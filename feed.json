{
    "version": "https://jsonfeed.org/version/1",
    "title": "专注技术分享",
    "subtitle": "醒醒，别做梦了",
    "icon": "http://yrmlnf.coding-pages.com/images/favicon.ico",
    "description": "",
    "home_page_url": "http://yrmlnf.coding-pages.com",
    "items": [
        {
            "id": "http://yrmlnf.coding-pages.com/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB/PySpider-%E7%88%AC%E5%8F%96Shopfiy%E5%BA%94%E7%94%A8/",
            "url": "http://yrmlnf.coding-pages.com/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB/PySpider-%E7%88%AC%E5%8F%96Shopfiy%E5%BA%94%E7%94%A8/",
            "title": "PySpider-爬取Shopify应用",
            "date_published": "2021-04-22T03:22:00.000Z",
            "content_html": "<h1 id=\"操作系统\"><a class=\"anchor\" href=\"#操作系统\">#</a> 操作系统</h1>\n<ul class=\"task-list\">\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_0\" checked=\"true\" disabled=\"true\" /><label for=\"cbx_0\">  Windows</label></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_1\" checked=\"true\" disabled=\"true\" /><label for=\"cbx_1\">  MAC</label></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_2\" checked=\"true\" disabled=\"true\" /><label for=\"cbx_2\">  Linux</label></li>\n</ul>\n<h1 id=\"软件依赖\"><a class=\"anchor\" href=\"#软件依赖\">#</a> 软件依赖</h1>\n<p><span class=\"label info\">^ Lastest</span> <span class=\"label info\">~ minimum</span></p>\n<ul>\n<li>Python@3.6^</li>\n<li>Pip@~</li>\n<li>node.js@~</li>\n</ul>\n<h1 id=\"实验环境\"><a class=\"anchor\" href=\"#实验环境\">#</a> 实验环境</h1>\n<ul>\n<li>Windows10</li>\n<li>python@3.68</li>\n<li>pip@19.2.3</li>\n</ul>\n<h1 id=\"什么是pyspider\"><a class=\"anchor\" href=\"#什么是pyspider\">#</a> 什么是 PySpider</h1>\n<p>pyspider 是支持 WebUI 的，支持任务监控，项目管理，以及多种数据库的一个强大的爬虫框架</p>\n<ul>\n<li>\n<p>pyspider 的优点，它有这么几个优点</p>\n<ol>\n<li>提供 WebUI 界面，调试爬虫很方便。</li>\n<li>可以很方便的进行爬取的流程监控和爬虫项目管理。</li>\n<li>支持常见的数据库。</li>\n<li>支持使用 PhantomJS，可以抓取 JavaScript 页面。</li>\n<li>支持优先级定制和定时爬取等功能。</li>\n</ol>\n</li>\n<li>\n<p>和 Scrapy 的比较</p>\n<ol>\n<li>pyspider 提供 WebUI,Scrapy 它采用的是代码和命令行操作，但可以通过对接 Portia 现可视化配置。</li>\n<li>pyspider 支持 PhantomJS 来进行 JavaScript 谊染页面的采集 Scrapy 可以对接 Sc rapy-Splash 组件，这需要额外配置。</li>\n<li>pyspider 中内置 pyquery 作为选择器而 Scrapy 接了 XPath 对接 css 选择器和正则匹配。</li>\n<li>pyspider 的可扩展程度不高，Scrapy 可以通过对接其他的模块实现强大的功能，模块之间的耦合度低。</li>\n</ol>\n</li>\n<li>\n<p>总结：</p>\n<p>所以如果要快速实现一个页面的抓取，推荐使用 pyspider, 开发更加便捷，如果要应对反爬程度很强、超大规模的抓取，推荐使用 Scrapy。</p>\n</li>\n</ul>\n<p>pyspider 的架构相对简单分为这么几个部分：scheduler（调度器）、fetcher（抓取器）、processor（脚本执行）任务由 scheduler 发起调度，fetcher 抓取网页内容， processor 执行预先编写的 py 脚本，输出结果或产生新的提链任务（scheduler)、整个爬取的过程受，Monitor（监控器）的监控，结果保存在 Result Worker（结果处理器）中。<br />\n2. 每个 pyspider 的项目对应一个 Python 脚本，该脚本中定义了一个 Handler 类，它有 on_start (）方法 爬取首先调用 on_start （）方法生成最初的抓取任务，然后发送给 Scheduler 进行调度。</p>\n<p>执行流程：</p>\n<ol>\n<li>scheduler 将抓取任务分发给 Fetcher 进行抓取， Fetcher 执行并得到响应，随后将响应发送给 Processer<br />\nProcesser 处理响应并提取 url，新的 URL 生成新的抓取任务，然后通过消息队列的方式通知 Schduler 当前抓取任务执行情况，并将新生成的抓取任务发送 Scheduler 如果生成了提取结果，则将其发送到结果队列等待 Result Worker 处理</li>\n<li>Scheduler 接收到新的抓取任务，然后查询数据库，判断其如果是新的抓取任务或者是需要重试的任务就继续进行调度，然后将其发送回 Fetcher 进行抓取<br />\n不断重复以上流程实现抓取</li>\n</ol>\n<h1 id=\"pyspider安装\"><a class=\"anchor\" href=\"#pyspider安装\">#</a> PySpider 安装</h1>\n<ol>\n<li>\n<p>创建虚拟环境</p>\n<p>作者使用的是 Anaconda 虚拟环境，可以在 Anaconda 官网下载并安装。这里必须指定 python3.6 版本，若用 python3.7 会报错，需要修改源码</p>\n<details class=\"warning\"><summary>python3.7修改源码</summary><div>\n<pre><code> 解决办法是将这个关键字替换掉。主要有两个文件：\n Python\\Lib\\site-packages\\pyspider\\run.py 和 \n Python\\Lib\\site-packages\\pyspider\\fetcher\\tornado_fetcher.py 中的async全部替换成shark\n</code></pre>\n</div></details>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>conda create -n pys <span class=\"token assign-left variable\">python</span><span class=\"token operator\">=</span><span class=\"token number\">3.6</span></pre></td></tr></table></figure><details class=\"info\"><summary>windows下Anaconda的常用命令</summary><div>\n<ul>\n<li>创建虚拟环境，虚拟环境名为 pys<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>conda create -n pys</pre></td></tr></table></figure></li>\n<li>删除 pys 虚拟环境</li>\n</ul>\n<pre><code>```bash\n  conda remove -n pys\n```\n</code></pre>\n<ul>\n<li>进入 pys 虚拟环境</li>\n</ul>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>conda activate pys</pre></td></tr></table></figure><ul>\n<li>退出 pys 虚拟环境</li>\n</ul>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>conda deactivate pys</pre></td></tr></table></figure></div></details>\n</li>\n<li>\n<p>安装 pyspider</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>conda activate pys</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>pip <span class=\"token function\">install</span> pyspider</pre></td></tr></table></figure></li>\n<li>\n<p>安装 PHantomJS</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9waGFudG9tanMub3JnL2Rvd25sb2FkLmh0bWw=\">下载 PHantomJS</span><br />\n 下载对应系统的安装包，作者下载的是 windows 系统的<br />\n<img data-src=\"1.png\" alt=\"下载PHantomJS\" /><br />\n 解压文件夹后，将 bin 目录下的 phantomjs.exe 放入当前环境的 pyspider 包根目录下<br />\n<img data-src=\"2.png\" alt=\"下载PHantomJS\" /><br />\n 我的虚拟环境目录是在 J:\\Anaconda3\\envs\\pys<br />\n 所以要将该文件放入 J:\\Anaconda3\\envs\\pys<br />\n<img data-src=\"3.png\" alt=\"下载PHantomJS\" /></p>\n</li>\n<li>\n<p>修改 werkzeug 版本<br />\n werkzeug 的版本为 1.0.0，这个版本中没有 DispatcherMiddleware 方法，所以还是降低版本。<br />\n注意降低版本不能低于 0.15 版本，因为我们的 pyspider 要求大于 0.15 版本以上</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>python -m pip uninstall werkzeug</pre></td></tr><tr><td data-num=\"2\"></td><td><pre> python -m pip <span class=\"token function\">install</span> <span class=\"token assign-left variable\">werkzeug</span><span class=\"token operator\">==</span><span class=\"token number\">0.16</span>.0</pre></td></tr></table></figure></li>\n</ol>\n<h1 id=\"pyspider启动\"><a class=\"anchor\" href=\"#pyspider启动\">#</a> PySpider 启动</h1>\n<p>进入虚拟环境后，通过命令启动 PySpider</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>conda activate pys</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>pyspider</pre></td></tr></table></figure><p>如果发现 PySpider 卡在 result_worker starting... 不动，请关闭公网防火墙</p>\n<p>或则按下面操作步骤操作</p>\n<ol>\n<li>打开一个 cmd 窗口，启动 pyspider，等待 10 秒左右</li>\n<li>保持第一个 cmd 窗口，再打开一个新的 cmd 窗口启动 pyspider</li>\n<li>第二个 cmd 窗口成功 pyspider 后关闭第一个 cmd 窗口</li>\n</ol>\n<p>服务启动后，在浏览器访问 localhost:5000，即可进入界面</p>\n<h1 id=\"界面介绍\"><a class=\"anchor\" href=\"#界面介绍\">#</a> 界面介绍</h1>\n<p><img data-src=\"4.png\" alt=\"界面介绍\" /></p>\n<ul>\n<li>定时任务：当前设置的定时任务</li>\n<li>组：可以将爬虫分成不同组，然后按组调用。设置 group 为 delete 和状态 STOP，等待 24 小时将可以删除爬虫</li>\n<li>爬虫：爬虫程序</li>\n<li>任务状态：\n<ul>\n<li>TODO - 创建一个脚本来编写</li>\n<li>STOP- 您可以将项目标记为 STOP 您希望它停止（= =）。</li>\n<li>CHECKING- 修改正在运行的项目时，为防止不完整修改，项目状态将 CHECKING 自动设置。</li>\n<li>DEBUG/ RUNNING- 这两种状态对蜘蛛没有区别。但是将它标记为 DEBUG 第一次运行然后将其更改 RUNNING 为检查后是很好的。</li>\n</ul>\n</li>\n<li>rate：<br />\n爬取的速率，rate - 一秒钟内有多少请求，burst - 考虑到这种情况，<br />\nrate/burst = 0.1/3 这意味着蜘蛛每 10 秒抓一页。所有任务都已完成，项目每分钟检查最后更新的项目。假设找到 3 个新项目，pyspider 将 “爆发” 并抓取 3 个任务而不等待 3 * 10 秒。但是，第四项任务需要等待 10 秒。</li>\n<li>avg time：平均时间</li>\n<li>progress：表示每 5 分钟，每小时，每天和总体的请求次数</li>\n</ul>\n<h1 id=\"编写爬虫\"><a class=\"anchor\" href=\"#编写爬虫\">#</a> 编写爬虫</h1>\n<p>本文目标是爬取 Shopify 的 app 信息</p>\n<ol>\n<li>\n<p>目标网址：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9hcHBzLnNob3BpZnkuY29tL2Jyb3dzZS9hbGw/cGFnZT0x\">https://apps.shopify.com/browse/all?page=1</span><br />\n<img data-src=\"5.png\" alt=\"目标网址\" /></p>\n</li>\n<li>\n<p>新建爬虫<br />\n<img data-src=\"6.png\" alt=\"目标网址\" /></p>\n</li>\n<li>\n<p>将下面代码复制进右边编辑栏</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#!/usr/bin/env python</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> pyspider<span class=\"token punctuation\">.</span>libs<span class=\"token punctuation\">.</span>base_handler <span class=\"token keyword\">import</span> <span class=\"token operator\">*</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">from</span> pyspider<span class=\"token punctuation\">.</span>database<span class=\"token punctuation\">.</span>mysql<span class=\"token punctuation\">.</span>mysql <span class=\"token keyword\">import</span> SQL</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name\">Handler</span><span class=\"token punctuation\">(</span>BaseHandler<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    crawl_config <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token keyword\">def</span> <span class=\"token function\">__init__</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        self<span class=\"token punctuation\">.</span>base_url <span class=\"token operator\">=</span> <span class=\"token string\">'https://apps.shopify.com/browse/all?page=%s'</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        self<span class=\"token punctuation\">.</span>page_num <span class=\"token operator\">=</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        self<span class=\"token punctuation\">.</span>total_num <span class=\"token operator\">=</span> <span class=\"token number\">202</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token decorator annotation punctuation\">@every</span><span class=\"token punctuation\">(</span>minutes<span class=\"token operator\">=</span><span class=\"token number\">24</span> <span class=\"token operator\">*</span> <span class=\"token number\">60</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token keyword\">def</span> <span class=\"token function\">on_start</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token keyword\">while</span> self<span class=\"token punctuation\">.</span>page_num <span class=\"token operator\">&lt;=</span> self<span class=\"token punctuation\">.</span>total_num<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>            url <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>base_url <span class=\"token operator\">%</span> <span class=\"token builtin\">str</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>page_num<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>            self<span class=\"token punctuation\">.</span>crawl<span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">,</span> callback<span class=\"token operator\">=</span>self<span class=\"token punctuation\">.</span>index_page<span class=\"token punctuation\">,</span>validate_cert<span class=\"token operator\">=</span><span class=\"token boolean\">False</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>            self<span class=\"token punctuation\">.</span>page_num <span class=\"token operator\">+=</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token decorator annotation punctuation\">@config</span><span class=\"token punctuation\">(</span>age<span class=\"token operator\">=</span><span class=\"token number\">10</span> <span class=\"token operator\">*</span> <span class=\"token number\">24</span> <span class=\"token operator\">*</span> <span class=\"token number\">60</span> <span class=\"token operator\">*</span> <span class=\"token number\">60</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token keyword\">def</span> <span class=\"token function\">index_page</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> response<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        data <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        <span class=\"token keyword\">for</span> each <span class=\"token keyword\">in</span> response<span class=\"token punctuation\">.</span>doc<span class=\"token punctuation\">(</span><span class=\"token string\">'.grid--equal-height > div > div'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>items<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>             dic<span class=\"token operator\">=</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>                 <span class=\"token string\">\"title\"</span><span class=\"token punctuation\">:</span> each<span class=\"token punctuation\">.</span>find<span class=\"token punctuation\">(</span><span class=\"token string\">'h2'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>text<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>                 <span class=\"token string\">\"developer\"</span><span class=\"token punctuation\">:</span> each<span class=\"token punctuation\">.</span>find<span class=\"token punctuation\">(</span><span class=\"token string\">'div[class=\"ui-app-card__developer-name\"]'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>text<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>                 <span class=\"token string\">\"description\"</span><span class=\"token punctuation\">:</span> each<span class=\"token punctuation\">.</span>find<span class=\"token punctuation\">(</span><span class=\"token string\">'p[class=\"ui-app-card__details\"]'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>text<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>                 <span class=\"token string\">\"rate\"</span><span class=\"token punctuation\">:</span> each<span class=\"token punctuation\">.</span>find<span class=\"token punctuation\">(</span><span class=\"token string\">'span[class=\"ui-star-rating__rating\"]'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>text<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>                 <span class=\"token string\">'reviews'</span><span class=\"token punctuation\">:</span> each<span class=\"token punctuation\">.</span>find<span class=\"token punctuation\">(</span><span class=\"token string\">'span[class=\"ui-review-count-summary\"]'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>text<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>                 <span class=\"token string\">\"price\"</span><span class=\"token punctuation\">:</span> each<span class=\"token punctuation\">.</span>find<span class=\"token punctuation\">(</span><span class=\"token string\">'div[class=\"ui-app-card__pricing\"]'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>text<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>             <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>             data<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span>dic<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        <span class=\"token keyword\">return</span> data</pre></td></tr><tr><td data-num=\"34\"></td><td><pre></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>    <span class=\"token keyword\">def</span> <span class=\"token function\">on_result</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span>result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>        sql <span class=\"token operator\">=</span> SQL<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>        <span class=\"token keyword\">if</span> result<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>            <span class=\"token keyword\">for</span> data <span class=\"token keyword\">in</span> result<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>                sql<span class=\"token punctuation\">.</span>insert<span class=\"token punctuation\">(</span><span class=\"token string\">'shopify'</span><span class=\"token punctuation\">,</span><span class=\"token operator\">**</span>data<span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>点击 save 和 run 后，会出现 202 条 follow，这是因为在代码中设置了从第一页爬取到 202 页，在这个页面能帮我们看到爬虫将要爬取的链接，点击每条 follow 的箭头则会启动那一个 url，想要一次爬取 202 条则需要在首页里面执行爬虫</p>\n</li>\n<li>\n<p>保存数据</p>\n<p>安装 MySQL，并创建表 shopify</p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">TABLE</span> <span class=\"token punctuation\">`</span>shopify<span class=\"token punctuation\">`</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>   <span class=\"token punctuation\">`</span>id<span class=\"token punctuation\">`</span> <span class=\"token keyword\">int</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">AUTO_INCREMENT</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>   <span class=\"token punctuation\">`</span>title<span class=\"token punctuation\">`</span> <span class=\"token keyword\">varchar</span><span class=\"token punctuation\">(</span><span class=\"token number\">100</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>   <span class=\"token punctuation\">`</span>developer<span class=\"token punctuation\">`</span> <span class=\"token keyword\">varchar</span><span class=\"token punctuation\">(</span><span class=\"token number\">50</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>   <span class=\"token punctuation\">`</span>description<span class=\"token punctuation\">`</span> <span class=\"token keyword\">text</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>   <span class=\"token punctuation\">`</span>rate<span class=\"token punctuation\">`</span> <span class=\"token keyword\">varchar</span><span class=\"token punctuation\">(</span><span class=\"token number\">30</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>   <span class=\"token punctuation\">`</span>reviews<span class=\"token punctuation\">`</span> <span class=\"token keyword\">varchar</span><span class=\"token punctuation\">(</span><span class=\"token number\">30</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>   <span class=\"token punctuation\">`</span>price<span class=\"token punctuation\">`</span> <span class=\"token keyword\">varchar</span><span class=\"token punctuation\">(</span><span class=\"token number\">30</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>   <span class=\"token keyword\">PRIMARY</span> <span class=\"token keyword\">KEY</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">`</span>id<span class=\"token punctuation\">`</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre> <span class=\"token punctuation\">)</span> <span class=\"token keyword\">ENGINE</span><span class=\"token operator\">=</span><span class=\"token keyword\">InnoDB</span> <span class=\"token keyword\">AUTO_INCREMENT</span><span class=\"token operator\">=</span><span class=\"token number\">4817</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token keyword\">CHARSET</span><span class=\"token operator\">=</span>utf8<span class=\"token punctuation\">;</span></pre></td></tr></table></figure></li>\n<li>\n<p><span class=\"exturl\" data-url=\"aHR0cDovL3huLS1teXNxbC1sbjJoeTFxZjIzYWk5bS5weQ==\">创建文件 mysql.py</span></p>\n<p>写入下面代码，修改数据库连接相关信息</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#!/usr/bin/env python</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre> <span class=\"token comment\">#-*- encoding: utf-8 -*-</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre> <span class=\"token keyword\">from</span> six <span class=\"token keyword\">import</span> itervalues</pre></td></tr><tr><td data-num=\"4\"></td><td><pre> <span class=\"token keyword\">import</span> pymysql</pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre> <span class=\"token keyword\">class</span> <span class=\"token class-name\">SQL</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>     <span class=\"token comment\">#数据库初始化</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>     <span class=\"token keyword\">def</span> <span class=\"token function\">__init__</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>         <span class=\"token comment\">#数据库连接相关信息</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>         hosts    <span class=\"token operator\">=</span> <span class=\"token string\">'localhost'</span>  </pre></td></tr><tr><td data-num=\"11\"></td><td><pre>         username <span class=\"token operator\">=</span> <span class=\"token string\">'root'</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>         password <span class=\"token operator\">=</span> <span class=\"token string\">'6113535'</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>         database <span class=\"token operator\">=</span> <span class=\"token string\">'test'</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>         charsets <span class=\"token operator\">=</span> <span class=\"token string\">'utf8'</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>         self<span class=\"token punctuation\">.</span>connection <span class=\"token operator\">=</span> <span class=\"token boolean\">False</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>         <span class=\"token keyword\">try</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>             self<span class=\"token punctuation\">.</span>conn <span class=\"token operator\">=</span> pymysql<span class=\"token punctuation\">.</span>connect<span class=\"token punctuation\">(</span>host <span class=\"token operator\">=</span> hosts<span class=\"token punctuation\">,</span>user <span class=\"token operator\">=</span> username<span class=\"token punctuation\">,</span>passwd <span class=\"token operator\">=</span> password<span class=\"token punctuation\">,</span>db <span class=\"token operator\">=</span> database<span class=\"token punctuation\">,</span>charset <span class=\"token operator\">=</span> charsets<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>             self<span class=\"token punctuation\">.</span>cursor <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>conn<span class=\"token punctuation\">.</span>cursor<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>             self<span class=\"token punctuation\">.</span>cursor<span class=\"token punctuation\">.</span>execute<span class=\"token punctuation\">(</span><span class=\"token string\">\"set names \"</span><span class=\"token operator\">+</span>charsets<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>             self<span class=\"token punctuation\">.</span>connection <span class=\"token operator\">=</span> <span class=\"token boolean\">True</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>         <span class=\"token keyword\">except</span> e<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>             <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Cannot Connect To Mysql!/n\"</span><span class=\"token punctuation\">,</span>e<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>     <span class=\"token keyword\">def</span> <span class=\"token function\">escape</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span>string<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>         <span class=\"token keyword\">return</span> <span class=\"token string\">'%s'</span> <span class=\"token operator\">%</span> string</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>     <span class=\"token comment\">#插入数据到数据库   </span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>     <span class=\"token keyword\">def</span> <span class=\"token function\">insert</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span>tablename<span class=\"token operator\">=</span><span class=\"token boolean\">None</span><span class=\"token punctuation\">,</span><span class=\"token operator\">**</span>values<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>         <span class=\"token keyword\">if</span> self<span class=\"token punctuation\">.</span>connection<span class=\"token punctuation\">:</span> </pre></td></tr><tr><td data-num=\"31\"></td><td><pre>             tablename <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>escape<span class=\"token punctuation\">(</span>tablename<span class=\"token punctuation\">)</span>  </pre></td></tr><tr><td data-num=\"32\"></td><td><pre>             <span class=\"token keyword\">if</span> values<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>                 _keys <span class=\"token operator\">=</span> <span class=\"token string\">\",\"</span><span class=\"token punctuation\">.</span>join<span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>escape<span class=\"token punctuation\">(</span>k<span class=\"token punctuation\">)</span> <span class=\"token keyword\">for</span> k <span class=\"token keyword\">in</span> values<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>                 _values <span class=\"token operator\">=</span> <span class=\"token string\">\",\"</span><span class=\"token punctuation\">.</span>join<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token string\">'%s'</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">]</span><span class=\"token operator\">*</span><span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>values<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>                 sql_query <span class=\"token operator\">=</span> <span class=\"token string\">\"insert into %s (%s) values (%s)\"</span> <span class=\"token operator\">%</span> <span class=\"token punctuation\">(</span>tablename<span class=\"token punctuation\">,</span>_keys<span class=\"token punctuation\">,</span>_values<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>             <span class=\"token keyword\">else</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>                 sql_query <span class=\"token operator\">=</span> <span class=\"token string\">\"replace into %s default values\"</span> <span class=\"token operator\">%</span> tablename</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>             <span class=\"token keyword\">try</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>                 <span class=\"token keyword\">if</span> values<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>                     self<span class=\"token punctuation\">.</span>cursor<span class=\"token punctuation\">.</span>execute<span class=\"token punctuation\">(</span>sql_query<span class=\"token punctuation\">,</span><span class=\"token builtin\">list</span><span class=\"token punctuation\">(</span>itervalues<span class=\"token punctuation\">(</span>values<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>                 <span class=\"token keyword\">else</span><span class=\"token punctuation\">:</span>       </pre></td></tr><tr><td data-num=\"42\"></td><td><pre>                     self<span class=\"token punctuation\">.</span>cursor<span class=\"token punctuation\">.</span>execute<span class=\"token punctuation\">(</span>sql_query<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>                 self<span class=\"token punctuation\">.</span>conn<span class=\"token punctuation\">.</span>commit<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>                 <span class=\"token keyword\">return</span> <span class=\"token boolean\">True</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>             <span class=\"token keyword\">except</span> e<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>                 <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"An Error Occured: \"</span><span class=\"token punctuation\">,</span>e<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>                 <span class=\"token keyword\">return</span> <span class=\"token boolean\">False</span></pre></td></tr></table></figure><p>将文件放到当前环境的 pyspider\\database\\mysql 文件夹下<br />\n<img data-src=\"8.png\" alt=\"mysql\" /><br />\n 爬虫代码中的用 return 返回了数据后就会自动执行 on_result () 函数，这个函数就是调用该文件来把数据保存到 MySQL</p>\n</li>\n<li>\n<p>执行爬虫</p>\n</li>\n</ol>\n<p>回到首页，将爬虫的状态设为 running，然后点击运行<br />\n<img data-src=\"9.png\" alt=\"执行爬虫\" /><br />\n然后就会看到后台飞快的执行，执行完成后可以看见 process 的 all 显示为 204（有两次是测试）</p>\n",
            "tags": [
                "计算机科学",
                "网络爬虫",
                "python",
                "pyspider"
            ]
        },
        {
            "id": "http://yrmlnf.coding-pages.com/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/IT%E8%BF%90%E7%BB%B4/MySQL-%E5%9C%A8%E5%90%84%E7%B3%BB%E7%BB%9F%E4%B8%8B%E5%AE%89%E8%A3%85/",
            "url": "http://yrmlnf.coding-pages.com/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/IT%E8%BF%90%E7%BB%B4/MySQL-%E5%9C%A8%E5%90%84%E7%B3%BB%E7%BB%9F%E4%B8%8B%E5%AE%89%E8%A3%85/",
            "title": "MySQL-在各系统下安装",
            "date_published": "2021-04-17T02:09:00.000Z",
            "content_html": "<blockquote>\n<p>MySQL 是一个功能齐全的关系数据库管理系统（RDBMS），可以与 Oracle DB 和 Microsoft 的 SQL Server 竞争。MySQL 由瑞典公司 MySQL AB 赞助，该公司由 Oracle 公司拥有。</p>\n</blockquote>\n<h1 id=\"windows\"><a class=\"anchor\" href=\"#windows\">#</a> Windows</h1>\n<ol>\n<li>下载 mysql，<span class=\"exturl\" data-url=\"aHR0cHM6Ly9kZXYubXlzcWwuY29tL2Rvd25sb2Fkcy9pbnN0YWxsZXIv\">点击进入下载</span><br />\n第一个是在线下载版，第二个是安装版<br />\n我选择第二个<br />\n<img data-src=\"1.png\" alt=\"image\" /></li>\n<li>选择 No thanks 跳过登录<br />\n<img data-src=\"2.png\" alt=\"image\" /></li>\n<li>下载完成后打开安装包<br />\n根据需求选择，这里选择 develop<br />\n<img data-src=\"3.png\" alt=\"image\" /></li>\n<li>next<br />\n<img data-src=\"4.png\" alt=\"image\" /></li>\n<li>安装<br />\n<img data-src=\"5.png\" alt=\"image\" /></li>\n<li>安装完成<br />\n<img data-src=\"6.png\" alt=\"image\" /></li>\n<li>next<br />\n<img data-src=\"7.png\" alt=\"image\" /></li>\n<li>选择高可用，这里选择单机模式<br />\n<img data-src=\"8.png\" alt=\"image\" /></li>\n<li>选择 mysql 端口，这里选择默认的 3306<br />\n<img data-src=\"9.png\" alt=\"image\" /></li>\n<li>选择密码认证方式，这里选择默认的第一个选择<br />\n<img data-src=\"10.png\" alt=\"image\" /></li>\n<li>输入数据库管理员密码<br />\n<img data-src=\"11.png\" alt=\"image\" /></li>\n<li>是否开机启动<br />\n<img data-src=\"12.png\" alt=\"image\" /></li>\n<li>开始自动 mysql<br />\n<img data-src=\"13.png\" alt=\"image\" /></li>\n<li>完成配置<br />\n<img data-src=\"14.png\" alt=\"image\" /></li>\n<li>next<br />\n<img data-src=\"15.png\" alt=\"image\" /></li>\n<li>是否启动 boostrap，这里直接 next<br />\n<img data-src=\"16.png\" alt=\"image\" /></li>\n<li>连接数据库，输入之前输入的密码，点击 check<br />\n<img data-src=\"17.png\" alt=\"image\" /></li>\n<li>执行<br />\n<img data-src=\"18.png\" alt=\"image\" /></li>\n<li>完成<br />\n<img data-src=\"19.png\" alt=\"image\" /></li>\n<li>下一步<br />\n<img data-src=\"20.png\" alt=\"image\" /></li>\n<li>将 mysql 添加到开始菜单<br />\n<img data-src=\"21.png\" alt=\"image\" /></li>\n<li>点击开始菜单，打开 mysql 客户端<br />\n<img data-src=\"22.png\" alt=\"image\" /></li>\n<li>输入密码，若连接成功则安装完成<br />\n<img data-src=\"23.png\" alt=\"image\" /></li>\n</ol>\n<h1 id=\"linux\"><a class=\"anchor\" href=\"#linux\">#</a> Linux</h1>\n<h2 id=\"centos\"><a class=\"anchor\" href=\"#centos\">#</a> CentOS</h2>\n<ol>\n<li>下载 mysql repo 源，否则 yum 没有 mysql-server 的源</li>\n</ol>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>$ <span class=\"token function\">wget</span> http://repo.mysql.com/mysql-community-release-el7-5.noarch.rpm</pre></td></tr></table></figure><ol start=\"2\">\n<li>安装 mysql repo 源</li>\n</ol>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>$ <span class=\"token function\">rpm</span> -ivh mysql-community-release-el7-5.noarch.rpm</pre></td></tr></table></figure><ol start=\"3\">\n<li>安装 Mysql</li>\n</ol>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>$ yum <span class=\"token function\">install</span> -y mysql-server mysql mysql-deve</pre></td></tr></table></figure><ol start=\"4\">\n<li>运行 Mysql 服务，第一次运行</li>\n</ol>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">service</span> mysqld start</pre></td></tr></table></figure><ol start=\"5\">\n<li>重置密码</li>\n</ol>\n<pre><code>$ mysql -u root\n&gt;use mysql;\n&gt;update user set password=password(&quot;123456&quot;) where user=&quot;root&quot;;\n&gt;exit;\n</code></pre>\n<h2 id=\"ubuntu\"><a class=\"anchor\" href=\"#ubuntu\">#</a> Ubuntu</h2>\n<ol>\n<li>依次执行下面命令<br />\n安装过程会提示设置 mysql root 用户的密码，设置完成后等待自动安装即可</li>\n</ol>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">apt-get</span> update</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">apt-get</span> <span class=\"token function\">install</span> mysql-server</pre></td></tr></table></figure><ol start=\"2\">\n<li>检查是否安装完成</li>\n</ol>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">netstat</span> -tap <span class=\"token operator\">|</span> <span class=\"token function\">grep</span> mysql</pre></td></tr></table></figure><h1 id=\"macos\"><a class=\"anchor\" href=\"#macos\">#</a> MacOS</h1>\n<p>留坑</p>\n",
            "tags": [
                "计算机科学",
                "IT运维",
                "devops",
                "mysql"
            ]
        },
        {
            "id": "http://yrmlnf.coding-pages.com/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis-%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5%E4%B8%8E%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/",
            "url": "http://yrmlnf.coding-pages.com/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis-%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5%E4%B8%8E%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/",
            "title": "Redis-基本概念与解决方案",
            "date_published": "2021-04-17T01:03:00.000Z",
            "content_html": "<h1 id=\"什么是redis\"><a class=\"anchor\" href=\"#什么是redis\">#</a> 什么是 Redis</h1>\n<p>Redis 是一个开源的使用 ANSI C 语言编写、遵守 BSD 协议、支持网络、可基于内存亦可持久化的日志型、Key-Value 数据库，并提供多种语言的 API 的非关系型数据库。</p>\n<p>传统数据库遵循 ACID 规则。而 Nosql（Not Only SQL 的缩写，是对不同于传统的关系型数据库的数据库管理系统的统称） 一般为分布式而分布式一般遵循 CAP 定理。</p>\n<p>redis 底层实际上是个 hashtable</p>\n<details class=\"info\"><summary>CAP定理</summary><div>\n<div class=\"note info\">\n<p>一个分布式系统不可能同时满足以下三种，一致性（C:Consistency）, 可用性（A:Available）, 分区容错性（P:Partition Tolerance）. 在此 ZooKeeper 保证的是 CP，ZooKeeper 不能保证每次服务请求的可用性，在极端环境下，ZooKeeper 可能会丢弃一些请求，消费者程序需要重新请求才能获得结果。另外在进行 leader 选举时集群都是不可用，所以说，ZooKeeper 不能保证服务可用性。（Base 理论 CA 强一致性和最终一致性）</p>\n</div>\n</div></details>\n<h1 id=\"redis的应用场景\"><a class=\"anchor\" href=\"#redis的应用场景\">#</a> Redis 的应用场景</h1>\n<ul>\n<li>消息队列</li>\n<li>缓存</li>\n<li>共享 session</li>\n<li>分布式锁</li>\n</ul>\n<h1 id=\"单线程的redis为什么快\"><a class=\"anchor\" href=\"#单线程的redis为什么快\">#</a> 单线程的 Redis 为什么快</h1>\n<ul>\n<li>合理高效的数据结构</li>\n<li>基于内存操作</li>\n<li>采用了非阻塞 I/O 多路复用机制</li>\n<li>单线程操作，避免了上下文的切换</li>\n</ul>\n<details class=\"info\"><summary>I/O机制</summary><div>\n<div class=\"note info\">\n<ol>\n<li>阻塞 I/O<br />\n 首先，要从你常用的 IO 操作谈起，比如 read 和 write，通常 IO 操作都是阻塞 I/O 的，也就是说当你调用 read 时，如果没有数据收到，那么线程或者进程就会被挂起，直到收到数据。阻塞的意思，就是一直等着。阻塞 I/O 就是等着数据过来，进行读写操作。应用的函数进行调用，但是内核一直没有返回，就一直等着。应用的函数长时间处于等待结果的状态，我们就称为阻塞 I/O。每个应用都得等着，每个应用都在等着，浪费啊！很像现实中的情况。大家都不干活，等着数据过来，过来工作一下，没有的话继续等着</li>\n<li>非阻塞 I/O<br />\n 非阻塞 IO 很简单，通过 fcntl（POSIX）或 ioctl（Unix）设为非阻塞模式，这时，当你调用 read 时，如果有数据收到，就返回数据，如果没有数据收到，就立刻返回一个错误，如 EWOULDBLOCK。这样是不会阻塞线程了，但是你还是要不断的轮询来读取或写入。相当于你去查看有没有数据，告诉你没有，过一会再来吧！应用过一会再来问，有没有数据？没有数据，会有一个返回。但是依旧很不好。应用必须得过一会来一下，问问内核有木有数据啊。这和现实很像啊！好多情况都得去某些地方问问好了没有？木有，明天再过来。明天，好了木有？木有，后天再过来。。。。。忙碌的应用。。。。</li>\n<li>I/O 多路复用<br />\n多路复用是指使用一个线程来检查多个文件描述符（Socket）的就绪状态，比如调用 select 和 poll 函数，传入多个文件描述符（FileDescription，简称 FD），如果有一个文件描述符（FileDescription）就绪，则返回，否则阻塞直到超时。得到就绪状态后进行真正的操作可以在同一个线程里执行，也可以启动线程执行（比如使用线程池）。虾米意思？就是派一个代表，同时监听多个文件描述符是否有数据到来。等着等着，如有有数据，就告诉某某你的数据来啦！赶紧来处理吧。有没有很感动，一个人待着，帮了很多人。医院的黄牛，一个人排队，大家只要把钱给它，它就会把号给需要的人，开个玩笑。。。。</li>\n</ol>\n</div>\n</div></details>\n<h1 id=\"redis的数据结构及使用场景\"><a class=\"anchor\" href=\"#redis的数据结构及使用场景\">#</a> Redis 的数据结构及使用场景</h1>\n<ol>\n<li>String（基本类型）<br />\n字符串：字符串类型是 Redis 最基础的数据结构，首先键都是字符串类型，而且 其他几种数据结构都是在字符串类型基础上构建的，我们常使用的 set key value 命令就是字符串。常用在缓存、计数、共享 Session、限速等</li>\n<li>Hash（基本类型）<br />\n哈希：在 Redis 中，哈希类型是指键值本身又是一个键值对结构，哈希可以用来存放用户信息，比如实现购物车</li>\n<li>List（基本类型）<br />\n列表类型是用来存储多个有序的字符串。可以做简单的消息队列的功能。</li>\n<li>Set（基本类型）<br />\n集合类型也是用来保存多个的字符串元素，但和列表类型不一 样的是，集合中不允许有重复元素，并且集合中的元素是无序的，不能通过索引下标获取元素。利用 Set 的交集、并集、差集等操作，可以计算共同喜好，全部的喜好，自己独有的喜好等功能。</li>\n<li>Sorted Set（基本类型）<br />\n有序集合多了一个权重参数 Score，集合中的元素能够按 Score 进行排列。可以做排行榜应用，取 TOP N 操作。</li>\n<li>Bitmap<br />\n 位图是支持按 bit 位来存储信息，可以用来实现 布隆过滤器（BloomFilter）和 <span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2N0d2N0dy9hcnRpY2xlL2RldGFpbHMvMTA1MDEzODE3\">统计某用户登录天数</span></li>\n</ol>\n<h1 id=\"redis的过期策略\"><a class=\"anchor\" href=\"#redis的过期策略\">#</a> Redis 的过期策略</h1>\n<p><ins>Redis 过期策略采用定时删除 + 惰性删除策略</ins></p>\n<ul>\n<li>\n<p>定时删除<br />\n Redis 启用一个定时器定时监视所有的 key，判断 key 是否过期，过期则将其删除。这种策略可以保证过期的 key 全部被删除，但是每次都需要遍历内存中的数据，非常消耗 cpu 的资源，并且当 key 已过期，而定时器还处于未唤醒状态时，key 仍可以使用</p>\n</li>\n<li>\n<p>惰性删除<br />\n在获取 key 时，先判断 key 是否已经过期，如已经过期则删除。这种策略有一个缺点，就是如果 key 一直没被使用，则会一直保存在内存中</p>\n</li>\n</ul>\n<p>这两种策略天然互补，当两种策略结合起来用后，定时删除策略就会发生变化，定时删除将不再扫描内存里全部的数据，而是抽取一部分 key 进行检查，这样就降低了 cpu 资源的消耗，惰性删除策略互补了未抽取检查的 key，基本满足了所有的要求。但是有时候就是那么巧，既没有被定时器抽取，也没有被使用，这些数据该如何从内存中消息呢？没关系，Redis 还有内存淘汰机制，当内存不够用时，将会触发内存淘汰机制</p>\n<h1 id=\"redis内存淘汰机制\"><a class=\"anchor\" href=\"#redis内存淘汰机制\">#</a> Redis 内存淘汰机制</h1>\n<p>内存淘汰机制有以下几种：</p>\n<ul>\n<li>当内存不足以容纳新写入数据时，新写入操作会报错。（Redis 默认策略）</li>\n<li>当内存不足以容纳新写入数据时，在键空间中，移除最近最少使用的 Key。（LRU 推荐使用）</li>\n<li>当内存不足以容纳新写入数据时，在键空间中，随机移除某个 Key。</li>\n<li>当内存不足以容纳新写入数据时，在设置了过期时间的键空间中，移除最近最少使用的 Key。这种情况一般是把 Redis 既当缓存，又做持久化存储的时候才用。</li>\n<li>当内存不足以容纳新写入数据时，在设置了过期时间的键空间中，随机移除某个 Key。</li>\n<li>当内存不足以容纳新写入数据时，在设置了过期时间的键空间中，有更早过期时间的 Key 优先移除。</li>\n</ul>\n<p>Redis 的 LRU (Least Recently Used) 具体实现:<br />\n 传统的 LRU 是使用栈的形式，每次都将最新使用的移入栈顶，但是用栈的形式会导致执行 select * 的时候大量非热点数据占领头部数据，所以需要改进。Redis 每次按 key 获取一个值的时候，都会更新 value 中的 lru 字段为当前秒级别的时间戳。Redis 初始的实现算法很简单，随机从 dict 中取出五个 key, 淘汰一个 lru 字段值最小的。在 3.0 的时候，又改进了一版算法，首先第一次随机选取的 key 都会放入一个 pool 中 (pool 的大小为 16),pool 中的 key 是按 lru 大小顺序排列的。接下来每次随机选取的 keylru 值必须小于 pool 中最小的 lru 才会继续放入，直到将 pool 放满。放满之后，每次如果有新的 key 需要放入，需要将 pool 中 lru 最大的一个 key 取出。淘汰的时候，直接从 pool 中选取一个 lru 最小的值然后将其淘汰。</p>\n<h1 id=\"redis持久化机制\"><a class=\"anchor\" href=\"#redis持久化机制\">#</a> Redis 持久化机制</h1>\n<p>Redis 为了保证效率，数据缓存在了内存中，但是会周期性的把更新的数据写入磁盘或者把修改操作写入追加的记录文件中，以保证数据的持久化。Redis 有两种持久化机制：RDB (Redis DataBase) 和 AOF (Append Only File)</p>\n<ul>\n<li>\n<p>RDB<br />\n 快照形式是直接把内存中的数据保存到一个 dump 的文件中，定时保存，保存策略。当 Redis 需要做持久化时，Redis 会 fork 一个子进程，子进程将数据写到磁盘上一个临时 RDB 文件中。当子进程完成写临时文件后，将原来的 RDB 替换掉。</p>\n</li>\n<li>\n<p>AOF<br />\n 把所有的对 Redis 的服务器进行修改的命令都存到一个文件里，命令的集合。使用 AOF 做持久化，每一个写命令都通过 write 函数追加到 appendonly.aof 中。aof 的默认策略是每秒钟 fsync 一次，在这种配置下，就算发生故障停机，也最多丢失一秒钟的数据。缺点是对于相同的数据集来说，AOF 的文件体积通常要大于 RDB 文件的体积。根据所使用的 fsync 策略，AOF 的速度可能会慢于 RDB。<br />\nAOD 写入保存：<br />\nWRITE：根据条件，将 aof_buf 中的缓存写入到 AOF 文件<br />\n SAVE：根据条件，调用 fsync 或 fdatasync 函数，将 AOF 文件保存到磁盘中<br />\n存储结构:<br />\n 内容是 redis 通讯协议 (RESP) 格式的命令文本存储。</p>\n</li>\n<li>\n<p>比较</p>\n<ol>\n<li>aof 文件比 rdb 更新频率高，优先使用 aof 还原数据。</li>\n<li>aof 比 rdb 更安全也更大</li>\n<li>rdb 性能比 aof 好</li>\n<li>如果两个都配了优先加载 AOF</li>\n</ol>\n</li>\n</ul>\n<p>Redis 默认是快照 RDB 的持久化方式。对于 redis 服务重启，会优先加载 AOF,AOF 没找到的话再找 RDB，因为 AOF 文件的数据要全于 RDB。对于主从同步来说，主从刚刚连接的时候，进行全量同步（RDB）；全同步结束后，进行增量同步 (AOF)</p>\n<h1 id=\"redis的resp协议\"><a class=\"anchor\" href=\"#redis的resp协议\">#</a> Redis 的 RESP 协议</h1>\n<p>该协议是用于与 Redis 服务器通信的，用的较多的是 Redis-cli 通过 pipe 与 Redis 服务器联系；<br />\n协议如下：</p>\n<ol>\n<li>客户端以规定格式的形式发送命令给服务器；</li>\n<li>服务器在执行最后一条命令后，返回结果。</li>\n</ol>\n<p>客户端发送命令的格式 (类型)：5 种类型</p>\n<ul>\n<li>简单字符串 Simple Strings, 以 &quot;+&quot; 加号 开头</li>\n<li>错误 Errors, 以 &quot;-&quot; 减号 开头</li>\n<li>整数型 Integer， 以 &quot;:&quot; 冒号开头</li>\n<li>大字符串类型 Bulk Strings, 以 &quot;$&quot; 美元符号开头，长度限制 512M</li>\n<li>数组类型 Arrays，以 &quot;*&quot; 星号开头</li>\n</ul>\n<h1 id=\"redis的管道pipeline\"><a class=\"anchor\" href=\"#redis的管道pipeline\">#</a> Redis 的管道 pipeline</h1>\n<p>对于单线程阻塞式的 Redis，Pipeline 可以满足批量的操作，把多个命令连续的发送给 Redis Server，然后一一解析响应结果。Pipelining 可以提高批量处理性能，提升的原因主要是 TCP 连接中减少了 “交互往返” 的时间。pipeline 底层是通过把所有的操作封装成流，redis 有定义自己的出入输出流。在 sync () 方法执行操作，每次请求放在队列里面，解析响应包。</p>\n<h1 id=\"redis常见架构\"><a class=\"anchor\" href=\"#redis常见架构\">#</a> Redis 常见架构</h1>\n<ul>\n<li>\n<p>单机版<br />\n<img data-src=\"1.png\" alt=\"单机版\" /><br />\n特点：简单</p>\n</li>\n<li>\n<p>主从复制<br />\n<img data-src=\"2.jpeg\" alt=\"主从复制\" /><br />\n Redis 的复制（replication）功能允许用户根据一个 Redis 服务器来创建任意多个该服务器的复制品，其中被复制的服务器为主服务器（master），而通过复制创建出来的服务器复制品则为从服务器（slave）。 只要主从服务器之间的网络连接正常，主从服务器两者会具有相同的数据，主服务器就会一直将发生在自己身上的数据更新同步 给从服务器，从而一直保证主从服务器的数据相同。<br />\n特点：</p>\n<ol>\n<li>master/slave 角色</li>\n<li>master/slave 数据相同</li>\n<li>降低 master 读压力在转交从库</li>\n</ol>\n<p>缺点：</p>\n<ol>\n<li>无法保证高可用</li>\n<li>没有解决 master 写的压力</li>\n</ol>\n</li>\n<li>\n<p>哨兵模式<br />\n<img data-src=\"3.jpeg\" alt=\"哨兵模式\" /><br />\n Redis sentinel 是一个分布式系统中监控 redis 主从服务器，并在主服务器下线时自动进行故障转移。其中三个特性：<br />\n监控（Monitoring）： Sentinel 会不断地检查你的主服务器和从服务器是否运作正常。<br />\n提醒（Notification）： 当被监控的某个 Redis 服务器出现问题时， Sentinel 可以通过 API 向管理员或者其他应用程序发送通知。<br />\n自动故障迁移（Automatic failover）： 当一个主服务器不能正常工作时， Sentinel 会开始一次自动故障迁移操作。<br />\n特点：</p>\n<ol>\n<li>保证高可用</li>\n<li>监控各个节点</li>\n<li>自动故障迁移</li>\n</ol>\n<p>缺点：</p>\n<ol>\n<li>主从模式，切换需要时间丢数据</li>\n<li>没有解决 master 写的压力</li>\n</ol>\n</li>\n<li>\n<p>集群（proxy 型）<br />\n<img data-src=\"4.jpeg\" alt=\"集群（proxy 型）\" /><br />\nTwemproxy 是一个 Twitter 开源的一个 redis 和 memcache 快速 / 轻量级代理服务器；Twemproxy 是一个快速的单线程代理程序，支持 Memcached ASCII 协议和 redis 协议。<br />\n特点：</p>\n<ol>\n<li>多种 hash 算法：MD5、CRC16、CRC32、CRC32a、hsieh、murmur、Jenkins</li>\n<li>支持失败节点自动删除</li>\n<li>后端 Sharding 分片逻辑对业务透明，业务方的读写方式和操作单个 Redis 一致</li>\n</ol>\n<p>缺点：</p>\n<ol>\n<li>增加了新的 proxy，需要维护其高可用</li>\n<li>failover 逻辑需要自己实现，其本身不能支持故障的自动转移可扩展性差，进行扩缩容都需要手动干预</li>\n</ol>\n</li>\n<li>\n<p>集群（直连型）<br />\n<img data-src=\"4.jpeg\" alt=\"集群（proxy 型）\" /><br />\n从 redis 3.0 之后版本支持 redis-cluster 集群，Redis-Cluster 采用无中心结构，每个节点保存数据和整个集群状态，每个节点都和其他所有节点连接。<br />\n特点：</p>\n<ol>\n<li>无中心架构（不存在哪个节点影响性能瓶颈），少了 proxy 层</li>\n<li>数据按照 slot 存储分布在多个节点，节点间数据共享，可动态调整数据分布</li>\n<li>可扩展性，可线性扩展到 1000 个节点，节点可动态添加或删除</li>\n<li>高可用性，部分节点不可用时，集群仍可用。通过增加 Slave 做备份数据副本</li>\n<li>实现故障自动 failover，节点之间通过 gossip 协议交换状态信息，用投票机制完成 Slave 到 Master 的角色提升。</li>\n</ol>\n<p>缺点：</p>\n<ol>\n<li>资源隔离性较差，容易出现相互影响的情况。</li>\n<li>数据通过异步复制，不保证数据的强一致性</li>\n</ol>\n</li>\n</ul>\n<h1 id=\"redis常见问题解决方案\"><a class=\"anchor\" href=\"#redis常见问题解决方案\">#</a> Redis 常见问题解决方案</h1>\n<h2 id=\"redis与mysql双写一致性方案\"><a class=\"anchor\" href=\"#redis与mysql双写一致性方案\">#</a> Redis 与 Mysql 双写一致性方案</h2>\n<p>先更新数据库，再删缓存。数据库的读操作的速度远快于写操作的，所以脏数据很难出现。可以对异步延时删除策略，保证读请求完成以后，再进行删除操作。</p>\n<h2 id=\"redis并发竞争key的解决方案\"><a class=\"anchor\" href=\"#redis并发竞争key的解决方案\">#</a> Redis 并发竞争 key 的解决方案</h2>\n<ul>\n<li>分布式锁 + 时间戳</li>\n<li>利用消息队列，把并行操作变成串行操作</li>\n</ul>\n<h2 id=\"如何解决redis缓存穿透问题\"><a class=\"anchor\" href=\"#如何解决redis缓存穿透问题\">#</a> 如何解决 Redis 缓存穿透问题</h2>\n<p>Redis 缓存穿透指查询的 key 缓存中没有，数据库也没有，每次针对此 key 的请求从缓存获取不到数据，请求就到数据库获取数据，从而可能压垮数据库。比如用一个不存在的用户 id 获取用户信息，不论缓存还是数据库都没有，若黑客利用此漏洞进行攻击可能压垮数据库<br />\n解决方案：</p>\n<ul>\n<li>在接口做校验</li>\n<li>存 null 值</li>\n<li>布隆过滤器：将所有可能的值映射到布隆过滤器中，查询时先判断 key 是否存在布隆过滤器中，存在才往下执行，如果不存在则直接返回。布隆过滤器将值进行多次哈希 bit 存储，布隆过滤器说某个元素在，可能会被误判。布隆过滤器说某个元素不在，那么一定不在。</li>\n</ul>\n<h2 id=\"如何解决redis缓存击穿问题\"><a class=\"anchor\" href=\"#如何解决redis缓存击穿问题\">#</a> 如何解决 Redis 缓存击穿问题</h2>\n<p>Redis 缓存击穿指查询的 key 缓存中不存在（通常由于失效而不存在），大量请求直接到数据库查询，压垮数据库。</p>\n<p>解决方案：</p>\n<ul>\n<li>互斥锁锁：业界比较常用的做法，是使用 mutex。简单的说当缓存失效时，不是立刻去查询数据库，而是先去争夺锁，</li>\n</ul>\n<h2 id=\"如何解决redis缓存雪崩\"><a class=\"anchor\" href=\"#如何解决redis缓存雪崩\">#</a> 如何解决 Redis 缓存雪崩</h2>\n<p>Redis 缓存雪崩指大量的 key 在同一时间失效，导致大量请求直接去数据库查询数据。缓存雪崩可以造成缓存服务器宕机，高峰期缓存失效，热点缓存失效。</p>\n<p>解决方案：</p>\n<ul>\n<li>给失效时间添加随机数</li>\n<li>热点数据设置永不失效</li>\n<li>缓存服务采用高可用架构</li>\n<li>建立监控系统，提前预知雪崩</li>\n</ul>\n<h1 id=\"redis和memcached的区别\"><a class=\"anchor\" href=\"#redis和memcached的区别\">#</a> Redis 和 memcached 的区别</h1>\n<ul>\n<li>存储方式<br />\n memcache 会把数据全部存在内存之中，断电后会挂掉，数据不能超过内存大小。redis 有部分数据存在硬盘上，这样能保证数据的持久性。</li>\n<li>数据支持类型<br />\n memcache 对数据类型的支持简单，只支持简单的 key-value，，而 redis 支持五种数据类型</li>\n<li>底层模型<br />\n它们之间底层实现方式以及与客户端之间通信的应用协议不一样。redis 直接自己构建了 VM 机制，因为一般的系统调用系统函数的话，会浪费一定的时间去移动和请求。</li>\n<li>value 的大小<br />\n redis 可以达到 1GB，而 memcache 只有 1MB。</li>\n</ul>\n",
            "tags": [
                "计算机科学",
                "数据库",
                "redis"
            ]
        },
        {
            "id": "http://yrmlnf.coding-pages.com/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/%E5%A4%A7%E6%95%B0%E6%8D%AE/%E6%95%B0%E6%8D%AE%E5%8F%AF%E8%A7%86%E5%8C%96/Superset-%E4%BA%8C%E6%AC%A1%E5%BC%80%E5%8F%91%E6%8C%87%E5%8D%97/",
            "url": "http://yrmlnf.coding-pages.com/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/%E5%A4%A7%E6%95%B0%E6%8D%AE/%E6%95%B0%E6%8D%AE%E5%8F%AF%E8%A7%86%E5%8C%96/Superset-%E4%BA%8C%E6%AC%A1%E5%BC%80%E5%8F%91%E6%8C%87%E5%8D%97/",
            "title": "Superset-二次开发指南",
            "date_published": "2021-04-16T06:41:00.000Z",
            "content_html": "<h1 id=\"操作系统\"><a class=\"anchor\" href=\"#操作系统\">#</a> 操作系统</h1>\n<ul class=\"task-list\">\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_0\" checked=\"true\" disabled=\"true\" /><label for=\"cbx_0\">  Windows</label></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_1\" checked=\"true\" disabled=\"true\" /><label for=\"cbx_1\">  MAC</label></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_2\" checked=\"true\" disabled=\"true\" /><label for=\"cbx_2\">  Linux</label></li>\n</ul>\n<h1 id=\"软件依赖\"><a class=\"anchor\" href=\"#软件依赖\">#</a> 软件依赖</h1>\n<p><span class=\"label info\">^ Lastest</span> <span class=\"label info\">~ minimum</span></p>\n<ul>\n<li>Python@3.6^</li>\n<li>Pip@~</li>\n<li>node.js@~</li>\n</ul>\n<h1 id=\"实验环境\"><a class=\"anchor\" href=\"#实验环境\">#</a> 实验环境</h1>\n<ul>\n<li>Windows10</li>\n<li>python@3.68</li>\n<li>pip@19.2.3</li>\n<li>setuptools@41.4.0</li>\n<li>nodejs@12.15.0</li>\n<li>npm@6.134</li>\n<li>superset@0.35</li>\n</ul>\n<div class=\"note warning\">\n<p>superset 版本变更比较大，本指南适用于 0.35 版本，其他版本不一定适用</p>\n</div>\n<h1 id=\"搭建开发环境\"><a class=\"anchor\" href=\"#搭建开发环境\">#</a> 搭建开发环境</h1>\n<ol>\n<li>从 github 上克隆一份源码，或者从别的压缩包解压一份源码 git 命令</li>\n</ol>\n<pre><code>git clone https://github.com/apache/incubator-superset.git\n</code></pre>\n<ol start=\"2\">\n<li>配置 pip 国内源</li>\n</ol>\n<pre><code>pip config set global.index-url https://pypi.tuna.tsinghua.edu.cn/simple\n</code></pre>\n<ol start=\"3\">\n<li>\n<p>安装 C++ buildTools, 下载地址为 (这个安装包 4g 大小，如果运行环境  搭建成功可以不安装)</p>\n<p><span class=\"exturl\" data-url=\"aHR0cDovL2dvLm1pY3Jvc29mdC5jb20vZndsaW5rLz9MaW5rSWQ9NjkxMTI2\">点击下载</span></p>\n</li>\n<li>\n<p>创建虚拟环境，参考上面，已经有就跳过</p>\n</li>\n<li>\n<p>安装依赖</p>\n</li>\n</ol>\n<pre><code>pip install -r requirements-dev.txt\n</code></pre>\n<ol start=\"6\">\n<li>制作软连接</li>\n</ol>\n<div class=\"note warning\">\n<p>因为下载下来的源代码是 superset\\static\\assets 这个软连接可以在 linux 或者 Mac 上正常工作，但是在 windows 下不能正常工作，不是 windows 环境可以跳过</p>\n</div>\n<div class=\"note info\">\n<p>yourpath 替换成你的路径<br />\n运行前先删除 yourpath\\incubator-superset\\superset\\static\\ 下的 assets 文件</p>\n</div>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>mklink /J <span class=\"token string\">\"yourpath\\incubator-superset\\superset\\static<span class=\"token entity\" title=\"\\a\">\\a</span>ssets\"</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token string\">\"yourpath\\incubator-superset\\superset<span class=\"token entity\" title=\"\\a\">\\a</span>ssets\"</span></pre></td></tr></table></figure><ol start=\"7\">\n<li>安装 superset 开发者模式</li>\n</ol>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>pip <span class=\"token function\">install</span> -e <span class=\"token builtin class-name\">.</span></pre></td></tr></table></figure><ol start=\"8\">\n<li>创建管理员账户，记住用户名跟密码，如果已经创建会报主键重复的错误，直接下一步</li>\n</ol>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>fabmanager create-admin --app superset</pre></td></tr></table></figure><ol start=\"9\">\n<li>进入 superset/bin 目录下，初始化数据库</li>\n</ol>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>python superset db upgrade</pre></td></tr></table></figure><ol start=\"10\">\n<li>应用初始化，后端配置完成</li>\n</ol>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>python superset init</pre></td></tr></table></figure><ol start=\"11\">\n<li>前端配置，进入 superset/assets 目录下，安装依赖</li>\n</ol>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">npm</span> <span class=\"token function\">install</span></pre></td></tr></table></figure><p>❌ 如果失败，请尝试</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>cnpm <span class=\"token function\">install</span></pre></td></tr></table></figure><p>❌ 如果都失败，删掉 node_model 文件夹后请尝试</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">npm</span> clean cache --force</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>cnpm <span class=\"token function\">install</span></pre></td></tr></table></figure><div class=\"note info\">\n<p>13.8 版本的 nodejs 安装过程会出现如下错误，建议换成 12.15 版本<br />\n<img data-src=\"1.png\" alt=\" \" /></p>\n</div>\n<ol start=\"12\">\n<li>执行下面代码，无报错则前端环境配置完成</li>\n</ol>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">npm</span> run dev</pre></td></tr></table></figure><p>⭕️ 若无报错，不要关闭，dev 是指开发模式，会自动编译你修改过的代码<br />\n<img data-src=\"2.png\" alt=\" \" /></p>\n<p>❌ 如果出现下面错误，执行<br />\n<img data-src=\"3.png\" alt=\" \" /></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">npm</span> <span class=\"token function\">install</span> --save-dev @babel/runtime-corejs3</pre></td></tr></table></figure><ol start=\"13\">\n<li>新建终端，进入目录 yourpath\\incubator-superset\\superset\\bin</li>\n</ol>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>python -m  flask run -p <span class=\"token number\">8088</span> --with-threads --reload --debugger</pre></td></tr></table></figure><ol start=\"14\">\n<li>打开网站 localhost:8088，如正常显示界面则搭建成功</li>\n<li>用相应的工具开发前后端即可，我个人习惯使用 Pycharm 开发 python，VSCode 开发前端</li>\n</ol>\n<h1 id=\"自定义jwt登录验证\"><a class=\"anchor\" href=\"#自定义jwt登录验证\">#</a> 自定义 JWT 登录验证</h1>\n<div class=\"note info\">\n<p>superset 自带 Flask-login 登录，但是实际项目需要使用无状态 token 登录，这时候我们修改下代码</p>\n</div>\n<h2 id=\"superset登录逻辑\"><a class=\"anchor\" href=\"#superset登录逻辑\">#</a> superset 登录逻辑</h2>\n<ol>\n<li>首先看到入口文件，superset/<strong>init</strong>.py 第 178 行，从第一行代码可以看到 superset 默认使用 SupersetSecurityManager 这个类作为登录验证类</li>\n</ol>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>custom_sm<span class=\"token operator\">=</span>app<span class=\"token punctuation\">.</span>config<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span><span class=\"token string\">\"CUSTOM_SECURITY_MANAGER\"</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">or</span> SupersetSecurityManager</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">if</span> <span class=\"token keyword\">not</span> <span class=\"token builtin\">issubclass</span><span class=\"token punctuation\">(</span>custom_sm<span class=\"token punctuation\">,</span> SupersetSecurityManager<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\t<span class=\"token keyword\">raise</span> Exception<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t\t<span class=\"token triple-quoted-string string\">\"\"\"Your CUSTOM_SECURITY_MANAGER must now </pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t\textend SupersetSecurityManager,</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t\tnot FAB's security manager.</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t\tSee [4565] in UPDATING.md</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t\t\"\"\"</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token keyword\">with</span> app<span class=\"token punctuation\">.</span>app_context<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\tappbuilder <span class=\"token operator\">=</span> AppBuilder<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t\tapp<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t\tdb<span class=\"token punctuation\">.</span>session<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t\tbase_template<span class=\"token operator\">=</span><span class=\"token string\">\"superset/base.html\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t\tindexview<span class=\"token operator\">=</span>MyIndexView<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t\tsecurity_manager_class<span class=\"token operator\">=</span>custom_sm<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t\tupdate_perms<span class=\"token operator\">=</span><span class=\"token boolean\">False</span><span class=\"token punctuation\">,</span>  </pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t\t<span class=\"token comment\"># Run `superset init` to update FAB's perms</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t<span class=\"token punctuation\">)</span></pre></td></tr></table></figure><ol start=\"2\">\n<li>查看 SupersetSecurityManager 父类的父类 BaseSecurityManager<br />\n 第 609 行，初始化的是这个 self.authdbview 类，即 AuthDBView</li>\n</ol>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">if</span> self<span class=\"token punctuation\">.</span>auth_type <span class=\"token operator\">==</span> AUTH_DB<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>\tself<span class=\"token punctuation\">.</span>user_view <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>userdbmodelview</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\tself<span class=\"token punctuation\">.</span>auth_view <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>authdbview<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><ol start=\"3\">\n<li>查看 AuthDBView 类，里面写了登录的方法，所以只要我们重写 SupersetSecurityManager 和 AuthDBView 类就可以了</li>\n</ol>\n<h2 id=\"编写自己的jwt验证\"><a class=\"anchor\" href=\"#编写自己的jwt验证\">#</a> 编写自己的 JWT 验证</h2>\n<ol>\n<li>\n<p>在 superset 下新建文件夹 customize<br />\n<img data-src=\"4.png\" alt=\"\" /></p>\n</li>\n<li>\n<p><span class=\"exturl\" data-url=\"aHR0cDovL3huLS1DdXN0b21BdXRoREJWaWV3LXJ3OTRhc3oyZi5weQ==\">新建 CustomAuthDBView.py</span></p>\n</li>\n</ol>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">import</span> jwt</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> flask_appbuilder<span class=\"token punctuation\">.</span>baseviews <span class=\"token keyword\">import</span> expose</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">from</span> flask_appbuilder<span class=\"token punctuation\">.</span>security<span class=\"token punctuation\">.</span>views <span class=\"token keyword\">import</span> AuthView</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">from</span> flask_appbuilder<span class=\"token punctuation\">.</span>security<span class=\"token punctuation\">.</span>forms <span class=\"token keyword\">import</span> LoginForm_db</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">from</span> flask_appbuilder<span class=\"token punctuation\">.</span>_compat <span class=\"token keyword\">import</span> as_unicode</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">from</span> flask <span class=\"token keyword\">import</span> flash<span class=\"token punctuation\">,</span> redirect<span class=\"token punctuation\">,</span> request<span class=\"token punctuation\">,</span>g</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">from</span> flask_login <span class=\"token keyword\">import</span> login_user</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">import</span> time</pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name\">CustomAuthDBView</span><span class=\"token punctuation\">(</span>AuthView<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\tlogin_template <span class=\"token operator\">=</span> <span class=\"token string\">\"appbuilder/general/security/login_db.html\"</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t<span class=\"token decorator annotation punctuation\">@expose</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/login/\"</span><span class=\"token punctuation\">,</span> methods<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"GET\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"POST\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t<span class=\"token keyword\">def</span> <span class=\"token function\">login</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t\ttoken_dict <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t\t\t<span class=\"token string\">'expiry'</span><span class=\"token punctuation\">:</span><span class=\"token builtin\">int</span><span class=\"token punctuation\">(</span>time<span class=\"token punctuation\">.</span>time<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t\t\t<span class=\"token string\">'user_name'</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'admin'</span>  <span class=\"token comment\"># 自定义的参数</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t\t<span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"============create===========\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t\tencoded_str <span class=\"token operator\">=</span> <span class=\"token builtin\">str</span><span class=\"token punctuation\">(</span>jwt<span class=\"token punctuation\">.</span>encode<span class=\"token punctuation\">(</span>token_dict<span class=\"token punctuation\">,</span> <span class=\"token string\">'secret'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t\tencoding<span class=\"token operator\">=</span><span class=\"token string\">'ascii'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t\t<span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>encoded_str<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t\ttoken <span class=\"token operator\">=</span> request<span class=\"token punctuation\">.</span>args<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span><span class=\"token string\">'token'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> token <span class=\"token keyword\">is</span> <span class=\"token keyword\">not</span> <span class=\"token boolean\">None</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t\t\t<span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"==========decode=========\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\t\t\tjwt_decode <span class=\"token operator\">=</span> jwt<span class=\"token punctuation\">.</span>decode<span class=\"token punctuation\">(</span>token<span class=\"token punctuation\">,</span> <span class=\"token string\">'secret'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\t\t\texpiry <span class=\"token operator\">=</span> jwt_decode<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span><span class=\"token string\">\"expiry\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\t\t\tuser_name <span class=\"token operator\">=</span> jwt_decode<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span><span class=\"token string\">\"user_name\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\t\t\t<span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>expiry<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\t\t\t<span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>user_name<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\t\t\t<span class=\"token keyword\">if</span> time<span class=\"token punctuation\">.</span>time<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> expiry <span class=\"token operator\">>=</span> <span class=\"token number\">600</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>\t\t\t\tflash<span class=\"token punctuation\">(</span>as_unicode<span class=\"token punctuation\">(</span><span class=\"token string\">\"token失效\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"warning\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>\t\t\t\t<span class=\"token keyword\">return</span> redirect<span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>appbuilder<span class=\"token punctuation\">.</span>get_url_for_login<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>\t\t\tuser <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>appbuilder<span class=\"token punctuation\">.</span>sm<span class=\"token punctuation\">.</span>find_user<span class=\"token punctuation\">(</span>username<span class=\"token operator\">=</span>user_name<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>\t\t\t<span class=\"token keyword\">if</span> user<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>\t\t\t\tlogin_user<span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">,</span> remember<span class=\"token operator\">=</span><span class=\"token boolean\">False</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>\t\t\t\t<span class=\"token keyword\">return</span> redirect<span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>appbuilder<span class=\"token punctuation\">.</span>get_url_for_index<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> g<span class=\"token punctuation\">.</span>user <span class=\"token keyword\">is</span> <span class=\"token keyword\">not</span> <span class=\"token boolean\">None</span> <span class=\"token keyword\">and</span> g<span class=\"token punctuation\">.</span>user<span class=\"token punctuation\">.</span>is_authenticated<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>\t\t\t<span class=\"token keyword\">return</span> redirect<span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>appbuilder<span class=\"token punctuation\">.</span>get_url_for_index<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>\t\tform <span class=\"token operator\">=</span> LoginForm_db<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> form<span class=\"token punctuation\">.</span>validate_on_submit<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>\t\t\tuser <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>appbuilder<span class=\"token punctuation\">.</span>sm<span class=\"token punctuation\">.</span>auth_user_db<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>\t\t\t\tform<span class=\"token punctuation\">.</span>username<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">,</span> form<span class=\"token punctuation\">.</span>password<span class=\"token punctuation\">.</span>data</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>\t\t\t<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>\t\t\t<span class=\"token keyword\">if</span> <span class=\"token keyword\">not</span> user<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>\t\t\t\tflash<span class=\"token punctuation\">(</span>as_unicode<span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>invalid_login_message<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>\t\t\t\t<span class=\"token punctuation\">,</span> <span class=\"token string\">\"warning\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>\t\t\t\t<span class=\"token keyword\">return</span> redirect<span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>appbuilder<span class=\"token punctuation\">.</span>get_url_for_login<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>\t\t\tlogin_user<span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">,</span> remember<span class=\"token operator\">=</span><span class=\"token boolean\">False</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>\t\t\t<span class=\"token keyword\">return</span> redirect<span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>appbuilder<span class=\"token punctuation\">.</span>get_url_for_index<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>\t\t<span class=\"token keyword\">return</span> self<span class=\"token punctuation\">.</span>render_template<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>\t\t\tself<span class=\"token punctuation\">.</span>login_template<span class=\"token punctuation\">,</span> title<span class=\"token operator\">=</span>self<span class=\"token punctuation\">.</span>title<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>\t\t\tform<span class=\"token operator\">=</span>form<span class=\"token punctuation\">,</span> appbuilder<span class=\"token operator\">=</span>self<span class=\"token punctuation\">.</span>appbuilder</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>\t\t<span class=\"token punctuation\">)</span></pre></td></tr></table></figure><ol start=\"3\">\n<li><span class=\"exturl\" data-url=\"aHR0cDovL3huLS1DdXN0b21TZWN1cml0eU1hbmFnZXItd204NGI3eDlmLnB5\">新建 CustomSecurityManager.py</span></li>\n</ol>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">from</span> superset<span class=\"token punctuation\">.</span>customize<span class=\"token punctuation\">.</span>views<span class=\"token punctuation\">.</span>CustomAuthDBView <span class=\"token keyword\">import</span> CustomAuthDBView</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> superset<span class=\"token punctuation\">.</span>security <span class=\"token keyword\">import</span> SupersetSecurityManager</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name\">CustomSecurityManager</span><span class=\"token punctuation\">(</span>SupersetSecurityManager<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    authdbview <span class=\"token operator\">=</span> CustomAuthDBView</pre></td></tr></table></figure><ol start=\"4\">\n<li>修改 /superset/config.py, 将</li>\n</ol>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>CUSTOM_SECURITY_MANAGER <span class=\"token operator\">=</span> <span class=\"token boolean\">None</span></pre></td></tr></table></figure><p>修改为</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">from</span> superset<span class=\"token punctuation\">.</span>customize<span class=\"token punctuation\">.</span>views<span class=\"token punctuation\">.</span>CustomSecurityManager <span class=\"token keyword\">import</span> CustomSecurityManager</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>CUSTOM_SECURITY_MANAGER <span class=\"token operator\">=</span> CustomSecurityManager</pre></td></tr></table></figure><ol start=\"5\">\n<li>\n<p>启动服务，打开登陆界面.<span class=\"exturl\" data-url=\"aHR0cDovLzEyNy4wLjAuMTo4MDg4L2xvZ2luLw==\">http://127.0.0.1:8088/login/</span><br />\n<img data-src=\"5.png\" alt=\"\" /></p>\n</li>\n<li>\n<p>将打印的 token 作为参数，<span class=\"exturl\" data-url=\"aHR0cDovLzEyNy4wLjAuMTo4MDg4L2xvZ2luLz90b2tlbj1leUowZVhBaU9pSktWMVFpTENKaGJHY2lPaUpJVXpJMU5pSjkuZXlKbGVIQnBjbmtpT2pFMU9ERXhOekU1TkRRc0luVnpaWEpmYm1GdFpTSTZJbUZrYldsdUluMC5QcVZydnltM0w2djJ5TkRDUGNJQlBtaHEzM25UVUpuLXFfZGdnNXRTVGZV\">http://127.0.0.1:8088/login/?token=eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJleHBpcnkiOjE1ODExNzE5NDQsInVzZXJfbmFtZSI6ImFkbWluIn0.PqVrvym3L6v2yNDCPcIBPmhq33nTUJn-q_dgg5tSTfU</span>, 就能直接登录了，具体登录逻辑可以自己开发，这里只判断了用户名与时效</p>\n</li>\n</ol>\n<h1 id=\"superset集成echarts\"><a class=\"anchor\" href=\"#superset集成echarts\">#</a> Superset 集成 Echarts</h1>\n<h2 id=\"后端\"><a class=\"anchor\" href=\"#后端\">#</a> 后端</h2>\n<p>修改 superset\\viz.py 文件 (这里是所有图表的后端处理文件，每一类对应一个图表的后端处理方法), 添加一个类 Echart</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name\">EchartsBarViz</span><span class=\"token punctuation\">(</span>BaseViz<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    viz_type <span class=\"token operator\">=</span> <span class=\"token string\">'echarts_bar'</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    verbose_name <span class=\"token operator\">=</span> <span class=\"token string\">\"Echarts Bar\"</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    is_timeseries <span class=\"token operator\">=</span> <span class=\"token boolean\">True</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">def</span> <span class=\"token function\">query_obj</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        d <span class=\"token operator\">=</span> <span class=\"token builtin\">super</span><span class=\"token punctuation\">(</span>TimeSeriesScatterViz<span class=\"token punctuation\">,</span> self<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>query_obj<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        fd <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>form_data  <span class=\"token comment\"># form_data 中包含界面左侧组件内容</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token keyword\">not</span> fd<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span><span class=\"token string\">'all_columns'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> </pre></td></tr><tr><td data-num=\"11\"></td><td><pre>            <span class=\"token keyword\">raise</span> Exception<span class=\"token punctuation\">(</span><span class=\"token string\">'Choose Columns'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token keyword\">if</span> fd<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span><span class=\"token string\">'all_columns'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>            d<span class=\"token punctuation\">[</span><span class=\"token string\">'columns'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> fd<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span><span class=\"token string\">'all_columns'</span><span class=\"token punctuation\">)</span> </pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token keyword\">return</span> d</pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token keyword\">def</span> <span class=\"token function\">get_data</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> df<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        data <span class=\"token operator\">=</span> np<span class=\"token punctuation\">.</span>array<span class=\"token punctuation\">(</span>df<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>tolist<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        <span class=\"token keyword\">return</span> data</pre></td></tr></table></figure><p>query_obj 方法是在前查询的时候执行的，get_data 方法是在查询时候执行的<br />\n viz_type 是用来标识这个函数属于哪个前端图表的，必须与前端的注册文件一一对应，verbose_name 是别名，目前没用</p>\n<h2 id=\"前端\"><a class=\"anchor\" href=\"#前端\">#</a> 前端</h2>\n<ol>\n<li>首先新建一个文件夹 EchartsBar<br />\n<img data-src=\"6.png\" alt=\"\" /></li>\n<li>新建入口文件 index.js, 入口文件主要调用了 ReactEcharsBar.js 和 tansformProps.js，还有配置一些属性</li>\n</ol>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token punctuation\">&#123;</span> t <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'@superset-ui/translation'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token punctuation\">&#123;</span> ChartMetadata<span class=\"token punctuation\">,</span> ChartPlugin <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'@superset-ui/chart'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">import</span> transformProps <span class=\"token keyword\">from</span> <span class=\"token string\">'./transformProps'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">import</span> thumbnail <span class=\"token keyword\">from</span> <span class=\"token string\">'./images/thumbnail.png'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">const</span> metadata <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ChartMetadata</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  name<span class=\"token operator\">:</span> <span class=\"token function\">t</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Echart Bar'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  description<span class=\"token operator\">:</span> <span class=\"token string\">''</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  credits<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'http://echarts.baidu.com/examples/editor.html?c=scatter-effect'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  thumbnail<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">TimeSeriesScatterChartPlugin</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">ChartPlugin</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  <span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token keyword\">super</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>      metadata<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      transformProps<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      <span class=\"token function-variable function\">loadChart</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">import</span><span class=\"token punctuation\">(</span><span class=\"token string\">'./ReactEchartsBar.js'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><ol start=\"2\">\n<li>创建 transformProps.js, 这是用来整理数据的文件</li>\n</ol>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> <span class=\"token keyword\">function</span> <span class=\"token function\">transformProps</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">chartProps</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> width<span class=\"token punctuation\">,</span> height<span class=\"token punctuation\">,</span> queryData <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> chartProps<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token comment\">//console.log (chartProps); 可以用来验证数据是否正确</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    data<span class=\"token operator\">:</span> queryData<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    width<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    height<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><ol start=\"3\">\n<li>新建 ReactEcharsBar.js, 这是画图的入口文件，主要调用了 EcharsBar.js</li>\n</ol>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token punctuation\">&#123;</span> reactify <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'@superset-ui/chart'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">import</span> Component <span class=\"token keyword\">from</span> <span class=\"token string\">'./EchartsBar'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> <span class=\"token function\">reactify</span><span class=\"token punctuation\">(</span>Component<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><ol start=\"4\">\n<li>新建 EchartsBar.js, 这里引入了 EchartsBar.css 文件。这里的数据是从数据库里拿出来的，可以先把处理数据的代码去掉，然后写死数据来测试，否则会报错</li>\n</ol>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">import</span> d3 <span class=\"token keyword\">from</span> <span class=\"token string\">'d3'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">import</span> PropTypes <span class=\"token keyword\">from</span> <span class=\"token string\">'prop-types'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token punctuation\">&#123;</span> CategoricalColorNamespace <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'@superset-ui/color'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token punctuation\">&#123;</span> getNumberFormatter <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'@superset-ui/number-format'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token string\">'./EchartsBar.css'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">import</span> echarts <span class=\"token keyword\">from</span> <span class=\"token string\">'echarts'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">const</span> propTypes <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  data<span class=\"token operator\">:</span> PropTypes<span class=\"token punctuation\">.</span>array<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  width<span class=\"token operator\">:</span> PropTypes<span class=\"token punctuation\">.</span>number<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  height<span class=\"token operator\">:</span> PropTypes<span class=\"token punctuation\">.</span>number<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token keyword\">function</span> <span class=\"token function\">EchartsBar</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">element<span class=\"token punctuation\">,</span> props</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> data<span class=\"token punctuation\">,</span> width<span class=\"token punctuation\">,</span> height <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> props<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  element<span class=\"token punctuation\">.</span>innerHTML <span class=\"token operator\">=</span> <span class=\"token string\">''</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  <span class=\"token comment\">// 处理数据</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  <span class=\"token keyword\">var</span> echars_xAxis <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  <span class=\"token keyword\">var</span> echars_series <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  data<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">val<span class=\"token punctuation\">,</span> idx<span class=\"token punctuation\">,</span> array</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t <span class=\"token keyword\">var</span> index <span class=\"token operator\">=</span> echars_xAxis<span class=\"token punctuation\">.</span><span class=\"token function\">indexOf</span><span class=\"token punctuation\">(</span>val<span class=\"token punctuation\">[</span><span class=\"token number\">4</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>index <span class=\"token operator\">==</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t\t echars_xAxis<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>val<span class=\"token punctuation\">[</span><span class=\"token number\">4</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\t\t echars_series<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\t <span class=\"token punctuation\">&#125;</span><span class=\"token keyword\">else</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\t\t echars_series<span class=\"token punctuation\">[</span>index<span class=\"token punctuation\">]</span> <span class=\"token operator\">+=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\t <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>  <span class=\"token keyword\">const</span> div <span class=\"token operator\">=</span> d3<span class=\"token punctuation\">.</span><span class=\"token function\">select</span><span class=\"token punctuation\">(</span>element<span class=\"token punctuation\">,</span> props<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>  <span class=\"token keyword\">var</span> html <span class=\"token operator\">=</span> <span class=\"token string\">'&lt;div id=\"myChart\" style=\"height:'</span> <span class=\"token operator\">+</span> height <span class=\"token operator\">+</span> </pre></td></tr><tr><td data-num=\"33\"></td><td><pre>  <span class=\"token string\">'px; width:'</span> <span class=\"token operator\">+</span> width <span class=\"token operator\">+</span> <span class=\"token string\">'px;\">&lt;/div>'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>  div<span class=\"token punctuation\">.</span><span class=\"token function\">html</span><span class=\"token punctuation\">(</span>html<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 给 echarts 添加 div</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>  <span class=\"token keyword\">var</span> myChart <span class=\"token operator\">=</span> echarts<span class=\"token punctuation\">.</span><span class=\"token function\">init</span><span class=\"token punctuation\">(</span>document<span class=\"token punctuation\">.</span><span class=\"token function\">getElementById</span><span class=\"token punctuation\">(</span><span class=\"token string\">'myChart'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 初始化 echarts</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>  <span class=\"token keyword\">var</span> option <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>      xAxis<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>          type<span class=\"token operator\">:</span> <span class=\"token string\">'category'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>          data<span class=\"token operator\">:</span> echars_xAxis<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>\t\t  <span class=\"token string\">\"axisLabel\"</span><span class=\"token operator\">:</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>\t\t      \t\tinterval<span class=\"token operator\">:</span> <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>      yAxis<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>          type<span class=\"token operator\">:</span> <span class=\"token string\">'value'</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>      series<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>          data<span class=\"token operator\">:</span> echars_series<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>          type<span class=\"token operator\">:</span> <span class=\"token string\">'bar'</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>  myChart<span class=\"token punctuation\">.</span><span class=\"token function\">setOption</span><span class=\"token punctuation\">(</span>option<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre></pre></td></tr><tr><td data-num=\"54\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>EchartsBar<span class=\"token punctuation\">.</span>displayName <span class=\"token operator\">=</span> <span class=\"token string\">'Echarts Bar'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>EchartsBar<span class=\"token punctuation\">.</span>propTypes <span class=\"token operator\">=</span> propTypes<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre></pre></td></tr><tr><td data-num=\"59\"></td><td><pre><span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> EchartsBar<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><ol start=\"5\">\n<li>创建 EchartsBar.css 文件，可以在里面自己写样式</li>\n</ol>\n<figure class=\"highlight css\"><figcaption data-lang=\"CSS\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token selector\">.superset-legacy-chart-chord svg #circle circle</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token property\">fill</span><span class=\"token punctuation\">:</span> none<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token property\">pointer-events</span><span class=\"token punctuation\">:</span> all<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token selector\">.superset-legacy-chart-chord svg .group path</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token property\">fill-opacity</span><span class=\"token punctuation\">:</span> 0.6<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token selector\">.superset-legacy-chart-chord svg path.chord</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token property\">stroke</span><span class=\"token punctuation\">:</span> #000<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  <span class=\"token property\">stroke-width</span><span class=\"token punctuation\">:</span> 0.25px<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token selector\">.superset-legacy-chart-chord svg #circle:hover path.fade</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  <span class=\"token property\">opacity</span><span class=\"token punctuation\">:</span> 0.2<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><ol start=\"6\">\n<li>\n<p>创建文件夹 images, 里面放两张图片，一个命名为 thumbnail.png，一个命名为 thumbnailLarge.png, 这两张是选择图例的封面图。</p>\n</li>\n<li>\n<p>注册图例，打开 /superset/visualizations/presets/MainPreset.js, 添加以下代码</p>\n</li>\n</ol>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">import</span> EchartsBar <span class=\"token keyword\">from</span> <span class=\"token string\">'../EchartsBar/index.js'</span></pre></td></tr></table></figure><p><img data-src=\"7.png\" alt=\"\" /></p>\n<ol start=\"8\">\n<li>新建图表搜索面板文件，在 /superset/explore/controlPanels/ 下新建文件 EchartsBar.js, 这里定义了左边的搜索条件</li>\n</ol>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token punctuation\">&#123;</span> t <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'@superset-ui/translation'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  controlPanelSections<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>      <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>          label<span class=\"token operator\">:</span> <span class=\"token function\">t</span><span class=\"token punctuation\">(</span><span class=\"token string\">'NOT GROUPED BY'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>  </pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t\t  <span class=\"token comment\">// 控制块标题，可以有多个控制块，一块包含多个组件</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>          description<span class=\"token operator\">:</span> <span class=\"token function\">t</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Use this section if you want to query atomic rows'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> </pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t\t  <span class=\"token comment\">// 描述</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>          expanded<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>          controlSetRows<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>              <span class=\"token punctuation\">[</span><span class=\"token string\">'all_columns'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>  <span class=\"token comment\">// 使用的组件名</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>              <span class=\"token punctuation\">[</span><span class=\"token string\">'row_limit'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>          <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><ol start=\"9\">\n<li>注册面板<br />\n在 /superset/setup/setupPlugins.ts 添加下面代码</li>\n</ol>\n<pre><code>import EchartsBar from '../explore/controlPanels/EchartsBar';\n</code></pre>\n<p><img data-src=\"9.png\" alt=\"\" /></p>\n<ol start=\"10\">\n<li>重启前后端服务器，打开网页就可以看见新的图例<br />\n<img data-src=\"10.png\" alt=\"\" /><br />\n<img data-src=\"11.png\" alt=\"\" /></li>\n</ol>\n<h1 id=\"自定义页面\"><a class=\"anchor\" href=\"#自定义页面\">#</a> 自定义页面</h1>\n<h2 id=\"新增路由\"><a class=\"anchor\" href=\"#新增路由\">#</a> 新增路由</h2>\n<p>在 superset/view/core.py 最下面添加代码</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name\">lucas</span><span class=\"token punctuation\">(</span>BaseSupersetView<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>\troute_base <span class=\"token operator\">=</span> <span class=\"token string\">'/lucas'</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\tdefault_view <span class=\"token operator\">=</span> <span class=\"token string\">'theme'</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token decorator annotation punctuation\">@expose</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/theme/\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">def</span> <span class=\"token function\">theme</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token keyword\">return</span> self<span class=\"token punctuation\">.</span>render_template<span class=\"token punctuation\">(</span><span class=\"token string\">\"superset/theme.html\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>appbuilder<span class=\"token punctuation\">.</span>add_view_no_menu<span class=\"token punctuation\">(</span>lucas<span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>其中 route_base 是根路由，default_view 是默认视图路由<br />\n重启服务器，访问 http://127.0.0.1:8088/lucas/theme/<br />\n<img data-src=\"12.png\" alt=\"\" /><br />\n 这里只是随便返回了一个 html 页面，可以根据自己的需求来写逻辑</p>\n<h2 id=\"新增菜单选项\"><a class=\"anchor\" href=\"#新增菜单选项\">#</a> 新增菜单选项</h2>\n<p>在 superset/view/core.py 最下面添加代码，主要是 add_link 和 add_view 函数</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name\">lucas</span><span class=\"token punctuation\">(</span>BaseSupersetView<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    route_base <span class=\"token operator\">=</span> <span class=\"token string\">'/lucas'</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\tdefault_view <span class=\"token operator\">=</span> <span class=\"token string\">'theme'</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token decorator annotation punctuation\">@expose</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/theme/\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">def</span> <span class=\"token function\">theme</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token keyword\">return</span> self<span class=\"token punctuation\">.</span>render_template<span class=\"token punctuation\">(</span><span class=\"token string\">\"superset/theme.html\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>appbuilder<span class=\"token punctuation\">.</span>add_view<span class=\"token punctuation\">(</span>lucas<span class=\"token punctuation\">,</span><span class=\"token string\">'Hello'</span><span class=\"token punctuation\">,</span>category<span class=\"token operator\">=</span><span class=\"token string\">'My View'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>appbuilder<span class=\"token punctuation\">.</span>add_link<span class=\"token punctuation\">(</span><span class=\"token string\">'message'</span><span class=\"token punctuation\">,</span>href<span class=\"token operator\">=</span><span class=\"token string\">'/lucas/theme/'</span><span class=\"token punctuation\">,</span>category<span class=\"token operator\">=</span><span class=\"token string\">'My View'</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>重新执行 python superset init, 启动服务<br />\n<img data-src=\"13.png\" alt=\"\" /></p>\n<h2 id=\"新增react页面\"><a class=\"anchor\" href=\"#新增react页面\">#</a> 新增 React 页面</h2>\n<ol>\n<li>\n<p>首先复制一份 superset\\assets\\src\\welcome 文件夹到 superset\\assets\\src\\ 下并改名为 myView<br />\n<img data-src=\"14.png\" alt=\"\" /></p>\n</li>\n<li>\n<p>修改 superset\\assets\\webpack.config.js 文件，搜索 entry，找到代码，新增自己的页面 (myView)</p>\n</li>\n</ol>\n<figure class=\"highlight javascript\"><figcaption data-lang=\"javascript\"><span>mark: 10</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre>entry<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    theme<span class=\"token operator\">:</span> path<span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span><span class=\"token constant\">APP_DIR</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'/src/theme.js'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    preamble<span class=\"token operator\">:</span> <span class=\"token constant\">PREAMBLE</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    addSlice<span class=\"token operator\">:</span> <span class=\"token function\">addPreamble</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/src/addSlice/index.jsx'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    explore<span class=\"token operator\">:</span> <span class=\"token function\">addPreamble</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/src/explore/index.jsx'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    dashboard<span class=\"token operator\">:</span> <span class=\"token function\">addPreamble</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/src/dashboard/index.jsx'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    sqllab<span class=\"token operator\">:</span> <span class=\"token function\">addPreamble</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/src/SqlLab/index.jsx'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    welcome<span class=\"token operator\">:</span> <span class=\"token function\">addPreamble</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/src/welcome/index.jsx'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    profile<span class=\"token operator\">:</span> <span class=\"token function\">addPreamble</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/src/profile/index.jsx'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token operator\">+</span> myView<span class=\"token operator\">:</span> <span class=\"token function\">addPreamble</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/src/myView/index.jsx'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    showSavedQuery<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>path<span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span><span class=\"token constant\">APP_DIR</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'/src/showSavedQuery/index.jsx'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr></table></figure><ol start=\"3\">\n<li>编译项目</li>\n</ol>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">npm</span> run build</pre></td></tr></table></figure><ol start=\"4\">\n<li>去掉 superset 的导航栏</li>\n</ol>\n<p>新增默认模板，复制 /superset/templates/superset/basic.html 到 /superset/templates/superset/, 改名为 myBasic.html<br />\n 删除以下代码</p>\n<pre><code class=\"language-xhtml\">\n    &#123;% block navbar %&#125;\n      &#123;% if not standalone_mode %&#125;\n        <header class=\"top\" role=\"header\">\n          &#123;% include 'appbuilder/navbar.html' %&#125;\n        </header>\n      &#123;% endif %&#125;\n    &#123;% endblock %&#125;\n\n</code></pre>\n<ol start=\"5\">\n<li>后端新增路由<br />\n在 /superset/views/core.py 最下面新增代码，myBasic.html 是我们自定义默认模板，myView 是 react 的入口文件，<br />\nbootstrap 是配置数据，myView 要和我们前面定义的 myView 对应上。</li>\n</ol>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name\">lucas</span><span class=\"token punctuation\">(</span>BaseSupersetView<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    route_base <span class=\"token operator\">=</span> <span class=\"token string\">'/lucas'</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\tdefault_view <span class=\"token operator\">=</span> <span class=\"token string\">'theme'</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token decorator annotation punctuation\">@expose</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/theme/\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">def</span> <span class=\"token function\">theme</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        d <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>            <span class=\"token string\">\"defaultDbId\"</span><span class=\"token punctuation\">:</span> config<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span><span class=\"token string\">\"SQLLAB_DEFAULT_DBID\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>            <span class=\"token string\">\"common\"</span><span class=\"token punctuation\">:</span> self<span class=\"token punctuation\">.</span>common_bootstrap_payload<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token keyword\">return</span> self<span class=\"token punctuation\">.</span>render_template<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>            <span class=\"token string\">\"superset/myBasic.html\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>            entry<span class=\"token operator\">=</span><span class=\"token string\">\"myView\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>            bootstrap_data<span class=\"token operator\">=</span>json<span class=\"token punctuation\">.</span>dumps<span class=\"token punctuation\">(</span>d<span class=\"token punctuation\">,</span> default<span class=\"token operator\">=</span>utils<span class=\"token punctuation\">.</span>json_iso_dttm_ser<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>appbuilder<span class=\"token punctuation\">.</span>add_view<span class=\"token punctuation\">(</span>lucas<span class=\"token punctuation\">,</span><span class=\"token string\">'Hello'</span><span class=\"token punctuation\">,</span>category<span class=\"token operator\">=</span><span class=\"token string\">'My View'</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><ol start=\"6\">\n<li>重启 superset, 打开 http://127.0.0.1:8088/lucas/theme/，就会进入没有导航栏的 react 首页，然后再根据需求使用 react 开发页面即可</li>\n</ol>\n<h1 id=\"视图与角色权限\"><a class=\"anchor\" href=\"#视图与角色权限\">#</a> 视图与角色权限</h1>\n<div class=\"note info\">\n<p>superset 默认把角色与视图的权限存在了 sqlite (可更改) 里了，如果要新增权限我们要在数据库里插入数据，主要是三个表 ab_permission,ab_permission_view,ab_view_menu。<br />\n我们需要在表中插入相关权限数据，分别是三个表 ab_permission,ab_permission_view,ab_view_menu，然后给路由添加 @has_access 或者 @has_access_api 的注解</p>\n</div>\n<h2 id=\"控制权限代码块\"><a class=\"anchor\" href=\"#控制权限代码块\">#</a> 控制权限代码块</h2>\n<div class=\"note info\">\n<p>@has_access 用于视图，@has_access_api 用于 api</p>\n</div>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">from</span> flask_appbuilder<span class=\"token punctuation\">.</span>security<span class=\"token punctuation\">.</span>decorators <span class=\"token keyword\">import</span> permission_name</pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name\">lucas</span><span class=\"token punctuation\">(</span>BaseSupersetView<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\troute_base <span class=\"token operator\">=</span> <span class=\"token string\">'/lucas'</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\tdefault_view <span class=\"token operator\">=</span> <span class=\"token string\">'theme'</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\tclass_permission_name <span class=\"token operator\">=</span> <span class=\"token string\">'Api'</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t<span class=\"token decorator annotation punctuation\">@has_access</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t<span class=\"token decorator annotation punctuation\">@permission_name</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"query_form_data\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t<span class=\"token decorator annotation punctuation\">@expose</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/theme/\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t<span class=\"token keyword\">def</span> <span class=\"token function\">theme</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t\t<span class=\"token keyword\">return</span> self<span class=\"token punctuation\">.</span>render_template<span class=\"token punctuation\">(</span><span class=\"token string\">\"superset/theme.html\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>appbuilder<span class=\"token punctuation\">.</span>add_view<span class=\"token punctuation\">(</span>lucas<span class=\"token punctuation\">,</span><span class=\"token string\">'Hello'</span><span class=\"token punctuation\">,</span>category<span class=\"token operator\">=</span><span class=\"token string\">'My View'</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><h2 id=\"插入权限数据\"><a class=\"anchor\" href=\"#插入权限数据\">#</a> 插入权限数据</h2>\n<p>class_permission_name = 'Api' 中的 api<br />\n@permission_name (&quot;query_form_data&quot;) 中的 query_form_data 都是数据库里默认存在的数据，<br />\n我们可以插入不同权限数据，然后修改这两个属性就可以达到新增权限的效果，有以下两种方法</p>\n<ul>\n<li>在三个表 ab_permission,ab_permission_view,ab_view_menu 中插入数据</li>\n<li>在上面代码下加入 db.create_all ()，然后运行 superset init 初始化系统自动创建权限</li>\n</ul>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>db.create_all<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><h1 id=\"自定义内置参数\"><a class=\"anchor\" href=\"#自定义内置参数\">#</a> 自定义内置参数</h1>\n<h2 id=\"修改源码\"><a class=\"anchor\" href=\"#修改源码\">#</a> 修改源码</h2>\n<p>修改源码路径源代码路径：superset &gt; jinja_context.py<br />\n 在 filter_values 方法后面添加如下代码</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">def</span> <span class=\"token function\">get_tenantid</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> Optional<span class=\"token punctuation\">[</span><span class=\"token builtin\">int</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token builtin\">hasattr</span><span class=\"token punctuation\">(</span>g<span class=\"token punctuation\">,</span> <span class=\"token string\">\"user\"</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">and</span> g<span class=\"token punctuation\">.</span>user<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        <span class=\"token comment\"># 需根据 username 从新用户管理平台上面获取对应用户的 tenantid</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token number\">5</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token boolean\">None</span></pre></td></tr></table></figure><p>在 BaseTemplateProcessor 类的 _ init _ 方法中修改如下内容：<br />\n在该 context 中添加 &quot;get_tenantid&quot;: get_tenantid，即下面代码的第四个参数</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"><span>mark: 5</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre>self<span class=\"token punctuation\">.</span>context <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>            <span class=\"token string\">\"url_param\"</span><span class=\"token punctuation\">:</span> url_param<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>            <span class=\"token string\">\"current_user_id\"</span><span class=\"token punctuation\">:</span> current_user_id<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>            <span class=\"token string\">\"current_username\"</span><span class=\"token punctuation\">:</span> current_username<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>            <span class=\"token string\">\"get_tenantid\"</span><span class=\"token punctuation\">:</span> get_tenantid<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>            <span class=\"token string\">\"cache_key_wrapper\"</span><span class=\"token punctuation\">:</span> CacheKeyWrapper<span class=\"token punctuation\">(</span>extra_cache_keys<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>cache_key_wrapper<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>            <span class=\"token string\">\"filter_values\"</span><span class=\"token punctuation\">:</span> filter_values<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>            <span class=\"token string\">\"form_data\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"使用方法\"><a class=\"anchor\" href=\"#使用方法\">#</a> 使用方法</h2>\n<p>以下测试均使用 superset 自带的 example 数据库，schema 为 main，表名为 ab_permission</p>\n<p>在 SQLLab 或者数据源使用</p>\n<p>去掉 \\ 号</p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">FROM</span> ab_permission </pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">WHERE</span> id <span class=\"token operator\">=</span> \\&#123;\\&#123; get_tenantid<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>&#125;&#125;</pre></td></tr></table></figure><h1 id=\"设置superset默认中文\"><a class=\"anchor\" href=\"#设置superset默认中文\">#</a> 设置 Superset 默认中文</h1>\n<p>修改 config.py 文件<br />\n找到</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>BABEL_DEFAULT_LOCALE <span class=\"token operator\">=</span> <span class=\"token string\">\"en\"</span></pre></td></tr></table></figure><p>改为</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>BABEL_DEFAULT_LOCALE <span class=\"token operator\">=</span> <span class=\"token string\">\"zh\"</span></pre></td></tr></table></figure><p>&lt;h1 id=&quot;解决 csv 导出乱码&quot;&gt; 解决 csv 导出乱码 &lt; a class=&quot;anchor&quot; href=&quot;解决 csv 导出乱码&quot; data-pjax-state=&quot;&quot;&gt;#&lt;/a&gt;&lt;/h1&gt;</p>\n<p>修改 config.py 文件<br />\n找到</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>CSV_EXPORT <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span><span class=\"token string\">\"encoding\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"utf-8\"</span><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>改为</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>CSV_EXPORT <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span><span class=\"token string\">\"encoding\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"utf-8-sig\"</span><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h1 id=\"地图图表汉化\"><a class=\"anchor\" href=\"#地图图表汉化\">#</a> 地图图表汉化</h1>\n<p>汉化前：<br />\n<img data-src=\"15.png\" alt=\"\" /><br />\n汉化后：<br />\n<img data-src=\"16.png\" alt=\"\" /><br />\n修改方法：<br />\n修改两个文件内容</p>\n<ul>\n<li>./superset/assets/node_modules/@superset-ui/legacy-plugin-chart-country-map/esm/countries/china.geojson</li>\n<li>./superset/assets/node_modules/@superset-ui/legacy-plugin-chart-country-map/lib/countries/china.geojson</li>\n</ul>\n<p>将所有 NAME_1 的拼音改成中文</p>\n<figure class=\"highlight json\"><figcaption data-lang=\"JSON\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">&#123;</span><span class=\"token property\">\"ID_0\"</span><span class=\"token operator\">:</span><span class=\"token number\">49</span><span class=\"token punctuation\">,</span><span class=\"token property\">\"ISO\"</span><span class=\"token operator\">:</span><span class=\"token string\">\"CN-71\"</span><span class=\"token punctuation\">,</span><span class=\"token property\">\"NAME_0\"</span><span class=\"token operator\">:</span><span class=\"token string\">\"China\"</span><span class=\"token punctuation\">,</span><span class=\"token property\">\"ID_1\"</span><span class=\"token operator\">:</span><span class=\"token number\">32</span><span class=\"token punctuation\">,</span><span class=\"token property\">\"NAME_1\"</span><span class=\"token operator\">:</span><span class=\"token string\">\"Taiwan\"</span><span class=\"token punctuation\">,</span><span class=\"token property\">\"TYPE_1\"</span><span class=\"token operator\">:</span><span class=\"token string\">\"Shěng\"</span><span class=\"token punctuation\">,</span><span class=\"token property\">\"ENGTYPE_1\"</span><span class=\"token operator\">:</span><span class=\"token string\">\"Province\"</span><span class=\"token punctuation\">,</span><span class=\"token property\">\"NL_NAME_1\"</span><span class=\"token operator\">:</span><span class=\"token string\">\"台湾\"</span><span class=\"token punctuation\">,</span><span class=\"token property\">\"VARNAME_1\"</span><span class=\"token operator\">:</span><span class=\"token string\">\"Táiwān\"</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr></table></figure><p>改为</p>\n<figure class=\"highlight json\"><figcaption data-lang=\"JSON\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">&#123;</span><span class=\"token property\">\"ID_0\"</span><span class=\"token operator\">:</span><span class=\"token number\">49</span><span class=\"token punctuation\">,</span><span class=\"token property\">\"ISO\"</span><span class=\"token operator\">:</span><span class=\"token string\">\"CN-71\"</span><span class=\"token punctuation\">,</span><span class=\"token property\">\"NAME_0\"</span><span class=\"token operator\">:</span><span class=\"token string\">\"China\"</span><span class=\"token punctuation\">,</span><span class=\"token property\">\"ID_1\"</span><span class=\"token operator\">:</span><span class=\"token number\">32</span><span class=\"token punctuation\">,</span><span class=\"token property\">\"NAME_1\"</span><span class=\"token operator\">:</span><span class=\"token string\">\"台湾\"</span><span class=\"token punctuation\">,</span><span class=\"token property\">\"TYPE_1\"</span><span class=\"token operator\">:</span><span class=\"token string\">\"Shěng\"</span><span class=\"token punctuation\">,</span><span class=\"token property\">\"ENGTYPE_1\"</span><span class=\"token operator\">:</span><span class=\"token string\">\"Province\"</span><span class=\"token punctuation\">,</span><span class=\"token property\">\"NL_NAME_1\"</span><span class=\"token operator\">:</span><span class=\"token string\">\"台湾\"</span><span class=\"token punctuation\">,</span><span class=\"token property\">\"VARNAME_1\"</span><span class=\"token operator\">:</span><span class=\"token string\">\"Táiwān\"</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>然后重写编译前端</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">npm</span> run build</pre></td></tr></table></figure><h1 id=\"国际化\"><a class=\"anchor\" href=\"#国际化\">#</a> 国际化</h1>\n<p>找到安装目录下有个 translations/zh/LC_MESSAGES 文件夹。<br />\n打开里面的 messages.json 文件，添加你需要汉化的字符串<br />\n完成后在 /superset 目录下运行</p>\n<pre><code class=\"language-Bash\">pybabel compile -d translations\n</code></pre>\n<p>编译完，重启服务即可</p>\n<h1 id=\"csv导出别名\"><a class=\"anchor\" href=\"#csv导出别名\">#</a> csv 导出别名</h1>\n<p>修改 superset/viz.py 中 get_csv 函数</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">def</span> <span class=\"token function\">get_csv</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>        df <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>get_df<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        <span class=\"token comment\"># 导出 csv 替换成 数据源中的 label</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        columns <span class=\"token operator\">=</span> <span class=\"token builtin\">list</span><span class=\"token punctuation\">(</span>df<span class=\"token punctuation\">.</span>columns<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        verbose_map <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>datasource<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span><span class=\"token string\">'verbose_map'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        df<span class=\"token punctuation\">.</span>columns <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>verbose_map<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span>c<span class=\"token punctuation\">,</span> c<span class=\"token punctuation\">)</span> <span class=\"token keyword\">for</span> c <span class=\"token keyword\">in</span> columns<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        include_index <span class=\"token operator\">=</span> <span class=\"token keyword\">not</span> <span class=\"token builtin\">isinstance</span><span class=\"token punctuation\">(</span>df<span class=\"token punctuation\">.</span>index<span class=\"token punctuation\">,</span> pd<span class=\"token punctuation\">.</span>RangeIndex<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token keyword\">return</span> df<span class=\"token punctuation\">.</span>to_csv<span class=\"token punctuation\">(</span>index<span class=\"token operator\">=</span>include_index<span class=\"token punctuation\">,</span> <span class=\"token operator\">**</span>config<span class=\"token punctuation\">[</span><span class=\"token string\">\"CSV_EXPORT\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure>",
            "tags": [
                "计算机科学",
                "大数据",
                "数据可视化",
                "superset",
                "python",
                "数据可视化"
            ]
        },
        {
            "id": "http://yrmlnf.coding-pages.com/Pentaho-RestAPI%E7%94%A8%E6%88%B7%E8%A7%92%E8%89%B2%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86/",
            "url": "http://yrmlnf.coding-pages.com/Pentaho-RestAPI%E7%94%A8%E6%88%B7%E8%A7%92%E8%89%B2%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86/",
            "title": "Pentaho-RestAPI用户角色权限管理",
            "date_published": "2021-03-31T03:29:32.000Z",
            "content_html": "<h1 id=\"前言\"><a class=\"anchor\" href=\"#前言\">#</a> 前言</h1>\n<p>以下介绍的 Rest API 用以 PBA 的安全用户 &amp; 角色的管理：</p>\n<ul>\n<li>创建、删除用户角色</li>\n<li>给用户分配角色</li>\n<li>获得某角色下的用户列表</li>\n<li>给角色赋予权限</li>\n<li>修改用户密码</li>\n</ul>\n<p>Pentaho Rest API 的通用格式为：</p>\n<pre><code>[server path]/[rest path]/[query parameter]\n</code></pre>\n<p>调用 API 需进行 pentaho 认证，参考<span class=\"exturl\" data-url=\"aHR0cHM6Ly9oZWxwLnBlbnRhaG8uY29tL0RvY3VtZW50YXRpb24vOC4yL0RldmVsb3Blcl9DZW50ZXIvUkVTVF9BUEk=\">教程</span>。本篇示例均以 Basic Auth 的认证方式实现。</p>\n<h1 id=\"users\"><a class=\"anchor\" href=\"#users\">#</a> Users</h1>\n<p>本章节列的 Rest API 与 Pentaho 用户有关。</p>\n<h2 id=\"创建用户\"><a class=\"anchor\" href=\"#创建用户\">#</a> 创建用户</h2>\n<p>创建一个用户包括创建用户名和密码。此请求封装在具有用户名和密码值的 user 对象中，请注意创建用户不包括为其分配角色，若要分配角色需要建立另外的请求。<br />\n⚠️ 终端用户必须有管理权限才可以执行。</p>\n<h3 id=\"支持方法\"><a class=\"anchor\" href=\"#支持方法\">#</a> 支持方法</h3>\n<table>\n<thead>\n<tr>\n<th>Http Verb</th>\n<th>Example Request</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>PUT</td>\n<td>PUT /pentaho/api/userroledao/createUser</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"参数\"><a class=\"anchor\" href=\"#参数\">#</a> 参数</h3>\n<table>\n<thead>\n<tr>\n<th>Name</th>\n<th>Description</th>\n<th>Type</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>user</td>\n<td>用于传递 userName 和 password 的对象</td>\n<td>query</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"request-body\"><a class=\"anchor\" href=\"#request-body\">#</a> Request Body</h3>\n<p>user 对象传递 userName&amp;password 的示例如下：</p>\n<figure class=\"highlight json\"><figcaption data-lang=\"JSON\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token property\">\"userName\"</span><span class=\"token operator\">:</span><span class=\"token string\">\"viviran\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token property\">\"password\"</span><span class=\"token operator\">:</span><span class=\"token string\">\"password\"</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><table>\n<thead>\n<tr>\n<th>Element</th>\n<th>Media Types</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>user</td>\n<td>*/*&lt;br&gt;application/xml&lt;br&gt;application/octet-stream</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"response-body\"><a class=\"anchor\" href=\"#response-body\">#</a> Response Body</h3>\n<p>Response Body 包含操作状态码</p>\n<table>\n<thead>\n<tr>\n<th>Element</th>\n<th>Media Types</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>(custom)</td>\n<td>*/*&lt;br&gt;application/xml&lt;br&gt;application/octet-stream</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"请求指令\"><a class=\"anchor\" href=\"#请求指令\">#</a> 请求指令</h3>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">curl</span>   -d <span class=\"token string\">'&#123;\"userName\":\"viviran\",\"password\":\"password\"&#125;'</span> -H<span class=\"token string\">'Authorization:Basic YWRtaW46cGFzc3dvcmQ='</span> -H <span class=\"token string\">'Content-Type:application/json'</span> -X PUT http://localhost:8080/pentaho/api/userroledao/createUser</pre></td></tr></table></figure><p>创建 viviran 的用户</p>\n<h3 id=\"状态码\"><a class=\"anchor\" href=\"#状态码\">#</a> 状态码</h3>\n<table>\n<thead>\n<tr>\n<th>Code</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>200*</td>\n<td>Successfully created new user (实际上是 204, 无返回内容)</td>\n</tr>\n<tr>\n<td>400</td>\n<td>Provided data has invalid format.</td>\n</tr>\n<tr>\n<td>401</td>\n<td>未认证</td>\n</tr>\n<tr>\n<td>403</td>\n<td>Only users with administrative privileges can access this method.</td>\n</tr>\n<tr>\n<td>412</td>\n<td>Unable to create user.</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"删除用户\"><a class=\"anchor\" href=\"#删除用户\">#</a> 删除用户</h2>\n<p>使用一个 query parameter 实现用户列表的删除，若要批量删除用户，userName 以 tab (\\t) 分隔.<br />\n⚠️ 终端用户必须有管理权限才可以执行。</p>\n<h3 id=\"支持方法-2\"><a class=\"anchor\" href=\"#支持方法-2\">#</a> 支持方法</h3>\n<table>\n<thead>\n<tr>\n<th>HTTP Verb</th>\n<th>Example Request</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>PUT</td>\n<td>PUT pentaho/api/userroledao/deleteUsers?userNames=user1%09user2%09</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"参数-2\"><a class=\"anchor\" href=\"#参数-2\">#</a> 参数</h3>\n<table>\n<thead>\n<tr>\n<th>Name</th>\n<th>Description</th>\n<th>Type</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>userName</td>\n<td>用户名列表以 tab (\\t) 分隔</td>\n<td>query</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"request-body-2\"><a class=\"anchor\" href=\"#request-body-2\">#</a> Request Body</h3>\n<p>无</p>\n<h3 id=\"response-body-2\"><a class=\"anchor\" href=\"#response-body-2\">#</a> Response Body</h3>\n<p>Response Body 包含操作状态码</p>\n<table>\n<thead>\n<tr>\n<th>Element</th>\n<th>Media Types</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>(custom)</td>\n<td>*/*&lt;br&gt;application/xml&lt;br&gt;application/octet-stream</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"请求指令-2\"><a class=\"anchor\" href=\"#请求指令-2\">#</a> 请求指令</h3>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">curl</span> -H<span class=\"token string\">'Authorization:Basic YWRtaW46cGFzc3dvcmQ='</span> -X PUT http://localhost:8080/pentaho/api/userroledao/deleteUsers?userNames<span class=\"token operator\">=</span>viviran</pre></td></tr></table></figure><p>删除 viviran</p>\n<h3 id=\"状态码-2\"><a class=\"anchor\" href=\"#状态码-2\">#</a> 状态码</h3>\n<table>\n<thead>\n<tr>\n<th>Code</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>200*</td>\n<td>Successfully created new user (实际上是 204, 无返回内容)</td>\n</tr>\n<tr>\n<td>401</td>\n<td>未认证</td>\n</tr>\n<tr>\n<td>403</td>\n<td>Only users with administrative privileges can access this method.</td>\n</tr>\n<tr>\n<td>500</td>\n<td>Internal server error prevented the system from properly retrieving either the user or roles.</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"修改用户密码\"><a class=\"anchor\" href=\"#修改用户密码\">#</a> 修改用户密码</h2>\n<p>修改信息封装在 ChangeUserPassword 对象：userName, newPassword, oldPassword.</p>\n<h3 id=\"支持方法-3\"><a class=\"anchor\" href=\"#支持方法-3\">#</a> 支持方法</h3>\n<table>\n<thead>\n<tr>\n<th>HTTP Verb</th>\n<th>Example Request</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>PUT</td>\n<td>PUT pentaho/api/userroledao/user</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"参数-3\"><a class=\"anchor\" href=\"#参数-3\">#</a> 参数</h3>\n<table>\n<thead>\n<tr>\n<th>Name</th>\n<th>Description</th>\n<th>Type</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>ChangePasswordUser</td>\n<td>封装了需要修改的用户的用户名、旧密码、新密码字段</td>\n<td>query</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"request-body-3\"><a class=\"anchor\" href=\"#request-body-3\">#</a> Request Body</h3>\n<p>ChangePasswordUser 对象传递的示例如下：</p>\n<figure class=\"highlight json\"><figcaption data-lang=\"JSON\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token property\">\"userName\"</span><span class=\"token operator\">:</span><span class=\"token string\">\"suzy\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token property\">\"newPassword\"</span><span class=\"token operator\">:</span><span class=\"token string\">\"newpassword\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token property\">\"oldPassword\"</span><span class=\"token operator\">:</span><span class=\"token string\">\"password\"</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h3 id=\"response-body-3\"><a class=\"anchor\" href=\"#response-body-3\">#</a> Response Body</h3>\n<p>Response Body 包含操作状态码</p>\n<table>\n<thead>\n<tr>\n<th>Element</th>\n<th>Media Types</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>(custom)</td>\n<td>*/*&lt;br&gt;application/xml&lt;br&gt;application/octet-stream</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"请求指令-3\"><a class=\"anchor\" href=\"#请求指令-3\">#</a> 请求指令</h3>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">curl</span> -d <span class=\"token string\">'&#123;\"userName\":\"suzy\",\"newPassword\":\"newpassword\",\"oldPassword\":\"password\"&#125;'</span> -H<span class=\"token string\">'Authorization:Basic YWRtaW46cGFzc3dvcmQ='</span> -H <span class=\"token string\">'Content-Type:application/json'</span> -X PUT http://localhost:8080/pentaho/api/userroledao/user</pre></td></tr></table></figure><p>修改 suzy 的密码 password-&gt;newpassword</p>\n<h3 id=\"状态码-3\"><a class=\"anchor\" href=\"#状态码-3\">#</a> 状态码</h3>\n<table>\n<thead>\n<tr>\n<th>Code</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>200*</td>\n<td>Successfully created new user (实际上是 204, 无返回内容)</td>\n</tr>\n<tr>\n<td>400</td>\n<td>Provided data has invalid format.</td>\n</tr>\n<tr>\n<td>401</td>\n<td>未认证</td>\n</tr>\n<tr>\n<td>403</td>\n<td>Only users with administrative privileges can access this method.</td>\n</tr>\n<tr>\n<td>412</td>\n<td>Unable to create</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"获得用户列表\"><a class=\"anchor\" href=\"#获得用户列表\">#</a> 获得用户列表</h2>\n<p>返回 Pentaho 资源库中的用户列表。</p>\n<h3 id=\"支持方法-4\"><a class=\"anchor\" href=\"#支持方法-4\">#</a> 支持方法</h3>\n<table>\n<thead>\n<tr>\n<th>HTTP Verb</th>\n<th>Example Request</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>GET</td>\n<td>GET pentaho/api/userroledao/users</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"参数-4\"><a class=\"anchor\" href=\"#参数-4\">#</a> 参数</h3>\n<p>无</p>\n<h3 id=\"request-body-4\"><a class=\"anchor\" href=\"#request-body-4\">#</a> Request Body</h3>\n<p>无</p>\n<h3 id=\"response-body-4\"><a class=\"anchor\" href=\"#response-body-4\">#</a> Response Body</h3>\n<p>返回平台的用户列表。</p>\n<table>\n<thead>\n<tr>\n<th>Element</th>\n<th>Media Types</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>userList</td>\n<td>application/xml&lt;br&gt;application/json</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"请求指令-4\"><a class=\"anchor\" href=\"#请求指令-4\">#</a> 请求指令</h3>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">curl</span> -H<span class=\"token string\">'Authorization:Basic YWRtaW46cGFzc3dvcmQ='</span> http://localhost:8080/pentaho/api/userroledao/users</pre></td></tr></table></figure><p>返回结果：</p>\n<figure class=\"highlight xml\"><figcaption data-lang=\"XML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token prolog\">&lt;?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"yes\"?></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>userList</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>users</span><span class=\"token punctuation\">></span></span>suzy<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>users</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>users</span><span class=\"token punctuation\">></span></span>pat<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>users</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>users</span><span class=\"token punctuation\">></span></span>tiffany<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>users</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>users</span><span class=\"token punctuation\">></span></span>admin<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>users</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>users</span><span class=\"token punctuation\">></span></span>vivi<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>users</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>users</span><span class=\"token punctuation\">></span></span>swran001<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>users</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>users</span><span class=\"token punctuation\">></span></span>Shipped<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>users</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>userList</span><span class=\"token punctuation\">></span></span></pre></td></tr></table></figure><h3 id=\"状态码-4\"><a class=\"anchor\" href=\"#状态码-4\">#</a> 状态码</h3>\n<table>\n<thead>\n<tr>\n<th>Code</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>200</td>\n<td>Successfully returned the list of users.</td>\n</tr>\n<tr>\n<td>500</td>\n<td>An error occurred in the platform while trying to access the list of users.</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"获取用户的角色\"><a class=\"anchor\" href=\"#获取用户的角色\">#</a> 获取用户的角色</h2>\n<p>获得某一个用户的所有角色。</p>\n<h3 id=\"支持方法-5\"><a class=\"anchor\" href=\"#支持方法-5\">#</a> 支持方法</h3>\n<table>\n<thead>\n<tr>\n<th>HTTP Verb</th>\n<th>Example Request</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>GET</td>\n<td>GET pentaho/api/userroledao/userRoles?userName=suzy</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"参数-5\"><a class=\"anchor\" href=\"#参数-5\">#</a> 参数</h3>\n<table>\n<thead>\n<tr>\n<th>Name</th>\n<th>Description</th>\n<th>Type</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>userName</td>\n<td>需要获得角色的用户</td>\n<td>query</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"request-body-5\"><a class=\"anchor\" href=\"#request-body-5\">#</a> Request Body</h3>\n<p>无</p>\n<h3 id=\"response-body-5\"><a class=\"anchor\" href=\"#response-body-5\">#</a> Response Body</h3>\n<p>返回平台的用户的角色。</p>\n<table>\n<thead>\n<tr>\n<th>Element</th>\n<th>Media Types</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>roleList</td>\n<td>application/xml&lt;br&gt;application/json</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"请求指令-5\"><a class=\"anchor\" href=\"#请求指令-5\">#</a> 请求指令</h3>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">curl</span> -H<span class=\"token string\">'Authorization:Basic YWRtaW46cGFzc3dvcmQ='</span> http://localhost:8080/pentaho/api/userroledao/userRoles?userName<span class=\"token operator\">=</span>suzy</pre></td></tr></table></figure><p>获得用户 suzy 的角色</p>\n<p>返回结果：</p>\n<figure class=\"highlight xml\"><figcaption data-lang=\"XML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token prolog\">&lt;?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"yes\"?></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>roleList</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>roles</span><span class=\"token punctuation\">></span></span>Power User<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>roles</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>roleList</span><span class=\"token punctuation\">></span></span></pre></td></tr></table></figure><h3 id=\"状态码-5\"><a class=\"anchor\" href=\"#状态码-5\">#</a> 状态码</h3>\n<table>\n<thead>\n<tr>\n<th>Code</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>200</td>\n<td>Successfully retrieved the list of roles.</td>\n</tr>\n<tr>\n<td>500</td>\n<td>Invalid user parameter.</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"给用户分配角色\"><a class=\"anchor\" href=\"#给用户分配角色\">#</a> 给用户分配角色</h2>\n<p>使用 query parameters 将系统存在的角色分配给系统已存在的用户。<br />\n如果用户名存在，但是角色系统不存在，也会返回 204。这意味着调用是成功的，用户名也可以在系统找到，但是没有为用户分配该角色。这可以避免为用户分配多个角色时，其中一个角色不存在就报错的问题。<br />\n⚠️ 终端用户必须有管理权限才可以执行。</p>\n<h3 id=\"支持方法-6\"><a class=\"anchor\" href=\"#支持方法-6\">#</a> 支持方法</h3>\n<table>\n<thead>\n<tr>\n<th>HTTP Verb</th>\n<th>Example Request</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>PUT</td>\n<td>PUT pentaho/api/userroledao/assignRoleToUser?userName=admin&amp;roleNames=power%20user%09cto%09</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"参数-6\"><a class=\"anchor\" href=\"#参数-6\">#</a> 参数</h3>\n<table>\n<thead>\n<tr>\n<th>Name</th>\n<th>Description</th>\n<th>Type</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>userName</td>\n<td>需要分配角色的用户名</td>\n<td>query</td>\n</tr>\n<tr>\n<td>roleNames</td>\n<td>系统存在的角色名，分配多个角色时以 tab (/t) 分隔</td>\n<td>query</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"request-body-6\"><a class=\"anchor\" href=\"#request-body-6\">#</a> Request Body</h3>\n<p>无</p>\n<h3 id=\"response-body-6\"><a class=\"anchor\" href=\"#response-body-6\">#</a> Response Body</h3>\n<p>Response Body 包含状态码</p>\n<table>\n<thead>\n<tr>\n<th>Element</th>\n<th>Media Types</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>(custom)</td>\n<td>*/*&lt;br&gt;application/xml&lt;br&gt;application/json</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"请求指令-6\"><a class=\"anchor\" href=\"#请求指令-6\">#</a> 请求指令</h3>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">curl</span> -H<span class=\"token string\">'Authorization:Basic YWRtaW46cGFzc3dvcmQ='</span> -H<span class=\"token string\">'Content-Type:*/*'</span> -X PUT http://localhost:8080/pentaho/api/userroledao/assignRoleToUser?userName<span class=\"token operator\">=</span>admin<span class=\"token punctuation\">\\</span><span class=\"token operator\">&amp;</span><span class=\"token assign-left variable\">roleNames</span><span class=\"token operator\">=</span>power%20user%09cto%09</pre></td></tr></table></figure><p>给 admin 分配 power user 和 cto 的角色，注意特殊符号转译：&amp;,space,tab</p>\n<h3 id=\"状态码-6\"><a class=\"anchor\" href=\"#状态码-6\">#</a> 状态码</h3>\n<table>\n<thead>\n<tr>\n<th>Code</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>200*</td>\n<td>Successfully append the roles to the user.(实际上是 204)</td>\n</tr>\n<tr>\n<td>403</td>\n<td>Only users with administrative privileges can access this method.</td>\n</tr>\n<tr>\n<td>500</td>\n<td>Internal server error prevented the system from properly retrieving either the user or roles.</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"删除用户的角色\"><a class=\"anchor\" href=\"#删除用户的角色\">#</a> 删除用户的角色</h2>\n<p>通过 query parameters 删除系统已存在的用户的指定角色<br />\n⚠️ 终端用户必须有管理权限才可以执行。</p>\n<h3 id=\"支持方法-7\"><a class=\"anchor\" href=\"#支持方法-7\">#</a> 支持方法</h3>\n<table>\n<thead>\n<tr>\n<th>HTTP Verb</th>\n<th>Example Request</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>PUT</td>\n<td>PUT pentaho/api/userroledao/removeRoleFromUser?userName=admin&amp;roleNames=Business%20User%09Power%20User%09</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"参数-7\"><a class=\"anchor\" href=\"#参数-7\">#</a> 参数</h3>\n<table>\n<thead>\n<tr>\n<th>Name</th>\n<th>Description</th>\n<th>Type</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>userName</td>\n<td>需要删除角色的用户名</td>\n<td>query</td>\n</tr>\n<tr>\n<td>roleNames</td>\n<td>平台存在的角色列表，删除多个时，用 tab (\\t) 分隔</td>\n<td>query</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"request-body-7\"><a class=\"anchor\" href=\"#request-body-7\">#</a> Request Body</h3>\n<p>无</p>\n<h3 id=\"response-body-7\"><a class=\"anchor\" href=\"#response-body-7\">#</a> Response Body</h3>\n<p>Response Body 包含操作状态码</p>\n<table>\n<thead>\n<tr>\n<th>Element</th>\n<th>Media Types</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>(custom)</td>\n<td>*/*&lt;br&gt;application/xml&lt;br&gt;application/json</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"请求指令-7\"><a class=\"anchor\" href=\"#请求指令-7\">#</a> 请求指令</h3>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">curl</span> -H<span class=\"token string\">'Authorization:Basic YWRtaW46cGFzc3dvcmQ='</span> -X PUT http://localhost:8080/pentaho/api/userroledao/removeRoleFromUser?userName<span class=\"token operator\">=</span>admin<span class=\"token punctuation\">\\</span><span class=\"token operator\">&amp;</span><span class=\"token assign-left variable\">roleNames</span><span class=\"token operator\">=</span>cto%09Power%20User%09</pre></td></tr></table></figure><p>删除 admin 的 cto 和 power user 的角色，注意特殊符号转译：&amp;,space,tab</p>\n<h3 id=\"状态码-7\"><a class=\"anchor\" href=\"#状态码-7\">#</a> 状态码</h3>\n<table>\n<thead>\n<tr>\n<th>Code</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>200*</td>\n<td>Successfully removed the roles from the user.(实际是 204)</td>\n</tr>\n<tr>\n<td>403</td>\n<td>Only users with administrative privileges can access this method.</td>\n</tr>\n<tr>\n<td>500</td>\n<td>Internal server error prevented the system from properly retrieving either the user or roles.</td>\n</tr>\n</tbody>\n</table>\n<h1 id=\"roles\"><a class=\"anchor\" href=\"#roles\">#</a> Roles</h1>\n<p>本章节列的 Rest API 与 Pentaho 角色有关。</p>\n<h2 id=\"创建角色\"><a class=\"anchor\" href=\"#创建角色\">#</a> 创建角色</h2>\n<p>创建一个角色，该角色没有任何权限。若要分配权限，需要新建另外的请求。详见 <code>2.5 给角色分配权限</code> <br />\n⚠️ 终端用户必须有管理权限才可以执行。</p>\n<h3 id=\"支持方法-8\"><a class=\"anchor\" href=\"#支持方法-8\">#</a> 支持方法</h3>\n<table>\n<thead>\n<tr>\n<th>HTTP Verb</th>\n<th>Example Request</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>PUT</td>\n<td>PUT pentaho/api/userroledao/createRole?roleName=rName</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"参数-8\"><a class=\"anchor\" href=\"#参数-8\">#</a> 参数</h3>\n<table>\n<thead>\n<tr>\n<th>Name</th>\n<th>Description</th>\n<th>Type</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>roleName</td>\n<td>新建的角色名</td>\n<td>query</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"request-body-8\"><a class=\"anchor\" href=\"#request-body-8\">#</a> Request Body</h3>\n<p>无</p>\n<h3 id=\"response-body-8\"><a class=\"anchor\" href=\"#response-body-8\">#</a> Response Body</h3>\n<p>Response Body 包含操作状态码</p>\n<table>\n<thead>\n<tr>\n<th>Element</th>\n<th>Media Types</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>(custom)</td>\n<td>*/*&lt;br&gt;application/xml&lt;br&gt;application/json</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"请求指令-8\"><a class=\"anchor\" href=\"#请求指令-8\">#</a> 请求指令</h3>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">curl</span> -H<span class=\"token string\">'Authorization:Basic YWRtaW46cGFzc3dvcmQ='</span> -X PUT http://localhost:8080/pentaho/api/userroledao/createRole?roleName<span class=\"token operator\">=</span>cto</pre></td></tr></table></figure><p>新增 cto 的角色</p>\n<h3 id=\"状态码-8\"><a class=\"anchor\" href=\"#状态码-8\">#</a> 状态码</h3>\n<table>\n<thead>\n<tr>\n<th>Code</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>200*</td>\n<td>Successfully created new role.（实际上是 204）</td>\n</tr>\n<tr>\n<td>400</td>\n<td>Provided data has invalid format.</td>\n</tr>\n<tr>\n<td>403</td>\n<td>Only users with administrative privileges can access this method.</td>\n</tr>\n<tr>\n<td>500</td>\n<td>Unable to create role objects.</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"删除角色\"><a class=\"anchor\" href=\"#删除角色\">#</a> 删除角色</h2>\n<p>删除平台角色，可批量删除<br />\n⚠️ 终端用户必须有管理权限才可以执行。</p>\n<h3 id=\"支持方法-9\"><a class=\"anchor\" href=\"#支持方法-9\">#</a> 支持方法</h3>\n<table>\n<thead>\n<tr>\n<th>HTTP Verb</th>\n<th>Example Request</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>PUT</td>\n<td>PUT pentaho/api/userroledao/deleteRoles?roleNames=role1%09</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"参数-9\"><a class=\"anchor\" href=\"#参数-9\">#</a> 参数</h3>\n<table>\n<thead>\n<tr>\n<th>Name</th>\n<th>Description</th>\n<th>Type</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>roleNames</td>\n<td>平台存在的角色，批量删除以 tab (\\t) 分隔</td>\n<td>query</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"request-body-9\"><a class=\"anchor\" href=\"#request-body-9\">#</a> Request Body</h3>\n<p>无</p>\n<h3 id=\"response-body-9\"><a class=\"anchor\" href=\"#response-body-9\">#</a> Response Body</h3>\n<p>Response Body 包含操作状态码</p>\n<table>\n<thead>\n<tr>\n<th>Element</th>\n<th>Media Types</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>(custom)</td>\n<td>*/*&lt;br&gt;application/xml&lt;br&gt;application/json</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"请求指令-9\"><a class=\"anchor\" href=\"#请求指令-9\">#</a> 请求指令</h3>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">curl</span> -H<span class=\"token string\">'Authorization:Basic YWRtaW46cGFzc3dvcmQ='</span> -X PUT http://localhost:8080/pentaho/api/userroledao/deleteRoles?roleNames<span class=\"token operator\">=</span>role5%09role6</pre></td></tr></table></figure><p>删除角色 role5，role6</p>\n<h3 id=\"状态码-9\"><a class=\"anchor\" href=\"#状态码-9\">#</a> 状态码</h3>\n<table>\n<thead>\n<tr>\n<th>Code</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>200*</td>\n<td>Successfully deleted the list of roles.（实际上是 204）</td>\n</tr>\n<tr>\n<td>403</td>\n<td>Only users with administrative privileges can access this method.</td>\n</tr>\n<tr>\n<td>500</td>\n<td>The system was unable to delete the roles passed in.</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"获取角色列表\"><a class=\"anchor\" href=\"#获取角色列表\">#</a> 获取角色列表</h2>\n<p>获得平台的角色列表。</p>\n<h3 id=\"支持方法-10\"><a class=\"anchor\" href=\"#支持方法-10\">#</a> 支持方法</h3>\n<table>\n<thead>\n<tr>\n<th>HTTP Verb</th>\n<th>Example Request</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>GET</td>\n<td>GET pentaho/api/userroledao/roles</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"参数-10\"><a class=\"anchor\" href=\"#参数-10\">#</a> 参数</h3>\n<table>\n<thead>\n<tr>\n<th>Name</th>\n<th>Description</th>\n<th>Type</th>\n</tr>\n</thead>\n</table>\n<h3 id=\"request-body-10\"><a class=\"anchor\" href=\"#request-body-10\">#</a> Request Body</h3>\n<p>无</p>\n<h3 id=\"response-body-10\"><a class=\"anchor\" href=\"#response-body-10\">#</a> Response Body</h3>\n<p>返回平台的角色列表</p>\n<table>\n<thead>\n<tr>\n<th>Element</th>\n<th>Media Types</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>roleList</td>\n<td>application/xml&lt;br&gt;application/json</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"请求指令-10\"><a class=\"anchor\" href=\"#请求指令-10\">#</a> 请求指令</h3>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">curl</span> -H<span class=\"token string\">'Authorization:Basic YWRtaW46cGFzc3dvcmQ='</span> http://localhost:8080/pentaho/api/userroledao/roles</pre></td></tr></table></figure><p>返回结果：</p>\n<figure class=\"highlight xml\"><figcaption data-lang=\"XML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token prolog\">&lt;?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"yes\"?></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>roleList</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>roles</span><span class=\"token punctuation\">></span></span>Administrator<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>roles</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>roles</span><span class=\"token punctuation\">></span></span>Power User<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>roles</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>roles</span><span class=\"token punctuation\">></span></span>Report Author<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>roles</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>roles</span><span class=\"token punctuation\">></span></span>Business Analyst<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>roles</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>roleList</span><span class=\"token punctuation\">></span></span></pre></td></tr></table></figure><h3 id=\"状态码-10\"><a class=\"anchor\" href=\"#状态码-10\">#</a> 状态码</h3>\n<table>\n<thead>\n<tr>\n<th>Code</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>200</td>\n<td>Successfully retrieved the list of roles.</td>\n</tr>\n<tr>\n<td>500</td>\n<td>The system was not able to return the list of roles.</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"获取角色下的用户列表\"><a class=\"anchor\" href=\"#获取角色下的用户列表\">#</a> 获取角色下的用户列表</h2>\n<p>获取某一角色下的用户列表，角色要在平台中存在。<br />\n⚠️ 终端用户必须有管理权限才可以执行。</p>\n<h3 id=\"支持方法-11\"><a class=\"anchor\" href=\"#支持方法-11\">#</a> 支持方法</h3>\n<table>\n<thead>\n<tr>\n<th>HTTP Verb</th>\n<th>Example Request</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>GET</td>\n<td>GET pentaho/api/userroledao/roleMembers?roleName=Power%20User</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"参数-11\"><a class=\"anchor\" href=\"#参数-11\">#</a> 参数</h3>\n<table>\n<thead>\n<tr>\n<th>Name</th>\n<th>Description</th>\n<th>Type</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>roleName</td>\n<td>获取用户列表的角色名</td>\n<td>query</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"request-body-11\"><a class=\"anchor\" href=\"#request-body-11\">#</a> Request Body</h3>\n<p>无</p>\n<h3 id=\"response-body-11\"><a class=\"anchor\" href=\"#response-body-11\">#</a> Response Body</h3>\n<p>返回角色的用户列表</p>\n<table>\n<thead>\n<tr>\n<th>Element</th>\n<th>Media Types</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>userList</td>\n<td>application/xml&lt;br&gt;application/json</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"请求指令-11\"><a class=\"anchor\" href=\"#请求指令-11\">#</a> 请求指令</h3>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">curl</span> -H<span class=\"token string\">'Authorization:Basic YWRtaW46cGFzc3dvcmQ='</span> http://localhost:8080/pentaho/api/userroledao/roleMembers?roleName<span class=\"token operator\">=</span>Power%20User</pre></td></tr></table></figure><p>返回结果：</p>\n<figure class=\"highlight xml\"><figcaption data-lang=\"XML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token prolog\">&lt;?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"yes\"?></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>userList</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>users</span><span class=\"token punctuation\">></span></span>suzy<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>users</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>users</span><span class=\"token punctuation\">></span></span>vivi<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>users</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>userList</span><span class=\"token punctuation\">></span></span></pre></td></tr></table></figure><h3 id=\"状态码-11\"><a class=\"anchor\" href=\"#状态码-11\">#</a> 状态码</h3>\n<table>\n<thead>\n<tr>\n<th>Code</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>200*</td>\n<td>Successfully retrieved the list of Users.（实际上是 204）</td>\n</tr>\n<tr>\n<td>403</td>\n<td>Only users with administrative privileges can access this method.</td>\n</tr>\n<tr>\n<td>500</td>\n<td>The system was not able to return the list of users.</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"给角色分配权限\"><a class=\"anchor\" href=\"#给角色分配权限\">#</a> 给角色分配权限</h2>\n<p>为角色分配系统的物理权限，该调用将为角色重新设置权限列表。如果新分配权限列表包含角色以前没有的权限，则增加权限。如果新分配权限列表去掉了角色以前的权限，则删除权限。<br />\n⚠️ 终端用户必须有管理权限才可以执行。</p>\n<h3 id=\"支持方法-12\"><a class=\"anchor\" href=\"#支持方法-12\">#</a> 支持方法</h3>\n<table>\n<thead>\n<tr>\n<th>HTTP Verb</th>\n<th>Example Request</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>PUT</td>\n<td>PUT /pentaho/api/userroledao/roleAssignments</td>\n</tr>\n</tbody>\n</table>\n<figure class=\"highlight xml\"><figcaption data-lang=\"XML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>systemRolesMap</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>assignments</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>roleName</span><span class=\"token punctuation\">></span></span>Report Author<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>roleName</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>logicalRoles</span><span class=\"token punctuation\">></span></span>org.pentaho.scheduler.manage<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>logicalRoles</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>logicalRoles</span><span class=\"token punctuation\">></span></span>org.pentaho.repository.read<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>logicalRoles</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>logicalRoles</span><span class=\"token punctuation\">></span></span>org.pentaho.security.publish<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>logicalRoles</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>logicalRoles</span><span class=\"token punctuation\">></span></span>org.pentaho.repository.create<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>logicalRoles</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>logicalRoles</span><span class=\"token punctuation\">></span></span>org.pentaho.repository.execute<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>logicalRoles</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>assignments</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>systemRolesMap</span><span class=\"token punctuation\">></span></span></pre></td></tr></table></figure><h3 id=\"参数-12\"><a class=\"anchor\" href=\"#参数-12\">#</a> 参数</h3>\n<table>\n<thead>\n<tr>\n<th>Name</th>\n<th>Description</th>\n<th>Type</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>roleAssignments</td>\n<td>Built from the Request payload, an example of the role assignments exists in the example request.</td>\n<td>query</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"request-body-12\"><a class=\"anchor\" href=\"#request-body-12\">#</a> Request Body</h3>\n<p>Built from the Request payload, an example of the role assignments exists in the example request.</p>\n<table>\n<thead>\n<tr>\n<th>Element</th>\n<th>Media Types</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>logicalRoleAssignments</td>\n<td>application/xml&lt;br&gt;application/json</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"response-body-12\"><a class=\"anchor\" href=\"#response-body-12\">#</a> Response Body</h3>\n<p>Response Body 包含操作状态码</p>\n<table>\n<thead>\n<tr>\n<th>Element</th>\n<th>Media Types</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>(custom)</td>\n<td>*/*&lt;br&gt;application/xml&lt;br&gt;application/json</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"状态码-12\"><a class=\"anchor\" href=\"#状态码-12\">#</a> 状态码</h3>\n<table>\n<thead>\n<tr>\n<th>Code</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>200*</td>\n<td>Successfully applied the logical role assignment.(实际上是 204)</td>\n</tr>\n<tr>\n<td>403</td>\n<td>Only users with administrative privileges can access this method.</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"列出角色的权限\"><a class=\"anchor\" href=\"#列出角色的权限\">#</a> 列出角色的权限</h2>\n<p>检索平台中的角色列表和操作权限映射，以及操作权限列表。逻辑角色名称映射由地区决定。如果区域设置为空，系统将使用默认的区域设置 “en”。<br />\n⚠️ 终端用户必须有管理权限才可以执行。</p>\n<h3 id=\"支持方法-13\"><a class=\"anchor\" href=\"#支持方法-13\">#</a> 支持方法</h3>\n<table>\n<thead>\n<tr>\n<th>HTTP Verb</th>\n<th>Example Request</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>GET</td>\n<td>GET pentaho/api/userroledao/logicalRoleMap?locale=en</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"参数-13\"><a class=\"anchor\" href=\"#参数-13\">#</a> 参数</h3>\n<table>\n<thead>\n<tr>\n<th>Name</th>\n<th>Description</th>\n<th>Type</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>locale</td>\n<td>locale 参数是可选的，它决定系统角色映射中物理权限的本地化角色名称。</td>\n<td>query</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"request-body-13\"><a class=\"anchor\" href=\"#request-body-13\">#</a> Request Body</h3>\n<p>无</p>\n<h3 id=\"response-body-13\"><a class=\"anchor\" href=\"#response-body-13\">#</a> Response Body</h3>\n<p>当前系统的角色映射。每个赋值都包含不可变标志，不可变赋值的角色不能被编辑。这对于管理员之类的角色非常有用，他们不应该失去管理特权。分配中的逻辑角色是当前映射到角色的物理权限。角色名是可以分配给用户的角色的名称。系统角色映射还包括系统中所有物理权限的列表及其本地化的角色名称。本地化角色名基于传递给调用的本地角色名，默认为 “en”。这些是可用于创建角色的物理权限。</p>\n<table>\n<thead>\n<tr>\n<th>Element</th>\n<th>Media Types</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>systemRolesMap</td>\n<td>application/xml&lt;br&gt;application/json</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"请求指令-12\"><a class=\"anchor\" href=\"#请求指令-12\">#</a> 请求指令</h3>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">curl</span> -H<span class=\"token string\">'Authorization:Basic YWRtaW46cGFzc3dvcmQ='</span> http://localhost:8080/pentaho/api/userroledao/logicalRoleMap?locale<span class=\"token operator\">=</span>en</pre></td></tr></table></figure><p>返回结果</p>\n<figure class=\"highlight xml\"><figcaption data-lang=\"XML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token prolog\">&lt;?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"yes\"?></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>systemRolesMap</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>assignments</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>immutable</span><span class=\"token punctuation\">></span></span>true<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>immutable</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>logicalRoles</span><span class=\"token punctuation\">></span></span>org.pentaho.platform.dataaccess.datasource.security.manage<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>logicalRoles</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>logicalRoles</span><span class=\"token punctuation\">></span></span>org.pentaho.repository.execute<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>logicalRoles</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>logicalRoles</span><span class=\"token punctuation\">></span></span>org.pentaho.repository.read<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>logicalRoles</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>logicalRoles</span><span class=\"token punctuation\">></span></span>org.pentaho.repository.create<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>logicalRoles</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>logicalRoles</span><span class=\"token punctuation\">></span></span>org.pentaho.scheduler.manage<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>logicalRoles</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>logicalRoles</span><span class=\"token punctuation\">></span></span>org.pentaho.security.administerSecurity<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>logicalRoles</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>logicalRoles</span><span class=\"token punctuation\">></span></span>org.pentaho.security.publish<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>logicalRoles</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>roleName</span><span class=\"token punctuation\">></span></span>SysAdmin<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>roleName</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>assignments</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>assignments</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>immutable</span><span class=\"token punctuation\">></span></span>false<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>immutable</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>logicalRoles</span><span class=\"token punctuation\">></span></span>org.pentaho.repository.read<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>logicalRoles</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>roleName</span><span class=\"token punctuation\">></span></span>Authenticated<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>roleName</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>assignments</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>assignments</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>immutable</span><span class=\"token punctuation\">></span></span>false<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>immutable</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>logicalRoles</span><span class=\"token punctuation\">></span></span>org.pentaho.scheduler.manage<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>logicalRoles</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>logicalRoles</span><span class=\"token punctuation\">></span></span>org.pentaho.repository.read<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>logicalRoles</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>logicalRoles</span><span class=\"token punctuation\">></span></span>org.pentaho.security.publish<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>logicalRoles</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>logicalRoles</span><span class=\"token punctuation\">></span></span>org.pentaho.repository.create<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>logicalRoles</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>logicalRoles</span><span class=\"token punctuation\">></span></span>org.pentaho.repository.execute<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>logicalRoles</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>roleName</span><span class=\"token punctuation\">></span></span>Power User<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>roleName</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>assignments</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>assignments</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>immutable</span><span class=\"token punctuation\">></span></span>true<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>immutable</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>logicalRoles</span><span class=\"token punctuation\">></span></span>org.pentaho.platform.dataaccess.datasource.security.manage<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>logicalRoles</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>logicalRoles</span><span class=\"token punctuation\">></span></span>org.pentaho.repository.execute<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>logicalRoles</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>logicalRoles</span><span class=\"token punctuation\">></span></span>org.pentaho.repository.read<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>logicalRoles</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>logicalRoles</span><span class=\"token punctuation\">></span></span>org.pentaho.repository.create<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>logicalRoles</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>logicalRoles</span><span class=\"token punctuation\">></span></span>org.pentaho.scheduler.manage<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>logicalRoles</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>logicalRoles</span><span class=\"token punctuation\">></span></span>org.pentaho.security.administerSecurity<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>logicalRoles</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>logicalRoles</span><span class=\"token punctuation\">></span></span>org.pentaho.security.publish<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>logicalRoles</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>roleName</span><span class=\"token punctuation\">></span></span>Administrator<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>roleName</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>assignments</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>assignments</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>immutable</span><span class=\"token punctuation\">></span></span>false<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>immutable</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>logicalRoles</span><span class=\"token punctuation\">></span></span>org.pentaho.security.publish<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>logicalRoles</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>roleName</span><span class=\"token punctuation\">></span></span>Business Analyst<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>roleName</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>assignments</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>assignments</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>immutable</span><span class=\"token punctuation\">></span></span>false<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>immutable</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>logicalRoles</span><span class=\"token punctuation\">></span></span>org.pentaho.security.publish<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>logicalRoles</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>logicalRoles</span><span class=\"token punctuation\">></span></span>org.pentaho.scheduler.manage<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>logicalRoles</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>roleName</span><span class=\"token punctuation\">></span></span>Report Author<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>roleName</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>assignments</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>localizedRoleNames</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>localizedName</span><span class=\"token punctuation\">></span></span>管理安全性<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>localizedName</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>roleName</span><span class=\"token punctuation\">></span></span>org.pentaho.security.administerSecurity<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>roleName</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>localizedRoleNames</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>localizedRoleNames</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>localizedName</span><span class=\"token punctuation\">></span></span>计划内容<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>localizedName</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>roleName</span><span class=\"token punctuation\">></span></span>org.pentaho.scheduler.manage<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>roleName</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>localizedRoleNames</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>localizedRoleNames</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>localizedName</span><span class=\"token punctuation\">></span></span>阅读内容<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>localizedName</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>roleName</span><span class=\"token punctuation\">></span></span>org.pentaho.repository.read<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>roleName</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>localizedRoleNames</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>localizedRoleNames</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>localizedName</span><span class=\"token punctuation\">></span></span>发布内容<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>localizedName</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>roleName</span><span class=\"token punctuation\">></span></span>org.pentaho.security.publish<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>roleName</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>localizedRoleNames</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>localizedRoleNames</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>localizedName</span><span class=\"token punctuation\">></span></span>创建内容<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>localizedName</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>roleName</span><span class=\"token punctuation\">></span></span>org.pentaho.repository.create<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>roleName</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>localizedRoleNames</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>localizedRoleNames</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>localizedName</span><span class=\"token punctuation\">></span></span>Execute<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>localizedName</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>roleName</span><span class=\"token punctuation\">></span></span>org.pentaho.repository.execute<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>roleName</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>localizedRoleNames</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>localizedRoleNames</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>localizedName</span><span class=\"token punctuation\">></span></span>管理数据源<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>localizedName</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>roleName</span><span class=\"token punctuation\">></span></span>org.pentaho.platform.dataaccess.datasource.security.manage<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>roleName</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>localizedRoleNames</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>systemRolesMap</span><span class=\"token punctuation\">></span></span></pre></td></tr></table></figure><h3 id=\"状态码-13\"><a class=\"anchor\" href=\"#状态码-13\">#</a> 状态码</h3>\n<table>\n<caption id=\"toc\">toc</caption>\n<thead>\n<tr>\n<th>Code</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>200</td>\n<td>Successfully retrieved the permissions of roles.</td>\n</tr>\n<tr>\n<td>403</td>\n<td>Only users with administrative privileges can access this method.</td>\n</tr>\n</tbody>\n</table>\n<h1 id=\"文件权限\"><a class=\"anchor\" href=\"#文件权限\">#</a> 文件权限</h1>\n<h2 id=\"创建文件夹\"><a class=\"anchor\" href=\"#创建文件夹\">#</a> 创建文件夹</h2>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#设置文件名 </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">fileName</span><span class=\"token operator\">=</span>%3Ahome%3Azjft%3Atest <span class=\"token comment\"># /home/zjft/test</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">curl</span> -XPUT http://127.0.0.1:8080/pentaho/api/repo/dirs/<span class=\"token variable\">$fileName</span> --cookie <span class=\"token string\">'JSESSIONID=0F653A1AAD18EE1FBCF3C8A4DE897F02'</span></pre></td></tr></table></figure><h2 id=\"获取文件元数据信息\"><a class=\"anchor\" href=\"#获取文件元数据信息\">#</a> 获取文件元数据信息</h2>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">curl</span>  http://127.0.0.1:8080/pentaho/api/repo/files/<span class=\"token variable\">$fileName</span>/properties --cookie <span class=\"token string\">'JSESSIONID=0F653A1AAD18EE1FBCF3C8A4DE897F02'</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># 返回</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token operator\">&lt;</span>?xml <span class=\"token assign-left variable\">version</span><span class=\"token operator\">=</span><span class=\"token string\">\"1.0\"</span> <span class=\"token assign-left variable\">encoding</span><span class=\"token operator\">=</span><span class=\"token string\">\"utf-8\"</span>?<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token operator\">&lt;</span>repositoryFileDto<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token operator\">&lt;</span>aclNode<span class=\"token operator\">></span>false<span class=\"token operator\">&lt;</span>/aclNode<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token operator\">&lt;</span>createdDate<span class=\"token operator\">></span><span class=\"token number\">158313930270</span><span class=\"token operator\"><span class=\"token file-descriptor important\">6</span>&lt;</span>/createdDate<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token operator\">&lt;</span>deletedDate/<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token operator\">&lt;</span>fileSize<span class=\"token operator\">></span>-<span class=\"token operator\"><span class=\"token file-descriptor important\">1</span>&lt;</span>/fileSize<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token operator\">&lt;</span>folder<span class=\"token operator\">></span>true<span class=\"token operator\">&lt;</span>/folder<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  <span class=\"token operator\">&lt;</span>hidden<span class=\"token operator\">></span>true<span class=\"token operator\">&lt;</span>/hidden<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  <span class=\"token operator\">&lt;</span>id<span class=\"token operator\">></span>ef9c73e9-d905-40ea-aaac-c64e1f619a0<span class=\"token operator\"><span class=\"token file-descriptor important\">1</span>&lt;</span>/id<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  <span class=\"token operator\">&lt;</span>lastModifiedDate/<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  <span class=\"token operator\">&lt;</span>locale<span class=\"token operator\">></span>zh<span class=\"token operator\">&lt;</span>/locale<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  <span class=\"token operator\">&lt;</span>lockDate/<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  <span class=\"token operator\">&lt;</span>locked<span class=\"token operator\">></span>false<span class=\"token operator\">&lt;</span>/locked<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  <span class=\"token operator\">&lt;</span>name<span class=\"token operator\">></span>zcyuan<span class=\"token operator\">&lt;</span>/name<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  <span class=\"token operator\">&lt;</span>notSchedulable<span class=\"token operator\">></span>false<span class=\"token operator\">&lt;</span>/notSchedulable<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  <span class=\"token operator\">&lt;</span>ownerType<span class=\"token operator\">></span>-<span class=\"token operator\"><span class=\"token file-descriptor important\">1</span>&lt;</span>/ownerType<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  <span class=\"token operator\">&lt;</span>path<span class=\"token operator\">></span>/home/zcyuan<span class=\"token operator\">&lt;</span>/path<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  <span class=\"token operator\">&lt;</span>title<span class=\"token operator\">></span>zcyuan<span class=\"token operator\">&lt;</span>/title<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>  <span class=\"token operator\">&lt;</span>versionCommentEnabled<span class=\"token operator\">></span>false<span class=\"token operator\">&lt;</span>/versionCommentEnabled<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  <span class=\"token operator\">&lt;</span>versioned<span class=\"token operator\">></span>false<span class=\"token operator\">&lt;</span>/versioned<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>  <span class=\"token operator\">&lt;</span>versioningEnabled<span class=\"token operator\">></span>false<span class=\"token operator\">&lt;</span>/versioningEnabled<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token operator\">&lt;</span>/repositoryFileDto<span class=\"token operator\">></span></pre></td></tr></table></figure><h2 id=\"删除文件\"><a class=\"anchor\" href=\"#删除文件\">#</a> 删除文件</h2>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 传入如上文件 id</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">curl</span> -XPUT http://127.0.0.1:8080/pentaho/api/repo/files/delete\" -d <span class=\"token string\">'7063d459-b719-4248-8662-5f3ad5118a15'</span> --cookie <span class=\"token string\">'JSESSIONID=0F653A1AAD18EE1FBCF3C8A4DE897F02'</span></pre></td></tr></table></figure><h2 id=\"修改文件是否对用户隐藏用户不拥有管理安全性权限\"><a class=\"anchor\" href=\"#修改文件是否对用户隐藏用户不拥有管理安全性权限\">#</a> 修改文件是否对用户隐藏（用户不拥有管理安全性权限）</h2>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">fileName</span><span class=\"token operator\">=</span>%3Ahome%3Azcyuan <span class=\"token comment\"># /home/zcyuan</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># 隐藏</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">curl</span> -XPUT http://127.0.0.1:8080/pentaho/api/repo/files/<span class=\"token variable\">$fileName</span>/metadata  -d <span class=\"token string\">'&#123;\"stringKeyStringValueDto\":[&#123;\"key\":\"_PERM_HIDDEN\", \"value\":\"true\"&#125;]&#125;'</span>  -H <span class=\"token string\">\"Content-Type: application/json\"</span>  --cookie <span class=\"token string\">'JSESSIONID=0F653A1AAD18EE1FBCF3C8A4DE897F02'</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\"># 不隐藏</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token function\">curl</span> -XPUT http://127.0.0.1:8080/pentaho/api/repo/files/<span class=\"token variable\">$fileName</span>/metadata  -d <span class=\"token string\">'&#123;\"stringKeyStringValueDto\":[&#123;\"key\":\"_PERM_HIDDEN\", \"value\":\"false\"&#125;]&#125;'</span>  -H <span class=\"token string\">\"Content-Type: application/json\"</span>  --cookie <span class=\"token string\">'JSESSIONID=0F653A1AAD18EE1FBCF3C8A4DE897F02'</span></pre></td></tr></table></figure><blockquote>\n<p>设置了隐藏，则 用户 zcyuan 对其文件不可见</p>\n</blockquote>\n<p><img data-src=\"https://i.bmp.ovh/imgs/2020/03/ed2647fff4343718.png\" alt=\"\" /></p>\n<h2 id=\"获取文件权限信息\"><a class=\"anchor\" href=\"#获取文件权限信息\">#</a> 获取文件权限信息</h2>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">curl</span> http://127.0.0.1:8080/pentaho/api/repo/files/<span class=\"token variable\">$fileName</span>/acl --cookie <span class=\"token string\">'JSESSIONID=0F653A1AAD18EE1FBCF3C8A4DE897F02'</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># 返回</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token operator\">&lt;</span>?xml <span class=\"token assign-left variable\">version</span><span class=\"token operator\">=</span><span class=\"token string\">\"1.0\"</span> <span class=\"token assign-left variable\">encoding</span><span class=\"token operator\">=</span><span class=\"token string\">\"UTF-8\"</span>?<span class=\"token operator\">></span><span class=\"token operator\">&lt;</span>root<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token operator\">&lt;</span>aces<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token operator\">&lt;</span>modifiable<span class=\"token operator\">></span>true<span class=\"token operator\">&lt;</span>/modifiable<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token operator\">&lt;</span>permissions<span class=\"token operator\">></span><span class=\"token operator\"><span class=\"token file-descriptor important\">4</span>&lt;</span>/permissions<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token operator\">&lt;</span>recipient<span class=\"token operator\">></span>zcyuan<span class=\"token operator\">&lt;</span>/recipient<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token operator\">&lt;</span>recipientType<span class=\"token operator\">></span><span class=\"token operator\"><span class=\"token file-descriptor important\">0</span>&lt;</span>/recipientType<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token operator\">&lt;</span>/aces<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token operator\">&lt;</span>aces<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token operator\">&lt;</span>modifiable<span class=\"token operator\">></span>false<span class=\"token operator\">&lt;</span>/modifiable<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token operator\">&lt;</span>permissions<span class=\"token operator\">></span><span class=\"token operator\"><span class=\"token file-descriptor important\">4</span>&lt;</span>/permissions<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token operator\">&lt;</span>recipient<span class=\"token operator\">></span>Administrator<span class=\"token operator\">&lt;</span>/recipient<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token operator\">&lt;</span>recipientType<span class=\"token operator\">></span><span class=\"token operator\"><span class=\"token file-descriptor important\">1</span>&lt;</span>/recipientType<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  <span class=\"token operator\">&lt;</span>/aces<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  <span class=\"token operator\">&lt;</span>entriesInheriting<span class=\"token operator\">></span>false<span class=\"token operator\">&lt;</span>/entriesInheriting<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  <span class=\"token operator\">&lt;</span>id<span class=\"token operator\">></span>ef9c73e9-d905-40ea-aaac-c64e1f619a0<span class=\"token operator\"><span class=\"token file-descriptor important\">1</span>&lt;</span>/id<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  <span class=\"token operator\">&lt;</span>owner<span class=\"token operator\">></span>zcyuan<span class=\"token operator\">&lt;</span>/owner<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  <span class=\"token operator\">&lt;</span>ownerType<span class=\"token operator\">></span><span class=\"token operator\"><span class=\"token file-descriptor important\">0</span>&lt;</span>/ownerType<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token operator\">&lt;</span>/root<span class=\"token operator\">></span></pre></td></tr></table></figure><ul>\n<li>\n<p><strong>aces</strong> : 角色或用户</p>\n<ul>\n<li>\n<p><strong>modifiable</strong> : （用户或角色）的权限</p>\n<ul>\n<li>\n<p><strong>完全控制</strong> ： &lt;permissions&gt;4&lt;/permissions&gt;</p>\n</li>\n<li>\n<p><strong>删除</strong>： &lt;permissions&gt;3&lt;/permissions&gt;</p>\n<p>​\t\t    &lt;permissions&gt;2&lt;/permissions&gt;</p>\n<p>​            &lt;permissions&gt;4&lt;/permissions&gt;</p>\n</li>\n<li>\n<p><strong>写</strong>：&lt;permissions&gt;1&lt;/permissions&gt;</p>\n<p>​\t\t&lt;permissions&gt;0&lt;/permissions&gt;</p>\n</li>\n<li>\n<p><strong>读</strong> ：&lt;permissions&gt;0&lt;/permissions&gt;</p>\n</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n<h2 id=\"给文件添加用户或角色\"><a class=\"anchor\" href=\"#给文件添加用户或角色\">#</a> 给文件添加用户或角色</h2>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">fileName</span><span class=\"token operator\">=</span>%3Ahome%3Azcyuan <span class=\"token comment\"># /home/zcyuan </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># 先获取文件权限信息</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">curl</span> http://127.0.0.1:8080/pentaho/api/repo/files/<span class=\"token variable\">$fileName</span>/acl --cookie <span class=\"token string\">'JSESSIONID=F1B72D8373A75C910F94A604E8FC276B'</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\"># 返回</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>:<span class=\"token operator\">&lt;&lt;</span><span class=\"token operator\">!</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token operator\">&lt;</span>?xml <span class=\"token assign-left variable\">version</span><span class=\"token operator\">=</span><span class=\"token string\">\"1.0\"</span> <span class=\"token assign-left variable\">encoding</span><span class=\"token operator\">=</span><span class=\"token string\">\"utf-8\"</span>?<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token operator\">&lt;</span>repositoryFileAclDto<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token operator\">&lt;</span>aces<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token operator\">&lt;</span>modifiable<span class=\"token operator\">></span>true<span class=\"token operator\">&lt;</span>/modifiable<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token operator\">&lt;</span>permissions<span class=\"token operator\">></span><span class=\"token operator\"><span class=\"token file-descriptor important\">4</span>&lt;</span>/permissions<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token operator\">&lt;</span>recipient<span class=\"token operator\">></span>zcyuan<span class=\"token operator\">&lt;</span>/recipient<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token operator\">&lt;</span>recipientType<span class=\"token operator\">></span><span class=\"token operator\"><span class=\"token file-descriptor important\">0</span>&lt;</span>/recipientType<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  <span class=\"token operator\">&lt;</span>/aces<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre> </pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  <span class=\"token operator\">&lt;</span>aces<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token operator\">&lt;</span>modifiable<span class=\"token operator\">></span>false<span class=\"token operator\">&lt;</span>/modifiable<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token operator\">&lt;</span>permissions<span class=\"token operator\">></span><span class=\"token operator\"><span class=\"token file-descriptor important\">4</span>&lt;</span>/permissions<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token operator\">&lt;</span>recipient<span class=\"token operator\">></span>Administrator<span class=\"token operator\">&lt;</span>/recipient<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token operator\">&lt;</span>recipientType<span class=\"token operator\">></span><span class=\"token operator\"><span class=\"token file-descriptor important\">1</span>&lt;</span>/recipientType<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  <span class=\"token operator\">&lt;</span>/aces<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>  <span class=\"token operator\">&lt;</span>entriesInheriting<span class=\"token operator\">></span>false<span class=\"token operator\">&lt;</span>/entriesInheriting<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  <span class=\"token operator\">&lt;</span>id<span class=\"token operator\">></span>ef9c73e9-d905-40ea-aaac-c64e1f619a0<span class=\"token operator\"><span class=\"token file-descriptor important\">1</span>&lt;</span>/id<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>  <span class=\"token operator\">&lt;</span>owner<span class=\"token operator\">></span>zcyuan<span class=\"token operator\">&lt;</span>/owner<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>  <span class=\"token operator\">&lt;</span>ownerType<span class=\"token operator\">></span><span class=\"token operator\"><span class=\"token file-descriptor important\">0</span>&lt;</span>/ownerType<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token operator\">&lt;</span>/repositoryFileAclDto<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>！</pre></td></tr><tr><td data-num=\"30\"></td><td><pre></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token comment\"># 在其文件上添加角色 zjft 且权限为 删除、写、读</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token comment\"># 将下面 aces 插入上面 xml 的 root 中</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>:<span class=\"token operator\">&lt;&lt;</span><span class=\"token operator\">!</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>  <span class=\"token operator\">&lt;</span>aces<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>    <span class=\"token operator\">&lt;</span>modifiable<span class=\"token operator\">></span>true<span class=\"token operator\">&lt;</span>/modifiable<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>    <span class=\"token operator\">&lt;</span>permissions<span class=\"token operator\">></span><span class=\"token operator\"><span class=\"token file-descriptor important\">4</span>&lt;</span>/permissions<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    <span class=\"token operator\">&lt;</span>permissions<span class=\"token operator\">></span><span class=\"token operator\"><span class=\"token file-descriptor important\">3</span>&lt;</span>/permissions<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>    <span class=\"token operator\">&lt;</span>permissions<span class=\"token operator\">></span><span class=\"token operator\"><span class=\"token file-descriptor important\">2</span>&lt;</span>/permissions<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>    <span class=\"token operator\">&lt;</span>recipient<span class=\"token operator\">></span>zjft<span class=\"token operator\">&lt;</span>/recipient<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    <span class=\"token operator\">&lt;</span>recipientType<span class=\"token operator\">></span><span class=\"token operator\"><span class=\"token file-descriptor important\">0</span>&lt;</span>/recipientType<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>  <span class=\"token operator\">&lt;</span>/aces<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre><span class=\"token operator\">!</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre><span class=\"token function\">curl</span> -XPUT http://127.0.0.1:8080/pentaho/api/repo/files/<span class=\"token variable\">$fileName</span>/acl -d <span class=\"token string\">'&lt;?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"yes\"?>&lt;repositoryFileAclDto>&lt;aces>&lt;modifiable>true&lt;/modifiable>&lt;permissions>4&lt;/permissions>&lt;recipient>zcyuan&lt;/recipient>&lt;recipientType>0&lt;/recipientType>&lt;/aces>&lt;aces>&lt;modifiable>true&lt;/modifiable>&lt;permissions>0&lt;/permissions>&lt;permissions>1&lt;/permissions>&lt;permissions>2&lt;/permissions>&lt;recipient>zjft&lt;/recipient>&lt;recipientType>1&lt;/recipientType>&lt;/aces>&lt;aces>&lt;modifiable>false&lt;/modifiable>&lt;permissions>4&lt;/permissions>&lt;recipient>Administrator&lt;/recipient>&lt;recipientType>1&lt;/recipientType>&lt;/aces>&lt;entriesInheriting>false&lt;/entriesInheriting>&lt;id>ef9c73e9-d905-40ea-aaac-c64e1f619a01&lt;/id>&lt;owner>zcyuan&lt;/owner>&lt;ownerType>0&lt;/ownerType>&lt;/repositoryFileAclDto>'</span> -H <span class=\"token string\">'Content-Type: application/xml'</span> --cookie <span class=\"token string\">'JSESSIONID=F1B72D8373A75C910F94A604E8FC276B'</span></pre></td></tr></table></figure><p><img data-src=\"https://i.bmp.ovh/imgs/2020/03/0f74c11918a17f67.png\" alt=\"\" /></p>\n<h2 id=\"给zcyuan添加zjft角色登录查看文件\"><a class=\"anchor\" href=\"#给zcyuan添加zjft角色登录查看文件\">#</a> 给 zcyuan 添加 zjft 角色，登录查看文件</h2>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">curl</span> -XPUT http://127.0.0.1:8080/pentaho/api/userroledao/assignRoleToUser?userName<span class=\"token operator\">=</span>zcyuan<span class=\"token operator\">&amp;</span><span class=\"token assign-left variable\">roleNames</span><span class=\"token operator\">=</span>zjft%09  --cookie <span class=\"token string\">'JSESSIONID=F1B72D8373A75C910F94A604E8FC276B'</span></pre></td></tr></table></figure><p><img data-src=\"https://i.bmp.ovh/imgs/2020/03/ba3daf5212818ea8.png\" alt=\"\" /></p>\n<h2 id=\"表结构\"><a class=\"anchor\" href=\"#表结构\">#</a> 表结构</h2>\n<p><strong>ab_files</strong></p>\n<table>\n<thead>\n<tr>\n<th>字段名</th>\n<th>类型</th>\n<th style=\"text-align:left\">描述</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>id</td>\n<td>int</td>\n<td style=\"text-align:left\"></td>\n</tr>\n<tr>\n<td>no</td>\n<td>int</td>\n<td style=\"text-align:left\">功能点</td>\n</tr>\n<tr>\n<td>file_id</td>\n<td>int</td>\n<td style=\"text-align:left\">文件 id</td>\n</tr>\n<tr>\n<td>file_name</td>\n<td>varchar</td>\n<td style=\"text-align:left\">文件名</td>\n</tr>\n<tr>\n<td>described</td>\n<td>varchar</td>\n<td style=\"text-align:left\">文件描述</td>\n</tr>\n<tr>\n<td>theme</td>\n<td>varchar</td>\n<td style=\"text-align:left\">主题</td>\n</tr>\n<tr>\n<td>source</td>\n<td>tinyint</td>\n<td style=\"text-align:left\">文件来源（1:superset，2:pentaho）</td>\n</tr>\n<tr>\n<td>path</td>\n<td>varchar</td>\n<td style=\"text-align:left\">iframe url</td>\n</tr>\n<tr>\n<td>type</td>\n<td>tinyint</td>\n<td style=\"text-align:left\">文件类型（0：chart，1:dashbord，2:prpt ）</td>\n</tr>\n<tr>\n<td>cover</td>\n<td>varhcar</td>\n<td style=\"text-align:left\">模版路径</td>\n</tr>\n<tr>\n<td>is_delete</td>\n<td>int</td>\n<td style=\"text-align:left\">该文件是否删除</td>\n</tr>\n<tr>\n<td>create_dtm</td>\n<td>datedtime</td>\n<td style=\"text-align:left\">创建时间</td>\n</tr>\n</tbody>\n</table>\n<p><strong>ab_file_flag</strong></p>\n<table>\n<thead>\n<tr>\n<th>字段名</th>\n<th>类型</th>\n<th style=\"text-align:left\">描述</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>id</td>\n<td>int</td>\n<td style=\"text-align:left\"></td>\n</tr>\n<tr>\n<td>user_id</td>\n<td>int</td>\n<td style=\"text-align:left\">用户 id</td>\n</tr>\n<tr>\n<td>file_id</td>\n<td>int</td>\n<td style=\"text-align:left\">文件 id</td>\n</tr>\n<tr>\n<td>board</td>\n<td>tinyint</td>\n<td style=\"text-align:left\">是否加入看板</td>\n</tr>\n<tr>\n<td>top</td>\n<td>tinyint</td>\n<td style=\"text-align:left\">是否置顶</td>\n</tr>\n<tr>\n<td>top_dtm</td>\n<td>datetime</td>\n<td style=\"text-align:left\">置顶时间</td>\n</tr>\n<tr>\n<td>row</td>\n<td>int</td>\n<td style=\"text-align:left\">看板排序</td>\n</tr>\n</tbody>\n</table>\n<p><em><strong>由图可知 zcyuan 用户可看 zjft 角色下所有的文件，且用户文件 /home/zcyuan 文件夹被隐藏</strong></em></p>\n<hr />\n<h1 id=\"参考资料\"><a class=\"anchor\" href=\"#参考资料\">#</a> 参考资料</h1>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9oZWxwLnBlbnRhaG8uY29tL0RvY3VtZW50YXRpb24vOC4zL0RldmVsb3Blcl9jZW50ZXIvUkVTVF9BUElfUmVmZXJlbmNlL1VzZXJfUm9sZV9NYW5hZ2VtZW50LzBPMA==\">https://help.pentaho.com/Documentation/8.3/Developer_center/REST_API_Reference/User_Role_Management/0O0</span></p>\n",
            "tags": [
                "计算机科学",
                "大数据",
                "数据可视化",
                "pentaho"
            ]
        },
        {
            "id": "http://yrmlnf.coding-pages.com/Pentaho-8-3%E7%89%88%E6%9C%AC%E6%95%B0%E6%8D%AE%E5%BA%93%E8%BF%81%E7%A7%BB/",
            "url": "http://yrmlnf.coding-pages.com/Pentaho-8-3%E7%89%88%E6%9C%AC%E6%95%B0%E6%8D%AE%E5%BA%93%E8%BF%81%E7%A7%BB/",
            "title": "Pentaho-8.3版本数据库迁移",
            "date_published": "2021-03-31T03:11:00.000Z",
            "content_html": "<h1 id=\"前言\"><a class=\"anchor\" href=\"#前言\">#</a> 前言</h1>\n<p>Pentaho 默认的资源库是 PostgreSQL，ktr 文件与报表文件都加密存放在 PostgreSQL，本文介绍如何把 PostgreSQL 迁移到其他数据库</p>\n<h1 id=\"迁移到mysql\"><a class=\"anchor\" href=\"#迁移到mysql\">#</a> 迁移到 MySQL</h1>\n<h2 id=\"导入数据库文件pentaho-serverdatamysql5\"><a class=\"anchor\" href=\"#导入数据库文件pentaho-serverdatamysql5\">#</a> 导入数据库文件 (pentaho-server/data/mysql5)</h2>\n<blockquote>\n<p>环境</p>\n<p>mysql：5.7.17（maridb：10.3.13）</p>\n</blockquote>\n<p><strong>create_jcr_mysql.sql</strong>： 创建 jackrabbit 数据库存储用户相关</p>\n<p>**create_quartz_mysql.sql ** ：为 Quartz 计划任务器创建资源库。</p>\n<p><strong>create_repository_mysql.sql</strong> ：创建 hibernate 数据库，用于存储用户授权认证，solution repository 以及数据源。</p>\n<p><em><strong>* 注：以上三个脚本会创建三个数据库 hibernate、quartz、jackrabbit 和对应的三个用户 hibuser、pentaho_user、jcr_user 密码都为 password 如果在这里你想将密码改成自己的那么以下配置时将对应密码改成你修改的密码即可</strong></em></p>\n<h2 id=\"导入驱动包\"><a class=\"anchor\" href=\"#导入驱动包\">#</a> 导入驱动包</h2>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 复制驱动包</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">cp</span> tomcat/lib/mysql-connector-java.x.xx.xx.jar <span class=\"token punctuation\">\\</span>biserver-ce<span class=\"token punctuation\">\\</span>tomcat<span class=\"token punctuation\">\\</span>webapps<span class=\"token punctuation\">\\</span>pentaho<span class=\"token punctuation\">\\</span>WEB-INF<span class=\"token punctuation\">\\</span>lib</pre></td></tr></table></figure><h2 id=\"依次修改-pentaho-serverpentaho-solutionssystem-下文件\"><a class=\"anchor\" href=\"#依次修改-pentaho-serverpentaho-solutionssystem-下文件\">#</a> 依次修改 pentaho-server/pentaho-solutions/system/ 下文件</h2>\n<ul>\n<li>\n<h2 id=\"applicationcontext-spring-security-jdbcproperties\"><a class=\"anchor\" href=\"#applicationcontext-spring-security-jdbcproperties\">#</a> applicationContext-spring-security-jdbc.properties</h2>\n<figure class=\"highlight properties\"><figcaption data-lang=\".properties\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 修改或删除 HSQLDB 配置</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token attr-name\">datasource.driver.classname</span><span class=\"token punctuation\">=</span><span class=\"token attr-value\">com.mysql.jdbc.Driver</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token attr-name\">datasource.url</span><span class=\"token punctuation\">=</span><span class=\"token attr-value\">jdbc:mysql://localhost:3306/hibernate</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token attr-name\">datasource.username</span><span class=\"token punctuation\">=</span><span class=\"token attr-value\">root</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token attr-name\">datasource.password</span><span class=\"token punctuation\">=</span><span class=\"token attr-value\">root</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\"># The SQL query that will be used to validate connections from this pool before returning them to the caller. </span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\"># This query must be an SELECT statement that returns at least one row.</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\"># HSQLDB: SELECT 1 FROM INFORMATION_SCHEMA.SYSTEM_USERS</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token comment\"># MySQL, H2, MS-SQL, POSTGRESQL, SQLite: SELECT 1</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\"># ORACLE: SELECT 1 FROM DUAL</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token attr-name\">datasource.validation.query</span><span class=\"token punctuation\">=</span><span class=\"token attr-value\">SELECT 1</span></pre></td></tr></table></figure></li>\n<li>\n<h2 id=\"applicationcontext-spring-security-hibernateproperties\"><a class=\"anchor\" href=\"#applicationcontext-spring-security-hibernateproperties\">#</a> applicationContext-spring-security-hibernate.properties</h2>\n<figure class=\"highlight properties\"><figcaption data-lang=\".properties\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 修改或删除 HSQLDB 配置</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token attr-name\">jdbc.driver</span><span class=\"token punctuation\">=</span><span class=\"token attr-value\">com.mysql.jdbc.Driver</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token attr-name\">jdbc.url</span><span class=\"token punctuation\">=</span><span class=\"token attr-value\">jdbc:mysql://localhost:3306/hibernate</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token attr-name\">jdbc.username</span><span class=\"token punctuation\">=</span><span class=\"token attr-value\">hibuser</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token attr-name\">jdbc.password</span><span class=\"token punctuation\">=</span><span class=\"token attr-value\">password</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token attr-name\">hibernate.dialect</span><span class=\"token punctuation\">=</span><span class=\"token attr-value\">org.hibernate.dialect.MySQL5InnoDBDialect</span></pre></td></tr></table></figure></li>\n<li>\n<h2 id=\"hibernatehibernate-settingsxml\"><a class=\"anchor\" href=\"#hibernatehibernate-settingsxml\">#</a> hibernate\\hibernate-settings.xml</h2>\n<figure class=\"highlight xml\"><figcaption data-lang=\"XML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">&lt;!-- 修改配置文件为 MySQL/MARIDB 配置</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  * This setting allows the deployment to specify where to find the </pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  * database-specific hibernate configuration. The samples supplied</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  * include the following:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  * </pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  * system/hibernate/hsql.hibernate.cfg.xml</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  * system/hibernate/mysql5.hibernate.cfg.xml</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  * system/hibernate/postgresql.hibernate.cfg.xml</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  * system/hibernate/oracle10g.hibernate.cfg.xml</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  * system/hibernate/sqlserver.hibernate.cfg.xml</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  *</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  --></span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>config-file</span><span class=\"token punctuation\">></span></span>system/hibernate/mysql5.hibernate.cfg.xml<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>config-file</span><span class=\"token punctuation\">></span></span></pre></td></tr></table></figure></li>\n<li>\n<h2 id=\"quartzquartzproperties\"><a class=\"anchor\" href=\"#quartzquartzproperties\">#</a> quartz\\quartz.properties</h2>\n<figure class=\"highlight properties\"><figcaption data-lang=\".properties\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#org.quartz.jobStore.driverDelegateClass = org.quartz.impl.jdbcjobstore.StdJDBCDelegate</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">#       Where DriverDelegateClass is one of:</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">#         - StdJDBCDelegate (for many JDBC-compliant drivers)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">#         - MSSQLDelegate (for Microsoft SQL Server drivers)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\">#         - PostgreSQLDelegate (for PostgreSQL drivers)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\">#         - WebLogicDelegate (for WebLogic drivers)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\">#         - oracle.OracleDelegate (for Oracle drivers)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token attr-name\">org.quartz.jobStore.driverDelegateClass</span> <span class=\"token punctuation\">=</span> <span class=\"token attr-value\">org.quartz.impl.jdbcjobstore.StdJDBCDelegate</span></pre></td></tr></table></figure></li>\n<li>\n<h2 id=\"simple-jndijdbcproperties\"><a class=\"anchor\" href=\"#simple-jndijdbcproperties\">#</a> simple-jndi\\jdbc.properties</h2>\n<figure class=\"highlight properties\"><figcaption data-lang=\".properties\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token attr-name\">SampleData/type</span><span class=\"token punctuation\">=</span><span class=\"token attr-value\">javax.sql.DataSource</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token attr-name\">SampleData/driver</span><span class=\"token punctuation\">=</span><span class=\"token attr-value\">com.mysql.jdbc.Driver</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token attr-name\">SampleData/url</span><span class=\"token punctuation\">=</span><span class=\"token attr-value\">jdbc:mysql://localhost:3306/sampledata</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token attr-name\">SampleData/user</span><span class=\"token punctuation\">=</span><span class=\"token attr-value\">pentaho_user</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token attr-name\">SampleData/password</span><span class=\"token punctuation\">=</span><span class=\"token attr-value\">password</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token attr-name\">Hibernate/type</span><span class=\"token punctuation\">=</span><span class=\"token attr-value\">javax.sql.DataSource</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token attr-name\">Hibernate/driver</span><span class=\"token punctuation\">=</span><span class=\"token attr-value\">com.mysql.jdbc.Driver</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token attr-name\">Hibernate/url</span><span class=\"token punctuation\">=</span><span class=\"token attr-value\">jdbc:mysql://localhost:3306/hibernate</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token attr-name\">Hibernate/user</span><span class=\"token punctuation\">=</span><span class=\"token attr-value\">hibuser</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token attr-name\">Hibernate/password</span><span class=\"token punctuation\">=</span><span class=\"token attr-value\">password</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token attr-name\">Quartz/type</span><span class=\"token punctuation\">=</span><span class=\"token attr-value\">javax.sql.DataSource</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token attr-name\">Quartz/driver</span><span class=\"token punctuation\">=</span><span class=\"token attr-value\">com.mysql.jdbc.Driver</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token attr-name\">Quartz/url</span><span class=\"token punctuation\">=</span><span class=\"token attr-value\">jdbc:mysql://localhost:3306/quartz</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token attr-name\">Quartz/user</span><span class=\"token punctuation\">=</span><span class=\"token attr-value\">pentaho_user</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token attr-name\">Quartz/password</span><span class=\"token punctuation\">=</span><span class=\"token attr-value\">password</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token attr-name\">Shark/type</span><span class=\"token punctuation\">=</span><span class=\"token attr-value\">javax.sql.DataSource</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token attr-name\">Shark/driver</span><span class=\"token punctuation\">=</span><span class=\"token attr-value\">com.mysql.jdbc.Driver</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token attr-name\">Shark/url</span><span class=\"token punctuation\">=</span><span class=\"token attr-value\">jdbc:mysql://localhost:3306/shark</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token attr-name\">Shark/user</span><span class=\"token punctuation\">=</span><span class=\"token attr-value\">root</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token attr-name\">Shark/password</span><span class=\"token punctuation\">=</span><span class=\"token attr-value\">root</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token attr-name\">SampleDataAdmin/type</span><span class=\"token punctuation\">=</span><span class=\"token attr-value\">javax.sql.DataSource</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token attr-name\">SampleDataAdmin/driver</span><span class=\"token punctuation\">=</span><span class=\"token attr-value\">com.mysql.jdbc.Driver</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token attr-name\">SampleDataAdmin/url</span><span class=\"token punctuation\">=</span><span class=\"token attr-value\">jdbc:mysql://localhost:3306/sampledata</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token attr-name\">SampleDataAdmin/user</span><span class=\"token punctuation\">=</span><span class=\"token attr-value\">pentaho_user</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token attr-name\">SampleDataAdmin/password</span><span class=\"token punctuation\">=</span><span class=\"token attr-value\">password</span></pre></td></tr></table></figure></li>\n<li>\n<h2 id=\"webappspentahometa-infcontextxml\"><a class=\"anchor\" href=\"#webappspentahometa-infcontextxml\">#</a> webapps\\pentaho\\META-INF\\context.xml</h2>\n<figure class=\"highlight xml\"><figcaption data-lang=\"XML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token prolog\">&lt;?xml version=\"1.0\" encoding=\"UTF-8\"?></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>Context</span> <span class=\"token attr-name\">path</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>/pentaho<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">docbase</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>webapps/pentaho/<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\t<span class=\"token comment\">&lt;!-- &lt;Resource name=\"jdbc/Hibernate\" auth=\"Container\" type=\"javax.sql.DataSource\"</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t\tfactory=\"org.apache.tomcat.jdbc.pool.DataSourceFactory\" maxActive=\"20\" minIdle=\"0\" maxIdle=\"5\" initialSize=\"0\"</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t\tmaxWait=\"10000\" username=\"hibuser\" password=\"password\"</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t\tdriverClassName=\"org.hsqldb.jdbcDriver\" url=\"jdbc:hsqldb:hsql://localhost/hibernate\"</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t\tvalidationQuery=\"select count(*) from INFORMATION_SCHEMA.SYSTEM_SEQUENCES\" /></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t\t</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t&lt;Resource name=\"jdbc/Quartz\" auth=\"Container\" type=\"javax.sql.DataSource\"</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t\tfactory=\"org.apache.tomcat.jdbc.pool.DataSourceFactory\" maxActive=\"20\" minIdle=\"0\" maxIdle=\"5\" initialSize=\"0\"</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t\tmaxWait=\"10000\" username=\"pentaho_user\" password=\"password\"</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t\tdriverClassName=\"org.hsqldb.jdbcDriver\" url=\"jdbc:hsqldb:hsql://localhost/quartz\"</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t\tvalidationQuery=\"select count(*) from INFORMATION_SCHEMA.SYSTEM_SEQUENCES\"/> --></span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>Resource</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>jdbc/Hibernate<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">auth</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>Container<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">type</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>javax.sql.DataSource<span class=\"token punctuation\">\"</span></span> </pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token attr-name\">factory</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>org.apache.commons.dbcp.BasicDataSourceFactory<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">maxActive</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>20<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">maxIdle</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>5<span class=\"token punctuation\">\"</span></span> </pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token attr-name\">maxWait</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>10000<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">username</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>hibuser<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">password</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>password<span class=\"token punctuation\">\"</span></span> </pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token attr-name\">driverClassName</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>com.mysql.jdbc.Driver<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">url</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>jdbc:mysql://localhost:3306/hibernate<span class=\"token punctuation\">\"</span></span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token attr-name\">validationQuery</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>select 1<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/></span></span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>Resource</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>jdbc/Quartz<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">auth</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>Container<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">type</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>javax.sql.DataSource<span class=\"token punctuation\">\"</span></span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token attr-name\">factory</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>org.apache.commons.dbcp.BasicDataSourceFactory<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">maxActive</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>20<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">maxIdle</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>5<span class=\"token punctuation\">\"</span></span> </pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token attr-name\">maxWait</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>10000<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">username</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>pentaho_user<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">password</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>password<span class=\"token punctuation\">\"</span></span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token attr-name\">driverClassName</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>com.mysql.jdbc.Driver<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">url</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>jdbc:mysql://localhost:3306/quartz<span class=\"token punctuation\">\"</span></span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token attr-name\">validationQuery</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>select 1<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">/></span></span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>Context</span><span class=\"token punctuation\">></span></span></pre></td></tr></table></figure></li>\n<li>\n<h2 id=\"tomcatwebappspentahoweb-infwebxml\"><a class=\"anchor\" href=\"#tomcatwebappspentahoweb-infwebxml\">#</a> tomcat\\webapps\\pentaho\\WEB-INF\\web.xml</h2>\n<figure class=\"highlight xml\"><figcaption data-lang=\"XML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>注释掉以下两段内容（默认的hsqldb数据库）</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>&lt; !-- [BEGIN HSQLDB DATABASES] --></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>&lt; context-param></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>&lt; param-name>hsqldb-databases<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>param-name</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>&lt; param-value>sampledata@../../data/hsqldb/sampledata,hibernate@../../data/hsqldb/hibernate,quartz@../../data/hsqldb/quartz<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>param-value</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>&lt; /context-param></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>&lt; !-- [END HSQLDB DATABASES] --></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>&lt; !-- [BEGIN HSQLDB STARTER] --></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>&lt; listener></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>&lt; listener-class>org.pentaho.platform.web.http.context.HsqldbStartupListener<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>listener-class</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>&lt; /listener></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>&lt; !-- [END HSQLDB STARTER] --></pre></td></tr></table></figure></li>\n<li>\n<h2 id=\"jackrabbitrepositoryxml\"><a class=\"anchor\" href=\"#jackrabbitrepositoryxml\">#</a> jackrabbit\\repository.xml</h2>\n<figure class=\"highlight xml\"><figcaption data-lang=\"XML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">&lt;!--Repository/FileSystem--></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>FileSystem</span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>org.apache.jackrabbit.core.fs.db.DbFileSystem<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>param</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>driver<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">value</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>com.mysql.jdbc.Driver<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">/></span></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>param</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>url<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">value</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>jdbc:mysql://localhost:3306/jackrabbit<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">/></span></span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>param</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>user<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">value</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>jcr_user<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">/></span></span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>param</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>password<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">value</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>password<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">/></span></span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>param</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>schema<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">value</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>mysql<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">/></span></span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>param</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>schemaObjectPrefix<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">value</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>fs_repos_<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">/></span></span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>FileSystem</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\">&lt;!-- Repository/DataStore --></span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>DataStore</span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>org.apache.jackrabbit.core.data.db.DbDataStore<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>param</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>url<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">value</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>jdbc:mysql://localhost:3306/jackrabbit<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">/></span></span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>param</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>user<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">value</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>jcr_user<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">/></span></span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>param</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>password<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">value</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>password<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">/></span></span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>param</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>databaseType<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">value</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>mysql<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">/></span></span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>param</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>driver<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">value</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>com.mysql.jdbc.Driver<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">/></span></span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>param</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>minRecordLength<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">value</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>1024<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">/></span></span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>param</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>maxConnections<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">value</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>3<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">/></span></span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>param</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>copyWhenReading<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">value</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>true<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">/></span></span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>param</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>tablePrefix<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">value</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span><span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">/></span></span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>param</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>schemaObjectPrefix<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">value</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>ds_repos_<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">/></span></span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>DataStore</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token comment\">&lt;!-- 3.3.6.4Repository/Workspace/PersistenceManagerRepository/Workspace/FileSystem--></span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>FileSystem</span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>org.apache.jackrabbit.core.fs.db.DbFileSystem<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>param</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>driver<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">value</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>com.mysql.jdbc.Driver<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">/></span></span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>param</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>url<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">value</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>jdbc:mysql://localhost:3306/jackrabbit<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">/></span></span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>param</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>user<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">value</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>jcr_user<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">/></span></span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>param</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>password<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">value</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>password<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">/></span></span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>param</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>schema<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">value</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>mysql<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">/></span></span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>param</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>schemaObjectPrefix<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">value</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>fs_ws_<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">/></span></span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>FileSystem</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre></pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token comment\">&lt;!-- Repository/Workspace/PersistenceManager--></span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>PersistenceManager</span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>org.apache.jackrabbit.core.persistence.bundle.MySqlPersistenceManager<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>param</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>driver<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">value</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>com.mysql.jdbc.Driver<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">/></span></span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>param</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>url<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">value</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>jdbc:mysql://localhost:3306/jackrabbit<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">/></span></span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>param</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>user<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">value</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>jcr_user<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/></span></span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>param</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>password<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">value</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>password<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/></span></span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>param</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>schema<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">value</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>mysql<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">/></span></span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>param</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>schemaObjectPrefix<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">value</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>$&#123;wsp.name&#125;_pm_ws_<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">/></span></span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>PersistenceManager</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre></pre></td></tr><tr><td data-num=\"43\"></td><td><pre><span class=\"token comment\">&lt;!--Repository/Versioning/FileSystem--></span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>FileSystem</span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>org.apache.jackrabbit.core.fs.db.DbFileSystem<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>param</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>driver<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">value</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>com.mysql.jdbc.Driver<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">/></span></span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>param</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>url<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">value</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>jdbc:mysql://localhost:3306/jackrabbit<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">/></span></span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>param</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>user<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">value</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>jcr_user<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">/></span></span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>param</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>password<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">value</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>password<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">/></span></span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>param</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>schema<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">value</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>mysql<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">/></span></span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>param</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>schemaObjectPrefix<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">value</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>fs_ver_<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">/></span></span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>FileSystem</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre></pre></td></tr><tr><td data-num=\"53\"></td><td><pre><span class=\"token comment\">&lt;!--Repository/Versioning/FileSystem--></span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>PersistenceManager</span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>org.apache.jackrabbit.core.persistence.bundle.MySqlPersistenceManager<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>param</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>driver<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">value</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>com.mysql.jdbc.Driver<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">/></span></span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>param</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>url<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">value</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>jdbc:mysql://localhost:3306/jackrabbit<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">/></span></span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>param</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>user<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">value</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>jcr_user<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/></span></span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>param</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>password<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">value</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>password<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/></span></span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>param</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>schema<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">value</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>mysql<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">/></span></span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>param</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>schemaObjectPrefix<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">value</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>pm_ver_<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">/></span></span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>PersistenceManager</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre></pre></td></tr><tr><td data-num=\"63\"></td><td><pre><span class=\"token comment\">&lt;!--Repository/Cluster/Journal--></span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>Cluster</span> <span class=\"token attr-name\">id</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>node1<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>     <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>Journal</span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>org.apache.jackrabbit.core.journal.DatabaseJournal<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>param</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>revision<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">value</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>$&#123;rep.home&#125;/revision.log<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/></span></span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>param</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>url<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">value</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>jdbc:mysql://localhost:3306/jackrabbit<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">/></span></span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>param</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>driver<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">value</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>com.mysql.jdbc.Driver<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">/></span></span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>param</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>user<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">value</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>jcr_user<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">/></span></span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>param</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>password<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">value</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>password<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">/></span></span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>param</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>schema<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">value</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>postgresql<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">/></span></span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>param</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>schemaObjectPrefix<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">value</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>cl_j_<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">/></span></span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>Journal</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>Cluster</span><span class=\"token punctuation\">></span></span></pre></td></tr></table></figure></li>\n</ul>\n",
            "tags": [
                "计算机科学",
                "大数据",
                "数据可视化",
                "pentaho"
            ]
        },
        {
            "id": "http://yrmlnf.coding-pages.com/Druid-%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5%E4%B8%8E%E4%BD%BF%E7%94%A8/",
            "url": "http://yrmlnf.coding-pages.com/Druid-%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5%E4%B8%8E%E4%BD%BF%E7%94%A8/",
            "title": "Druid-基本概念与使用",
            "date_published": "2021-03-31T02:58:00.000Z",
            "content_html": "<h1 id=\"什么是druid\"><a class=\"anchor\" href=\"#什么是druid\">#</a> 什么是 DRUID</h1>\n<p>​        <span class=\"exturl\" data-url=\"aHR0cHM6Ly9kcnVpZC5hcGFjaGUub3JnLw==\">Druid</span> 是一个高效的数据查询系统，主要解决的是对于大量的基于时序的数据进行聚合查询。数据可以实时摄入，进入到 Druid 后立即可查，同时数据是几乎是不可变。通常是基于时序的事实事件，事实发生后进入 Druid，外部系统就可以对该事实进行查询</p>\n<h1 id=\"druid的技术特点\"><a class=\"anchor\" href=\"#druid的技术特点\">#</a> Druid 的技术特点</h1>\n<ul>\n<li>\n<p>数据吞吐量大</p>\n</li>\n<li>\n<p>支持流式数据摄入和实时</p>\n</li>\n<li>\n<p>查询灵活且快速</p>\n</li>\n</ul>\n<h1 id=\"druid总体架构\"><a class=\"anchor\" href=\"#druid总体架构\">#</a> Druid 总体架构</h1>\n<blockquote>\n<p>本身包含了五种节点 ： Realtime、Historical、Coordinator、Broker、Indexer</p>\n</blockquote>\n<h2 id=\"historical历史节点\"><a class=\"anchor\" href=\"#historical历史节点\">#</a> Historical（历史节点)</h2>\n<blockquote>\n<p>历史节点主要负责加载已经生成好的数据文件以及提供数据查询。</p>\n</blockquote>\n<p>​        历史节点启动时，会先检查自身的本地缓存中已存在的 Segment 数据文件，然后从 DeepStorage 中下载数据自己但不在本地的 Segment 数据文件，后加载到内存后再提供查询。</p>\n<h2 id=\"realtime-实时节点\"><a class=\"anchor\" href=\"#realtime-实时节点\">#</a> Realtime （实时节点）</h2>\n<blockquote>\n<p>主要负责及时摄入实时数据，以及生成 Segment 数据文件；</p>\n</blockquote>\n<p>​          Realtime 节点只响应 broker 节点的查询请求，返回查询结果到 broker 节点。旧数据会按指定周期将数据 build 成 segments 移到 Historical 节点。一般会使用外部依赖 kafka 来提高实时摄取数据的可用性。如果不需要实时摄取数据到集群中，可以舍弃 Real-time nodes，只定时地批量从 deep storage 摄取数据即可；</p>\n<h3 id=\"segment数据文件的制造与传播\"><a class=\"anchor\" href=\"#segment数据文件的制造与传播\">#</a> Segment 数据文件的制造与传播</h3>\n<ul>\n<li>实时节点生成 Segment 数据文件，并上传到 DeepStorage 中。</li>\n<li>Segment 数据文件的相关元数据信息保存到 MetaStore 中（mysql)</li>\n<li>协调节点会从 MetaSotre 中获取到 Segment 数据文件的相关元信息后，将按配置的规则分配到符合条件的历史节点中。</li>\n<li>历史节点收到协调节点的通知后，会从 DeepStorage 中拉取该 Segment 数据文件，并通过 zookeeper 向集群声明可以提供查询了。</li>\n<li>实时节点会丢弃该 Segment 数据文件，并通过 zookeeper 向集群声明不在提供该 Sgment 的查询服务。</li>\n</ul>\n<h2 id=\"coordinator-协调节点\"><a class=\"anchor\" href=\"#coordinator-协调节点\">#</a> Coordinator (协调节点)</h2>\n<blockquote>\n<p>协调节点主要负责历史节点的数据负载均衡，以及通过规则管理数据源的生命周期。</p>\n</blockquote>\n<p>​        监控 historical 节点组，可以认为是 Druid 中的 master，其通过 Zookeeper 管理 Historical 和 Real-time nodes，且通过 Mysql 中的 metadata 管理 Segments，以确保数据可用、可复制。它们通过从 MySQL 读取数据段的元数据信息，来决定哪些数据段应该在集群中被加载，使用 Zookeeper 来确定哪个 historical 节点存在，并且创建 Zookeeper 条目告诉 historical 节点加载和删除新数据段。</p>\n<h2 id=\"broker-查询节点\"><a class=\"anchor\" href=\"#broker-查询节点\">#</a> Broker （查询节点）</h2>\n<blockquote>\n<p>对外提供数据查询服务，并同时从实施节点、历史节点查询数据，合并后返给调用方</p>\n</blockquote>\n<p>​        Druid 集群直接对外提供查询的节点只有查询节点，而查询节点会将从实时节点与历史节点查询到的数据进行合并并返回。</p>\n<h2 id=\"indexer-索引节点\"><a class=\"anchor\" href=\"#indexer-索引节点\">#</a> Indexer（ 索引节点）</h2>\n<blockquote>\n<p>索引服务用于数据导入，batch data 和 streaming data 都可以通过给 indexing services 发请求来导入数据  Indexing service 可以通过 api 的方式灵活的操作 Segment 文件，如合并，删除 Segment 等</p>\n</blockquote>\n<p>​     Indexing service 主要由三个组件构成，一个 peon 运行一个任务，一个 middle manager 负责管理多个 peon，overlord 负责接收新的任务分配给 middle manager，overlord 和 middle manager 可以运行在同一节点或跨多个节点，而 middle manager 和 peon 一般运行在同一个节点</p>\n<h3 id=\"middlemanager\"><a class=\"anchor\" href=\"#middlemanager\">#</a> MiddleManager</h3>\n<blockquote>\n<p>将新数据摄取到集群中。负责从外部数据源读取数据并发布新的 Druid segments。</p>\n</blockquote>\n<h3 id=\"overlord\"><a class=\"anchor\" href=\"#overlord\">#</a> Overlord</h3>\n<blockquote>\n<p>监视 MiddleManager 进程，并且是数据摄入 Druid 的控制器。它们负责将提取任务分配给 MiddleManagers 并协调 segment 发布</p>\n</blockquote>\n<h2 id=\"router可选\"><a class=\"anchor\" href=\"#router可选\">#</a> Router (可选)</h2>\n<blockquote>\n<p>​        Router 进程是一个可选的进程，他为 Broker、Overload 和 Coordinator 提供了统一 API 网管服务。如果不启动该进程，也可以直接连接 Broker、Overload 和 Coordinator 服务</p>\n</blockquote>\n<h2 id=\"外部依赖\"><a class=\"anchor\" href=\"#外部依赖\">#</a> 外部依赖</h2>\n<ul>\n<li><strong>Mysql</strong>：用于存储关于 Druid 中的 metadata，规则数据，配置数据等</li>\n<li><strong>Deep storage</strong> ：储 segments，Druid 目前已经支持本地磁盘，NFS 挂载磁盘，HDFS，S3 等。数据来源有 2 个批处理和 Realtime 节点</li>\n<li><strong>ZooKeeper</strong>：于管理当前 cluster 的状态为集群服务发现和维持当前的数据拓扑而服务；被 Druid 用于管理当前 cluster 的状态，比如记录哪些 segments 从实时节点移到了历史节点；</li>\n</ul>\n<h2 id=\"安装节点\"><a class=\"anchor\" href=\"#安装节点\">#</a> 安装节点</h2>\n<table>\n<thead>\n<tr>\n<th>Node</th>\n<th>IP</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong>Coordinator</strong></td>\n<td>hdp-m-1  ,hip-m-2,</td>\n</tr>\n<tr>\n<td><strong>Broker</strong></td>\n<td>hdp-m-1,hdp-m-2</td>\n</tr>\n<tr>\n<td><strong>MiddleManager</strong></td>\n<td>hdp-m-1,hdp-m-2</td>\n</tr>\n<tr>\n<td><strong>Overlord</strong></td>\n<td>hdp-m-1,hdp-m-2</td>\n</tr>\n<tr>\n<td><strong>Router</strong></td>\n<td>hdp-m-1,hdp-m-2</td>\n</tr>\n<tr>\n<td><strong>Historical</strong></td>\n<td>hdp-s-1,hdp-s-2,hdp-s-3</td>\n</tr>\n</tbody>\n</table>\n<h1 id=\"druid基本概念\"><a class=\"anchor\" href=\"#druid基本概念\">#</a> Druid 基本概念</h1>\n<h2 id=\"datasource结构\"><a class=\"anchor\" href=\"#datasource结构\">#</a> DataSource 结构</h2>\n<blockquote>\n<p>Druid 在数据摄入之前，首先要定义一个数据源（DataSource, 类似于数据库中表的概念）<br />\nDruid 是一个分布式数据分析平台，也是一个时序数据库</p>\n</blockquote>\n<p>与传统关系型数据库相比，Druid 的 DataSource 可以算是 table，DataSource 的结构包括以下几个方面</p>\n<ul>\n<li><strong>时间列</strong>（TimeStamp）：表明每行数据的时间值，默认只用 UTC 时间格式且精确到毫秒。这个列是数据聚合与范围查询的重要维度</li>\n<li><strong>维度列</strong>（Dimension）：用来表示数据行的各个类别信息</li>\n<li><strong>指标列</strong>（Metric）：用于聚合和计算的列</li>\n</ul>\n<h2 id=\"segment结构\"><a class=\"anchor\" href=\"#segment结构\">#</a> Segment 结构</h2>\n<blockquote>\n<p>DataSource 是逻辑结构，而 Segment 是数据实际存储的物理结构，Druid 通过 Segment 实现对数据的横纵切割操作。</p>\n</blockquote>\n<ul>\n<li><strong>横向切割</strong>：通过设置在 segmentGranularity 参数，Druid 将不同时间范围内的数据存储在不同 Segment 数据块中。</li>\n<li><strong>纵向切割</strong>：在 Segment 中面向列进行数据压缩处理</li>\n</ul>\n<h2 id=\"数据格式定义\"><a class=\"anchor\" href=\"#数据格式定义\">#</a> 数据格式定义</h2>\n<figure class=\"highlight json\"><figcaption data-lang=\"JSON\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token property\">\"dataSchema\"</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span>...<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> #JSON对象，指明数据源格式、数据解析、维度等信息</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token property\">\"ioConfig\"</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span>...<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> #JSON对象，指明数据如何在Druid中存储</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token property\">\"tuningConfig\"</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span>...<span class=\"token punctuation\">&#125;</span> #JSON对象，指明存储优化配置（非必填）</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><strong>DataSchema 详解</strong></p>\n<figure class=\"highlight json\"><figcaption data-lang=\"JSON\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token property\">\"datasource\"</span><span class=\"token operator\">:</span><span class=\"token string\">\"...\"</span><span class=\"token punctuation\">,</span> #string类型，数据源名称</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token property\">\"parser\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token property\">\"type\"</span><span class=\"token operator\">:</span> &lt;><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token property\">\"parseSpec\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>            <span class=\"token property\">\"format\"</span><span class=\"token operator\">:</span> &lt;><span class=\"token punctuation\">,</span> #数据格式，可以是 “json”<span class=\"token punctuation\">,</span> “jsonLowercase”<span class=\"token punctuation\">,</span> “csv”<span class=\"token punctuation\">,</span> “tsv” 几种格式</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>            <span class=\"token property\">\"timestampSpec\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span>#时间戳和时间戳类型\t字段名自动换成__time</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>            <span class=\"token property\">\"dimensionsSpec\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span>#数据的维度（包含哪些列）\t</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> #JSON对象，包含了如何即系数据的相关内容</pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token property\">\"metricsSpec\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>...<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> #list 包含了所有的指标信息</pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token property\">\"granularitySpec\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span>...<span class=\"token punctuation\">&#125;</span> #JSON对象，指明数据的存储和查询力度</pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><strong>granularitySpec 详解</strong></p>\n<figure class=\"highlight json\"><figcaption data-lang=\"JSON\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token property\">\"granularitySpec\"</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token property\">\"type\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"uniform\"</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">//type : 用来指定粒度的类型使用　uniform, arbitrary (尝试创建大小相等的段).</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token property\">\"segmentGranularity\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"day\"</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">//segmentGranularity : 用来确定每个 segment 包含的时间戳范围</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token property\">\"queryGranularity\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"none\"</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// 控制注入数据的粒度。 最小的 queryGranularity 是 millisecond (毫秒级)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token property\">\"rollup\"</span> <span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token property\">\"intervals\"</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"2018-01-09/2018-01-13\"</span><span class=\"token punctuation\">]</span> <span class=\"token comment\">//intervals : 用来确定总的要获取的文件时间戳的范围</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h1 id=\"数据摄入\"><a class=\"anchor\" href=\"#数据摄入\">#</a> 数据摄入</h1>\n<h2 id=\"批处理数据摄入\"><a class=\"anchor\" href=\"#批处理数据摄入\">#</a> 批处理数据摄入</h2>\n<p><strong>准备 json 文件 Pageviews.json</strong></p>\n<figure class=\"highlight json\"><figcaption data-lang=\"JSON\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">&#123;</span><span class=\"token property\">\"time\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"2015-09-01T00:00:00Z\"</span><span class=\"token punctuation\">,</span> <span class=\"token property\">\"url\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"/foo/bar\"</span><span class=\"token punctuation\">,</span> <span class=\"token property\">\"user\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"alice\"</span><span class=\"token punctuation\">,</span> <span class=\"token property\">\"latencyMs\"</span><span class=\"token operator\">:</span> <span class=\"token number\">32</span><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span><span class=\"token property\">\"time\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"2015-09-01T01:00:00Z\"</span><span class=\"token punctuation\">,</span> <span class=\"token property\">\"url\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"/\"</span><span class=\"token punctuation\">,</span> <span class=\"token property\">\"user\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"bob\"</span><span class=\"token punctuation\">,</span> <span class=\"token property\">\"latencyMs\"</span><span class=\"token operator\">:</span> <span class=\"token number\">11</span><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#123;</span><span class=\"token property\">\"time\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"2015-09-01T01:30:00Z\"</span><span class=\"token punctuation\">,</span> <span class=\"token property\">\"url\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"/foo/bar\"</span><span class=\"token punctuation\">,</span> <span class=\"token property\">\"user\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"bob\"</span><span class=\"token punctuation\">,</span> <span class=\"token property\">\"latencyMs\"</span><span class=\"token operator\">:</span> <span class=\"token number\">45</span><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>...</pre></td></tr></table></figure><h3 id=\"本地文件摄入\"><a class=\"anchor\" href=\"#本地文件摄入\">#</a> 本地文件摄入</h3>\n<ul>\n<li>\n<p><strong>准备 pageviews_index_local_json_task.json</strong></p>\n<figure class=\"highlight json\"><figcaption data-lang=\"JSON\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token property\">\"type\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"index\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token property\">\"spec\"</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token property\">\"ioConfig\"</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>      <span class=\"token property\">\"type\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"index\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>      <span class=\"token property\">\"firehose\"</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token property\">\"type\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"local\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token property\">\"baseDir\"</span><span class=\"token operator\">:</span><span class=\"token string\">\"/usr/hdp/3.1.0.0-78/druid/quickstart/mydemo\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token property\">\"filter\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"pageviews2.json\"</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token property\">\"dataSchema\"</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      <span class=\"token property\">\"dataSource\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"pageviews\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      <span class=\"token property\">\"granularitySpec\"</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token property\">\"type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"uniform\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        <span class=\"token property\">\"segmentGranularity\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"day\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        <span class=\"token property\">\"queryGranularity\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"none\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t<span class=\"token property\">\"rollup\"</span><span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        <span class=\"token property\">\"intervals\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"2015-09-01/2015-09-02\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>      <span class=\"token property\">\"parser\"</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        <span class=\"token property\">\"type\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"String\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        <span class=\"token property\">\"parseSpec\"</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>          <span class=\"token property\">\"format\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"json\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>          <span class=\"token property\">\"dimensionsSpec\"</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>            <span class=\"token property\">\"dimensions\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"url\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"user\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>          <span class=\"token property\">\"timestampSpec\"</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>            <span class=\"token property\">\"format\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"auto\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>            <span class=\"token property\">\"column\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"time\"</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>      <span class=\"token property\">\"metricsSpec\"</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>          <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>            <span class=\"token property\">\"name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"count\"</span><span class=\"token punctuation\">,</span> </pre></td></tr><tr><td data-num=\"37\"></td><td><pre>            <span class=\"token property\">\"type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"count\"</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>      <span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>    <span class=\"token property\">\"tuningConfig\"</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>      <span class=\"token property\">\"type\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"index\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>      <span class=\"token property\">\"partitionsSpec\"</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>        <span class=\"token property\">\"type\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"hashed\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>        <span class=\"token property\">\"targetPartitionSize\"</span> <span class=\"token operator\">:</span> <span class=\"token number\">5000000</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>    <span class=\"token property\">\"jobProperties\"</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure></li>\n<li>\n<p><strong>向 overlord 节点在提交任务（发送 post 请求）</strong></p>\n</li>\n</ul>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">curl</span> -X <span class=\"token string\">'POST'</span> -H <span class=\"token string\">'Content-Type:application/json'</span> -d @pageviews_index_local_json_task.json hdp-m-2.data.dc.zjft.com:8090/druid/indexer/v1/task</pre></td></tr></table></figure><ul>\n<li><strong><span class=\"exturl\" data-url=\"aHR0cDovL3huLS1kcnVpZGhkcC1tLTItbGsyOWEyODhmcDZoZHVlLmRhdGEuZGMuempmdC5jb206ODA4MQ==\">访问 druid 首页 hdp-m-2.data.dc.zjft.com:8081</span></strong></li>\n</ul>\n<p><img data-src=\"https://upload.cc/i1/2020/01/13/hAOkSp.png\" alt=\"image-20200113093222493\" /></p>\n<h3 id=\"hadoop-文件摄入\"><a class=\"anchor\" href=\"#hadoop-文件摄入\">#</a> hadoop 文件摄入</h3>\n<ul>\n<li>\n<p><strong>将文件 pageviews.json 上传至 hdfs</strong></p>\n</li>\n<li>\n<p><strong>pageviews_index_hdfs_json_task.json</strong></p>\n</li>\n</ul>\n<figure class=\"highlight json\"><figcaption data-lang=\"JSON\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>cp pageviews_index_local_json_task.json  pageviews_index_hdfs_json_task.json</pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre># 将**pageviews_index_hdfs_json_task.json 中ioConfig替换为</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre> <span class=\"token property\">\"ioConfig\"</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>      <span class=\"token property\">\"type\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"hadoop\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>      <span class=\"token property\">\"inputSpec\"</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token property\">\"type\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"static\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token property\">\"paths\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"hdfs://zijin-datalake:8020/user/druid/quickstart/pageviews.json\"</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>   <span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><ul>\n<li><strong>向 overlord 节点在提交任务（发送 post 请求）</strong></li>\n</ul>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">curl</span> -X <span class=\"token string\">'POST'</span> -H <span class=\"token string\">'Content-Type:application/json'</span> -d @pageviews_index_local_json_task.json hdp-m-2.data.dc.zjft.com:8090/druid/indexer/v1/task</pre></td></tr></table></figure><h3 id=\"csv文件导入\"><a class=\"anchor\" href=\"#csv文件导入\">#</a> CSV 文件导入</h3>\n<blockquote>\n<p>只需要改 &quot;parseSpec&quot;  部分</p>\n<p>​     tyep=“csv”</p>\n<p>​\tcolumns 字段必须和 csv 数据的字段一一对应</p>\n<p>​\t &quot;columns&quot; : [&quot;time&quot;,&quot;url&quot;,&quot;user&quot;,&quot;latencyMs&quot;],</p>\n</blockquote>\n<figure class=\"highlight json\"><figcaption data-lang=\"JSON\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token property\">\"type\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"index\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token property\">\"spec\"</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token property\">\"ioConfig\"</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>      <span class=\"token property\">\"type\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"index\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>      <span class=\"token property\">\"firehose\"</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token property\">\"type\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"local\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token property\">\"baseDir\"</span><span class=\"token operator\">:</span><span class=\"token string\">\"/usr/hdp/3.1.0.0-78/druid/quickstart/mydemo\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token property\">\"filter\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"pageviews.csv,pageviews1.csv\"</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token property\">\"dataSchema\"</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      <span class=\"token property\">\"dataSource\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"pageviews2\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      <span class=\"token property\">\"granularitySpec\"</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token property\">\"type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"uniform\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        <span class=\"token property\">\"segmentGranularity\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"day\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        <span class=\"token property\">\"queryGranularity\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"none\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        <span class=\"token property\">\"intervals\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"2015-09-01/2015-09-02\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>      <span class=\"token property\">\"parser\"</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        <span class=\"token property\">\"type\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"String\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        <span class=\"token property\">\"parseSpec\"</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>          <span class=\"token property\">\"format\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"csv\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t  <span class=\"token property\">\"columns\"</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"time\"</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"url\"</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"user\"</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"latencyMs\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>          <span class=\"token property\">\"dimensionsSpec\"</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>            <span class=\"token property\">\"dimensions\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"url\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"user\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>          <span class=\"token property\">\"timestampSpec\"</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>            <span class=\"token property\">\"format\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"auto\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>            <span class=\"token property\">\"column\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"time\"</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>      <span class=\"token property\">\"metricsSpec\"</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>          <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>            <span class=\"token property\">\"name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"count\"</span><span class=\"token punctuation\">,</span> </pre></td></tr><tr><td data-num=\"37\"></td><td><pre>            <span class=\"token property\">\"type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"count\"</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>          <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>            <span class=\"token property\">\"name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"latencyMs\"</span><span class=\"token punctuation\">,</span> </pre></td></tr><tr><td data-num=\"41\"></td><td><pre>            <span class=\"token property\">\"type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"doubleSum\"</span><span class=\"token punctuation\">,</span> </pre></td></tr><tr><td data-num=\"42\"></td><td><pre>            <span class=\"token property\">\"fieldName\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"latencyMs\"</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>      <span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>    <span class=\"token property\">\"tuningConfig\"</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>      <span class=\"token property\">\"type\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"index\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>      <span class=\"token property\">\"partitionsSpec\"</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>        <span class=\"token property\">\"type\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"hashed\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>        <span class=\"token property\">\"targetPartitionSize\"</span> <span class=\"token operator\">:</span> <span class=\"token number\">5000000</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>    <span class=\"token property\">\"jobProperties\"</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"实时数据摄入\"><a class=\"anchor\" href=\"#实时数据摄入\">#</a> 实时数据摄入</h2>\n<h3 id=\"概述\"><a class=\"anchor\" href=\"#概述\">#</a> 概述</h3>\n<blockquote>\n<p>实时输入摄入：包括 Pull,Push 两种</p>\n</blockquote>\n<ul>\n<li>Pull: 需要启动一个 RealtimeNode 节点，通过不同的 Firehose 摄取不同种类的数据源。</li>\n<li>Push: 需要启动 Tranquility 或是 Kafka 索引服务。通过 HTTP 调用的方式进行数据摄入</li>\n</ul>\n<h3 id=\"pull\"><a class=\"anchor\" href=\"#pull\">#</a> Pull</h3>\n<blockquote>\n<p>由于 Realtime Node 没有提供高可用，可伸缩等特性，对于比较重要的场景推荐使用 Tranquility Server or 或是 Tranquility Kafka 索引服务</p>\n</blockquote>\n<h3 id=\"push\"><a class=\"anchor\" href=\"#push\">#</a> Push</h3>\n<blockquote>\n<p>通过 Tranquility 的数据摄入，可以分为两种方式</p>\n</blockquote>\n<h4 id=\"tranquility-serve\"><a class=\"anchor\" href=\"#tranquility-serve\">#</a> Tranquility Serve</h4>\n<blockquote>\n<p>Tranquility Server：发送方可以通过 Tranquility Server 提供的 HTTP 接口，向 Druid 发送数据。</p>\n</blockquote>\n<p><strong>1、下载</strong>   <span class=\"exturl\" data-url=\"aHR0cDovL3N0YXRpYy5kcnVpZC5pby90cmFucXVpbGl0eS9yZWxlYXNlcy90cmFucXVpbGl0eS1kaXN0cmlidXRpb24tMC44LjAudGd6\">Tranquility</span></p>\n<p><strong>2、 解压</strong> <em>tar -xzf tranquility-distribution-0.8.0.tgz</em></p>\n<p><strong>3、 复制</strong>  sever <em>cp druid/conf-quickstart/tranquility/server.json  server.json</em></p>\n<p><em><strong>server.json</strong></em></p>\n<figure class=\"highlight json\"><figcaption data-lang=\"JSON\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token property\">\"dataSources\"</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token property\">\"metrics\"</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>      <span class=\"token property\">\"spec\"</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token property\">\"dataSchema\"</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>          <span class=\"token property\">\"dataSource\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"metrics\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>          <span class=\"token property\">\"parser\"</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>            <span class=\"token property\">\"type\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"string\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>            <span class=\"token property\">\"parseSpec\"</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>              <span class=\"token property\">\"timestampSpec\"</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>                <span class=\"token property\">\"column\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"timestamp\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>                <span class=\"token property\">\"format\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"auto\"</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>              <span class=\"token property\">\"dimensionsSpec\"</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>                <span class=\"token property\">\"dimensions\"</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>                <span class=\"token property\">\"dimensionExclusions\"</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>                  <span class=\"token string\">\"timestamp\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>                  <span class=\"token string\">\"value\"</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>                <span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>              <span class=\"token property\">\"format\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"json\"</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>          <span class=\"token property\">\"granularitySpec\"</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>            <span class=\"token property\">\"type\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"uniform\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>            <span class=\"token property\">\"segmentGranularity\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"hour\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>            <span class=\"token property\">\"queryGranularity\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"none\"</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>          <span class=\"token property\">\"metricsSpec\"</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>            <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>              <span class=\"token property\">\"type\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"count\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>              <span class=\"token property\">\"name\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"count\"</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>            <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>              <span class=\"token property\">\"name\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"value_sum\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>              <span class=\"token property\">\"type\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"doubleSum\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>              <span class=\"token property\">\"fieldName\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"value\"</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>            <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>              <span class=\"token property\">\"fieldName\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"value\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>              <span class=\"token property\">\"name\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"value_min\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>              <span class=\"token property\">\"type\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"doubleMin\"</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>            <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>              <span class=\"token property\">\"type\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"doubleMax\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>              <span class=\"token property\">\"name\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"value_max\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>              <span class=\"token property\">\"fieldName\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"value\"</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>          <span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>        <span class=\"token property\">\"ioConfig\"</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>          <span class=\"token property\">\"type\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"realtime\"</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>        <span class=\"token property\">\"tuningConfig\"</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>          <span class=\"token property\">\"type\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"realtime\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>          <span class=\"token property\">\"maxRowsInMemory\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"100000\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>          <span class=\"token property\">\"intermediatePersistPeriod\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"PT10M\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>          <span class=\"token property\">\"windowPeriod\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"PT10M\"</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>      <span class=\"token property\">\"properties\"</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>        <span class=\"token property\">\"task.partitions\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"1\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>        <span class=\"token property\">\"task.replicants\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"1\"</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>  <span class=\"token property\">\"properties\"</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>    <span class=\"token property\">\"zookeeper.connect\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"localhost\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>    <span class=\"token property\">\"druid.discovery.curator.path\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"/druid/discovery\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>    <span class=\"token property\">\"druid.selectors.indexing.serviceName\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"druid/overlord\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>    <span class=\"token property\">\"http.port\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"8200\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>    <span class=\"token property\">\"http.threads\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"9\"</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><strong>4、后台启动</strong></p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">nohup</span> bin/tranquility server  -configFile server.json <span class=\"token operator\">></span>start.log <span class=\"token operator\">&amp;</span></pre></td></tr></table></figure><p><strong>访问 Overlord Console (<span class=\"exturl\" data-url=\"aHR0cDovL2hkcC1tLTEuZGF0YS5kYy56amZ0LmNvbTo4MDkwLw==\">http://hdp-m-1.data.dc.zjft.com:8090/</span>)</strong></p>\n<p><img data-src=\"https://upload.cc/i1/2020/01/13/UhRdK3.png\" alt=\"img\" /></p>\n<p><strong>5、发送数据</strong></p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>druid/bin//generate-example-metrics <span class=\"token operator\">|</span> <span class=\"token function\">curl</span> -XPOST -H<span class=\"token string\">'Content-Type: application/json'</span> --data-binary @- http://hdp-m-1.data.dc.zjft.com:8200/v1/post/metrics</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">## 返回数据</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#123;</span><span class=\"token string\">\"result\"</span>:<span class=\"token punctuation\">&#123;</span><span class=\"token string\">\"received\"</span>:25,<span class=\"token string\">\"sent\"</span>:25<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><img data-src=\"https://upload.cc/i1/2020/01/13/ZYkPpg.png\" alt=\"img\" /></p>\n<h4 id=\"tranquility-kafka\"><a class=\"anchor\" href=\"#tranquility-kafka\">#</a> Tranquility Kafka</h4>\n<blockquote>\n<p>Tranquility Kafka：发送发可以先将数据发送到 Kafka,Tranquility Kafka 会根据配置从 Kafka 获取数据，并写到 Druid 中</p>\n</blockquote>\n<p><strong>kafka.json</strong></p>\n<figure class=\"highlight json\"><figcaption data-lang=\"JSON\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token property\">\"dataSources\"</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token property\">\"metrics-kafka\"</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>      <span class=\"token property\">\"spec\"</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token property\">\"dataSchema\"</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>          <span class=\"token property\">\"dataSource\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"metrics\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>          <span class=\"token property\">\"parser\"</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>            <span class=\"token property\">\"type\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"string\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>            <span class=\"token property\">\"parseSpec\"</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>              <span class=\"token property\">\"timestampSpec\"</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>                <span class=\"token property\">\"column\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"timestamp\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>                <span class=\"token property\">\"format\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"auto\"</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>              <span class=\"token property\">\"dimensionsSpec\"</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>                <span class=\"token property\">\"dimensions\"</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>                <span class=\"token property\">\"dimensionExclusions\"</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>                  <span class=\"token string\">\"timestamp\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>                  <span class=\"token string\">\"value\"</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>                <span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>              <span class=\"token property\">\"format\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"json\"</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>          <span class=\"token property\">\"granularitySpec\"</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>            <span class=\"token property\">\"type\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"uniform\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>            <span class=\"token property\">\"segmentGranularity\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"hour\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>            <span class=\"token property\">\"queryGranularity\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"none\"</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>          <span class=\"token property\">\"metricsSpec\"</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>            <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>              <span class=\"token property\">\"type\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"count\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>              <span class=\"token property\">\"name\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"count\"</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>            <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>              <span class=\"token property\">\"name\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"value_sum\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>              <span class=\"token property\">\"type\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"doubleSum\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>              <span class=\"token property\">\"fieldName\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"value\"</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>            <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>              <span class=\"token property\">\"fieldName\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"value\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>              <span class=\"token property\">\"name\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"value_min\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>              <span class=\"token property\">\"type\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"doubleMin\"</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>            <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>              <span class=\"token property\">\"type\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"doubleMax\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>              <span class=\"token property\">\"name\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"value_max\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>              <span class=\"token property\">\"fieldName\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"value\"</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>          <span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>        <span class=\"token property\">\"ioConfig\"</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>          <span class=\"token property\">\"type\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"realtime\"</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>        <span class=\"token property\">\"tuningConfig\"</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>          <span class=\"token property\">\"type\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"realtime\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>          <span class=\"token property\">\"maxRowsInMemory\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"100000\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>          <span class=\"token property\">\"intermediatePersistPeriod\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"PT10M\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>          <span class=\"token property\">\"windowPeriod\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"PT10M\"</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>      <span class=\"token property\">\"properties\"</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>        <span class=\"token property\">\"task.partitions\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"1\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>        <span class=\"token property\">\"task.replicants\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"1\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>        <span class=\"token property\">\"topicPattern\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"metrics\"</span> # 指定主题</pre></td></tr><tr><td data-num=\"65\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>  <span class=\"token property\">\"properties\"</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>    <span class=\"token property\">\"zookeeper.connect\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"hdp-s-1.data.dc.zjft.com:6667\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>    <span class=\"token property\">\"druid.discovery.curator.path\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"/druid/discovery\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>    <span class=\"token property\">\"druid.selectors.indexing.serviceName\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"druid/overlord\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>    <span class=\"token property\">\"commit.periodMillis\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"15000\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>    <span class=\"token property\">\"consumer.numThreads\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"2\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>    <span class=\"token property\">\"kafka.zookeeper.connect\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"hdp-s-1.data.dc.zjft.com:6667\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>    <span class=\"token property\">\"kafka.group.id\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"tranquility-kafka\"</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 复制 kafka.json</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">cp</span> druid/conf-quickstart/tranquility/server.json  kafka.json</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># 运行 服务 就会自动从 kafka 读数据</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token function\">nohup</span> bin/tranquility kafka  -configFile kafka.json  <span class=\"token operator\">&amp;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\">##</span></pre></td></tr></table></figure><p 注：时间戳列采用yyyy-MM-ddTHH:mm:ssZ格式，否则数据无法解析，应该可以配置，但未找到配置点=\"\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mstyle mathcolor=\"red\"></mstyle></mrow><annotation encoding=\"application/x-tex\">\\color{red}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"></span></span></p>\n<h3 id=\"kafka-indexing-service\"><a class=\"anchor\" href=\"#kafka-indexing-service\">#</a> Kafka Indexing Service</h3>\n<p>** 索引服务与实时节点比较: **</p>\n<ul>\n<li>\n<p>在 Druid 重启时，索引服务不会丢数据，但是对于实时节点，如果重启太慢，数据超过了时间窗口以及延时窗口，这部分数据会被丢弃。</p>\n</li>\n<li>\n<p>索引服务实际是在指定时间内处理数据，然后将数据积压，可以配置提交时间，到达提交时间时进行提交。</p>\n</li>\n<li>\n<p>索引服务在 Druid 重启后，不会重读消费过的数据，也就是 offset 不会从 begining 开始，数据不会重叠。</p>\n</li>\n<li>\n<p>索引服务出现在 tranquility 服务之后，实际是对实时节点的一个补充，但是索引服务只在 0.9.1.1 版本之后进行支持</p>\n</li>\n</ul>\n<p><strong>supervisor-kafka-pageviews.json</strong></p>\n<figure class=\"highlight json\"><figcaption data-lang=\"JSON\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>     <span class=\"token property\">\"type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"kafka\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>     <span class=\"token property\">\"dataSchema\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>         <span class=\"token property\">\"dataSource\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"pageviews-kafka4\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>         <span class=\"token property\">\"parser\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>             <span class=\"token property\">\"type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"string\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>             <span class=\"token property\">\"parseSpec\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>                 <span class=\"token property\">\"timestampSpec\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>                     <span class=\"token property\">\"column\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"time\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>                     <span class=\"token property\">\"format\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"auto\"</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>                 <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>                 <span class=\"token property\">\"dimensionsSpec\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>                     <span class=\"token property\">\"dimensions\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre> \t\t     <span class=\"token property\">\"dimensionExclusions\"</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>                       <span class=\"token string\">\"time\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>                       <span class=\"token string\">\"latencyMs\"</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>                      <span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>                 <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t\t</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>                 <span class=\"token property\">\"format\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"json\"</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>             <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>         <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>         <span class=\"token property\">\"granularitySpec\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>             <span class=\"token property\">\"type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"uniform\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>             <span class=\"token property\">\"segmentGranularity\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"hour\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>             <span class=\"token property\">\"queryGranularity\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"none\"</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>         <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>         <span class=\"token property\">\"metricsSpec\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>                 <span class=\"token property\">\"type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"count\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>                 <span class=\"token property\">\"name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"views\"</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>             <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>             <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>                 <span class=\"token property\">\"name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"latencyMs\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>                 <span class=\"token property\">\"type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"doubleSum\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>                 <span class=\"token property\">\"fieldName\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"latencyMs\"</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>             <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>         <span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>     <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>     <span class=\"token property\">\"ioConfig\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>         <span class=\"token property\">\"topic\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"pageviews1\"</span><span class=\"token punctuation\">,</span> </pre></td></tr><tr><td data-num=\"41\"></td><td><pre>         <span class=\"token property\">\"consumerProperties\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>             <span class=\"token property\">\"bootstrap.servers\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"hdp-s-1.data.dc.zjft.com:6667,hdp-s-2.data.dc.zjft.com:6667,hdp-s-3.data.dc.zjft.com:6667\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>             <span class=\"token property\">\"group.id\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"pageviews-indexing-service\"</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>         <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>\t <span class=\"token property\">\"useEarliestOffset\"</span><span class=\"token operator\">:</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>         <span class=\"token property\">\"taskCount\"</span><span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>         <span class=\"token property\">\"replicas\"</span><span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>         <span class=\"token property\">\"taskDuration\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"PT1H\"</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>     <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>     <span class=\"token property\">\"tuningConfig\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>         <span class=\"token property\">\"type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"kafka\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>         <span class=\"token property\">\"maxRowsInMemory\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"100000\"</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>     <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre> <span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><strong>运行</strong></p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">curl</span> -X POST -H <span class=\"token string\">'Content-Type: application/json'</span> -d @supervisor-kafka-pageviews.json hdp-m-2.data.dc.zjft.com:8090/druid/indexer/v1/supervisor</pre></td></tr></table></figure><p><strong>访问 Overlord Console (<span class=\"exturl\" data-url=\"aHR0cDovL2hkcC1tLTEuZGF0YS5kYy56amZ0LmNvbTo4MDkwLw==\">http://hdp-m-1.data.dc.zjft.com:8090/</span>)</strong></p>\n<p><img data-src=\"https://upload.cc/i1/2020/01/13/Gm4Tj8.png\" alt=\"img\" /></p>\n<p><strong>点击 starus 查看 状态</strong></p>\n<p><img data-src=\"https://upload.cc/i1/2020/01/13/oREi5x.png\" alt=\"img\" /></p>\n<p><strong>向 Kafka 发送几条数据</strong></p>\n<figure class=\"highlight json\"><figcaption data-lang=\"JSON\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">&#123;</span><span class=\"token property\">\"time\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"2020-01-13T10:07:04Z\"</span><span class=\"token punctuation\">,</span> <span class=\"token property\">\"url\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"/foo/fa/info\"</span><span class=\"token punctuation\">,</span> <span class=\"token property\">\"user\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"luzp\"</span><span class=\"token punctuation\">,</span> <span class=\"token property\">\"latencyMs\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"70\"</span><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span><span class=\"token property\">\"time\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"2020-01-12T10:06:04Z\"</span><span class=\"token punctuation\">,</span> <span class=\"token property\">\"url\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"/foo/bar/info\"</span><span class=\"token punctuation\">,</span> <span class=\"token property\">\"user\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"xzy\"</span><span class=\"token punctuation\">,</span> <span class=\"token property\">\"latencyMs\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"80\"</span><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#123;</span><span class=\"token property\">\"time\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"2020-01-12T10:05:04Z\"</span><span class=\"token punctuation\">,</span> <span class=\"token property\">\"url\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"/foo/bar/user\"</span><span class=\"token punctuation\">,</span> <span class=\"token property\">\"user\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"wwj\"</span><span class=\"token punctuation\">,</span> <span class=\"token property\">\"latencyMs\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"160\"</span><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><strong>消费者偏移量 将发生改变</strong></p>\n<p><img data-src=\"https://upload.cc/i1/2020/01/13/MOZHSs.png\" alt=\"img\" /></p>\n<p><strong>通过 superset 查询</strong></p>\n<p><img data-src=\"https://upload.cc/i1/2020/01/13/Y8isoI.png\" alt=\"image\" /></p>\n<p><strong>访问 druid 首页（<span class=\"exturl\" data-url=\"aHR0cDovL2hkcC1tLTIuZGF0YS5kYy56amZ0LmNvbTo4MDgxLyVFRiVCQyU4OSVFNSU4RiVBRiVFNCVCQiVBNSVFNiU5RiVBNSVFNyU5QyU4QnNlZ21lbnQ=\">http://hdp-m-2.data.dc.zjft.com:8081/）可以查看 segment</span> 粒度为小时</strong></p>\n<p><img data-src=\"https://upload.cc/i1/2020/01/13/GUNVwY.png\" alt=\"img\" /></p>\n<h1 id=\"查询\"><a class=\"anchor\" href=\"#查询\">#</a> 查询</h1>\n<h2 id=\"查询方式\"><a class=\"anchor\" href=\"#查询方式\">#</a> 查询方式</h2>\n<blockquote>\n<p>​        使用 HTTP REST 样式请求对可查询节点（<span class=\"exturl\" data-url=\"aHR0cDovL2RydWlkLmlvL2RvY3MvMC4xMi4xL2Rlc2lnbi9icm9rZXIuaHRtbA==\">Broker</span>， <span class=\"exturl\" data-url=\"aHR0cDovL2RydWlkLmlvL2RvY3MvMC4xMi4xL2Rlc2lnbi9oaXN0b3JpY2FsLmh0bWw=\">Historical</span> 或<span class=\"exturl\" data-url=\"aHR0cDovL2RydWlkLmlvL2RvY3MvMC4xMi4xL2Rlc2lnbi9yZWFsdGltZS5odG1s\"> Realtime</span>）进行查询。该查询以 JSON 表示，并且这些节点类型中的每一个都公开相同的 REST 查询接口</p>\n</blockquote>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">curl</span> -X POST <span class=\"token string\">'hdp-m-2.data.dc.zjft.com:8082>/druid/v2/?pretty'</span> -H <span class=\"token string\">'Content-Type:application/json'</span> -d @<span class=\"token operator\">&lt;</span>query_json_file<span class=\"token operator\">></span></pre></td></tr></table></figure><p><strong>可用查询</strong></p>\n<p>​        对于各种用例，Druid 具有许多查询类型。查询由各种 JSON 属性组成，Druid 针对不同用例具有不同类型的查询。各种查询类型的文档描述了所有可以设置的 JSON 属性。</p>\n<h2 id=\"常用查询组件\"><a class=\"anchor\" href=\"#常用查询组件\">#</a> 常用查询组件</h2>\n<h3 id=\"components\"><a class=\"anchor\" href=\"#components\">#</a> <span class=\"exturl\" data-url=\"aHR0cDovL2RydWlkLmlvL2RvY3MvMC4xMi4xL3R1dG9yaWFscy90dXRvcmlhbC1iYXRjaC5odG1s\">Components</span></h3>\n<h4 id=\"datasource\"><a class=\"anchor\" href=\"#datasource\">#</a> Datasource</h4>\n<ul>\n<li><strong>datasource</strong>：</li>\n</ul>\n<blockquote>\n<p>一个数据源等价于 druid 表。此外，一个查询也可以作为数据源，提供类似于子查询的功能。查询数据源目前只支持 GroupBy 查询</p>\n</blockquote>\n<figure class=\"highlight json\"><figcaption data-lang=\"JSON\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token property\">\"queryType\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"scan\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token property\">\"dataSource\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token property\">\"type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"table\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token property\">\"name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"wikiticker\"</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token property\">\"resultFormat\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"list\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token property\">\"intervals\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"1901-01-01T00:00:00+00:00/2101-01-01T00:00:00+00:00\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token property\">\"columns\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token string\">\"page\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token string\">\"countryName\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token string\">\"cityName\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token string\">\"countryIsoCode\"</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  <span class=\"token property\">\"limit\"</span><span class=\"token operator\">:</span> <span class=\"token number\">5</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><ul>\n<li><strong>Union Data Source</strong></li>\n</ul>\n<blockquote>\n<p>联合数据源中的数据源必须拥有相同的 schema。联合查询只能被发送给 broker/router 节点，不支持直接发送到历史节点</p>\n</blockquote>\n<figure class=\"highlight json\"><figcaption data-lang=\"JSON\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>   <span class=\"token property\">\"type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"union\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>   <span class=\"token property\">\"dataSources\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"&lt;string_value1>\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"&lt;string_value2>\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"&lt;string_value3>\"</span><span class=\"token punctuation\">,</span> ... <span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><ul>\n<li><strong>查询</strong></li>\n</ul>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">curl</span> -XPOST -H<span class=\"token string\">'Content-Type: application/json'</span> http://hdp-m-2.data.dc.zjft.com:8082/druid/v2/?pretty -d @query.json</pre></td></tr></table></figure><p><em><strong>返回结果</strong></em></p>\n<figure class=\"highlight json\"><figcaption data-lang=\"JSON\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token property\">\"segmentId\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"wikiticker_2015-09-12T00:00:00.000Z_2015-09-13T00:00:00.000Z_2020-01-07T01:42:03.953Z\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token property\">\"columns\"</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span> <span class=\"token string\">\"page\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"countryName\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"cityName\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"countryIsoCode\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"count\"</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token property\">\"events\"</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token property\">\"page\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"Talk:Oswald Tilghman\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token property\">\"countryName\"</span> <span class=\"token operator\">:</span> <span class=\"token null keyword\">null</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token property\">\"cityName\"</span> <span class=\"token operator\">:</span> <span class=\"token null keyword\">null</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token property\">\"countryIsoCode\"</span> <span class=\"token operator\">:</span> <span class=\"token null keyword\">null</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token property\">\"count\"</span> <span class=\"token operator\">:</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token property\">\"page\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"Rallicula\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token property\">\"countryName\"</span> <span class=\"token operator\">:</span> <span class=\"token null keyword\">null</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token property\">\"cityName\"</span> <span class=\"token operator\">:</span> <span class=\"token null keyword\">null</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token property\">\"countryIsoCode\"</span> <span class=\"token operator\">:</span> <span class=\"token null keyword\">null</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token property\">\"count\"</span> <span class=\"token operator\">:</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token property\">\"page\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"Peremptory norm\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token property\">\"countryName\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"Australia\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token property\">\"cityName\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"Auburn\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token property\">\"countryIsoCode\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"AU\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token property\">\"count\"</span> <span class=\"token operator\">:</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token property\">\"page\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"Apamea abruzzorum\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    <span class=\"token property\">\"countryName\"</span> <span class=\"token operator\">:</span> <span class=\"token null keyword\">null</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token property\">\"cityName\"</span> <span class=\"token operator\">:</span> <span class=\"token null keyword\">null</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    <span class=\"token property\">\"countryIsoCode\"</span> <span class=\"token operator\">:</span> <span class=\"token null keyword\">null</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    <span class=\"token property\">\"count\"</span> <span class=\"token operator\">:</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    <span class=\"token property\">\"page\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"Atractus flammigerus\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    <span class=\"token property\">\"countryName\"</span> <span class=\"token operator\">:</span> <span class=\"token null keyword\">null</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    <span class=\"token property\">\"cityName\"</span> <span class=\"token operator\">:</span> <span class=\"token null keyword\">null</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    <span class=\"token property\">\"countryIsoCode\"</span> <span class=\"token operator\">:</span> <span class=\"token null keyword\">null</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    <span class=\"token property\">\"count\"</span> <span class=\"token operator\">:</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span> <span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token punctuation\">&#125;</span> <span class=\"token punctuation\">]</span></pre></td></tr></table></figure><h4 id=\"filters\"><a class=\"anchor\" href=\"#filters\">#</a> <span class=\"exturl\" data-url=\"aHR0cDovL2RydWlkLmlvL2RvY3MvMC4xMi4xL3F1ZXJ5aW5nL2ZpbHRlcnMuaHRtbA==\">Filters</span></h4>\n<ul>\n<li>\n<p><strong>Selector filter</strong></p>\n<blockquote>\n<p>等价于 sql 的 `where countryIsoCode = 'US'</p>\n</blockquote>\n<figure class=\"highlight json\"><figcaption data-lang=\"JSON\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>      <span class=\"token property\">\"queryType\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"scan\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>      <span class=\"token property\">\"dataSource\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token property\">\"type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"table\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token property\">\"name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"wikiticker\"</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>      <span class=\"token property\">\"filter\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token property\">\"type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"selector\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token property\">\"dimension\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"countryIsoCode\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token property\">\"value\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"US\"</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      <span class=\"token property\">\"resultFormat\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"list\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      <span class=\"token property\">\"columns\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        <span class=\"token string\">\"page\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token string\">\"countryName\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        <span class=\"token string\">\"cityName\"</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      <span class=\"token property\">\"intervals\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        <span class=\"token string\">\"1901-01-01T00:00:00+00:00/2101-01-01T00:00:00+00:00\"</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>      <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>      <span class=\"token property\">\"limit\"</span><span class=\"token operator\">:</span> <span class=\"token number\">5</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure></li>\n<li>\n<p><strong>Column Comparison filter</strong></p>\n<blockquote>\n<p>等价于 sql 的 <code>where countryName = cityName</code></p>\n</blockquote>\n<figure class=\"highlight json\"><figcaption data-lang=\"JSON\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token property\">\"queryType\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"scan\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token property\">\"dataSource\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token property\">\"type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"table\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token property\">\"name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"wikiticker\"</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token property\">\"filter\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token property\">\"type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"columnComparison\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token property\">\"dimensions\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>      <span class=\"token string\">\"countryName\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      <span class=\"token string\">\"cityName\"</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  <span class=\"token property\">\"resultFormat\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"list\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  <span class=\"token property\">\"columns\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token string\">\"page\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token string\">\"countryName\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token string\">\"cityName\"</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  <span class=\"token property\">\"intervals\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>     <span class=\"token string\">\"1901-01-01T00:00:00+00:00/2101-01-01T00:00:00+00:00\"</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>  <span class=\"token property\">\"limit\"</span><span class=\"token operator\">:</span> <span class=\"token number\">5</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure></li>\n<li>\n<p><strong>Regular expression filter</strong></p>\n<blockquote>\n<p>正则表达式，支持标准的 java 正则表达式，下面的查询表示 countryIsoCode 以 U 开头</p>\n</blockquote>\n<figure class=\"highlight json\"><figcaption data-lang=\"JSON\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token property\">\"queryType\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"scan\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token property\">\"dataSource\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token property\">\"type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"table\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token property\">\"name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"wikiticker\"</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token property\">\"filter\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token property\">\"type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"regex\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token property\">\"dimension\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"countryIsoCode\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token property\">\"pattern\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"^U\"</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  <span class=\"token property\">\"resultFormat\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"list\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  <span class=\"token property\">\"columns\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token string\">\"page\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token string\">\"countryName\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token string\">\"cityName\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token string\">\"countryIsoCode\"</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  <span class=\"token property\">\"intervals\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>     <span class=\"token string\">\"1901-01-01T00:00:00+00:00/2101-01-01T00:00:00+00:00\"</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  <span class=\"token property\">\"limit\"</span><span class=\"token operator\">:</span> <span class=\"token number\">5</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure></li>\n<li>\n<p><strong>Logical expression filters</strong></p>\n<blockquote>\n<p>支持 and or not，下面的等价于  <code>where countryIsoCode = 'US' and cityName = 'New York'</code></p>\n</blockquote>\n<figure class=\"highlight json\"><figcaption data-lang=\"JSON\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>      <span class=\"token property\">\"queryType\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"scan\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>      <span class=\"token property\">\"dataSource\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token property\">\"type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"table\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token property\">\"name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"wikiticker\"</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>      <span class=\"token property\">\"filter\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token property\">\"type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"and\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token property\">\"fields\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>          <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>            <span class=\"token property\">\"type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"selector\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>            <span class=\"token property\">\"dimension\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"countryIsoCode\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>            <span class=\"token property\">\"value\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"US\"</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>          <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>            <span class=\"token property\">\"type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"selector\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>            <span class=\"token property\">\"dimension\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"cityName\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>            <span class=\"token property\">\"value\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"New York\"</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        <span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>      <span class=\"token property\">\"resultFormat\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"list\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>      <span class=\"token property\">\"columns\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        <span class=\"token string\">\"page\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        <span class=\"token string\">\"countryName\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        <span class=\"token string\">\"cityName\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        <span class=\"token string\">\"countryIsoCode\"</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>      <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>      <span class=\"token property\">\"intervals\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>       <span class=\"token string\">\"1901-01-01T00:00:00+00:00/2101-01-01T00:00:00+00:00\"</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>      <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>      <span class=\"token property\">\"limit\"</span><span class=\"token operator\">:</span> <span class=\"token number\">5</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure></li>\n<li>\n<p><strong>JavaScript filter</strong></p>\n<figure class=\"highlight json\"><figcaption data-lang=\"JSON\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token property\">\"filter\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token property\">\"type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"javascript\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token property\">\"dimension\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"countryIsoCode\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token property\">\"function\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"function(value) &#123; return (value == 'US' || value == 'CN') &#125;\"</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure></li>\n<li>\n<p><strong>Search filter</strong></p>\n<blockquote>\n<p>用于部分字符串匹配，如下面的表示包含 foo，并且对大小写不敏感</p>\n</blockquote>\n<figure class=\"highlight json\"><figcaption data-lang=\"JSON\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token property\">\"filter\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token property\">\"type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"search\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token property\">\"dimension\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"product\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token property\">\"query\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>      <span class=\"token property\">\"type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"insensitive_contains\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>      <span class=\"token property\">\"value\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"foo\"</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure></li>\n<li>\n<p><strong>In filter</strong></p>\n<blockquote>\n<p>等价于 <code>where countryIsoCode in ('US', 'CN')</code></p>\n</blockquote>\n<figure class=\"highlight json\"><figcaption data-lang=\"JSON\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token property\">\"filter\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token property\">\"type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"in\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token property\">\"dimension\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"countryIsoCode\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token property\">\"values\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"US\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"CN\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure></li>\n<li>\n<p><strong>Like  filter</strong></p>\n<blockquote>\n<p>等价于 <code>where countryIsoCode like '%U'</code></p>\n</blockquote>\n<figure class=\"highlight json\"><figcaption data-lang=\"JSON\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token property\">\"filter\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token property\">\"type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"like\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token property\">\"dimension\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"countryIsoCode\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token property\">\"pattern\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"%U\"</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure></li>\n<li>\n<p><strong>Bourd filter</strong></p>\n<blockquote>\n<p>等价于  <code>&quot;CN&quot; &lt; countryIsoCode &lt; &quot;US&quot;</code></p>\n</blockquote>\n<figure class=\"highlight json\"><figcaption data-lang=\"JSON\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token property\">\"filter\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token property\">\"type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"bound\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token property\">\"dimension\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"countryIsoCode\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token property\">\"lower\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"CN\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token property\">\"lowerStrict\"</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token property\">\"upper\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"US\"</span> <span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token property\">\"ordering\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"numeric\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token property\">\"upperStrict\"</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token property\">\"ordering\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"lexicographic\"</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure></li>\n</ul>\n<h4 id=\"aggregations\"><a class=\"anchor\" href=\"#aggregations\">#</a> <span class=\"exturl\" data-url=\"aHR0cDovL2RydWlkLmlvL2RvY3MvMC4xMi4xL3F1ZXJ5aW5nL2FnZ3JlZ2F0aW9ucy5odG1s\">Aggregations</span></h4>\n<ul>\n<li>\n<p><strong>Count aggregator</strong></p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  page<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> num</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">from</span> wikiticker</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">where</span> <span class=\"token string\">\"__time\"</span> <span class=\"token operator\">BETWEEN</span> <span class=\"token keyword\">TIMESTAMP</span> <span class=\"token string\">'2016-06-27 00:00:00'</span> <span class=\"token operator\">AND</span> <span class=\"token keyword\">TIMESTAMP</span> <span class=\"token string\">'2016-06-28 00:00:00'</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> page</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> num <span class=\"token keyword\">desc</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">limit</span> <span class=\"token number\">5</span></pre></td></tr></table></figure><figure class=\"highlight json\"><figcaption data-lang=\"JSON\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token property\">\"queryType\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"topN\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token property\">\"dataSource\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"wikiticker\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token property\">\"dimension\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"page\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token property\">\"threshold\"</span><span class=\"token operator\">:</span> <span class=\"token number\">5</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token property\">\"metric\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"num\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token property\">\"granularity\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"all\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token property\">\"aggregations\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>      <span class=\"token property\">\"type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"count\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      <span class=\"token property\">\"name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"num\"</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  <span class=\"token property\">\"intervals\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token string\">\"2016-06-27/2016-06-28\"</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  <span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure></li>\n<li>\n<p><strong>Sum aggregator</strong></p>\n<blockquote>\n<p>longSum、doubleSum、floatSum</p>\n</blockquote>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    page<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token function\">sum</span><span class=\"token punctuation\">(</span>delta<span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> num</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">from</span> wikiticker</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">where</span> <span class=\"token string\">\"__time\"</span> <span class=\"token operator\">BETWEEN</span> <span class=\"token keyword\">TIMESTAMP</span> <span class=\"token string\">'2016-06-27 00:00:00'</span> <span class=\"token operator\">AND</span> <span class=\"token keyword\">TIMESTAMP</span> <span class=\"token string\">'2016-06-28 00:00:00'</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> page</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> page <span class=\"token keyword\">asc</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">limit</span> <span class=\"token number\">5</span></pre></td></tr></table></figure><figure class=\"highlight json\"><figcaption data-lang=\"JSON\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token property\">\"queryType\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"topN\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token property\">\"dataSource\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"wikiticker\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token property\">\"dimension\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"page\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token property\">\"threshold\"</span><span class=\"token operator\">:</span> <span class=\"token number\">5</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token property\">\"metric\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"num\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token property\">\"granularity\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"all\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token property\">\"aggregations\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>      <span class=\"token property\">\"type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"longSum\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      <span class=\"token property\">\"name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"num\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      <span class=\"token property\">\"fieldName\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"delta\"</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  <span class=\"token property\">\"intervals\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token string\">\"2016-06-27/2016-06-28\"</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  <span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure></li>\n<li>\n<p><strong>Min / Max aggregators</strong></p>\n<blockquote>\n<p>doubleMin、doubleMax、floatMin、floatMax、longMin、longMax</p>\n</blockquote>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    page<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token function\">max</span><span class=\"token punctuation\">(</span>delta<span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> num</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">from</span> wikiticker</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">where</span> <span class=\"token string\">\"__time\"</span> <span class=\"token operator\">BETWEEN</span> <span class=\"token keyword\">TIMESTAMP</span> <span class=\"token string\">'2016-06-27 00:00:00'</span> <span class=\"token operator\">AND</span> <span class=\"token keyword\">TIMESTAMP</span> <span class=\"token string\">'2016-06-28 00:00:00'</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> page</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> page <span class=\"token keyword\">asc</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">limit</span> <span class=\"token number\">5</span></pre></td></tr></table></figure><figure class=\"highlight json\"><figcaption data-lang=\"JSON\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token property\">\"queryType\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"topN\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token property\">\"dataSource\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"wikiticker\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token property\">\"dimension\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"page\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token property\">\"threshold\"</span><span class=\"token operator\">:</span> <span class=\"token number\">5</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token property\">\"metric\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"num\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token property\">\"granularity\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"all\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token property\">\"aggregations\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>      <span class=\"token property\">\"type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"longMax\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      <span class=\"token property\">\"name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"num\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      <span class=\"token property\">\"fieldName\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"delta\"</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  <span class=\"token property\">\"intervals\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token string\">\"2016-06-27/2016-06-28\"</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  <span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure></li>\n<li>\n<p><strong><span class=\"exturl\" data-url=\"aHR0cDovL2RydWlkLmlvL2RvY3MvMC4xMS4wL3F1ZXJ5aW5nL2FnZ3JlZ2F0aW9ucy5odG1sP3NwbT1hMmM0Zy4xMTE4NjYyMy4yLjExLjNiMzA0NWE3M3F3NjVT\">更多聚合</span></strong></p>\n</li>\n</ul>\n<h3 id=\"timeseries\"><a class=\"anchor\" href=\"#timeseries\">#</a> <span class=\"exturl\" data-url=\"aHR0cDovL2RydWlkLmlvL2RvY3MvMC4xMi4xL3F1ZXJ5aW5nL3RpbWVzZXJpZXNxdWVyeS5odG1s\">Timeseries</span></h3>\n<blockquote>\n<p>统计一段时间内的汇总数据</p>\n</blockquote>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">SELECT</span> <span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> num<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">sum</span><span class=\"token punctuation\">(</span>added<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">FROM</span> wikiticker</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">WHERE</span> <span class=\"token string\">\"__time\"</span> <span class=\"token operator\">BETWEEN</span> <span class=\"token keyword\">TIMESTAMP</span> <span class=\"token string\">'2016-06-27 00:00:00'</span> <span class=\"token operator\">AND</span> <span class=\"token keyword\">TIMESTAMP</span> <span class=\"token string\">'2016-06-27 23:59:59'</span></pre></td></tr></table></figure><figure class=\"highlight json\"><figcaption data-lang=\"JSON\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token property\">\"queryType\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"timeseries\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token property\">\"dataSource\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"wikiticker\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token property\">\"granularity\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"all\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token property\">\"aggregations\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span> <span class=\"token property\">\"type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"count\"</span><span class=\"token punctuation\">,</span> <span class=\"token property\">\"name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"count\"</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span> <span class=\"token property\">\"type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"longSum\"</span><span class=\"token punctuation\">,</span> <span class=\"token property\">\"name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"added\"</span><span class=\"token punctuation\">,</span> <span class=\"token property\">\"fieldName\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"added\"</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token property\">\"intervals\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span> <span class=\"token string\">\"2016-06-27/2016-06-28\"</span> <span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h3 id=\"topn\"><a class=\"anchor\" href=\"#topn\">#</a> <span class=\"exturl\" data-url=\"aHR0cDovL2RydWlkLmlvL2RvY3MvMC4xMi4xL3F1ZXJ5aW5nL3RvcG5xdWVyeS5odG1s\">TopN</span></h3>\n<blockquote>\n<p>返回前 N 条数据，并可以按照 metric 排序，可以支持维度，但只有一个</p>\n</blockquote>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">SELECT</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    page<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token function\">sum</span><span class=\"token punctuation\">(</span>added<span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> num</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">FROM</span> wikiticker</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">WHERE</span> <span class=\"token string\">\"__time\"</span> <span class=\"token operator\">BETWEEN</span> <span class=\"token keyword\">TIMESTAMP</span> <span class=\"token string\">'2016-06-27 00:00:00'</span> <span class=\"token operator\">AND</span> <span class=\"token keyword\">TIMESTAMP</span> <span class=\"token string\">'2016-06-27 23:59:59'</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> page</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> num <span class=\"token keyword\">desc</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">limit</span> <span class=\"token number\">5</span></pre></td></tr></table></figure><figure class=\"highlight json\"><figcaption data-lang=\"JSON\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token property\">\"queryType\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"topN\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token property\">\"dataSource\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"wikiticker\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token property\">\"dimension\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"page\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token property\">\"threshold\"</span><span class=\"token operator\">:</span> <span class=\"token number\">5</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token property\">\"metric\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"added\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token property\">\"granularity\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"all\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token property\">\"aggregations\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>      <span class=\"token property\">\"type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"doubleSum\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      <span class=\"token property\">\"name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"added\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      <span class=\"token property\">\"fieldName\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"added\"</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  <span class=\"token property\">\"intervals\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span> <span class=\"token string\">\"2016-06-27/2016-06-28\"</span> <span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h3 id=\"groupby\"><a class=\"anchor\" href=\"#groupby\">#</a> <span class=\"exturl\" data-url=\"aHR0cDovL2RydWlkLmlvL2RvY3MvMC4xMi4xL3F1ZXJ5aW5nL2dyb3VwYnlxdWVyeS5odG1s\">GroupBy</span></h3>\n<blockquote>\n<p>能对指定的多个维度分组，也支持对指定的维度排序，也支持 limit，但是性能比 TopN 和 Timeseries 要差很多</p>\n</blockquote>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">SELECT</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    page<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    countryName<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token function\">sum</span><span class=\"token punctuation\">(</span>added<span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> num<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token function\">sum</span><span class=\"token punctuation\">(</span>delta<span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> num2</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">FROM</span> wikiticker</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">WHERE</span> <span class=\"token string\">\"__time\"</span> <span class=\"token operator\">BETWEEN</span> <span class=\"token keyword\">TIMESTAMP</span> <span class=\"token string\">'2016-06-27 00:00:00'</span> <span class=\"token operator\">AND</span> <span class=\"token keyword\">TIMESTAMP</span> <span class=\"token string\">'2016-06-27 23:59:59'</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> page<span class=\"token punctuation\">,</span>countryName</pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> num <span class=\"token keyword\">desc</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token keyword\">limit</span> <span class=\"token number\">5</span></pre></td></tr></table></figure><figure class=\"highlight json\"><figcaption data-lang=\"JSON\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token property\">\"queryType\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"groupBy\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token property\">\"dataSource\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"wikiticker\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token property\">\"granularity\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"all\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token property\">\"dimensions\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token string\">\"page\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token string\">\"countryName\"</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token property\">\"limitSpec\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token property\">\"type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"default\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token property\">\"limit\"</span><span class=\"token operator\">:</span> <span class=\"token number\">5</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token property\">\"columns\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        <span class=\"token property\">\"dimension\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"added\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token property\">\"direction\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"descending\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        <span class=\"token property\">\"dimensionOrder\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>          <span class=\"token property\">\"type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"numeric\"</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  <span class=\"token property\">\"aggregations\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>      <span class=\"token property\">\"type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"longSum\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>      <span class=\"token property\">\"name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"added\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>      <span class=\"token property\">\"fieldName\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"added\"</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>      <span class=\"token property\">\"type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"longSum\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>      <span class=\"token property\">\"name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"delta\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>      <span class=\"token property\">\"fieldName\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"delta\"</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>  <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>  <span class=\"token property\">\"intervals\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>    <span class=\"token string\">\"2016-06-27/2016-06-28\"</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>  <span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h3 id=\"search\"><a class=\"anchor\" href=\"#search\">#</a> <span class=\"exturl\" data-url=\"aHR0cDovL2RydWlkLmlvL2RvY3MvMC4xMi4xL3F1ZXJ5aW5nL3NlYXJjaHF1ZXJ5Lmh0bWw=\">Search</span></h3>\n<blockquote>\n<p>类似于 like 操作，可以查询多个维度列，不支持聚合</p>\n</blockquote>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">SELECT</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>\tpage<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\tcountryName</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">FROM</span> wikipedia</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">WHERE</span> <span class=\"token string\">\"__time\"</span> <span class=\"token operator\">BETWEEN</span> <span class=\"token keyword\">TIMESTAMP</span> <span class=\"token string\">'2016-06-27 00:00:00'</span> <span class=\"token operator\">AND</span> <span class=\"token keyword\">TIMESTAMP</span> <span class=\"token string\">'2016-06-27 23:59:59'</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token operator\">and</span> page <span class=\"token operator\">like</span> <span class=\"token string\">'%C'</span> <span class=\"token operator\">or</span> countryName <span class=\"token operator\">like</span> <span class=\"token string\">'%C'</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">limit</span> <span class=\"token number\">5</span></pre></td></tr></table></figure><figure class=\"highlight json\"><figcaption data-lang=\"JSON\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token property\">\"queryType\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"search\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token property\">\"dataSource\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"wikipedia3\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token property\">\"granularity\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"all\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token property\">\"dimensions\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token string\">\"page\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token string\">\"countryName\"</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token property\">\"query\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token property\">\"type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"insensitive_contains\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token property\">\"value\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"C\"</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  <span class=\"token property\">\"sort\"</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token property\">\"type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"lexicographic\"</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  <span class=\"token property\">\"limit\"</span><span class=\"token operator\">:</span> <span class=\"token number\">5</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  <span class=\"token property\">\"intervals\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token string\">\"2016-06-27/2016-06-28\"</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  <span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h3 id=\"select\"><a class=\"anchor\" href=\"#select\">#</a> <span class=\"exturl\" data-url=\"aHR0cDovL2RydWlkLmlvL2RvY3MvMC4xMi4xL3F1ZXJ5aW5nL3NlbGVjdC1xdWVyeS5odG1s\">Select</span></h3>\n<blockquote>\n<p>查数据，不支持聚合，但支持分页，排序</p>\n</blockquote>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">SELECT</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token operator\">*</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">FROM</span> wikipedia</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">WHERE</span> <span class=\"token string\">\"__time\"</span> <span class=\"token operator\">BETWEEN</span> <span class=\"token keyword\">TIMESTAMP</span> <span class=\"token string\">'2016-06-27 00:00:00'</span> <span class=\"token operator\">AND</span> <span class=\"token keyword\">TIMESTAMP</span> <span class=\"token string\">'2016-06-27 23:59:59'</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">limit</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token number\">5</span></pre></td></tr></table></figure><figure class=\"highlight json\"><figcaption data-lang=\"JSON\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token property\">\"queryType\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"select\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token property\">\"dataSource\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"wikipedia3\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token property\">\"granularity\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"all\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token property\">\"dimensions\"</span><span class=\"token operator\">:</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token property\">\"metrics\"</span><span class=\"token operator\">:</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token property\">\"pagingSpec\"</span><span class=\"token operator\">:</span><span class=\"token punctuation\">&#123;</span><span class=\"token property\">\"pagingIdentifiers\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> <span class=\"token property\">\"threshold\"</span><span class=\"token operator\">:</span><span class=\"token number\">5</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token property\">\"intervals\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token string\">\"2016-06-27/2016-06-28\"</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h3 id=\"scan\"><a class=\"anchor\" href=\"#scan\">#</a> <span class=\"exturl\" data-url=\"aHR0cDovL2RydWlkLmlvL2RvY3MvMC4xMi4xL3F1ZXJ5aW5nL3NjYW4tcXVlcnkuaHRtbA==\">Scan</span></h3>\n<blockquote>\n<p>类似于 Select，但不支持分页，但是如果没有分页需求，推荐使用这个，性能比 Select 好</p>\n</blockquote>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">SELECT</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>page<span class=\"token punctuation\">,</span>countryName</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">FROM</span> wikipedia</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">WHERE</span> <span class=\"token string\">\"__time\"</span> <span class=\"token operator\">BETWEEN</span> <span class=\"token keyword\">TIMESTAMP</span> <span class=\"token string\">'2016-06-27 00:00:00'</span> <span class=\"token operator\">AND</span> <span class=\"token keyword\">TIMESTAMP</span> <span class=\"token string\">'2016-06-27 23:59:59'</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">limit</span> <span class=\"token number\">5</span></pre></td></tr></table></figure><figure class=\"highlight json\"><figcaption data-lang=\"JSON\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>   <span class=\"token property\">\"queryType\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"scan\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>   <span class=\"token property\">\"dataSource\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"wikipedia3\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>   <span class=\"token property\">\"resultFormat\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"list\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>   <span class=\"token property\">\"columns\"</span><span class=\"token operator\">:</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"page\"</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"countryName\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>   <span class=\"token property\">\"intervals\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>     <span class=\"token string\">\"2016-06-27/2016-06-28\"</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>   <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>   <span class=\"token property\">\"batchSize\"</span><span class=\"token operator\">:</span><span class=\"token number\">20480</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>   <span class=\"token property\">\"limit\"</span><span class=\"token operator\">:</span><span class=\"token number\">5</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre> <span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h1 id=\"支持sql查询\"><a class=\"anchor\" href=\"#支持sql查询\">#</a> 支持 SQL 查询</h1>\n<blockquote>\n<p>Apache Druid（孵化）SQL 是一个内置的 SQL 层，是 Druid 原生的基于 JSON 的查询语言的替代品，由基于<span class=\"exturl\" data-url=\"aHR0cHM6Ly9jYWxjaXRlLmFwYWNoZS5vcmcv\"> Apache Calcite</span> 的解析器和规划器提供支持。Druid SQL 将 SQL 转换为查询 Broker（您查询的第一个进程）上的本机 Druid 查询，然后将其作为本机 Druid 查询传递给数据进程。除了在 Broker 上转换 SQL 的（轻微）开销之外，与本机查询相比，没有额外的性能损失。</p>\n</blockquote>\n<p>请确保已 <code>druid.sql.enable = true</code>  在 common.runtime.properties 或 Broker 的 runtime.properties 中设置。</p>\n<p><img data-src=\"https://upload.cc/i1/2020/01/13/Q6UuDX.png\" alt=\"img\" /></p>\n<p 注：使用Kafka=\"\" Indexing=\"\" Service=\"\" 导入数据无法使用sql查询=\"\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mstyle mathcolor=\"red\"></mstyle></mrow><annotation encoding=\"application/x-tex\">\\color{red}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"></span></span></p>\n<p><em><strong>pageviews_count_sql.json</strong></em></p>\n<figure class=\"highlight json\"><figcaption data-lang=\"JSON\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">&#123;</span><span class=\"token property\">\"query\"</span><span class=\"token operator\">:</span><span class=\"token string\">\"SELECT url,latencyMs  FROM pageviews\"</span><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure>",
            "tags": [
                "计算机科学",
                "大数据",
                "druid"
            ]
        },
        {
            "id": "http://yrmlnf.coding-pages.com/Maxwell-%E6%95%B4%E5%90%88kafka%E4%B8%8Ebireme/",
            "url": "http://yrmlnf.coding-pages.com/Maxwell-%E6%95%B4%E5%90%88kafka%E4%B8%8Ebireme/",
            "title": "Maxwell-整合kafka与bireme",
            "date_published": "2021-03-31T02:28:30.000Z",
            "content_html": "<h1 id=\"mysqlmaridb-开启binlog\"><a class=\"anchor\" href=\"#mysqlmaridb-开启binlog\">#</a> mysql (maridb) 开启 binlog</h1>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">SHOW</span> VARIABLES <span class=\"token operator\">LIKE</span> <span class=\"token string\">'%log_bin%'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token operator\">+</span><span class=\"token comment\">---------------+-------+</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token operator\">|</span> Variable_name <span class=\"token operator\">|</span> <span class=\"token keyword\">Value</span> <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token operator\">+</span><span class=\"token comment\">---------------+-------+</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token operator\">|</span> log_bin       <span class=\"token operator\">|</span> <span class=\"token keyword\">OFF</span>   <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token operator\">+</span><span class=\"token comment\">---------------+-------+</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\">--  如果返回 OFF 没有开启，ON 则是已经开启</span></pre></td></tr></table></figure><h2 id=\"设置开启login\"><a class=\"anchor\" href=\"#设置开启login\">#</a> 设置开启 login</h2>\n<p etcmy.cnf.dserver.cnf=\"\">修改 my.cnf，mysql 一般位于 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mstyle mathcolor=\"red\"><mrow><mi mathvariant=\"normal\">/</mi><mi>e</mi><mi>t</mi><mi>c</mi><mi mathvariant=\"normal\">/</mi><mi>m</mi><mi>y</mi><mi mathvariant=\"normal\">.</mi><mi>c</mi><mi>n</mi><mi>f</mi></mrow></mstyle></mrow><annotation encoding=\"application/x-tex\">\\color{red}{/etc/my.cnf}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord\" style=\"color:red;\"><span class=\"mord\" style=\"color:red;\">/</span><span class=\"mord mathnormal\" style=\"color:red;\">e</span><span class=\"mord mathnormal\" style=\"color:red;\">t</span><span class=\"mord mathnormal\" style=\"color:red;\">c</span><span class=\"mord\" style=\"color:red;\">/</span><span class=\"mord mathnormal\" style=\"color:red;\">m</span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;color:red;\">y</span><span class=\"mord\" style=\"color:red;\">.</span><span class=\"mord mathnormal\" style=\"color:red;\">c</span><span class=\"mord mathnormal\" style=\"color:red;\">n</span><span class=\"mord mathnormal\" style=\"margin-right:0.10764em;color:red;\">f</span></span></span></span></span>   maridb 一般位于<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mstyle mathcolor=\"red\"></mstyle></mrow><annotation encoding=\"application/x-tex\">\\color{red}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"></span></span></p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># mysqld 中添加如下</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>mysqld<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>log-bin <span class=\"token operator\">=</span> mysql-bin <span class=\"token comment\">#开启 binlog</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>binlog-format <span class=\"token operator\">=</span> ROW <span class=\"token comment\">#选择 row 模式</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>server_id <span class=\"token operator\">=</span> <span class=\"token number\">1</span> <span class=\"token comment\">#配置 mysql replication 需要定义，不能和 canal 的 slaveId 重复</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\">## 开启 gtid 模式</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\">#gtid-mode=ON</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\">#log-slave-updates=ON</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token comment\">#enforce-gtid-consistency=true</span></pre></td></tr></table></figure><p>修改后重启数据库</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">service</span> mysql restart</pre></td></tr></table></figure><p><strong>检查是否开启</strong></p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">show</span> <span class=\"token keyword\">global</span> variables <span class=\"token operator\">like</span> <span class=\"token string\">\"%log_bin%\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token operator\">+</span><span class=\"token comment\">---------------------------------+---------------------------------------+</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token operator\">|</span> Variable_name                   <span class=\"token operator\">|</span> <span class=\"token keyword\">Value</span>                                 <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token operator\">+</span><span class=\"token comment\">---------------------------------+---------------------------------------+</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token operator\">|</span> log_bin                         <span class=\"token operator\">|</span> <span class=\"token keyword\">ON</span>                                    <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token operator\">|</span> log_bin_basename                <span class=\"token operator\">|</span> <span class=\"token operator\">/</span>usr<span class=\"token operator\">/</span><span class=\"token keyword\">local</span><span class=\"token operator\">/</span>mysql<span class=\"token operator\">/</span><span class=\"token keyword\">data</span><span class=\"token operator\">/</span>mysql<span class=\"token operator\">-</span>bin       <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token operator\">|</span> log_bin_index                   <span class=\"token operator\">|</span> <span class=\"token operator\">/</span>usr<span class=\"token operator\">/</span><span class=\"token keyword\">local</span><span class=\"token operator\">/</span>mysql<span class=\"token operator\">/</span><span class=\"token keyword\">data</span><span class=\"token operator\">/</span>mysql<span class=\"token operator\">-</span>bin<span class=\"token punctuation\">.</span><span class=\"token keyword\">index</span> <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token operator\">|</span> log_bin_trust_function_creators <span class=\"token operator\">|</span> <span class=\"token keyword\">OFF</span>                                   <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token operator\">|</span> log_bin_use_v1_row_events       <span class=\"token operator\">|</span> <span class=\"token keyword\">OFF</span>                                   <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token operator\">+</span><span class=\"token comment\">---------------------------------+---------------------------------------+</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token keyword\">SHOW</span> VARIABLES <span class=\"token operator\">LIKE</span> <span class=\"token string\">'%log_bin%'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token operator\">+</span><span class=\"token comment\">---------------+-------+</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token operator\">|</span> Variable_name <span class=\"token operator\">|</span> <span class=\"token keyword\">Value</span> <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token operator\">+</span><span class=\"token comment\">---------------+-------+</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token operator\">|</span> log_bin       <span class=\"token operator\">|</span> <span class=\"token keyword\">ON</span>    <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token operator\">+</span><span class=\"token comment\">---------------+-------+</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token comment\">-- 开启成功</span></pre></td></tr></table></figure><h2 id=\"创始用户及表\"><a class=\"anchor\" href=\"#创始用户及表\">#</a> 创始用户及表</h2>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">-- 开通 MySQL 高权限账号</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">USER</span> <span class=\"token string\">'maxwell'</span><span class=\"token variable\">@'%'</span> IDENTIFIED <span class=\"token keyword\">BY</span> <span class=\"token string\">'maxwell'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">GRANT</span> <span class=\"token keyword\">ALL</span> <span class=\"token keyword\">ON</span> maxwell<span class=\"token punctuation\">.</span><span class=\"token operator\">*</span> <span class=\"token keyword\">TO</span> <span class=\"token string\">'maxwell'</span><span class=\"token variable\">@'%'</span> IDENTIFIED <span class=\"token keyword\">BY</span> <span class=\"token string\">'maxwell'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">GRANT</span> <span class=\"token keyword\">SELECT</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">REPLICATION</span> CLIENT<span class=\"token punctuation\">,</span><span class=\"token keyword\">REPLICATION</span> SLAVE <span class=\"token keyword\">ON</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">.</span><span class=\"token operator\">*</span> <span class=\"token keyword\">TO</span> <span class=\"token string\">'maxwell'</span><span class=\"token variable\">@'%'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>FLUSH <span class=\"token keyword\">PRIVILEGES</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\">-- 初始化表</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">TABLE</span> tb1<span class=\"token punctuation\">(</span>a <span class=\"token keyword\">int</span><span class=\"token punctuation\">,</span> b <span class=\"token keyword\">char</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">primary</span> <span class=\"token keyword\">key</span><span class=\"token punctuation\">(</span>a<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><h1 id=\"maxwell\"><a class=\"anchor\" href=\"#maxwell\">#</a> maxwell</h1>\n<blockquote>\n<p><span class=\"exturl\" data-url=\"aHR0cDovL21heHdlbGxzLWRhZW1vbi5pby8=\">Maxwell</span> 通过 canal 解析 binlog，并将其发送到 Kafka</p>\n</blockquote>\n<h2 id=\"maxwell主要功能\"><a class=\"anchor\" href=\"#maxwell主要功能\">#</a> Maxwell 主要功能</h2>\n<ul>\n<li>支持 SELECT * FROM table 的方式进行全量数据初始化</li>\n<li>支持在主库发生 failover 后，自动恢复 binlog 位置 (GTID)</li>\n<li>可以对数据进行分区，解决数据倾斜问题，发送到 kafka 的数据支持 database、table、column 等级别的数据分区</li>\n<li>工作方式是伪装为 Slave，接收 binlog events，然后根据 schemas 信息拼装，可以接受 ddl、xid、row 等各种 event</li>\n</ul>\n<p><strong>常见 mysql binlog 解析工具对比</strong></p>\n<p><img data-src=\"https://cdn.jsdelivr.net/gh/happydj/cloudimg@master/data/20200628110252.png\" alt=\"\" /></p>\n<ul>\n<li>\n<p><em>canal 由 Java 开发，分为服务端和客户端，拥有众多的衍生应用，性能稳定，功能强大；canal 需要自己编写客户端来消费 canal 解析到的数据。</em></p>\n</li>\n<li>\n<p><em>maxwell 相对于 canal 的优势是使用简单，它直接将数据变更输出为 json 字符串，不需要再编写客户端。</em></p>\n</li>\n</ul>\n<h2 id=\"快速开始\"><a class=\"anchor\" href=\"#快速开始\">#</a> 快速开始</h2>\n<blockquote>\n<p>首先 MySQL 需要先启用 binlog，关于什么是 MySQL binlog，可以参考文章《<span class=\"exturl\" data-url=\"aHR0cHM6Ly9tcC53ZWl4aW4ucXEuY29tL3M/X19iaXo9TXpJMU5EVTBNVEUxTkE9PSZhbXA7bWlkPTIyNDc0ODM4NzUmYW1wO2lkeD0xJmFtcDtzbj0yY2RjMjMyZmEzMDM2ZGE1MmE4MjY5NjQ5OTY1MDZhOCZhbXA7Y2hrc209ZTljMmVkZWVkZWI1NjRmODkxYjM0ZWYxZTQ3NDE4YmJlNmI4Y2I2ZGNiN2Y0OGI1ZmE3M2IxNWNmMWQ2MzE3MmRmMWExNzNjNzVkMCZhbXA7c2NlbmU9MCZhbXA7eHRyYWNrPTEmYW1wO2tleT1lMzk3N2Y4YTc5NDkwYzYzNDViZWZiODhkMGJiZjc0Y2JkYzZiNTA4YTUyZTYxZWEwNzZjODMwYTViNjRjNTUyZGVmNmM2YWQ4NDhkNGJjYzdhMWQyMWU1M2UzMGViNWMxZWFkMzNhY2RiOTdkZjc3OWQwZTZmYThhMGZiZTRiZGEzMmMwNDA3N2VhMGQzNTExYmM5Zjk0OTBhZDBiNDZjJmFtcDthc2NlbmU9MSZhbXA7dWluPU1qSTRNVGMwT0RFd09RJTNEJTNEJmFtcDtkZXZpY2V0eXBlPVdpbmRvd3MrNyZhbXA7dmVyc2lvbj02MjA2MDcxOSZhbXA7bGFuZz16aF9DTiZhbXA7cGFzc190aWNrZXQ9aDhqeXJRNzFoUWM4NzJMeHlkWlMlMkYzYVUxSlhGYnA0cmFRMUt2WTkwOEJjS0JlU0J0WEZnQlk5SVM5WmFMRURp\">MySQL Binlog 介绍</span>》</p>\n</blockquote>\n<ol>\n<li>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL3plbmRlc2svbWF4d2VsbC9yZWxlYXNlcw==\">maxwell 下载地址</span></p>\n</li>\n<li>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL3plbmRlc2svbWF4d2VsbA==\">maxwell 官方文档</span></p>\n</li>\n<li>\n<p>解压: tar xf maxwell.tar.gz</p>\n</li>\n<li>\n<p>简单测试</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 直接输入到终端窗口 </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>bin/maxwell <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>--host<span class=\"token operator\">=</span><span class=\"token string\">'localhost'</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>--port<span class=\"token operator\">=</span><span class=\"token number\">3306</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>--user<span class=\"token operator\">=</span><span class=\"token string\">'maxwell'</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>--password<span class=\"token operator\">=</span><span class=\"token string\">'maxwell'</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>--producer<span class=\"token operator\">=</span>stdout <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>--log_level<span class=\"token operator\">=</span>INFO</pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\"># mysql sql</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>insert into tb2 value<span class=\"token punctuation\">(</span><span class=\"token number\">10</span>,<span class=\"token string\">\"10\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token comment\"># 控制台输出</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">&#123;</span><span class=\"token string\">\"database\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"sampledata\"</span>,<span class=\"token string\">\"table\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"tb2\"</span>,<span class=\"token string\">\"type\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"bootstrap-insert\"</span>,<span class=\"token string\">\"ts\"</span>:1584716272,<span class=\"token string\">\"xid\"</span>:832,<span class=\"token string\">\"data\"</span>:<span class=\"token punctuation\">&#123;</span><span class=\"token string\">\"a\"</span>:10,<span class=\"token string\">\"b\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"10\"</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token comment\">## 输入到 kafka</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token comment\"># 创建 topic </span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>./kafka-topics.sh --create --zookeeper hdp-m-1.data.dc.zjft.com:2181 hdp-m-2.data.dc.zjft.com:2181 hdp-e-1.data.dc.zjft.com:2181 --replication-factor <span class=\"token number\">1</span> --partitions <span class=\"token number\">1</span> --topic maxwell</pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token comment\"># 启动消费者</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>./kafka-console-consumer.sh --topic maxwell --bootstrap-server hdp-s-1.data.dc.zjft.com:6667</pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token comment\"># 运行 maxwell</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>bin/maxwell --user<span class=\"token operator\">=</span><span class=\"token string\">'maxwell'</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    --password<span class=\"token operator\">=</span><span class=\"token string\">'maxwell'</span> --host<span class=\"token operator\">=</span><span class=\"token string\">'localshot'</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    --producer<span class=\"token operator\">=</span>kafka <span class=\"token punctuation\">\\</span> </pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    --kafka.bootstrap.servers<span class=\"token operator\">=</span><span class=\"token string\">'hdp-s-1.data.dc.zjft.com:6667'</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    --kafka_topic<span class=\"token operator\">=</span>maxwell <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    --log_level<span class=\"token operator\">=</span>info</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    </pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token comment\"># insert</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>insert into tb2 value<span class=\"token punctuation\">(</span><span class=\"token number\">1</span>,<span class=\"token string\">\"2\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>insert into tb2 value<span class=\"token punctuation\">(</span><span class=\"token number\">2</span>,<span class=\"token string\">\"b\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>insert into tb2 value<span class=\"token punctuation\">(</span><span class=\"token number\">3</span>,<span class=\"token string\">\"2\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>udpate tb2 <span class=\"token builtin class-name\">set</span> <span class=\"token assign-left variable\">b</span><span class=\"token operator\">=</span><span class=\"token string\">\"b\"</span> where <span class=\"token assign-left variable\">a</span><span class=\"token operator\">=</span><span class=\"token number\">3</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre></pre></td></tr><tr><td data-num=\"37\"></td><td><pre><span class=\"token comment\"># 消费者消费 maxwell topic 的消息</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre><span class=\"token comment\"># 主题不存在报错：Error while fetching metadata with correlation id 379 : &#123;tpoicname:=INVALID_TOPIC_EXCEPTION&#125;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre></pre></td></tr><tr><td data-num=\"40\"></td><td><pre><span class=\"token punctuation\">&#123;</span><span class=\"token string\">\"database\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"sampledata\"</span>,<span class=\"token string\">\"table\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"tb2\"</span>,<span class=\"token string\">\"type\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"insert\"</span>,<span class=\"token string\">\"ts\"</span>:1585033146,<span class=\"token string\">\"xid\"</span>:840，<span class=\"token string\">\"data\"</span>:<span class=\"token punctuation\">&#123;</span><span class=\"token string\">\"a\"</span>:1,<span class=\"token string\">\"b\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"2\"</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre><span class=\"token punctuation\">&#123;</span><span class=\"token string\">\"database\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"sampledata\"</span>,<span class=\"token string\">\"table\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"tb2\"</span>,<span class=\"token string\">\"type\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"insert\"</span>,<span class=\"token string\">\"ts\"</span>:1585033147,<span class=\"token string\">\"xid\"</span>:841,<span class=\"token string\">\"data\"</span>:<span class=\"token punctuation\">&#123;</span><span class=\"token string\">\"a\"</span>:2,<span class=\"token string\">\"b\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"2\"</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre><span class=\"token punctuation\">&#123;</span><span class=\"token string\">\"database\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"sampledata\"</span>,<span class=\"token string\">\"table\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"tb2\"</span>,<span class=\"token string\">\"type\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"insert\"</span>,<span class=\"token string\">\"ts\"</span>:1585033147,<span class=\"token string\">\"xid\"</span>:842,<span class=\"token string\">\"data\"</span>:<span class=\"token punctuation\">&#123;</span><span class=\"token string\">\"a\"</span>:3,<span class=\"token string\">\"b\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"2\"</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre></pre></td></tr><tr><td data-num=\"44\"></td><td><pre></pre></td></tr><tr><td data-num=\"45\"></td><td><pre><span class=\"token comment\"># update （若修改的数据值不变，则不产生日志）</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>update tb1 <span class=\"token builtin class-name\">set</span> <span class=\"token assign-left variable\">dtm</span><span class=\"token operator\">=</span><span class=\"token string\">'2020-03-31'</span> where a <span class=\"token operator\">=</span> <span class=\"token number\">1235</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre><span class=\"token punctuation\">&#123;</span><span class=\"token string\">\"database\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"sampledata\"</span>,<span class=\"token string\">\"table\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"tb1\"</span>,<span class=\"token string\">\"type\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"update\"</span>,<span class=\"token string\">\"ts\"</span>:1585536380,<span class=\"token string\">\"xid\"</span>:10588,<span class=\"token string\">\"commit\"</span>:true,<span class=\"token string\">\"data\"</span>:<span class=\"token punctuation\">&#123;</span><span class=\"token string\">\"a\"</span>:1235,<span class=\"token string\">\"b\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"100\"</span>,<span class=\"token string\">\"dtm\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"2020-03-31\"</span><span class=\"token punctuation\">&#125;</span>,<span class=\"token string\">\"old\"</span>:<span class=\"token punctuation\">&#123;</span><span class=\"token string\">\"dtm\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"2020-03-30\"</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre></pre></td></tr><tr><td data-num=\"49\"></td><td><pre><span class=\"token comment\"># delete </span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>delete from tb1 where <span class=\"token assign-left variable\">a</span><span class=\"token operator\">=</span><span class=\"token number\">4</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre><span class=\"token punctuation\">&#123;</span><span class=\"token string\">\"database\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"sampledata\"</span>,<span class=\"token string\">\"table\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"tb1\"</span>,<span class=\"token string\">\"type\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"delete\"</span>,<span class=\"token string\">\"ts\"</span>:1585535987,<span class=\"token string\">\"xid\"</span>:10063,<span class=\"token string\">\"</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>commit\"</span>:true,<span class=\"token string\">\"data\"</span>:<span class=\"token punctuation\">&#123;</span><span class=\"token string\">\"a\"</span>:4,<span class=\"token string\">\"b\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"10\"</span>,<span class=\"token string\">\"dtm\"</span>:null<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure></li>\n<li>\n<p>使用配置文件 ： cp config.properties.example config.properties &amp;&amp; vi config.properties</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#config.properties</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token assign-left variable\">log_level</span><span class=\"token operator\">=</span>info</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token assign-left variable\">producer</span><span class=\"token operator\">=</span>kafka</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token assign-left variable\">kafka_topic</span><span class=\"token operator\">=</span>maxwell3</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>kafka.bootstrap.servers<span class=\"token operator\">=</span>hdp-s-1.data.dc.zjft.com:6667 </pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\"># mysql login info</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token assign-left variable\">host</span><span class=\"token operator\">=</span><span class=\"token number\">127.0</span>.0.1</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token assign-left variable\">port</span><span class=\"token operator\">=</span><span class=\"token number\">3306</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token assign-left variable\">user</span><span class=\"token operator\">=</span>maxwell</pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token assign-left variable\">password</span><span class=\"token operator\">=</span>maxwell</pre></td></tr></table></figure><p>** 运行方法： ** bin/maxwell --config config.properties</p>\n</li>\n</ol>\n<h2 id=\"输出json字符串的格式\"><a class=\"anchor\" href=\"#输出json字符串的格式\">#</a> 输出 JSON 字符串的格式</h2>\n<table>\n<thead>\n<tr>\n<th>字段</th>\n<th>解释</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>data</td>\n<td>最新的数据，修改后的数据</td>\n</tr>\n<tr>\n<td>old</td>\n<td>旧数据，修改前的数据</td>\n</tr>\n<tr>\n<td>type</td>\n<td>有 insert, update, delete, database-create, database-alter, database-drop, table-create,  table-alter, table-drop，bootstrap-insert，int (未知类型)</td>\n</tr>\n<tr>\n<td>xid</td>\n<td>事务 id</td>\n</tr>\n<tr>\n<td>commit</td>\n<td>同一个 xid 代表同一个事务，事务的最后一条语句会有 commit，可以利用这个重现事务</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"maxwell配置项说明\"><a class=\"anchor\" href=\"#maxwell配置项说明\">#</a> maxwell 配置项说明</h2>\n<blockquote>\n<p>config.properties 配置文件里面的所有选项，都可以在启动 maxweill ./bin/maxwell 是指定，覆盖配置文件的内容。这里只讲一些常用的</p>\n</blockquote>\n<h3 id=\"mysql-配置选项\"><a class=\"anchor\" href=\"#mysql-配置选项\">#</a> mysql 配置选项</h3>\n<p><strong>Maxwell 根据用途将 MySQL 划分为 3 种角色：</strong></p>\n<ul>\n<li><strong>host</strong>：主机，建 maxwell 库表，存储捕获到的 schema 等信息\n<ul>\n<li><strong>Maxwell</strong> 主要有六张表，\n<ul>\n<li><strong>bootstrap</strong> 用于数据初始化，</li>\n<li><strong>schemas</strong> 记录所有的 binlog 文件信息，</li>\n<li><strong>databases</strong> 记录了所有的数据库信息，</li>\n<li><strong>tables</strong> 记录了所有的表信息，</li>\n<li><strong>columns</strong> 记录了所有的字段信息，</li>\n<li><strong>positions</strong> 记录了读取 binlog 的位移信息，heartbeats 记录了心跳信息</li>\n</ul>\n</li>\n</ul>\n</li>\n<li><strong>replication_hos</strong>t：复制主机，Event 监听，读取该主机 binlog\n<ul>\n<li>将 host 和 replication_host 分开，可以避免 replication_user 往生产库里写数据</li>\n</ul>\n</li>\n<li><strong>schema_hos</strong>t：schema 主机，捕获表结构 schema 的主机\n<ul>\n<li><strong>binlog</strong> 里面没有字段信息，所以 maxwell 需要从数据库查出 schema，存起来。</li>\n<li><strong>schema_host</strong> 一般用不到，但在 binlog-proxy 场景下就很实用。比如要将已经离线的 binlog 通过 maxwell 生成 json 流，于是自建一个 mysql server 里面没有结构，只用于发送 binlog，此时表机构就可以制动从 schema_host 获取。<br />\n通常，这三个主机都是同一个，schema_host 只在有 replication_host 的时候使用。</li>\n</ul>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>选项</th>\n<th>参数值</th>\n<th>描述</th>\n<th>默认值</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>host</td>\n<td>STRING</td>\n<td>mysql 地址</td>\n<td>localhost</td>\n</tr>\n<tr>\n<td>user</td>\n<td>STRING</td>\n<td colspan=\"2\">mysql 用户名</td>\n</tr>\n<tr>\n<td>password</td>\n<td>STRING</td>\n<td>mysql 密码</td>\n<td>(no password)</td>\n</tr>\n<tr>\n<td>port</td>\n<td>INT</td>\n<td colspan=\"2\">mysql 端口 3306</td>\n</tr>\n<tr>\n<td>jdbc_options</td>\n<td>STRING</td>\n<td>mysql jdbc connection options</td>\n<td>DEFAULT_JDBC_OPTS</td>\n</tr>\n<tr>\n<td>ssl</td>\n<td>SSL_OPT</td>\n<td>SSL behavior for mysql cx</td>\n<td>DISABLED</td>\n</tr>\n<tr>\n<td>schema_database</td>\n<td>STRING</td>\n<td>Maxwell 用于维护的 schema 和 position 将使用的数据库</td>\n<td>maxwell</td>\n</tr>\n<tr>\n<td>client_id</td>\n<td>STRING</td>\n<td>用于标识 Maxwell 实例的唯一字符串</td>\n<td>maxwell</td>\n</tr>\n<tr>\n<td>replica_server_id</td>\n<td>LONG</td>\n<td>用于标识 Maxwell 实例的唯一数字</td>\n<td>6379 (see notes)</td>\n</tr>\n<tr>\n<td>master_recovery</td>\n<td>BOOLEAN</td>\n<td>enable experimental master recovery code</td>\n<td>false</td>\n</tr>\n<tr>\n<td>gtid_mode</td>\n<td>BOOLEAN</td>\n<td>是否开启基于 GTID 的复制</td>\n<td>false</td>\n</tr>\n<tr>\n<td>recapture_schema</td>\n<td>BOOLEAN</td>\n<td>重新捕获最新的表结构 (schema)，不可在 config.properties 中配置</td>\n<td>false</td>\n</tr>\n<tr>\n<td>replication_host</td>\n<td>STRING</td>\n<td>server to replicate from. See split server roles</td>\n<td>schema-store host</td>\n</tr>\n<tr>\n<td>replication_password</td>\n<td>STRING</td>\n<td>password on replication server</td>\n<td>(none)</td>\n</tr>\n<tr>\n<td>replication_port</td>\n<td>INT</td>\n<td>port on replication server</td>\n<td>3306</td>\n</tr>\n<tr>\n<td>replication_user</td>\n<td>STRING</td>\n<td colspan=\"2\">user on replication server</td>\n</tr>\n<tr>\n<td>replication_ssl</td>\n<td>SSL_OPT</td>\n<td>SSL behavior for replication cx cx</td>\n<td>DISABLED</td>\n</tr>\n<tr>\n<td>schema_host</td>\n<td>STRING</td>\n<td>server to capture schema from. See split server roles</td>\n<td>schema-store host</td>\n</tr>\n<tr>\n<td>schema_password</td>\n<td>STRING</td>\n<td>password on schema-capture server</td>\n<td>(none)</td>\n</tr>\n<tr>\n<td>schema_port</td>\n<td>INT</td>\n<td>port on schema-capture server</td>\n<td>3306</td>\n</tr>\n<tr>\n<td>schema_user</td>\n<td>STRING</td>\n<td colspan=\"2\">user on schema-capture server</td>\n</tr>\n<tr>\n<td>schema_ssl</td>\n<td>SSL_OPT</td>\n<td>SSL behavior for schema-capture server</td>\n<td>DISABLED</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"生产者的配置\"><a class=\"anchor\" href=\"#生产者的配置\">#</a> 生产者的配置</h3>\n<table>\n<thead>\n<tr>\n<th>选项</th>\n<th>参数值</th>\n<th>描述</th>\n<th>默认值</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>producer</td>\n<td>PRODUCER_TYPE</td>\n<td>生产者类型</td>\n<td>stdout</td>\n</tr>\n<tr>\n<td>custom_producer.factory</td>\n<td>CLASS_NAME</td>\n<td colspan=\"2\">自定义消费者的工厂类</td>\n</tr>\n<tr>\n<td>producer_ack_timeout</td>\n<td>PRODUCER_ACK_TIMEOUT</td>\n<td colspan=\"2\">异步消费认为消息丢失的超时时间（毫秒 ms）</td>\n</tr>\n<tr>\n<td>producer_partition_by</td>\n<td>输入到 kafka/kinesis 的分区函数</td>\n<td>输入到 kafka/kinesis 的分区函数</td>\n<td>database</td>\n</tr>\n<tr>\n<td>producer_partition_columns</td>\n<td>STRING</td>\n<td colspan=\"2\">若按列分区，以逗号分隔的列名称</td>\n</tr>\n<tr>\n<td>producer_partition_by_fallback</td>\n<td>PARTITION_BY_FALLBACK</td>\n<td colspan=\"2\">producer_partition_by=column 时需要，当列不存在是使用</td>\n</tr>\n<tr>\n<td>ignore_producer_error</td>\n<td>BOOLEAN</td>\n<td>为 false 时，在 kafka/kinesis 发生错误时退出程序；为 true 时，仅记录日志 See also dead_letter_topic</td>\n<td>true</td>\n</tr>\n<tr>\n<td>kafka.bootstrap.servers</td>\n<td>STRING</td>\n<td colspan=\"2\">kafka 集群列表，HOST:PORT [,HOST:PORT]</td>\n</tr>\n<tr>\n<td>kafka_topic\tSTRING</td>\n<td>kafka</td>\n<td>topic</td>\n<td>maxwell</td>\n</tr>\n<tr>\n<td>dead_letter_topic</td>\n<td>STRING</td>\n<td colspan=\"2\">详见官方文档</td>\n</tr>\n<tr>\n<td>kafka_version</td>\n<td>KAFKA_VERSION</td>\n<td colspan=\"2\">指定 maxwell 的 kafka 生产者客户端版本，不可在 config.properties 中配置\t0.11.0.1</td>\n</tr>\n<tr>\n<td>kafka_partition_hash</td>\n<td>[default | murmur3]</td>\n<td>选择 kafka 分区时使用的 hash 方法</td>\n<td>default</td>\n</tr>\n<tr>\n<td>kafka_key_format</td>\n<td>[array | hash]</td>\n<td colspan=\"2\">how maxwell outputs kafka keys, either a hash or an array of hashes\thash</td>\n</tr>\n<tr>\n<td>ddl_kafka_topic</td>\n<td>STRING</td>\n<td>当 output_ddl 为 true 时，所有 DDL 的消息都将投递到该 topic</td>\n<td>kafka_topic</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"过滤器配置\"><a class=\"anchor\" href=\"#过滤器配置\">#</a> 过滤器配置</h3>\n<p>​       <strong>通过 exclude 排除，通过 include 包含，值可以为具体的数据库、数据表、数据列，甚至用 Javascript 来定义复杂的过滤规则；可以用正则表达式描述，有几个来自官网的例子</strong></p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 仅匹配 foodb 数据库的 tbl 表和所有 table_数字的表</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>--filter<span class=\"token operator\">=</span><span class=\"token string\">'exclude: foodb.*, include: foodb.tbl, include: foodb./table_\\d+/'</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># 排除所有库所有表，仅匹配 db1 数据库</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>--filter <span class=\"token operator\">=</span> <span class=\"token string\">'exclude: *.*, include: db1.*'</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\"># 排除含 db.tbl.col 列值为 reject 的所有更新</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>--filter <span class=\"token operator\">=</span> <span class=\"token string\">'exclude: db.tbl.col = reject'</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\"># 排除任何包含 col_a 列的更新</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>--filter <span class=\"token operator\">=</span> <span class=\"token string\">'exclude: *.*.col_a = *'</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token comment\"># blacklist 黑名单，完全排除 bad_db 数据库，若要恢复，必须删除 maxwell 库</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>--filter <span class=\"token operator\">=</span> <span class=\"token string\">'blacklist: bad_db.*'</span></pre></td></tr></table></figure><h3 id=\"javascript-过滤器\"><a class=\"anchor\" href=\"#javascript-过滤器\">#</a> javascript 过滤器</h3>\n<blockquote>\n<p>如果需要本机过滤器无法提供的更多灵活性，则可以编写一小段 JavaScript，让 Maxwell 通过传递每一行 <code>--javascript FILE</code></p>\n</blockquote>\n<figure class=\"highlight javascript\"><figcaption data-lang=\"javascript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token operator\">/</span> <span class=\"token operator\">*</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre> <span class=\"token operator\">*</span>您的JavaScript过滤器至少应定义</pre></td></tr><tr><td data-num=\"3\"></td><td><pre> <span class=\"token operator\">*</span>（process_row，process_heartbeat，process_ddl）之一。</pre></td></tr><tr><td data-num=\"4\"></td><td><pre> <span class=\"token operator\">*</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre> <span class=\"token operator\">*</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">process_row</span><span class=\"token template-punctuation string\">`</span></span>被称为后过滤器，用于所有未过滤的数据行</pre></td></tr><tr><td data-num=\"6\"></td><td><pre> <span class=\"token operator\">*</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token operator\">*</span> process_row必须采用一个参数，即“ WrappedRowMap”的实例。WrappedRowMap的javascript <span class=\"token constant\">API</span>如下所示：</pre></td></tr><tr><td data-num=\"8\"></td><td><pre> <span class=\"token operator\">*</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre> <span class=\"token operator\">*</span> <span class=\"token punctuation\">.</span>suppress（）<span class=\"token operator\">-</span><span class=\"token operator\">></span>调用此命令从输出中删除行</pre></td></tr><tr><td data-num=\"10\"></td><td><pre> <span class=\"token operator\">*</span> <span class=\"token punctuation\">.</span>kafka_topic <span class=\"token operator\">=</span>“ topic”<span class=\"token operator\">-</span><span class=\"token operator\">></span>覆盖此行的默认kafka主题</pre></td></tr><tr><td data-num=\"11\"></td><td><pre> <span class=\"token operator\">*</span> <span class=\"token punctuation\">.</span>partition_string <span class=\"token operator\">=</span>“ string”<span class=\"token operator\">-</span><span class=\"token operator\">></span>覆盖kafka <span class=\"token operator\">/</span> kinesis按字符串划分</pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token operator\">*</span> <span class=\"token punctuation\">.</span>data<span class=\"token operator\">-</span><span class=\"token operator\">></span>包含行数据的哈希。可以修改。</pre></td></tr><tr><td data-num=\"13\"></td><td><pre> <span class=\"token operator\">*</span> <span class=\"token punctuation\">.</span>old_data<span class=\"token operator\">-</span><span class=\"token operator\">></span>包含旧数据的哈希</pre></td></tr><tr><td data-num=\"14\"></td><td><pre> <span class=\"token operator\">*</span> <span class=\"token punctuation\">.</span>extra_attributes<span class=\"token operator\">-</span><span class=\"token operator\">></span>如果您在此哈希中设置值，则它们将在最终<span class=\"token constant\">JSON</span>的顶级输出</pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token operator\">*</span> <span class=\"token punctuation\">.</span>type<span class=\"token operator\">-</span><span class=\"token operator\">></span>“插入” <span class=\"token operator\">|</span> “更新” <span class=\"token operator\">|</span> “删除”</pre></td></tr><tr><td data-num=\"16\"></td><td><pre> <span class=\"token operator\">*</span> <span class=\"token punctuation\">.</span>table<span class=\"token operator\">-</span><span class=\"token operator\">></span>表名</pre></td></tr><tr><td data-num=\"17\"></td><td><pre> <span class=\"token operator\">*</span> <span class=\"token punctuation\">.</span>database<span class=\"token operator\">-</span><span class=\"token operator\">></span>数据库名称</pre></td></tr><tr><td data-num=\"18\"></td><td><pre> <span class=\"token operator\">*</span> <span class=\"token punctuation\">.</span>position<span class=\"token operator\">-</span><span class=\"token operator\">></span>事件的binlog位置作为字符串</pre></td></tr><tr><td data-num=\"19\"></td><td><pre> <span class=\"token operator\">*</span> <span class=\"token punctuation\">.</span>xid<span class=\"token operator\">-</span><span class=\"token operator\">></span>交易<span class=\"token constant\">XID</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre> <span class=\"token operator\">*</span> <span class=\"token punctuation\">.</span>server_id<span class=\"token operator\">-</span><span class=\"token operator\">></span>服务器<span class=\"token constant\">ID</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre> <span class=\"token operator\">*</span> <span class=\"token punctuation\">.</span>thread_id<span class=\"token operator\">-</span><span class=\"token operator\">></span>客户端thread_id</pre></td></tr><tr><td data-num=\"22\"></td><td><pre> <span class=\"token operator\">*</span> <span class=\"token punctuation\">.</span>timestamp<span class=\"token operator\">-</span><span class=\"token operator\">></span>行时间戳</pre></td></tr><tr><td data-num=\"23\"></td><td><pre> <span class=\"token operator\">*</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre> <span class=\"token operator\">*</span> <span class=\"token operator\">/</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token keyword\">function</span> <span class=\"token function\">process_row</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">row</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span> row<span class=\"token punctuation\">.</span>database <span class=\"token operator\">==</span> <span class=\"token string\">\"shard_1\"</span> <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span> row<span class=\"token punctuation\">.</span>table <span class=\"token operator\">==</span> <span class=\"token string\">\"fo\"</span> <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\t\t\trow<span class=\"token punctuation\">.</span><span class=\"token function\">suppress</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span> row<span class=\"token punctuation\">.</span>table <span class=\"token operator\">==</span> <span class=\"token string\">\"sharded\"</span> <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>\t\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span> row<span class=\"token punctuation\">.</span>type <span class=\"token operator\">==</span> <span class=\"token string\">\"insert\"</span> <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>\t\t\t\trow<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"password\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"XXXXXXXX\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span> row<span class=\"token punctuation\">.</span>table <span class=\"token operator\">==</span> <span class=\"token string\">\"other\"</span> <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>\t\t\trow<span class=\"token punctuation\">.</span>kafka_topic <span class=\"token operator\">=</span> <span class=\"token string\">\"other_kafka_topic\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span> row<span class=\"token punctuation\">.</span>table <span class=\"token operator\">==</span> <span class=\"token string\">\"iterate_me\"</span> <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>\t\t\t<span class=\"token keyword\">for</span> <span class=\"token function\">each</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token keyword\">var</span> key <span class=\"token keyword\">in</span> row<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span><span class=\"token function\">keySet</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>\t\t\t\tlogger<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span>row<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">[</span>key<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre></pre></td></tr><tr><td data-num=\"44\"></td><td><pre><span class=\"token operator\">/</span> <span class=\"token operator\">*</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre><span class=\"token operator\">*</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">process_ddl</span><span class=\"token template-punctuation string\">`</span></span>必须采用一个参数，即<span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">WrappedDDLMap</span><span class=\"token template-punctuation string\">`</span></span>的实例。WrappedDDLMap响应：</pre></td></tr><tr><td data-num=\"46\"></td><td><pre> <span class=\"token operator\">*</span> <span class=\"token punctuation\">.</span>suppress（）<span class=\"token operator\">-</span><span class=\"token operator\">></span>调用此命令从输出中删除行</pre></td></tr><tr><td data-num=\"47\"></td><td><pre> <span class=\"token operator\">*</span> <span class=\"token punctuation\">.</span>kafka_topic <span class=\"token operator\">=</span>“ topic”<span class=\"token operator\">-</span><span class=\"token operator\">></span>覆盖此行的默认kafka主题</pre></td></tr><tr><td data-num=\"48\"></td><td><pre> <span class=\"token operator\">*</span> <span class=\"token punctuation\">.</span>extra_attributes<span class=\"token operator\">-</span><span class=\"token operator\">></span>如果您在此哈希中设置值，则它们将在最终<span class=\"token constant\">JSON</span>的顶级输出</pre></td></tr><tr><td data-num=\"49\"></td><td><pre> <span class=\"token operator\">*</span> <span class=\"token punctuation\">.</span>type<span class=\"token operator\">-</span><span class=\"token operator\">></span> <span class=\"token constant\">DDL</span><span class=\"token operator\">-</span><span class=\"token constant\">TYPE</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre> <span class=\"token operator\">*</span> <span class=\"token punctuation\">.</span>table<span class=\"token operator\">-</span><span class=\"token operator\">></span>表名</pre></td></tr><tr><td data-num=\"51\"></td><td><pre> <span class=\"token operator\">*</span> <span class=\"token punctuation\">.</span>database<span class=\"token operator\">-</span><span class=\"token operator\">></span>数据库名称</pre></td></tr><tr><td data-num=\"52\"></td><td><pre> <span class=\"token operator\">*</span> <span class=\"token punctuation\">.</span>position<span class=\"token operator\">-</span><span class=\"token operator\">></span>事件的binlog位置作为字符串</pre></td></tr><tr><td data-num=\"53\"></td><td><pre> <span class=\"token operator\">*</span> <span class=\"token punctuation\">.</span>timestamp<span class=\"token operator\">-</span><span class=\"token operator\">></span>以<span class=\"token constant\">UTC</span>秒为单位的行时间戳</pre></td></tr><tr><td data-num=\"54\"></td><td><pre><span class=\"token operator\">*</span> <span class=\"token punctuation\">.</span>change<span class=\"token operator\">-</span><span class=\"token operator\">></span>表示<span class=\"token constant\">DDL</span>更改的哈希图。每种<span class=\"token constant\">DDL</span>类型都不同。</pre></td></tr><tr><td data-num=\"55\"></td><td><pre> <span class=\"token operator\">*</span> <span class=\"token operator\">/</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre></pre></td></tr><tr><td data-num=\"57\"></td><td><pre><span class=\"token keyword\">function</span> <span class=\"token function\">process_ddl</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">ddl</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>\tlogger<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span>ddl<span class=\"token punctuation\">.</span>change<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>\tlogger<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span>ddl<span class=\"token punctuation\">.</span>table<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>\tlogger<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span>ddl<span class=\"token punctuation\">.</span>database<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>\tddl<span class=\"token punctuation\">.</span>extra_attributes<span class=\"token punctuation\">[</span><span class=\"token string\">'hello'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token string\">'world'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span> ddl<span class=\"token punctuation\">.</span>table <span class=\"token operator\">==</span> <span class=\"token string\">\"foo\"</span> <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>\t\tddl<span class=\"token punctuation\">.</span><span class=\"token function\">suppress</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre></pre></td></tr><tr><td data-num=\"67\"></td><td><pre><span class=\"token operator\">/</span> <span class=\"token operator\">*</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre> <span class=\"token operator\">*</span> process_heartbeat<span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">必须采用一个参数，即WrappedHeartbeatMap</span><span class=\"token template-punctuation string\">`</span></span>的实例。WrappedHeartbeatMap响应：</pre></td></tr><tr><td data-num=\"69\"></td><td><pre> <span class=\"token operator\">*</span> <span class=\"token punctuation\">.</span>position<span class=\"token operator\">-</span><span class=\"token operator\">></span>事件的binlog位置作为字符串</pre></td></tr><tr><td data-num=\"70\"></td><td><pre> <span class=\"token operator\">*</span> <span class=\"token punctuation\">.</span>timestamp<span class=\"token operator\">-</span><span class=\"token operator\">></span>以<span class=\"token constant\">UTC</span>秒为单位的行时间戳</pre></td></tr><tr><td data-num=\"71\"></td><td><pre> <span class=\"token operator\">*</span> <span class=\"token punctuation\">.</span>heartbeat<span class=\"token operator\">-</span><span class=\"token operator\">></span>发送心跳的时间戳，以utc毫秒为单位</pre></td></tr><tr><td data-num=\"72\"></td><td><pre> <span class=\"token operator\">*</span> <span class=\"token operator\">/</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre></pre></td></tr><tr><td data-num=\"74\"></td><td><pre><span class=\"token keyword\">function</span> <span class=\"token function\">process_heartbeat</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">heartbeat</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>\tlogger<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span>heartbeat<span class=\"token punctuation\">.</span>position<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>\tlogger<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span>heartbeat<span class=\"token punctuation\">.</span>timestamp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>\tlogger<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span>heartbeat<span class=\"token punctuation\">.</span>heartbeat<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h3 id=\"formatting\"><a class=\"anchor\" href=\"#formatting\">#</a> formatting</h3>\n<ul>\n<li>\n<p><strong>output_ddl</strong></p>\n<p>是否在输出的 json 流中，包含 ddl 语句。默认 false</p>\n</li>\n<li>\n<p><strong>output_binlog_position</strong><br />\n 是否在输出的 json 流中，包含 binlog filename:postion。默认 false</p>\n</li>\n<li>\n<p><strong>output_commit_info</strong><br />\n 是否在输出的 json 流里面，包含 commit 和 xid 信息。默认 true<br />\n 比如一个事物里，包含多个表的变更，或一个表上多条数据的变更，那么他们都具有相同的 xid，最后一个 row event 输出 commit:true 字段。这有利于消费者实现 事务回放，而不仅仅是行级别的回放。</p>\n</li>\n<li>\n<p><strong>output_thread_id</strong></p>\n<p>同样，binlog 里面也包含了 thread_id ，可以包含在输出中。默认 false<br />\n 消费者可以用它来实现更粗粒度的事务回放。还有一个场景是用户审计，用户每次登陆之后将登陆 ip、登陆时间、用户名、thread_id 记录到一个表中，可轻松根据 thread_id 关联到 binlog 里面这条记录是哪个用户修改的。</p>\n</li>\n</ul>\n<h3 id=\"init_position\"><a class=\"anchor\" href=\"#init_position\">#</a> init_position</h3>\n<blockquote>\n<p>手动指定 maxwell 要从哪个 binlog，哪个位置开始。指定的格式 FILE:POSITION:HEARTBEAT。只支持在启动 maxwell 的命令指定，比如 --init_postion=mysql-bin.0000456:4:0。<br />\nmaxwell 默认从连接上 mysql server 的当前位置开始解析，如果指定 init_postion，要确保文件确实存在，如果 binlog 已经被 purge 掉了，可能需要想其它办法。<span class=\"exturl\" data-url=\"aHR0cDovL3NlYW5sb29rLmNvbS8yMDE4LzAxLzEzL21heHdlbGwtYmlubG9nL3h4\">见 Binlog 可视化搜索：实现类似阿里 RDS 数据追踪功能</span></p>\n</blockquote>\n<p><strong>指定 --init_postion=mysql.bin.00001:xxx，<em>报错 EventDataDeserializationException: Failed to deserialize data of EventHeaderV4，当我另起一个 maxwell 指点之前的 binlog postion 开始解析，却有没有抛异常。事后的数据也表明并没有数据丢失</em>。</strong></p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>com.github.shyiko.mysql.binlog.event.deserialization.EventDataDeserializationException: Failed to deserialize data of EventHeaderV4<span class=\"token punctuation\">&#123;</span>timestamp<span class=\"token operator\">=</span><span class=\"token number\">1584948956000</span>, <span class=\"token assign-left variable\">eventType</span><span class=\"token operator\">=</span>EXT_WRITE_ROWS, <span class=\"token assign-left variable\">serverId</span><span class=\"token operator\">=</span><span class=\"token number\">1</span>, <span class=\"token assign-left variable\">headerLength</span><span class=\"token operator\">=</span><span class=\"token number\">19</span>, <span class=\"token assign-left variable\">dataLength</span><span class=\"token operator\">=</span><span class=\"token number\">28</span>, <span class=\"token assign-left variable\">nextPosition</span><span class=\"token operator\">=</span><span class=\"token number\">881252</span>, <span class=\"token assign-left variable\">flags</span><span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>\tat com.github.shyiko.mysql.binlog.event.deserialization.EventDeserializer.deserializeEventData<span class=\"token punctuation\">(</span>EventDeserializer.java:300<span class=\"token punctuation\">)</span> ~<span class=\"token punctuation\">[</span>mysql-binlog-connector-java-0.20.0.jar:0.20.0<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\tat com.github.shyiko.mysql.binlog.event.deserialization.EventDeserializer.nextEvent<span class=\"token punctuation\">(</span>EventDeserializer.java:223<span class=\"token punctuation\">)</span> ~<span class=\"token punctuation\">[</span>mysql-binlog-connector-java-0.20.0.jar:0.20.0<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tat com.github.shyiko.mysql.binlog.BinaryLogClient.listenForEventPackets<span class=\"token punctuation\">(</span>BinaryLogClient.java:954<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span>mysql-binlog-connector-java-0.20.0.jar:0.20.0<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\tat com.github.shyiko.mysql.binlog.BinaryLogClient.connect<span class=\"token punctuation\">(</span>BinaryLogClient.java:581<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span>mysql-binlog-connector-java-0.20.0.jar:0.20.0<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\tat com.github.shyiko.mysql.binlog.BinaryLogClient<span class=\"token variable\">$7</span>.run<span class=\"token punctuation\">(</span>BinaryLogClient.java:857<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span>mysql-binlog-connector-java-0.20.0.jar:0.20.0<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\tat java.lang.Thread.run<span class=\"token punctuation\">(</span>Thread.java:748<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span>?:1.8.0_231<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>Caused by: com.github.shyiko.mysql.binlog.event.deserialization.MissingTableMapEventException: No TableMapEventData has been found <span class=\"token keyword\">for</span> table id:316. Usually that means that you have started reading binary log <span class=\"token string\">'within the logical event group'</span> <span class=\"token punctuation\">(</span>e.g. from WRITE_ROWS and not proceeding TABLE_MAP</pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token comment\"># 查询日志文件的位置</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>mysql<span class=\"token operator\">></span> show binlog events <span class=\"token keyword\">in</span> <span class=\"token string\">'mysql-bin.000002'</span> from <span class=\"token number\">61012</span> limit <span class=\"token number\">10</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>+------------------+-------+----------------+-----------+-------------+-----------------------------------------+</pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token operator\">|</span> Log_name         <span class=\"token operator\">|</span> Pos   <span class=\"token operator\">|</span> Event_type     <span class=\"token operator\">|</span> Server_id <span class=\"token operator\">|</span> End_log_pos <span class=\"token operator\">|</span> Info                                    <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>+------------------+-------+----------------+-----------+-------------+-----------------------------------------+</pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token operator\">|</span> mysql-bin.000002 <span class=\"token operator\">|</span> <span class=\"token number\">61012</span> <span class=\"token operator\">|</span> Xid            <span class=\"token operator\">|</span>         <span class=\"token number\">1</span> <span class=\"token operator\">|</span>       <span class=\"token number\">61043</span> <span class=\"token operator\">|</span> COMMIT /* <span class=\"token assign-left variable\">xid</span><span class=\"token operator\">=</span><span class=\"token number\">40</span> */                     <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token operator\">|</span> mysql-bin.000002 <span class=\"token operator\">|</span> <span class=\"token number\">61043</span> <span class=\"token operator\">|</span> Anonymous_Gtid <span class=\"token operator\">|</span>         <span class=\"token number\">1</span> <span class=\"token operator\">|</span>       <span class=\"token number\">61108</span> <span class=\"token operator\">|</span> SET @@<span class=\"token environment constant\">SESSION</span>.GTID_NEXT<span class=\"token operator\">=</span> <span class=\"token string\">'ANONYMOUS'</span>    <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token operator\">|</span> mysql-bin.000002 <span class=\"token operator\">|</span> <span class=\"token number\">61108</span> <span class=\"token operator\">|</span> Query          <span class=\"token operator\">|</span>         <span class=\"token number\">1</span> <span class=\"token operator\">|</span>       <span class=\"token number\">61186</span> <span class=\"token operator\">|</span> BEGIN                                   <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token operator\">|</span> mysql-bin.000002 <span class=\"token operator\">|</span> <span class=\"token number\">61186</span> <span class=\"token operator\">|</span> Table_map      <span class=\"token operator\">|</span>         <span class=\"token number\">1</span> <span class=\"token operator\">|</span>       <span class=\"token number\">61296</span> <span class=\"token operator\">|</span> table_id: <span class=\"token number\">156</span> <span class=\"token punctuation\">(</span>sampledata.uas_corp_reg<span class=\"token punctuation\">)</span> <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token operator\">|</span> mysql-bin.000002 <span class=\"token operator\">|</span> <span class=\"token number\">61296</span> <span class=\"token operator\">|</span> Delete_rows    <span class=\"token operator\">|</span>         <span class=\"token number\">1</span> <span class=\"token operator\">|</span>       <span class=\"token number\">63469</span> <span class=\"token operator\">|</span> table_id: <span class=\"token number\">156</span> flags: STMT_END_F         <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token operator\">|</span> mysql-bin.000002 <span class=\"token operator\">|</span> <span class=\"token number\">63469</span> <span class=\"token operator\">|</span> Xid            <span class=\"token operator\">|</span>         <span class=\"token number\">1</span> <span class=\"token operator\">|</span>       <span class=\"token number\">63500</span> <span class=\"token operator\">|</span> COMMIT /* <span class=\"token assign-left variable\">xid</span><span class=\"token operator\">=</span><span class=\"token number\">42</span> */                     <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token operator\">|</span> mysql-bin.000002 <span class=\"token operator\">|</span> <span class=\"token number\">63500</span> <span class=\"token operator\">|</span> Anonymous_Gtid <span class=\"token operator\">|</span>         <span class=\"token number\">1</span> <span class=\"token operator\">|</span>       <span class=\"token number\">63565</span> <span class=\"token operator\">|</span> SET @@<span class=\"token environment constant\">SESSION</span>.GTID_NEXT<span class=\"token operator\">=</span> <span class=\"token string\">'ANONYMOUS'</span>    <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token operator\">|</span> mysql-bin.000002 <span class=\"token operator\">|</span> <span class=\"token number\">63565</span> <span class=\"token operator\">|</span> Query          <span class=\"token operator\">|</span>         <span class=\"token number\">1</span> <span class=\"token operator\">|</span>       <span class=\"token number\">63643</span> <span class=\"token operator\">|</span> BEGIN                                   <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token operator\">|</span> mysql-bin.000002 <span class=\"token operator\">|</span> <span class=\"token number\">63643</span> <span class=\"token operator\">|</span> Table_map      <span class=\"token operator\">|</span>         <span class=\"token number\">1</span> <span class=\"token operator\">|</span>       <span class=\"token number\">63780</span> <span class=\"token operator\">|</span> table_id: <span class=\"token number\">158</span> <span class=\"token punctuation\">(</span>sampledata.work_deal<span class=\"token punctuation\">)</span>    <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token operator\">|</span> mysql-bin.000002 <span class=\"token operator\">|</span> <span class=\"token number\">63780</span> <span class=\"token operator\">|</span> Delete_rows    <span class=\"token operator\">|</span>         <span class=\"token number\">1</span> <span class=\"token operator\">|</span>       <span class=\"token number\">71930</span> <span class=\"token operator\">|</span> table_id: <span class=\"token number\">158</span>                           <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>+------------------+-------+----------------+-----------+-------------+-----------------------------------------+</pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token comment\">#测试可知当 Event_type 在 Xid 之前一个（delete_row,update_row,wirte_row）就会报错则会报错跳过该 event</span></pre></td></tr></table></figure><h2 id=\"数据初始化bootstrap引导操作\"><a class=\"anchor\" href=\"#数据初始化bootstrap引导操作\">#</a> 数据初始化（bootstrap 引导操作）</h2>\n<blockquote>\n<p>Maxwell 启动后将从 maxwell 库中获取上一次停止时 position, 从该断点处开始读取 binlog. 如果 binlog 已经清除了，那么怎样可以通过 maxwell 把整张表都复制出来呢？也就是数据初始化该怎么做？</p>\n</blockquote>\n<p>针对数据初始化的问题，Maxwell 提供了一个命令工具 maxwell-bootstrap 帮助我们完成数据初始化，maxwell-bootstrap 是基于 SELECT * FROM table 的方式进行全量数据初始化，不会产生多余的 binlog！</p>\n<p><strong>这个工具有下面这些参数：</strong></p>\n<table>\n<thead>\n<tr>\n<th>参数</th>\n<th>说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>--log_level LOG_LEVEL</td>\n<td>日志级别（DEBUG, INFO, WARN or ERROR）</td>\n</tr>\n<tr>\n<td>--user USER</td>\n<td>mysql 用户名</td>\n</tr>\n<tr>\n<td>--password PASSWORD</td>\n<td>mysql 密码</td>\n</tr>\n<tr>\n<td>--host HOST</td>\n<td>mysql 地址</td>\n</tr>\n<tr>\n<td>--port PORT</td>\n<td>mysql 端口</td>\n</tr>\n<tr>\n<td>--database DATABASE</td>\n<td>要 bootstrap 的表所在的数据库</td>\n</tr>\n<tr>\n<td>--table TABLE</td>\n<td>要引导的表</td>\n</tr>\n<tr>\n<td>--where WHERE_CLAUSE</td>\n<td>设置过滤条件</td>\n</tr>\n<tr>\n<td>--client_id CLIENT_ID</td>\n<td>指定执行引导操作的 Maxwell 实例</td>\n</tr>\n</tbody>\n</table>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># maxwell-bootstrap 命令</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>bin/maxwell-bootstrap --user maxwell  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    --password maxwell <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    --host <span class=\"token number\">127.0</span>.0.1  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    --database sampledata <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    --table <span class=\"token builtin class-name\">test</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    --client_id maxwell  <span class=\"token comment\"># 默认 client_id=maxwell</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token comment\"># 在 `maxwell.bootstrap` 表中插入记录，手动触发</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>INSERT INTO maxwell.bootstrap <span class=\"token punctuation\">(</span>database_name, table_name,where_clause<span class=\"token punctuation\">)</span> VALUES <span class=\"token punctuation\">(</span><span class=\"token string\">'test'</span>, <span class=\"token string\">'tb2'</span>,<span class=\"token string\">'1=1'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token comment\"># 在运行 maxwell</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>bin/maxwell --config config.properties</pre></td></tr></table></figure><p><strong>kafka 消费者日志</strong></p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">&#123;</span><span class=\"token string\">\"database\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"sampledata\"</span>,<span class=\"token string\">\"table\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"tb3\"</span>,<span class=\"token string\">\"type\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"bootstrap-start\"</span>,<span class=\"token string\">\"ts\"</span>:1585033656,<span class=\"token string\">\"data\"</span>:<span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span><span class=\"token string\">\"database\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"sampledata\"</span>,<span class=\"token string\">\"table\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"tb3\"</span>,<span class=\"token string\">\"type\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"bootstrap-insert\"</span>,<span class=\"token string\">\"ts\"</span>:1585033656,<span class=\"token string\">\"data\"</span>:<span class=\"token punctuation\">&#123;</span><span class=\"token string\">\"a\"</span>:1,<span class=\"token string\">\"b\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"2\"</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#123;</span><span class=\"token string\">\"database\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"sampledata\"</span>,<span class=\"token string\">\"table\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"tb3\"</span>,<span class=\"token string\">\"type\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"bootstrap-insert\"</span>,<span class=\"token string\">\"ts\"</span>:1585033656,<span class=\"token string\">\"data\"</span>:<span class=\"token punctuation\">&#123;</span><span class=\"token string\">\"a\"</span>:2,<span class=\"token string\">\"b\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"2\"</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">&#123;</span><span class=\"token string\">\"database\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"sampledata\"</span>,<span class=\"token string\">\"table\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"tb3\"</span>,<span class=\"token string\">\"type\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"bootstrap-insert\"</span>,<span class=\"token string\">\"ts\"</span>:1585033656,<span class=\"token string\">\"data\"</span>:<span class=\"token punctuation\">&#123;</span><span class=\"token string\">\"a\"</span>:3,<span class=\"token string\">\"b\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"2\"</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\">#若主键相同 bootstrap 将其覆盖</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">&#123;</span><span class=\"token string\">\"database\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"sampledata\"</span>,<span class=\"token string\">\"table\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"tb3\"</span>,<span class=\"token string\">\"type\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"bootstrap-insert\"</span>,<span class=\"token string\">\"ts\"</span>:1584932007,<span class=\"token string\">\"data\"</span>:<span class=\"token punctuation\">&#123;</span><span class=\"token string\">\"a\"</span>:10,<span class=\"token string\">\"b\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"10\"</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">&#123;</span><span class=\"token string\">\"database\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"sampledata\"</span>,<span class=\"token string\">\"table\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"tb3\"</span>,<span class=\"token string\">\"type\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"bootstrap-complete\"</span>,<span class=\"token string\">\"ts\"</span>:1585033657,<span class=\"token string\">\"data\"</span>:<span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>是 bootstrap-insert，便是 sampledata.tb3 的 binlog 数据了</p>\n<p>Bootstrap 的过程是 <strong>bootstrap-start -&gt; bootstrap-insert -&gt; bootstrap-complete</strong>，其中，start 和 complete 的 data 字段为空，不携带数据。</p>\n<p><em>在进行 bootstrap 过程中，如果 maxwell 崩溃，重启时，bootstrap 会完全重新开始，不管之前进行到多少，若不希望这样，可以到数据库中设置 is_complete 字段值为 1 (表示完成)，或者删除该行</em></p>\n<p><strong>控制台输出</strong></p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 增量输出</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span><span class=\"token string\">\"database\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"sampledata\"</span>,<span class=\"token string\">\"table\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"tb1\"</span>,<span class=\"token string\">\"type\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"insert\"</span>,<span class=\"token string\">\"ts\"</span>:1584672522,<span class=\"token string\">\"xid\"</span>:18003,<span class=\"token string\">\"commit\"</span>:true,<span class=\"token string\">\"data\"</span>:<span class=\"token punctuation\">&#123;</span><span class=\"token string\">\"a\"</span>:1,<span class=\"token string\">\"b\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"a\"</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#123;</span><span class=\"token string\">\"database\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"sampledata\"</span>,<span class=\"token string\">\"table\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"tb1\"</span>,<span class=\"token string\">\"type\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"insert\"</span>,<span class=\"token string\">\"ts\"</span>:1584672522,<span class=\"token string\">\"xid\"</span>:18004,<span class=\"token string\">\"commit\"</span>:true,<span class=\"token string\">\"data\"</span>:<span class=\"token punctuation\">&#123;</span><span class=\"token string\">\"a\"</span>:2,<span class=\"token string\">\"b\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"b\"</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><strong>输出参数说明</strong></p>\n<ul>\n<li>\n<p>data，最新的数据，修改后的数据</p>\n</li>\n<li>\n<p>old，旧数据，修改前的数据</p>\n</li>\n<li>\n<p>type，操作类型，有 insert, update, delete, database-create, database-alter, database-drop, table-create, table-alter, table-drop，bootstrap-insert，int (未知类型)</p>\n</li>\n<li>\n<p>xid，事务 id</p>\n</li>\n<li>\n<p>commit，同一个 xid 代表同一个事务，事务的最后一条语句会有 commit，可以利用这个重现事务</p>\n</li>\n<li>\n<p>server_id，thread_id，</p>\n</li>\n</ul>\n<h2 id=\"monitoring\"><a class=\"anchor\" href=\"#monitoring\">#</a> monitoring</h2>\n<blockquote>\n<p>如果是长时间运行的 maxwell，添加 monitor 配置，maxwell 提供了 http api 返回监控数据。</p>\n</blockquote>\n<ul>\n<li>\n<p>metrics_type=http</p>\n</li>\n<li>\n<p>metrics_jvm=true --http_port=8080</p>\n</li>\n</ul>\n<h2 id=\"maxwell多实例\"><a class=\"anchor\" href=\"#maxwell多实例\">#</a> maxwell 多实例</h2>\n<blockquote>\n<p>​      在不同的配置下，Maxwell 可以在同一个主服务器上运行多个实例。如果希望让生产者以不同的配置运行，例如将来自不同组的表 (table) 的事件投递到不同的 Topic 中，这将非常有用。Maxwell 的每个实例都必须配置一个唯一的 client_id，以便区分的 binlog 位置。</p>\n</blockquote>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> * from positions<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>+-----------+------------------+-----------------+----------+-----------+--------------+---------------------+</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token operator\">|</span> server_id <span class=\"token operator\">|</span> binlog_file      <span class=\"token operator\">|</span> binlog_position <span class=\"token operator\">|</span> gtid_set <span class=\"token operator\">|</span> client_id <span class=\"token operator\">|</span> heartbeat_at <span class=\"token operator\">|</span> last_heartbeat_read <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>+-----------+------------------+-----------------+----------+-----------+--------------+---------------------+</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token operator\">|</span>         <span class=\"token number\">1</span> <span class=\"token operator\">|</span> mysql-bin.000001 <span class=\"token operator\">|</span>         <span class=\"token number\">4323504</span> <span class=\"token operator\">|</span> NULL     <span class=\"token operator\">|</span> maxwell   <span class=\"token operator\">|</span>         NULL <span class=\"token operator\">|</span>       <span class=\"token number\">1585040020604</span> <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token operator\">|</span>         <span class=\"token number\">1</span> <span class=\"token operator\">|</span> mysql-bin.000001 <span class=\"token operator\">|</span>         <span class=\"token number\">5897218</span> <span class=\"token operator\">|</span> NULL     <span class=\"token operator\">|</span> maxwell1 <span class=\"token operator\">|</span>         NULL <span class=\"token operator\">|</span>       <span class=\"token number\">1585063941753</span> <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>+-----------+------------------+-----------------+----------+-----------+--------------+---------------------+</pre></td></tr></table></figure><h2 id=\"maxwell-分区\"><a class=\"anchor\" href=\"#maxwell-分区\">#</a> maxwell 分区</h2>\n<blockquote>\n<p>Kafka 和 AWS Kinesis 都支持分区流的概念。分区由来控制 <code>producer_partition_by</code> ，它使您可以选择按数据库，表，主键或列数据拆分流。您如何选择分区将影响 maxwell 流的使用者</p>\n</blockquote>\n<p>在 <code>Maxwell</code>  官网查文档得知，在 <code>Maxwell</code>  没有配置的情况下，默认使用数据库名 database 作为计算分区的 key，并使用 Java 默认的 hashcode 算法进行计算，项目中 <code>maxwell</code>  的 binlog 就是单个 database，所以会造成数据倾斜</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>HASH_FUNCTION<span class=\"token punctuation\">(</span>HASH_STRING<span class=\"token punctuation\">)</span> % TOPIC.NUMBER_OF_PARTITIONS</pre></td></tr></table></figure><p>maxwell 有一个参数是–producer_partition_by，在不指定的情况下默认是 database，意思是数据推送到 kafka 时，数据被根据数据库进行 hash，同一个库的数据会被放在同一个 partition 中，这个参数有三个值：<br />\ndatabase、table、primary_key</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#murmurhash3 hash 算法</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>--kafka_partition_hash<span class=\"token operator\">=</span>murmur3</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># Rowkey 作为分区 key</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>--producer_partition_by<span class=\"token operator\">=</span>primary_key</pre></td></tr></table></figure><h2 id=\"maxwell高可用未实现\"><a class=\"anchor\" href=\"#maxwell高可用未实现\">#</a> maxwell 高可用（未实现）</h2>\n<p>​       通过 zookeeper 实现高可用，修改一下 maxwell 源码，启动的时候到 zk 里注册一个临时结点，注册监听，节点挂了就重启 Maxwell 或者其他操作</p>\n<p>​\t<span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL3plbmRlc2svbWF4d2VsbC9pc3N1ZXMvMjQ4\">Maxwell / MySQL 高可用性设置</span></p>\n<h2 id=\"注意事项\"><a class=\"anchor\" href=\"#注意事项\">#</a> 注意事项</h2>\n<p><strong>1 timestamp column</strong></p>\n<p>​\t\tmaxwell 对时间类型（datetime, timestamp, date）都是当做字符串处理的，这也是为了保证数据一致 (比如 0000-00-00 00:00:00 这样的时间在 timestamp 里是非法的，但 mysql 却认，解析成 java 或者 python 类型就是 null/None)。</p>\n<p>如果 MySQL 表上的字段是 timestamp 类型，是有时区的概念 <strong>binlog 解析出来的是标准 UTC 时间</strong></p>\n<p><strong>2 binary column</strong></p>\n<p>​       maxwell 可以处理 binary 类型的列，如 blob、varbinary，它的做法就是对二进制列使用  <code>base64_encode</code> ，当做字符串输出到 json。消费者拿到这个列数据后，不能直接拼装，需要  <code>base64_decode</code> 。</p>\n<h1 id=\"bireme增量\"><a class=\"anchor\" href=\"#bireme增量\">#</a> bireme (增量)</h1>\n<blockquote>\n<p>运行 bireme 环境</p>\n<ul>\n<li>JAVA_HOME</li>\n<li>yun install jsvc</li>\n</ul>\n</blockquote>\n<p>Bireme 是用于 Greenplum / HashData 数据仓库的 ** <code>增量</code>  ** 同步工具。目前，它支持 MySQL，PostgreSQL 和 MongoDB 数据源。</p>\n<p><span class=\"exturl\" data-url=\"aHR0cDovL2dyZWVucGx1bS5vcmcv\">Greenplum</span> 是一个高级的，功能齐全的开源数据仓库，可对 PB 数据量进行强大而快速的分析。它是面向大数据分析的唯一对象，并且得到了世界上最先进的基于成本的查询优化器的支持。它可以对大量数据提供高查询性能。</p>\n<p><span class=\"exturl\" data-url=\"aHR0cDovL3d3dy5oYXNoZGF0YS5jbi8=\">HashData</span> 是基于 Greenplum 构建的灵活的云数据仓库。</p>\n<p>Bireme 使用 DELETE + COPY 将数据源的修改记录同步到 Greenplum / HashData。此模式比 INSERT + UPDATE + DELETE 更快更好。</p>\n<p>功能和限制：</p>\n<ul>\n<li>使用小批量加载来增强数据同步的性能。默认的加载延迟时间是 10 秒。</li>\n<li>所有表在目标数据库中必须具有主键。</li>\n</ul>\n<p>使用这个版本<span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL0hhc2hEYXRhSW5jL2JpcmVtZS9yZWxlYXNlcw==\"> bireme</span>  （bireme 的 jar 包不在路径里）这个使用会报错：**Cannot find daemon loader org/apache/commons/daemon/support/DaemonLoader **</p>\n<p>所以使用编译好的<span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL0hhc2hEYXRhSW5jL2JpcmVtZS9yZWxlYXNlcy9kb3dubG9hZC92Mi4wLjAtYWxwaGEtMS9iaXJlbWUtMi4wLjAtYWxwaGEtMS50YXIuZ3o=\"> v2.0.0-alpha-1</span></p>\n<h2 id=\"bireme如何工作\"><a class=\"anchor\" href=\"#bireme如何工作\">#</a> bireme 如何工作</h2>\n<p>Bireme 从数据源读取记录，然后将它们传递到单独的管道中。在每个管道中，bireme 会将其转换为内部格式并对其进行缓存。当缓存的记录达到一定数量时，它们将合并为一个任务。每个任务包含两个集合，<em>删除</em> 集合和<em>插入</em>集合。最后，它将记录更新到目标数据库。</p>\n<p>每个数据源可能具有多个管道。对于 maxwell，每个 Kafka 分区对应一个管道，对于 debezium，每个 Kafka 主题对应一个管道。</p>\n<p><img data-src=\"https://raw.githubusercontent.com/HashDataInc/bireme/master/docs/bireme.png\" alt=\"\" /></p>\n<p>下图描述了如何在管道中处理更改数据。</p>\n<p><img data-src=\"https://raw.githubusercontent.com/HashDataInc/bireme/master/docs/bireme.png\" alt=\"管道\" /></p>\n<h2 id=\"配置文件简介\"><a class=\"anchor\" href=\"#配置文件简介\">#</a> 配置文件简介</h2>\n<p>配置文件包括两部分：</p>\n<ul>\n<li>基本配置文件：默认为<strong> config.properties</strong>，其中包含 bireme 的基本配置。</li>\n<li>表映射文件：** .properties**。每个数据源都对应一个文件，该文件指定要同步的表以及目标数据库中的对应表。&lt;source_name&gt; 在 config.properties 文件中指定。</li>\n</ul>\n<h3 id=\"configproperties\"><a class=\"anchor\" href=\"#configproperties\">#</a> config.properties</h3>\n<p><strong>必要参数</strong></p>\n<table>\n<thead>\n<tr>\n<th>参量</th>\n<th>描述</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>target.url</td>\n<td>目标数据库的地址。格式： jdbc：postgresql：// &lt;ip&gt;：&lt; 端口 &gt; / &lt; 数据库 &gt;</td>\n</tr>\n<tr>\n<td>target.user</td>\n<td>用于连接到目标数据库的用户名</td>\n</tr>\n<tr>\n<td>target.passwd</td>\n<td>用于连接到目标数据库的密码</td>\n</tr>\n<tr>\n<td>data.source</td>\n<td>指定数据源为 &lt;source_name&gt;，并用逗号分隔多个数据源，忽略空格</td>\n</tr>\n<tr>\n<td>&lt;source_name&gt; .type</td>\n<td>指定数据源的类型，例如 maxwell</td>\n</tr>\n</tbody>\n</table>\n<p>** 注意：** 数据源名称只是为了方便起见。可以根据需要进行修改。</p>\n<p><strong>Maxwell 数据源的参数</strong></p>\n<table>\n<thead>\n<tr>\n<th>参量</th>\n<th>描述</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>&lt;source_name&gt; .kafka.server</td>\n<td>Kafka 地址。格式： &lt;ip&gt;：&lt;port&gt;</td>\n</tr>\n<tr>\n<td>&lt;source_name&gt; .kafka.topic</td>\n<td>数据源对应主题</td>\n</tr>\n<tr>\n<td>&lt;source_name&gt; .kafka.groupid</td>\n<td>kafka 消费者组 ID。默认值为<em> bireme</em></td>\n</tr>\n</tbody>\n</table>\n<p><strong>其他参数</strong></p>\n<table>\n<thead>\n<tr>\n<th>参量</th>\n<th>描述</th>\n<th>默认</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>pipeline.thread_pool.size</td>\n<td>管道的线程池大小</td>\n<td>5</td>\n</tr>\n<tr>\n<td>transform.thread_pool.size</td>\n<td>转换的线程池大小</td>\n<td>10</td>\n</tr>\n<tr>\n<td>merge.thread_pool.size</td>\n<td>合并的线程池大小</td>\n<td>10</td>\n</tr>\n<tr>\n<td>merge.interval</td>\n<td>合并之间的最大间隔（以毫秒为单位）</td>\n<td>10000</td>\n</tr>\n<tr>\n<td>merge.batch.size</td>\n<td>一次合并的最大行数</td>\n<td>50000</td>\n</tr>\n<tr>\n<td>loader.conn_pool.size</td>\n<td>与目标数据库的连接数，小于或等于变更装入程序的数量</td>\n<td>10</td>\n</tr>\n<tr>\n<td>loader.task_queue.size</td>\n<td>每个变更加载器中任务队列的长度</td>\n<td>2</td>\n</tr>\n<tr>\n<td>metrics.reporter</td>\n<td>Bireme 指定两种监视模式，即 consolo 或 jmx。如果不需要监视，则可以将其指定为 none</td>\n<td>jmx</td>\n</tr>\n<tr>\n<td>metrics.reporter.console.interval</td>\n<td>指标输出之间的时间间隔（以秒为单位）。只要 metrics.reporter 是控制台，它就有效</td>\n<td>10</td>\n</tr>\n<tr>\n<td>state.server.port</td>\n<td>状态服务器的端口</td>\n<td>8080</td>\n</tr>\n<tr>\n<td>state.server.addr</td>\n<td>状态服务器的 IP 地址</td>\n<td>0.0.0.0</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"source_name-properties\"><a class=\"anchor\" href=\"#source_name-properties\">#</a> source_name&gt; .properties</h3>\n<p>在每个数据源的配置文件中，指定数据源包括的表以及目标数据库中的对应表。</p>\n<pre><code>&lt;database&gt;.&lt;OriginTable_1&gt; = &lt;schema&gt;.&lt;MappedTable_1&gt;\n&lt;database&gt;.&lt;OriginTable_2&gt; = &lt;schema&gt;.&lt;MappedTable_2&gt;\n...\n</code></pre>\n<h2 id=\"快速操作\"><a class=\"anchor\" href=\"#快速操作\">#</a> 快速操作</h2>\n<p>因为 bireme 的 jar 包不在路径里，直接下载编译好的<span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL0hhc2hEYXRhSW5jL2JpcmVtZS9yZWxlYXNlcy9kb3dubG9hZC92Mi4wLjAtYWxwaGEtMS9iaXJlbWUtMi4wLjAtYWxwaGEtMS50YXIuZ3o=\"> bireme</span> 包</p>\n<ol>\n<li>\n<p>下载<span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL0hhc2hEYXRhSW5jL2JpcmVtZS9yZWxlYXNlcy9kb3dubG9hZC92Mi4wLjAtYWxwaGEtMS9iaXJlbWUtMi4wLjAtYWxwaGEtMS50YXIuZ3o=\"> bireme</span></p>\n</li>\n<li>\n<p>解压： tar xf bireme bireme-2.0.0-alpha-1.tar.gz</p>\n</li>\n<li>\n<p>修改配置文件 vim etc/config.properties  etc/maxwell.properties</p>\n</li>\n</ol>\n<figure class=\"highlight properties\"><figcaption data-lang=\".properties\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># etc/config.propertis</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token attr-name\">target.url</span> <span class=\"token punctuation\">=</span> <span class=\"token attr-value\">jdbc:postgresql://10.34.11.141:2345/postgres</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token attr-name\">target.user</span> <span class=\"token punctuation\">=</span> <span class=\"token attr-value\">pentaho_user</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token attr-name\">target.passwd</span> <span class=\"token punctuation\">=</span> <span class=\"token attr-value\">cloud.Zijin</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\"># data source name list, separated by comma.</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token attr-name\">data_source</span> <span class=\"token punctuation\">=</span> <span class=\"token attr-value\">maxwell1</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\"># data source name list, separated by comma.</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token attr-name\">data_source</span> <span class=\"token punctuation\">=</span> <span class=\"token attr-value\">maxwell1</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token comment\"># data source \"mysql1\" type</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token attr-name\">maxwell1.type</span> <span class=\"token punctuation\">=</span> <span class=\"token attr-value\">maxwell</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token comment\"># kafka server which maxwell write binlog into.</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token attr-name\">maxwell1.kafka.server</span> <span class=\"token punctuation\">=</span> <span class=\"token attr-value\">hdp-s-1.data.dc.zjft.com:6667</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token comment\"># kafka topic which maxwell write binlog into.</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token attr-name\">maxwell1.kafka.topic</span> <span class=\"token punctuation\">=</span> <span class=\"token attr-value\">maxwell</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token comment\"># kafka groupid used for consumer.</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token attr-name\">maxwell1.kafka.groupid</span> <span class=\"token punctuation\">=</span> <span class=\"token attr-value\">bireme</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token comment\"># set the IP address for bireme state server.</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token attr-name\">state.server.addr</span> <span class=\"token punctuation\">=</span> <span class=\"token attr-value\">0.0.0.0</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token comment\"># set the port for bireme state server.</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token attr-name\">state.server.port</span> <span class=\"token punctuation\">=</span> <span class=\"token attr-value\">8080</span></pre></td></tr></table></figure><p><strong>maxwell1.properties</strong></p>\n<figure class=\"highlight properties\"><figcaption data-lang=\".properties\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># etc/maxwell.properties</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token attr-name\">test.tb1</span> <span class=\"token punctuation\">=</span> <span class=\"token attr-value\">public.tb1</span></pre></td></tr></table></figure><p><strong>若 postgres 表不存在则</strong>：cn.hashdata.bireme.BiremeException: Greenplum table and MySQL table size are inconsistent!*</p>\n<ol start=\"4\">\n<li>在 postgres 建表</li>\n</ol>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">create</span> <span class=\"token keyword\">table</span> tb1<span class=\"token punctuation\">(</span>a <span class=\"token keyword\">int</span><span class=\"token punctuation\">,</span> b <span class=\"token keyword\">char</span><span class=\"token punctuation\">(</span><span class=\"token number\">11</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">primary</span> <span class=\"token keyword\">key</span><span class=\"token punctuation\">(</span>a<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">-- 字段需要和 mysql 一直否在报：字段不存在</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">-- 字段类型需要一直，否则同步到 postgres 中会忽略该字段</span></pre></td></tr></table></figure><ol start=\"5\">\n<li>\n<p>启动 bireme : bin/bireme start  （ stop| restart ）</p>\n</li>\n<li>\n<p>监听日志：tai l -f logs/bireme.out（ logs/bireme.err ）</p>\n</li>\n<li>\n<p>测试（查询 psotgres）</p>\n<pre><code class=\"language-sql\"></code></pre>\n</li>\n</ol>\n<p>select * from tb1;<br />\na  |     b<br />\n----+------------<br />\n3 | d<br />\n6 | 6<br />\n7 | 7<br />\n4 | 4<br />\n10 | 10<br />\n1 | 1<br />\n5 | 5</p>\n<pre><code>\n\n\n## 监控，http://127.0.0.1:8080/pretty \n\n**HTTP服务器**\n\nBireme启动轻型HTTP服务器以获取当前的加载状态。\n\n启动HTTP服务器时，将公开以下端点：\n\n| 终点       | 描述                       |\n| ---------- | -------------------------- |\n| /          | 获取所有数据源的加载状态。 |\n| / &lt;数据源&gt; | 获取给定数据源的加载状态。 |\n\n结果以JSON格式组织。使用参数*pretty*将打印出用户友好的结果。\n\n**例**\n\n以下是加载状态的示例：\n\n</code></pre>\n<p>{<br />\n&quot;source_name&quot;: &quot;maxwell1&quot;,<br />\n&quot;type&quot;: &quot;MAXWELL&quot;<br />\n&quot;pipelines&quot;: [<br />\n{<br />\n&quot;name&quot;: &quot;maxwell-1&quot;,<br />\n&quot;latest&quot;: &quot;1970-01-01T08:00:00.000Z&quot;,<br />\n&quot;delay&quot;: latest,<br />\n&quot;state&quot;: &quot;NORMAL&quot;<br />\n},<br />\n]<br />\n}</p>\n<pre><code>\n- *source_name*是在配置文件中指定的查询数据源的名称。\n- *type*是数据源的类型。\n- *管道*是一个数组，每个元素都对应一个管道。（每个数据源可能有几个单独的管道。）\n\n- *name*是管道的名称。\n- *最新*时间是已成功加载到哈希数据的最新更改数据的产生时间。\n- *延迟*是更改数据从输入双向到提交到数据源的时间段。\n- *状态*是管道的状态。\n\n## 优势和存在问题\n\n**优势**\n\n1、可以实现多个库表的汇总功能，syncdb1.tb1/syncdb2.tb1 可以汇总到pgsql的一张表tb1中\n2、中间使用kafka消息队列，对于大数据量性能方面提升较好\n\n\n**存在问题**\n\n1、maxwell会连接数据源库，生成maxwell库，用来存在相应binlog消费位点position信息，只能在数据源生成库\n2、第一次启动maxwell时，只能以当前的binlog position位点开始解析，事先需要先同步数据源数据库到目标数据库的一份全量数据\n\n## 实际操作\n\n&gt; 其他配置不变，只需要修改**maxwell1.properties**\n\n**maxwell1.properties**\n\n```properties\nusp_anyfix.work_type=usp_anyfix.work_type\nusp_anyfix.work_deal=usp_anyfix.work_deal\nusp_anyfix.device_branch=usp_anyfix.device_branch\nusp_anyfix.service_remote_way=usp_anyfix.service_remote_way\nusp_anyfix.fault_type=usp_anyfix.fault_type\nusp_anyfix.service_branch=usp_anyfix.service_branch\nusp_anyfix.work_request=usp_anyfix.work_request\n\n\nusp_uas.uas_user_info=usp_uas.uas_user_info\nusp_uas.sys_tenant=usp_uas.sys_tenant\nusp_uas.uas_cfg_area=usp_uas.uas_cfg_area\nusp_uas.uas_corp_reg=usp_uas.uas_corp_reg\nusp_uas.uas_user_real=usp_uas.uas_user_real\n\n\nusp_device.device_brand=usp_device.device_brand\nusp_device.device_info=usp_device.device_info\nusp_device.device_large_class=usp_device.device_large_class\nusp_device.device_model=usp_device.device_model\nusp_device.device_small_class=usp_device.device_small_class\nusp_device.device_specification=usp_device.device_specification\n\n</code></pre>\n<p><em>经测试发现，以下表无法识别</em></p>\n<p><em>cn.hashdata.bireme.BiremeException: Greenplum table and MySQL table size are inconsistent!</em></p>\n<figure class=\"highlight properties\"><figcaption data-lang=\".properties\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token attr-name\">usp_anyfix.work_type</span><span class=\"token punctuation\">=</span><span class=\"token attr-value\">usp_anyfix.work_type</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token attr-name\">usp_anyfix.work_deal</span><span class=\"token punctuation\">=</span><span class=\"token attr-value\">usp_anyfix.work_deal</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token attr-name\">usp_anyfix.device_branch</span><span class=\"token punctuation\">=</span><span class=\"token attr-value\">usp_anyfix.device_branch</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token attr-name\">usp_anyfix.service_remote_way</span><span class=\"token punctuation\">=</span><span class=\"token attr-value\">usp_anyfix.service_remote_way</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token attr-name\">usp_uas.uas_user_info</span><span class=\"token punctuation\">=</span><span class=\"token attr-value\">usp_uas.uas_user_info</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token attr-name\">usp_uas.sys_tenant</span><span class=\"token punctuation\">=</span><span class=\"token attr-value\">usp_uas.sys_tenant</span></pre></td></tr></table></figure><p><strong>未知原因</strong>： <em>表在 gp 中存在，而且修改表名，有些表名能识别，有些表名无法识别，</em></p>\n<h1 id=\"mysql2pgsql全量\"><a class=\"anchor\" href=\"#mysql2pgsql全量\">#</a> mysql2pgsql（全量）</h1>\n<blockquote>\n<p>由于 bireme 无法解析 bootsrap-maxwell 产生的 json，导致 bireme 无法通过 maxwell 实现 mysql 全量导入 gp</p>\n<p>所以可以泗洪 mysql2pasql 开源工具实现全量同步</p>\n</blockquote>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL2FsaXl1bi9yZHNfZGJzeW5jL3JlbGVhc2VzP3NwbT1hMmM0Zy4xMTE4NjYyMy4yLjQueU9QWUtk\">mysql2pgsql 开源文档</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL2FsaXl1bi9yZHNfZGJzeW5jL2Jsb2IvbWFzdGVyL2RvYy9teXNxbDJncC5tZA==\">mysql2pgsql 参数文档</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL2FsaXl1bi9yZHNfZGJzeW5jL2lzc3Vlcz9xPWlzJTNBaXNzdWUraXMlM0FjbG9zZWQ=\">mysql2pgsql 问题答疑</span></p>\n<h2 id=\"下载-mysql2pgsql\"><a class=\"anchor\" href=\"#下载-mysql2pgsql\">#</a> 下载 mysql2pgsql</h2>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">wget</span> https://github.com/aliyun/rds_dbsync/files/919279/mysql2pgsql.bin.el6.20170413.tar.gz</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># 解压</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">tar</span> -xzvf mysql2pgsql.bin.el6.20170413.tar.gz mysql2pgsql</pre></td></tr></table></figure><h2 id=\"配置mysql和gp连接信息配置文件\"><a class=\"anchor\" href=\"#配置mysql和gp连接信息配置文件\">#</a> 配置 mysql 和 gp 连接信息配置文件</h2>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token builtin class-name\">cd</span> mysql2pgsql</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">vi</span> my.cfg</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">## my.cfg</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">[</span>src.mysql<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token function\">host</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"10.34.12.185\"</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>port <span class=\"token operator\">=</span> <span class=\"token string\">\"3306\"</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>user <span class=\"token operator\">=</span> <span class=\"token string\">\"root\"</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>password <span class=\"token operator\">=</span> <span class=\"token string\">\"cloud.Zijin\"</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>db <span class=\"token operator\">=</span> <span class=\"token string\">\"usp_anyfix\"</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>encodingdir <span class=\"token operator\">=</span> <span class=\"token string\">\"share\"</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>encoding <span class=\"token operator\">=</span> <span class=\"token string\">\"utf8\"</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>serverid <span class=\"token operator\">=</span> <span class=\"token number\">10</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">[</span>desc.pgsql<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>connect_string <span class=\"token operator\">=</span> <span class=\"token string\">\"host=10.34.11.141 dbname=postgres port=2345 user=gpadmin password=cloud.Zijin\"</span></pre></td></tr></table></figure><h2 id=\"mysql2pgsql-用法\"><a class=\"anchor\" href=\"#mysql2pgsql-用法\">#</a> mysql2pgsql 用法</h2>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>./mysql2pgsql -l <span class=\"token operator\">&lt;</span>tables_list_file<span class=\"token operator\">></span> -d -n -j <span class=\"token operator\">&lt;</span>number of threads<span class=\"token operator\">></span> -s <span class=\"token operator\">&lt;</span>schema of target table<span class=\"token operator\">></span></pre></td></tr></table></figure><p><strong>参数说明</strong></p>\n<p *=\"\" 不添加参数默认同步所有表=\"\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mstyle mathcolor=\"red\"></mstyle></mrow><annotation encoding=\"application/x-tex\">\\color{red}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"></span></span></p>\n<ul>\n<li>\n<p>-l : 可选参数，指定一个文本文件，文件中含有需要同步的表；如果不指定此参数，则同步配置文件中指定数据库下的所有表。 <code>&lt;tables_list_file&gt; </code> 为一个文件名，里面含有需要同步的表集合以及表上查询的条件，其内容格式示例如下:</p>\n<figure class=\"highlight properties\"><figcaption data-lang=\".properties\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token attr-name\">table1</span> <span class=\"token punctuation\">:</span> <span class=\"token attr-value\">select * from table_big where column1 &lt; '2016-08-05'</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token attr-name\">table2</span> <span class=\"token attr-value\">: </span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>table3</pre></td></tr></table></figure></li>\n<li>\n<p>-d：可选参数，表示只生成目的表的建表 DDL 语句，不实际进行数据同步。</p>\n</li>\n<li>\n<p>-n：可选参数，需要与 - d 一起使用，指定在 DDL 语句中不包含表分区定义。</p>\n</li>\n<li>\n<p>-j：可选参数，指定使用多少线程进行数据同步；如果不指定此参数，会使用 5 个线程并发。</p>\n</li>\n<li>\n<p>-s：可选参数，指定目标表的 schema</p>\n</li>\n</ul>\n<h2 id=\"迁移maridb数据库\"><a class=\"anchor\" href=\"#迁移maridb数据库\">#</a> 迁移 maridb 数据库</h2>\n<ul>\n<li>\n<p>获取 maridb usp_anfyfix 所有表的 ddl</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>./mysql2pgsql -d</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># 获取 usp_anyfix 数据库所有表</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>-- Reference commands to create target tables <span class=\"token punctuation\">(</span>Please choose a distribution key and replace it with <span class=\"token operator\">&lt;</span>distribution key<span class=\"token operator\">></span> <span class=\"token keyword\">for</span> each table<span class=\"token punctuation\">)</span>: </pre></td></tr><tr><td data-num=\"4\"></td><td><pre>---------------</pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>CREATE TABLE __hr_org_dept <span class=\"token punctuation\">(</span>deptid text, name text, corpcode text, upperid text, upperid2 text, allupper text, deptlevelid text, bureaulevelid int4, hzcorp text<span class=\"token punctuation\">)</span> with <span class=\"token punctuation\">(</span>APPENDONLY<span class=\"token operator\">=</span>true, <span class=\"token assign-left variable\">ORIENTATION</span><span class=\"token operator\">=</span>column, <span class=\"token assign-left variable\">COMPRESSTYPE</span><span class=\"token operator\">=</span>zlib, <span class=\"token assign-left variable\">COMPRESSLEVEL</span><span class=\"token operator\">=</span><span class=\"token number\">1</span>, <span class=\"token assign-left variable\">BLOCKSIZE</span><span class=\"token operator\">=</span><span class=\"token number\">1048576</span>, <span class=\"token assign-left variable\">OIDS</span><span class=\"token operator\">=</span>false<span class=\"token punctuation\">)</span> DISTRIBUTED BY <span class=\"token punctuation\">(</span><span class=\"token operator\">&lt;</span>distribution key<span class=\"token operator\">></span><span class=\"token punctuation\">)</span> PARTITION BY RANGE <span class=\"token punctuation\">(</span><span class=\"token operator\">&lt;</span>partition key<span class=\"token operator\">></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span>START <span class=\"token punctuation\">(</span>date <span class=\"token string\">'&lt;YYYY-MM-DD>'</span><span class=\"token punctuation\">)</span> INCLUSIVE END <span class=\"token punctuation\">(</span>date <span class=\"token string\">'&lt;YYYY-MM-DD>'</span><span class=\"token punctuation\">)</span> EXCLUSIVE EVERY <span class=\"token punctuation\">(</span>INTERVAL <span class=\"token string\">'&lt;1 month>'</span> <span class=\"token punctuation\">))</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>CREATE TABLE custom_field <span class=\"token punctuation\">(</span>field_id int8, field_name text, field_type int4, required text, form_type int4, common text, corp_id int8, operator int8, operate_time timestamp<span class=\"token punctuation\">)</span> with <span class=\"token punctuation\">(</span>APPENDONLY<span class=\"token operator\">=</span>true, <span class=\"token assign-left variable\">ORIENTATION</span><span class=\"token operator\">=</span>column, <span class=\"token assign-left variable\">COMPRESSTYPE</span><span class=\"token operator\">=</span>zlib, <span class=\"token assign-left variable\">COMPRESSLEVEL</span><span class=\"token operator\">=</span><span class=\"token number\">1</span>, <span class=\"token assign-left variable\">BLOCKSIZE</span><span class=\"token operator\">=</span><span class=\"token number\">1048576</span>, <span class=\"token assign-left variable\">OIDS</span><span class=\"token operator\">=</span>false<span class=\"token punctuation\">)</span> DISTRIBUTED BY <span class=\"token punctuation\">(</span><span class=\"token operator\">&lt;</span>distribution key<span class=\"token operator\">></span><span class=\"token punctuation\">)</span> PARTITION BY RANGE <span class=\"token punctuation\">(</span><span class=\"token operator\">&lt;</span>partition key<span class=\"token operator\">></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span>START <span class=\"token punctuation\">(</span>date <span class=\"token string\">'&lt;YYYY-MM-DD>'</span><span class=\"token punctuation\">)</span> INCLUSIVE END <span class=\"token punctuation\">(</span>date <span class=\"token string\">'&lt;YYYY-MM-DD>'</span><span class=\"token punctuation\">)</span> EXCLUSIVE EVERY <span class=\"token punctuation\">(</span>INTERVAL <span class=\"token string\">'&lt;1 month>'</span> <span class=\"token punctuation\">))</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>CREATE TABLE custom_field_data <span class=\"token punctuation\">(</span>data_id int8, form_type int4, form_id int8, field_id int8, field_name text, field_type int4, field_value text<span class=\"token punctuation\">)</span> with <span class=\"token punctuation\">(</span>APPENDONLY<span class=\"token operator\">=</span>true, <span class=\"token assign-left variable\">ORIENTATION</span><span class=\"token operator\">=</span>column, <span class=\"token assign-left variable\">COMPRESSTYPE</span><span class=\"token operator\">=</span>zlib, <span class=\"token assign-left variable\">COMPRESSLEVEL</span><span class=\"token operator\">=</span><span class=\"token number\">1</span>, <span class=\"token assign-left variable\">BLOCKSIZE</span><span class=\"token operator\">=</span><span class=\"token number\">1048576</span>, <span class=\"token assign-left variable\">OIDS</span><span class=\"token operator\">=</span>false<span class=\"token punctuation\">)</span> DISTRIBUTED BY <span class=\"token punctuation\">(</span><span class=\"token operator\">&lt;</span>distribution key<span class=\"token operator\">></span><span class=\"token punctuation\">)</span> PARTITION BY RANGE <span class=\"token punctuation\">(</span><span class=\"token operator\">&lt;</span>partition key<span class=\"token operator\">></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span>START <span class=\"token punctuation\">(</span>date <span class=\"token string\">'&lt;YYYY-MM-DD>'</span><span class=\"token punctuation\">)</span> INCLUSIVE END <span class=\"token punctuation\">(</span>date <span class=\"token string\">'&lt;YYYY-MM-DD>'</span><span class=\"token punctuation\">)</span> EXCLUSIVE EVERY <span class=\"token punctuation\">(</span>INTERVAL <span class=\"token string\">'&lt;1 month>'</span> <span class=\"token punctuation\">))</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span></pre></td></tr></table></figure><p>​         <code>通过./mysql2pgsql -d命令获取的mysql表结构信息不完整，例如表的注释，主键，字段注释等都不会获取到，所以需要复制你所需的建表信息并加以修改,在greenplum端先用列出来的建表信息加以修改之后并执行，如果目的数据库中没有对应的表的话，执行同步命令会失败，所以必须先对应建立每一张表</code></p>\n</li>\n<li>\n<p>在 gp 的 usp_anyfix 模式中建表</p>\n</li>\n<li>\n<p>创建 tables_list_file 文件用途同步（存放需要同步的表）</p>\n<p><strong>tables_list_file.txt</strong></p>\n<figure class=\"highlight properties\"><figcaption data-lang=\".properties\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>work_type</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>work_deal</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>device_branch</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>fault_type</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>work_request</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>service_remote_way</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>service_branch</pre></td></tr></table></figure></li>\n<li>\n<p>运行</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>./mysql2pqsql -l tables_list_files -s usp_anyfix</pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">##</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>-- Adding table: work_type</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>-- Adding table: work_deal</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>-- Adding table: work_branch</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>-- Adding table: fault_type</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>-- Adding table: work_request</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>-- Adding table: service_remote_way</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>-- Adding table: service_branch</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>Starting data <span class=\"token function\">sync</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>Query to get <span class=\"token builtin class-name\">source</span> data <span class=\"token keyword\">for</span> target table work_type: <span class=\"token keyword\">select</span> * from </pre></td></tr><tr><td data-num=\"13\"></td><td><pre>Query to get <span class=\"token builtin class-name\">source</span> data <span class=\"token keyword\">for</span> target table work_deal: <span class=\"token keyword\">select</span> * from </pre></td></tr><tr><td data-num=\"14\"></td><td><pre>Query to get <span class=\"token builtin class-name\">source</span> data <span class=\"token keyword\">for</span> target table work_branch: <span class=\"token keyword\">select</span> * from </pre></td></tr><tr><td data-num=\"15\"></td><td><pre>Query to get <span class=\"token builtin class-name\">source</span> data <span class=\"token keyword\">for</span> target table fault_type: <span class=\"token keyword\">select</span> * from </pre></td></tr><tr><td data-num=\"16\"></td><td><pre>Query to get <span class=\"token builtin class-name\">source</span> data <span class=\"token keyword\">for</span> target table work_request: <span class=\"token keyword\">select</span> * from </pre></td></tr><tr><td data-num=\"17\"></td><td><pre>Query to get <span class=\"token builtin class-name\">source</span> data <span class=\"token keyword\">for</span> target table service_remote_way: <span class=\"token keyword\">select</span> * from </pre></td></tr><tr><td data-num=\"18\"></td><td><pre>Query to get <span class=\"token builtin class-name\">source</span> data <span class=\"token keyword\">for</span> target table service_branch: <span class=\"token keyword\">select</span> * from </pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token variable\"><span class=\"token variable\">`</span>usp_anyfix<span class=\"token variable\">`</span></span><span class=\"token builtin class-name\">.</span><span class=\"token variable\"><span class=\"token variable\">`</span>work_type<span class=\"token variable\">`</span></span> </pre></td></tr><tr><td data-num=\"20\"></td><td><pre>-- Reference DDL to create the target table:</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>CREATE TABLE usp_anyfix.work_type <span class=\"token punctuation\">(</span>id int4, name text, demander_corp int8, description text, sys_type int4, enabled text, operator int8, operate_time timestamp<span class=\"token punctuation\">)</span> with <span class=\"token punctuation\">(</span>APPENDONLY<span class=\"token operator\">=</span>true, <span class=\"token assign-left variable\">ORIENTATION</span><span class=\"token operator\">=</span>column, <span class=\"token assign-left variable\">COMPRESSTYPE</span><span class=\"token operator\">=</span>zlib, <span class=\"token assign-left variable\">COMPRESSLEVEL</span><span class=\"token operator\">=</span><span class=\"token number\">1</span>, <span class=\"token assign-left variable\">BLOCKSIZE</span><span class=\"token operator\">=</span><span class=\"token number\">1048576</span>, <span class=\"token assign-left variable\">OIDS</span><span class=\"token operator\">=</span>false<span class=\"token punctuation\">)</span> DISTRIBUTED BY <span class=\"token punctuation\">(</span><span class=\"token operator\">&lt;</span>distribution key<span class=\"token operator\">></span><span class=\"token punctuation\">)</span> PARTITION BY RANGE <span class=\"token punctuation\">(</span><span class=\"token operator\">&lt;</span>partition key<span class=\"token operator\">></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span>START <span class=\"token punctuation\">(</span>date <span class=\"token string\">'&lt;YYYY-MM-DD>'</span><span class=\"token punctuation\">)</span> INCLUSIVE END <span class=\"token punctuation\">(</span>date <span class=\"token string\">'&lt;YYYY-MM-DD>'</span><span class=\"token punctuation\">)</span> EXCLUSIVE EVERY <span class=\"token punctuation\">(</span>INTERVAL <span class=\"token string\">'&lt;1 month>'</span> <span class=\"token punctuation\">))</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>thread <span class=\"token number\">0</span> migrate task <span class=\"token number\">0</span> table usp_anyfix.work_type <span class=\"token number\">5</span> rows complete, <span class=\"token function\">time</span> cost <span class=\"token number\">117.708</span> ms</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>Number of rows migrated: <span class=\"token number\">5</span> <span class=\"token punctuation\">(</span>number of <span class=\"token builtin class-name\">source</span> tables' rows: <span class=\"token number\">5</span><span class=\"token punctuation\">)</span> </pre></td></tr><tr><td data-num=\"25\"></td><td><pre>Data <span class=\"token function\">sync</span> <span class=\"token function\">time</span> cost <span class=\"token number\">208.147</span> ms</pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span>.</pre></td></tr></table></figure><p><strong>每个库都要单独运行一次</strong></p>\n<p><strong>usp_uas</strong></p>\n<pre><code>uas_cfg_area\nuas_corp_reg\nuas_user_info\nuas_user_real\nsys_tenant\n</code></pre>\n<p><strong>usp_device</strong></p>\n<pre><code>device_brand\ndevice_info\ndevice_large_class\ndevice_model\ndevice_small_class\ndevice_specification\n</code></pre>\n</li>\n<li>\n<p>查看 pg (同步完成)</p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">SELECT</span> id<span class=\"token punctuation\">,</span> name<span class=\"token punctuation\">,</span> demander_corp<span class=\"token punctuation\">,</span> description<span class=\"token punctuation\">,</span> sys_type</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">FROM</span> usp_anyfix<span class=\"token punctuation\">.</span>work_type<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre> id <span class=\"token operator\">|</span> name <span class=\"token operator\">|</span> demander_corp <span class=\"token operator\">|</span> description <span class=\"token operator\">|</span> sys_type  <span class=\"token operator\">|</span> enabled</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">----+------+---------------+-------------+-----------+----------</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre> <span class=\"token number\">1</span>\t<span class=\"token operator\">|</span>  维修 <span class=\"token operator\">|</span>   \t  <span class=\"token number\">0</span>       <span class=\"token operator\">|</span>\t     维修\t  <span class=\"token operator\">|</span>    <span class=\"token number\">1</span>      <span class=\"token operator\">|</span>   \tY\t\t</pre></td></tr><tr><td data-num=\"6\"></td><td><pre> <span class=\"token number\">5</span>\t<span class=\"token operator\">|</span>  投诉 <span class=\"token operator\">|</span>   \t  <span class=\"token number\">0</span>       <span class=\"token operator\">|</span>\t     投诉\t  <span class=\"token operator\">|</span>    <span class=\"token number\">5</span>      <span class=\"token operator\">|</span>   \tY\t\t</pre></td></tr><tr><td data-num=\"7\"></td><td><pre> <span class=\"token number\">2</span>\t<span class=\"token operator\">|</span>  巡检 <span class=\"token operator\">|</span>   \t  <span class=\"token number\">0</span>       <span class=\"token operator\">|</span>\t     巡检\t  <span class=\"token operator\">|</span>    <span class=\"token number\">2</span>      <span class=\"token operator\">|</span>   \tY\t\t</pre></td></tr><tr><td data-num=\"8\"></td><td><pre> <span class=\"token number\">3</span>\t<span class=\"token operator\">|</span>  安装 <span class=\"token operator\">|</span>   \t  <span class=\"token number\">0</span>       <span class=\"token operator\">|</span>\t     安装\t  <span class=\"token operator\">|</span>    <span class=\"token number\">3</span>      <span class=\"token operator\">|</span>   \tY\t</pre></td></tr><tr><td data-num=\"9\"></td><td><pre> <span class=\"token number\">4</span>\t<span class=\"token operator\">|</span>  咨询 <span class=\"token operator\">|</span>   \t  <span class=\"token number\">0</span>       <span class=\"token operator\">|</span>\t     咨询\t  <span class=\"token operator\">|</span>    <span class=\"token number\">4</span>      <span class=\"token operator\">|</span>   \tY</pre></td></tr></table></figure></li>\n</ul>\n<h1 id=\"可能出现的异常\"><a class=\"anchor\" href=\"#可能出现的异常\">#</a> 可能出现的异常</h1>\n<h2 id=\"mysql-maxwell\"><a class=\"anchor\" href=\"#mysql-maxwell\">#</a> mysql-maxwell</h2>\n<h3 id=\"maxwell-重启或意外挂断\"><a class=\"anchor\" href=\"#maxwell-重启或意外挂断\">#</a> Maxwell 重启或意外挂断</h3>\n<blockquote>\n<p>kiil $ {PID} 停止 Maxwell 进程，或者当 Maxwell 由于网络和其他因素挂断时。重新启动进程是不会丢失少量数据</p>\n</blockquote>\n<p>取决于您的生产者设置。通常，maxwell  <code>maxwell.positions</code>  在记录发送之前不会更新，尤其是在与可靠的生产者（例如 kafka /kinesis 等）打交道时，只有等 kafka 接收后发送成功的标示才会更新 <code>maxwell.positions</code> 。</p>\n<p>所以当 maxwell 意外挂掉重启即可</p>\n<p>可配置 kafka 相关参数:</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 压缩格式 压缩的速度上 lz4=snappy&lt;gzip。</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>kafka.compression.type<span class=\"token operator\">=</span>snappy</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># 重试次数</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>kafka.retries<span class=\"token operator\">=</span><span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\">#procedure 要求 leader 在考虑完成请求之前收到的确认数，用于控制发送记录在服务端的持久化，其值可以为如下：</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\">#acks = 0 如果设置为零，则生产者将不会等待来自服务器的任何确认，该记录将立即添加到套接字缓冲区并视为已发送。在这种情况下，无法保证服务器已收到记录，并且重试配置将不会生效（因为客户端通常不会知道任何故障），为每条记录返回的偏移量始终设置为 - 1。</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\">#acks = 1 这意味着 leader 会将记录写入其本地日志，但无需等待所有副本服务器的完全确认即可做出回应，在这种情况下，如果 leader 在确认记录后立即失败，但在将数据复制到所有的副本服务器之前，则记录将会丢失。</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\">#acks = all 这意味着 leader 将等待完整的同步副本集以确认记录，这保证了只要至少一个同步副本服务器仍然存活，记录就不会丢失，这是最强有力的保证，这相当于 acks = -1 的设置。</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>kafka.acks<span class=\"token operator\">=</span><span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\">#kafka.batch.size=16384</span></pre></td></tr></table></figure><h3 id=\"使用旧的binlog\"><a class=\"anchor\" href=\"#使用旧的binlog\">#</a> 使用旧的 binlog</h3>\n<blockquote>\n<p>如果是拿比较老的 binlog 放到新的 mysql server 上去用 maxwell 拉去，有可能表结构已经发生了变化。</p>\n</blockquote>\n<ul>\n<li>\n<p>表字段添加或者减少 (删除)</p>\n<p>目前传入 kafka 没什么影响，只会在 json 中多一个字段或者少一个</p>\n</li>\n<li>\n<p>若 binlog 中存在 ddl</p>\n<p>报错：com.zendesk.maxwell.schema.ddl.InvalidSchemaError: Unexpectedly asked to create existing table device_large_class</p>\n<p>可以使用 --init-postition 跳过</p>\n<p>或者直接使用 maxwell-bootstrap 直接读表，不读 binlog</p>\n</li>\n</ul>\n<h3 id=\"mysql-用户权限\"><a class=\"anchor\" href=\"#mysql-用户权限\">#</a> mysql 用户权限</h3>\n<blockquote>\n<p>maxwell 对数据库中多个表读写权限，而对其他表则没有读取权限，配置参数还会过滤掉没有读权限的表。但是如果没有读取权限的表发生更改，</p>\n<p>就会报错 ： java.lang.RuntimeException: Couldn't find table test_tb in database Maxwell</p>\n</blockquote>\n<p><strong>原因</strong>：</p>\n<pre><code> Maxwell构建元数据库时，它没有足够的权限，并且不知道表的存在。 因此，该表在Maxwell元数据中不存在\n</code></pre>\n<p><strong>解决</strong></p>\n<ul>\n<li>Maxwell 添加足够的权限并重建元数据。</li>\n<li>您可以在配置中配置具有读取权限的过滤器表 --filter='exclude: databasename.table'</li>\n</ul>\n<h3 id=\"14-timestamp-column\"><a class=\"anchor\" href=\"#14-timestamp-column\">#</a> 1.4 timestamp column</h3>\n<p>maxwell 对时间类型（datetime, timestamp, date）都是当做字符串处理的，这也是为了保证数据一致 (比如 0000-00-00 00:00:00 这样的时间在 timestamp 里是非法的，但 mysql 却认，解析成 java 或者 python 类型就是 null/None)。</p>\n<p>如果 MySQL 表上的字段是 timestamp 类型，是有时区的概念 <strong>binlog 解析出来的是标准 UTC 时间</strong></p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 查看 mysql 时区</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>show variables like <span class=\"token string\">'%time_zone%'</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>+------------------+--------+</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token operator\">|</span> Variable_name    <span class=\"token operator\">|</span> Value  <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>+------------------+--------+</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token operator\">|</span> system_time_zone <span class=\"token operator\">|</span> CST    <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token operator\">|</span> time_zone        <span class=\"token operator\">|</span> SYSTEM <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>+------------------+--------+</pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token comment\">#SYSTEM 表示使用 “OS 时区”； CST ，这里 cst 是 “中国标准时间 + 8:00 区”</span></pre></td></tr></table></figure><p><strong>修改 mysql 服务器的时区</strong></p>\n<ul>\n<li>\n<p>修改 global 变量</p>\n<p>set global time_zone = '+8:00'; ## 修改 mysql 全局时区为北京时间，即我们所在的东 8 区</p>\n<p>set time_zone = '+8:00'; ## 修改当前会话时区</p>\n<p>flush privileges; #立即生效</p>\n</li>\n<li>\n<p>修改 my.cnf 配置文件来修改时区</p>\n<p># vim /etc/my.cnf ## 在 [mysqld] 区域中加上</p>\n<p>default-time_zone = '+8:00'</p>\n</li>\n</ul>\n<h2 id=\"maxwell-kafka\"><a class=\"anchor\" href=\"#maxwell-kafka\">#</a> maxwell - kafka</h2>\n<h3 id=\"maxwell-到kafka-数据倾斜问题\"><a class=\"anchor\" href=\"#maxwell-到kafka-数据倾斜问题\">#</a> maxwell 到 kafka 数据倾斜问题</h3>\n<p>在<span class=\"exturl\" data-url=\"aHR0cDovL21heHdlbGxzLWRhZW1vbi5pby8=\"> Maxwell</span> 官网查文档得知，在 <code>Maxwell</code>  没有配置的情况下，默认使用数据库名 database 作为计算分区的 key，并使用 Java 默认的 hashcode 算法进行计算，项目中 <code>maxwell</code>  的 binlog 就是单个 database，所以造成数据倾斜。</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>HASH_FUNCTION<span class=\"token punctuation\">(</span>HASH_STRING<span class=\"token punctuation\">)</span> % TOPIC.NUMBER_OF_PARTITIONS</pre></td></tr></table></figure><p>修改 <code>Maxwell</code>  的配置文件 config.properties 中加入对应参数即可，选择了 primary_key 作为分区 key，同时选用 murmurhash3</p>\n<p>maxwell 有一个参数是–producer_partition_by，在不指定的情况下默认是 database，意思是数据推送到 kafka 时，数据被根据数据库进行 hash，同一个库的数据会被放在同一个 partition 中，这个参数有三个值：<br />\ndatabase、table、primary_key</p>\n<p>哈希算法，以获得更好的效率和分布：</p>\n<figure class=\"highlight properties\"><figcaption data-lang=\".properties\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token attr-name\">kafka_partition_hash</span><span class=\"token punctuation\">=</span><span class=\"token attr-value\">murmur3</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token attr-name\">producer_partition_by</span><span class=\"token punctuation\">=</span><span class=\"token attr-value\">primary_key</span></pre></td></tr></table></figure><h3 id=\"kafka可能存在数据丢失情况\"><a class=\"anchor\" href=\"#kafka可能存在数据丢失情况\">#</a> kafka 可能存在数据丢失情况</h3>\n<p>在 maxwell 中 kafka.acks=1（默认）</p>\n<pre><code>   kafka在 Partition Leader接收到消息而且写入本地磁盘了，就认为成功了，不管他其他的Follower有没有同步过去这条消息了，\n</code></pre>\n<p><strong>存在极端情况</strong></p>\n<pre><code> 万一Partition Leader刚刚接收到消息，Follower还没来得及同步过去，结果Leader所在的broker宕机了，此时也会导致这条消息丢失，因为客户端已经认为发送成功了。\n</code></pre>\n<p>解决办法：</p>\n<ul>\n<li>\n<p>一开始就参数改成的：kafka.akcs=-1</p>\n<p>Partition Leader 接收到消息之后，还必须要求 ISR 列表里跟 Leader 保持同步的那些 Follower 都要把消息同步过去，才能认为这条消息是写入成功了</p>\n</li>\n<li>\n<p>可以通过 kafka 接受的 json 中 <code>position</code>  属性获取 position</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 可以通过 mysql 查询手动定位丢失的数据</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>show binlog events <span class=\"token keyword\">in</span> <span class=\"token string\">'mysql-bin.000002'</span> from position limit <span class=\"token number\">30</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure></li>\n</ul>\n<h2 id=\"kafka-bireme-gp\"><a class=\"anchor\" href=\"#kafka-bireme-gp\">#</a> kafka-bireme-gp</h2>\n<h3 id=\"31-bireme-不支持ddl-不支持maxwell全量\"><a class=\"anchor\" href=\"#31-bireme-不支持ddl-不支持maxwell全量\">#</a> 3.1 bireme 不支持 ddl (不支持 maxwell 全量)</h3>\n<blockquote>\n<p>若 kalka 中有 maxwell 导入的 ddl，或者全量数据，bireme 是无法解析该 json</p>\n</blockquote>\n<p>* 所以在 kafka 中一定不能有 ddl 语句和 maxwell 导入的全量（bootstrap-start -&gt; bootstrap-insert -&gt; bootstrap-complete），bireme 无法解析 json</p>\n<ul -to-offset=\"\" 这个的偏移量是全区都是用一个，如果分区消息不均衡=\"\" 需要考虑是否适用=\"\">\n<li>\n<p>解决方法</p>\n<ol>\n<li>\n<p>maxwell 不使用全量到入</p>\n</li>\n<li>\n<p>maxwell 不使用 output_ddl  或者 <code> output_ddl 为 true 配合 ddl_kafka_topic使用</code></p>\n</li>\n<li>\n<p>使用 kafka 命令修改消费者的偏移量（跳过 bireme 无法识别的错误）</p>\n</li>\n</ol>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 获取消费者组的偏移量</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre> ./kafka-consumer-groups.sh --bootstrap-server hdp-s-1.data.dc.zjft.com:6667 --group bireme2 --describe</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># TOPIC     PARTITION  CURRENT-OFFSET  LOG-END-OFFSET  LAG  CONSUMER-ID  HOST  CLIENT-ID</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\"># maxwell2      0          43              43           0        -         -        -</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\"># maxwell1      0          33              55           22        -        -        -</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\">#修改 bireme2 在 maxwell1 中的偏移量</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\"># （最新的偏移量）</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>./kafka-consumer-groups.sh --bootstrap-server hdp-s-1.data.dc.zjft.com:6667 --group bireme2 --topic maxwell1 --reset-offsets --to-latest -execute</pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token comment\">#  TOPIC                          PARTITION  NEW-OFFSET     </span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\">#  maxwell1                       0          55    </span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token comment\">#（最早的）</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>./kafka-consumer-groups.sh --bootstrap-server hdp-s-1.data.dc.zjft.com:6667 --group bireme2 --topic maxwell1 --reset-offsets --to-earliest -execute</pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token comment\"># TOPIC                          PARTITION  NEW-OFFSET     </span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token comment\"># maxwell1                       0          38             </span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token comment\">#（指定位置）</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>./kafka-consumer-groups.sh --bootstrap-server hdp-s-1.data.dc.zjft.com:6667 --group bireme2 --topic maxwell1 --reset-offsets -to-offset <span class=\"token number\">43</span> -execute</pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token comment\"># TOPIC                          PARTITION  NEW-OFFSET     </span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token comment\"># maxwell1                       0          43</span></pre></td></tr></table></figure><p>***** <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mstyle mathcolor=\"red\"></mstyle></mrow><annotation encoding=\"application/x-tex\">\\color{red}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"></span></span></p>\n</li>\n</ul>\n<h3 id=\"mysql结构发生改变\"><a class=\"anchor\" href=\"#mysql结构发生改变\">#</a> mysql 结构发生改变</h3>\n<ul>\n<li>\n<p>若 mysql 表添加字段</p>\n<p>bireme 导入 gp 没有影响，若 gp 也添加相应字段，则该字段自动填充（bireme 重启）</p>\n</li>\n<li>\n<p>若 mysql 表删除字段</p>\n<blockquote>\n<p>Caused by: cn.hashdata.bireme.BiremeException: Not found. Record does not have a field named &quot;fieldName&quot;.</p>\n</blockquote>\n<p><strong>解决</strong></p>\n<ul>\n<li>减少 gp 表对应的字段，在重启 bireme</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"source_nameproperties中表对应不上\"><a class=\"anchor\" href=\"#source_nameproperties中表对应不上\">#</a> &lt;source_name&gt;.properties 中表对应不上</h3>\n<blockquote>\n<p>在使用 v2.0.0-alpha-1 可能会出现这种情况，mysql 多张表指向一张表<br />\n报错：cn.hashdata.bireme.BiremeException: Greenplum table and MySQL table size are inconsistent!</p>\n</blockquote>\n<figure class=\"highlight properties\"><figcaption data-lang=\".properties\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token attr-name\">test.device_info</span> <span class=\"token punctuation\">=</span> <span class=\"token attr-value\">public.device_info</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token attr-name\">test1.device_info</span> <span class=\"token punctuation\">=</span> <span class=\"token attr-value\">public.device_info</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token attr-name\">test2.device_info</span> <span class=\"token punctuation\">=</span> <span class=\"token attr-value\">public.device_info</span></pre></td></tr></table></figure><p><strong>注释以下部分</strong></p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>table_map<span class=\"token punctuation\">.</span><span class=\"token function\">size</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> tableMap<span class=\"token punctuation\">.</span><span class=\"token function\">size</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token class-name\">String</span> message <span class=\"token operator\">=</span> <span class=\"token string\">\"some tables do not have primary keys！\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">BiremeException</span><span class=\"token punctuation\">(</span>message<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    logger<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Greenplum table primary key check is completed, the state is okay！\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h3 id=\"当同步的表个数过多时数据不能同步\"><a class=\"anchor\" href=\"#当同步的表个数过多时数据不能同步\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL0hhc2hEYXRhSW5jL2JpcmVtZS9pc3N1ZXMvODg=\">当同步的表个数过多时，数据不能同步</span></h3>\n<h3 id=\"bireme启动后1分钟左右就出现假死情况日志没有记录任何错误\"><a class=\"anchor\" href=\"#bireme启动后1分钟左右就出现假死情况日志没有记录任何错误\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL0hhc2hEYXRhSW5jL2JpcmVtZS9pc3N1ZXMvNDc=\">bireme 启动后，1 分钟左右就出现假死情况，日志没有记录任何错误 </span></h3>\n<h2 id=\"mysql2pgsql全量-2\"><a class=\"anchor\" href=\"#mysql2pgsql全量-2\">#</a> mysql2pgsql（全量）</h2>\n<ul>\n<li>\n<p><strong>主键重复</strong>：</p>\n<p><em>同步出现此问题，则会导致该表同步失败:</em></p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>COPY failed <span class=\"token keyword\">for</span> table <span class=\"token string\">\"work_request\"</span><span class=\"token builtin class-name\">:</span> ERROR:  duplicate key value violates unique constraint <span class=\"token string\">\"work_request_pkey\"</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>DETAIL:  Key <span class=\"token punctuation\">(</span>work_id<span class=\"token punctuation\">)</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">1230771096200847361</span><span class=\"token punctuation\">)</span> already exists.</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>CONTEXT:  COPY work_request, line <span class=\"token number\">1</span></pre></td></tr></table></figure><p>可以删除 key (work_id)=(1230771096200847361) 这条记录 ，再删除 table_list_file.txt 中除该表的其他表</p>\n</li>\n<li>\n<p><strong>表不存在</strong></p>\n<p><em>同步出现此问题，不影响其他表</em></p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>-- Reference DDL to create the target table:</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>CREATE TABLE usp_anyfix.custom_field <span class=\"token punctuation\">(</span>field_id int8, field_name text, field_type int4, required text, form_type int4, common text, corp_id int8, operator int8, operate_time timestamp<span class=\"token punctuation\">)</span> with <span class=\"token punctuation\">(</span>APPENDONLY<span class=\"token operator\">=</span>true, <span class=\"token assign-left variable\">ORIENTATION</span><span class=\"token operator\">=</span>column, <span class=\"token assign-left variable\">COMPRESSTYPE</span><span class=\"token operator\">=</span>zlib, <span class=\"token assign-left variable\">COMPRESSLEVEL</span><span class=\"token operator\">=</span><span class=\"token number\">1</span>, <span class=\"token assign-left variable\">BLOCKSIZE</span><span class=\"token operator\">=</span><span class=\"token number\">1048576</span>, <span class=\"token assign-left variable\">OIDS</span><span class=\"token operator\">=</span>false<span class=\"token punctuation\">)</span> DISTRIBUTED BY <span class=\"token punctuation\">(</span><span class=\"token operator\">&lt;</span>distribution key<span class=\"token operator\">></span><span class=\"token punctuation\">)</span> PARTITION BY RANGE <span class=\"token punctuation\">(</span><span class=\"token operator\">&lt;</span>partition key<span class=\"token operator\">></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span>START <span class=\"token punctuation\">(</span>date <span class=\"token string\">'&lt;YYYY-MM-DD>'</span><span class=\"token punctuation\">)</span> INCLUSIVE END <span class=\"token punctuation\">(</span>date <span class=\"token string\">'&lt;YYYY-MM-DD>'</span><span class=\"token punctuation\">)</span> EXCLUSIVE EVERY <span class=\"token punctuation\">(</span>INTERVAL <span class=\"token string\">'&lt;1 month>'</span> <span class=\"token punctuation\">))</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>table copy failed Query <span class=\"token string\">'COPY \"usp_anyfix\".\"custom_field\" FROM stdin DELIMITERS '</span><span class=\"token operator\">|</span><span class=\"token string\">' with csv QUOTE '</span>'<span class=\"token string\">''</span>': ERROR:  relation <span class=\"token string\">\"usp_anyfix.custom_field\"</span> does not exist</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>thread <span class=\"token number\">1</span> migrate task <span class=\"token number\">1</span> table usp_anyfix.work_type <span class=\"token number\">5</span> rows complete, <span class=\"token function\">time</span> cost <span class=\"token number\">119.677</span> ms</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>Number of rows migrated: <span class=\"token number\">5</span> <span class=\"token punctuation\">(</span>number of <span class=\"token builtin class-name\">source</span> tables' rows: <span class=\"token number\">5</span><span class=\"token punctuation\">)</span> </pre></td></tr><tr><td data-num=\"7\"></td><td><pre>Data <span class=\"token function\">sync</span> <span class=\"token function\">time</span> cost <span class=\"token number\">248.356</span> ms</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>errors occured during migration</pre></td></tr></table></figure><p>若需要同步 gai 表，可以修改日志里的 sql 语句在 gp 创建表，再重新运行（修改 table_list_file）</p>\n</li>\n<li>\n<p><strong>需要修改 gp 表结构的</strong></p>\n<ul>\n<li>\n<p>字段对应不上</p>\n</li>\n<li>\n<p>gp 表约束条件 如（不为空，惟一值）</p>\n<p>* 在同步时 gp 可能会把  <code>‘’</code>  当成空，所以不能设置 <code>NOT NULL</code></p>\n</li>\n</ul>\n</li>\n</ul>\n",
            "tags": [
                "计算机科学",
                "大数据",
                "maxwell",
                "bireme",
                "kafka"
            ]
        },
        {
            "id": "http://yrmlnf.coding-pages.com/Canal-%E9%83%A8%E7%BD%B2%E6%8C%87%E5%8D%97/",
            "url": "http://yrmlnf.coding-pages.com/Canal-%E9%83%A8%E7%BD%B2%E6%8C%87%E5%8D%97/",
            "title": "Canal-部署指南",
            "date_published": "2021-03-31T02:12:23.000Z",
            "content_html": "<h1 id=\"简介\"><a class=\"anchor\" href=\"#简介\">#</a> 简介</h1>\n<div class=\"note info\">\n<p>canal 是纯 Java 开发。基于数据库增量日志解析，提供增量数据订阅 &amp; 消费，目前主要支持了 MySQL</p>\n</div>\n<p><img data-src=\"1.jpg\" alt=\"1\" /></p>\n<p><strong>MySQL 主备复制原理</strong><br />\n<img data-src=\"2.jpg\" alt=\"2\" /></p>\n<ul>\n<li>MySQL master 将数据变更写入二进制日志 (binary log, 其中记录叫做二进制日志事件 binary log events，可以通过 show binlog events 进行查看)</li>\n<li>MySQL slave 将 master 的 binary log events 拷贝到它的中继日志 (relay log)</li>\n<li>MySQL slave 重放 relay log 中事件，将数据变更反映它自己的数据<br />\n<strong> Cannel 工作原理</strong><br />\n canal 模拟 MySQL slave 的交互协议，伪装自己为 MySQL slave ，向 MySQL master 发送 dump 协议</li>\n<li>canal 模拟 MySQL slave 的交互协议，伪装自己为 MySQL slave ，向 MySQL master 发送 dump 协议</li>\n<li>MySQL master 收到 dump 请求，开始推送 binary log 给 slave (即 canal)</li>\n<li>canal 解析 binary log 对象 (原始为 byte 流)</li>\n</ul>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL2FsaWJhYmEvY2FuYWwvd2lraQ==\">官方文档</span></p>\n<h1 id=\"配置mysql环境\"><a class=\"anchor\" href=\"#配置mysql环境\">#</a> 配置 mysql 环境</h1>\n<ul>\n<li>\n<p><strong>需要先开启 Binlog 写入功能，配置 binlog-format 为 ROW 模式</strong></p>\n<p etcmy.cnf.dserver.cnf=\"\">修改 my.cnf，mysql 一般位于 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mstyle mathcolor=\"red\"><mrow><mi mathvariant=\"normal\">/</mi><mi>e</mi><mi>t</mi><mi>c</mi><mi mathvariant=\"normal\">/</mi><mi>m</mi><mi>y</mi><mi mathvariant=\"normal\">.</mi><mi>c</mi><mi>n</mi><mi>f</mi></mrow></mstyle></mrow><annotation encoding=\"application/x-tex\">\\color{red}{/etc/my.cnf}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord\" style=\"color:red;\"><span class=\"mord\" style=\"color:red;\">/</span><span class=\"mord mathnormal\" style=\"color:red;\">e</span><span class=\"mord mathnormal\" style=\"color:red;\">t</span><span class=\"mord mathnormal\" style=\"color:red;\">c</span><span class=\"mord\" style=\"color:red;\">/</span><span class=\"mord mathnormal\" style=\"color:red;\">m</span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;color:red;\">y</span><span class=\"mord\" style=\"color:red;\">.</span><span class=\"mord mathnormal\" style=\"color:red;\">c</span><span class=\"mord mathnormal\" style=\"color:red;\">n</span><span class=\"mord mathnormal\" style=\"margin-right:0.10764em;color:red;\">f</span></span></span></span></span>   maridb 一般位于<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mstyle mathcolor=\"red\"></mstyle></mrow><annotation encoding=\"application/x-tex\">\\color{red}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"></span></span></p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>mysqld<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>log-bin<span class=\"token operator\">=</span>mysql-bin <span class=\"token comment\"># 开启 binlog</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>binlog-format<span class=\"token operator\">=</span>ROW <span class=\"token comment\"># 选择 ROW 模式</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token assign-left variable\">server_id</span><span class=\"token operator\">=</span><span class=\"token number\">1</span> <span class=\"token comment\"># 配置 MySQL replaction 需要定义，不要和 canal 的 slaveId 重复</span></pre></td></tr></table></figure></li>\n<li>\n<p><strong>验证</strong></p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 是否启用了日志</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>show variables like <span class=\"token string\">'log_bin'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>show global variables like <span class=\"token string\">\"%log_bin%\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\"># 怎样知道当前的日志</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>show master status<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\"># 查看 mysql binlog 模式</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>show variables like <span class=\"token string\">'binlog_format'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\"># 获取 binlog 文件列表</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>show binary logs<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\"># 查看置顶 binglog 文件的内容</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>show binlog events <span class=\"token keyword\">in</span> <span class=\"token string\">'mysql-bin.000008'</span></pre></td></tr></table></figure></li>\n<li>\n<p><strong>授权 canal</strong></p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">-- 连接 mysql 账号具有 mysql slave 的权限，如果已有账号可直接 grant 授权</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">create</span> <span class=\"token keyword\">user</span> canal identified <span class=\"token keyword\">by</span> <span class=\"token string\">'canal'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">grant</span> <span class=\"token keyword\">select</span> <span class=\"token punctuation\">,</span><span class=\"token keyword\">replication</span> slave<span class=\"token punctuation\">,</span><span class=\"token keyword\">replication</span> client <span class=\"token keyword\">on</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">.</span><span class=\"token operator\">*</span> <span class=\"token keyword\">to</span> <span class=\"token string\">'canal'</span><span class=\"token variable\">@'%'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>flush <span class=\"token keyword\">privileges</span></pre></td></tr></table></figure></li>\n</ul>\n<h1 id=\"搭建canal环境单机\"><a class=\"anchor\" href=\"#搭建canal环境单机\">#</a> 搭建 canal 环境 (单机)</h1>\n<ul>\n<li>\n<p><strong>下载 canal (1.1.4) 版本</strong></p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">wget</span> https://github.com/alibaba/canal/releases/download/canal-1.1.4/canal.deployer-1.1.4.tar.gz</pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">mkdir</span> /tmp/canal</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token function\">tar</span> zxvf canal.deployer-<span class=\"token variable\">$version</span>.tar.gz -C /tmp/canal</pre></td></tr></table></figure></li>\n<li>\n<p><strong>解压后目录结构</strong></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>drwxr-xr-x@  <span class=\"token number\">7</span> jiedeng  staff   224B  <span class=\"token number\">6</span>  <span class=\"token number\">5</span> 09:07 bin</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>drwxr-xr-x@ <span class=\"token number\">10</span> jiedeng  staff   320B  <span class=\"token number\">6</span>  <span class=\"token number\">4</span> <span class=\"token number\">10</span>:32 conf</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>drwxr-xr-x@ <span class=\"token number\">83</span> jiedeng  staff   <span class=\"token number\">2</span>.6K  <span class=\"token number\">6</span>  <span class=\"token number\">1</span> <span class=\"token number\">14</span>:24 lib</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>drwxr-xr-x@  <span class=\"token number\">9</span> jiedeng  staff   288B  <span class=\"token number\">6</span>  <span class=\"token number\">3</span> <span class=\"token number\">14</span>:37 logs</pre></td></tr></table></figure></li>\n<li>\n<p><strong>修改配置文件</strong></p>\n<figure class=\"highlight properties\"><figcaption data-lang=\".properties\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#################################################  </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">## mysql serverId  </span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token attr-name\">canal.instance.mysql.slaveId</span> <span class=\"token punctuation\">=</span> <span class=\"token attr-value\">1234  </span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\"># position info，需要改成自己的数据库信息  </span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token attr-name\">canal.instance.master.address</span> <span class=\"token punctuation\">=</span> <span class=\"token attr-value\">127.0.0.1:3306   </span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token attr-name\">canal.instance.master.journal.name</span> <span class=\"token attr-value\">=   </span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token attr-name\">canal.instance.master.position</span> <span class=\"token attr-value\">=   </span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token attr-name\">canal.instance.master.timestamp</span> <span class=\"token attr-value\">=   </span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token comment\">#canal.instance.standby.address =   </span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token comment\">#canal.instance.standby.journal.name =  </span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token comment\">#canal.instance.standby.position =   </span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token comment\">#canal.instance.standby.timestamp =   </span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token comment\"># username/password，需要改成自己的数据库信息  </span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token attr-name\">canal.instance.dbUsername</span> <span class=\"token punctuation\">=</span> <span class=\"token attr-value\">canal    </span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token attr-name\">canal.instance.dbPassword</span> <span class=\"token punctuation\">=</span> <span class=\"token attr-value\">canal  </span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token attr-name\">canal.instance.defaultDatabaseName</span> <span class=\"token punctuation\">=</span> <span class=\"token attr-value\">sampledata  </span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token attr-name\">canal.instance.connectionCharset</span> <span class=\"token punctuation\">=</span> <span class=\"token attr-value\">UTF-8  </span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token comment\"># table regex  </span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token attr-name\">canal.instance.filter.regex</span> <span class=\"token punctuation\">=</span> <span class=\"token attr-value\">.*\\\\..*</span></pre></td></tr></table></figure></li>\n<li>\n<p><strong>启动 / 关闭</strong></p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>bin/startup.sh <span class=\"token comment\"># 启动</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>bin/stop.sh <span class=\"token comment\"># 关闭</span></pre></td></tr></table></figure></li>\n<li>\n<p><strong>查看日志</strong></p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">tail</span> logs/canal/canal.log</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">#| 2020-06-05 14:26:26.064 [main] INFO  com.alibaba.otter.canal.deployer.CanalStarter - ## start the canal server.</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">#| 2020-06-05 14:26:26.082 [main] INFO  com.alibaba.otter.canal.deployer.CanalController - ## start the canal server[10.32.58.203(10.32.58.203):11111]</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">#| 2020-06-05 14:26:26.826 [main] INFO  com.alibaba.otter.canal.deployer.CanalStarter - ## the canal server is running now ......</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token function\">tail</span> logs/example/example.log</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\">#| 2020-06-05 14:32:01.353 [main] INFO  c.a.otter.canal.instance.spring.CanalInstanceWithSpring - start CannalInstance for 1-example </span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\">#| 2020-06-05 14:32:01.359 [main] WARN  c.a.o.canal.parse.inbound.mysql.dbsync.LogEventConvert - --> init table filter : ^.*\\..*$</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token comment\">#| 2020-06-05 14:32:01.359 [main] WARN  c.a.o.canal.parse.inbound.mysql.dbsync.LogEventConvert - --> init table black filter : </span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\">#| 2020-06-05 14:32:01.365 [main] INFO  c.a.otter.canal.instance.core.AbstractCanalInstance - start successful....</span></pre></td></tr></table></figure></li>\n<li>\n<p><strong>运行 canal-client</strong></p>\n<p>新建 maven 工程，添加 pom 依赖</p>\n<figure class=\"highlight xml\"><figcaption data-lang=\"XML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>dependency</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>            <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>groupId</span><span class=\"token punctuation\">></span></span>com.alibaba.otter<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>groupId</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>            <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>artifactId</span><span class=\"token punctuation\">></span></span>canal.client<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>artifactId</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>            <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>version</span><span class=\"token punctuation\">></span></span>1.1.4<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>version</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>dependency</span><span class=\"token punctuation\">></span></span></pre></td></tr></table></figure><p><strong>CanalClientDemo.java</strong></p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">package</span> <span class=\"token namespace\">com<span class=\"token punctuation\">.</span>zjft</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token namespace\">com<span class=\"token punctuation\">.</span>alibaba<span class=\"token punctuation\">.</span>otter<span class=\"token punctuation\">.</span>canal<span class=\"token punctuation\">.</span>client<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">CanalConnector</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token namespace\">com<span class=\"token punctuation\">.</span>alibaba<span class=\"token punctuation\">.</span>otter<span class=\"token punctuation\">.</span>canal<span class=\"token punctuation\">.</span>client<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">CanalConnectors</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token namespace\">com<span class=\"token punctuation\">.</span>alibaba<span class=\"token punctuation\">.</span>otter<span class=\"token punctuation\">.</span>canal<span class=\"token punctuation\">.</span>protocol<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">CanalEntry</span><span class=\"token punctuation\">.</span>*<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token namespace\">com<span class=\"token punctuation\">.</span>alibaba<span class=\"token punctuation\">.</span>otter<span class=\"token punctuation\">.</span>canal<span class=\"token punctuation\">.</span>protocol<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">Message</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token namespace\">com<span class=\"token punctuation\">.</span>google<span class=\"token punctuation\">.</span>protobuf<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">InvalidProtocolBufferException</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token namespace\">java<span class=\"token punctuation\">.</span>net<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">InetSocketAddress</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token namespace\">java<span class=\"token punctuation\">.</span>util<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">List</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token namespace\">java<span class=\"token punctuation\">.</span>util<span class=\"token punctuation\">.</span>stream<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">Stream</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">CanalClientDemo</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token class-name\">String</span> SERVER_ADDRESS <span class=\"token operator\">=</span> <span class=\"token string\">\"127.0.0.1\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token class-name\">Integer</span> PORT <span class=\"token operator\">=</span> <span class=\"token number\">11111</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token comment\">// 目的地，canal server 里面的一个队列</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token class-name\">String</span>  DESTINATION <span class=\"token operator\">=</span> <span class=\"token string\">\"example\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token class-name\">String</span> USERNAME <span class=\"token operator\">=</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token class-name\">String</span> PASSWORD <span class=\"token operator\">=</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token class-name\">Integer</span> BATCHSIZE <span class=\"token operator\">=</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span>  <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        <span class=\"token keyword\">int</span> emptyCount <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        <span class=\"token comment\">// 连接</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        <span class=\"token class-name\">CanalConnector</span> connector <span class=\"token operator\">=</span> <span class=\"token class-name\">CanalConnectors</span><span class=\"token punctuation\">.</span><span class=\"token function\">newSingleConnector</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">InetSocketAddress</span><span class=\"token punctuation\">(</span>SERVER_ADDRESS<span class=\"token punctuation\">,</span> PORT<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> DESTINATION<span class=\"token punctuation\">,</span>USERNAME<span class=\"token punctuation\">,</span> PASSWORD<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        <span class=\"token keyword\">try</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>            connector<span class=\"token punctuation\">.</span><span class=\"token function\">connect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>            <span class=\"token comment\">// 订阅</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>            connector<span class=\"token punctuation\">.</span><span class=\"token function\">subscribe</span><span class=\"token punctuation\">(</span><span class=\"token string\">\".*\\\\..*\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>            <span class=\"token comment\">// 回滚到上次 ack 的位置</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>            connector<span class=\"token punctuation\">.</span><span class=\"token function\">rollback</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>            <span class=\"token keyword\">while</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>                <span class=\"token comment\">// 获取指定数量的数据，不做确认</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>                <span class=\"token class-name\">Message</span> message <span class=\"token operator\">=</span> connector<span class=\"token punctuation\">.</span><span class=\"token function\">getWithoutAck</span><span class=\"token punctuation\">(</span>BATCHSIZE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>                <span class=\"token keyword\">long</span> batchId <span class=\"token operator\">=</span> message<span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>                <span class=\"token keyword\">int</span> size <span class=\"token operator\">=</span> message<span class=\"token punctuation\">.</span><span class=\"token function\">getEntries</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">size</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>                <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>batchId <span class=\"token operator\">==</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span> <span class=\"token operator\">&amp;&amp;</span> size <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>                    emptyCount<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>                    <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"empty count : \"</span> <span class=\"token operator\">+</span> emptyCount<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>                    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>                        <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">.</span><span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">10000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>                    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">InterruptedException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>                    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span><span class=\"token keyword\">else</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>                    <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"batchId-->\"</span><span class=\"token operator\">+</span>batchId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>                    <span class=\"token function\">printEntity</span><span class=\"token punctuation\">(</span>message<span class=\"token punctuation\">.</span><span class=\"token function\">getEntries</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>                    <span class=\"token comment\">//connector.ack(batchId);</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>                    <span class=\"token comment\">//connector.rollback(batchId)</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token keyword\">finally</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>            <span class=\"token comment\">// 关闭连接</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>            connector<span class=\"token punctuation\">.</span><span class=\"token function\">disconnect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">printEntity</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Entry</span><span class=\"token punctuation\">></span></span> entries<span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Entry</span> entry <span class=\"token operator\">:</span> entries<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>            <span class=\"token comment\">// 该条数据的数据类型是事务开始或事务结束，不是 binlog 二进制数据本身，就跳过继续处理</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>            <span class=\"token comment\">// 注意：这里是有 bug 的，当 mysql 开启 binlog，且为 Row 行模式，且开启了在 binlog 中显示原始 SQL。</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>            <span class=\"token comment\">// 这时就会有一种新增的类型：CanalEntry.EventType.QUERY</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>            <span class=\"token comment\">// 原始</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>            <span class=\"token comment\">//if (entry.getEntryType() == CanalEntry.EntryType.TRANSACTIONBEGIN || entry.getEntryType() == CanalEntry.EntryType.TRANSACTIONEND) &#123;</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>            <span class=\"token comment\">//    continue;</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>            <span class=\"token comment\">//&#125;</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>            <span class=\"token comment\">// 修改为 只保留 binlog 部分对应的 Entry 并解析</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>entry<span class=\"token punctuation\">.</span><span class=\"token function\">getEntryType</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token class-name\">EntryType</span><span class=\"token punctuation\">.</span>TRANSACTIONBEGIN <span class=\"token comment\">// 跳过事务开始的 Entry</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>                    <span class=\"token operator\">||</span> entry<span class=\"token punctuation\">.</span><span class=\"token function\">getEntryType</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token class-name\">EntryType</span><span class=\"token punctuation\">.</span>TRANSACTIONEND <span class=\"token comment\">// 跳过事务结束的 Entry</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>                    <span class=\"token operator\">||</span> entry<span class=\"token punctuation\">.</span><span class=\"token function\">getHeader</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getEventType</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token class-name\">EventType</span><span class=\"token punctuation\">.</span>QUERY <span class=\"token comment\">// 跳过事务为原始 SQL 的 Entry</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>            <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>                <span class=\"token keyword\">continue</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>entry<span class=\"token punctuation\">.</span><span class=\"token function\">getEntryType</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">!=</span><span class=\"token class-name\">EntryType</span><span class=\"token punctuation\">.</span>ROWDATA<span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>                <span class=\"token keyword\">continue</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>            <span class=\"token class-name\">RowChange</span> rowChage <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>            <span class=\"token keyword\">try</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>                rowChage <span class=\"token operator\">=</span> <span class=\"token class-name\">RowChange</span><span class=\"token punctuation\">.</span><span class=\"token function\">parseFrom</span><span class=\"token punctuation\">(</span>entry<span class=\"token punctuation\">.</span><span class=\"token function\">getStoreValue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span><span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Exception</span> e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>                <span class=\"token keyword\">throw</span>  <span class=\"token keyword\">new</span> <span class=\"token class-name\">RuntimeException</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"ERROR ## parser of eromanga-event has an error , data:\"</span> <span class=\"token operator\">+</span> entry<span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>                        e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>            <span class=\"token class-name\">EventType</span> eventType <span class=\"token operator\">=</span> rowChage<span class=\"token punctuation\">.</span><span class=\"token function\">getEventType</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>            <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>                    <span class=\"token class-name\">String</span><span class=\"token punctuation\">.</span><span class=\"token function\">format</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"================; binlog[%s:%s] , name[%s,%s] , eventType : %s \"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>                    entry<span class=\"token punctuation\">.</span><span class=\"token function\">getHeader</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getLogfileName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> entry<span class=\"token punctuation\">.</span><span class=\"token function\">getHeader</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getLogfileOffset</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>                    entry<span class=\"token punctuation\">.</span><span class=\"token function\">getHeader</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getSchemaName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> entry<span class=\"token punctuation\">.</span><span class=\"token function\">getHeader</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getTableName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>                    eventType<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre>            <span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">RowData</span> rowData <span class=\"token operator\">:</span>rowChage<span class=\"token punctuation\">.</span><span class=\"token function\">getRowDatasList</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre>                <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"------->; before\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>                <span class=\"token function\">printColumn</span><span class=\"token punctuation\">(</span>rowData<span class=\"token punctuation\">.</span><span class=\"token function\">getBeforeColumnsList</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre>                <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"------->; after\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre>                <span class=\"token function\">printColumn</span><span class=\"token punctuation\">(</span>rowData<span class=\"token punctuation\">.</span><span class=\"token function\">getAfterColumnsList</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"100\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"101\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"102\"></td><td><pre></pre></td></tr><tr><td data-num=\"103\"></td><td><pre></pre></td></tr><tr><td data-num=\"104\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">printColumn</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Column</span><span class=\"token punctuation\">></span></span> columns<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"105\"></td><td><pre><span class=\"token comment\">//        columns.stream().map(System.out.println);</span></pre></td></tr><tr><td data-num=\"106\"></td><td><pre>        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Column</span> column <span class=\"token operator\">:</span> columns<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"107\"></td><td><pre></pre></td></tr><tr><td data-num=\"108\"></td><td><pre>            <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span>column<span class=\"token punctuation\">.</span><span class=\"token function\">getName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">\" : \"</span> <span class=\"token operator\">+</span> column<span class=\"token punctuation\">.</span><span class=\"token function\">getValue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">\"    update=\"</span> <span class=\"token operator\">+</span> column<span class=\"token punctuation\">.</span><span class=\"token function\">getUpdated</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"109\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"110\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"111\"></td><td><pre></pre></td></tr><tr><td data-num=\"112\"></td><td><pre></pre></td></tr><tr><td data-num=\"113\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure></li>\n<li>\n<p><strong>控制台日志</strong></p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># insert into sampledata.tb_canal vlaues(1,'node1');</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># insert into sampledata.tb_canal vlaues(2,'node2');</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># update sampledata.tb_canal set name='node3' where id=1</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\"># delete from sampledata.tb_canal where id = 1;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\"># ------- 客户端日志 ---------------</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token punctuation\">;</span> binlog<span class=\"token punctuation\">[</span>mysql-bin.000008:5599050<span class=\"token punctuation\">]</span> , name<span class=\"token punctuation\">[</span>sampledata,tb_canal<span class=\"token punctuation\">]</span> , eventType <span class=\"token builtin class-name\">:</span> INSERT </pre></td></tr><tr><td data-num=\"8\"></td><td><pre>-------<span class=\"token operator\">></span><span class=\"token punctuation\">;</span> before</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>-------<span class=\"token operator\">></span><span class=\"token punctuation\">;</span> after</pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token function\">id</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span>    <span class=\"token assign-left variable\">update</span><span class=\"token operator\">=</span>true</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>name <span class=\"token builtin class-name\">:</span> node1    <span class=\"token assign-left variable\">update</span><span class=\"token operator\">=</span>true</pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token punctuation\">;</span> </pre></td></tr><tr><td data-num=\"13\"></td><td><pre>binlog<span class=\"token punctuation\">[</span>mysql-bin.000008:5599010<span class=\"token punctuation\">]</span> , name<span class=\"token punctuation\">[</span>sampledata,tb_canal<span class=\"token punctuation\">]</span> , eventType <span class=\"token builtin class-name\">:</span> INSERT </pre></td></tr><tr><td data-num=\"14\"></td><td><pre>-------<span class=\"token operator\">></span><span class=\"token punctuation\">;</span> before</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>-------<span class=\"token operator\">></span><span class=\"token punctuation\">;</span> after</pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token function\">id</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">2</span>    <span class=\"token assign-left variable\">update</span><span class=\"token operator\">=</span>true</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>name <span class=\"token builtin class-name\">:</span> node2    <span class=\"token assign-left variable\">update</span><span class=\"token operator\">=</span>true</pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token punctuation\">;</span> </pre></td></tr><tr><td data-num=\"20\"></td><td><pre>binlog<span class=\"token punctuation\">[</span>mysql-bin.000008:5599322<span class=\"token punctuation\">]</span> , name<span class=\"token punctuation\">[</span>sampledata,tb_canal<span class=\"token punctuation\">]</span> , eventType <span class=\"token builtin class-name\">:</span> UPDATE </pre></td></tr><tr><td data-num=\"21\"></td><td><pre>-------<span class=\"token operator\">></span><span class=\"token punctuation\">;</span> before</pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token function\">id</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span>    <span class=\"token assign-left variable\">update</span><span class=\"token operator\">=</span>false</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>name <span class=\"token builtin class-name\">:</span> node1    <span class=\"token assign-left variable\">update</span><span class=\"token operator\">=</span>false</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>-------<span class=\"token operator\">></span><span class=\"token punctuation\">;</span> after</pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token function\">id</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span>    <span class=\"token assign-left variable\">update</span><span class=\"token operator\">=</span>false</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>name <span class=\"token builtin class-name\">:</span> node3    <span class=\"token assign-left variable\">update</span><span class=\"token operator\">=</span>true</pre></td></tr><tr><td data-num=\"27\"></td><td><pre></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token punctuation\">;</span> </pre></td></tr><tr><td data-num=\"29\"></td><td><pre>binlog<span class=\"token punctuation\">[</span>mysql-bin.000008:5599605<span class=\"token punctuation\">]</span> , name<span class=\"token punctuation\">[</span>sampledata,tb_canal<span class=\"token punctuation\">]</span> , eventType <span class=\"token builtin class-name\">:</span> DELETE </pre></td></tr><tr><td data-num=\"30\"></td><td><pre>-------<span class=\"token operator\">&amp;</span>gt<span class=\"token punctuation\">;</span> before</pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token function\">id</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span>    <span class=\"token assign-left variable\">update</span><span class=\"token operator\">=</span>false</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>name <span class=\"token builtin class-name\">:</span> node3    <span class=\"token assign-left variable\">update</span><span class=\"token operator\">=</span>false</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>-------<span class=\"token operator\">></span><span class=\"token punctuation\">;</span> after</pre></td></tr></table></figure></li>\n</ul>\n<h1 id=\"canal-kafka\"><a class=\"anchor\" href=\"#canal-kafka\">#</a> Canal Kafka</h1>\n<ul>\n<li>\n<p><strong>properties 配置分为两部分：</strong></p>\n<ul>\n<li>canal.properties (系统根配置文件)</li>\n<li>instance.properties (instance 级别的配置文件，每个 instance 一份)</li>\n</ul>\n</li>\n<li>\n<p><strong>canal.properties 相关配置</strong></p>\n<figure class=\"highlight properties\"><figcaption data-lang=\".properties\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 将 binglog 输出到 kafka</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token attr-name\">canal.serverMode</span> <span class=\"token punctuation\">=</span> <span class=\"token attr-value\">kafka</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\"># 默认实例文件夹，多个用逗号分隔</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token attr-name\">canal.destinations</span> <span class=\"token punctuation\">=</span> <span class=\"token attr-value\">example</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\"># 配置文件目录</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token attr-name\">canal.conf.dir</span> <span class=\"token punctuation\">=</span> <span class=\"token attr-value\">../conf</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\"># 自动扫描实例目录添加 / 删除和启动 / 停止实例</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token comment\">#canal.auto.scan = true</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token comment\"># 只接受 dml </span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token attr-name\">canal.instance.filter.druid.ddl</span> <span class=\"token punctuation\">=</span> <span class=\"token attr-value\">true</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token attr-name\">canal.instance.filter.query.dcl</span> <span class=\"token punctuation\">=</span> <span class=\"token attr-value\">false</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token attr-name\">canal.instance.filter.query.dml</span> <span class=\"token punctuation\">=</span> <span class=\"token attr-value\">false</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token attr-name\">canal.instance.filter.query.ddl</span> <span class=\"token punctuation\">=</span> <span class=\"token attr-value\">true</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token attr-name\">canal.instance.filter.table.error</span> <span class=\"token punctuation\">=</span> <span class=\"token attr-value\">false</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token comment\"># 配置 kafka ，多台用 逗号 分隔</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token attr-name\">canal.mq.servers</span> <span class=\"token punctuation\">=</span> <span class=\"token attr-value\">10.34.11.154:6667,10.34.11.142:6667,10.34.11.142:6667</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token comment\"># 使用 json 格式</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token attr-name\">canal.mq.flatMessage</span> <span class=\"token punctuation\">=</span> <span class=\"token attr-value\">true</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token attr-name\">canal.mq.acks</span> <span class=\"token punctuation\">=</span> <span class=\"token attr-value\">all</span></pre></td></tr></table></figure></li>\n<li>\n<p><strong>example/instance.properties</strong></p>\n<figure class=\"highlight properties\"><figcaption data-lang=\".properties\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 模拟 mysql slave 节点 id，不能重复</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token attr-name\">canal.instance.mysql.slaveId</span><span class=\"token punctuation\">=</span><span class=\"token attr-value\">100</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># mysql 节点</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token attr-name\">canal.instance.master.address</span><span class=\"token punctuation\">=</span><span class=\"token attr-value\">127.0.0.1:3306</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\"># 用户密码 编码</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token attr-name\">canal.instance.dbUsername</span><span class=\"token punctuation\">=</span><span class=\"token attr-value\">canal</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token attr-name\">canal.instance.dbPassword</span><span class=\"token punctuation\">=</span><span class=\"token attr-value\">canal</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token attr-name\">canal.instance.connectionCharset</span> <span class=\"token punctuation\">=</span> <span class=\"token attr-value\">UTF-8</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token comment\"># mq config</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token comment\"># kafka 主体</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token attr-name\">canal.mq.topic</span><span class=\"token punctuation\">=</span><span class=\"token attr-value\">example_2</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token comment\"># canal 1.1.3 版本之后 允许对匹配条件的规则指定发送的 topic 名字</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token comment\"># 例子 1: test:test\\\\.test 指定匹配的单表，发送到以 test 为名字的 topic 上</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token comment\"># 例子 2: test:.*\\\\..* 匹配所有表，因为有指定 topic，则每个表都会发送到 test 的 topic 下</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token comment\"># 例子 3: test:test 指定匹配对应的库，一个库的所有表都会发送到 test 的 topic 下</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token comment\"># 例子 4：testA:test\\\\.* 指定匹配的表达式，针对匹配的表会发送到 testA 的 topic 下</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token comment\"># 例子 5：test0:test,test1:test1\\\\.test1，指定多个表达式，会将 test 库的表都发送到 test0 的 topic 下，# test1\\\\.test1 的表发送到对应的 test1 的 topic 下，其余的表发送到默认的 canal.mq.topic 值</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token attr-name\">canal.mq.dynamicTopic</span><span class=\"token punctuation\">=</span><span class=\"token attr-value\">boostrapA:boostrap </span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token comment\"># 单队列模式的分区下标，</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token attr-name\">canal.mq.partition</span><span class=\"token punctuation\">=</span><span class=\"token attr-value\">0</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token comment\"># hash partition config</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token comment\">#散列模式的分区数</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token comment\">#canal.mq.partitionsNum=3</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token comment\"># canal 1.1.3 版本之后，支持配置格式：schema.table:pk1^pk2，多个配置之间使用逗号分隔</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token comment\"># 例子 1：test\\\\.test:pk1^pk2 指定匹配的单表，对应的 hash 字段为 pk1 + pk2</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token comment\"># 例子 2：.*\\\\..*:id 正则匹配，指定所有正则匹配的表对应的 hash 字段为 id</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token comment\"># 例子 3：.*\\\\..*:$pk$ 正则匹配，指定所有正则匹配的表对应的 hash 字段为表主键 (自动查找)</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token comment\"># 例子 4: 匹配规则啥都不写，则默认发到 0 这个 partition 上</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token comment\"># 例子 5：.*\\\\..* ，不指定 pk 信息的正则匹配，将所有正则匹配的表，对应的 hash 字段为表名</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre><span class=\"token comment\"># 按表 hash: 一张表的所有数据可以发到同一个分区，不同表之间会做散列 (会有热点表分区过大问题)</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token comment\"># 例子 6: test\\\\.test:id,.\\\\..* , 针对 test 的表按照 id 散列，其余的表按照 table 散列</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre></pre></td></tr><tr><td data-num=\"37\"></td><td><pre><span class=\"token comment\">#canal.mq.partitionHash=test.table:id^name,.*\\\\..*</span></pre></td></tr></table></figure><p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL2FsaWJhYmEvY2FuYWwvd2lraS9DYW5hbC1LYWZrYS1Sb2NrZXRNUS1RdWlja1N0YXJ0\">Canal-Kafka 更多相关配置</span></p>\n</li>\n<li>\n<p><strong>启动</strong></p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>bin/bin/startup.sh</pre></td></tr></table></figure></li>\n<li>\n<p><strong>kafka 查看</strong></p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>bin/kafka-console-consumer.sh --bootstrap-server <span class=\"token number\">10.34</span>.11.154:6667 --topic example_2</pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#123;</span><span class=\"token string\">\"data\"</span>:<span class=\"token punctuation\">[</span><span class=\"token punctuation\">&#123;</span><span class=\"token string\">\"a\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"1\"</span>,<span class=\"token string\">\"b\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"10\"</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">]</span>,<span class=\"token string\">\"database\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"sampledata\"</span>,<span class=\"token string\">\"es\"</span>:1591081315000,<span class=\"token string\">\"id\"</span>:2,<span class=\"token string\">\"isDdl\"</span>:false,<span class=\"token string\">\"mysqlType\"</span>:<span class=\"token punctuation\">&#123;</span><span class=\"token string\">\"a\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"int(11)\"</span>,<span class=\"token string\">\"b\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"char(11)\"</span><span class=\"token punctuation\">&#125;</span>,<span class=\"token string\">\"old\"</span>:<span class=\"token punctuation\">[</span><span class=\"token punctuation\">&#123;</span><span class=\"token string\">\"b\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"1\"</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">]</span>,<span class=\"token string\">\"pkNames\"</span>:<span class=\"token punctuation\">[</span><span class=\"token string\">\"a\"</span><span class=\"token punctuation\">]</span>,<span class=\"token string\">\"sql\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"\"</span>,<span class=\"token string\">\"sqlType\"</span>:<span class=\"token punctuation\">&#123;</span><span class=\"token string\">\"a\"</span>:4,<span class=\"token string\">\"b\"</span>:1<span class=\"token punctuation\">&#125;</span>,<span class=\"token string\">\"table\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"tb3\"</span>,<span class=\"token string\">\"ts\"</span>:1591081315384,<span class=\"token string\">\"type\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"UPDATE\"</span><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre> <span class=\"token punctuation\">&#123;</span><span class=\"token string\">\"data\"</span>:null,<span class=\"token string\">\"database\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"sampledata\"</span>,<span class=\"token string\">\"es\"</span>:1591081442000,<span class=\"token string\">\"id\"</span>:3,<span class=\"token string\">\"isDdl\"</span>:true,<span class=\"token string\">\"mysqlType\"</span>:null,<span class=\"token string\">\"old\"</span>:null,<span class=\"token string\">\"pkNames\"</span>:null,<span class=\"token string\">\"sql\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"\"</span>,<span class=\"token string\">\"sqlType\"</span>:null,<span class=\"token string\">\"table\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"tb4\"</span>,<span class=\"token string\">\"ts\"</span>:1591081442795,<span class=\"token string\">\"type\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"CREATE\"</span><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre> </pre></td></tr><tr><td data-num=\"7\"></td><td><pre> <span class=\"token punctuation\">&#123;</span><span class=\"token string\">\"data\"</span>:null,<span class=\"token string\">\"database\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"sampledata\"</span>,<span class=\"token string\">\"es\"</span>:1591081475000,<span class=\"token string\">\"id\"</span>:4,<span class=\"token string\">\"isDdl\"</span>:true,<span class=\"token string\">\"mysqlType\"</span>:null,<span class=\"token string\">\"old\"</span>:null,<span class=\"token string\">\"pkNames\"</span>:null,<span class=\"token string\">\"sql\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"\"</span>,<span class=\"token string\">\"sqlType\"</span>:null,<span class=\"token string\">\"table\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"tb4\"</span>,<span class=\"token string\">\"ts\"</span>:1591081475975,<span class=\"token string\">\"type\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"ERASE\"</span><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">&#123;</span><span class=\"token string\">\"data\"</span>:<span class=\"token punctuation\">[</span><span class=\"token punctuation\">&#123;</span><span class=\"token string\">\"a\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"1\"</span>,<span class=\"token string\">\"b\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"10\"</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">]</span>,<span class=\"token string\">\"database\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"sampledata\"</span>,<span class=\"token string\">\"es\"</span>:1591081646000,<span class=\"token string\">\"id\"</span>:5,<span class=\"token string\">\"isDdl\"</span>:false,<span class=\"token string\">\"mysqlType\"</span>:<span class=\"token punctuation\">&#123;</span><span class=\"token string\">\"a\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"int(11)\"</span>,<span class=\"token string\">\"b\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"char(11)\"</span><span class=\"token punctuation\">&#125;</span>,<span class=\"token string\">\"old\"</span>:null,<span class=\"token string\">\"pkNames\"</span>:<span class=\"token punctuation\">[</span><span class=\"token string\">\"a\"</span><span class=\"token punctuation\">]</span>,<span class=\"token string\">\"sql\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"\"</span>,<span class=\"token string\">\"sqlType\"</span>:<span class=\"token punctuation\">&#123;</span><span class=\"token string\">\"a\"</span>:4,<span class=\"token string\">\"b\"</span>:1<span class=\"token punctuation\">&#125;</span>,<span class=\"token string\">\"table\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"tb3\"</span>,<span class=\"token string\">\"ts\"</span>:1591081647060,<span class=\"token string\">\"type\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"DELETE\"</span><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure></li>\n<li>\n<p><strong>偏移量保存</strong></p>\n<p>单机下 binlog 的偏移量是保存在  文件夹下的 meta.dat</p>\n<pre><code>&#123;&quot;clientDatas&quot;:[&#123;&quot;clientIdentity&quot;:&#123;&quot;clientId&quot;:1001,&quot;destination&quot;:&quot;example&quot;,&quot;filter&quot;:&quot;&quot;&#125;,&quot;cursor&quot;:&#123;&quot;identity&quot;:&#123;&quot;slaveId&quot;:-1,&quot;sourceAddress&quot;:&#123;&quot;address&quot;:&quot;localhost&quot;,&quot;port&quot;:3306&#125;&#125;,&quot;postion&quot;:&#123;&quot;gtid&quot;:&quot;&quot;,&quot;included&quot;:false,&quot;journalName&quot;:&quot;mysql-bin.000008&quot;,&quot;position&quot;:5601892,&quot;serverId&quot;:1,&quot;timestamp&quot;:1591343595000&#125;&#125;&#125;],&quot;destination&quot;:&quot;example&quot;&#125;\n</code></pre>\n</li>\n</ul>\n<h1 id=\"搭建canal环境ha\"><a class=\"anchor\" href=\"#搭建canal环境ha\">#</a> 搭建 canal 环境 (HA)</h1>\n<ul>\n<li>\n<p><strong>机器准备</strong></p>\n<ul>\n<li>\n<p>2 台 canal 服务器节点：10.34.11.136,  10.34.11.65</p>\n</li>\n<li>\n<p>3 台 zookeeper 节点：10.34.11.70 ,10.34.11.133  ,10.34.11.124</p>\n</li>\n<li>\n<p>mysql 服务器： 10.34.12.185</p>\n</li>\n</ul>\n</li>\n<li>\n<p><strong>修改配置文件，在单台机器上各自完成配置</strong></p>\n<p><strong>canal.propertis</strong></p>\n<figure class=\"highlight properties\"><figcaption data-lang=\".properties\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token attr-name\">canal.zkServers</span><span class=\"token punctuation\">=</span><span class=\"token attr-value\">10.34.11.70:2181,10.34.11.133:2181,10.34.11.124:2181</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token attr-name\"> canal.instance.global.spring.xml</span> <span class=\"token punctuation\">=</span> <span class=\"token attr-value\">classpath:spring/default-instance.xml</span></pre></td></tr></table></figure><p><strong>example/instance.properties</strong></p>\n<figure class=\"highlight properties\"><figcaption data-lang=\".properties\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token attr-name\">canal.instance.mysql.slaveId</span> <span class=\"token punctuation\">=</span> <span class=\"token attr-value\">1234 ##另外一台机器改成1235，保证slaveId不重复即可</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token attr-name\">canal.instance.master.address</span> <span class=\"token punctuation\">=</span> <span class=\"token attr-value\">10.34.12.185:3306</span></pre></td></tr></table></figure></li>\n<li>\n<p><strong>运行</strong></p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 查看 zookeeper 节点信息</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>get /otter/canal/destinations/example/running</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token punctuation\">&#123;</span><span class=\"token string\">\"active\"</span>:true,<span class=\"token string\">\"address\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"10.34.11.136:11111\"</span><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  cZxid <span class=\"token operator\">=</span> 0x4b00016f22</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  ctime <span class=\"token operator\">=</span> Wed Jun 03 <span class=\"token number\">16</span>:09:55 CST <span class=\"token number\">2020</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  mZxid <span class=\"token operator\">=</span> 0x4b00016f22</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  mtime <span class=\"token operator\">=</span> Wed Jun 03 <span class=\"token number\">16</span>:09:55 CST <span class=\"token number\">2020</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  pZxid <span class=\"token operator\">=</span> 0x4b00016f22</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  cversion <span class=\"token operator\">=</span> <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  dataVersion <span class=\"token operator\">=</span> <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  aclVersion <span class=\"token operator\">=</span> <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  ephemeralOwner <span class=\"token operator\">=</span> 0x37258e330ff1bb0</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  dataLength <span class=\"token operator\">=</span> <span class=\"token number\">44</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  numChildren <span class=\"token operator\">=</span> <span class=\"token number\">0</span></pre></td></tr></table></figure></li>\n</ul>\n<h2 id=\"触发ha自动切换场景-serverclient-ha模式都有效\"><a class=\"anchor\" href=\"#触发ha自动切换场景-serverclient-ha模式都有效\">#</a> 触发 HA 自动切换场景 (server/client HA 模式都有效)</h2>\n<p><strong>正常关闭（bin/stop.sh）</strong></p>\n<ul>\n<li>正常关闭 canal server (会释放 instance 的所有资源，包括删除 running 节点)</li>\n<li>平滑切换 (gracefully)</li>\n</ul>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#操作：更新对应 instance 的 running 节点内容，将 \"active\" 设置为 false，对应的 running 节点收到消息后，会主动释放 running 节点，让出控制权但自己 jvm 不退出，gracefully.</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>get /otter/canal/destinations/example/running</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span><span class=\"token string\">\"active\"</span>:true,<span class=\"token string\">\"address\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"10.34.11.65:11111\"</span><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  cZxid <span class=\"token operator\">=</span> 0x4b0001e34e</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  ctime <span class=\"token operator\">=</span> Fri Jun 05 <span class=\"token number\">16</span>:04:59 CST <span class=\"token number\">2020</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  mZxid <span class=\"token operator\">=</span> 0x4b0001e34e</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  mtime <span class=\"token operator\">=</span> Fri Jun 05 <span class=\"token number\">16</span>:04:59 CST <span class=\"token number\">2020</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  pZxid <span class=\"token operator\">=</span> 0x4b0001e34e</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  cversion <span class=\"token operator\">=</span> <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  dataVersion <span class=\"token operator\">=</span> <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  aclVersion <span class=\"token operator\">=</span> <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  ephemeralOwner <span class=\"token operator\">=</span> 0x17258e335f01b6e</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  dataLength <span class=\"token operator\">=</span> <span class=\"token number\">45</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  numChildren <span class=\"token operator\">=</span> <span class=\"token number\">0</span></pre></td></tr></table></figure><pre><code>**异常场景**\n\n- canal server对应的jvm异常crash，running节点的释放会在对应的zookeeper session失效后，释放running节点(EPHEMERAL节点) &lt;font color='red'&gt;ps. session过期时间默认为zookeeper配置文件中定义的tickTime的20倍，如果不改动zookeeper配置，那默认就是40秒&lt;/font&gt;\n- canal server所在的网络出现闪断，导致zookeeper认为session失效，释放了running节点，此时canal server对应的jvm并未退出，(一种假死状态，非常特殊的情况) &lt;font color='red'&gt; ps.为了保护假死状态的canal server，避免因瞬间runing失效导致instance重新分布，所以做了一个策略：canal server在收到running节点释放后，延迟一段时间抢占running，原本running节点的拥有者可以不需要等待延迟，优先取得running节点，可以保证假死状态下尽可能不无谓的释放资源。 目前延迟时间的默认值为5秒，即running节点针对假死状态的保护期为5秒.&lt;/font&gt;\n</code></pre>\n<h1 id=\"canal-admin界面化安装\"><a class=\"anchor\" href=\"#canal-admin界面化安装\">#</a> canal-admin 界面化安装</h1>\n<ul>\n<li>\n<p><strong>下载</strong></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL2FsaWJhYmEvY2FuYWwvcmVsZWFzZXMvZG93bmxvYWQvY2FuYWwtMS4xLjQvY2FuYWwuYWRtaW4tMS4xLjQudGFyLmd6\">canal.admin-1.1.4</span></p>\n</li>\n<li>\n<p><strong>修改 conf/application.yml</strong></p>\n<figure class=\"highlight yml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key atrule\">server</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span> <span class=\"token number\">8089</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token key atrule\">spring</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token key atrule\">jackson</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token key atrule\">date-format</span><span class=\"token punctuation\">:</span> yyyy<span class=\"token punctuation\">-</span>MM<span class=\"token punctuation\">-</span>dd HH<span class=\"token punctuation\">:</span>mm<span class=\"token punctuation\">:</span>ss</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token key atrule\">time-zone</span><span class=\"token punctuation\">:</span> GMT+8</pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token key atrule\">spring.datasource</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token key atrule\">address</span><span class=\"token punctuation\">:</span> 127.0.0.1<span class=\"token punctuation\">:</span><span class=\"token number\">3306</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token key atrule\">database</span><span class=\"token punctuation\">:</span> canal_manager</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token key atrule\">username</span><span class=\"token punctuation\">:</span> canal</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  <span class=\"token key atrule\">password</span><span class=\"token punctuation\">:</span> canal</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  <span class=\"token key atrule\">driver-class-name</span><span class=\"token punctuation\">:</span> com.mysql.jdbc.Driver</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  <span class=\"token key atrule\">url</span><span class=\"token punctuation\">:</span> jdbc<span class=\"token punctuation\">:</span>mysql<span class=\"token punctuation\">:</span>//$<span class=\"token punctuation\">&#123;</span>spring.datasource.address<span class=\"token punctuation\">&#125;</span>/$<span class=\"token punctuation\">&#123;</span>spring.datasource.database<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">?</span>useUnicode=true<span class=\"token important\">&amp;characterEncoding=UTF-8&amp;useSSL=false</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  <span class=\"token key atrule\">hikari</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token key atrule\">maximum-pool-size</span><span class=\"token punctuation\">:</span> <span class=\"token number\">30</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token key atrule\">minimum-idle</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token key atrule\">canal</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  <span class=\"token key atrule\">adminUser</span><span class=\"token punctuation\">:</span> admin</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  <span class=\"token key atrule\">adminPasswd</span><span class=\"token punctuation\">:</span> 4ACFE3202A5FF5CF467898FC58AAB1D615029441</pre></td></tr></table></figure></li>\n<li>\n<p><strong>在 mysql 运行 conf/canal_manager.sql</strong></p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>root <span class=\"token operator\">-</span>ucanal <span class=\"token operator\">-</span>pcanal</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>source conf<span class=\"token operator\">/</span>canal_manager<span class=\"token punctuation\">.</span><span class=\"token keyword\">sql</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">use</span> canal_manager</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>mysql<span class=\"token operator\">></span> <span class=\"token keyword\">show</span> <span class=\"token keyword\">tables</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token operator\">+</span><span class=\"token comment\">-------------------------+</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token operator\">|</span> Tables_in_canal_manager <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token operator\">+</span><span class=\"token comment\">-------------------------+</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token operator\">|</span> canal_adapter_config    <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token operator\">|</span> canal_cluster           <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token operator\">|</span> canal_config            <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token operator\">|</span> canal_instance_config   <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token operator\">|</span> canal_node_server       <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token operator\">|</span> canal_user              <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token operator\">+</span><span class=\"token comment\">-------------------------+</span></pre></td></tr></table></figure></li>\n<li>\n<p><strong>启动</strong></p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>bin/starup.sh</pre></td></tr></table></figure><p><em>浏览器访问 127.0.0.1:8089 （默认用户 / 密码 admin/123456）</em></p>\n</li>\n<li>\n<p><strong>新建集群</strong></p>\n<p><img data-src=\"4.png\" alt=\"4\" /></p>\n</li>\n<li>\n<p><strong>选择编辑主配置</strong></p>\n<p><img data-src=\"5.png\" alt=\"image-20200605162605369\" /></p>\n</li>\n</ul>\n<figure class=\"highlight properties\"><figcaption data-lang=\".properties\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#################################################</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">######### \t\tcommon argument\t\t#############</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">#################################################</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\"># tcp bind ip</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token attr-name\">canal.ip</span> <span class=\"token attr-value\">=</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\"># register ip to zookeeper</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token attr-name\">canal.register.ip</span> <span class=\"token attr-value\">=</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token attr-name\">canal.port</span> <span class=\"token punctuation\">=</span> <span class=\"token attr-value\">11111</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token attr-name\">canal.metrics.pull.port</span> <span class=\"token punctuation\">=</span> <span class=\"token attr-value\">11112</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\"># canal instance user/passwd</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token comment\"># canal.user = canal</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token comment\"># canal.passwd = E3619321C1A937C46A0D8BD1DAC39F93B27D4458</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token comment\"># canal admin config</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token comment\">#canal.admin.manager = 127.0.0.1:8089</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token attr-name\">canal.admin.port</span> <span class=\"token punctuation\">=</span> <span class=\"token attr-value\">11110</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token attr-name\">canal.admin.user</span> <span class=\"token punctuation\">=</span> <span class=\"token attr-value\">admin</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token attr-name\">canal.admin.passwd</span> <span class=\"token punctuation\">=</span> <span class=\"token attr-value\">4ACFE3202A5FF5CF467898FC58AAB1D615029441</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token attr-name\">canal.zkServers</span> <span class=\"token punctuation\">=</span><span class=\"token attr-value\">10.34.11.70:2181,10.34.11.133:2181,10.34.11.124:2181</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token comment\"># flush data to zk</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token attr-name\">canal.zookeeper.flush.period</span> <span class=\"token punctuation\">=</span> <span class=\"token attr-value\">1000</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token attr-name\">canal.withoutNetty</span> <span class=\"token punctuation\">=</span> <span class=\"token attr-value\">false</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token comment\"># tcp, kafka, RocketMQ</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token attr-name\">canal.serverMode</span> <span class=\"token punctuation\">=</span> <span class=\"token attr-value\">kafka</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token comment\"># flush meta cursor/parse position to file</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token attr-name\">canal.file.data.dir</span> <span class=\"token punctuation\">=</span> <span class=\"token attr-value\">$&#123;canal.conf.dir&#125;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token attr-name\">canal.file.flush.period</span> <span class=\"token punctuation\">=</span> <span class=\"token attr-value\">1000</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token comment\">## memory store RingBuffer size, should be Math.pow(2,n)</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token attr-name\">canal.instance.memory.buffer.size</span> <span class=\"token punctuation\">=</span> <span class=\"token attr-value\">16384</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token comment\">## memory store RingBuffer used memory unit size , default 1kb</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token attr-name\">canal.instance.memory.buffer.memunit</span> <span class=\"token punctuation\">=</span> <span class=\"token attr-value\">1024 </span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token comment\">## meory store gets mode used MEMSIZE or ITEMSIZE</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre><span class=\"token attr-name\">canal.instance.memory.batch.mode</span> <span class=\"token punctuation\">=</span> <span class=\"token attr-value\">MEMSIZE</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token attr-name\">canal.instance.memory.rawEntry</span> <span class=\"token punctuation\">=</span> <span class=\"token attr-value\">true</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre></pre></td></tr><tr><td data-num=\"37\"></td><td><pre><span class=\"token comment\">## detecing config</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre><span class=\"token attr-name\">canal.instance.detecting.enable</span> <span class=\"token punctuation\">=</span> <span class=\"token attr-value\">false</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre><span class=\"token comment\">#canal.instance.detecting.sql = insert into retl.xdual values(1,now()) on duplicate key update x=now()</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre><span class=\"token attr-name\">canal.instance.detecting.sql</span> <span class=\"token punctuation\">=</span> <span class=\"token attr-value\">select 1</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre><span class=\"token attr-name\">canal.instance.detecting.interval.time</span> <span class=\"token punctuation\">=</span> <span class=\"token attr-value\">3</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre><span class=\"token attr-name\">canal.instance.detecting.retry.threshold</span> <span class=\"token punctuation\">=</span> <span class=\"token attr-value\">3</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre><span class=\"token attr-name\">canal.instance.detecting.heartbeatHaEnable</span> <span class=\"token punctuation\">=</span> <span class=\"token attr-value\">false</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre></pre></td></tr><tr><td data-num=\"45\"></td><td><pre><span class=\"token comment\"># support maximum transaction size, more than the size of the transaction will be cut into multiple transactions delivery</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre><span class=\"token attr-name\">canal.instance.transaction.size</span> <span class=\"token punctuation\">=</span>  <span class=\"token attr-value\">1024</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre><span class=\"token comment\"># mysql fallback connected to new master should fallback times</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre><span class=\"token attr-name\">canal.instance.fallbackIntervalInSeconds</span> <span class=\"token punctuation\">=</span> <span class=\"token attr-value\">60</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre></pre></td></tr><tr><td data-num=\"50\"></td><td><pre><span class=\"token comment\"># network config</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre><span class=\"token attr-name\">canal.instance.network.receiveBufferSize</span> <span class=\"token punctuation\">=</span> <span class=\"token attr-value\">16384</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre><span class=\"token attr-name\">canal.instance.network.sendBufferSize</span> <span class=\"token punctuation\">=</span> <span class=\"token attr-value\">16384</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre><span class=\"token attr-name\">canal.instance.network.soTimeout</span> <span class=\"token punctuation\">=</span> <span class=\"token attr-value\">30</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre></pre></td></tr><tr><td data-num=\"55\"></td><td><pre><span class=\"token comment\"># binlog filter config</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre><span class=\"token attr-name\">canal.instance.filter.druid.ddl</span> <span class=\"token punctuation\">=</span> <span class=\"token attr-value\">true</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre><span class=\"token attr-name\">canal.instance.filter.query.dcl</span> <span class=\"token punctuation\">=</span> <span class=\"token attr-value\">false</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre><span class=\"token attr-name\">canal.instance.filter.query.dml</span> <span class=\"token punctuation\">=</span> <span class=\"token attr-value\">false</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre><span class=\"token attr-name\">canal.instance.filter.query.ddl</span> <span class=\"token punctuation\">=</span> <span class=\"token attr-value\">false</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre><span class=\"token attr-name\">canal.instance.filter.table.error</span> <span class=\"token punctuation\">=</span> <span class=\"token attr-value\">false</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre><span class=\"token attr-name\">canal.instance.filter.rows</span> <span class=\"token punctuation\">=</span> <span class=\"token attr-value\">false</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre><span class=\"token attr-name\">canal.instance.filter.transaction.entry</span> <span class=\"token punctuation\">=</span> <span class=\"token attr-value\">false</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre></pre></td></tr><tr><td data-num=\"64\"></td><td><pre><span class=\"token comment\"># binlog format/image check</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre><span class=\"token attr-name\">canal.instance.binlog.format</span> <span class=\"token punctuation\">=</span> <span class=\"token attr-value\">ROW,STATEMENT,MIXED </span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre><span class=\"token attr-name\">canal.instance.binlog.image</span> <span class=\"token punctuation\">=</span> <span class=\"token attr-value\">FULL,MINIMAL,NOBLOB</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre></pre></td></tr><tr><td data-num=\"68\"></td><td><pre><span class=\"token comment\"># binlog ddl isolation</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre><span class=\"token attr-name\">canal.instance.get.ddl.isolation</span> <span class=\"token punctuation\">=</span> <span class=\"token attr-value\">false</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre></pre></td></tr><tr><td data-num=\"71\"></td><td><pre><span class=\"token comment\"># parallel parser config</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre><span class=\"token attr-name\">canal.instance.parser.parallel</span> <span class=\"token punctuation\">=</span> <span class=\"token attr-value\">true</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre><span class=\"token comment\">## concurrent thread number, default 60% available processors, suggest not to exceed Runtime.getRuntime().availableProcessors()</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre><span class=\"token comment\">#canal.instance.parser.parallelThreadSize = 16</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre><span class=\"token comment\">## disruptor ringbuffer size, must be power of 2</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre><span class=\"token attr-name\">canal.instance.parser.parallelBufferSize</span> <span class=\"token punctuation\">=</span> <span class=\"token attr-value\">256</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre></pre></td></tr><tr><td data-num=\"78\"></td><td><pre><span class=\"token comment\"># table meta tsdb info</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre><span class=\"token attr-name\">canal.instance.tsdb.enable</span> <span class=\"token punctuation\">=</span> <span class=\"token attr-value\">true</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre><span class=\"token attr-name\">canal.instance.tsdb.dir</span> <span class=\"token punctuation\">=</span> <span class=\"token attr-value\">$&#123;canal.file.data.dir:../conf&#125;/$&#123;canal.instance.destination:&#125;</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre><span class=\"token attr-name\">canal.instance.tsdb.url</span> <span class=\"token punctuation\">=</span> <span class=\"token attr-value\">jdbc:h2:$&#123;canal.instance.tsdb.dir&#125;/h2;CACHE_SIZE=1000;MODE=MYSQL;</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre><span class=\"token attr-name\">canal.instance.tsdb.dbUsername</span> <span class=\"token punctuation\">=</span> <span class=\"token attr-value\">canal</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre><span class=\"token attr-name\">canal.instance.tsdb.dbPassword</span> <span class=\"token punctuation\">=</span> <span class=\"token attr-value\">canal</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre><span class=\"token comment\"># dump snapshot interval, default 24 hour</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre><span class=\"token attr-name\">canal.instance.tsdb.snapshot.interval</span> <span class=\"token punctuation\">=</span> <span class=\"token attr-value\">24</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre><span class=\"token comment\"># purge snapshot expire , default 360 hour(15 days)</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre><span class=\"token attr-name\">canal.instance.tsdb.snapshot.expire</span> <span class=\"token punctuation\">=</span> <span class=\"token attr-value\">360</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre></pre></td></tr><tr><td data-num=\"89\"></td><td><pre><span class=\"token comment\"># aliyun ak/sk , support rds/mq</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre><span class=\"token attr-name\">canal.aliyun.accessKey</span> <span class=\"token attr-value\">=</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre><span class=\"token attr-name\">canal.aliyun.secretKey</span> <span class=\"token attr-value\">=</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre></pre></td></tr><tr><td data-num=\"93\"></td><td><pre><span class=\"token comment\">#################################################</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre><span class=\"token comment\">######### \t\tdestinations\t\t#############</span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre><span class=\"token comment\">#################################################</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre><span class=\"token comment\"># canal.destinations = example</span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre><span class=\"token comment\"># conf root dir</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre><span class=\"token attr-name\">canal.conf.dir</span> <span class=\"token punctuation\">=</span> <span class=\"token attr-value\">../conf</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre><span class=\"token comment\"># auto scan instance dir add/remove and start/stop instance</span></pre></td></tr><tr><td data-num=\"100\"></td><td><pre><span class=\"token attr-name\">canal.auto.scan</span> <span class=\"token punctuation\">=</span> <span class=\"token attr-value\">true</span></pre></td></tr><tr><td data-num=\"101\"></td><td><pre><span class=\"token attr-name\">canal.auto.scan.interval</span> <span class=\"token punctuation\">=</span> <span class=\"token attr-value\">5</span></pre></td></tr><tr><td data-num=\"102\"></td><td><pre></pre></td></tr><tr><td data-num=\"103\"></td><td><pre><span class=\"token attr-name\">canal.instance.tsdb.spring.xml</span> <span class=\"token punctuation\">=</span> <span class=\"token attr-value\">classpath:spring/tsdb/h2-tsdb.xml</span></pre></td></tr><tr><td data-num=\"104\"></td><td><pre><span class=\"token comment\">#canal.instance.tsdb.spring.xml = classpath:spring/tsdb/mysql-tsdb.xml</span></pre></td></tr><tr><td data-num=\"105\"></td><td><pre></pre></td></tr><tr><td data-num=\"106\"></td><td><pre><span class=\"token attr-name\">canal.instance.global.mode</span> <span class=\"token punctuation\">=</span> <span class=\"token attr-value\">spring</span></pre></td></tr><tr><td data-num=\"107\"></td><td><pre><span class=\"token attr-name\">canal.instance.global.lazy</span> <span class=\"token punctuation\">=</span> <span class=\"token attr-value\">false</span></pre></td></tr><tr><td data-num=\"108\"></td><td><pre><span class=\"token attr-name\">canal.instance.global.manager.address</span> <span class=\"token punctuation\">=</span> <span class=\"token attr-value\">$&#123;canal.admin.manager&#125;</span></pre></td></tr><tr><td data-num=\"109\"></td><td><pre><span class=\"token comment\">#canal.instance.global.spring.xml = classpath:spring/memory-instance.xml</span></pre></td></tr><tr><td data-num=\"110\"></td><td><pre><span class=\"token attr-name\">canal.instance.global.spring.xml</span> <span class=\"token punctuation\">=</span> <span class=\"token attr-value\">classpath:spring/file-instance.xml</span></pre></td></tr><tr><td data-num=\"111\"></td><td><pre><span class=\"token comment\">#canal.instance.global.spring.xml = classpath:spring/default-instance.xml</span></pre></td></tr><tr><td data-num=\"112\"></td><td><pre></pre></td></tr><tr><td data-num=\"113\"></td><td><pre><span class=\"token comment\">##################################################</span></pre></td></tr><tr><td data-num=\"114\"></td><td><pre><span class=\"token comment\">######### \t\t     MQ \t\t     #############</span></pre></td></tr><tr><td data-num=\"115\"></td><td><pre><span class=\"token comment\">##################################################</span></pre></td></tr><tr><td data-num=\"116\"></td><td><pre><span class=\"token attr-name\">canal.mq.servers</span> <span class=\"token punctuation\">=</span> <span class=\"token attr-value\">10.34.11.154:6667,10.34.11.142:6667,10.34.11.142:6667</span></pre></td></tr><tr><td data-num=\"117\"></td><td><pre><span class=\"token attr-name\">canal.mq.retries</span> <span class=\"token punctuation\">=</span> <span class=\"token attr-value\">0</span></pre></td></tr><tr><td data-num=\"118\"></td><td><pre><span class=\"token attr-name\">canal.mq.batchSize</span> <span class=\"token punctuation\">=</span> <span class=\"token attr-value\">16384</span></pre></td></tr><tr><td data-num=\"119\"></td><td><pre><span class=\"token attr-name\">canal.mq.maxRequestSize</span> <span class=\"token punctuation\">=</span> <span class=\"token attr-value\">1048576</span></pre></td></tr><tr><td data-num=\"120\"></td><td><pre><span class=\"token attr-name\">canal.mq.lingerMs</span> <span class=\"token punctuation\">=</span> <span class=\"token attr-value\">100</span></pre></td></tr><tr><td data-num=\"121\"></td><td><pre><span class=\"token attr-name\">canal.mq.bufferMemory</span> <span class=\"token punctuation\">=</span> <span class=\"token attr-value\">33554432</span></pre></td></tr><tr><td data-num=\"122\"></td><td><pre><span class=\"token attr-name\">canal.mq.canalBatchSize</span> <span class=\"token punctuation\">=</span> <span class=\"token attr-value\">50</span></pre></td></tr><tr><td data-num=\"123\"></td><td><pre><span class=\"token attr-name\">canal.mq.canalGetTimeout</span> <span class=\"token punctuation\">=</span> <span class=\"token attr-value\">100</span></pre></td></tr><tr><td data-num=\"124\"></td><td><pre><span class=\"token attr-name\">canal.mq.flatMessage</span> <span class=\"token punctuation\">=</span> <span class=\"token attr-value\">true</span></pre></td></tr><tr><td data-num=\"125\"></td><td><pre><span class=\"token attr-name\">canal.mq.compressionType</span> <span class=\"token punctuation\">=</span> <span class=\"token attr-value\">none</span></pre></td></tr><tr><td data-num=\"126\"></td><td><pre><span class=\"token attr-name\">canal.mq.acks</span> <span class=\"token punctuation\">=</span> <span class=\"token attr-value\">all</span></pre></td></tr><tr><td data-num=\"127\"></td><td><pre><span class=\"token comment\">#canal.mq.properties. =</span></pre></td></tr><tr><td data-num=\"128\"></td><td><pre><span class=\"token attr-name\">canal.mq.producerGroup</span> <span class=\"token punctuation\">=</span> <span class=\"token attr-value\">test</span></pre></td></tr><tr><td data-num=\"129\"></td><td><pre><span class=\"token comment\"># Set this value to \"cloud\", if you want open message trace feature in aliyun.</span></pre></td></tr><tr><td data-num=\"130\"></td><td><pre><span class=\"token attr-name\">canal.mq.accessChannel</span> <span class=\"token punctuation\">=</span> <span class=\"token attr-value\">local</span></pre></td></tr><tr><td data-num=\"131\"></td><td><pre><span class=\"token comment\"># aliyun mq namespace</span></pre></td></tr><tr><td data-num=\"132\"></td><td><pre><span class=\"token comment\">#canal.mq.namespace =</span></pre></td></tr><tr><td data-num=\"133\"></td><td><pre></pre></td></tr><tr><td data-num=\"134\"></td><td><pre><span class=\"token comment\">##################################################</span></pre></td></tr><tr><td data-num=\"135\"></td><td><pre><span class=\"token comment\">#########     Kafka Kerberos Info    #############</span></pre></td></tr><tr><td data-num=\"136\"></td><td><pre><span class=\"token comment\">##################################################</span></pre></td></tr><tr><td data-num=\"137\"></td><td><pre><span class=\"token attr-name\">canal.mq.kafka.kerberos.enable</span> <span class=\"token punctuation\">=</span> <span class=\"token attr-value\">false</span></pre></td></tr><tr><td data-num=\"138\"></td><td><pre><span class=\"token attr-name\">canal.mq.kafka.kerberos.krb5FilePath</span> <span class=\"token punctuation\">=</span> <span class=\"token attr-value\">\"../conf/kerberos/krb5.conf\"</span></pre></td></tr><tr><td data-num=\"139\"></td><td><pre><span class=\"token attr-name\">canal.mq.kafka.kerberos.jaasFilePath</span> <span class=\"token punctuation\">=</span> <span class=\"token attr-value\">\"../conf/kerberos/jaas.conf\"</span></pre></td></tr></table></figure><ul>\n<li>\n<p><strong>将上面 ha 搭建的两台 canal 停止</strong></p>\n</li>\n<li>\n<p><strong>分别修改 conf/canal_local.properties</strong></p>\n<figure class=\"highlight properties\"><figcaption data-lang=\".properties\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># register ip</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token attr-name\">canal.register.ip</span> <span class=\"token punctuation\">=</span><span class=\"token attr-value\">10.34.11.136</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\"># canal admin config</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\"># 绑定启动 canal.admin 的 ip:port</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token attr-name\">canal.admin.manager</span> <span class=\"token punctuation\">=</span> <span class=\"token attr-value\">10.34.12.185:8089</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token attr-name\">canal.admin.port</span> <span class=\"token punctuation\">=</span> <span class=\"token attr-value\">11110</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token attr-name\">canal.admin.user</span> <span class=\"token punctuation\">=</span> <span class=\"token attr-value\">admin</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token attr-name\">canal.admin.passwd</span> <span class=\"token punctuation\">=</span> <span class=\"token attr-value\">4ACFE3202A5FF5CF467898FC58AAB1D615029441</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\"># admin auto register</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token attr-name\">canal.admin.register.auto</span> <span class=\"token punctuation\">=</span> <span class=\"token attr-value\">true</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token comment\"># 填写页面写的集群名称</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token attr-name\">canal.admin.register.cluster</span> <span class=\"token punctuation\">=</span> <span class=\"token attr-value\">canal_cluster</span></pre></td></tr></table></figure></li>\n<li>\n<p><strong>在分别启动 canal</strong></p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>bin/starup.sh <span class=\"token builtin class-name\">local</span> conf/canal_local.properties</pre></td></tr></table></figure><p><em>在 server 管理里面会多服务器</em></p>\n<p><img data-src=\"3.png\" alt=\"image-20200605163745709\" /></p>\n</li>\n<li>\n<p><strong>新建 instance , 指定所属集群为 canal_cluster</strong></p>\n<figure class=\"highlight properties\"><figcaption data-lang=\".properties\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#################################################</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">## mysql serverId , v1.0.26+ will autoGen</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># canal.instance.mysql.slaveId=0</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\"># enable gtid use true/false</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token attr-name\">canal.instance.gtidon</span><span class=\"token punctuation\">=</span><span class=\"token attr-value\">false</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\"># position info</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token attr-name\">canal.instance.master.address</span><span class=\"token punctuation\">=</span><span class=\"token attr-value\">10.34.12.185:3306</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token attr-name\">canal.instance.master.journal.name</span><span class=\"token punctuation\">=</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token attr-name\">canal.instance.master.position</span><span class=\"token punctuation\">=</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token attr-name\">canal.instance.master.timestamp</span><span class=\"token punctuation\">=</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token attr-name\">canal.instance.master.gtid</span><span class=\"token punctuation\">=</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token comment\"># rds oss binlog</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token attr-name\">canal.instance.rds.accesskey</span><span class=\"token punctuation\">=</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token attr-name\">canal.instance.rds.secretkey</span><span class=\"token punctuation\">=</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token attr-name\">canal.instance.rds.instanceId</span><span class=\"token punctuation\">=</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token comment\"># table meta tsdb info</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token attr-name\">canal.instance.tsdb.enable</span><span class=\"token punctuation\">=</span><span class=\"token attr-value\">true</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token comment\"># username/password</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token attr-name\">canal.instance.dbUsername</span><span class=\"token punctuation\">=</span><span class=\"token attr-value\">canal</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token attr-name\">canal.instance.dbPassword</span><span class=\"token punctuation\">=</span><span class=\"token attr-value\">canal</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token attr-name\">canal.instance.connectionCharset</span> <span class=\"token punctuation\">=</span> <span class=\"token attr-value\">UTF-8</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token comment\"># enable druid Decrypt database password</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token attr-name\">canal.instance.enableDruid</span><span class=\"token punctuation\">=</span><span class=\"token attr-value\">false</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token comment\">#canal.instance.pwdPublicKey=MFwwDQYJKoZIhvcNAQEBBQADSwAwSAJBALK4BUxdDltRRE5/zXpVEVPUgunvscYFtEip3pmLlhrWpacX7y7GCMo2/JM6LeHmiiNdH1FWgGCpUfircSwlWKUCAwEAAQ==</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre></pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token comment\"># table regex</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token attr-name\">canal.instance.filter.regex</span><span class=\"token punctuation\">=</span><span class=\"token attr-value\">.*\\\\..*</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre><span class=\"token comment\"># table black regex</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token attr-name\">canal.instance.filter.black.regex</span><span class=\"token punctuation\">=</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre><span class=\"token comment\"># table field filter(format: schema1.tableName1:field1/field2,schema2.tableName2:field1/field2)</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre><span class=\"token comment\">#canal.instance.filter.field=test1.t_product:id/subject/keywords,test2.t_company:id/name/contact/ch</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre><span class=\"token comment\"># table field black filter(format: schema1.tableName1:field1/field2,schema2.tableName2:field1/field2)</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre><span class=\"token comment\">#canal.instance.filter.black.field=test1.t_product:subject/product_image,test2.t_company:id/name/contact/ch</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre></pre></td></tr><tr><td data-num=\"41\"></td><td><pre><span class=\"token comment\"># mq config</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre><span class=\"token attr-name\">canal.mq.topic</span><span class=\"token punctuation\">=</span><span class=\"token attr-value\">example_1</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre><span class=\"token comment\"># dynamic topic route by schema or table regex</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre><span class=\"token comment\">#canal.mq.dynamicTopic=mytest1.user,mytest2\\\\..*,.*\\\\..*</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre><span class=\"token attr-name\">canal.mq.partition</span><span class=\"token punctuation\">=</span><span class=\"token attr-value\">0</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre><span class=\"token comment\"># hash partition config</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre><span class=\"token comment\">#canal.mq.partitionsNum=3</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre><span class=\"token comment\">#canal.mq.partitionHash=test.table:id^name,.*\\\\..*</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre><span class=\"token comment\">#################################################</span></pre></td></tr></table></figure></li>\n</ul>\n",
            "tags": [
                "计算机科学",
                "IT运维",
                "cannal"
            ]
        },
        {
            "id": "http://yrmlnf.coding-pages.com/Spring-%E5%9F%BA%E6%9C%AC%E7%89%B9%E6%80%A7%E4%B8%8E%E5%8E%9F%E7%90%86/",
            "url": "http://yrmlnf.coding-pages.com/Spring-%E5%9F%BA%E6%9C%AC%E7%89%B9%E6%80%A7%E4%B8%8E%E5%8E%9F%E7%90%86/",
            "title": "Spring-基本特性与原理",
            "date_published": "2021-02-25T05:33:00.000Z",
            "content_html": "<h1 id=\"向切面编程\"><a class=\"anchor\" href=\"#向切面编程\">#</a> 向切面编程</h1>\n<p>AOP（Aspect Oriented Programming，缩写为 AOP）指面向切面编程。AOP 为开发者提供了一种描述横切关注点的机制，并能自动将横切关注点织入到面向对象的软件系统，从而实现面向切面的模块化。换句话来说，AOP 其实与拦截器类似，可以为我们关注的对象在执行某些方法前后执行我们想要的逻辑。<br />\nAOP 能够将那些与业务无关，却为业务模块所共同调用的逻辑或责任，例如事务处理、日志管理、权限控制等，封装起来，便于减少系统的重复代码，降低模块间的耦合度，并有利于未来的可操作性和可维护性。</p>\n<h2 id=\"术语\"><a class=\"anchor\" href=\"#术语\">#</a> 术语</h2>\n<ol>\n<li>连接点（join point）：<br />\n程序运行中的一些时间点，例如一个方法的执行，或者是一个异常的处理。在 Spring AOP 中，join point 总是方法的执行点，即只有方法连接点。通俗的讲，连接点即表示类里面可以被增强的方法</li>\n<li>切点（Point cut）<br />\n在 Spring 中，所有的方法都可以认为是连接点（join point）, 但是我们并不希望在所有的方法上都添加增强代码 (Advice)，而切点（pointcut）的作用就是提供一组规则 (使用 AspectJ pointcut expression language 来描述) 来匹配（join point），给满足规则的连接点（join point）添加增强代码 (Advice)。即切面类里你关注的方法</li>\n<li>增强（Advice）<br />\n又称通知，增强指得当拦截到连接点之后所要做的事，就是我们切入的代码。增强又分为<br />\n（1）前置增强<br />\n（2）后置增强<br />\n（3）异常增强<br />\n（4）最终增强</li>\n<li>Aspect（切面）<br />\n切点（Point cut）+ 增强（Advice）= 切面</li>\n<li>织入（Weaving）<br />\n织入是一个过程，是将切面应用到目标对象从而创造出代理对象的过程。AOP 织入分为三种方式<br />\n（1）编译器织入，这要求使用特殊的 java 编译器<br />\n（2）类装载期织入，这要求使用特殊的类装载器<br />\n（3）动态代理织入，通过 jdk 的动态代理生成代理对象过程</li>\n</ol>\n<details class=\"info\"><summary>关于join point 和 point cut 的区别</summary><div>\n<p>在 Spring AOP 中，所有的方法执行都是 join point. 而 point cut 是一个描述信息，它修饰的是 join point, 通过 point cut, 我们就可以确定哪些 join point 可以被织入 Advice. 因此 join point 和 point cut 本质上就是两个不同纬度上的东西.<br />\nadvice 是在 join point 上执行的，而 point cut 规定了哪些 join point 可以执行哪些 advice</p>\n</div></details>\n<h2 id=\"java代理\"><a class=\"anchor\" href=\"#java代理\">#</a> JAVA 代理</h2>\n<p>spirng AOP 使用的是 JDK 的动态代理来实现的，所以要了解 AOP 的原理必须先理解 JAVA 的代理，JAVA 代理又分为静态代理，动态代理。代理是什么意思呢？就是当对象 A 要执行一个方法的时候，不让它直接执行，而是创建一个对象 B，对象 B 里有成员属性对象 A，通过 B 去调用 A 的方法。</p>\n<h3 id=\"静态代理\"><a class=\"anchor\" href=\"#静态代理\">#</a> 静态代理</h3>\n<p>静态代理的特点是，为每一个业务增强都提供一个代理类，由代理类来创建代理对象。下面我们通过静态代理来实现对转账业务进行身份验证.<br />\n 假设现在有一个 service，这就是上面提到的对象 A</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">IAccountService</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">void</span> <span class=\"token function\">transfer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">AccountServiceImpl</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">IAccountService</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token annotation punctuation\">@Override</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">transfer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"调用dao层,完成转账主业务.\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>现在我们创建一个代理类，即对象 B</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">AccountProxy</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">IAccountService</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token comment\">// 目标对象</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token class-name\">IAccountService</span> target<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token class-name\">AccountProxy</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">IAccountService</span> target<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>target <span class=\"token operator\">=</span> target<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>     * 代理方法，实现对目标方法的功能增强</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>     */</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token annotation punctuation\">@Override</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">transfer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        <span class=\"token function\">before</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        target<span class=\"token punctuation\">.</span><span class=\"token function\">transfer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>     * 前置增强</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>     */</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token keyword\">void</span> <span class=\"token function\">before</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"对转账人身份进行验证.\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>当我们要调用对象 A 的方法时候，改为调用代理对象的方法</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Client</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        <span class=\"token comment\">// 创建目标对象</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token class-name\">IAccountService</span> target <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">AccountServiceImpl</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token comment\">// 创建代理对象</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token class-name\">AccountProxy</span> proxy <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">AccountProxy</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        proxy<span class=\"token punctuation\">.</span><span class=\"token function\">transfer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>结果<span class=\"token operator\">:</span> </pre></td></tr><tr><td data-num=\"12\"></td><td><pre>对转账人身份进行验证<span class=\"token punctuation\">.</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>调用dao层<span class=\"token punctuation\">,</span>完成转账主业务<span class=\"token punctuation\">.</span></pre></td></tr></table></figure><p>这里 AccountServiceImpl 对象的 transfer () 就是连接点，AccountProxy 的 transfer () 就是切点，before () 就是增强。<br />\n然而如果用静态代理来实现 AOP 的话就太蠢了，这意味着我得写无限多的代理类，所以 Spring AOP 选择了动态代理</p>\n<h3 id=\"动态代理\"><a class=\"anchor\" href=\"#动态代理\">#</a> 动态代理</h3>\n<p>JDK 动态代理又分为 JDK 代理和 CGLIB 代理</p>\n<ul>\n<li>\n<p>JDK 代理<br />\n静态代理会为每一个业务增强都提供一个代理类，由代理类来创建代理对象，而动态代理并不存在代理类，代理对象直接由代理生成工具动态生成.</p>\n<ol>\n<li>\n<p>首先创建一个业务类</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">IAccountService</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token comment\">// 主业务逻辑：转账</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">void</span> <span class=\"token function\">transfer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">AccountServiceImpl</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">IAccountService</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token annotation punctuation\">@Override</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">transfer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"调用dao层,完成转账主业务.\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure></li>\n<li>\n<p>创建代理对象</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">AccountAdvice</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">InvocationHandler</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token comment\">// 目标对象</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token class-name\">IAccountService</span> target<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token class-name\">AccountAdvice</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">IAccountService</span> target<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>target <span class=\"token operator\">=</span> target<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>     * 代理方法，每次调用目标方法时都会进到这里</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>     */</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token annotation punctuation\">@Override</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token class-name\">Object</span> <span class=\"token function\">invoke</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Object</span> proxy<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Method</span> method<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Object</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">Throwable</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        <span class=\"token function\">before</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token keyword\">return</span> method<span class=\"token punctuation\">.</span><span class=\"token function\">invoke</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">,</span> args<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>     * 前置增强</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>     */</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token keyword\">void</span> <span class=\"token function\">before</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"对转账人身份进行验证.\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure></li>\n<li>\n<p>测试：</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Client</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>        <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>            <span class=\"token comment\">// 创建目标对象</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>            <span class=\"token class-name\">IAccountService</span> target <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">AccountServiceImpl</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>            <span class=\"token comment\">// 创建代理对象</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>            <span class=\"token class-name\">IAccountService</span> proxy <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">IAccountService</span><span class=\"token punctuation\">)</span> <span class=\"token class-name\">Proxy</span><span class=\"token punctuation\">.</span><span class=\"token function\">newProxyInstance</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">.</span><span class=\"token function\">getClass</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getClassLoader</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>                    target<span class=\"token punctuation\">.</span><span class=\"token function\">getClass</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getInterfaces</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>                    <span class=\"token keyword\">new</span> <span class=\"token class-name\">AccountAdvice</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>            <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>            proxy<span class=\"token punctuation\">.</span><span class=\"token function\">transfer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    结果<span class=\"token operator\">:</span> </pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    对转账人身份进行验证<span class=\"token punctuation\">.</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    调用dao层<span class=\"token punctuation\">,</span>完成转账主业务<span class=\"token punctuation\">.</span></pre></td></tr></table></figure></li>\n</ol>\n</li>\n<li>\n<p>CGLIB 代理<br />\n JDK 动态代理必须要有接口，但如果要代理一个没有接口的类该怎么办呢？这时我们可以使用 CGLIB 动态代理. CGLIB 动态代理的原理是生成目标类的子类，这个子类对象就是代理对象，代理对象是被增强过的.</p>\n<ol>\n<li>创建业务对象<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">AccountService</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">transfer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"调用dao层,完成转账主业务.\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure></li>\n<li>创建代理对象<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">AccountAdvice</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">MethodInterceptor</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>     * 代理方法，每次调用目标方法时都会进到这里</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>     */</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token annotation punctuation\">@Override</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token class-name\">Object</span> <span class=\"token function\">intercept</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Object</span> obj<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Method</span> method<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Object</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">,</span> <span class=\"token class-name\">MethodProxy</span> methodProxy<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">Throwable</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token function\">before</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token keyword\">return</span> methodProxy<span class=\"token punctuation\">.</span><span class=\"token function\">invokeSuper</span><span class=\"token punctuation\">(</span>obj<span class=\"token punctuation\">,</span> args<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token comment\">//        return method.invoke (obj, args);  这种也行</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>     * 前置增强</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>     */</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token keyword\">void</span> <span class=\"token function\">before</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"对转账人身份进行验证.\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure></li>\n<li>测试<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Client</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        <span class=\"token comment\">// 创建目标对象</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token class-name\">AccountService</span> target <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">AccountService</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token comment\">// 创建代理对象</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token class-name\">AccountService</span> proxy <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">AccountService</span><span class=\"token punctuation\">)</span> <span class=\"token class-name\">Enhancer</span><span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">.</span><span class=\"token function\">getClass</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>                <span class=\"token keyword\">new</span> <span class=\"token class-name\">AccountAdvice</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        proxy<span class=\"token punctuation\">.</span><span class=\"token function\">transfer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>结果<span class=\"token operator\">:</span> </pre></td></tr><tr><td data-num=\"13\"></td><td><pre>对转账人身份进行验证<span class=\"token punctuation\">.</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>调用dao层<span class=\"token punctuation\">,</span>完成转账主业务<span class=\"token punctuation\">.</span></pre></td></tr></table></figure></li>\n</ol>\n</li>\n</ul>\n<h3 id=\"jdk动态代理与cglib代理的区别\"><a class=\"anchor\" href=\"#jdk动态代理与cglib代理的区别\">#</a> JDK 动态代理与 CGLIB 代理的区别</h3>\n<ol>\n<li>区别：<br />\nJDK 是基于反射机制，生成一个实现代理接口的匿名类，然后重写方法，实现方法的增强.<br />\n 它生成类的速度很快，但是运行时因为是基于反射，调用后续的类操作会很慢.<br />\n 而且他是只能针对接口编程的.<br />\nCGLIB 是基于继承机制，继承被代理类，所以方法不要声明为 final, 然后重写父类方法达到增强了类的作用.<br />\n 它底层是基于 asm 第三方框架，是对代理对象类的 class 文件加载进来，通过修改其字节码生成子类来处理.<br />\n 生成类的速度慢，但是后续执行类的操作时候很快.<br />\n 可以针对类和接口.</li>\n<li>优劣<br />\n因为 jdk 是基于反射，CGLIB 是基于字节码。所以性能上会有差异.<br />\n 在老版本 CGLIB 的速度是 JDK 速度的 10 倍左右，但是 CGLIB 启动类比 JDK 慢 8 倍左右，但是实际上 JDK 的速度在版本升级的时候每次都提高很多性能，而 CGLIB 仍止步不前.<br />\n 在对 JDK 动态代理与 CGlib 动态代理的代码实验中看，1W 次执行下，JDK7 及 8 的动态代理性能比 CGlib 要好 20% 左右。</li>\n<li>Spring AOP 默认使用 JDK 动态代理</li>\n</ol>\n<h2 id=\"aop的原理\"><a class=\"anchor\" href=\"#aop的原理\">#</a> AOP 的原理</h2>\n<p>在了解了动态代理的原理后，接下来的事情就很简单了。AOP 实际就是通过反射自动地创建这些代理类，这就让我们可以集中注意力在增强上的编写而不用理会如何去做动态代理<br />\n下面模拟一下 AOP 的代理过程</p>\n<ol>\n<li>创建一个业务<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">IAccountService</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token comment\">// 主业务逻辑：转账</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">void</span> <span class=\"token function\">transfer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">AccountServiceImpl</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">IAccountService</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token annotation punctuation\">@Override</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">transfer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"调用dao层,完成转账主业务.\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure></li>\n<li>创建一个切面抽象类<br />\n定义一个切面抽象类，该类使用了模板方法的设计模式，为开始，结束，异常，前置增强，后置增强提供了默认实现，当我们定义切面类时只需要按需重写它们就行. isIntercept () 方法用来判断切入点是否正确，切面类需要重写这个方法.<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">abstract</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">BaseAspect</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">MethodInterceptor</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">Logger</span> logger <span class=\"token operator\">=</span> <span class=\"token class-name\">LoggerFactory</span><span class=\"token punctuation\">.</span><span class=\"token function\">getLogger</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">BaseAspect</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token annotation punctuation\">@Override</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token class-name\">Object</span> <span class=\"token function\">intercept</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Object</span> obj<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Method</span> method<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Object</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">,</span> <span class=\"token class-name\">MethodProxy</span> methodProxy<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">Throwable</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token class-name\">Object</span> result <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token function\">begin</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">isIntercept</span><span class=\"token punctuation\">(</span>method<span class=\"token punctuation\">,</span> args<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>                <span class=\"token function\">before</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>                result <span class=\"token operator\">=</span> methodProxy<span class=\"token punctuation\">.</span><span class=\"token function\">invokeSuper</span><span class=\"token punctuation\">(</span>obj<span class=\"token punctuation\">,</span> args<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>                <span class=\"token function\">after</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>                result <span class=\"token operator\">=</span> methodProxy<span class=\"token punctuation\">.</span><span class=\"token function\">invokeSuper</span><span class=\"token punctuation\">(</span>obj<span class=\"token punctuation\">,</span>args<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Exception</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>            logger<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"proxy failure\"</span><span class=\"token punctuation\">,</span> e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>            <span class=\"token function\">error</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>            <span class=\"token keyword\">throw</span> e<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">finally</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>            <span class=\"token function\">end</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        <span class=\"token keyword\">return</span> result<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    <span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>     * 开始增强</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>     */</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">begin</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    <span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>     * 切入点判断</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>     */</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">boolean</span> <span class=\"token function\">isIntercept</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Method</span> method<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Object</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">Throwable</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    <span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>     * 前置增强</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>     */</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">before</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">Throwable</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>    <span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>     * 后置增强</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>     */</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">after</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">Throwable</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>    <span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>     * 异常增强</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>     */</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Throwable</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>    <span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>     * 最终增强</pre></td></tr><tr><td data-num=\"60\"></td><td><pre>     */</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">end</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure></li>\n<li>创建一个切面类，类中配置切入点和增强.<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">AccountAspect</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">BaseAspect</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>     * 切入点</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>     */</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">boolean</span> <span class=\"token function\">isIntercept</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Method</span> method<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Object</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">Throwable</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token keyword\">return</span> method<span class=\"token punctuation\">.</span><span class=\"token function\">getName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">equals</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"transfer\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>     * 前置增强</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>     */</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">before</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">Throwable</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"对转账人身份进行验证.\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure></li>\n<li>代理工厂类<br />\n定义一个工厂类来创建代理，其实不创建这个类也行，但为了模仿 Spring 还是创建了. @SuppressWarnings 是为了抑制警告，就是编译器上面的黄线.<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">ProxyFactory</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token annotation punctuation\">@SuppressWarnings</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"unchecked\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">></span></span> <span class=\"token class-name\">T</span> <span class=\"token function\">createProxy</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">final</span> <span class=\"token class-name\">Class</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token operator\">?</span><span class=\"token punctuation\">></span></span> targetClass<span class=\"token punctuation\">,</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">MethodInterceptor</span> methodInterceptor<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">)</span> <span class=\"token class-name\">Enhancer</span><span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span>targetClass<span class=\"token punctuation\">,</span>methodInterceptor<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure></li>\n<li>测试<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Client</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        <span class=\"token comment\">// 创建目标对象</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token class-name\">IAccountService</span> target <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">AccountServiceImpl</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token comment\">// 切面</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token class-name\">BaseAspect</span> accountAspect <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">AccountAspect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token comment\">// 创建代理对象</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token class-name\">IAccountService</span> proxy <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">IAccountService</span><span class=\"token punctuation\">)</span> <span class=\"token class-name\">ProxyFactory</span><span class=\"token punctuation\">.</span><span class=\"token function\">createProxy</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">.</span><span class=\"token function\">getClass</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> accountAspect<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        proxy<span class=\"token punctuation\">.</span><span class=\"token function\">transfer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>结果<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>对转账人身份进行验证<span class=\"token punctuation\">.</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>调用dao层<span class=\"token punctuation\">,</span>完成转账主业务<span class=\"token punctuation\">.</span></pre></td></tr></table></figure></li>\n</ol>\n<p>上面已经完成 Spring AOP 的面向切面的基本功能了，再配合上 AOP 的一些注解便能很灵活的找到连接点然后进行增强。</p>\n<h2 id=\"aop的好处\"><a class=\"anchor\" href=\"#aop的好处\">#</a> AOP 的好处</h2>\n<ul>\n<li>降低模块的耦合度</li>\n<li>使系统容易扩展</li>\n<li>提高代码复用性</li>\n</ul>\n<h2 id=\"aop与拦截器异同\"><a class=\"anchor\" href=\"#aop与拦截器异同\">#</a> AOP 与拦截器异同</h2>\n<ol>\n<li>相同：<br />\nSpring AOP 和拦截器一样，都是 AOP 的实现方式的一种，均使用代理模式实现</li>\n<li>区别<br />\n（1）作用层面<br />\n拦截器只对 action 负责，作用层面一般位于 Controller 层<br />\n Spring AOP 主要是拦截对 Spring 管理的 Bean 的访问，一般作用与 Service 层<br />\n（2）功能层面<br />\n拦截器和过滤器有点相似，是链式的处理模式，这样有一个缺点就是，每次请求，都会访问 action 的上下文，不够灵活。Spring AOP 的注解有 @Before、@After、@AfterReturning、@AfterThrowing、@Around，可以更灵活的配置要监听处理的 Bean</li>\n</ol>\n<h1 id=\"控制反转\"><a class=\"anchor\" href=\"#控制反转\">#</a> 控制反转</h1>\n<p>IOC（Inversion of Control，缩写为 IoC）中文为控制反转，是面向对象编程中的一种设计原则，可以用来减低计算机代码之间的耦合度。IOC 的作用通俗来说就是帮我们创建对象，并将对象传递给执行的代码中<br />\n在 java 开发过程中，我们需要什么对象的时候就会 new 一个出来，而 IOC 做的就是当我们需要这个对象的时候它帮我们 new 一个出来，这时候创建对象的主体改变了，所以说是反转<br />\n Spring IOC 容器通过 xml, 注解等其它方式配置类及类之间的依赖关系，完成了对象的创建和依赖的管理注入。实现 IOC 的主要设计模式是工厂模式。</p>\n<h2 id=\"术语-2\"><a class=\"anchor\" href=\"#术语-2\">#</a> 术语</h2>\n<ol>\n<li>依赖注入<br />\n依赖注入（Dependency Injection，简称 DI），指我们平时在开发 java web 程序的时候，每个对象在需要使用它的合作对象时，自己都要将它要合作对象创建出来（比如 new 对象），这个合作对象是由自己主动创建出来的。创建合作对象的主动权在自己手上，需要时候就主动创建，这样耦合性很高。在这稍微解释一下耦合性概念：A 对象需要使用合作对象 B 来共同完成一件事，A 要使用 B，那么 A 就对 B 产生了依赖，也就是 A 和 B 之间存在一种耦合关系，并且是紧密耦合在一起。</li>\n<li>依赖查找<br />\n依赖查找（Dependency Lookup，简称 DL），DL 由 Martin Fowler 在 2004 年初的一篇论文中首次提出的。他总结：控制的什么被反转了？就是：获得依赖对象的方式反转了。</li>\n</ol>\n<h2 id=\"ioc原理\"><a class=\"anchor\" href=\"#ioc原理\">#</a> IOC 原理</h2>\n<p>IOC 主要做了三步</p>\n<ol>\n<li>创建 IOC 容器，用于存放对象</li>\n<li>通过 xml 或则注解获取类名，id，创建对象放进 IOC 容器</li>\n<li>在需要使用对象的时候，从容器中获取对象</li>\n</ol>\n<p>下面模拟 IOC</p>\n<ol>\n<li>模拟 IOC<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">BeanFactory</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token class-name\">Object</span> <span class=\"token function\">getBean</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">ClassPathXmlApplicationContext</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">BeanFactory</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token comment\">// 容器，用来存放注入的 Bean  </span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Map</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Object</span><span class=\"token punctuation\">></span></span> container <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">HashMap</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Object</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token comment\">// 解析 xml 文件，通过反射将配置的 bean 放到 container 中  </span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token class-name\">ClassPathXmlApplicationContext</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> fileName<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">Exception</span><span class=\"token punctuation\">&#123;</span>  </pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token class-name\">SAXBuilder</span> sb <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">SAXBuilder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> </pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token class-name\">Document</span> doc </pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        <span class=\"token operator\">=</span>sb<span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ClassPathXmlApplicationContext</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">.</span><span class=\"token function\">getResource</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/\"</span><span class=\"token operator\">+</span>fileName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        <span class=\"token class-name\">Element</span> root <span class=\"token operator\">=</span> doc<span class=\"token punctuation\">.</span><span class=\"token function\">getRootElement</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Element</span><span class=\"token punctuation\">></span></span> list <span class=\"token operator\">=</span> <span class=\"token class-name\">XPath</span><span class=\"token punctuation\">.</span><span class=\"token function\">selectNodes</span><span class=\"token punctuation\">(</span>root<span class=\"token punctuation\">,</span> <span class=\"token string\">\"/beans/bean\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> list<span class=\"token punctuation\">.</span><span class=\"token function\">size</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>              </pre></td></tr><tr><td data-num=\"20\"></td><td><pre>           <span class=\"token class-name\">Element</span> bean <span class=\"token operator\">=</span> list<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"21\"></td><td><pre>           <span class=\"token class-name\">String</span> id <span class=\"token operator\">=</span> bean<span class=\"token punctuation\">.</span><span class=\"token function\">getAttributeValue</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"id\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"22\"></td><td><pre>           <span class=\"token class-name\">String</span> clazz <span class=\"token operator\">=</span> bean<span class=\"token punctuation\">.</span><span class=\"token function\">getAttributeValue</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"class\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"23\"></td><td><pre>           <span class=\"token class-name\">Object</span> o <span class=\"token operator\">=</span> <span class=\"token class-name\">Class</span><span class=\"token punctuation\">.</span><span class=\"token function\">forName</span><span class=\"token punctuation\">(</span>clazz<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">newInstance</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"24\"></td><td><pre>           container<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">,</span> o<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"25\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span>  </pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    <span class=\"token annotation punctuation\">@Override</span>  </pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token class-name\">Object</span> <span class=\"token function\">getBean</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> id<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>        </pre></td></tr><tr><td data-num=\"29\"></td><td><pre>        <span class=\"token keyword\">return</span> container<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>  </pre></td></tr><tr><td data-num=\"31\"></td><td><pre></pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure></li>\n<li>创建对象</li>\n</ol>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">Animal</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>         <span class=\"token keyword\">void</span> <span class=\"token function\">say</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Dog</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">Animal</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token annotation punctuation\">@Override</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">say</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>             <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"汪汪\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> </pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Chicken</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">Animal</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        <span class=\"token annotation punctuation\">@Override</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">say</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>            <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"鸡你很美\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">People</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>            <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"小明-23岁\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t```</pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token number\">3.</span> 使用IOC</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>```java</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">Exception</span> <span class=\"token punctuation\">&#123;</span>  </pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>            <span class=\"token comment\">// 加载配置文件  </span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>            <span class=\"token class-name\">BeanFactory</span> f <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ClassPathXmlApplicationContext</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"applicationContext.xml\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"29\"></td><td><pre></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>            <span class=\"token class-name\">Object</span> os <span class=\"token operator\">=</span> f<span class=\"token punctuation\">.</span><span class=\"token function\">getBean</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"dog\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"31\"></td><td><pre>            <span class=\"token class-name\">Animal</span> dog <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Animal</span><span class=\"token punctuation\">)</span>os<span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"32\"></td><td><pre>            dog<span class=\"token punctuation\">.</span><span class=\"token function\">say</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"33\"></td><td><pre></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>            <span class=\"token class-name\">Object</span> op <span class=\"token operator\">=</span> f<span class=\"token punctuation\">.</span><span class=\"token function\">getBean</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"chicken\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"35\"></td><td><pre>            <span class=\"token class-name\">Animal</span> chicken <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Animal</span><span class=\"token punctuation\">)</span>op<span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"36\"></td><td><pre>            chicken<span class=\"token punctuation\">.</span><span class=\"token function\">say</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"37\"></td><td><pre></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>            <span class=\"token class-name\">Object</span> p <span class=\"token operator\">=</span> f<span class=\"token punctuation\">.</span><span class=\"token function\">getBean</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"people\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"39\"></td><td><pre>            <span class=\"token class-name\">People</span> people<span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Animal</span><span class=\"token punctuation\">)</span>p<span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"40\"></td><td><pre>            people<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"41\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span> </pre></td></tr><tr><td data-num=\"42\"></td><td><pre>\t```</pre></td></tr></table></figure>",
            "tags": [
                "计算机科学",
                "后端",
                "java",
                "spring"
            ]
        },
        {
            "id": "http://yrmlnf.coding-pages.com/%E7%A7%91%E5%AD%A6%E4%B8%8A%E7%BD%91-%E9%98%BF%E9%87%8C%E4%BA%91%E8%BD%BB%E9%87%8F%E7%BA%A7%E5%BA%94%E7%94%A8%E6%90%AD%E5%BB%BAVPN%E6%9C%8D%E5%8A%A1/",
            "url": "http://yrmlnf.coding-pages.com/%E7%A7%91%E5%AD%A6%E4%B8%8A%E7%BD%91-%E9%98%BF%E9%87%8C%E4%BA%91%E8%BD%BB%E9%87%8F%E7%BA%A7%E5%BA%94%E7%94%A8%E6%90%AD%E5%BB%BAVPN%E6%9C%8D%E5%8A%A1/",
            "title": "科学上网-阿里云轻量级应用搭建VPN服务",
            "date_published": "2021-01-06T07:46:00.000Z",
            "content_html": "<h1 id=\"概述\"><a class=\"anchor\" href=\"#概述\">#</a> 概述</h1>\n<p>本文通过在阿里云轻量级应用服务器部署 pptpd 服务器来达到通过该服务器 ip 访问外网的目的</p>\n<h1 id=\"准备工作\"><a class=\"anchor\" href=\"#准备工作\">#</a> 准备工作</h1>\n<p>首先得先购买一台阿里云轻量级应用服务器，<span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuYWxpeXVuLmNvbS8=\">进入阿里云</span></p>\n<ol>\n<li>点击产品，选择弹性计算 -&gt; 轻量级应用服务</li>\n</ol>\n<p><img data-src=\"1.png\" alt=\"轻量级应用服务\" /></p>\n<ol start=\"2\">\n<li>立即购买</li>\n</ol>\n<p><img data-src=\"2.png\" alt=\"立即购买\" /></p>\n<ol start=\"3\">\n<li>根据自己的需求选择购买，我选择了新加坡，centos7.3, 1 个月的服务器，一个月费用才 24，其实很划算。需要注意的是 linux 系统不能重装为 windows 系统，请谨慎选择</li>\n</ol>\n<p><img data-src=\"3.png\" alt=\"立即购买\" /></p>\n<ol start=\"4\">\n<li>付款后进入控制台后看见购买了的服务器</li>\n</ol>\n<p><img data-src=\"4.png\" alt=\"立即购买\" /></p>\n<ol start=\"5\">\n<li>点击服务器，点击安全 -&gt; 防火墙，开放 1723 端口，vpn 通过该端口来进行通信</li>\n</ol>\n<p><img data-src=\"5.png\" alt=\"立即购买\" /></p>\n<h1 id=\"安装pptpd\"><a class=\"anchor\" href=\"#安装pptpd\">#</a> 安装 pptpd</h1>\n<h2 id=\"配置pptpd文件\"><a class=\"anchor\" href=\"#配置pptpd文件\">#</a> 配置 pptpd 文件</h2>\n<ol>\n<li>查看系统是否支持<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>modprobe ppp-compress-18 <span class=\"token operator\">&amp;&amp;</span> <span class=\"token builtin class-name\">echo</span> <span class=\"token function\">yes</span></pre></td></tr></table></figure></li>\n<li>安装服务<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>yum -y update</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>yum <span class=\"token function\">install</span> -y ppp pptpd</pre></td></tr></table></figure><img data-src=\"6.png\" alt=\"安装服务\" /></li>\n<li>执行下面命令，编辑配置文件，删除下列两行命令符前面的 “#”，保存后退出，&lt;b&gt;localip 后面的是外网地址 &lt;/b&gt;<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">vi</span> /etc/pptpd.conf</pre></td></tr></table></figure>如下<pre><code>#          be set to the given one. You MUST still give at least one remote\n#          IP for each simultaneous client.\n#\n# (Recommended)\nlocalip 149.129.57.100\nremoteip 192.168.0.234-238\n# or\n</code></pre>\n<img data-src=\"7.png\" alt=\"编辑配置文件\" /></li>\n<li>执行下面命令，将 ms-dns 修改为 223.5.5.5 和 223.6.6.6。保存后退出<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">vi</span> /etc/ppp/options.pptpd</pre></td></tr></table></figure><img data-src=\"8.png\" alt=\"编辑options文件\" />\n<blockquote>\n<p>IP 地址 223.5.5.5 和 223.6.6.6 是阿里云的公共 DNS 服务器地址，您可以根据需要调整为其它公共 DNS 服务地址</p>\n</blockquote>\n</li>\n<li>执行下面命令，设置 pptpd 的用户名和密码。根据需要添加账号，一行只添加一个用户账号。按照 “用户名 pptpd 密码 IP 地址” 格式输入，每一项用空格隔开。保存后退出。<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">vi</span> /etc/ppp/chap-secrets</pre></td></tr></table></figure>如下<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># Secrets for authentication using CHAP</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># client server secret IP addresses</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token builtin class-name\">test</span> pptpd <span class=\"token number\">123456</span> *</pre></td></tr></table></figure><img data-src=\"9.png\" alt=\"编辑用户名和密码\" /></li>\n<li>执行下面命令，设置最大传输单元 MTU。在命令符 [-x /etc/ppp/ip-up.local] &amp;&amp; /etc/ppp/ip-up.local “$@” 下方添加 ifconfig ppp0 mtu 1472<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">vi</span> /etc/ppp/ip-up</pre></td></tr></table></figure>如下<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>/etc/ppp/ip-up. ipv6to4 <span class=\"token variable\">$&#123;LOGDEVICE&#125;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span> -x /etc/ppp/ip-up.local <span class=\"token punctuation\">]</span> <span class=\"token operator\">&amp;&amp;</span> /etc/ppp/ip-up.local “<span class=\"token variable\">$@</span>”</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">ifconfig</span> ppp0 mtu <span class=\"token number\">1472</span></pre></td></tr></table></figure><img data-src=\"10.png\" alt=\"最大传输单元\" /></li>\n</ol>\n<h2 id=\"设置内核参数\"><a class=\"anchor\" href=\"#设置内核参数\">#</a> 设置内核参数</h2>\n<ol>\n<li>执行<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">vi</span> /etc/sysctl.conf</pre></td></tr></table></figure></li>\n<li>编辑配置文件，最后一行添加 net.ipv4.ip_forward = 1，保存后退出。<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>net.ipv4.ip_forward <span class=\"token operator\">=</span> <span class=\"token number\">1</span></pre></td></tr></table></figure></li>\n<li>执行 sysctl -p 命令，使修改后的参数生效<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>sysctl -p</pre></td></tr></table></figure></li>\n</ol>\n<h2 id=\"防火墙配置\"><a class=\"anchor\" href=\"#防火墙配置\">#</a> 防火墙配置</h2>\n<ol>\n<li>\n<p>禁用防火墙</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>systemctl stop firewalld</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>systemctl disable firewalld</pre></td></tr></table></figure><p>或者开启相关端口</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>firewall-cmd --zone<span class=\"token operator\">=</span>public --add-port<span class=\"token operator\">=</span><span class=\"token number\">1723</span>/tcp --permanent</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>firewall-cmd --reload</pre></td></tr></table></figure></li>\n<li>\n<p>执行如下命令，添加 iptables 转发规则</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>iptables -t nat -A POSTROUTING -s <span class=\"token number\">192.168</span>.0.0/24 -j MASQUERADE</pre></td></tr></table></figure><blockquote>\n<p>注意这个转发规则，不通的架构，命令是不一样的<br />\n XEN 架构：iptables -t nat -A POSTROUTING -s 192.168.0.0/24 -o eth0 -j MASQUERADE<br />\nOpenVZ 架构：iptables -t nat -A POSTROUTING -s 192.168.0.0/24 -j SNAT --to-source VPS 公网 IP</p>\n</blockquote>\n<p>有个软件可以查看 vps 架构</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>yum <span class=\"token function\">install</span> virt-what</pre></td></tr></table></figure><p>输入 virt-what 就会显示当前架构</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>virt-what</pre></td></tr></table></figure></li>\n<li>\n<p>执行如下命令，添加 NAT 转发规则，其中 XXX.XXX.XXX.XXX 为您的实例公网 IP 地址</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>iptables -t nat -A POSTROUTING -s <span class=\"token number\">192.168</span>.0.0/255.255.255.0 -j SNAT --to-source XXX.XXX.XXX.XXX</pre></td></tr></table></figure></li>\n<li>\n<p>执行下面命令进行配置</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>iptables -P INPUT ACCEPT <span class=\"token comment\">#改成 ACCEPT 标示接收一切请求  </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>iptables -F <span class=\"token comment\">#清空默认所有规则  </span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>iptables -X <span class=\"token comment\">#清空自定义所有规则  </span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>iptables -Z <span class=\"token comment\">#计数器置 0  </span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>iptables -A INPUT -i lo -j ACCEPT <span class=\"token comment\">#允许 127.0.0.1 访问本地服务  </span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>iptables -A INPUT -m state --state ESTABLISHED -j ACCEPT <span class=\"token comment\">#允许访问外部服务  </span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>iptables -A INPUT -p icmp -m icmp --icmp-type <span class=\"token number\">8</span> -j ACCEPT <span class=\"token comment\">#允许 ping  </span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>iptables -A INPUT -p tcp --dport <span class=\"token number\">22</span> -j ACCEPT <span class=\"token comment\">#开启 ssh 端口  </span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>iptables -t nat -A POSTROUTING -s <span class=\"token number\">192.168</span>.0.0/24 -o eth0 -jMASQUERADE  </pre></td></tr><tr><td data-num=\"10\"></td><td><pre>iptables -A INPUT -p tcp --dport <span class=\"token number\">1723</span> -j ACCEPT</pre></td></tr></table></figure></li>\n<li>\n<p>保存</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">service</span> iptables save</pre></td></tr></table></figure><p>如果上述命令执行失败报出：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>The <span class=\"token function\">service</span> <span class=\"token builtin class-name\">command</span> supports only basic LSB actions <span class=\"token punctuation\">(</span>start, stop, restart, try-restart, reload, force-reload, status<span class=\"token punctuation\">)</span>. For other actions, please try to use systemctl.</pre></td></tr></table></figure><p>执行下面命令</p>\n<ol>\n<li>关闭防火墙</li>\n</ol>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>systemctl stop firewalld</pre></td></tr></table></figure><ol start=\"2\">\n<li>安装或更新服务</li>\n</ol>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>yum <span class=\"token function\">install</span> iptables-services</pre></td></tr></table></figure><ol start=\"3\">\n<li>启动 iptables</li>\n</ol>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>systemctl <span class=\"token builtin class-name\">enable</span> iptables</pre></td></tr></table></figure><ol start=\"4\">\n<li>打开 iptables</li>\n</ol>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>systemctl start iptables</pre></td></tr></table></figure><ol start=\"5\">\n<li>再次保存</li>\n</ol>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">service</span> iptables save</pre></td></tr></table></figure><p><img data-src=\"11.png\" alt=\"最大传输单元\" /></p>\n</li>\n</ol>\n<h2 id=\"配置pptp服务\"><a class=\"anchor\" href=\"#配置pptp服务\">#</a> 配置 PPTP 服务</h2>\n<ol>\n<li>执行如下命令，重启 PPTP 服务。</li>\n</ol>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>systemctl restart pptpd</pre></td></tr></table></figure><ol start=\"2\">\n<li>执行如下命令，重启 iptables。</li>\n</ol>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>systemctl start iptables</pre></td></tr></table></figure><h1 id=\"连接vpn服务器\"><a class=\"anchor\" href=\"#连接vpn服务器\">#</a> 连接 VPN 服务器</h1>\n<ol>\n<li>打开 windows 设置，点击网络和 Internet<br />\n<img data-src=\"12.png\" alt=\"windows设置\" /></li>\n<li>点击 vpn -&gt; 添加 vpn 连接<br />\n<img data-src=\"13.png\" alt=\"vpn连接\" /></li>\n<li>按图片选择，保存并连接就可以了<br />\n<img data-src=\"14.png\" alt=\"vpn连接\" /></li>\n</ol>\n",
            "tags": [
                "计算机科学",
                "软件应用",
                "阿里云",
                "vpn"
            ]
        },
        {
            "id": "http://yrmlnf.coding-pages.com/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB/Scrapy-%E9%83%A8%E7%BD%B2%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%ABAPI%E6%9C%8D%E5%8A%A1/",
            "url": "http://yrmlnf.coding-pages.com/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB/Scrapy-%E9%83%A8%E7%BD%B2%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%ABAPI%E6%9C%8D%E5%8A%A1/",
            "title": "Scrapy-部署网络爬虫API服务",
            "date_published": "2020-12-30T14:43:00.000Z",
            "content_html": "<h1 id=\"概述\"><a class=\"anchor\" href=\"#概述\">#</a> 概述</h1>\n<p>本文将使用到下面三个框架</p>\n<ul>\n<li>Scrapy（Web 爬虫框架）：Scrapy 是一套基于基于 Twisted 的异步处理框架，纯 python 实现的爬虫框架，用户只需要定制开发几个模块就可以轻松的实现一个爬虫</li>\n<li>Scrapyd（爬虫服务器）：Scrapyd 是用于部署和运行 Scrapy 的应用程序。它可以使用 JSON API 部署（上载）Scrapy 的项目并控制每个作业</li>\n<li>Scrapyd-Client （Scrapyd 客户端）：Scrapyd-Client 用于把 Scrapy 项目部署在 Scrapyd 服务器上</li>\n</ul>\n<h1 id=\"安装scrapyd\"><a class=\"anchor\" href=\"#安装scrapyd\">#</a> 安装 Scrapyd</h1>\n<ol>\n<li>安装 scrapyd</li>\n</ol>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>pip <span class=\"token function\">install</span> scrapyd</pre></td></tr></table></figure><ol start=\"2\">\n<li>打开命令行，运行服务器</li>\n</ol>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>scrapyd</pre></td></tr></table></figure><p>可以看见下面输出<br />\n<img data-src=\"1.png\" alt=\"运行服务器\" /><br />\n浏览器打开 <span class=\"exturl\" data-url=\"aHR0cDovLzEyNy4wLjAuMTo2ODAwLyVFRiVCQyU4QyVFNSU4RiVBRiVFNCVCQiVBNSVFNyU5QyU4QiVFOCVBNyU4MSVFNiU5QyU4RCVFNSU4QSVBMSVFNSU5OSVBOCVFNyU5QSU4NCVFNyU5NSU4QyVFOSU5RCVBMg==\">http://127.0.0.1:6800/，可以看见服务器的界面</span><br />\n<img data-src=\"2.png\" alt=\"服务器的界面\" /><br />\n其中 job 为任务管理，logs 为执行日志，Documentation 为 scrapyd 的文档<br />\n这时 scrapyd 并没有部署任何 scrapy 项目，接下来我们使用 Scrapyd-Client 部署 scrapy 项目，切记不要关闭该命令行窗口</p>\n<h1 id=\"部署scrapy项目\"><a class=\"anchor\" href=\"#部署scrapy项目\">#</a> 部署 Scrapy 项目</h1>\n<ol>\n<li>安装 Scrapyd-Client</li>\n</ol>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>pip <span class=\"token function\">install</span> scrapyd-client</pre></td></tr></table></figure><ol start=\"2\">\n<li>检查是否安装成功</li>\n</ol>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>scrapyd-deploy</pre></td></tr></table></figure><p>如果安装成功会出现下面提示<br />\n<img data-src=\"3.png\" alt=\"安装成功\" /><br />\n因为当前文件夹并不是 scrapy 项目，所以会提示找不到 scrapy 项目<br />\n需要注意的是，在 windows 环境下，运行该命令会提示不是内部或外部命令，这时候你需要找到你的 python 目录，<br />\n由于我使用的是 anaconda 的虚拟环境，所以我的目录是 J:\\Anaconda3\\envs\\scrapy<br />\n 在 J:\\Anaconda3\\Scripts 下创建 scrapyd-deploy.bat 文件，写入下面内容，路径替换成自己本机路径</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>@echo off</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token string\">\"J:\\Anaconda3<span class=\"token entity\" title=\"\\e\">\\e</span>nvs\\scrapy\\python.exe\"</span>  <span class=\"token string\">\"J:\\Anaconda3<span class=\"token entity\" title=\"\\e\">\\e</span>nvs\\scrapy\\Scripts\\scrapyd-deploy\"</span> %*</pre></td></tr></table></figure><p>关闭命令行，重新打开命令，再次输入</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>scrapyd-deploy</pre></td></tr></table></figure><ol start=\"3\">\n<li>修改 scrapy 项目配置文件<br />\n进入到你的 scrapy 项目下，修改 scrapy.cfg</li>\n</ol>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>settings<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>default <span class=\"token operator\">=</span> LighthouseCrawler<span class=\"token punctuation\">.</span>settings</pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">[</span>deploy<span class=\"token punctuation\">:</span>target<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>url <span class=\"token operator\">=</span> http<span class=\"token punctuation\">:</span><span class=\"token operator\">//</span>localhost<span class=\"token punctuation\">:</span><span class=\"token number\">6800</span><span class=\"token operator\">/</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>project <span class=\"token operator\">=</span> prject</pre></td></tr></table></figure><p>target 为你的服务器命令，prject 是你工程的名字</p>\n<ol start=\"4\">\n<li>命令进入 scrapy 项目，部署项目<br />\n注意： 必须要开启 scrapyd 服务 (步骤一)，否则将提示服务器拒绝</li>\n</ol>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token builtin class-name\">cd</span> /myscrapy</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>scrapyd-deploy target -p prject</pre></td></tr></table></figure><p><img data-src=\"4.png\" alt=\"服务器的界面\" /></p>\n<ol start=\"5\">\n<li>检查服务器是否可用<br />\n执行下面命令，并观察启动 scrapyd 的命令行窗口的输出</li>\n</ol>\n<pre><code>curl http://localhost:6800/daemonstatus.json\n</code></pre>\n<p>如果没有报错，则成功部署<br />\n在 windows 下可能出现下面错误</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>builtins.NotImplementedError: spawnProcess not available since pywin32 is not installed.</pre></td></tr></table></figure><p>则先安装 pywin32</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>pip <span class=\"token function\">install</span> pywin32</pre></td></tr></table></figure><p>然后把 python 目录 python3\\Lib\\site-packages\\pywin32_system32 下的两个 ddl 文件复制到 C:\\Windows\\System32，重新打开命令行运行 scrapyd，再次尝试</p>\n<h1 id=\"api\"><a class=\"anchor\" href=\"#api\">#</a> API</h1>\n<ol>\n<li>检查服务的负载状态</li>\n</ol>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">curl</span> http://localhost:6800/daemonstatus.json</pre></td></tr></table></figure><p>响应</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"status\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"ok\"</span>, <span class=\"token string\">\"running\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"0\"</span>, <span class=\"token string\">\"pending\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"0\"</span>, <span class=\"token string\">\"finished\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"0\"</span>, <span class=\"token string\">\"node_name\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"node-name\"</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><ol start=\"2\">\n<li>向项目添加版本，如果不存在则创建项目</li>\n</ol>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">curl</span> http://localhost:6800/addversion.json -F <span class=\"token assign-left variable\">project</span><span class=\"token operator\">=</span>myproject -F <span class=\"token assign-left variable\">version</span><span class=\"token operator\">=</span>r23 -F <span class=\"token assign-left variable\">egg</span><span class=\"token operator\">=</span>@myproject.egg</pre></td></tr></table></figure><p>响应</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">&#123;</span><span class=\"token string\">\"status\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"ok\"</span>, <span class=\"token string\">\"spiders\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token number\">3</span><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><ol start=\"3\">\n<li>安排一次爬虫运行（也称为作业）</li>\n</ol>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">curl</span> http://localhost:6800/schedule.json -d <span class=\"token assign-left variable\">project</span><span class=\"token operator\">=</span>myproject -d <span class=\"token assign-left variable\">spider</span><span class=\"token operator\">=</span>somespider</pre></td></tr></table></figure><p>响应</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">&#123;</span><span class=\"token string\">\"status\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"ok\"</span>, <span class=\"token string\">\"jobid\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"6487ec79947edab326d6db28a2d86511e8247444\"</span><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><ol start=\"4\">\n<li>取消一次爬虫</li>\n</ol>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">curl</span> http://localhost:6800/cancel.json -d <span class=\"token assign-left variable\">project</span><span class=\"token operator\">=</span>myproject -d <span class=\"token assign-left variable\">job</span><span class=\"token operator\">=</span>6487ec79947edab326d6db28a2d86511e8247444</pre></td></tr></table></figure><p>响应</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">&#123;</span><span class=\"token string\">\"status\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"ok\"</span>, <span class=\"token string\">\"prevstate\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"running\"</span><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><ol start=\"5\">\n<li>获取上传到此 Scrapy 服务器的项目列表</li>\n</ol>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">curl</span> http://localhost:6800/listprojects.json</pre></td></tr></table></figure><p>响应</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">&#123;</span><span class=\"token string\">\"status\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"ok\"</span>, <span class=\"token string\">\"projects\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"myproject\"</span>, <span class=\"token string\">\"otherproject\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><ol start=\"6\">\n<li>获取可用于某些项目的版本列表</li>\n</ol>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">curl</span> http://localhost:6800/listversions.json?project<span class=\"token operator\">=</span>myproject</pre></td></tr></table></figure><p>响应</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">&#123;</span><span class=\"token string\">\"status\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"ok\"</span>, <span class=\"token string\">\"versions\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"r99\"</span>, <span class=\"token string\">\"r156\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><ol start=\"7\">\n<li>获取某个项目的爬虫列表</li>\n</ol>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">curl</span> http://localhost:6800/listspiders.json?project<span class=\"token operator\">=</span>myproject</pre></td></tr></table></figure><p>响应</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">&#123;</span><span class=\"token string\">\"status\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"ok\"</span>, <span class=\"token string\">\"spiders\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"spider1\"</span>, <span class=\"token string\">\"spider2\"</span>, <span class=\"token string\">\"spider3\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><ol start=\"8\">\n<li>获取作业列表</li>\n</ol>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">curl</span> http://localhost:6800/listjobs.json?project<span class=\"token operator\">=</span>myproject</pre></td></tr></table></figure><p>响应</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token string\">\"pending\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">&#123;</span><span class=\"token string\">\"id\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"78391cc0fcaf11e1b0090800272a6d06\"</span>, <span class=\"token string\">\"spider\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"spider1\"</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">]</span>,</pre></td></tr><tr><td data-num=\"2\"></td><td><pre> <span class=\"token string\">\"running\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">&#123;</span><span class=\"token string\">\"id\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"422e608f9f28cef127b3d5ef93fe9399\"</span>, <span class=\"token string\">\"spider\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"spider2\"</span>, <span class=\"token string\">\"start_time\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"2012-09-12 10:14:03.594664\"</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">]</span>,</pre></td></tr><tr><td data-num=\"3\"></td><td><pre> <span class=\"token string\">\"finished\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">&#123;</span><span class=\"token string\">\"id\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"2f16646cfcaf11e1b0090800272a6d06\"</span>, <span class=\"token string\">\"spider\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"spider3\"</span>, <span class=\"token string\">\"start_time\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"2012-09-12 10:14:03.594664\"</span>, <span class=\"token string\">\"end_time\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"2012-09-12 10:24:03.594664\"</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><ol start=\"9\">\n<li>删除项目版本</li>\n</ol>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">curl</span> http://localhost:6800/delversion.json -d <span class=\"token assign-left variable\">project</span><span class=\"token operator\">=</span>myproject -d <span class=\"token assign-left variable\">version</span><span class=\"token operator\">=</span>r99</pre></td></tr></table></figure><p>响应</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">&#123;</span><span class=\"token string\">\"status\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"ok\"</span><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><ol start=\"10\">\n<li>删除项目</li>\n</ol>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">curl</span> http://localhost:6800/delproject.json -d <span class=\"token assign-left variable\">project</span><span class=\"token operator\">=</span>myproject</pre></td></tr></table></figure><p>响应</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">&#123;</span><span class=\"token string\">\"status\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"ok\"</span><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure>",
            "tags": [
                "计算机科学",
                "网络爬虫",
                "python",
                "scrapy"
            ]
        },
        {
            "id": "http://yrmlnf.coding-pages.com/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-B%E6%A0%91%E3%80%81B-%E6%A0%91%E3%80%81B-%E6%A0%91/",
            "url": "http://yrmlnf.coding-pages.com/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-B%E6%A0%91%E3%80%81B-%E6%A0%91%E3%80%81B-%E6%A0%91/",
            "title": "数据结构-B树、B-树、B-树",
            "date_published": "2020-11-05T12:22:40.000Z",
            "content_html": "<h1 id=\"多路查找树\"><a class=\"anchor\" href=\"#多路查找树\">#</a> 多路查找树</h1>\n<div class=\"note info\">\n<p>多路查找树 (muitl-way search tree)，其每一个节点的孩子数可以多于两个，且每一个节点处可以存储多个元素。主要有 4 中特殊形式。</p>\n</div>\n<p>和普通的查找树相比，多路查找树不仅一个节点有多个孩子而且一个节点不再是只能存储一个元素，这打破了我们对树的理解。正因为这个特性，使他能够出色的解决 IO 问题，而我们研究的 B,B+,B - 便是平衡的多路查找树</p>\n<h1 id=\"b树\"><a class=\"anchor\" href=\"#b树\">#</a> B 树</h1>\n<p>一个 m 阶的 B 树具有如下属性：</p>\n<div class=\"note info\">\n<ol>\n<li>如果根结点不是叶结点，则其至少有两棵子树。</li>\n<li>每一个非根的分支结点都有 k-1 个元素和 k 个孩子，其中 [m/2]≤ k ≤ m。每一个叶子结点 n 都有 k-1 个元素，其中 [m/2]≤ k ≤ m</li>\n<li>所有叶子结点都位于同一层次。</li>\n<li>所有分支结点包含下列信息数据 (n, A0, K1, A1, K2, A2, …, Kn, An)，其中: Ki ( i=1, 2, …, n ) 为关键字，且 Ki&lt;Ki+1 ( i=1, 2, …, n-1 ); Ai ( i=0, 2, …, n) 为指向子树根结点的指针，且指针 Ai-1 所指子树中所有结点的关键字均小于 Ki ( i=1, 2, …, n ) ，An 所指子树中所有结点的关键字均大于 Kn，n ( [m/2]-1 ≤ n ≤ m-1 ) 为关键字的个数 (或 n+1 为子树的个数)</li>\n</ol>\n</div>\n<p>用人话来说，一颗 m 阶 B 树有以下特点</p>\n<ul>\n<li>每个节点最多包含 m 个节点</li>\n<li>如果根节点包含子节点，则至少有 2 个子节点。除根节点外，每个节点至少包含 m/2 个子节点</li>\n<li>拥有 k 个子节点的非叶节点最多包含 k-1 个记录 (k&lt;m-1)</li>\n<li>所有的叶子节点在最后一层</li>\n</ul>\n<p><img data-src=\"1.jpg\" alt=\"B树\" /></p>\n<p>上面是一个 3 阶 B 树，包含了以上所有的特点</p>\n<h2 id=\"查询\"><a class=\"anchor\" href=\"#查询\">#</a> 查询</h2>\n<p><img data-src=\"2.jpg\" alt=\"查询\" /></p>\n<p>如上图我要从上图中找到 E 字母，查找流程如下</p>\n<ol>\n<li>获取根节点的关键字进行比较，当前根节点关键字为 M，E&lt;M（26 个字母顺序），所以往找到指向左边的子节点（二分法规则，左小右大，左边放小于当前节点值的子节点、右边放大于当前节点值的子节点）</li>\n<li>拿到关键字 D 和 G，D&lt;E&lt;G 所以直接找到 D 和 G 中间的节点</li>\n<li>拿到 E 和 F，因为 E=E 所以直接返回关键字和指针信息（如果树结构里面没有包含所要查找的节点则返回 null）；</li>\n</ol>\n<h2 id=\"插入\"><a class=\"anchor\" href=\"#插入\">#</a> 插入</h2>\n<p>遵循规则：</p>\n<ol>\n<li>\n<p>节点拆分规则：当前是要组成一个 5 路查找树，那么此时 m=5, 关键字数必须 &lt;=5-1（这里关键字数&gt; 4 就要进行节点拆分）, 拆分的时候把中间节点往上升级</p>\n</li>\n<li>\n<p>排序规则：满足节点本身比左边节点大，比右边节点小的排序规则；</p>\n</li>\n</ol>\n<p>定义一个 5 阶树（平衡 5 路查找树；），现在我们要把 3、8、31、11、23、29、50、28 这些数字构建出一个 5 阶树出来；</p>\n<p>先插入 3、8、31、11</p>\n<p><img data-src=\"3.jpg\" alt=\"插入\" /></p>\n<p>当插入 23 的时候，发现元素等于 5 了，这时候需要拆分节点，此时把中间节点 11 升级，然后再插入 29</p>\n<p><img data-src=\"4.jpg\" alt=\"插入\" /></p>\n<p>再插入 50，最后插入 28 的时候发现右孩子元素又等于 5 了，这时候把中间节点 29 升级到与 11 同一级</p>\n<p><img data-src=\"5.jpg\" alt=\"插入\" /></p>\n<h2 id=\"删除\"><a class=\"anchor\" href=\"#删除\">#</a> 删除</h2>\n<p>规则：</p>\n<ol>\n<li>节点合并规则：当前是要组成一个 5 路查找树，那么此时 m=5, 关键字数必须大于等于 ceil（5/2）（这里关键字数 &lt; 2 就要进行节点合并）；</li>\n<li>满足节点本身比左边节点大，比右边节点小的排序规则；</li>\n<li>关键字数小于二时先从子节点取，子节点没有符合条件时就向向父节点取，取中间值往父节点放；</li>\n</ol>\n<p><img data-src=\"6.jpg\" alt=\"删除\" /></p>\n<h2 id=\"特点\"><a class=\"anchor\" href=\"#特点\">#</a> 特点</h2>\n<p>B 树相对于平衡二叉树的不同是，每个节点包含的关键字增多了，特别是在 B 树应用到数据库中的时候，数据库充分利用了磁盘块的原理（磁盘数据存储是采用块的形式存储的，每个块的大小为 16K，每次 IO 进行数据读取时，同一个磁盘块的数据可以一次性读取出来）把节点大小限制和充分使用在磁盘快大小范围；把树的节点关键字增多后树的层级比原来的二叉树少了，减少数据查找的次数和复杂度；</p>\n<h1 id=\"b树-2\"><a class=\"anchor\" href=\"#b树-2\">#</a> B + 树</h1>\n<p><img data-src=\"7.jpg\" alt=\"B+树\" /></p>\n<p>B + 树通过仅在树的叶节点上存储数据指针，消除了用于索引的 B 树的缺点。因此，B + 树的叶节点的结构与 B 树的内部节点的结构完全不同。在这里应该指出，由于数据指针仅存在于叶节点上，因此叶节点必须必须将所有键值及其对应的数据指针存储到磁盘文件块，以便访问它们。此外，叶节点链接到提供对记录的有序访问。因此，叶节点形成索引的第一层，内部节点形成多级索引的其他层。叶子节点的某些关键值也出现在内部节点中，以简单地充当控制记录搜索的媒介</p>\n<h2 id=\"b树与b树的区别\"><a class=\"anchor\" href=\"#b树与b树的区别\">#</a> B 树与 B + 树的区别</h2>\n<table>\n<thead>\n<tr>\n<th>B 树</th>\n<th>B + 树</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>所有内部和叶节点都有数据指针</td>\n<td>只有叶节点具有数据指针</td>\n</tr>\n<tr>\n<td>树中没有 key 的重复项</td>\n<td>key 重复，并且所有节点都位于叶子上</td>\n</tr>\n<tr>\n<td>叶节点不存储为结构链表</td>\n<td>叶节点存储为结构链表</td>\n</tr>\n</tbody>\n</table>\n<p>B + 树对于 B 树的改进主要有：</p>\n<ul>\n<li>更少的 IO 次数<br />\n非叶子节点去掉了其中指向 data record 的指针，使得每个结点能存放更多的 key，这使得 B + 树的高度会比 B 树低，访问时所需要的 IO 次数就会少很多。此外，由于每个节点存储的记录数更多，所以对访问局部性原理的利用更好，缓存命中率更高</li>\n<li>更适于范围查询<br />\n底部叶子节点是链表的形式，因此可以实现更方便的顺序遍历</li>\n<li>更稳定的查询效率<br />\n因为 B 树的所有节点都存储数据所以 B 树查询时间复杂度不稳定，可能第一个就命中也可能最后一个才命中，而 B + 树的数据都在叶子节点，所以 B + 树的查询复杂度稳定为</li>\n</ul>\n<p>B + 树也有劣势，由于键会重复，因此会占用更多空间。但是与带来性能优势相比，空间劣势往往可以接受，因此 B + 树在数据库比 B 树使用范围更广</p>\n<h1 id=\"b-树\"><a class=\"anchor\" href=\"#b-树\">#</a> B - 树</h1>\n<p>暂时没用到，待补充</p>\n",
            "tags": [
                "计算机科学",
                "数据结构",
                "java"
            ]
        },
        {
            "id": "http://yrmlnf.coding-pages.com/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-TreeMap%E7%BA%A2%E9%BB%91%E6%A0%91/",
            "url": "http://yrmlnf.coding-pages.com/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-TreeMap%E7%BA%A2%E9%BB%91%E6%A0%91/",
            "title": "数据结构-TreeMap红黑树",
            "date_published": "2020-10-16T07:33:47.000Z",
            "content_html": "<h1 id=\"概述\"><a class=\"anchor\" href=\"#概述\">#</a> 概述</h1>\n<p>TreeMap 实现了 SotredMap 接口，它是有序的集合。而且是一个红黑树结构，每个 key-value 都作为一个红黑树的节点。如果在调用 TreeMap 的构造函数时没有指定比较器，则根据 key 执行自然排序</p>\n<h1 id=\"继承关系\"><a class=\"anchor\" href=\"#继承关系\">#</a> 继承关系</h1>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">TreeMap</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">K</span><span class=\"token punctuation\">,</span><span class=\"token class-name\">V</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">extends</span> <span class=\"token class-name\">AbstractMap</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">K</span><span class=\"token punctuation\">,</span><span class=\"token class-name\">V</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">implements</span> <span class=\"token class-name\">NavigableMap</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">K</span><span class=\"token punctuation\">,</span><span class=\"token class-name\">V</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Cloneable</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>io<span class=\"token punctuation\">.</span></span>Serializable</span> <span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h1 id=\"实现接口\"><a class=\"anchor\" href=\"#实现接口\">#</a> 实现接口</h1>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token class-name\">Serializable</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Cloneable</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Map</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">K</span><span class=\"token punctuation\">,</span><span class=\"token class-name\">V</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">NavigableMap</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">K</span><span class=\"token punctuation\">,</span><span class=\"token class-name\">V</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">SortedMap</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">K</span><span class=\"token punctuation\">,</span><span class=\"token class-name\">V</span><span class=\"token punctuation\">></span></span></pre></td></tr></table></figure><h1 id=\"treemap基本属性\"><a class=\"anchor\" href=\"#treemap基本属性\">#</a> TreeMap 基本属性</h1>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">Comparator</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token operator\">?</span> <span class=\"token keyword\">super</span> <span class=\"token class-name\">K</span><span class=\"token punctuation\">></span></span> comparator<span class=\"token punctuation\">;</span>  <span class=\"token comment\">// 比较器，是自然排序，还是定制排序 ，使用 final 修饰，表明一旦赋值便不允许改变</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">private</span> <span class=\"token keyword\">transient</span> <span class=\"token class-name\">Entry</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">K</span><span class=\"token punctuation\">,</span><span class=\"token class-name\">V</span><span class=\"token punctuation\">></span></span> root <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">// 红黑树的根节点</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">private</span> <span class=\"token keyword\">transient</span> <span class=\"token keyword\">int</span> size <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>     <span class=\"token comment\">//TreeMap 中存放的键值对的数量</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">private</span> <span class=\"token keyword\">transient</span> <span class=\"token keyword\">int</span> modCount <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>   <span class=\"token comment\">// 修改的次数</span></pre></td></tr></table></figure><h1 id=\"红黑树数据结构\"><a class=\"anchor\" href=\"#红黑树数据结构\">#</a> 红黑树数据结构</h1>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Entry</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">K</span><span class=\"token punctuation\">,</span><span class=\"token class-name\">V</span><span class=\"token punctuation\">></span></span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">Map<span class=\"token punctuation\">.</span>Entry</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">K</span><span class=\"token punctuation\">,</span><span class=\"token class-name\">V</span><span class=\"token punctuation\">></span></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token class-name\">K</span> key<span class=\"token punctuation\">;</span>    <span class=\"token comment\">// 键</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token class-name\">V</span> value<span class=\"token punctuation\">;</span>    <span class=\"token comment\">// 值</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token class-name\">Entry</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">K</span><span class=\"token punctuation\">,</span><span class=\"token class-name\">V</span><span class=\"token punctuation\">></span></span> left <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>     <span class=\"token comment\">// 左孩子节点</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token class-name\">Entry</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">K</span><span class=\"token punctuation\">,</span><span class=\"token class-name\">V</span><span class=\"token punctuation\">></span></span> right <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>    <span class=\"token comment\">// 右孩子节点</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token class-name\">Entry</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">K</span><span class=\"token punctuation\">,</span><span class=\"token class-name\">V</span><span class=\"token punctuation\">></span></span> parent<span class=\"token punctuation\">;</span>          <span class=\"token comment\">// 父节点</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">boolean</span> color <span class=\"token operator\">=</span> BLACK<span class=\"token punctuation\">;</span>      <span class=\"token comment\">// 节点的颜色，在红黑树种，只有两种颜色，红色和黑色</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token comment\">// 构造方法，用指定的 key,value ,parent 初始化，color 默认为黑色</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token class-name\">Entry</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">K</span> key<span class=\"token punctuation\">,</span> <span class=\"token class-name\">V</span> value<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Entry</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">K</span><span class=\"token punctuation\">,</span><span class=\"token class-name\">V</span><span class=\"token punctuation\">></span></span> parent<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>key <span class=\"token operator\">=</span> key<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>value <span class=\"token operator\">=</span> value<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>parent <span class=\"token operator\">=</span> parent<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token comment\">// 返回 key</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token class-name\">K</span> <span class=\"token function\">getKey</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        <span class=\"token keyword\">return</span> key<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token comment\">// 返回该节点对应的 value</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token class-name\">V</span> <span class=\"token function\">getValue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        <span class=\"token keyword\">return</span> value<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    <span class=\"token comment\">// 替换节点的值，并返回旧值</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token class-name\">V</span> <span class=\"token function\">setValue</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">V</span> value<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>        <span class=\"token class-name\">V</span> oldValue <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>value <span class=\"token operator\">=</span> value<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>        <span class=\"token keyword\">return</span> oldValue<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    <span class=\"token comment\">// 重写 equals () 方法</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">boolean</span> <span class=\"token function\">equals</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Object</span> o<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token punctuation\">(</span>o <span class=\"token keyword\">instanceof</span> <span class=\"token class-name\">Map<span class=\"token punctuation\">.</span>Entry</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>            <span class=\"token keyword\">return</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>        <span class=\"token class-name\">Map<span class=\"token punctuation\">.</span>Entry</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token operator\">?</span><span class=\"token punctuation\">,</span><span class=\"token operator\">?</span><span class=\"token punctuation\">></span></span> e <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Map<span class=\"token punctuation\">.</span>Entry</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token operator\">?</span><span class=\"token punctuation\">,</span><span class=\"token operator\">?</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">)</span>o<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>        <span class=\"token comment\">// 两个节点的 key 相等，value 相等，这两个节点才相等</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token function\">valEquals</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">,</span>e<span class=\"token punctuation\">.</span><span class=\"token function\">getKey</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">valEquals</span><span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">,</span>e<span class=\"token punctuation\">.</span><span class=\"token function\">getValue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    <span class=\"token comment\">// 重写 hashCode () 方法</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">int</span> <span class=\"token function\">hashCode</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>        <span class=\"token keyword\">int</span> keyHash <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>key<span class=\"token operator\">==</span><span class=\"token keyword\">null</span> <span class=\"token operator\">?</span> <span class=\"token number\">0</span> <span class=\"token operator\">:</span> key<span class=\"token punctuation\">.</span><span class=\"token function\">hashCode</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>        <span class=\"token keyword\">int</span> valueHash <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>value<span class=\"token operator\">==</span><span class=\"token keyword\">null</span> <span class=\"token operator\">?</span> <span class=\"token number\">0</span> <span class=\"token operator\">:</span> value<span class=\"token punctuation\">.</span><span class=\"token function\">hashCode</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>        <span class=\"token comment\">//key 和 vale hash 值得异或运算，相同则为零，不同则为 1 </span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>        <span class=\"token keyword\">return</span> keyHash <span class=\"token operator\">^</span> valueHash<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>    <span class=\"token comment\">// 重写 toString () 方法</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token class-name\">String</span> <span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>        <span class=\"token keyword\">return</span> key <span class=\"token operator\">+</span> <span class=\"token string\">\"=\"</span> <span class=\"token operator\">+</span> value<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h1 id=\"构造方法\"><a class=\"anchor\" href=\"#构造方法\">#</a> 构造方法</h1>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// 构造方法，comparator 用键的顺序做比较</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token class-name\">TreeMap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    comparator <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\">// 构造方法，提供比较器，用指定比较器排序</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token class-name\">TreeMap</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Comparator</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token operator\">?</span> <span class=\"token keyword\">super</span> <span class=\"token class-name\">K</span><span class=\"token punctuation\">></span></span> comparator<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    his<span class=\"token punctuation\">.</span>comparator <span class=\"token operator\">=</span> comparator<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token comment\">// 将 m 中的元素转化 daoTreeMap 中，按照键的顺序做比较排序</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token class-name\">TreeMap</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Map</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token operator\">?</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">K</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">?</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">V</span><span class=\"token punctuation\">></span></span> m<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    comparator <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token function\">putAll</span><span class=\"token punctuation\">(</span>m<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token comment\">// 构造方法，指定的参数为 SortedMap</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token comment\">// 采用 m 的比较器排序</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token class-name\">TreeMap</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">SortedMap</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">K</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">?</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">V</span><span class=\"token punctuation\">></span></span> m<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    comparator <span class=\"token operator\">=</span> m<span class=\"token punctuation\">.</span><span class=\"token function\">comparator</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        <span class=\"token function\">buildFromSorted</span><span class=\"token punctuation\">(</span>m<span class=\"token punctuation\">.</span><span class=\"token function\">size</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> m<span class=\"token punctuation\">.</span><span class=\"token function\">entrySet</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">iterator</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>io<span class=\"token punctuation\">.</span></span>IOException</span> cannotHappen<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">ClassNotFoundException</span> cannotHappen<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>TreeMap 提供了四个构造方法，实现了方法的重载。无参构造方法中比较器的值为 null, 采用自然排序的方法，如果指定了比较器则称之为定制排序.</p>\n<ul>\n<li>自然排序：TreeMap 的所有 key 必须实现 Comparable 接口，所有的 key 都是同一个类的对象</li>\n<li>定制排序：创建 TreeMap 对象传入了一个 Comparator 对象，该对象负责对 TreeMap 中所有的 key 进行排序，采用定制排序不要求 Map 的 key 实现 Comparable 接口。等下面分析到比较方法的时候在分析这两种比较有何不同。</li>\n</ul>\n<h1 id=\"新增\"><a class=\"anchor\" href=\"#新增\">#</a> 新增</h1>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token class-name\">V</span> <span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">K</span> key<span class=\"token punctuation\">,</span> <span class=\"token class-name\">V</span> value<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token class-name\">Entry</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">K</span><span class=\"token punctuation\">,</span><span class=\"token class-name\">V</span><span class=\"token punctuation\">></span></span> t <span class=\"token operator\">=</span> root<span class=\"token punctuation\">;</span>     <span class=\"token comment\">// 红黑树的根节点</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>t <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>        <span class=\"token comment\">// 红黑树是否为空</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token function\">compare</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// type (and possibly null) check</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token comment\">// 构造根节点，因为根节点没有父节点，传入 null 值。 </span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        root <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Entry</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">,</span> value<span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        size <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>     <span class=\"token comment\">//size 值加 1</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        modCount<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span>    <span class=\"token comment\">// 改变修改的次数</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>    <span class=\"token comment\">// 返回 null </span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token keyword\">int</span> cmp<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token class-name\">Entry</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">K</span><span class=\"token punctuation\">,</span><span class=\"token class-name\">V</span><span class=\"token punctuation\">></span></span> parent<span class=\"token punctuation\">;</span>    <span class=\"token comment\">// 定义节点</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token comment\">// split comparator and comparable paths</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token class-name\">Comparator</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token operator\">?</span> <span class=\"token keyword\">super</span> <span class=\"token class-name\">K</span><span class=\"token punctuation\">></span></span> cpr <span class=\"token operator\">=</span> comparator<span class=\"token punctuation\">;</span>     <span class=\"token comment\">// 获取比较器</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>cpr <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>      <span class=\"token comment\">// 如果定义了比较器，采用自定义比较器进行比较</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        <span class=\"token keyword\">do</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>            parent <span class=\"token operator\">=</span> t<span class=\"token punctuation\">;</span>      <span class=\"token comment\">// 将红黑树根节点赋值给 parent</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>            cmp <span class=\"token operator\">=</span> cpr<span class=\"token punctuation\">.</span><span class=\"token function\">compare</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">,</span> t<span class=\"token punctuation\">.</span>key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>     <span class=\"token comment\">// 比较 key, 与根节点的大小</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>cmp <span class=\"token operator\">&lt;</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span>      <span class=\"token comment\">// 如果 key &lt; t.key , 指向左子树</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>                t <span class=\"token operator\">=</span> t<span class=\"token punctuation\">.</span>left<span class=\"token punctuation\">;</span>   <span class=\"token comment\">//t = t.left  , t == 它的做孩子节点</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>            <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>cmp <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>                t <span class=\"token operator\">=</span> t<span class=\"token punctuation\">.</span>right<span class=\"token punctuation\">;</span>  <span class=\"token comment\">// 如果 key > t.key , 指向它的右孩子节点</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>            <span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>                <span class=\"token keyword\">return</span> t<span class=\"token punctuation\">.</span><span class=\"token function\">setValue</span><span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>      <span class=\"token comment\">// 如果它们相等，替换 key 的值</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>t <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>        <span class=\"token comment\">// 循环遍历</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>        <span class=\"token comment\">// 自然排序方式，没有指定比较器</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>key <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>            <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">NullPointerException</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">// 抛出异常</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>        <span class=\"token class-name\">Comparable</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token operator\">?</span> <span class=\"token keyword\">super</span> <span class=\"token class-name\">K</span><span class=\"token punctuation\">></span></span> k <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Comparable</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token operator\">?</span> <span class=\"token keyword\">super</span> <span class=\"token class-name\">K</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">)</span> key<span class=\"token punctuation\">;</span>    <span class=\"token comment\">// 类型转换</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>        <span class=\"token keyword\">do</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>            parent <span class=\"token operator\">=</span> t<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>            cmp <span class=\"token operator\">=</span> k<span class=\"token punctuation\">.</span><span class=\"token function\">compareTo</span><span class=\"token punctuation\">(</span>t<span class=\"token punctuation\">.</span>key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>cmp <span class=\"token operator\">&lt;</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span>     <span class=\"token comment\">// key &lt; t.key </span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>                t <span class=\"token operator\">=</span> t<span class=\"token punctuation\">.</span>left<span class=\"token punctuation\">;</span>   <span class=\"token comment\">// 左孩子</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>            <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>cmp <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span>   <span class=\"token comment\">// key > t.key </span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>                t <span class=\"token operator\">=</span> t<span class=\"token punctuation\">.</span>right<span class=\"token punctuation\">;</span>    <span class=\"token comment\">// 右孩子</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>            <span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>                <span class=\"token keyword\">return</span> t<span class=\"token punctuation\">.</span><span class=\"token function\">setValue</span><span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>   <span class=\"token comment\">//t == t.key , 替换 value 值</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>t <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>    <span class=\"token class-name\">Entry</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">K</span><span class=\"token punctuation\">,</span><span class=\"token class-name\">V</span><span class=\"token punctuation\">></span></span> e <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Entry</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">,</span> value<span class=\"token punctuation\">,</span> parent<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>   <span class=\"token comment\">// 创建新节点，并制定父节点</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>    <span class=\"token comment\">// 根据比较结果，决定新节点为父节点的左孩子或者右孩子</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>cmp <span class=\"token operator\">&lt;</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>        parent<span class=\"token punctuation\">.</span>left <span class=\"token operator\">=</span> e<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>    <span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>        parent<span class=\"token punctuation\">.</span>right <span class=\"token operator\">=</span> e<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>    <span class=\"token function\">fixAfterInsertion</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>   <span class=\"token comment\">// 新插入节点后重新调整红黑树 </span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>    size<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>    modCount<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre><span class=\"token comment\">// 比较方法，如果 comparator==null , 采用 comparable.compartTo 进行比较，否则采用指定比较器比较大小</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre><span class=\"token keyword\">final</span> <span class=\"token keyword\">int</span> <span class=\"token function\">compare</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Object</span> k1<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Object</span> k2<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>    <span class=\"token keyword\">return</span> comparator<span class=\"token operator\">==</span><span class=\"token keyword\">null</span> <span class=\"token operator\">?</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Comparable</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token operator\">?</span> <span class=\"token keyword\">super</span> <span class=\"token class-name\">K</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">)</span>k1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">compareTo</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">K</span><span class=\"token punctuation\">)</span>k2<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>        <span class=\"token operator\">:</span> comparator<span class=\"token punctuation\">.</span><span class=\"token function\">compare</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">K</span><span class=\"token punctuation\">)</span>k1<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">K</span><span class=\"token punctuation\">)</span>k2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre></pre></td></tr><tr><td data-num=\"60\"></td><td><pre><span class=\"token keyword\">private</span> <span class=\"token keyword\">void</span> <span class=\"token function\">fixAfterInsertion</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Entry</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">K</span><span class=\"token punctuation\">,</span><span class=\"token class-name\">V</span><span class=\"token punctuation\">></span></span> x<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>    <span class=\"token comment\">// 插入的节点默认的颜色为红色</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>    x<span class=\"token punctuation\">.</span>color <span class=\"token operator\">=</span> RED<span class=\"token punctuation\">;</span>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>    <span class=\"token comment\">// 情形 1： 新节点 x 是树的根节点，没有父节点不需要任何操作</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>    <span class=\"token comment\">// 情形 2： 新节点 x 的父节点颜色是黑色的，也不需要任何操作</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>    <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>x <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">&amp;&amp;</span> x <span class=\"token operator\">!=</span> root <span class=\"token operator\">&amp;&amp;</span> x<span class=\"token punctuation\">.</span>parent<span class=\"token punctuation\">.</span>color <span class=\"token operator\">==</span> RED<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>    <span class=\"token comment\">// 情形 3：新节点 x 的父节点颜色是红色的</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>    <span class=\"token comment\">// 判断 x 的节点的父节点位置，是否属于左孩子</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">parentOf</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token function\">leftOf</span><span class=\"token punctuation\">(</span><span class=\"token function\">parentOf</span><span class=\"token punctuation\">(</span><span class=\"token function\">parentOf</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>          <span class=\"token comment\">// 获取 x 节点的父节点的兄弟节点，上面语句已经判断出 x 节点的父节点为左孩子，所以直接取右孩子</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>         <span class=\"token class-name\">Entry</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">K</span><span class=\"token punctuation\">,</span><span class=\"token class-name\">V</span><span class=\"token punctuation\">></span></span> y <span class=\"token operator\">=</span> <span class=\"token function\">rightOf</span><span class=\"token punctuation\">(</span><span class=\"token function\">parentOf</span><span class=\"token punctuation\">(</span><span class=\"token function\">parentOf</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>         <span class=\"token comment\">// 判断是否 x 节点的父节点的兄弟节点为红色。</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>         <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">colorOf</span><span class=\"token punctuation\">(</span>y<span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> RED<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>              <span class=\"token function\">setColor</span><span class=\"token punctuation\">(</span><span class=\"token function\">parentOf</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> BLACK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//x 节点的父节点设置为黑色</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>              <span class=\"token function\">setColor</span><span class=\"token punctuation\">(</span>y<span class=\"token punctuation\">,</span> BLACK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>           <span class=\"token comment\">//y 节点的颜色设置为黑色</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>              <span class=\"token function\">setColor</span><span class=\"token punctuation\">(</span><span class=\"token function\">parentOf</span><span class=\"token punctuation\">(</span><span class=\"token function\">parentOf</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> RED<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//x.parent.parent 设置为红色</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>              x <span class=\"token operator\">=</span> <span class=\"token function\">parentOf</span><span class=\"token punctuation\">(</span><span class=\"token function\">parentOf</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//x == x.parent.parent , 进行遍历。</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>         <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>               <span class=\"token comment\">//x 的父节点的兄弟节点是黑色或者缺少的</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>               <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>x <span class=\"token operator\">==</span> <span class=\"token function\">rightOf</span><span class=\"token punctuation\">(</span><span class=\"token function\">parentOf</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>   <span class=\"token comment\">// 判断 x 节点是否为父节点的右孩子</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>                    x <span class=\"token operator\">=</span> <span class=\"token function\">parentOf</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>     <span class=\"token comment\">//x == 父节点</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>                    <span class=\"token function\">rotateLeft</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>    <span class=\"token comment\">// 左旋转操作</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>               <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>               <span class=\"token comment\">//x 节点是其父的左孩子</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>               <span class=\"token function\">setColor</span><span class=\"token punctuation\">(</span><span class=\"token function\">parentOf</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> BLACK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>               <span class=\"token function\">setColor</span><span class=\"token punctuation\">(</span><span class=\"token function\">parentOf</span><span class=\"token punctuation\">(</span><span class=\"token function\">parentOf</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> RED<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">// 上面两句将 x.parent 和 x.parent.parent 的颜色做调换</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>               <span class=\"token function\">rotateRight</span><span class=\"token punctuation\">(</span><span class=\"token function\">parentOf</span><span class=\"token punctuation\">(</span><span class=\"token function\">parentOf</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>   <span class=\"token comment\">// 进行右旋转</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>            <span class=\"token class-name\">Entry</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">K</span><span class=\"token punctuation\">,</span><span class=\"token class-name\">V</span><span class=\"token punctuation\">></span></span> y <span class=\"token operator\">=</span> <span class=\"token function\">leftOf</span><span class=\"token punctuation\">(</span><span class=\"token function\">parentOf</span><span class=\"token punctuation\">(</span><span class=\"token function\">parentOf</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">//y 是 x 节点的祖父节点的左孩子</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">colorOf</span><span class=\"token punctuation\">(</span>y<span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> RED<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>    <span class=\"token comment\">// 判断颜色</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>                <span class=\"token function\">setColor</span><span class=\"token punctuation\">(</span><span class=\"token function\">parentOf</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> BLACK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>    <span class=\"token comment\">// 父节点设置为黑色</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>                <span class=\"token function\">setColor</span><span class=\"token punctuation\">(</span>y<span class=\"token punctuation\">,</span> BLACK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>         <span class=\"token comment\">// 父节点的兄弟节点设置为黑色</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre>                <span class=\"token function\">setColor</span><span class=\"token punctuation\">(</span><span class=\"token function\">parentOf</span><span class=\"token punctuation\">(</span><span class=\"token function\">parentOf</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> RED<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>   <span class=\"token comment\">// 祖父节点设置为红色</span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre>                x <span class=\"token operator\">=</span> <span class=\"token function\">parentOf</span><span class=\"token punctuation\">(</span><span class=\"token function\">parentOf</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>   <span class=\"token comment\">// 将祖父节点作为新插入的节点，遍历调整</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre>                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>x <span class=\"token operator\">==</span> <span class=\"token function\">leftOf</span><span class=\"token punctuation\">(</span><span class=\"token function\">parentOf</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>     <span class=\"token comment\">//x 是其父亲的左孩子</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre>                    x <span class=\"token operator\">=</span> <span class=\"token function\">parentOf</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre>                    <span class=\"token function\">rotateRight</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>    <span class=\"token comment\">// 以父节点为旋转点，进行右旋操作</span></pre></td></tr><tr><td data-num=\"100\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"101\"></td><td><pre>                <span class=\"token function\">setColor</span><span class=\"token punctuation\">(</span><span class=\"token function\">parentOf</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> BLACK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>    <span class=\"token comment\">// 父节点为设置为黑色</span></pre></td></tr><tr><td data-num=\"102\"></td><td><pre>                <span class=\"token function\">setColor</span><span class=\"token punctuation\">(</span><span class=\"token function\">parentOf</span><span class=\"token punctuation\">(</span><span class=\"token function\">parentOf</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> RED<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">// 祖父节点设置为红色</span></pre></td></tr><tr><td data-num=\"103\"></td><td><pre>                <span class=\"token function\">rotateLeft</span><span class=\"token punctuation\">(</span><span class=\"token function\">parentOf</span><span class=\"token punctuation\">(</span><span class=\"token function\">parentOf</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">// 以父节点为旋转点，进行左旋操作</span></pre></td></tr><tr><td data-num=\"104\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"105\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"106\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"107\"></td><td><pre>    root<span class=\"token punctuation\">.</span>color <span class=\"token operator\">=</span> BLACK<span class=\"token punctuation\">;</span> <span class=\"token comment\">// 通过节点位置的调整，最终将红色的节点条调换到了根节点的位置，根节点重新设置为黑色</span></pre></td></tr><tr><td data-num=\"108\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>红黑树是一个更高效的检索二叉树，有如下特点：</p>\n<ol>\n<li>每个节点只能是红色或者黑色</li>\n<li>根节点永远是黑色的</li>\n<li>所有的叶子的子节点都是空节点，并且都是黑色的</li>\n<li>每个红色节点的两个子节点都是黑色的（不会有两个连续的红色节点）</li>\n<li>从任一个节点到其子树中每个叶子节点的路径都包含相同数量的黑色节点（叶子节点到根节点的黑色节点数量每条路径都相同）</li>\n</ol>\n<p>当一个默认为红色的节点插入树中，其实对应的是 7 中可能发生的情况，分别进行叙述：</p>\n<ul>\n<li>情形 1：新插入的节点时红黑树的根节点，没有父节点，无需任何的操作，直接将颜色设置为黑色就可以了</li>\n<li>情形 2：新节点的父节点颜色是黑色的，新插入的节点是红色的。也无需任何的操作。因为新节点的插入并没有影响到红黑书的特点</li>\n<li>情形 3：新节点的父节点（左孩子节点）颜色是红色的，而父节点的兄弟节点颜色也是红色的<br />\n<img data-src=\"1.png\" alt=\"\" /></li>\n<li>情形 4：父节点（左孩子节点）的颜色为红色，父节点的兄弟节点的颜色为黑色或者为 null，新插入的节点为父节点的右孩子节点。如下图<br />\n<img data-src=\"2.png\" alt=\"\" /></li>\n<li>情形 5：父节点（左孩子节点）的颜色为红色，父节点的兄弟节点颜色为黑色或者 null, 新插入节点为父亲的左孩子节点。如下图：<br />\n<img data-src=\"3.png\" alt=\"\" /></li>\n<li>情形 6 和情形 7 的操作与情形 4 和情形 5 的操作相同，它们之前的区别是父节点为有孩子节点，再次不再赘述。</li>\n</ul>\n<h1 id=\"删除\"><a class=\"anchor\" href=\"#删除\">#</a> 删除</h1>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token class-name\">V</span> <span class=\"token function\">remove</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Object</span> key<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token class-name\">Entry</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">K</span><span class=\"token punctuation\">,</span><span class=\"token class-name\">V</span><span class=\"token punctuation\">></span></span> p <span class=\"token operator\">=</span> <span class=\"token function\">getEntry</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">// 根据 key 查找节点，并返回该节点</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>p <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token class-name\">V</span> oldValue <span class=\"token operator\">=</span> p<span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">;</span>    <span class=\"token comment\">// 获取 key 对应的值</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token function\">deleteEntry</span><span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>     <span class=\"token comment\">// 删除节点</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token keyword\">return</span> oldValue<span class=\"token punctuation\">;</span>   <span class=\"token comment\">// 返回 key 对应的值</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token keyword\">final</span> <span class=\"token class-name\">Entry</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">K</span><span class=\"token punctuation\">,</span><span class=\"token class-name\">V</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">getEntry</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Object</span> key<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token comment\">// 根据键寻找节点，有非为两种方式，如果定制了比较器，采用定制排序方式，否则使用自然排序</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>comparator <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> </pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token function\">getEntryUsingComparator</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 循环遍历树，寻找和 key 相等的节点</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>key <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">NullPointerException</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token class-name\">Comparable</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token operator\">?</span> <span class=\"token keyword\">super</span> <span class=\"token class-name\">K</span><span class=\"token punctuation\">></span></span> k <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Comparable</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token operator\">?</span> <span class=\"token keyword\">super</span> <span class=\"token class-name\">K</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">)</span> key<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token class-name\">Entry</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">K</span><span class=\"token punctuation\">,</span><span class=\"token class-name\">V</span><span class=\"token punctuation\">></span></span> p <span class=\"token operator\">=</span> root<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>p <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>  <span class=\"token comment\">// 循环遍历树，寻找和 key 相等的节点</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        <span class=\"token keyword\">int</span> cmp <span class=\"token operator\">=</span> k<span class=\"token punctuation\">.</span><span class=\"token function\">compareTo</span><span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">.</span>key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>cmp <span class=\"token operator\">&lt;</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>            p <span class=\"token operator\">=</span> p<span class=\"token punctuation\">.</span>left<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>cmp <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>            p <span class=\"token operator\">=</span> p<span class=\"token punctuation\">.</span>right<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        <span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>            <span class=\"token keyword\">return</span> p<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token comment\">// 删除节点</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token keyword\">private</span> <span class=\"token keyword\">void</span> <span class=\"token function\">deleteEntry</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Entry</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">K</span><span class=\"token punctuation\">,</span><span class=\"token class-name\">V</span><span class=\"token punctuation\">></span></span> p<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    modCount<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">// 记录修改的次数</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    size<span class=\"token operator\">--</span><span class=\"token punctuation\">;</span>   <span class=\"token comment\">// 数量减 1</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>    <span class=\"token comment\">// 当前节点的两个孩子都不为空</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">.</span>left <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">&amp;&amp;</span> p<span class=\"token punctuation\">.</span>right <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>        <span class=\"token comment\">// 寻找继承者，继承者为当前节点的右孩子节点或者右孩子节点的最小左孩子</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>        <span class=\"token class-name\">Entry</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">K</span><span class=\"token punctuation\">,</span><span class=\"token class-name\">V</span><span class=\"token punctuation\">></span></span> s <span class=\"token operator\">=</span> <span class=\"token function\">successor</span><span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>        p<span class=\"token punctuation\">.</span>key <span class=\"token operator\">=</span> s<span class=\"token punctuation\">.</span>key<span class=\"token punctuation\">;</span>     <span class=\"token comment\">//key - value  的替换 ，并没有替换颜色</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>        p<span class=\"token punctuation\">.</span>value <span class=\"token operator\">=</span> s<span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>        p <span class=\"token operator\">=</span> s<span class=\"token punctuation\">;</span>  <span class=\"token comment\">// 指向继承者</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> <span class=\"token comment\">// p has 2 children</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>    <span class=\"token comment\">// Start fixup at replacement node, if it exists.</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>    <span class=\"token comment\">// 开始修复树结构，继承者的左孩子不为空，返回左孩子，否则返回右孩子</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>    <span class=\"token comment\">// 不可能存在左右两个孩子都存在的情况，successor 寻找的就是最小节点，它的左孩子节点为 null</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>    <span class=\"token class-name\">Entry</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">K</span><span class=\"token punctuation\">,</span><span class=\"token class-name\">V</span><span class=\"token punctuation\">></span></span> replacement <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">.</span>left <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">?</span> p<span class=\"token punctuation\">.</span>left <span class=\"token operator\">:</span> p<span class=\"token punctuation\">.</span>right<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>replacement <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>        <span class=\"token comment\">// Link replacement to parent</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>        <span class=\"token comment\">// 已经被选为继承者，当前拥有的一切放弃，所以将孩子交给爷爷抚养</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>        replacement<span class=\"token punctuation\">.</span>parent <span class=\"token operator\">=</span> p<span class=\"token punctuation\">.</span>parent<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>        <span class=\"token comment\">//p 节点没有父节点，则指向根节点</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">.</span>parent <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>           root <span class=\"token operator\">=</span> replacement<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>        <span class=\"token comment\">// 如果 p 为左孩子，如果 p 为左孩子，则将 p.parent.left = p.left</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>        <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>p <span class=\"token operator\">==</span> p<span class=\"token punctuation\">.</span>parent<span class=\"token punctuation\">.</span>left<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>            p<span class=\"token punctuation\">.</span>parent<span class=\"token punctuation\">.</span>left  <span class=\"token operator\">=</span> replacement<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>        <span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>            p<span class=\"token punctuation\">.</span>parent<span class=\"token punctuation\">.</span>right <span class=\"token operator\">=</span> replacement<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>        <span class=\"token comment\">// 删除 p 节点到左右分支，和父节点的引用</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>        p<span class=\"token punctuation\">.</span>left <span class=\"token operator\">=</span> p<span class=\"token punctuation\">.</span>right <span class=\"token operator\">=</span> p<span class=\"token punctuation\">.</span>parent <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>        <span class=\"token comment\">// Fix replacement</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">.</span>color <span class=\"token operator\">==</span> BLACK<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>            <span class=\"token comment\">// 恢复颜色分配</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>            <span class=\"token function\">fixAfterDeletion</span><span class=\"token punctuation\">(</span>replacement<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">.</span>parent <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token comment\">// return if we are the only node.</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>        <span class=\"token comment\">// 红黑书中父节点为空的只能是根节点。</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>        root <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token comment\">//  No children. Use self as phantom replacement and unlink.</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">.</span>color <span class=\"token operator\">==</span> BLACK<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>            <span class=\"token function\">fixAfterDeletion</span><span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">.</span>parent <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>p <span class=\"token operator\">==</span> p<span class=\"token punctuation\">.</span>parent<span class=\"token punctuation\">.</span>left<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>                p<span class=\"token punctuation\">.</span>parent<span class=\"token punctuation\">.</span>left <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>            <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>p <span class=\"token operator\">==</span> p<span class=\"token punctuation\">.</span>parent<span class=\"token punctuation\">.</span>right<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>                p<span class=\"token punctuation\">.</span>parent<span class=\"token punctuation\">.</span>right <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>            p<span class=\"token punctuation\">.</span>parent <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre><span class=\"token keyword\">private</span> <span class=\"token keyword\">void</span> <span class=\"token function\">fixAfterDeletion</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Entry</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">K</span><span class=\"token punctuation\">,</span><span class=\"token class-name\">V</span><span class=\"token punctuation\">></span></span> x<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>    <span class=\"token comment\">// 不是根节点，颜色为黑色，调整结构</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>    <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>x <span class=\"token operator\">!=</span> root <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">colorOf</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> BLACK<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>        <span class=\"token comment\">// 判断 x 是否为左孩子</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>x <span class=\"token operator\">==</span> <span class=\"token function\">leftOf</span><span class=\"token punctuation\">(</span><span class=\"token function\">parentOf</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>            <span class=\"token comment\">//x 的兄弟节点</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>            <span class=\"token class-name\">Entry</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">K</span><span class=\"token punctuation\">,</span><span class=\"token class-name\">V</span><span class=\"token punctuation\">></span></span> sib <span class=\"token operator\">=</span> <span class=\"token function\">rightOf</span><span class=\"token punctuation\">(</span><span class=\"token function\">parentOf</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>            <span class=\"token comment\">// 若兄弟节点是红色</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">colorOf</span><span class=\"token punctuation\">(</span>sib<span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> RED<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre>                <span class=\"token function\">setColor</span><span class=\"token punctuation\">(</span>sib<span class=\"token punctuation\">,</span> BLACK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>   <span class=\"token comment\">// 设置兄弟节点变为黑色</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>                <span class=\"token function\">setColor</span><span class=\"token punctuation\">(</span><span class=\"token function\">parentOf</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> RED<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">// 父节点设置为红色</span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre>                <span class=\"token function\">rotateLeft</span><span class=\"token punctuation\">(</span><span class=\"token function\">parentOf</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>   <span class=\"token comment\">// 左旋父节点</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre>                sib <span class=\"token operator\">=</span> <span class=\"token function\">rightOf</span><span class=\"token punctuation\">(</span><span class=\"token function\">parentOf</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 重新设置 x 的兄弟节点</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"100\"></td><td><pre></pre></td></tr><tr><td data-num=\"101\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">colorOf</span><span class=\"token punctuation\">(</span><span class=\"token function\">leftOf</span><span class=\"token punctuation\">(</span>sib<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>  <span class=\"token operator\">==</span> BLACK <span class=\"token operator\">&amp;&amp;</span></pre></td></tr><tr><td data-num=\"102\"></td><td><pre>                <span class=\"token function\">colorOf</span><span class=\"token punctuation\">(</span><span class=\"token function\">rightOf</span><span class=\"token punctuation\">(</span>sib<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> BLACK<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"103\"></td><td><pre>                <span class=\"token function\">setColor</span><span class=\"token punctuation\">(</span>sib<span class=\"token punctuation\">,</span> RED<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 兄弟节点的两个孩子都是黑色的重新设置兄弟节点的颜色，修改为红色</span></pre></td></tr><tr><td data-num=\"104\"></td><td><pre>                x <span class=\"token operator\">=</span> <span class=\"token function\">parentOf</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>   <span class=\"token comment\">// 将 x 定位到父节点</span></pre></td></tr><tr><td data-num=\"105\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"106\"></td><td><pre>                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">colorOf</span><span class=\"token punctuation\">(</span><span class=\"token function\">rightOf</span><span class=\"token punctuation\">(</span>sib<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> BLACK<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>   <span class=\"token comment\">// 兄弟节点的右孩子是黑色的，左孩子是红色的</span></pre></td></tr><tr><td data-num=\"107\"></td><td><pre>                    <span class=\"token function\">setColor</span><span class=\"token punctuation\">(</span><span class=\"token function\">leftOf</span><span class=\"token punctuation\">(</span>sib<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> BLACK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">// 设置左孩子节点为黑色</span></pre></td></tr><tr><td data-num=\"108\"></td><td><pre>                    <span class=\"token function\">setColor</span><span class=\"token punctuation\">(</span>sib<span class=\"token punctuation\">,</span> RED<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 兄弟节点为红色</span></pre></td></tr><tr><td data-num=\"109\"></td><td><pre>                    <span class=\"token function\">rotateRight</span><span class=\"token punctuation\">(</span>sib<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>   <span class=\"token comment\">// 右旋</span></pre></td></tr><tr><td data-num=\"110\"></td><td><pre>                    sib <span class=\"token operator\">=</span> <span class=\"token function\">rightOf</span><span class=\"token punctuation\">(</span><span class=\"token function\">parentOf</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">// 右旋后重新设置兄弟节点</span></pre></td></tr><tr><td data-num=\"111\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"112\"></td><td><pre>                <span class=\"token function\">setColor</span><span class=\"token punctuation\">(</span>sib<span class=\"token punctuation\">,</span> <span class=\"token function\">colorOf</span><span class=\"token punctuation\">(</span><span class=\"token function\">parentOf</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">// 兄弟节点颜色设置和父节点的颜色相同</span></pre></td></tr><tr><td data-num=\"113\"></td><td><pre>                <span class=\"token function\">setColor</span><span class=\"token punctuation\">(</span><span class=\"token function\">parentOf</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> BLACK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>   <span class=\"token comment\">// 父节点设置为黑色</span></pre></td></tr><tr><td data-num=\"114\"></td><td><pre>                <span class=\"token function\">setColor</span><span class=\"token punctuation\">(</span><span class=\"token function\">rightOf</span><span class=\"token punctuation\">(</span>sib<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> BLACK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">// 将兄弟节点的有孩子设置为黑色</span></pre></td></tr><tr><td data-num=\"115\"></td><td><pre>                <span class=\"token function\">rotateLeft</span><span class=\"token punctuation\">(</span><span class=\"token function\">parentOf</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>   <span class=\"token comment\">// 左旋</span></pre></td></tr><tr><td data-num=\"116\"></td><td><pre>                x <span class=\"token operator\">=</span> root<span class=\"token punctuation\">;</span>  <span class=\"token comment\">// 设置 x 为根节点</span></pre></td></tr><tr><td data-num=\"117\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"118\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token comment\">// symmetric</span></pre></td></tr><tr><td data-num=\"119\"></td><td><pre>            <span class=\"token comment\">//x 为父节点的右节点，参考上面的操作</span></pre></td></tr><tr><td data-num=\"120\"></td><td><pre>            <span class=\"token class-name\">Entry</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">K</span><span class=\"token punctuation\">,</span><span class=\"token class-name\">V</span><span class=\"token punctuation\">></span></span> sib <span class=\"token operator\">=</span> <span class=\"token function\">leftOf</span><span class=\"token punctuation\">(</span><span class=\"token function\">parentOf</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"121\"></td><td><pre></pre></td></tr><tr><td data-num=\"122\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">colorOf</span><span class=\"token punctuation\">(</span>sib<span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> RED<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"123\"></td><td><pre>                <span class=\"token function\">setColor</span><span class=\"token punctuation\">(</span>sib<span class=\"token punctuation\">,</span> BLACK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"124\"></td><td><pre>                <span class=\"token function\">setColor</span><span class=\"token punctuation\">(</span><span class=\"token function\">parentOf</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> RED<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"125\"></td><td><pre>                <span class=\"token function\">rotateRight</span><span class=\"token punctuation\">(</span><span class=\"token function\">parentOf</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"126\"></td><td><pre>                sib <span class=\"token operator\">=</span> <span class=\"token function\">leftOf</span><span class=\"token punctuation\">(</span><span class=\"token function\">parentOf</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"127\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"128\"></td><td><pre></pre></td></tr><tr><td data-num=\"129\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">colorOf</span><span class=\"token punctuation\">(</span><span class=\"token function\">rightOf</span><span class=\"token punctuation\">(</span>sib<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> BLACK <span class=\"token operator\">&amp;&amp;</span><span class=\"token function\">colorOf</span><span class=\"token punctuation\">(</span><span class=\"token function\">leftOf</span><span class=\"token punctuation\">(</span>sib<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> BLACK<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"130\"></td><td><pre>                    <span class=\"token function\">setColor</span><span class=\"token punctuation\">(</span>sib<span class=\"token punctuation\">,</span> RED<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"131\"></td><td><pre>                    x <span class=\"token operator\">=</span> <span class=\"token function\">parentOf</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"132\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"133\"></td><td><pre>                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">colorOf</span><span class=\"token punctuation\">(</span><span class=\"token function\">leftOf</span><span class=\"token punctuation\">(</span>sib<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> BLACK<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"134\"></td><td><pre>                    <span class=\"token function\">setColor</span><span class=\"token punctuation\">(</span><span class=\"token function\">rightOf</span><span class=\"token punctuation\">(</span>sib<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> BLACK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"135\"></td><td><pre>                    <span class=\"token function\">setColor</span><span class=\"token punctuation\">(</span>sib<span class=\"token punctuation\">,</span> RED<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"136\"></td><td><pre>                    <span class=\"token function\">rotateLeft</span><span class=\"token punctuation\">(</span>sib<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"137\"></td><td><pre>                    sib <span class=\"token operator\">=</span> <span class=\"token function\">leftOf</span><span class=\"token punctuation\">(</span><span class=\"token function\">parentOf</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"138\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"139\"></td><td><pre>                <span class=\"token function\">setColor</span><span class=\"token punctuation\">(</span>sib<span class=\"token punctuation\">,</span> <span class=\"token function\">colorOf</span><span class=\"token punctuation\">(</span><span class=\"token function\">parentOf</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"140\"></td><td><pre>                <span class=\"token function\">setColor</span><span class=\"token punctuation\">(</span><span class=\"token function\">parentOf</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> BLACK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"141\"></td><td><pre>                <span class=\"token function\">setColor</span><span class=\"token punctuation\">(</span><span class=\"token function\">leftOf</span><span class=\"token punctuation\">(</span>sib<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> BLACK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"142\"></td><td><pre>                <span class=\"token function\">rotateRight</span><span class=\"token punctuation\">(</span><span class=\"token function\">parentOf</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"143\"></td><td><pre>                x <span class=\"token operator\">=</span> root<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"144\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"145\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"146\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"147\"></td><td><pre></pre></td></tr><tr><td data-num=\"148\"></td><td><pre>    <span class=\"token function\">setColor</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">,</span> BLACK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"149\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>以排序二叉树的方法删除指定节点。删除的节点存在三种情况：</p>\n<ul>\n<li>被删除节点，没有左右孩子节点，直接删除即可</li>\n<li>被删除节点，有一个孩子节点，那么让它的孩子节点指向它的父节点即可</li>\n<li>本删除的节点，有两个非空的孩子节点，那么需要找到该节点的前驱或者后继节点，更换元素值，在将前驱或者后继节点删除（任意一个节点的前驱或者后继都必定至多有一个非空的子节点，可以按照前面的两种情形进行操作）</li>\n</ul>\n",
            "tags": [
                "计算机科学",
                "数据结构",
                "java"
            ]
        },
        {
            "id": "http://yrmlnf.coding-pages.com/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-HashMap/",
            "url": "http://yrmlnf.coding-pages.com/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-HashMap/",
            "title": "数据结构-HashMap",
            "date_published": "2020-10-15T06:44:39.000Z",
            "content_html": "<h1 id=\"概述\"><a class=\"anchor\" href=\"#概述\">#</a> 概述</h1>\n<p>文章的内容基于 JDK1.7 进行分析，之所以选用这个版本，是因为 1.8 的有些类做了改动，增加了阅读的难度，虽然是 1.7，但是对于 1.8 做了重大改动的内容，文章也会进行说明。</p>\n<p>HashMap 基于 Map 接口实现，元素以键值对的方式存储，并且允许使用 null 建和 null　值，　因为 key 不允许重复，因此只能有一个键为 null, 另外 HashMap 不能保证放入元素的顺序，它是无序的，和放入的顺序并不能相同。HashMap 是线程不安全的。</p>\n<h1 id=\"继承关系\"><a class=\"anchor\" href=\"#继承关系\">#</a> 继承关系</h1>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">HashMap</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">K</span><span class=\"token punctuation\">,</span><span class=\"token class-name\">V</span><span class=\"token punctuation\">></span></span><span class=\"token keyword\">extends</span> <span class=\"token class-name\">AbstractMap</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">K</span><span class=\"token punctuation\">,</span><span class=\"token class-name\">V</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">implements</span> <span class=\"token class-name\">Map</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">K</span><span class=\"token punctuation\">,</span><span class=\"token class-name\">V</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Cloneable</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Serializable</span></pre></td></tr></table></figure><h1 id=\"实现接口\"><a class=\"anchor\" href=\"#实现接口\">#</a> 实现接口</h1>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token class-name\">Serializable</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Cloneable</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Map</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">K</span><span class=\"token punctuation\">,</span><span class=\"token class-name\">V</span><span class=\"token punctuation\">></span></span></pre></td></tr></table></figure><h1 id=\"基本属性\"><a class=\"anchor\" href=\"#基本属性\">#</a> 基本属性</h1>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">int</span> DEFAULT_INITIAL_CAPACITY <span class=\"token operator\">=</span> <span class=\"token number\">1</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token number\">4</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 默认初始化大小 16 </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">float</span> DEFAULT_LOAD_FACTOR <span class=\"token operator\">=</span> <span class=\"token number\">0.75f</span><span class=\"token punctuation\">;</span>     <span class=\"token comment\">// 负载因子 0.75</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">Entry</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token operator\">?</span><span class=\"token punctuation\">,</span><span class=\"token operator\">?</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> EMPTY_TABLE <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span>         <span class=\"token comment\">// 初始化的默认数组</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">transient</span> <span class=\"token keyword\">int</span> size<span class=\"token punctuation\">;</span>     <span class=\"token comment\">//HashMap 中元素的数量</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">int</span> threshold<span class=\"token punctuation\">;</span>          <span class=\"token comment\">// 判断是否需要调整 HashMap 的容量</span></pre></td></tr></table></figure><h1 id=\"hashmap数据结构\"><a class=\"anchor\" href=\"#hashmap数据结构\">#</a> HashMap 数据结构</h1>\n<div class=\"note info\">\n<ol>\n<li>什么是链表<br />\n链表是由一系列非连续的节点组成的存储结构，简单分下类的话，链表又分为单向链表和双向链表，而单向 / 双向链表又可以分为循环链表和非循环链表，下面简单就这四种链表进行图解说明。</li>\n<li>单向链表<br />\n单向链表就是通过每个结点的指针指向下一个结点从而链接起来的结构，最后一个节点的 next 指向 null<br />\n<img data-src=\"2.png\" alt=\"\" /></li>\n<li>单向循环链表<br />\n单向循环链表和单向列表的不同是，最后一个节点的 next 不是指向 null，而是指向 head 节点，形成一个 “环”<br />\n<img data-src=\"3.png\" alt=\"\" /></li>\n<li>双向链表<br />\n从名字就可以看出，双向链表是包含两个指针的，pre 指向前一个节点，next 指向后一个节点，但是第一个节点 head 的 pre 指向 null，最后一个节点的 tail 指向 null<br />\n<img data-src=\"4.png\" alt=\"\" /></li>\n<li>双向循环链表<br />\n双向循环链表和双向链表的不同在于，第一个节点的 pre 指向最后一个节点，最后一个节点的 next 指向第一个节点，也形成一个 “环”。而 LinkedList 就是基于双向 &gt; 循环链表设计的<br />\n<img data-src=\"5.png\" alt=\"\" /></li>\n</ol>\n</div>\n<p>在进行源码解析之前，先从总体上对 HashMap 的数据存储结构进行一个大体上的说明。</p>\n<p><img data-src=\"1.png\" alt=\"\" /></p>\n<p>存储结构如上图所示。</p>\n<p>HashMap 采用 Entry 数组来存储 key-value 对，每一个键值对组成了一个 Entry 实体，Entry 类实际上是一个单向的链表结构，它具有 Next 指针，可以连接下一个 Entry 实体，依次来解决 Hash 冲突的问题，因为 HashMap 是按照 Key 的 hash 值来计算 Entry 在 HashMap 中存储的位置的，如果 hash 值相同，而 key 内容不相等，那么就用链表来解决这种 hash 冲突。</p>\n<h1 id=\"源码解析\"><a class=\"anchor\" href=\"#源码解析\">#</a> 源码解析</h1>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">HashMap</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">K</span><span class=\"token punctuation\">,</span><span class=\"token class-name\">V</span><span class=\"token punctuation\">></span></span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">AbstractMap</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">K</span><span class=\"token punctuation\">,</span><span class=\"token class-name\">V</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">implements</span> <span class=\"token class-name\">Map</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">K</span><span class=\"token punctuation\">,</span><span class=\"token class-name\">V</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Cloneable</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Serializable</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token comment\">// 默认初始化的容量</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">int</span> DEFAULT_INITIAL_CAPACITY <span class=\"token operator\">=</span> <span class=\"token number\">1</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token number\">4</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// aka 16</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token comment\">// 最大的容量</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">int</span> MAXIMUM_CAPACITY <span class=\"token operator\">=</span> <span class=\"token number\">1</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token number\">30</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token comment\">// 负载因子，当容量达到 75% 时就进行扩容操作</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">float</span> DEFAULT_LOAD_FACTOR <span class=\"token operator\">=</span> <span class=\"token number\">0.75f</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token comment\">// 当数组还没有进行扩容操作的时候，共享的一个空表对象</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">Entry</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token operator\">?</span><span class=\"token punctuation\">,</span><span class=\"token operator\">?</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> EMPTY_TABLE <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token comment\">//table, 进行扩容操作，长度必须 2 的 n 次方</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token keyword\">transient</span> <span class=\"token class-name\">Entry</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">K</span><span class=\"token punctuation\">,</span><span class=\"token class-name\">V</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> table <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Entry</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">K</span><span class=\"token punctuation\">,</span><span class=\"token class-name\">V</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> EMPTY_TABLE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token comment\">//Map 中包含的元素数量</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token keyword\">transient</span> <span class=\"token keyword\">int</span> size<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token comment\">// 阈值，用于判断是否需要扩容（threshold = 容量 * 负载因子）</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token keyword\">int</span> threshold<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token comment\">// 加载因子实际的大小</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    <span class=\"token keyword\">final</span> <span class=\"token keyword\">float</span> loadFactor<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    <span class=\"token comment\">//HashMap 改变的次数</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    <span class=\"token keyword\">transient</span> <span class=\"token keyword\">int</span> modCount<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>   </pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">int</span> ALTERNATIVE_HASHING_THRESHOLD_DEFAULT <span class=\"token operator\">=</span> <span class=\"token class-name\">Integer</span><span class=\"token punctuation\">.</span>MAX_VALUE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    <span class=\"token comment\">// 内部类，通过 vm 来修改 threshold 的值</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Holder</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>        <span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>         * Table capacity above which to switch to use alternative hashing.</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>         */</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>        <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">int</span> ALTERNATIVE_HASHING_THRESHOLD<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>        <span class=\"token keyword\">static</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>            <span class=\"token class-name\">String</span> altThreshold <span class=\"token operator\">=</span> <span class=\"token class-name\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>security<span class=\"token punctuation\">.</span></span>AccessController</span><span class=\"token punctuation\">.</span><span class=\"token function\">doPrivileged</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>                <span class=\"token keyword\">new</span> <span class=\"token class-name\"><span class=\"token namespace\">sun<span class=\"token punctuation\">.</span>security<span class=\"token punctuation\">.</span>action<span class=\"token punctuation\">.</span></span>GetPropertyAction</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>                    <span class=\"token string\">\"jdk.map.althashing.threshold\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 读取值</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>            <span class=\"token keyword\">int</span> threshold<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>            <span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>                threshold <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span> <span class=\"token operator\">!=</span> altThreshold<span class=\"token punctuation\">)</span>   <span class=\"token comment\">// 修改值</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>                        <span class=\"token operator\">?</span> <span class=\"token class-name\">Integer</span><span class=\"token punctuation\">.</span><span class=\"token function\">parseInt</span><span class=\"token punctuation\">(</span>altThreshold<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>                        <span class=\"token operator\">:</span> ALTERNATIVE_HASHING_THRESHOLD_DEFAULT<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>                <span class=\"token comment\">// disable alternative hashing if -1</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>threshold <span class=\"token operator\">==</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>                    threshold <span class=\"token operator\">=</span> <span class=\"token class-name\">Integer</span><span class=\"token punctuation\">.</span>MAX_VALUE<span class=\"token punctuation\">;</span> <span class=\"token comment\">// 设置为 Integer 能表示的最大值</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>threshold <span class=\"token operator\">&lt;</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>                    <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">IllegalArgumentException</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"value must be positive integer.\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">catch</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">IllegalArgumentException</span> failed<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>                <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Illegal value for 'jdk.map.althashing.threshold'\"</span><span class=\"token punctuation\">,</span> failed<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>            ALTERNATIVE_HASHING_THRESHOLD <span class=\"token operator\">=</span> threshold<span class=\"token punctuation\">;</span>  <span class=\"token comment\">// 返回</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>    <span class=\"token comment\">//HashCode 的初始值为 0 </span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>    <span class=\"token keyword\">transient</span> <span class=\"token keyword\">int</span> hashSeed <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>    <span class=\"token comment\">// 构造方法，指定初始容量和负载因子</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token class-name\">HashMap</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> initialCapacity<span class=\"token punctuation\">,</span> <span class=\"token keyword\">float</span> loadFactor<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>initialCapacity <span class=\"token operator\">&lt;</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>            <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">IllegalArgumentException</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Illegal initial capacity: \"</span> <span class=\"token operator\">+</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>                                               initialCapacity<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>initialCapacity <span class=\"token operator\">></span> MAXIMUM_CAPACITY<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>            initialCapacity <span class=\"token operator\">=</span> MAXIMUM_CAPACITY<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>loadFactor <span class=\"token operator\">&lt;=</span> <span class=\"token number\">0</span> <span class=\"token operator\">||</span> <span class=\"token class-name\">Float</span><span class=\"token punctuation\">.</span><span class=\"token function\">isNaN</span><span class=\"token punctuation\">(</span>loadFactor<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>            <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">IllegalArgumentException</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Illegal load factor: \"</span> <span class=\"token operator\">+</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>                                               loadFactor<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>loadFactor <span class=\"token operator\">=</span> loadFactor<span class=\"token punctuation\">;</span> <span class=\"token comment\">// 设置负载因子</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>        threshold <span class=\"token operator\">=</span> initialCapacity<span class=\"token punctuation\">;</span> <span class=\"token comment\">// 初始容量</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>        <span class=\"token function\">init</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 不做任何操作</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>    <span class=\"token comment\">// 构造方法，指定了初始容量</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token class-name\">HashMap</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> initialCapacity<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>        <span class=\"token keyword\">this</span><span class=\"token punctuation\">(</span>initialCapacity<span class=\"token punctuation\">,</span> DEFAULT_LOAD_FACTOR<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>    <span class=\"token comment\">// 无参构造方法，使用默认的容量大小和负载因子，并调用其他的构造方法</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token class-name\">HashMap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre>        <span class=\"token keyword\">this</span><span class=\"token punctuation\">(</span>DEFAULT_INITIAL_CAPACITY<span class=\"token punctuation\">,</span> DEFAULT_LOAD_FACTOR<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre></pre></td></tr><tr><td data-num=\"98\"></td><td><pre>    <span class=\"token comment\">// 构造函数，参数为指定的 Map 集合</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token class-name\">HashMap</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Map</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token operator\">?</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">K</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">?</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">V</span><span class=\"token punctuation\">></span></span> m<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"100\"></td><td><pre>        <span class=\"token keyword\">this</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Math</span><span class=\"token punctuation\">.</span><span class=\"token function\">max</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span>m<span class=\"token punctuation\">.</span><span class=\"token function\">size</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> DEFAULT_LOAD_FACTOR<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"101\"></td><td><pre>                      DEFAULT_INITIAL_CAPACITY<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> DEFAULT_LOAD_FACTOR<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"102\"></td><td><pre>        <span class=\"token function\">inflateTable</span><span class=\"token punctuation\">(</span>threshold<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"103\"></td><td><pre></pre></td></tr><tr><td data-num=\"104\"></td><td><pre>        <span class=\"token function\">putAllForCreate</span><span class=\"token punctuation\">(</span>m<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"105\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"106\"></td><td><pre>    <span class=\"token comment\">// 选择合适的容量值，最好是 number 的 2 的幂数</span></pre></td></tr><tr><td data-num=\"107\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">int</span> <span class=\"token function\">roundUpToPowerOf2</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> number<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"108\"></td><td><pre>        <span class=\"token comment\">// assert number >= 0 : \"number must be non-negative\";</span></pre></td></tr><tr><td data-num=\"109\"></td><td><pre>        <span class=\"token keyword\">return</span> number <span class=\"token operator\">>=</span> MAXIMUM_CAPACITY</pre></td></tr><tr><td data-num=\"110\"></td><td><pre>                <span class=\"token operator\">?</span> MAXIMUM_CAPACITY</pre></td></tr><tr><td data-num=\"111\"></td><td><pre>                <span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span>number <span class=\"token operator\">></span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">?</span> <span class=\"token class-name\">Integer</span><span class=\"token punctuation\">.</span><span class=\"token function\">highestOneBit</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>number <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"112\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"113\"></td><td><pre></pre></td></tr><tr><td data-num=\"114\"></td><td><pre>    <span class=\"token comment\">// 扩充表，HashMap 初始化时是一个空数组，此方法执行重新复制操作，创建一个新的 Entry []</span></pre></td></tr><tr><td data-num=\"115\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token keyword\">void</span> <span class=\"token function\">inflateTable</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> toSize<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"116\"></td><td><pre>        <span class=\"token comment\">// Find a power of 2 >= toSize</span></pre></td></tr><tr><td data-num=\"117\"></td><td><pre>        <span class=\"token keyword\">int</span> capacity <span class=\"token operator\">=</span> <span class=\"token function\">roundUpToPowerOf2</span><span class=\"token punctuation\">(</span>toSize<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//capacity 为 2 的幂数，大于等于 toSize</span></pre></td></tr><tr><td data-num=\"118\"></td><td><pre></pre></td></tr><tr><td data-num=\"119\"></td><td><pre>        threshold <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">)</span> <span class=\"token class-name\">Math</span><span class=\"token punctuation\">.</span><span class=\"token function\">min</span><span class=\"token punctuation\">(</span>capacity <span class=\"token operator\">*</span> loadFactor<span class=\"token punctuation\">,</span> MAXIMUM_CAPACITY <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"120\"></td><td><pre>        table <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Entry</span><span class=\"token punctuation\">[</span>capacity<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">// 新建数组，并重新赋值</span></pre></td></tr><tr><td data-num=\"121\"></td><td><pre>        <span class=\"token function\">initHashSeedAsNeeded</span><span class=\"token punctuation\">(</span>capacity<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">// 修改 hashSeed </span></pre></td></tr><tr><td data-num=\"122\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"123\"></td><td><pre></pre></td></tr><tr><td data-num=\"124\"></td><td><pre>    <span class=\"token comment\">// internal utilities</span></pre></td></tr><tr><td data-num=\"125\"></td><td><pre></pre></td></tr><tr><td data-num=\"126\"></td><td><pre>    <span class=\"token comment\">// 初始化</span></pre></td></tr><tr><td data-num=\"127\"></td><td><pre>    <span class=\"token keyword\">void</span> <span class=\"token function\">init</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"128\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"129\"></td><td><pre></pre></td></tr><tr><td data-num=\"130\"></td><td><pre>    <span class=\"token comment\">// 与虚拟机设置有关，改变 hashSeed 的值</span></pre></td></tr><tr><td data-num=\"131\"></td><td><pre>    <span class=\"token keyword\">final</span> <span class=\"token keyword\">boolean</span> <span class=\"token function\">initHashSeedAsNeeded</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> capacity<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"132\"></td><td><pre>        <span class=\"token keyword\">boolean</span> currentAltHashing <span class=\"token operator\">=</span> hashSeed <span class=\"token operator\">!=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"133\"></td><td><pre>        <span class=\"token keyword\">boolean</span> useAltHashing <span class=\"token operator\">=</span> sun<span class=\"token punctuation\">.</span>misc<span class=\"token punctuation\">.</span>VM<span class=\"token punctuation\">.</span><span class=\"token function\">isBooted</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span></pre></td></tr><tr><td data-num=\"134\"></td><td><pre>                <span class=\"token punctuation\">(</span>capacity <span class=\"token operator\">>=</span> <span class=\"token class-name\">Holder</span><span class=\"token punctuation\">.</span>ALTERNATIVE_HASHING_THRESHOLD<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"135\"></td><td><pre>        <span class=\"token keyword\">boolean</span> switching <span class=\"token operator\">=</span> currentAltHashing <span class=\"token operator\">^</span> useAltHashing<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"136\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>switching<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"137\"></td><td><pre>            hashSeed <span class=\"token operator\">=</span> useAltHashing</pre></td></tr><tr><td data-num=\"138\"></td><td><pre>                <span class=\"token operator\">?</span> <span class=\"token class-name\"><span class=\"token namespace\">sun<span class=\"token punctuation\">.</span>misc<span class=\"token punctuation\">.</span></span>Hashing</span><span class=\"token punctuation\">.</span><span class=\"token function\">randomHashSeed</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"139\"></td><td><pre>                <span class=\"token operator\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"140\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"141\"></td><td><pre>        <span class=\"token keyword\">return</span> switching<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"142\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"143\"></td><td><pre></pre></td></tr><tr><td data-num=\"144\"></td><td><pre>    <span class=\"token comment\">// 计算 k 的 hash 值</span></pre></td></tr><tr><td data-num=\"145\"></td><td><pre>    <span class=\"token keyword\">final</span> <span class=\"token keyword\">int</span> <span class=\"token function\">hash</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Object</span> k<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"146\"></td><td><pre>        <span class=\"token keyword\">int</span> h <span class=\"token operator\">=</span> hashSeed<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"147\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0</span> <span class=\"token operator\">!=</span> h <span class=\"token operator\">&amp;&amp;</span> k <span class=\"token keyword\">instanceof</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"148\"></td><td><pre>            <span class=\"token keyword\">return</span> <span class=\"token class-name\"><span class=\"token namespace\">sun<span class=\"token punctuation\">.</span>misc<span class=\"token punctuation\">.</span></span>Hashing</span><span class=\"token punctuation\">.</span><span class=\"token function\">stringHash32</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">)</span> k<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"149\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"150\"></td><td><pre></pre></td></tr><tr><td data-num=\"151\"></td><td><pre>        h <span class=\"token operator\">^=</span> k<span class=\"token punctuation\">.</span><span class=\"token function\">hashCode</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"152\"></td><td><pre></pre></td></tr><tr><td data-num=\"153\"></td><td><pre>        <span class=\"token comment\">// This function ensures that hashCodes that differ only by</span></pre></td></tr><tr><td data-num=\"154\"></td><td><pre>        <span class=\"token comment\">// constant multiples at each bit position have a bounded</span></pre></td></tr><tr><td data-num=\"155\"></td><td><pre>        <span class=\"token comment\">// number of collisions (approximately 8 at default load factor).</span></pre></td></tr><tr><td data-num=\"156\"></td><td><pre>        h <span class=\"token operator\">^=</span> <span class=\"token punctuation\">(</span>h <span class=\"token operator\">>>></span> <span class=\"token number\">20</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">^</span> <span class=\"token punctuation\">(</span>h <span class=\"token operator\">>>></span> <span class=\"token number\">12</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"157\"></td><td><pre>        <span class=\"token keyword\">return</span> h <span class=\"token operator\">^</span> <span class=\"token punctuation\">(</span>h <span class=\"token operator\">>>></span> <span class=\"token number\">7</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">^</span> <span class=\"token punctuation\">(</span>h <span class=\"token operator\">>>></span> <span class=\"token number\">4</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"158\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"159\"></td><td><pre></pre></td></tr><tr><td data-num=\"160\"></td><td><pre>    <span class=\"token comment\">// 根据 hashcode, 和表的长度，返回存放的索引</span></pre></td></tr><tr><td data-num=\"161\"></td><td><pre>    <span class=\"token keyword\">static</span> <span class=\"token keyword\">int</span> <span class=\"token function\">indexFor</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> h<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> length<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"162\"></td><td><pre>        <span class=\"token comment\">// assert Integer.bitCount(length) == 1 : \"length must be a non-zero power of 2\";</span></pre></td></tr><tr><td data-num=\"163\"></td><td><pre>        <span class=\"token keyword\">return</span> h <span class=\"token operator\">&amp;</span> <span class=\"token punctuation\">(</span>length<span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"164\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"165\"></td><td><pre></pre></td></tr><tr><td data-num=\"166\"></td><td><pre>    <span class=\"token comment\">// 返回 Map 中键值对的数量</span></pre></td></tr><tr><td data-num=\"167\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">int</span> <span class=\"token function\">size</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"168\"></td><td><pre>        <span class=\"token keyword\">return</span> size<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"169\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"170\"></td><td><pre></pre></td></tr><tr><td data-num=\"171\"></td><td><pre>    <span class=\"token comment\">// 判断集合是否为空</span></pre></td></tr><tr><td data-num=\"172\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">boolean</span> <span class=\"token function\">isEmpty</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"173\"></td><td><pre>        <span class=\"token keyword\">return</span> size <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"174\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"175\"></td><td><pre></pre></td></tr><tr><td data-num=\"176\"></td><td><pre>    <span class=\"token comment\">// 返回 key ，对应的值</span></pre></td></tr><tr><td data-num=\"177\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token class-name\">V</span> <span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Object</span> key<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"178\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>key <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"179\"></td><td><pre>            <span class=\"token keyword\">return</span> <span class=\"token function\">getForNullKey</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"180\"></td><td><pre>        <span class=\"token class-name\">Entry</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">K</span><span class=\"token punctuation\">,</span><span class=\"token class-name\">V</span><span class=\"token punctuation\">></span></span> entry <span class=\"token operator\">=</span> <span class=\"token function\">getEntry</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"181\"></td><td><pre></pre></td></tr><tr><td data-num=\"182\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">==</span> entry <span class=\"token operator\">?</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">:</span> entry<span class=\"token punctuation\">.</span><span class=\"token function\">getValue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"183\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"184\"></td><td><pre></pre></td></tr><tr><td data-num=\"185\"></td><td><pre>    <span class=\"token comment\">// 返回 null 键的值</span></pre></td></tr><tr><td data-num=\"186\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token class-name\">V</span> <span class=\"token function\">getForNullKey</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"187\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>size <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"188\"></td><td><pre>            <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"189\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"190\"></td><td><pre>        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Entry</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">K</span><span class=\"token punctuation\">,</span><span class=\"token class-name\">V</span><span class=\"token punctuation\">></span></span> e <span class=\"token operator\">=</span> table<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> e <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span> e <span class=\"token operator\">=</span> e<span class=\"token punctuation\">.</span>next<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"191\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">.</span>key <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"192\"></td><td><pre>                <span class=\"token keyword\">return</span> e<span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"193\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"194\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"195\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"196\"></td><td><pre></pre></td></tr><tr><td data-num=\"197\"></td><td><pre>    <span class=\"token comment\">// 是否包含键为 key 的元素</span></pre></td></tr><tr><td data-num=\"198\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">boolean</span> <span class=\"token function\">containsKey</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Object</span> key<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"199\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token function\">getEntry</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"200\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"201\"></td><td><pre></pre></td></tr><tr><td data-num=\"202\"></td><td><pre>    <span class=\"token comment\">// 返回键为 key 的 entry 实体，不存在返回 null</span></pre></td></tr><tr><td data-num=\"203\"></td><td><pre>    <span class=\"token keyword\">final</span> <span class=\"token class-name\">Entry</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">K</span><span class=\"token punctuation\">,</span><span class=\"token class-name\">V</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">getEntry</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Object</span> key<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"204\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>size <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"205\"></td><td><pre>            <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"206\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"207\"></td><td><pre></pre></td></tr><tr><td data-num=\"208\"></td><td><pre>        <span class=\"token keyword\">int</span> hash <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>key <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">?</span> <span class=\"token number\">0</span> <span class=\"token operator\">:</span> <span class=\"token function\">hash</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">// 计算 key 的 hash 值</span></pre></td></tr><tr><td data-num=\"209\"></td><td><pre>        <span class=\"token comment\">// 定位到 Entry [] 数组中的存储位置，开始遍历该位置是否有链表存在</span></pre></td></tr><tr><td data-num=\"210\"></td><td><pre>        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Entry</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">K</span><span class=\"token punctuation\">,</span><span class=\"token class-name\">V</span><span class=\"token punctuation\">></span></span> e <span class=\"token operator\">=</span> table<span class=\"token punctuation\">[</span><span class=\"token function\">indexFor</span><span class=\"token punctuation\">(</span>hash<span class=\"token punctuation\">,</span> table<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"211\"></td><td><pre>             e <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"212\"></td><td><pre>             e <span class=\"token operator\">=</span> e<span class=\"token punctuation\">.</span>next<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"213\"></td><td><pre>            <span class=\"token class-name\">Object</span> k<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"214\"></td><td><pre>            <span class=\"token comment\">// 判断是否有键位 key 的 entry 实体。有就返回。</span></pre></td></tr><tr><td data-num=\"215\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">.</span>hash <span class=\"token operator\">==</span> hash <span class=\"token operator\">&amp;&amp;</span></pre></td></tr><tr><td data-num=\"216\"></td><td><pre>                <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>k <span class=\"token operator\">=</span> e<span class=\"token punctuation\">.</span>key<span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> key <span class=\"token operator\">||</span> <span class=\"token punctuation\">(</span>key <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">&amp;&amp;</span> key<span class=\"token punctuation\">.</span><span class=\"token function\">equals</span><span class=\"token punctuation\">(</span>k<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"217\"></td><td><pre>                <span class=\"token keyword\">return</span> e<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"218\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"219\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"220\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"221\"></td><td><pre></pre></td></tr><tr><td data-num=\"222\"></td><td><pre>      <span class=\"token comment\">// 向 map 中添加 key-value 键值对，如果可以包含了 key 的映射，则旧的 value 将被替换</span></pre></td></tr><tr><td data-num=\"223\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token class-name\">V</span> <span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">K</span> key<span class=\"token punctuation\">,</span> <span class=\"token class-name\">V</span> value<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"224\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>table <span class=\"token operator\">==</span> EMPTY_TABLE<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>  <span class=\"token comment\">//table 如果为空，进行初始化操作</span></pre></td></tr><tr><td data-num=\"225\"></td><td><pre>            <span class=\"token function\">inflateTable</span><span class=\"token punctuation\">(</span>threshold<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"226\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"227\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>key <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span>  <span class=\"token comment\">//key 为 null , 放入数组的 0 号索引位置</span></pre></td></tr><tr><td data-num=\"228\"></td><td><pre>            <span class=\"token keyword\">return</span> <span class=\"token function\">putForNullKey</span><span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"229\"></td><td><pre>        <span class=\"token keyword\">int</span> hash <span class=\"token operator\">=</span> <span class=\"token function\">hash</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>   <span class=\"token comment\">// 计算 key 的 hash 值</span></pre></td></tr><tr><td data-num=\"230\"></td><td><pre>        <span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> <span class=\"token function\">indexFor</span><span class=\"token punctuation\">(</span>hash<span class=\"token punctuation\">,</span> table<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">// 计算 key 在 entry 数组中存储的位置</span></pre></td></tr><tr><td data-num=\"231\"></td><td><pre>        <span class=\"token comment\">// 判断该位置是否已经有元素存在</span></pre></td></tr><tr><td data-num=\"232\"></td><td><pre>        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Entry</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">K</span><span class=\"token punctuation\">,</span><span class=\"token class-name\">V</span><span class=\"token punctuation\">></span></span> e <span class=\"token operator\">=</span> table<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> e <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span> e <span class=\"token operator\">=</span> e<span class=\"token punctuation\">.</span>next<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"233\"></td><td><pre>            <span class=\"token class-name\">Object</span> k<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"234\"></td><td><pre>            <span class=\"token comment\">// 判断 key 是否已经在 map 中存在，若存在用新的 value 替换掉旧的 value, 并返回旧的 value</span></pre></td></tr><tr><td data-num=\"235\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">.</span>hash <span class=\"token operator\">==</span> hash <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>k <span class=\"token operator\">=</span> e<span class=\"token punctuation\">.</span>key<span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> key <span class=\"token operator\">||</span> key<span class=\"token punctuation\">.</span><span class=\"token function\">equals</span><span class=\"token punctuation\">(</span>k<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"236\"></td><td><pre>                <span class=\"token class-name\">V</span> oldValue <span class=\"token operator\">=</span> e<span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"237\"></td><td><pre>                e<span class=\"token punctuation\">.</span>value <span class=\"token operator\">=</span> value<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"238\"></td><td><pre>                e<span class=\"token punctuation\">.</span><span class=\"token function\">recordAccess</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">// 空方法</span></pre></td></tr><tr><td data-num=\"239\"></td><td><pre>                <span class=\"token keyword\">return</span> oldValue<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"240\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"241\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"242\"></td><td><pre></pre></td></tr><tr><td data-num=\"243\"></td><td><pre>        modCount<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 修改次数加 1 </span></pre></td></tr><tr><td data-num=\"244\"></td><td><pre>        <span class=\"token function\">addEntry</span><span class=\"token punctuation\">(</span>hash<span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">,</span> value<span class=\"token punctuation\">,</span> i<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 将 key-value 转化为 Entry 实体，添加到 Map 中</span></pre></td></tr><tr><td data-num=\"245\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"246\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"247\"></td><td><pre></pre></td></tr><tr><td data-num=\"248\"></td><td><pre>    <span class=\"token comment\">//key = null, 对应的操作，keyweinull , 存放在 entry [] 中的 0 号位置。并用新值替换旧值</span></pre></td></tr><tr><td data-num=\"249\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token class-name\">V</span> <span class=\"token function\">putForNullKey</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">V</span> value<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"250\"></td><td><pre>        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Entry</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">K</span><span class=\"token punctuation\">,</span><span class=\"token class-name\">V</span><span class=\"token punctuation\">></span></span> e <span class=\"token operator\">=</span> table<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> e <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span> e <span class=\"token operator\">=</span> e<span class=\"token punctuation\">.</span>next<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"251\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">.</span>key <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"252\"></td><td><pre>                <span class=\"token class-name\">V</span> oldValue <span class=\"token operator\">=</span> e<span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"253\"></td><td><pre>                e<span class=\"token punctuation\">.</span>value <span class=\"token operator\">=</span> value<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"254\"></td><td><pre>                e<span class=\"token punctuation\">.</span><span class=\"token function\">recordAccess</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"255\"></td><td><pre>                <span class=\"token keyword\">return</span> oldValue<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"256\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"257\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"258\"></td><td><pre>        modCount<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"259\"></td><td><pre>        <span class=\"token function\">addEntry</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> value<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"260\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"261\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"262\"></td><td><pre></pre></td></tr><tr><td data-num=\"263\"></td><td><pre>    <span class=\"token comment\">// 私有方法，添加元素</span></pre></td></tr><tr><td data-num=\"264\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token keyword\">void</span> <span class=\"token function\">putForCreate</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">K</span> key<span class=\"token punctuation\">,</span> <span class=\"token class-name\">V</span> value<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"265\"></td><td><pre>        <span class=\"token keyword\">int</span> hash <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">==</span> key <span class=\"token operator\">?</span> <span class=\"token number\">0</span> <span class=\"token operator\">:</span> <span class=\"token function\">hash</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 计算 hash 值</span></pre></td></tr><tr><td data-num=\"266\"></td><td><pre>        <span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> <span class=\"token function\">indexFor</span><span class=\"token punctuation\">(</span>hash<span class=\"token punctuation\">,</span> table<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 计算在 HashMap 中的存储位置</span></pre></td></tr><tr><td data-num=\"267\"></td><td><pre></pre></td></tr><tr><td data-num=\"268\"></td><td><pre>        <span class=\"token comment\">// 遍历 i 号存储位置的链表</span></pre></td></tr><tr><td data-num=\"269\"></td><td><pre>        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Entry</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">K</span><span class=\"token punctuation\">,</span><span class=\"token class-name\">V</span><span class=\"token punctuation\">></span></span> e <span class=\"token operator\">=</span> table<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> e <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span> e <span class=\"token operator\">=</span> e<span class=\"token punctuation\">.</span>next<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"270\"></td><td><pre>            <span class=\"token class-name\">Object</span> k<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"271\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">.</span>hash <span class=\"token operator\">==</span> hash <span class=\"token operator\">&amp;&amp;</span></pre></td></tr><tr><td data-num=\"272\"></td><td><pre>                <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>k <span class=\"token operator\">=</span> e<span class=\"token punctuation\">.</span>key<span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> key <span class=\"token operator\">||</span> <span class=\"token punctuation\">(</span>key <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">&amp;&amp;</span> key<span class=\"token punctuation\">.</span><span class=\"token function\">equals</span><span class=\"token punctuation\">(</span>k<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"273\"></td><td><pre>                e<span class=\"token punctuation\">.</span>value <span class=\"token operator\">=</span> value<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"274\"></td><td><pre>                <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"275\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"276\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"277\"></td><td><pre>        <span class=\"token comment\">// 创建 Entry 实体，存放到 i 号位置中</span></pre></td></tr><tr><td data-num=\"278\"></td><td><pre>        <span class=\"token function\">createEntry</span><span class=\"token punctuation\">(</span>hash<span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">,</span> value<span class=\"token punctuation\">,</span> i<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"279\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"280\"></td><td><pre>    <span class=\"token comment\">// 将 m 中的元素添加到 HashMap 中</span></pre></td></tr><tr><td data-num=\"281\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token keyword\">void</span> <span class=\"token function\">putAllForCreate</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Map</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token operator\">?</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">K</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">?</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">V</span><span class=\"token punctuation\">></span></span> m<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"282\"></td><td><pre>        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Map<span class=\"token punctuation\">.</span>Entry</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token operator\">?</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">K</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">?</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">V</span><span class=\"token punctuation\">></span></span> e <span class=\"token operator\">:</span> m<span class=\"token punctuation\">.</span><span class=\"token function\">entrySet</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"283\"></td><td><pre>            <span class=\"token function\">putForCreate</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">.</span><span class=\"token function\">getKey</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> e<span class=\"token punctuation\">.</span><span class=\"token function\">getValue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"284\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"285\"></td><td><pre></pre></td></tr><tr><td data-num=\"286\"></td><td><pre>    <span class=\"token comment\">// 扩容操作</span></pre></td></tr><tr><td data-num=\"287\"></td><td><pre>    <span class=\"token keyword\">void</span> <span class=\"token function\">resize</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> newCapacity<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"288\"></td><td><pre>        <span class=\"token class-name\">Entry</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> oldTable <span class=\"token operator\">=</span> table<span class=\"token punctuation\">;</span>     <span class=\"token comment\">// 将 table 赋值给新的引用</span></pre></td></tr><tr><td data-num=\"289\"></td><td><pre>        <span class=\"token keyword\">int</span> oldCapacity <span class=\"token operator\">=</span> oldTable<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"290\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>oldCapacity <span class=\"token operator\">==</span> MAXIMUM_CAPACITY<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"291\"></td><td><pre>            threshold <span class=\"token operator\">=</span> <span class=\"token class-name\">Integer</span><span class=\"token punctuation\">.</span>MAX_VALUE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"292\"></td><td><pre>            <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"293\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"294\"></td><td><pre>        <span class=\"token comment\">// 创建一个长度为 newCapacity 的数组</span></pre></td></tr><tr><td data-num=\"295\"></td><td><pre>        <span class=\"token class-name\">Entry</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> newTable <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Entry</span><span class=\"token punctuation\">[</span>newCapacity<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"296\"></td><td><pre>        <span class=\"token comment\">// 将 table 中的元素复制到 newTable 中</span></pre></td></tr><tr><td data-num=\"297\"></td><td><pre>        <span class=\"token function\">transfer</span><span class=\"token punctuation\">(</span>newTable<span class=\"token punctuation\">,</span> <span class=\"token function\">initHashSeedAsNeeded</span><span class=\"token punctuation\">(</span>newCapacity<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"298\"></td><td><pre>        table <span class=\"token operator\">=</span> newTable<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"299\"></td><td><pre>        <span class=\"token comment\">// 更改阈值</span></pre></td></tr><tr><td data-num=\"300\"></td><td><pre>        threshold <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">)</span><span class=\"token class-name\">Math</span><span class=\"token punctuation\">.</span><span class=\"token function\">min</span><span class=\"token punctuation\">(</span>newCapacity <span class=\"token operator\">*</span> loadFactor<span class=\"token punctuation\">,</span> MAXIMUM_CAPACITY <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"301\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"302\"></td><td><pre></pre></td></tr><tr><td data-num=\"303\"></td><td><pre>    <span class=\"token comment\">// 将 table 中的数据复制到 newTable 中</span></pre></td></tr><tr><td data-num=\"304\"></td><td><pre>    <span class=\"token keyword\">void</span> <span class=\"token function\">transfer</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Entry</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> newTable<span class=\"token punctuation\">,</span> <span class=\"token keyword\">boolean</span> rehash<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"305\"></td><td><pre>        <span class=\"token keyword\">int</span> newCapacity <span class=\"token operator\">=</span> newTable<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"306\"></td><td><pre>        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Entry</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">K</span><span class=\"token punctuation\">,</span><span class=\"token class-name\">V</span><span class=\"token punctuation\">></span></span> e <span class=\"token operator\">:</span> table<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"307\"></td><td><pre>            <span class=\"token keyword\">while</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span> <span class=\"token operator\">!=</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"308\"></td><td><pre>                <span class=\"token class-name\">Entry</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">K</span><span class=\"token punctuation\">,</span><span class=\"token class-name\">V</span><span class=\"token punctuation\">></span></span> next <span class=\"token operator\">=</span> e<span class=\"token punctuation\">.</span>next<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"309\"></td><td><pre>                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>rehash<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token comment\">// 是否需要重新计算 Hash 值</span></pre></td></tr><tr><td data-num=\"310\"></td><td><pre>                    e<span class=\"token punctuation\">.</span>hash <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">==</span> e<span class=\"token punctuation\">.</span>key <span class=\"token operator\">?</span> <span class=\"token number\">0</span> <span class=\"token operator\">:</span> <span class=\"token function\">hash</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">.</span>key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"311\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"312\"></td><td><pre>                <span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> <span class=\"token function\">indexFor</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">.</span>hash<span class=\"token punctuation\">,</span> newCapacity<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 计算存储的位置</span></pre></td></tr><tr><td data-num=\"313\"></td><td><pre>                e<span class=\"token punctuation\">.</span>next <span class=\"token operator\">=</span> newTable<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"314\"></td><td><pre>                newTable<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> e<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"315\"></td><td><pre>                e <span class=\"token operator\">=</span> next<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"316\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"317\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"318\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"319\"></td><td><pre></pre></td></tr><tr><td data-num=\"320\"></td><td><pre>    <span class=\"token comment\">// 将 m 中的元素全部添加到 HashMap 中</span></pre></td></tr><tr><td data-num=\"321\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">putAll</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Map</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token operator\">?</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">K</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">?</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">V</span><span class=\"token punctuation\">></span></span> m<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"322\"></td><td><pre>        <span class=\"token keyword\">int</span> numKeysToBeAdded <span class=\"token operator\">=</span> m<span class=\"token punctuation\">.</span><span class=\"token function\">size</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"323\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>numKeysToBeAdded <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// 为空返回</span></pre></td></tr><tr><td data-num=\"324\"></td><td><pre>            <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"325\"></td><td><pre></pre></td></tr><tr><td data-num=\"326\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>table <span class=\"token operator\">==</span> EMPTY_TABLE<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token comment\">// 是否需要执行初始化操作</span></pre></td></tr><tr><td data-num=\"327\"></td><td><pre>            <span class=\"token function\">inflateTable</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">)</span> <span class=\"token class-name\">Math</span><span class=\"token punctuation\">.</span><span class=\"token function\">max</span><span class=\"token punctuation\">(</span>numKeysToBeAdded <span class=\"token operator\">*</span> loadFactor<span class=\"token punctuation\">,</span> threshold<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"328\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"329\"></td><td><pre></pre></td></tr><tr><td data-num=\"330\"></td><td><pre>        <span class=\"token comment\">// 判断是否需要扩容</span></pre></td></tr><tr><td data-num=\"331\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>numKeysToBeAdded <span class=\"token operator\">></span> threshold<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"332\"></td><td><pre>            <span class=\"token keyword\">int</span> targetCapacity <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>numKeysToBeAdded <span class=\"token operator\">/</span> loadFactor <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"333\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>targetCapacity <span class=\"token operator\">></span> MAXIMUM_CAPACITY<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"334\"></td><td><pre>                targetCapacity <span class=\"token operator\">=</span> MAXIMUM_CAPACITY<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"335\"></td><td><pre>            <span class=\"token keyword\">int</span> newCapacity <span class=\"token operator\">=</span> table<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"336\"></td><td><pre>            <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>newCapacity <span class=\"token operator\">&lt;</span> targetCapacity<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"337\"></td><td><pre>                newCapacity <span class=\"token operator\">&lt;&lt;=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"338\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>newCapacity <span class=\"token operator\">></span> table<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"339\"></td><td><pre>                <span class=\"token function\">resize</span><span class=\"token punctuation\">(</span>newCapacity<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"340\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"341\"></td><td><pre>        <span class=\"token comment\">// 执行添加操作</span></pre></td></tr><tr><td data-num=\"342\"></td><td><pre>        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Map<span class=\"token punctuation\">.</span>Entry</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token operator\">?</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">K</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">?</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">V</span><span class=\"token punctuation\">></span></span> e <span class=\"token operator\">:</span> m<span class=\"token punctuation\">.</span><span class=\"token function\">entrySet</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"343\"></td><td><pre>            <span class=\"token function\">put</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">.</span><span class=\"token function\">getKey</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> e<span class=\"token punctuation\">.</span><span class=\"token function\">getValue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"344\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"345\"></td><td><pre></pre></td></tr><tr><td data-num=\"346\"></td><td><pre>    <span class=\"token comment\">// 删除 key , 并返回 key 对应的 value 值</span></pre></td></tr><tr><td data-num=\"347\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token class-name\">V</span> <span class=\"token function\">remove</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Object</span> key<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"348\"></td><td><pre>        <span class=\"token class-name\">Entry</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">K</span><span class=\"token punctuation\">,</span><span class=\"token class-name\">V</span><span class=\"token punctuation\">></span></span> e <span class=\"token operator\">=</span> <span class=\"token function\">removeEntryForKey</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"349\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>e <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">?</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">:</span> e<span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"350\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"351\"></td><td><pre></pre></td></tr><tr><td data-num=\"352\"></td><td><pre>    <span class=\"token comment\">// 返回 key 对应的实体</span></pre></td></tr><tr><td data-num=\"353\"></td><td><pre>    <span class=\"token keyword\">final</span> <span class=\"token class-name\">Entry</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">K</span><span class=\"token punctuation\">,</span><span class=\"token class-name\">V</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">removeEntryForKey</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Object</span> key<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"354\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>size <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"355\"></td><td><pre>            <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"356\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"357\"></td><td><pre>        <span class=\"token keyword\">int</span> hash <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>key <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">?</span> <span class=\"token number\">0</span> <span class=\"token operator\">:</span> <span class=\"token function\">hash</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 计算 key 的 hash 值</span></pre></td></tr><tr><td data-num=\"358\"></td><td><pre>        <span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> <span class=\"token function\">indexFor</span><span class=\"token punctuation\">(</span>hash<span class=\"token punctuation\">,</span> table<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">// 计算存储位置</span></pre></td></tr><tr><td data-num=\"359\"></td><td><pre>        <span class=\"token class-name\">Entry</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">K</span><span class=\"token punctuation\">,</span><span class=\"token class-name\">V</span><span class=\"token punctuation\">></span></span> prev <span class=\"token operator\">=</span> table<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"360\"></td><td><pre>        <span class=\"token class-name\">Entry</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">K</span><span class=\"token punctuation\">,</span><span class=\"token class-name\">V</span><span class=\"token punctuation\">></span></span> e <span class=\"token operator\">=</span> prev<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"361\"></td><td><pre></pre></td></tr><tr><td data-num=\"362\"></td><td><pre>        <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>e <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"363\"></td><td><pre>            <span class=\"token class-name\">Entry</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">K</span><span class=\"token punctuation\">,</span><span class=\"token class-name\">V</span><span class=\"token punctuation\">></span></span> next <span class=\"token operator\">=</span> e<span class=\"token punctuation\">.</span>next<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"364\"></td><td><pre>            <span class=\"token class-name\">Object</span> k<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"365\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">.</span>hash <span class=\"token operator\">==</span> hash <span class=\"token operator\">&amp;&amp;</span></pre></td></tr><tr><td data-num=\"366\"></td><td><pre>                <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>k <span class=\"token operator\">=</span> e<span class=\"token punctuation\">.</span>key<span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> key <span class=\"token operator\">||</span> <span class=\"token punctuation\">(</span>key <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">&amp;&amp;</span> key<span class=\"token punctuation\">.</span><span class=\"token function\">equals</span><span class=\"token punctuation\">(</span>k<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"367\"></td><td><pre>                modCount<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"368\"></td><td><pre>                size<span class=\"token operator\">--</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"369\"></td><td><pre>                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>prev <span class=\"token operator\">==</span> e<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"370\"></td><td><pre>                    table<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> next<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"371\"></td><td><pre>                <span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"372\"></td><td><pre>                    prev<span class=\"token punctuation\">.</span>next <span class=\"token operator\">=</span> next<span class=\"token punctuation\">;</span> <span class=\"token comment\">// 链表删除</span></pre></td></tr><tr><td data-num=\"373\"></td><td><pre>                e<span class=\"token punctuation\">.</span><span class=\"token function\">recordRemoval</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"374\"></td><td><pre>                <span class=\"token keyword\">return</span> e<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"375\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"376\"></td><td><pre>            prev <span class=\"token operator\">=</span> e<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"377\"></td><td><pre>            e <span class=\"token operator\">=</span> next<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"378\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"379\"></td><td><pre></pre></td></tr><tr><td data-num=\"380\"></td><td><pre>        <span class=\"token keyword\">return</span> e<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"381\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"382\"></td><td><pre></pre></td></tr><tr><td data-num=\"383\"></td><td><pre>    <span class=\"token comment\">// 删除一个指定的实体</span></pre></td></tr><tr><td data-num=\"384\"></td><td><pre>    <span class=\"token keyword\">final</span> <span class=\"token class-name\">Entry</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">K</span><span class=\"token punctuation\">,</span><span class=\"token class-name\">V</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">removeMapping</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Object</span> o<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"385\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>size <span class=\"token operator\">==</span> <span class=\"token number\">0</span> <span class=\"token operator\">||</span> <span class=\"token operator\">!</span><span class=\"token punctuation\">(</span>o <span class=\"token keyword\">instanceof</span> <span class=\"token class-name\">Map<span class=\"token punctuation\">.</span>Entry</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"386\"></td><td><pre>            <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"387\"></td><td><pre></pre></td></tr><tr><td data-num=\"388\"></td><td><pre>        <span class=\"token class-name\">Map<span class=\"token punctuation\">.</span>Entry</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">K</span><span class=\"token punctuation\">,</span><span class=\"token class-name\">V</span><span class=\"token punctuation\">></span></span> entry <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Map<span class=\"token punctuation\">.</span>Entry</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">K</span><span class=\"token punctuation\">,</span><span class=\"token class-name\">V</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">)</span> o<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"389\"></td><td><pre>        <span class=\"token class-name\">Object</span> key <span class=\"token operator\">=</span> entry<span class=\"token punctuation\">.</span><span class=\"token function\">getKey</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"390\"></td><td><pre>        <span class=\"token keyword\">int</span> hash <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>key <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">?</span> <span class=\"token number\">0</span> <span class=\"token operator\">:</span> <span class=\"token function\">hash</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"391\"></td><td><pre>        <span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> <span class=\"token function\">indexFor</span><span class=\"token punctuation\">(</span>hash<span class=\"token punctuation\">,</span> table<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"392\"></td><td><pre>        <span class=\"token class-name\">Entry</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">K</span><span class=\"token punctuation\">,</span><span class=\"token class-name\">V</span><span class=\"token punctuation\">></span></span> prev <span class=\"token operator\">=</span> table<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"393\"></td><td><pre>        <span class=\"token class-name\">Entry</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">K</span><span class=\"token punctuation\">,</span><span class=\"token class-name\">V</span><span class=\"token punctuation\">></span></span> e <span class=\"token operator\">=</span> prev<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"394\"></td><td><pre></pre></td></tr><tr><td data-num=\"395\"></td><td><pre>        <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>e <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"396\"></td><td><pre>            <span class=\"token class-name\">Entry</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">K</span><span class=\"token punctuation\">,</span><span class=\"token class-name\">V</span><span class=\"token punctuation\">></span></span> next <span class=\"token operator\">=</span> e<span class=\"token punctuation\">.</span>next<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"397\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">.</span>hash <span class=\"token operator\">==</span> hash <span class=\"token operator\">&amp;&amp;</span> e<span class=\"token punctuation\">.</span><span class=\"token function\">equals</span><span class=\"token punctuation\">(</span>entry<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"398\"></td><td><pre>                modCount<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"399\"></td><td><pre>                size<span class=\"token operator\">--</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"400\"></td><td><pre>                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>prev <span class=\"token operator\">==</span> e<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"401\"></td><td><pre>                    table<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> next<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"402\"></td><td><pre>                <span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"403\"></td><td><pre>                    prev<span class=\"token punctuation\">.</span>next <span class=\"token operator\">=</span> next<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"404\"></td><td><pre>                e<span class=\"token punctuation\">.</span><span class=\"token function\">recordRemoval</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"405\"></td><td><pre>                <span class=\"token keyword\">return</span> e<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"406\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"407\"></td><td><pre>            prev <span class=\"token operator\">=</span> e<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"408\"></td><td><pre>            e <span class=\"token operator\">=</span> next<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"409\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"410\"></td><td><pre></pre></td></tr><tr><td data-num=\"411\"></td><td><pre>        <span class=\"token keyword\">return</span> e<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"412\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"413\"></td><td><pre></pre></td></tr><tr><td data-num=\"414\"></td><td><pre>    <span class=\"token comment\">// 删除 map</span></pre></td></tr><tr><td data-num=\"415\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">clear</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"416\"></td><td><pre>        modCount<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"417\"></td><td><pre>        <span class=\"token class-name\">Arrays</span><span class=\"token punctuation\">.</span><span class=\"token function\">fill</span><span class=\"token punctuation\">(</span>table<span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"418\"></td><td><pre>        size <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"419\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"420\"></td><td><pre></pre></td></tr><tr><td data-num=\"421\"></td><td><pre>    <span class=\"token comment\">// 判断是否包含指定 value 的实体</span></pre></td></tr><tr><td data-num=\"422\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">boolean</span> <span class=\"token function\">containsValue</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Object</span> value<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"423\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>value <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"424\"></td><td><pre>            <span class=\"token keyword\">return</span> <span class=\"token function\">containsNullValue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"425\"></td><td><pre></pre></td></tr><tr><td data-num=\"426\"></td><td><pre>        <span class=\"token class-name\">Entry</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> tab <span class=\"token operator\">=</span> table<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"427\"></td><td><pre>        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> tab<span class=\"token punctuation\">.</span>length <span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"428\"></td><td><pre>            <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Entry</span> e <span class=\"token operator\">=</span> tab<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">;</span> e <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span> <span class=\"token punctuation\">;</span> e <span class=\"token operator\">=</span> e<span class=\"token punctuation\">.</span>next<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"429\"></td><td><pre>                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">.</span><span class=\"token function\">equals</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"430\"></td><td><pre>                    <span class=\"token keyword\">return</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"431\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"432\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"433\"></td><td><pre></pre></td></tr><tr><td data-num=\"434\"></td><td><pre>    <span class=\"token comment\">// 是否包含 value== null </span></pre></td></tr><tr><td data-num=\"435\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token keyword\">boolean</span> <span class=\"token function\">containsNullValue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"436\"></td><td><pre>        <span class=\"token class-name\">Entry</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> tab <span class=\"token operator\">=</span> table<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"437\"></td><td><pre>        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> tab<span class=\"token punctuation\">.</span>length <span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"438\"></td><td><pre>            <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Entry</span> e <span class=\"token operator\">=</span> tab<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">;</span> e <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span> <span class=\"token punctuation\">;</span> e <span class=\"token operator\">=</span> e<span class=\"token punctuation\">.</span>next<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"439\"></td><td><pre>                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">.</span>value <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"440\"></td><td><pre>                    <span class=\"token keyword\">return</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"441\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"442\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"443\"></td><td><pre></pre></td></tr><tr><td data-num=\"444\"></td><td><pre>    <span class=\"token comment\">// 重写克隆方法</span></pre></td></tr><tr><td data-num=\"445\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token class-name\">Object</span> <span class=\"token function\">clone</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"446\"></td><td><pre>        <span class=\"token class-name\">HashMap</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">K</span><span class=\"token punctuation\">,</span><span class=\"token class-name\">V</span><span class=\"token punctuation\">></span></span> result <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"447\"></td><td><pre>        <span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"448\"></td><td><pre>            result <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">HashMap</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">K</span><span class=\"token punctuation\">,</span><span class=\"token class-name\">V</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">)</span><span class=\"token keyword\">super</span><span class=\"token punctuation\">.</span><span class=\"token function\">clone</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"449\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">CloneNotSupportedException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"450\"></td><td><pre>            <span class=\"token comment\">// assert false;</span></pre></td></tr><tr><td data-num=\"451\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"452\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">.</span>table <span class=\"token operator\">!=</span> EMPTY_TABLE<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"453\"></td><td><pre>            result<span class=\"token punctuation\">.</span><span class=\"token function\">inflateTable</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Math</span><span class=\"token punctuation\">.</span><span class=\"token function\">min</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"454\"></td><td><pre>                <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">)</span> <span class=\"token class-name\">Math</span><span class=\"token punctuation\">.</span><span class=\"token function\">min</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"455\"></td><td><pre>                    size <span class=\"token operator\">*</span> <span class=\"token class-name\">Math</span><span class=\"token punctuation\">.</span><span class=\"token function\">min</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span> <span class=\"token operator\">/</span> loadFactor<span class=\"token punctuation\">,</span> <span class=\"token number\">4.0f</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"456\"></td><td><pre>                    <span class=\"token comment\">// we have limits...</span></pre></td></tr><tr><td data-num=\"457\"></td><td><pre>                    <span class=\"token class-name\">HashMap</span><span class=\"token punctuation\">.</span>MAXIMUM_CAPACITY<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"458\"></td><td><pre>               table<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"459\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"460\"></td><td><pre>        result<span class=\"token punctuation\">.</span>entrySet <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"461\"></td><td><pre>        result<span class=\"token punctuation\">.</span>modCount <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"462\"></td><td><pre>        result<span class=\"token punctuation\">.</span>size <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"463\"></td><td><pre>        result<span class=\"token punctuation\">.</span><span class=\"token function\">init</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"464\"></td><td><pre>        result<span class=\"token punctuation\">.</span><span class=\"token function\">putAllForCreate</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"465\"></td><td><pre></pre></td></tr><tr><td data-num=\"466\"></td><td><pre>        <span class=\"token keyword\">return</span> result<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"467\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"468\"></td><td><pre>    <span class=\"token comment\">// 静态内部类 ，Entry 用来存储键值对，HashMap 中的 Entry [] 用来存储 entry</span></pre></td></tr><tr><td data-num=\"469\"></td><td><pre>    <span class=\"token keyword\">static</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Entry</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">K</span><span class=\"token punctuation\">,</span><span class=\"token class-name\">V</span><span class=\"token punctuation\">></span></span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">Map<span class=\"token punctuation\">.</span>Entry</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">K</span><span class=\"token punctuation\">,</span><span class=\"token class-name\">V</span><span class=\"token punctuation\">></span></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"470\"></td><td><pre>        <span class=\"token keyword\">final</span> <span class=\"token class-name\">K</span> key<span class=\"token punctuation\">;</span>   <span class=\"token comment\">// 键</span></pre></td></tr><tr><td data-num=\"471\"></td><td><pre>        <span class=\"token class-name\">V</span> value<span class=\"token punctuation\">;</span>        <span class=\"token comment\">// 值</span></pre></td></tr><tr><td data-num=\"472\"></td><td><pre>        <span class=\"token class-name\">Entry</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">K</span><span class=\"token punctuation\">,</span><span class=\"token class-name\">V</span><span class=\"token punctuation\">></span></span> next<span class=\"token punctuation\">;</span>  <span class=\"token comment\">// 采用链表存储 HashCode 相同的键值对，next 指向下一个 entry</span></pre></td></tr><tr><td data-num=\"473\"></td><td><pre>        <span class=\"token keyword\">int</span> hash<span class=\"token punctuation\">;</span>   <span class=\"token comment\">//entry 的 hash 值</span></pre></td></tr><tr><td data-num=\"474\"></td><td><pre></pre></td></tr><tr><td data-num=\"475\"></td><td><pre>        <span class=\"token comment\">// 构造方法， 负责初始化 entry</span></pre></td></tr><tr><td data-num=\"476\"></td><td><pre>        <span class=\"token class-name\">Entry</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> h<span class=\"token punctuation\">,</span> <span class=\"token class-name\">K</span> k<span class=\"token punctuation\">,</span> <span class=\"token class-name\">V</span> v<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Entry</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">K</span><span class=\"token punctuation\">,</span><span class=\"token class-name\">V</span><span class=\"token punctuation\">></span></span> n<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"477\"></td><td><pre>            value <span class=\"token operator\">=</span> v<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"478\"></td><td><pre>            next <span class=\"token operator\">=</span> n<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"479\"></td><td><pre>            key <span class=\"token operator\">=</span> k<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"480\"></td><td><pre>            hash <span class=\"token operator\">=</span> h<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"481\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"482\"></td><td><pre></pre></td></tr><tr><td data-num=\"483\"></td><td><pre>        <span class=\"token keyword\">public</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">K</span> <span class=\"token function\">getKey</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"484\"></td><td><pre>            <span class=\"token keyword\">return</span> key<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"485\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"486\"></td><td><pre></pre></td></tr><tr><td data-num=\"487\"></td><td><pre>        <span class=\"token keyword\">public</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">V</span> <span class=\"token function\">getValue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"488\"></td><td><pre>            <span class=\"token keyword\">return</span> value<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"489\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"490\"></td><td><pre></pre></td></tr><tr><td data-num=\"491\"></td><td><pre>        <span class=\"token keyword\">public</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">V</span> <span class=\"token function\">setValue</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">V</span> newValue<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"492\"></td><td><pre>            <span class=\"token class-name\">V</span> oldValue <span class=\"token operator\">=</span> value<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"493\"></td><td><pre>            value <span class=\"token operator\">=</span> newValue<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"494\"></td><td><pre>            <span class=\"token keyword\">return</span> oldValue<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"495\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"496\"></td><td><pre></pre></td></tr><tr><td data-num=\"497\"></td><td><pre>        <span class=\"token keyword\">public</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">boolean</span> <span class=\"token function\">equals</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Object</span> o<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"498\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token punctuation\">(</span>o <span class=\"token keyword\">instanceof</span> <span class=\"token class-name\">Map<span class=\"token punctuation\">.</span>Entry</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"499\"></td><td><pre>                <span class=\"token keyword\">return</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"500\"></td><td><pre>            <span class=\"token class-name\">Map<span class=\"token punctuation\">.</span>Entry</span> e <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Map<span class=\"token punctuation\">.</span>Entry</span><span class=\"token punctuation\">)</span>o<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"501\"></td><td><pre>            <span class=\"token class-name\">Object</span> k1 <span class=\"token operator\">=</span> <span class=\"token function\">getKey</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"502\"></td><td><pre>            <span class=\"token class-name\">Object</span> k2 <span class=\"token operator\">=</span> e<span class=\"token punctuation\">.</span><span class=\"token function\">getKey</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"503\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>k1 <span class=\"token operator\">==</span> k2 <span class=\"token operator\">||</span> <span class=\"token punctuation\">(</span>k1 <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">&amp;&amp;</span> k1<span class=\"token punctuation\">.</span><span class=\"token function\">equals</span><span class=\"token punctuation\">(</span>k2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"504\"></td><td><pre>                <span class=\"token class-name\">Object</span> v1 <span class=\"token operator\">=</span> <span class=\"token function\">getValue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"505\"></td><td><pre>                <span class=\"token class-name\">Object</span> v2 <span class=\"token operator\">=</span> e<span class=\"token punctuation\">.</span><span class=\"token function\">getValue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"506\"></td><td><pre>                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>v1 <span class=\"token operator\">==</span> v2 <span class=\"token operator\">||</span> <span class=\"token punctuation\">(</span>v1 <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">&amp;&amp;</span> v1<span class=\"token punctuation\">.</span><span class=\"token function\">equals</span><span class=\"token punctuation\">(</span>v2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"507\"></td><td><pre>                    <span class=\"token keyword\">return</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"508\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"509\"></td><td><pre>            <span class=\"token keyword\">return</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"510\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"511\"></td><td><pre></pre></td></tr><tr><td data-num=\"512\"></td><td><pre>        <span class=\"token keyword\">public</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">int</span> <span class=\"token function\">hashCode</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"513\"></td><td><pre>            <span class=\"token keyword\">return</span> <span class=\"token class-name\">Objects</span><span class=\"token punctuation\">.</span><span class=\"token function\">hashCode</span><span class=\"token punctuation\">(</span><span class=\"token function\">getKey</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">^</span> <span class=\"token class-name\">Objects</span><span class=\"token punctuation\">.</span><span class=\"token function\">hashCode</span><span class=\"token punctuation\">(</span><span class=\"token function\">getValue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"514\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"515\"></td><td><pre></pre></td></tr><tr><td data-num=\"516\"></td><td><pre>        <span class=\"token keyword\">public</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">String</span> <span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"517\"></td><td><pre>            <span class=\"token keyword\">return</span> <span class=\"token function\">getKey</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">\"=\"</span> <span class=\"token operator\">+</span> <span class=\"token function\">getValue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"518\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"519\"></td><td><pre></pre></td></tr><tr><td data-num=\"520\"></td><td><pre>        <span class=\"token comment\">// 当使用相同的 key 的 value 被覆盖时调用</span></pre></td></tr><tr><td data-num=\"521\"></td><td><pre>        <span class=\"token keyword\">void</span> <span class=\"token function\">recordAccess</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">HashMap</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">K</span><span class=\"token punctuation\">,</span><span class=\"token class-name\">V</span><span class=\"token punctuation\">></span></span> m<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"522\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"523\"></td><td><pre></pre></td></tr><tr><td data-num=\"524\"></td><td><pre>        <span class=\"token comment\">// 每移除一个 entry 就被调用一次</span></pre></td></tr><tr><td data-num=\"525\"></td><td><pre>        <span class=\"token keyword\">void</span> <span class=\"token function\">recordRemoval</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">HashMap</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">K</span><span class=\"token punctuation\">,</span><span class=\"token class-name\">V</span><span class=\"token punctuation\">></span></span> m<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"526\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"527\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"528\"></td><td><pre></pre></td></tr><tr><td data-num=\"529\"></td><td><pre>    <span class=\"token comment\">// 添加实体</span></pre></td></tr><tr><td data-num=\"530\"></td><td><pre>    <span class=\"token keyword\">void</span> <span class=\"token function\">addEntry</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> hash<span class=\"token punctuation\">,</span> <span class=\"token class-name\">K</span> key<span class=\"token punctuation\">,</span> <span class=\"token class-name\">V</span> value<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> bucketIndex<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"531\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>size <span class=\"token operator\">>=</span> threshold<span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span> <span class=\"token operator\">!=</span> table<span class=\"token punctuation\">[</span>bucketIndex<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"532\"></td><td><pre>            <span class=\"token function\">resize</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span> <span class=\"token operator\">*</span> table<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"533\"></td><td><pre>            hash <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span> <span class=\"token operator\">!=</span> key<span class=\"token punctuation\">)</span> <span class=\"token operator\">?</span> <span class=\"token function\">hash</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">)</span> <span class=\"token operator\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"534\"></td><td><pre>            bucketIndex <span class=\"token operator\">=</span> <span class=\"token function\">indexFor</span><span class=\"token punctuation\">(</span>hash<span class=\"token punctuation\">,</span> table<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"535\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"536\"></td><td><pre></pre></td></tr><tr><td data-num=\"537\"></td><td><pre>        <span class=\"token function\">createEntry</span><span class=\"token punctuation\">(</span>hash<span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">,</span> value<span class=\"token punctuation\">,</span> bucketIndex<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"538\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"539\"></td><td><pre></pre></td></tr><tr><td data-num=\"540\"></td><td><pre>    <span class=\"token comment\">// 创建实体</span></pre></td></tr><tr><td data-num=\"541\"></td><td><pre>    <span class=\"token keyword\">void</span> <span class=\"token function\">createEntry</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> hash<span class=\"token punctuation\">,</span> <span class=\"token class-name\">K</span> key<span class=\"token punctuation\">,</span> <span class=\"token class-name\">V</span> value<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> bucketIndex<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"542\"></td><td><pre>        <span class=\"token class-name\">Entry</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">K</span><span class=\"token punctuation\">,</span><span class=\"token class-name\">V</span><span class=\"token punctuation\">></span></span> e <span class=\"token operator\">=</span> table<span class=\"token punctuation\">[</span>bucketIndex<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"543\"></td><td><pre>        table<span class=\"token punctuation\">[</span>bucketIndex<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Entry</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span>hash<span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">,</span> value<span class=\"token punctuation\">,</span> e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"544\"></td><td><pre>        size<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"545\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"546\"></td><td><pre>    <span class=\"token comment\">// 内部类实现 Iterator 接口，进行遍历操作</span></pre></td></tr><tr><td data-num=\"547\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token keyword\">abstract</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">HashIterator</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">E</span><span class=\"token punctuation\">></span></span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">Iterator</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">E</span><span class=\"token punctuation\">></span></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"548\"></td><td><pre>        <span class=\"token class-name\">Entry</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">K</span><span class=\"token punctuation\">,</span><span class=\"token class-name\">V</span><span class=\"token punctuation\">></span></span> next<span class=\"token punctuation\">;</span>        <span class=\"token comment\">// next entry to return</span></pre></td></tr><tr><td data-num=\"549\"></td><td><pre>        <span class=\"token keyword\">int</span> expectedModCount<span class=\"token punctuation\">;</span>   <span class=\"token comment\">// For fast-fail</span></pre></td></tr><tr><td data-num=\"550\"></td><td><pre>        <span class=\"token keyword\">int</span> index<span class=\"token punctuation\">;</span>              <span class=\"token comment\">// current slot</span></pre></td></tr><tr><td data-num=\"551\"></td><td><pre>        <span class=\"token class-name\">Entry</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">K</span><span class=\"token punctuation\">,</span><span class=\"token class-name\">V</span><span class=\"token punctuation\">></span></span> current<span class=\"token punctuation\">;</span>     <span class=\"token comment\">// current entry</span></pre></td></tr><tr><td data-num=\"552\"></td><td><pre></pre></td></tr><tr><td data-num=\"553\"></td><td><pre>        <span class=\"token class-name\">HashIterator</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"554\"></td><td><pre>            expectedModCount <span class=\"token operator\">=</span> modCount<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"555\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>size <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token comment\">// advance to first entry</span></pre></td></tr><tr><td data-num=\"556\"></td><td><pre>                <span class=\"token class-name\">Entry</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> t <span class=\"token operator\">=</span> table<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"557\"></td><td><pre>                <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>index <span class=\"token operator\">&lt;</span> t<span class=\"token punctuation\">.</span>length <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">(</span>next <span class=\"token operator\">=</span> t<span class=\"token punctuation\">[</span>index<span class=\"token operator\">++</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"558\"></td><td><pre>                    <span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"559\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"560\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"561\"></td><td><pre>        <span class=\"token comment\">// 是否有下一个元素</span></pre></td></tr><tr><td data-num=\"562\"></td><td><pre>        <span class=\"token keyword\">public</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">boolean</span> <span class=\"token function\">hasNext</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"563\"></td><td><pre>            <span class=\"token keyword\">return</span> next <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"564\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"565\"></td><td><pre>        <span class=\"token comment\">// 返回下一个元素</span></pre></td></tr><tr><td data-num=\"566\"></td><td><pre>        <span class=\"token keyword\">final</span> <span class=\"token class-name\">Entry</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">K</span><span class=\"token punctuation\">,</span><span class=\"token class-name\">V</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">nextEntry</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"567\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>modCount <span class=\"token operator\">!=</span> expectedModCount<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"568\"></td><td><pre>                <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ConcurrentModificationException</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"569\"></td><td><pre>            <span class=\"token class-name\">Entry</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">K</span><span class=\"token punctuation\">,</span><span class=\"token class-name\">V</span><span class=\"token punctuation\">></span></span> e <span class=\"token operator\">=</span> next<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"570\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>e <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"571\"></td><td><pre>                <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">NoSuchElementException</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"572\"></td><td><pre></pre></td></tr><tr><td data-num=\"573\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>next <span class=\"token operator\">=</span> e<span class=\"token punctuation\">.</span>next<span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"574\"></td><td><pre>                <span class=\"token class-name\">Entry</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> t <span class=\"token operator\">=</span> table<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"575\"></td><td><pre>                <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>index <span class=\"token operator\">&lt;</span> t<span class=\"token punctuation\">.</span>length <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">(</span>next <span class=\"token operator\">=</span> t<span class=\"token punctuation\">[</span>index<span class=\"token operator\">++</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"576\"></td><td><pre>                    <span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"577\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"578\"></td><td><pre>            current <span class=\"token operator\">=</span> e<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"579\"></td><td><pre>            <span class=\"token keyword\">return</span> e<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"580\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"581\"></td><td><pre>        <span class=\"token comment\">// 删除</span></pre></td></tr><tr><td data-num=\"582\"></td><td><pre>        <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">remove</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"583\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>current <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"584\"></td><td><pre>                <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">IllegalStateException</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"585\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>modCount <span class=\"token operator\">!=</span> expectedModCount<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"586\"></td><td><pre>                <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ConcurrentModificationException</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"587\"></td><td><pre>            <span class=\"token class-name\">Object</span> k <span class=\"token operator\">=</span> current<span class=\"token punctuation\">.</span>key<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"588\"></td><td><pre>            current <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"589\"></td><td><pre>            <span class=\"token class-name\">HashMap</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">removeEntryForKey</span><span class=\"token punctuation\">(</span>k<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"590\"></td><td><pre>            expectedModCount <span class=\"token operator\">=</span> modCount<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"591\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"592\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"593\"></td><td><pre></pre></td></tr><tr><td data-num=\"594\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">ValueIterator</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">HashIterator</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">V</span><span class=\"token punctuation\">></span></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"595\"></td><td><pre>        <span class=\"token keyword\">public</span> <span class=\"token class-name\">V</span> <span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"596\"></td><td><pre>            <span class=\"token keyword\">return</span> <span class=\"token function\">nextEntry</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"597\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"598\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"599\"></td><td><pre></pre></td></tr><tr><td data-num=\"600\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">KeyIterator</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">HashIterator</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">K</span><span class=\"token punctuation\">></span></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"601\"></td><td><pre>        <span class=\"token keyword\">public</span> <span class=\"token class-name\">K</span> <span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"602\"></td><td><pre>            <span class=\"token keyword\">return</span> <span class=\"token function\">nextEntry</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getKey</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"603\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"604\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"605\"></td><td><pre></pre></td></tr><tr><td data-num=\"606\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">EntryIterator</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">HashIterator</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Map<span class=\"token punctuation\">.</span>Entry</span><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">K</span><span class=\"token punctuation\">,</span><span class=\"token class-name\">V</span><span class=\"token punctuation\">></span><span class=\"token punctuation\">></span></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"607\"></td><td><pre>        <span class=\"token keyword\">public</span> <span class=\"token class-name\">Map<span class=\"token punctuation\">.</span>Entry</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">K</span><span class=\"token punctuation\">,</span><span class=\"token class-name\">V</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"608\"></td><td><pre>            <span class=\"token keyword\">return</span> <span class=\"token function\">nextEntry</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"609\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"610\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"611\"></td><td><pre></pre></td></tr><tr><td data-num=\"612\"></td><td><pre>    <span class=\"token comment\">// Subclass overrides these to alter behavior of views' iterator() method</span></pre></td></tr><tr><td data-num=\"613\"></td><td><pre>    <span class=\"token class-name\">Iterator</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">K</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">newKeyIterator</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>   <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"614\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">KeyIterator</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"615\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"616\"></td><td><pre>    <span class=\"token class-name\">Iterator</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">V</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">newValueIterator</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>   <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"617\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ValueIterator</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"618\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"619\"></td><td><pre>    <span class=\"token class-name\">Iterator</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Map<span class=\"token punctuation\">.</span>Entry</span><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">K</span><span class=\"token punctuation\">,</span><span class=\"token class-name\">V</span><span class=\"token punctuation\">></span><span class=\"token punctuation\">></span></span> <span class=\"token function\">newEntryIterator</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>   <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"620\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">EntryIterator</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"621\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"622\"></td><td><pre></pre></td></tr><tr><td data-num=\"623\"></td><td><pre></pre></td></tr><tr><td data-num=\"624\"></td><td><pre>    <span class=\"token comment\">// Views</span></pre></td></tr><tr><td data-num=\"625\"></td><td><pre></pre></td></tr><tr><td data-num=\"626\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token keyword\">transient</span> <span class=\"token class-name\">Set</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Map<span class=\"token punctuation\">.</span>Entry</span><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">K</span><span class=\"token punctuation\">,</span><span class=\"token class-name\">V</span><span class=\"token punctuation\">></span><span class=\"token punctuation\">></span></span> entrySet <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"627\"></td><td><pre></pre></td></tr><tr><td data-num=\"628\"></td><td><pre>    <span class=\"token comment\">// 返回 key 组成的 Set 集合</span></pre></td></tr><tr><td data-num=\"629\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token class-name\">Set</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">K</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">keySet</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"630\"></td><td><pre>        <span class=\"token class-name\">Set</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">K</span><span class=\"token punctuation\">></span></span> ks <span class=\"token operator\">=</span> keySet<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"631\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>ks <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">?</span> ks <span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span>keySet <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">KeySet</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"632\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"633\"></td><td><pre></pre></td></tr><tr><td data-num=\"634\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">KeySet</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">AbstractSet</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">K</span><span class=\"token punctuation\">></span></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"635\"></td><td><pre>        <span class=\"token keyword\">public</span> <span class=\"token class-name\">Iterator</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">K</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">iterator</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"636\"></td><td><pre>            <span class=\"token keyword\">return</span> <span class=\"token function\">newKeyIterator</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"637\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"638\"></td><td><pre>        <span class=\"token keyword\">public</span> <span class=\"token keyword\">int</span> <span class=\"token function\">size</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"639\"></td><td><pre>            <span class=\"token keyword\">return</span> size<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"640\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"641\"></td><td><pre>        <span class=\"token keyword\">public</span> <span class=\"token keyword\">boolean</span> <span class=\"token function\">contains</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Object</span> o<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"642\"></td><td><pre>            <span class=\"token keyword\">return</span> <span class=\"token function\">containsKey</span><span class=\"token punctuation\">(</span>o<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"643\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"644\"></td><td><pre>        <span class=\"token keyword\">public</span> <span class=\"token keyword\">boolean</span> <span class=\"token function\">remove</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Object</span> o<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"645\"></td><td><pre>            <span class=\"token keyword\">return</span> <span class=\"token class-name\">HashMap</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">removeEntryForKey</span><span class=\"token punctuation\">(</span>o<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"646\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"647\"></td><td><pre>        <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">clear</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"648\"></td><td><pre>            <span class=\"token class-name\">HashMap</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">clear</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"649\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"650\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"651\"></td><td><pre></pre></td></tr><tr><td data-num=\"652\"></td><td><pre>    <span class=\"token comment\">// 返回 Value 组成的集合</span></pre></td></tr><tr><td data-num=\"653\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token class-name\">Collection</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">V</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">values</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"654\"></td><td><pre>        <span class=\"token class-name\">Collection</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">V</span><span class=\"token punctuation\">></span></span> vs <span class=\"token operator\">=</span> values<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"655\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>vs <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">?</span> vs <span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span>values <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Values</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"656\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"657\"></td><td><pre></pre></td></tr><tr><td data-num=\"658\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Values</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">AbstractCollection</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">V</span><span class=\"token punctuation\">></span></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"659\"></td><td><pre>        <span class=\"token keyword\">public</span> <span class=\"token class-name\">Iterator</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">V</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">iterator</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"660\"></td><td><pre>            <span class=\"token keyword\">return</span> <span class=\"token function\">newValueIterator</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"661\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"662\"></td><td><pre>        <span class=\"token keyword\">public</span> <span class=\"token keyword\">int</span> <span class=\"token function\">size</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"663\"></td><td><pre>            <span class=\"token keyword\">return</span> size<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"664\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"665\"></td><td><pre>        <span class=\"token keyword\">public</span> <span class=\"token keyword\">boolean</span> <span class=\"token function\">contains</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Object</span> o<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"666\"></td><td><pre>            <span class=\"token keyword\">return</span> <span class=\"token function\">containsValue</span><span class=\"token punctuation\">(</span>o<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"667\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"668\"></td><td><pre>        <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">clear</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"669\"></td><td><pre>            <span class=\"token class-name\">HashMap</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">clear</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"670\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"671\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"672\"></td><td><pre></pre></td></tr><tr><td data-num=\"673\"></td><td><pre>    </pre></td></tr><tr><td data-num=\"674\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token class-name\">Set</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Map<span class=\"token punctuation\">.</span>Entry</span><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">K</span><span class=\"token punctuation\">,</span><span class=\"token class-name\">V</span><span class=\"token punctuation\">></span><span class=\"token punctuation\">></span></span> <span class=\"token function\">entrySet</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"675\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token function\">entrySet0</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"676\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"677\"></td><td><pre></pre></td></tr><tr><td data-num=\"678\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Set</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Map<span class=\"token punctuation\">.</span>Entry</span><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">K</span><span class=\"token punctuation\">,</span><span class=\"token class-name\">V</span><span class=\"token punctuation\">></span><span class=\"token punctuation\">></span></span> <span class=\"token function\">entrySet0</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"679\"></td><td><pre>        <span class=\"token class-name\">Set</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Map<span class=\"token punctuation\">.</span>Entry</span><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">K</span><span class=\"token punctuation\">,</span><span class=\"token class-name\">V</span><span class=\"token punctuation\">></span><span class=\"token punctuation\">></span></span> es <span class=\"token operator\">=</span> entrySet<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"680\"></td><td><pre>        <span class=\"token keyword\">return</span> es <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">?</span> es <span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span>entrySet <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">EntrySet</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"681\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"682\"></td><td><pre></pre></td></tr><tr><td data-num=\"683\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">EntrySet</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">AbstractSet</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Map<span class=\"token punctuation\">.</span>Entry</span><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">K</span><span class=\"token punctuation\">,</span><span class=\"token class-name\">V</span><span class=\"token punctuation\">></span><span class=\"token punctuation\">></span></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"684\"></td><td><pre>        <span class=\"token keyword\">public</span> <span class=\"token class-name\">Iterator</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Map<span class=\"token punctuation\">.</span>Entry</span><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">K</span><span class=\"token punctuation\">,</span><span class=\"token class-name\">V</span><span class=\"token punctuation\">></span><span class=\"token punctuation\">></span></span> <span class=\"token function\">iterator</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"685\"></td><td><pre>            <span class=\"token keyword\">return</span> <span class=\"token function\">newEntryIterator</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"686\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"687\"></td><td><pre>        <span class=\"token keyword\">public</span> <span class=\"token keyword\">boolean</span> <span class=\"token function\">contains</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Object</span> o<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"688\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token punctuation\">(</span>o <span class=\"token keyword\">instanceof</span> <span class=\"token class-name\">Map<span class=\"token punctuation\">.</span>Entry</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"689\"></td><td><pre>                <span class=\"token keyword\">return</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"690\"></td><td><pre>            <span class=\"token class-name\">Map<span class=\"token punctuation\">.</span>Entry</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">K</span><span class=\"token punctuation\">,</span><span class=\"token class-name\">V</span><span class=\"token punctuation\">></span></span> e <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Map<span class=\"token punctuation\">.</span>Entry</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">K</span><span class=\"token punctuation\">,</span><span class=\"token class-name\">V</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">)</span> o<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"691\"></td><td><pre>            <span class=\"token class-name\">Entry</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">K</span><span class=\"token punctuation\">,</span><span class=\"token class-name\">V</span><span class=\"token punctuation\">></span></span> candidate <span class=\"token operator\">=</span> <span class=\"token function\">getEntry</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">.</span><span class=\"token function\">getKey</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"692\"></td><td><pre>            <span class=\"token keyword\">return</span> candidate <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">&amp;&amp;</span> candidate<span class=\"token punctuation\">.</span><span class=\"token function\">equals</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"693\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"694\"></td><td><pre>        <span class=\"token keyword\">public</span> <span class=\"token keyword\">boolean</span> <span class=\"token function\">remove</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Object</span> o<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"695\"></td><td><pre>            <span class=\"token keyword\">return</span> <span class=\"token function\">removeMapping</span><span class=\"token punctuation\">(</span>o<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"696\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"697\"></td><td><pre>        <span class=\"token keyword\">public</span> <span class=\"token keyword\">int</span> <span class=\"token function\">size</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"698\"></td><td><pre>            <span class=\"token keyword\">return</span> size<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"699\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"700\"></td><td><pre>        <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">clear</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"701\"></td><td><pre>            <span class=\"token class-name\">HashMap</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">clear</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"702\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"703\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"704\"></td><td><pre></pre></td></tr><tr><td data-num=\"705\"></td><td><pre>    <span class=\"token comment\">// 将对象写入到输出流中</span></pre></td></tr><tr><td data-num=\"706\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token keyword\">void</span> <span class=\"token function\">writeObject</span><span class=\"token punctuation\">(</span><span class=\"token class-name\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>io<span class=\"token punctuation\">.</span></span>ObjectOutputStream</span> s<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"707\"></td><td><pre>        <span class=\"token keyword\">throws</span> <span class=\"token class-name\">IOException</span></pre></td></tr><tr><td data-num=\"708\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"709\"></td><td><pre>        <span class=\"token comment\">// Write out the threshold, loadfactor, and any hidden stuff</span></pre></td></tr><tr><td data-num=\"710\"></td><td><pre>        s<span class=\"token punctuation\">.</span><span class=\"token function\">defaultWriteObject</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"711\"></td><td><pre></pre></td></tr><tr><td data-num=\"712\"></td><td><pre>        <span class=\"token comment\">// Write out number of buckets</span></pre></td></tr><tr><td data-num=\"713\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>table<span class=\"token operator\">==</span>EMPTY_TABLE<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"714\"></td><td><pre>            s<span class=\"token punctuation\">.</span><span class=\"token function\">writeInt</span><span class=\"token punctuation\">(</span><span class=\"token function\">roundUpToPowerOf2</span><span class=\"token punctuation\">(</span>threshold<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"715\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"716\"></td><td><pre>           s<span class=\"token punctuation\">.</span><span class=\"token function\">writeInt</span><span class=\"token punctuation\">(</span>table<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"717\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"718\"></td><td><pre></pre></td></tr><tr><td data-num=\"719\"></td><td><pre>        <span class=\"token comment\">// Write out size (number of Mappings)</span></pre></td></tr><tr><td data-num=\"720\"></td><td><pre>        s<span class=\"token punctuation\">.</span><span class=\"token function\">writeInt</span><span class=\"token punctuation\">(</span>size<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"721\"></td><td><pre></pre></td></tr><tr><td data-num=\"722\"></td><td><pre>        <span class=\"token comment\">// Write out keys and values (alternating)</span></pre></td></tr><tr><td data-num=\"723\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>size <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"724\"></td><td><pre>            <span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Map<span class=\"token punctuation\">.</span>Entry</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">K</span><span class=\"token punctuation\">,</span><span class=\"token class-name\">V</span><span class=\"token punctuation\">></span></span> e <span class=\"token operator\">:</span> <span class=\"token function\">entrySet0</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"725\"></td><td><pre>                s<span class=\"token punctuation\">.</span><span class=\"token function\">writeObject</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">.</span><span class=\"token function\">getKey</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"726\"></td><td><pre>                s<span class=\"token punctuation\">.</span><span class=\"token function\">writeObject</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">.</span><span class=\"token function\">getValue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"727\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"728\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"729\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"730\"></td><td><pre></pre></td></tr><tr><td data-num=\"731\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">long</span> serialVersionUID <span class=\"token operator\">=</span> <span class=\"token number\">362498820763181265L</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"732\"></td><td><pre>    <span class=\"token comment\">// 从输入流中读取对象</span></pre></td></tr><tr><td data-num=\"733\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token keyword\">void</span> <span class=\"token function\">readObject</span><span class=\"token punctuation\">(</span><span class=\"token class-name\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>io<span class=\"token punctuation\">.</span></span>ObjectInputStream</span> s<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"734\"></td><td><pre>         <span class=\"token keyword\">throws</span> <span class=\"token class-name\">IOException</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">ClassNotFoundException</span></pre></td></tr><tr><td data-num=\"735\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"736\"></td><td><pre>        <span class=\"token comment\">// Read in the threshold (ignored), loadfactor, and any hidden stuff</span></pre></td></tr><tr><td data-num=\"737\"></td><td><pre>        s<span class=\"token punctuation\">.</span><span class=\"token function\">defaultReadObject</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"738\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>loadFactor <span class=\"token operator\">&lt;=</span> <span class=\"token number\">0</span> <span class=\"token operator\">||</span> <span class=\"token class-name\">Float</span><span class=\"token punctuation\">.</span><span class=\"token function\">isNaN</span><span class=\"token punctuation\">(</span>loadFactor<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"739\"></td><td><pre>            <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">InvalidObjectException</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Illegal load factor: \"</span> <span class=\"token operator\">+</span></pre></td></tr><tr><td data-num=\"740\"></td><td><pre>                                               loadFactor<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"741\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"742\"></td><td><pre></pre></td></tr><tr><td data-num=\"743\"></td><td><pre>        <span class=\"token comment\">// set other fields that need values</span></pre></td></tr><tr><td data-num=\"744\"></td><td><pre>        table <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Entry</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">K</span><span class=\"token punctuation\">,</span><span class=\"token class-name\">V</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> EMPTY_TABLE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"745\"></td><td><pre></pre></td></tr><tr><td data-num=\"746\"></td><td><pre>        <span class=\"token comment\">// Read in number of buckets</span></pre></td></tr><tr><td data-num=\"747\"></td><td><pre>        s<span class=\"token punctuation\">.</span><span class=\"token function\">readInt</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// ignored.</span></pre></td></tr><tr><td data-num=\"748\"></td><td><pre></pre></td></tr><tr><td data-num=\"749\"></td><td><pre>        <span class=\"token comment\">// Read number of mappings</span></pre></td></tr><tr><td data-num=\"750\"></td><td><pre>        <span class=\"token keyword\">int</span> mappings <span class=\"token operator\">=</span> s<span class=\"token punctuation\">.</span><span class=\"token function\">readInt</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"751\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>mappings <span class=\"token operator\">&lt;</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"752\"></td><td><pre>            <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">InvalidObjectException</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Illegal mappings count: \"</span> <span class=\"token operator\">+</span></pre></td></tr><tr><td data-num=\"753\"></td><td><pre>                                               mappings<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"754\"></td><td><pre></pre></td></tr><tr><td data-num=\"755\"></td><td><pre>        <span class=\"token comment\">// capacity chosen by number of mappings and desired load (if >= 0.25)</span></pre></td></tr><tr><td data-num=\"756\"></td><td><pre>        <span class=\"token keyword\">int</span> capacity <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">)</span> <span class=\"token class-name\">Math</span><span class=\"token punctuation\">.</span><span class=\"token function\">min</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"757\"></td><td><pre>                    mappings <span class=\"token operator\">*</span> <span class=\"token class-name\">Math</span><span class=\"token punctuation\">.</span><span class=\"token function\">min</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span> <span class=\"token operator\">/</span> loadFactor<span class=\"token punctuation\">,</span> <span class=\"token number\">4.0f</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"758\"></td><td><pre>                    <span class=\"token comment\">// we have limits...</span></pre></td></tr><tr><td data-num=\"759\"></td><td><pre>                    <span class=\"token class-name\">HashMap</span><span class=\"token punctuation\">.</span>MAXIMUM_CAPACITY<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"760\"></td><td><pre></pre></td></tr><tr><td data-num=\"761\"></td><td><pre>        <span class=\"token comment\">// allocate the bucket array;</span></pre></td></tr><tr><td data-num=\"762\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>mappings <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"763\"></td><td><pre>            <span class=\"token function\">inflateTable</span><span class=\"token punctuation\">(</span>capacity<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"764\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"765\"></td><td><pre>            threshold <span class=\"token operator\">=</span> capacity<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"766\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"767\"></td><td><pre></pre></td></tr><tr><td data-num=\"768\"></td><td><pre>        <span class=\"token function\">init</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">// Give subclass a chance to do its thing.</span></pre></td></tr><tr><td data-num=\"769\"></td><td><pre></pre></td></tr><tr><td data-num=\"770\"></td><td><pre>        <span class=\"token comment\">// Read the keys and values, and put the mappings in the HashMap</span></pre></td></tr><tr><td data-num=\"771\"></td><td><pre>        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> mappings<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"772\"></td><td><pre>            <span class=\"token class-name\">K</span> key <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">K</span><span class=\"token punctuation\">)</span> s<span class=\"token punctuation\">.</span><span class=\"token function\">readObject</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"773\"></td><td><pre>            <span class=\"token class-name\">V</span> value <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">V</span><span class=\"token punctuation\">)</span> s<span class=\"token punctuation\">.</span><span class=\"token function\">readObject</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"774\"></td><td><pre>            <span class=\"token function\">putForCreate</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">,</span> value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"775\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"776\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"777\"></td><td><pre></pre></td></tr><tr><td data-num=\"778\"></td><td><pre>    <span class=\"token comment\">// These methods are used when serializing HashSets</span></pre></td></tr><tr><td data-num=\"779\"></td><td><pre>    <span class=\"token keyword\">int</span>   <span class=\"token function\">capacity</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>     <span class=\"token punctuation\">&#123;</span> <span class=\"token keyword\">return</span> table<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">;</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"780\"></td><td><pre>    <span class=\"token keyword\">float</span> <span class=\"token function\">loadFactor</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>   <span class=\"token punctuation\">&#123;</span> <span class=\"token keyword\">return</span> loadFactor<span class=\"token punctuation\">;</span>   <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"781\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"构造方法\"><a class=\"anchor\" href=\"#构造方法\">#</a> 构造方法</h2>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token class-name\">HashMap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>    <span class=\"token comment\">// 无参构造方法</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token class-name\">HashMap</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> initialCapacity<span class=\"token punctuation\">)</span>  <span class=\"token comment\">// 指定初始容量的构造方法 </span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token class-name\">HashMap</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> initialCapacity<span class=\"token punctuation\">,</span> <span class=\"token keyword\">float</span> loadFactor<span class=\"token punctuation\">)</span> <span class=\"token comment\">// 指定初始容量和负载因子</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token class-name\">HashMap</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Map</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token operator\">?</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">K</span><span class=\"token punctuation\">,</span><span class=\"token operator\">?</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">V</span><span class=\"token punctuation\">></span></span> m<span class=\"token punctuation\">)</span>  <span class=\"token comment\">// 指定集合，转化为 HashMap</span></pre></td></tr></table></figure><p>HashMap 提供了四个构造方法，构造方法中 ，依靠第三个方法来执行的，但是前三个方法都没有进行数组的初始化操作，即使调用了构造方法，此时存放 HaspMap 中数组元素的 table 表长度依旧为 0 。在第四个构造方法中调用了 inflateTable () 方法完成了 table 的初始化操作，并将 m 中的元素添加到 HashMap 中。</p>\n<h2 id=\"添加方法\"><a class=\"anchor\" href=\"#添加方法\">#</a> 添加方法</h2>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token class-name\">V</span> <span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">K</span> key<span class=\"token punctuation\">,</span> <span class=\"token class-name\">V</span> value<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>table <span class=\"token operator\">==</span> EMPTY_TABLE<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token comment\">// 是否初始化</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>            <span class=\"token function\">inflateTable</span><span class=\"token punctuation\">(</span>threshold<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>key <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// 放置在 0 号位置</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>            <span class=\"token keyword\">return</span> <span class=\"token function\">putForNullKey</span><span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token keyword\">int</span> hash <span class=\"token operator\">=</span> <span class=\"token function\">hash</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 计算 hash 值</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> <span class=\"token function\">indexFor</span><span class=\"token punctuation\">(</span>hash<span class=\"token punctuation\">,</span> table<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">// 计算在 Entry [] 中的存储位置</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Entry</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">K</span><span class=\"token punctuation\">,</span><span class=\"token class-name\">V</span><span class=\"token punctuation\">></span></span> e <span class=\"token operator\">=</span> table<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> e <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span> e <span class=\"token operator\">=</span> e<span class=\"token punctuation\">.</span>next<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>            <span class=\"token class-name\">Object</span> k<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">.</span>hash <span class=\"token operator\">==</span> hash <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>k <span class=\"token operator\">=</span> e<span class=\"token punctuation\">.</span>key<span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> key <span class=\"token operator\">||</span> key<span class=\"token punctuation\">.</span><span class=\"token function\">equals</span><span class=\"token punctuation\">(</span>k<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>                <span class=\"token class-name\">V</span> oldValue <span class=\"token operator\">=</span> e<span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>                e<span class=\"token punctuation\">.</span>value <span class=\"token operator\">=</span> value<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>                e<span class=\"token punctuation\">.</span><span class=\"token function\">recordAccess</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>                <span class=\"token keyword\">return</span> oldValue<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        modCount<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        <span class=\"token function\">addEntry</span><span class=\"token punctuation\">(</span>hash<span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">,</span> value<span class=\"token punctuation\">,</span> i<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 添加到 Map 中</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>在该方法中，添加键值对时，首先进行 table 是否初始化的判断，如果没有进行初始化（分配空间，Entry [] 数组的长度）。然后进行 key 是否为 null 的判断，如果 key==null , 放置在 Entry [] 的 0 号位置。计算在 Entry [] 数组的存储位置，判断该位置上是否已有元素，如果已经有元素存在，则遍历该 Entry [] 数组位置上的单链表。判断 key 是否存在，如果 key 已经存在，则用新的 value 值，替换点旧的 value 值，并将旧的 value 值返回。如果 key 不存在于 HashMap 中，程序继续向下执行。将 key-vlaue, 生成 Entry 实体，添加到 HashMap 中的 Entry [] 数组中</p>\n<h3 id=\"addentry\"><a class=\"anchor\" href=\"#addentry\">#</a> addEntry()</h3>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/*</pre></td></tr><tr><td data-num=\"2\"></td><td><pre> * hash hash 值</pre></td></tr><tr><td data-num=\"3\"></td><td><pre> * key 键值</pre></td></tr><tr><td data-num=\"4\"></td><td><pre> * value value 值</pre></td></tr><tr><td data-num=\"5\"></td><td><pre> * bucketIndex Entry [] 数组中的存储索引</pre></td></tr><tr><td data-num=\"6\"></td><td><pre> * / </pre></td></tr><tr><td data-num=\"7\"></td><td><pre>void addEntry (int hash, K key, V value, int bucketIndex) &#123;</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>     if ((size >= threshold) &amp;&amp; (null != table [bucketIndex])) &#123;</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>         resize (2 * table.length); // 扩容操作，将数据元素重新计算位置后放入 newTable 中，链表的顺序与之前的顺序相反</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>         hash = (null != key) ? hash (key) : 0;</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>         bucketIndex = indexFor (hash, table.length);</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>     &#125;</pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    createEntry (hash, key, value, bucketIndex);</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>&#125;</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>void createEntry (int hash, K key, V value, int bucketIndex) &#123;</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    Entry&lt;K,V> e = table [bucketIndex];</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    table [bucketIndex] = new Entry&lt;>(hash, key, value, e);</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    size++;</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>&#125;</span></pre></td></tr></table></figure><p>添加方法的具体操作，在添加之前先进行容量的判断，如果当前容量达到了阈值，并且需要存储到 Entry [] 数组中，先进行扩容操作，扩充的容量为 table 长度的 2 倍。重新计算 hash 值，和数组存储的位置，扩容后的链表顺序与扩容前的链表顺序相反。然后将新添加的 Entry 实体存放到当前 Entry [] 位置链表的头部。<br />\n在 1.8 之前，新插入的元素都是放在了链表的头部位置，但是这种操作在高并发的环境下容易导致死锁，所以 1.8 之后，新插入的元素都放在了链表的尾部。</p>\n<h2 id=\"获取方法\"><a class=\"anchor\" href=\"#获取方法\">#</a> 获取方法</h2>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token class-name\">V</span> <span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Object</span> key<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>     <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>key <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>         <span class=\"token comment\">// 返回 table [0] 的 value 值</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>         <span class=\"token keyword\">return</span> <span class=\"token function\">getForNullKey</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>     <span class=\"token class-name\">Entry</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">K</span><span class=\"token punctuation\">,</span><span class=\"token class-name\">V</span><span class=\"token punctuation\">></span></span> entry <span class=\"token operator\">=</span> <span class=\"token function\">getEntry</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>     <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">==</span> entry <span class=\"token operator\">?</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">:</span> entry<span class=\"token punctuation\">.</span><span class=\"token function\">getValue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token keyword\">final</span> <span class=\"token class-name\">Entry</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">K</span><span class=\"token punctuation\">,</span><span class=\"token class-name\">V</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">getEntry</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Object</span> key<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>     <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>size <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>         <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>     <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>     <span class=\"token keyword\">int</span> hash <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>key <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">?</span> <span class=\"token number\">0</span> <span class=\"token operator\">:</span> <span class=\"token function\">hash</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>     <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Entry</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">K</span><span class=\"token punctuation\">,</span><span class=\"token class-name\">V</span><span class=\"token punctuation\">></span></span> e <span class=\"token operator\">=</span> table<span class=\"token punctuation\">[</span><span class=\"token function\">indexFor</span><span class=\"token punctuation\">(</span>hash<span class=\"token punctuation\">,</span> table<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>         e <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>         e <span class=\"token operator\">=</span> e<span class=\"token punctuation\">.</span>next<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>         <span class=\"token class-name\">Object</span> k<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>         <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">.</span>hash <span class=\"token operator\">==</span> hash <span class=\"token operator\">&amp;&amp;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>             <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>k <span class=\"token operator\">=</span> e<span class=\"token punctuation\">.</span>key<span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> key <span class=\"token operator\">||</span> <span class=\"token punctuation\">(</span>key <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">&amp;&amp;</span> key<span class=\"token punctuation\">.</span><span class=\"token function\">equals</span><span class=\"token punctuation\">(</span>k<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>            <span class=\"token keyword\">return</span> e<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>     <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>在 get 方法中，首先计算 hash 值，然后调用 indexFor () 方法得到该 key 在 table 中的存储位置，得到该位置的单链表，遍历列表找到 key 和指定 key 内容相等的 Entry，返回 entry.value 值</p>\n<h2 id=\"删除方法\"><a class=\"anchor\" href=\"#删除方法\">#</a> 删除方法</h2>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token class-name\">V</span> <span class=\"token function\">remove</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Object</span> key<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>     <span class=\"token class-name\">Entry</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">K</span><span class=\"token punctuation\">,</span><span class=\"token class-name\">V</span><span class=\"token punctuation\">></span></span> e <span class=\"token operator\">=</span> <span class=\"token function\">removeEntryForKey</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>     <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>e <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">?</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">:</span> e<span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">final</span> <span class=\"token class-name\">Entry</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">K</span><span class=\"token punctuation\">,</span><span class=\"token class-name\">V</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">removeEntryForKey</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Object</span> key<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>     <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>size <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>         <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>     <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>     <span class=\"token keyword\">int</span> hash <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>key <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">?</span> <span class=\"token number\">0</span> <span class=\"token operator\">:</span> <span class=\"token function\">hash</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>     <span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> <span class=\"token function\">indexFor</span><span class=\"token punctuation\">(</span>hash<span class=\"token punctuation\">,</span> table<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>     <span class=\"token class-name\">Entry</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">K</span><span class=\"token punctuation\">,</span><span class=\"token class-name\">V</span><span class=\"token punctuation\">></span></span> prev <span class=\"token operator\">=</span> table<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>     <span class=\"token class-name\">Entry</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">K</span><span class=\"token punctuation\">,</span><span class=\"token class-name\">V</span><span class=\"token punctuation\">></span></span> e <span class=\"token operator\">=</span> prev<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>     <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>e <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>         <span class=\"token class-name\">Entry</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">K</span><span class=\"token punctuation\">,</span><span class=\"token class-name\">V</span><span class=\"token punctuation\">></span></span> next <span class=\"token operator\">=</span> e<span class=\"token punctuation\">.</span>next<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>         <span class=\"token class-name\">Object</span> k<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>         <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">.</span>hash <span class=\"token operator\">==</span> hash <span class=\"token operator\">&amp;&amp;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>             <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>k <span class=\"token operator\">=</span> e<span class=\"token punctuation\">.</span>key<span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> key <span class=\"token operator\">||</span> <span class=\"token punctuation\">(</span>key <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">&amp;&amp;</span> key<span class=\"token punctuation\">.</span><span class=\"token function\">equals</span><span class=\"token punctuation\">(</span>k<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>             modCount<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>             size<span class=\"token operator\">--</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>             <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>prev <span class=\"token operator\">==</span> e<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>                 table<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> next<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>             <span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>                 prev<span class=\"token punctuation\">.</span>next <span class=\"token operator\">=</span> next<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>             e<span class=\"token punctuation\">.</span><span class=\"token function\">recordRemoval</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>             <span class=\"token keyword\">return</span> e<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>         <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>         prev <span class=\"token operator\">=</span> e<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>         e <span class=\"token operator\">=</span> next<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    <span class=\"token keyword\">return</span> e<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>删除操作，先计算指定 key 的 hash 值，然后计算出 table 中的存储位置，判断当前位置是否 Entry 实体存在，如果没有直接返回，若当前位置有 Entry 实体存在，则开始遍历列表。定义了三个 Entry 引用，分别为 pre, e ,next。 在循环遍历的过程中，首先判断 pre 和 e 是否相等，若相等表明，table 的当前位置只有一个元素，直接将 table [i] = next = null 。若形成了 pre -&gt; e -&gt; next 的连接关系，判断 e 的 key 是否和指定的 key 相等，若相等则让 pre -&gt; next ,e 失去引用</p>\n<h1 id=\"总结\"><a class=\"anchor\" href=\"#总结\">#</a> 总结</h1>\n<ul>\n<li>HashMap 是基于 hashing 的原理，我们使用 put (key, value) 存储对象到 HashMap 中，使用 get (key) 从 HashMap 中获取对象。</li>\n<li>当我们给 put (key, value) 方法传递键和值时，它先调用 key.hashCode () 方法，返回的 hashCode 值，用于找到 bucket 位置，来储存 Entry 对象。</li>\n<li>Map 提供了一些常用方法，如 keySet ()、entrySet () 等方法。<br />\nkeySet () 方法返回值是 Map 中 key 值的集合；entrySet () 的返回值也是返回一个 Set 集合，此集合的类型为 Map.Entry。</li>\n<li>“如果两个 key 的 hashcode 相同，你如何获取值对象？” 答案：当我们调用 get (key) 方法，HashMap 会使用 key 的 hashcode 值，找到 bucket 位置，然后获取值对象。</li>\n<li>“如果有两个值对象，储存在同一个 bucket ？” 答案：将会遍历链表直到找到值对象。</li>\n<li>“这时会问因为你并没有值对象去比较，你是如何确定确定找到值对象的？” 答案：找到 bucket 位置之后，会调用 keys.equals () 方法，去找到链表中正确的节点，最终找到要找的值对象。</li>\n<li>HashMap 中主要是通过 key 的 hashCode 来计算 hash 值的，只要 hashCode 相同，计算出来的 hash 值就一样。</li>\n<li>如果存储的对象对多了，就有可能不同的对象所算出来的 hash 值是相同的，这就出现了所谓的 hash 冲突。</li>\n<li>学过数据结构的同学都知道，解决 hash 冲突的方法有很多，HashMap 底层是通过链表来解决 hash 冲突的。</li>\n<li>HashMap 是基于哈希表的 Map 接口的实现。</li>\n<li>此实现提供所有可选的映射操作，并允许使用 null 值和 null 键。（除了非同步和允许使用 null 之外，HashMap 类与 Hashtable 大致相同。）</li>\n<li>此类不保证映射的顺序，特别是它不保证该顺序恒久不变。</li>\n<li>值得注意的是 HashMap 不是线程安全的，如果想要线程安全的 HashMap，可以通过 Collections 类的静态方法 synchronizedMap 获得线程安全的 HashMap。</li>\n</ul>\n<h1 id=\"完美的回答\"><a class=\"anchor\" href=\"#完美的回答\">#</a> 完美的回答：</h1>\n<ul>\n<li>HashMap 基于 hashing 原理，我们通过 put (key,value) 和 get (key) 方法储存和获取对象。</li>\n<li>当储存对象时，我们将键值对传递给 put (key,value) 方法时，它调用键对象 key 的 hashCode () 方法来计算 hashcode，然后找到 bucket 位置，来储存值对象 value。</li>\n<li>当获取对象时，通过 key 的 equals () 方法找到正确的键值对 key-value，然后返回值对象 value。</li>\n<li>HashMap 使用链表来解决碰撞问题，当发生碰撞了，对象将会储存在链表的下一个节点中。</li>\n<li>HashMap 在每个链表节点中，储存 键值对 key-value 对象。</li>\n<li>当两个不同的键对象 key 的 hashcode 相同时，会发生什么？它们会储存在同一个 bucket 位置的链表中，并通过键对象 key 的 equals () 方法用来找到键值对 key-value。</li>\n</ul>\n<h1 id=\"jdk-18的-改变\"><a class=\"anchor\" href=\"#jdk-18的-改变\">#</a> JDK 1.8 的 改变</h1>\n<p>在 JDK1.8 之前，HashMap 采用数组 + 链表实现，即使用链表处理冲突，同一 hash 值的节点都存储在一个链表里。但是当位于一个桶中的元素较多，即 hash 值相等的元素较多时，通过 key 值依次查找的效率较低。而 JDK1.8 中，HashMap 采用数组 + 链表 + 红黑树实现，当链表长度超过阈值（8）时，将链表转换为红黑树，这样大大减少了查找时间。</p>\n<h2 id=\"红黑树数据结构\"><a class=\"anchor\" href=\"#红黑树数据结构\">#</a> 红黑树数据结构</h2>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token class-name\">TreeNode</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span>k<span class=\"token punctuation\">,</span>v<span class=\"token punctuation\">></span></span> parent<span class=\"token punctuation\">;</span>  <span class=\"token comment\">// 父节点</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token class-name\">TreeNode</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span>k<span class=\"token punctuation\">,</span>v<span class=\"token punctuation\">></span></span> left<span class=\"token punctuation\">;</span> <span class=\"token comment\">// 左子树</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token class-name\">TreeNode</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span>k<span class=\"token punctuation\">,</span>v<span class=\"token punctuation\">></span></span> right<span class=\"token punctuation\">;</span><span class=\"token comment\">// 右子树</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token class-name\">TreeNode</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span>k<span class=\"token punctuation\">,</span>v<span class=\"token punctuation\">></span></span> prev<span class=\"token punctuation\">;</span>    <span class=\"token comment\">// needed to unlink next upon deletion</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">boolean</span> red<span class=\"token punctuation\">;</span>    <span class=\"token comment\">// 颜色属性</span></pre></td></tr></table></figure><p><img data-src=\"6.png\" alt=\"\" /></p>\n<h1 id=\"hashmap与hashtable的区别\"><a class=\"anchor\" href=\"#hashmap与hashtable的区别\">#</a> HashMap 与 HashTable 的区别</h1>\n<ul>\n<li>HashMap 允许将 null 作为一个 entry 的 key 或者 value，而 Hashtable 不允许。</li>\n<li>HashMap 把 Hashtable 的 contains 方法去掉了，改成 containsValue 和 containsKey。因为 contains 方法容易让人引起误解。</li>\n<li>HashTable 继承自 Dictionary 类，而 HashMap 是 Java1.2 引进的 Map interface 的一个实现。</li>\n<li>HashTable 的方法是 Synchronize 的，而 HashMap 不是，在多个线程访问 Hashtable 时，不需要自己为它的方法实现同步，而 HashMap 就必须为之提供外同步。</li>\n<li>Hashtable 和 HashMap 采用的 hash/rehash 算法都大概一样，所以性能不会有很大的差异</li>\n</ul>\n",
            "tags": [
                "计算机科学",
                "数据结构",
                "java"
            ]
        },
        {
            "id": "http://yrmlnf.coding-pages.com/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/%E5%A4%A7%E6%95%B0%E6%8D%AE/%E6%95%B0%E6%8D%AE%E6%B2%BB%E7%90%86/%E6%95%B0%E6%8D%AE%E6%B2%BB%E7%90%86-%E6%95%B0%E6%8D%AE%E8%A1%80%E7%BC%98%E8%AE%BE%E8%AE%A1/",
            "url": "http://yrmlnf.coding-pages.com/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/%E5%A4%A7%E6%95%B0%E6%8D%AE/%E6%95%B0%E6%8D%AE%E6%B2%BB%E7%90%86/%E6%95%B0%E6%8D%AE%E6%B2%BB%E7%90%86-%E6%95%B0%E6%8D%AE%E8%A1%80%E7%BC%98%E8%AE%BE%E8%AE%A1/",
            "title": "数据治理-数据血缘设计",
            "date_published": "2020-06-03T01:01:05.000Z",
            "content_html": "<h1 id=\"什么是数据血缘\"><a class=\"anchor\" href=\"#什么是数据血缘\">#</a> 什么是数据血缘</h1>\n<p>数据血缘是数据治理里元数据管理的一个概念。</p>\n<div class=\"note info\">\n<p>数据治理包括数据标准、数据质量、主数据、元数据、数据安全等多个方面。</p>\n</div>\n<p>对于元数据的管理，谷歌曾发表过一篇论文，里面详细的描述了谷歌他们是怎么做的： <span class=\"exturl\" data-url=\"aHR0cDovL3Blb3BsZS5jcy51Y2hpY2Fnby5lZHUvfmFlbG1vcmUvY2xhc3MvdG9waWNzMTcvZ29vZHMucGRm\">Goods：Google Dataset Search</span><br />\n 谷歌将元数据管理分为了几个部分：<br />\n<img data-src=\"1.png\" alt=\"谷歌将元数据管理分为了几个部分\" /></p>\n<p>那么什么是数据血缘呢？在现实世界中，我们每个个体都是祖先通过生育关系一代代孕育而来，这样就形成了我们人类的各种血缘关系。在数据信息时代，我们庞大的数据在每时每刻产生，这些数据又经过各种加工组合、转换，又会产生新的数据，这些数据之间就存在着天然的联系，我们把这些联系称为数据血缘关系。<br />\n直白点说数据血缘指数据产生的链路，就是我们这个数据是怎么来的，经过了哪些过程和阶段。</p>\n<h2 id=\"特性\"><a class=\"anchor\" href=\"#特性\">#</a> 特性</h2>\n<ul>\n<li>归属性：一般来说，特定的数据归属特定的团队或者个人</li>\n<li>多源性：同一个数据可以有多个来源（多个父亲）。一个数据可以是多个数据经过加工而生成的，而且这种加工过程可以是多个。</li>\n<li>可追溯性：数据的血缘关系，体现了数据的生命周期，体现了数据从产生到消亡的整个过程，具备可追溯性。</li>\n<li>层次性：数据的血缘关系是有层次的。对数据的分类、归纳、总结等对数据进行的描述信息又形成了新的数据，不同程度的描述信息形成了数据的层次。</li>\n</ul>\n<h1 id=\"数据血缘的作用\"><a class=\"anchor\" href=\"#数据血缘的作用\">#</a> 数据血缘的作用</h1>\n<h2 id=\"数据溯源\"><a class=\"anchor\" href=\"#数据溯源\">#</a> 数据溯源</h2>\n<p>溯源，指的是探寻事物的根本、源头。我们分析处理的数据，可能来源很广泛，有政府的数据，有互联网的数据，有通过数据交易从第三方获取的数据，还有自身拥有的数据。不同来源的数据，数据质量参差不齐，对分析处理的结果影响也不尽相同。当数据发生异常，我们需要能追踪到异常发生的原因，把风险控制在适当的水平。<br />\n数据的血缘关系，体现了数据的来龙去脉，能帮助我们追踪数据的来源，追踪数据处理过程。在数据的血缘关系可视化图形上，主节点的上面就是数据来源节点，非常清晰，一目了然。数据经过了哪些转换也能从可视化图形上看出来，对异常数据产生原因的分析帮助很大。</p>\n<h2 id=\"评估数据价值\"><a class=\"anchor\" href=\"#评估数据价值\">#</a> 评估数据价值</h2>\n<p>数据的价值在数据交易领域非常重要，涉及到数据的定价。要对数据价值进行评估，就需要有依据。数据血缘关系，可以从几个方面给数据价值的评估提供依据：</p>\n<ul>\n<li>数据受众。在血缘关系图上，下面的数据流出节点表示受众，亦即数据需求方，数据需求方越多表示数据价值越大；</li>\n<li>数据更新量级。数据血缘关系图中，数据流转线路的线条越粗，表示数据更新的量级越大，从一定程度上反映了数据价值的大小；</li>\n<li>数据更新频次。数据更新越频繁，表示数据越鲜活，价值越高。在血缘关系图上，数据流转线路的线段越短，更新越频繁。</li>\n</ul>\n<h2 id=\"数据质量评估\"><a class=\"anchor\" href=\"#数据质量评估\">#</a> 数据质量评估</h2>\n<p>从数据的血缘关系图上，可以方便的看到数据清洗的标准清单，这个清单反映了对数据质量的要求。</p>\n<h2 id=\"数据归档-销毁的参考\"><a class=\"anchor\" href=\"#数据归档-销毁的参考\">#</a> 数据归档、销毁的参考</h2>\n<p>如果数据没有了受众，就失去了使用价值。从数据的血缘关系图上看，最下面没有了数据节点，就可以去评估主节点所代表的数据是否要归档或者销毁了</p>\n<h1 id=\"数据血缘的级别\"><a class=\"anchor\" href=\"#数据血缘的级别\">#</a> 数据血缘的级别</h1>\n<p>广义上，血缘分析包含以下 3 个级别：</p>\n<ul>\n<li>作业级别:<br />\n 大数据平台中的数据由不同作业生成，例如 Kettle,Spark,MR。在作业级别我们可以获取到更高层次的信息，如服务器、运行时长、等待时长、当前任务流状态等</li>\n<li>数据集级别:<br />\n 数据集即表，广义上包括 HDFS、HBase、关系型数据库、Kafka、Ftp、本地文件等。在表级别我们能获取到表的生成链路，表的重要程度（使用频率），表的基础信息</li>\n<li>字段级别<br />\n字段级别是最苛刻的级别，在字段级别我们能追寻到某张表的字段来源于哪里，字段的重要性排名。</li>\n</ul>\n<h1 id=\"数据血缘的采集\"><a class=\"anchor\" href=\"#数据血缘的采集\">#</a> 数据血缘的采集</h1>\n<p>分析大数据平台中的每一个存储媒介（关系型数据库，NoSql，Kafka，HDFS 等）和每一个作业工具（如 Flink，Spark，Pentaho 等），编写新的 ETL 来生成数据血缘。<br />\n从存储媒介中我们能获取表的信息，从作业工具中我们能获取数据流转线路。</p>\n<h2 id=\"数据源信息\"><a class=\"anchor\" href=\"#数据源信息\">#</a> 数据源信息</h2>\n<p>数据源的基础信息包括：数据源名，数据源类型，数据源配置，数据源状态，数据源所属等<br />\n采集数据源信息一般有以下手段</p>\n<ol>\n<li>通过 SQL 脚本或者程序脚本录入数据源</li>\n<li>进行 ETL 采集数据血缘的时候录入</li>\n<li>手工录入</li>\n</ol>\n<h2 id=\"数据集信息\"><a class=\"anchor\" href=\"#数据集信息\">#</a> 数据集信息</h2>\n<p>以下是部分存储媒介提取方法</p>\n<ul>\n<li>关系型数据库：\n<ol>\n<li>从 DDL 或者 SQL 语句中提取表结构</li>\n<li>创建触发器提取表结构</li>\n</ol>\n</li>\n<li>KafKa: 当 kafka 作为 ODS 的时候，每个 topic 名就是表名</li>\n</ul>\n<h2 id=\"数据流转线路\"><a class=\"anchor\" href=\"#数据流转线路\">#</a> 数据流转线路</h2>\n<p>以下是部分作业工具提取方法</p>\n<ul>\n<li>Pentaho：<br />\nPentaho 使用 kettle 作为 ETL 工具，Kettle 分为 KJB 和 KTR 文件，其中 KJB 控制作业流程，KTR 控制实际转换。\n<ol>\n<li>对于 KJB 文件，我们可以获取作业信息</li>\n<li>对于 ktr 文件，我们可以获取具体的数据流转线路。ktr 实际上是一个 xml 文件，将 ktr 转换为 xml 文件然后用 kettle 读取遍历便能获取到数据链路</li>\n</ol>\n</li>\n</ul>\n<h2 id=\"数据量频率\"><a class=\"anchor\" href=\"#数据量频率\">#</a> 数据量，频率</h2>\n<p>通过分析日志文件获取，或者在 etl 中发送相关数据到一个专门记录数据血缘的服务</p>\n<h1 id=\"数据模型设计\"><a class=\"anchor\" href=\"#数据模型设计\">#</a> 数据模型设计</h1>\n<p><img data-src=\"2.png\" alt=\"数据模型设计\" /></p>\n<table>\n<thead>\n<tr>\n<th>表名</th>\n<th>描述</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>provenance_job</td>\n<td>作业信息表</td>\n</tr>\n<tr>\n<td>provenance_dataset</td>\n<td>数据集信息表，即 table 名</td>\n</tr>\n<tr>\n<td>provenance_field</td>\n<td>字段信息表</td>\n</tr>\n<tr>\n<td>provenance_datasource</td>\n<td>数据源信息表</td>\n</tr>\n<tr>\n<td>ref_job_lineage</td>\n<td>作业级别血缘关系表</td>\n</tr>\n<tr>\n<td>ref_dataset_lineage</td>\n<td>数据集级别血缘关系表</td>\n</tr>\n<tr>\n<td>ref_filed_lineage</td>\n<td>字段级别血缘关系表，type 字段指聚合的方法，如 sum，max，min</td>\n</tr>\n</tbody>\n</table>\n<p>作业表：provenance_job</p>\n<table>\n<thead>\n<tr>\n<th>字段名</th>\n<th>类型</th>\n<th>描述</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>id</td>\n<td>bint</td>\n<td>自增主键</td>\n</tr>\n<tr>\n<td>name</td>\n<td>varchar(128)</td>\n<td>作业名</td>\n</tr>\n<tr>\n<td>owner</td>\n<td>varchar(64)</td>\n<td>所属团队</td>\n</tr>\n<tr>\n<td>type</td>\n<td>varchar(64)</td>\n<td>作业类型</td>\n</tr>\n<tr>\n<td>comment</td>\n<td>varchar(256)</td>\n<td>备注</td>\n</tr>\n<tr>\n<td>status</td>\n<td>int</td>\n<td>状态 1 为正常 0 为失效</td>\n</tr>\n<tr>\n<td>create_time</td>\n<td>timestamp</td>\n<td>创建时间</td>\n</tr>\n<tr>\n<td>update_time</td>\n<td>timestamp</td>\n<td>更新时间</td>\n</tr>\n</tbody>\n</table>\n<p>数据表：provenance_dataset：</p>\n<table>\n<thead>\n<tr>\n<th>字段名</th>\n<th>类型</th>\n<th>描述</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>id</td>\n<td>bint</td>\n<td>自增主键</td>\n</tr>\n<tr>\n<td>name</td>\n<td>varchar(128)</td>\n<td>数据名</td>\n</tr>\n<tr>\n<td>datasource_id</td>\n<td>bint</td>\n<td>数据源 id</td>\n</tr>\n<tr>\n<td>job_id</td>\n<td>bint</td>\n<td>作业 id</td>\n</tr>\n<tr>\n<td>type</td>\n<td>varchar(64)</td>\n<td>数据类型</td>\n</tr>\n<tr>\n<td>comment</td>\n<td>varchar(256)</td>\n<td>备注</td>\n</tr>\n<tr>\n<td>status</td>\n<td>int</td>\n<td>状态 1 为正常 0 为失效</td>\n</tr>\n<tr>\n<td>create_time</td>\n<td>timestamp</td>\n<td>创建时间</td>\n</tr>\n<tr>\n<td>update_time</td>\n<td>timestamp</td>\n<td>更新时间</td>\n</tr>\n</tbody>\n</table>\n<p>字段表：provenance_filed：</p>\n<table>\n<thead>\n<tr>\n<th>字段名</th>\n<th>类型</th>\n<th>描述</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>id</td>\n<td>bint</td>\n<td>自增主键</td>\n</tr>\n<tr>\n<td>name</td>\n<td>varchar(128)</td>\n<td>数据名</td>\n</tr>\n<tr>\n<td>dataset_id</td>\n<td>bint</td>\n<td>数据 id</td>\n</tr>\n<tr>\n<td>type</td>\n<td>varchar(64)</td>\n<td>字段类型</td>\n</tr>\n<tr>\n<td>comment</td>\n<td>varchar(256)</td>\n<td>备注</td>\n</tr>\n<tr>\n<td>status</td>\n<td>int</td>\n<td>状态 1 为正常 0 为失效</td>\n</tr>\n<tr>\n<td>create_time</td>\n<td>timestamp</td>\n<td>创建时间</td>\n</tr>\n<tr>\n<td>update_time</td>\n<td>timestamp</td>\n<td>更新时间</td>\n</tr>\n</tbody>\n</table>\n<p>数据源表：provenance_datasource：</p>\n<table>\n<thead>\n<tr>\n<th>字段名</th>\n<th>类型</th>\n<th>描述</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>id</td>\n<td>bint</td>\n<td>自增主键</td>\n</tr>\n<tr>\n<td>name</td>\n<td>varchar(128)</td>\n<td>数据源名</td>\n</tr>\n<tr>\n<td>owner</td>\n<td>varchar(64)</td>\n<td>所属团队</td>\n</tr>\n<tr>\n<td>type</td>\n<td>varchar(64)</td>\n<td>数据源类型</td>\n</tr>\n<tr>\n<td>scheme</td>\n<td>varchar(64)</td>\n<td>模式名</td>\n</tr>\n<tr>\n<td>comment</td>\n<td>varchar(256)</td>\n<td>备注</td>\n</tr>\n<tr>\n<td>status</td>\n<td>int</td>\n<td>状态 1 为正常 0 为失效</td>\n</tr>\n<tr>\n<td>create_time</td>\n<td>timestamp</td>\n<td>创建时间</td>\n</tr>\n<tr>\n<td>update_time</td>\n<td>timestamp</td>\n<td>更新时间</td>\n</tr>\n</tbody>\n</table>\n<p>作业链路表：ref_job_lineage</p>\n<table>\n<thead>\n<tr>\n<th>字段名</th>\n<th>类型</th>\n<th>描述</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>id</td>\n<td>bint</td>\n<td>自增主键</td>\n</tr>\n<tr>\n<td>source</td>\n<td>bint</td>\n<td>流出作业节点 id</td>\n</tr>\n<tr>\n<td>target</td>\n<td>bint</td>\n<td>流入作业节点 id</td>\n</tr>\n<tr>\n<td>volume</td>\n<td>int</td>\n<td>更新量级</td>\n</tr>\n<tr>\n<td>version</td>\n<td>bint</td>\n<td>版本号</td>\n</tr>\n<tr>\n<td>date_from</td>\n<td>timestamp</td>\n<td>数据有效开始时间</td>\n</tr>\n<tr>\n<td>date_to</td>\n<td>timestamp</td>\n<td>数据有效截止时间</td>\n</tr>\n</tbody>\n</table>\n<p>数据链路表：ref_dataset_lineage</p>\n<table>\n<thead>\n<tr>\n<th>字段名</th>\n<th>类型</th>\n<th>描述</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>id</td>\n<td>bint</td>\n<td>自增主键</td>\n</tr>\n<tr>\n<td>source</td>\n<td>bint</td>\n<td>流出数据节点 id</td>\n</tr>\n<tr>\n<td>target</td>\n<td>bint</td>\n<td>流入数据节点 id</td>\n</tr>\n<tr>\n<td>volume</td>\n<td>int</td>\n<td>更新量级</td>\n</tr>\n<tr>\n<td>version</td>\n<td>bint</td>\n<td>版本号</td>\n</tr>\n<tr>\n<td>date_from</td>\n<td>timestamp</td>\n<td>数据有效开始时间</td>\n</tr>\n<tr>\n<td>date_to</td>\n<td>timestamp</td>\n<td>数据有效截止时间</td>\n</tr>\n</tbody>\n</table>\n<p>字段链路表：ref_filed_lineage</p>\n<table>\n<thead>\n<tr>\n<th>字段名</th>\n<th>类型</th>\n<th>描述</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>id</td>\n<td>bint</td>\n<td>自增主键</td>\n</tr>\n<tr>\n<td>source</td>\n<td>bint</td>\n<td>源字段 id</td>\n</tr>\n<tr>\n<td>target</td>\n<td>bint</td>\n<td>目标字段</td>\n</tr>\n<tr>\n<td>type</td>\n<td>varchart(64)</td>\n<td>聚合类型，如 max,min,sum,avg</td>\n</tr>\n<tr>\n<td>version</td>\n<td>bint</td>\n<td>版本号</td>\n</tr>\n<tr>\n<td>date_from</td>\n<td>timestamp</td>\n<td>数据有效开始时间</td>\n</tr>\n<tr>\n<td>date_to</td>\n<td>timestamp</td>\n<td>数据有效截止时间</td>\n</tr>\n</tbody>\n</table>\n<p>建立好数据表后建立对应的 ETL 把数据装载进表中。因为作业与数据处于变动的状态中，三张关系表将设计成拉链表，每天生成新的记录，用 version 字段区分。<br />\n这样做有三个好处</p>\n<ol>\n<li>数据血缘的亲疏由数据量来决定，记录数据量有利于获取更准确的血缘关系</li>\n<li>有利于观察动态的血缘关系</li>\n<li>能监控作业的执行情况</li>\n</ol>\n<h1 id=\"血缘关系可视化\"><a class=\"anchor\" href=\"#血缘关系可视化\">#</a> 血缘关系可视化</h1>\n<p>将血缘关系可视化能让我们更加直观的分析数据平台中的血缘关系，在分析血缘关系的时候一般使用桑基图或者关系图。</p>\n<h2 id=\"桑基图\"><a class=\"anchor\" href=\"#桑基图\">#</a> 桑基图</h2>\n<p>桑基图，也叫桑基能量分流图或者桑基能量平衡图，桑基图最明显的特征就是，始末端的分支宽度总和相等，即所有主支宽度的总和应与所有分出去的分支宽度的总和相等，通常应用于具有流向关系，层级关系的数据可视化分析。<br />\n桑基图由节点与流量组成，下面是桑基图的样子<br />\n<img data-src=\"3.png\" alt=\"\" /><br />\n血缘关系图中从三个元素分析数据血缘，分别是数据节点，流转线路，血缘亲疏<br />\n<img data-src=\"4.png\" alt=\"\" /></p>\n<h3 id=\"数据节点\"><a class=\"anchor\" href=\"#数据节点\">#</a> 数据节点</h3>\n<p>用来用来表现数据的所有者和数据层次信息或终端信息<br />\n有两种类型：数据流出节点，数据流入节点</p>\n<ul>\n<li>数据流入节点可以有多个，是主节点的父节点，表示数据来源</li>\n<li>数据流出节点也可以有多个，是主节点的子节点，表示数据的去向；包括一种特殊的节点，即终端节点，终端节点是一种特殊的数据流出节点，表示数据不再往下进行流转，这种数据一般用来做可视化展示。</li>\n</ul>\n<h3 id=\"流转线路\"><a class=\"anchor\" href=\"#流转线路\">#</a> 流转线路</h3>\n<p>表现的是数据的流转路径，从左到右流转。数据流转线路从数据流出节点出来往数据流入节点汇聚<br />\n数据流转线路表现了两个维度的信息，分别是方向、数据量级</p>\n<ul>\n<li>方向默认从左到右</li>\n<li>数据量级通过线条的粗细来表现。线条越粗表示数据量级越大，线条越细则表示数据量级越小。</li>\n</ul>\n<h3 id=\"血缘亲疏\"><a class=\"anchor\" href=\"#血缘亲疏\">#</a> 血缘亲疏</h3>\n<p>流入节点到流出节点之间所间隔的节点越少，两个节点的血缘关系越亲密。比如 table3 与 table6 都来源于 table1，但是 table3 中间隔了一个 table5 节点，所以 table6 与 table1 的数据更加相似。血缘亲疏可以用于数据质量评估与数据销毁评估。<br />\n<img data-src=\"6.png\" alt=\"\" /><br />\n<img data-src=\"5.png\" alt=\"\" /></p>\n<h3 id=\"图表数据结构\"><a class=\"anchor\" href=\"#图表数据结构\">#</a> 图表数据结构</h3>\n<p>图表数据类型与设计的关系表一致，只需要通过递归的方法查询节点的流转线路即可</p>\n<figure class=\"highlight json\"><figcaption data-lang=\"JSON\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>            source<span class=\"token operator\">:</span> 'table1'<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>            target<span class=\"token operator\">:</span> 'table3'<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>            value<span class=\"token operator\">:</span> <span class=\"token number\">5</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>            source<span class=\"token operator\">:</span> 'table1'<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>            target<span class=\"token operator\">:</span> 'table4'<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>            value<span class=\"token operator\">:</span> <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>            source<span class=\"token operator\">:</span> 'table2'<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>            target<span class=\"token operator\">:</span> 'table5'<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>            value<span class=\"token operator\">:</span> <span class=\"token number\">8</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>       <span class=\"token punctuation\">&#125;</span>       </pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">]</span></pre></td></tr></table></figure><h2 id=\"关系图\"><a class=\"anchor\" href=\"#关系图\">#</a> 关系图</h2>\n<p>关系图是展现事物相关性和关联性的图表，关系图由节点与流转线路组成。关系图能展示血缘之间的关系但是不能很好的展示数据量级，关系图比较适用于展现字段级别的血缘关系。</p>\n<p><img data-src=\"7.png\" alt=\"关系图\" /></p>\n<h3 id=\"数据节点-2\"><a class=\"anchor\" href=\"#数据节点-2\">#</a> 数据节点</h3>\n<p>数据节点上显示的当前节点的数据量总计</p>\n<h3 id=\"流转线路-2\"><a class=\"anchor\" href=\"#流转线路-2\">#</a> 流转线路</h3>\n<p>表现的是数据的流转路径，从左到右流转。数据流转线路从数据流出节点出来往数据流入节点汇聚<br />\n流转线路上标识了流转的方向</p>\n<h3 id=\"图表数据结构-2\"><a class=\"anchor\" href=\"#图表数据结构-2\">#</a> 图表数据结构</h3>\n<figure class=\"highlight json\"><figcaption data-lang=\"JSON\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    source<span class=\"token operator\">:</span> <span class=\"token string\">\"table1\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    target<span class=\"token operator\">:</span> <span class=\"token string\">\"table5\"</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    source<span class=\"token operator\">:</span> <span class=\"token string\">\"table1\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    target<span class=\"token operator\">:</span> <span class=\"token string\">\"table8\"</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">]</span></pre></td></tr></table></figure>",
            "tags": [
                "计算机科学",
                "大数据",
                "数据治理",
                "元数据"
            ]
        },
        {
            "id": "http://yrmlnf.coding-pages.com/%E8%B7%A8%E5%A2%83%E7%94%B5%E5%95%86/Amazon-2020%E7%89%A9%E6%B5%81%E6%88%90%E6%9C%AC/",
            "url": "http://yrmlnf.coding-pages.com/%E8%B7%A8%E5%A2%83%E7%94%B5%E5%95%86/Amazon-2020%E7%89%A9%E6%B5%81%E6%88%90%E6%9C%AC/",
            "title": "Amazon-2020物流成本",
            "date_published": "2020-05-23T02:40:00.000Z",
            "content_html": "<h1 id=\"amazon发货方式\"><a class=\"anchor\" href=\"#amazon发货方式\">#</a> Amazon 发货方式</h1>\n<p>亚马逊有三种发货方式，分别来如下：</p>\n<ol>\n<li>Fulfillment by Amazon（FBA）<br />\nFBA 是亚马逊物流服务，卖家先把货物发到亚马逊仓库储存，接到订单后直接从亚马逊仓库发货。整个挑选、包装、运输产品的过程都由亚马逊的工作人员操作。不仅自如此，平台还提供客户服务及退货服务。使用这种方式发货时效比较快，客户的用户体验比较好，百相当于分担了卖家的工作量。但是相应的也要向亚马逊缴纳仓库的使用费。</li>\n<li>Seller Fulfilled Prime（SFP）<br />\n简单的来说 SFP 就是卖家自己在海度外搭建海外仓或者和第三方的海外仓合作。物流效率和 FBA 的模式差不多。问但需要满足一定的规定才有资格使用 SFP。</li>\n<li>Fulfillment by Merchant（FBM）<br />\nFBM 就是卖家利用自己的资源向买家发货。当店铺有了订单后卖家再从国内将货物发往国答外，这种模式不需要囤货甚至不需要有货源，但物流时效比较慢。</li>\n</ol>\n<h1 id=\"fba\"><a class=\"anchor\" href=\"#fba\">#</a> FBA</h1>\n<h2 id=\"什么是亚马逊fba\"><a class=\"anchor\" href=\"#什么是亚马逊fba\">#</a> 什么是亚马逊 FBA</h2>\n<p>这个计划允许任何人在亚马逊平台出售产品。物流对任何电商企业来说都是最大的挑战之一。通过 FBA 计划，亚马逊可以在它的仓库中存储你的产品，把产品配送给你的顾客，处理所有退款退货问题，以及提供无与伦比的客户服务。<br />\n这不意味着作为卖家的你不需要承担任何责任。它真正的作用在于，让你有大量时间关注其他高级别、能创造价值的活动，比如引流、优化转化率等。<br />\n为什么亚马逊 FBA 比其他电商更好？<br />\nFBA 计划除了可以帮你处理物流问题，它还有其他优势。其中一点就是亚马逊的配送速度要比零售商的快。FBA 可以让你获得更多的平台曝光率，从而转化成更多的销量。<br />\nFBA 还可以让你的产品符合 Prime 资格，消费者非常喜欢这个免运费两天送达的 Prime 服务。最后 FBA 最大的一个优势是，亚马逊是一个非常受信任的品牌。它一直在努力优化支付过程，赢得消费者的信任。作为卖家的你也能得到这种信誉带来的好处。</p>\n<h2 id=\"怎么建立fba业务\"><a class=\"anchor\" href=\"#怎么建立fba业务\">#</a> 怎么建立 FBA 业务</h2>\n<p>要开始建立 FBA 业务，这里有 5 个基本的步骤：</p>\n<ol>\n<li>创建亚马逊卖家账号。建议创建专业卖家账号，专业卖家账号每月需缴纳一定的费用。</li>\n<li>选择利基产品。有些产品很好，有些产品则不值得涉及。做好调查，集思广益。</li>\n<li>找到供应商。一旦你知道要卖什么产品了，就开始和可靠的供应商建立合作关系。向他们要求样品，计算下从下单到出货所需时间，并算下产品的利润。</li>\n<li>创建产品的 listing。通过恰当的关键词和内容来优化产品页面。</li>\n<li>引流。向目标客户发送产品页面，提供销量。</li>\n</ol>\n<div class=\"note info 以下是Shogren的一些建议\">\n<ol>\n<li>产品的价格应该介于 10 美元到 50 美元之间；</li>\n<li>产品重量应尽可能轻</li>\n<li>查看潜在竞争者的主类目产品销量排名是否在前 5000，或者更低</li>\n<li>确保在你卖的产品类别中没有知名品牌</li>\n<li>尽量销售不容易碎的产品</li>\n<li>产品评价越多，竞争力越强。如果产品第一页的评价数量是 50 或者更少，这就意味着你可以打入这个市场</li>\n<li>生产成本应该控制在售价的 25% 或者更少</li>\n</ol>\n</div>\n<h2 id=\"fba费用计算\"><a class=\"anchor\" href=\"#fba费用计算\">#</a> FBA 费用计算</h2>\n<h3 id=\"fba中常见计量单位换算\"><a class=\"anchor\" href=\"#fba中常见计量单位换算\">#</a> FBA 中常见计量单位换算</h3>\n<p>1 (英寸)=2.54cm (厘米)<br />\n 1 lb (磅)=0.4536kg (千克)<br />\n 1 oz (盎司)=28.35g<br />\n1 cubic foot (立方英尺)=28.32 cubic dm (立方分米)</p>\n<h3 id=\"fba费用组成\"><a class=\"anchor\" href=\"#fba费用组成\">#</a> FBA 费用组成</h3>\n<p>FBA 费用包括：订单配送费、FBA 库存存储费、搬迁订单费、退货处理费、计划外服务费共 5 部分，每部分 FBA 费用细节不同。</p>\n<ol>\n<li>订单配送费<br />\n出货订单取决于有多少重量和包装的大小。\n<ul>\n<li>标准尺寸：任何重量不超过 12 盎司、最大边缘不超过 15 英寸、最大边缘不超过 0.75 英寸和包装后次要边缘不超过 12 英寸的物品。</li>\n<li>大规格：所有包装货物，重量不超过 20 磅，最大边缘不超过 18 英寸，最大边缘不超过 8 英寸，二次长度不超过 14 英寸。</li>\n<li>小大：不超过 70 磅的任何包装的重量，最长边不超过 60 英寸长的时间不超过 30 英寸，围护产品的最长边的边缘不超过 130 英寸。</li>\n<li>中大：不大于 150 磅，最长边的最长边和过 108 英寸加周长产品的任何包装重量不超过 130 英寸。</li>\n<li>大尺寸：任何包装后重量不超过 150 磅的物品，最大边缘不超过 108 英寸，最大边缘周长不超过 165 英寸。<br />\n包装的任何产品符合一个或多个下列条件：特别大超过 150 磅（单或体积重量），超过 1.08 英寸，或最长边加圆周超过 165 英寸的最长边。此外，确定了需要特殊处理或货物的配送也属于一种特殊的大件物品。<br />\n<img data-src=\"1.png\" alt=\"订单配送费\" /></li>\n</ul>\n</li>\n<li>FBA 库存仓储费\n<ul>\n<li>月度仓储费：<br />\n亚马逊会在第二个月 7-15 号之间进行收取，费用按照货物的体积进行收取：<br />\n1-9 月，标准尺寸 0.64 美元 / 每立方英尺 超大尺寸 0.43 美元 / 每立方英尺<br />\n 10-12 月，标准尺寸 2.35 美元 / 每立方英尺 超大尺寸 1.15 美元 / 每立方英尺<br />\n月度仓储费：(应收取 6 个月长期仓储费的商品数量) x (单位商品体积) x (对应月份每立方仓储费)<br />\n 在十月到十二月旺季期间，仓储费会比平时升高 1-2 倍。</li>\n<li>长期仓储费：<br />\n如果卖家的货物在亚马逊仓库里存放超过 6 个月没有销售出去则需要缴纳这笔费用。<br />\n一般来说，亚马逊会在每年的 2 月 15 号和 8 月 15 号进行收取：<br />\n存放在 6-12 个月的产品，按 11.25 美元每立方英尺进行收取长期仓储费<br />\n存放超过 12 个月的产品，按 22.50 美元每立方英尺进行长期仓储费的收取。<br />\n长期仓储费：(应收取时间段长期仓储费的商品数量) x (单位商品体积) x (对应时间段长期仓储费的每立方收费)<br />\n 值得注意的是，从 2017 年 8 月 15 日起欧洲 FBA 长期仓储费用如下：<br />\n存放 6-12 个月的产品：每立方米收取 500 欧元半年的长期仓储费<br />\n存放 12 个月以上的产品：每立方米收取 1000 欧元的长期仓储费</li>\n</ul>\n</li>\n<li>移除订单费<br />\n对于无法销售的产品，卖家自然会选择撤单，通常，搬迁令将在 14 个工作日内处理。然而，在假日季节和搬迁高峰期，处理搬迁订单可能需要 30 个工作日或更长时间。<br />\n自 2020 年 2 月 18 日起，亚马逊将根据重量分段按件收取移除费用<br />\n<img data-src=\"2.png\" alt=\"移除订单费\" /></li>\n<li>退货处理费<br />\n该费用适用于亚马逊上的选定类别，提供免费的买家返回运输，实际上是返回到亚马逊运营中心。退货的手续费等于给定商品的总送货费。</li>\n<li>计划外服务费<br />\n对于运往亚马逊仓库的产品，亚马逊可以向卖家提供这些服务，如果他们没有经过适当的预处理或标签。这项服务按件收费。<br />\n自 2020 年起，2 月 18 日，亚马逊将可选的标签物流服务费用从 $ 0.20 提高到每个项目 $ 0.30。商品物流每件亚马逊计划亚马逊物流标签服务费为 $ 0.10。</li>\n</ol>\n<h2 id=\"fba特点\"><a class=\"anchor\" href=\"#fba特点\">#</a> FBA 特点</h2>\n<p>优点:</p>\n<ol>\n<li>提高 Listing 排名，帮助卖家成为特色卖家，抢夺购物车，提 高客户的信任度，提高销售额。</li>\n<li>多年丰富的物流经验，仓库遍布全世界，智能化管理。</li>\n<li>配送时效超快 (仓库大多靠近机场)</li>\n<li>7*24 亚马逊专业客服。</li>\n<li>抹掉由物流引起的差评纠纷 。</li>\n<li>对单价超过 300USD 的产品免除所有 FBA 物流费用。<br />\n缺点:</li>\n<li>一般来说费用比国内发货稍微偏高（特别是非亚马逊平台的 FBA 发货），但是也要看产品重量来定夺。</li>\n<li>灵活性差 （所有海外仓的共同短板，但其他第三方海外仓还是可以有专门的中文客服来处理一些问题，FBA 却只能用英文和客户沟通，而且用邮件沟通回复不会向第三方海外仓客服那么及时）。</li>\n<li>FBA 仓库不会为卖家的头程发货提供清关服务。</li>\n<li>如果前期工作没做好，标签扫描出问题会影响货物入库，甚至入不了库。</li>\n<li>退货地址只支持美国 （如果您是做美国站点的 FBA）。</li>\n<li>客户想退货就可以退货不需要跟 FBA 有太多的沟通（退货太随意，给卖家带来不少困扰）。</li>\n</ol>\n<h1 id=\"sfp\"><a class=\"anchor\" href=\"#sfp\">#</a> SFP</h1>\n<h2 id=\"什么第三方海外仓sfp\"><a class=\"anchor\" href=\"#什么第三方海外仓sfp\">#</a> 什么第三方海外仓 (SFP)</h2>\n<p>海外仓，即海外仓储服务。由网络外贸交易平台、物流服务商独立或共同为卖家在销售目标地提供的货品仓储、分拣、包装、派送的一站式控制与管理服务。卖家将货物存储到当地仓库，当买家有需求时，第一时间做出快速响应，及时进行货物的分拣、包装以及递送</p>\n<h2 id=\"sfp费用\"><a class=\"anchor\" href=\"#sfp费用\">#</a> SFP 费用</h2>\n<p>不同海外仓不尽相同哦</p>\n<h2 id=\"sfp特点\"><a class=\"anchor\" href=\"#sfp特点\">#</a> SFP 特点</h2>\n<ul>\n<li>优点：\n<ol>\n<li>它可以给卖家提供头程清关服务，有的甚至还会有包含代缴税金、派送到仓的一条龙服务。海外仓和 FBA 一样，需要提前备货到海外仓库。但是相对于 FBA 来说，海外仓是可以提供头程清关服务的。</li>\n<li>更低的仓储物流成本。它也可以提供货品仓储、分拣、包装、派送的一条龙服务，综合费用成本比 FBA 低很多。</li>\n<li>灵活性相对 FBA 会强很多。第三方海外仓一般都是和国内物流商合作的，国外仓库都有华人驻守，沟通处理起来方便快捷。海外仓没有平台限制，无论在哪个平台售卖，都可以使用海外仓。</li>\n<li>海外中转。它还可以作为海外中转仓库，特别是旺季时候有些卖家出现亚马逊平台断货，如果海外仓有货，可以直接从海外仓调拨到 FBA 仓，节省从国内发货的时间，及时补足库存。</li>\n<li>关于退换货产品，如无质量问题，海外仓可重新更换标签或者重新包装，再次上架销售，减少损失。</li>\n<li>对于产品的限制和包装要求没有那么严格。相对于 FBA 来说，它对于产品的限制和包装没有那么严格，而且对于外箱有破损的，海外仓还可以帮忙换箱，不过要收费。</li>\n</ol>\n</li>\n<li>缺点:\n<ol>\n<li>缺点亚马逊的支持</li>\n<li>缺乏售后与投诉服务</li>\n</ol>\n</li>\n</ul>\n<h1 id=\"自发货fbm\"><a class=\"anchor\" href=\"#自发货fbm\">#</a> 自发货 (FBM)</h1>\n<h2 id=\"什么是fbm\"><a class=\"anchor\" href=\"#什么是fbm\">#</a> 什么是 FBM</h2>\n<p>配送问题一直是亚马逊卖家们纠结的一个点。人人都知道选择 FBA 发货是非常有优势的，不仅仅效率快而且对于亚马逊的友好度也是极具加深。但这个虽然好，偏偏它的成本价是很多卖家都难以接受的，实在是有点过高。相对于一些业绩惨淡、新手卖家而言，这样高的成本对他们而言，简直就是捉襟见肘。在这样的情况下，很多卖家就只能选择自发货的形式。目前亚马逊卖家主要采用的自发货形式主要有邮政、快递、专线这三种物流分类：<br />\n1. 邮政：邮政包裹的网络渠道遍布全球，比其他物流方式的覆盖面更广，对于一般的跨境电商平台亚马逊中小卖家而言，2 公斤以下的产品可选用邮政小包，2 公斤以上的产品用邮政大包，当然一些情况下也可以考虑 EMS 或者 E 邮包。<br />\n2. 快递渠道：主要指 DHL、TNT、FedEx 和 UPS 四大巨头，还有顺丰、四通一达等，其中四大巨头的速度和服务无可挑剔，但价格也偏贵，一般的商家很难承受。它们自建全球网络，进行世界各地的本地化物流服务，可以把货运到全球大多数的国家和地区，并且在官网能得到实时的物流追踪信息。另外，快递渠道对于产品本身还有一定的要求和限制，含电的、仿牌的、特殊类的产品基本上是无法实现递送的，适用于货值较高、客户要求时效性，2kg 以上的货物。<br />\n3. 专线物流：跨境专线物流的模式通常是，集中大批量货物发往目的地，通过规模效应降低成本，是针对某个国家或地区的快递公司的自主渠道，如中东、美国、俄罗斯等。价格比商业快递低一些，但时效性也慢一些，目前比较著名的有燕文物流、中外运安迈世等，可以对包裹进行追踪，按具体的路线来收费，一般 4-7 个工作日可以到达。<br />\n小包、快递和专线的侧重点不同，不同的物流渠道在价格、稳定性、时效方面差异性很大，具体如何选择，还要看亚马逊卖家针对的客户群体，如国家地域、货物重量、货值多少、体积大小、产品的利润点都是会主要的影响因素。</p>\n<h2 id=\"fbm费用\"><a class=\"anchor\" href=\"#fbm费用\">#</a> FBM 费用</h2>\n<ul>\n<li>邮政：<br />\n跨境电商一般用邮政的 e 邮宝<br />\n截止 2020 年 5 月 23 日<br />\n邮政的 e 邮宝特快的价格如下：<br />\n<img data-src=\"3.png\" alt=\"\" /></li>\n<li>快递渠道<br />\n快递渠道基本上超过 150RMB/kg</li>\n<li>专线物流<br />\n截止 2020 年 5 月 23 日<br />\n云途物流价格如下：<br />\n<img data-src=\"4.png\" alt=\"\" /></li>\n</ul>\n<h2 id=\"综合比较\"><a class=\"anchor\" href=\"#综合比较\">#</a> 综合比较</h2>\n<ul>\n<li>邮政成本最低，到美国建议使用 EUB，可发 2kg 以内货物；</li>\n<li>快递时效最快，价格最贵，一般到美国 3-5 天，不过小件产品非常贵，建议 20kg 以上货物才便宜；快递的清关手续比较麻烦，海关可能会要求提供一些资料比较繁琐。</li>\n<li>国际专线一般到美国 7-9 天，价格比邮政略贵，但是远低于快递，适合产品价值高的产品，一般到美国 20kg 以内都还是不错的。</li>\n</ul>\n<p>时效（由快到慢）：快递 &lt; 专线 &lt; 邮政<br />\n价格（由低到高）：邮政 &lt; 专线 &lt; 快递</p>\n",
            "tags": [
                "跨境电商",
                "amazon"
            ]
        },
        {
            "id": "http://yrmlnf.coding-pages.com/%E8%B7%A8%E5%A2%83%E7%94%B5%E5%95%86/Amazon-2020%E5%BC%80%E5%BA%97%E6%88%90%E6%9C%AC/",
            "url": "http://yrmlnf.coding-pages.com/%E8%B7%A8%E5%A2%83%E7%94%B5%E5%95%86/Amazon-2020%E5%BC%80%E5%BA%97%E6%88%90%E6%9C%AC/",
            "title": "Amazon-2020开店成本",
            "date_published": "2020-05-22T14:50:51.000Z",
            "content_html": "<h1 id=\"注册帐号费用\"><a class=\"anchor\" href=\"#注册帐号费用\">#</a> 注册帐号费用</h1>\n<p>实际费用：0 元<br />\n首先，选择全球开店的注册方式有两种：招商经理通道和自注册通道，无论你选择哪种方式注册帐号，都是免费的。目前来说，比较多人偏向于选择使用招商经理通道注册</p>\n<h2 id=\"招商经理通道亚马逊全球开店\"><a class=\"anchor\" href=\"#招商经理通道亚马逊全球开店\">#</a> 招商经理通道 (亚马逊全球开店)</h2>\n<div class=\"note info\">\n<p>“亚马逊全球开店” 是亚马逊针对中国市场做的一个招商项目，是开店注册的一种方式。可以简单理解为中国公司级卖家在亚马逊平台开店。与之相对的，还有亚马逊自注册开店（个人卖家在亚马逊开店），在介绍全球开店相关内容之前，我们简单了解一下全球开店和自注册开店的不同及优劣。</p>\n</div>\n<ul>\n<li>优势<br />\n 1. 账号安全性高：封店率 &lt;9% (官方统计数据)。<br />\n2. 有对应的招商经理扶持：指导和监管卖家账户运营，帮助卖家解决操作中的问题，账户有小问题会提前预警，可以申请线下秒杀活动，有需要升舱的卖家也可以通过招商经理去完成。<br />\n3. 有官方的培训支持：包括后台操作培训 (单独刊登，批量刊登，跟卖，订单处理，客服处理，后台设置，报告解读) 如何提升销量，FBA 详解，最新政策，活动解读等。</li>\n<li>劣势\n<ol>\n<li>非常难申请:“全球开店” 计划意在筛选优质卖家入驻亚马逊平台，所以对卖家的资质审核比较严格，不是想入驻就可以入驻的。卖家自己申请 “全球开店” 通过率 5% 不到，一旦卖家自己申请全球开店没有通过，那么用于申请全球开店的那个公司不能再次用于全球开店的申请。</li>\n<li>周期非常长:“全球开店” 账号的注册周期一般是在两个多月左右。全球开店账号的注册周期一般是在 7-15 个工作日左右。（7-15 个工作日是指通过我们的招商经理链接进行注册的平均周期，卖家自己申请的话至少都是在三个月以上），一般情况下，所有站点的注册中，美国站的会相对来说比较快。</li>\n<li>监管非常严：经营全球开店账号，必须严格遵守亚马逊的平台规则，产品图片、标题格式等等都必须严格按照要求执行，否则会被警告。</li>\n</ol>\n</li>\n<li>公司级卖家为什么要选择招商经理通道注册？\n<ol>\n<li>账号注册上线辅导及为期一个自然年的扶持：招商经理会评估卖家的资料，给符合条件的卖家发送全球开店注册链接，并会给予卖家上线注册指导，一般而言，注册账号所需时间为 5-10 分钟即可。对于注册完成的账号，招商经理会安排上线经理进行产品信息审核，上线经理会告知卖家亚马逊对于产品图片是否涉及侵权，标题描述以及关键字的要求优化的指导和建议，同时卖家朋友在此过程中遇到任何操作问题，均可向上线经理求助。</li>\n<li>账户运营安全：对于亚马逊卖家而言，账号安全是最为看重的一点。亚马逊高度重视消费者的消费体验，致力于创造一个消费者安心消费的环境，从而对卖家进行严格的管理。不少卖家由于绩效表现不佳、侵权、消费者投诉描述不符或者假货投诉、或者账号关联等因素导致账号被封。账号被封，意味着前期培育的 ASIN，店铺累计的绩效付之东流，同时消费者任何的退款申请亚马逊将无条件支付，剩余金额 90 天后才会支付，所以对于卖家来讲，之前的精力，资金投入都会变成无用功。在这个点上，招商经理在卖家账户处于高危状态的时候会提醒卖家及时纠错或者撰写完整的改进计划、指导卖家发现问题并进行申诉。</li>\n<li>申请促销活动：Best deal (Z 划算) 和 Deal of the Day (镇店之宝) 是亚马逊站内少有的促销资源，亚马逊每日都会推出促销活动，促销活动对于卖家而言：一方面可以提升短期内的销量，一方面是提升自己品牌的曝光。而对于全球开店的卖家，只要符合 FBA 库存数目，销售价格以及店铺绩效等要求，即可通过招商经理申请。</li>\n<li>汽配类目开通 / KYC 审核提前 / 视频添加等：对于像汽配类目的开通可以通过招商经理提交申请开通；同时如果有欧洲站的卖家想被提前 KYC 审核，从而放心发货过去的这类型的卖家需求，招商经理可以帮助提交申请提前 KYC; 同时类似的还有对于一些还没有品牌备案但是有强烈添加视频需求的卖家，可以找招商经理提报，视频对于提升商品的购买转化率还是非常有帮助的！<br />\n当然招商经理的能力不仅仅是这些，如果您有新市场拓展计划，比如开通欧洲站、日本站等其他站点，有了招商经理的协助一定事半功倍，所以建议公司客户建议通过招商经理通道注册 “亚马逊全球开店”！</li>\n<li>如何联系亚马逊招商经理开店<br />\n亚马逊招商经理一般通过在信息征集的形式先对您的公司信息进行初步登记，然后初步筛选后然后会以邮件的形式为您发送注册链接，收到邮件后通过邮件的链接和提示一步步操作。</li>\n</ol>\n</li>\n</ul>\n<h2 id=\"自注册通道\"><a class=\"anchor\" href=\"#自注册通道\">#</a> 自注册通道</h2>\n<ul>\n<li>优势<br />\n个人就可以注册，注册周期比较快。账号注册快，在你的资料都没有任何问题的情况下，两小时之内就可以把账号开通。</li>\n<li>劣势\n<ol>\n<li>账号安全性低，封店率 &gt; 56% (官方统计数据)，即便是被 review 也不会有任何的预警和帮助</li>\n<li>没有客户经理很难申报秒杀活动，除非这个自注册卖家店铺绩效非常的高，是个大卖家才会收到亚马逊的申请邀请，否则一般是无法参加的</li>\n<li>无官方培训支持普通卖家账户</li>\n</ol>\n</li>\n</ul>\n<h1 id=\"亚马逊促销计划\"><a class=\"anchor\" href=\"#亚马逊促销计划\">#</a> 亚马逊促销计划</h1>\n<p>亚马逊全球开店有两种销售计划，专业销售计划 (Professional)，个人销售计划 (Individual)。需要强调的是，“专业” 和 “个人” 销售计划并不等同于公司和个人，不论公司还是个人身份，都可以开立这两种计划。<br />\n而这两种计划的收费标准如下：<br />\n专业销售计划：费用 = 月租金 + 销售佣金<br />\n个人销售计划：费用 = 按件收费 + 销售佣金<br />\n另外，亚马逊分为北美站点、欧洲站点、日本站点三部分，站点不同，开店费用也不尽相同。</p>\n<ol>\n<li>北美站点<br />\n<img data-src=\"1.png\" alt=\"北美站点\" /><br />\n 2. 欧洲站点<br />\n<img data-src=\"2.png\" alt=\"北美站点\" /><br />\n 3. 日本站点<br />\n<img data-src=\"3.png\" alt=\"北美站点\" /></li>\n</ol>\n<h1 id=\"ppccpc站内推广费用\"><a class=\"anchor\" href=\"#ppccpc站内推广费用\">#</a> PPC/CPC 站内推广费用</h1>\n<p>在一定范围内，出价越高，排在前面的可能性会越大，但是有一个限度的。竞价只是次要因素，永远不会是主流。任何搜索引擎与平台，只会将最优先，对消费者最有利的产品优先展示出来。所谓花钱购买的流量，永远排在次位的。<br />\n后台广告促销管理中可以查看到每个关键词的预测竞价与每次点击费用。CPC 的点击价格是由第二名的出价 + 第一名与第二名之间差价的百分比 + 你的表现，综合得出的。</p>\n<h1 id=\"商标注册和品牌备案费用\"><a class=\"anchor\" href=\"#商标注册和品牌备案费用\">#</a> 商标注册和品牌备案费用</h1>\n<p>目前来讲，亚马逊并没有强制要求卖家必须要做品牌备案。但之前爆发的 Generic 商标侵权事件可以看出，品牌备案对卖家很具有保护作用。小美建议大家的是，假如你的经济状况允许，可以在店铺起步时就将商标注册和品牌备案，但如果经济状况不允许，可以在后期，即店铺做起来的再做考虑。<br />\n由于商标是地域性保护的，美国商标只在美国受保护，欧盟的商标只在欧盟受到保护，不需要每个站点都申请，这个可以代理公司代办，并且可以帮助大家申请到补贴福利。</p>\n<h2 id=\"欧洲站vat增值税\"><a class=\"anchor\" href=\"#欧洲站vat增值税\">#</a> 欧洲站 VAT 增值税</h2>\n<p>亚马逊 VAT 是什么意思呢？VAT 全称是 VALUE ADDED TAX，是欧盟国家普遍使用的售后增值税，即货物售价的利润税。当卖家销售的产品进入英国，产品需要缴纳进口税，当产品销售完成后，卖家可以退回进口增值税，再按销售额缴纳相应的销售税。<br />\n非欧洲站无此费用</p>\n<h1 id=\"合计成本\"><a class=\"anchor\" href=\"#合计成本\">#</a> 合计成本</h1>\n<table>\n<thead>\n<tr>\n<th></th>\n<th>项目</th>\n<th>中国公司账号</th>\n<th>美国公司账号</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>前期准备费用</td>\n<td>设施</td>\n<td>专用电脑、路由、网络、打印机等费用</td>\n<td>专用电脑、路由、网络、打印机等费用</td>\n</tr>\n<tr>\n<td></td>\n<td>公司代注册</td>\n<td>例：深圳公司 1500 元左右</td>\n<td>美国公司 4500 元左右（科罗拉多州为例）</td>\n</tr>\n<tr>\n<td></td>\n<td>税号代办</td>\n<td>直接填写 W-8 免税税号</td>\n<td>2500 元左右</td>\n</tr>\n<tr>\n<td></td>\n<td>VISA 或 MASTER 双币信用卡</td>\n<td>0</td>\n<td>0</td>\n</tr>\n<tr>\n<td></td>\n<td>收款账户办理费用</td>\n<td>视不同收款账户而不同，最低 0</td>\n<td>视不同收款账户而不同，最低 0</td>\n</tr>\n<tr>\n<td>后续运营费用</td>\n<td>公司维护费用</td>\n<td>做账报税零申报 2000 元左右 / 年 如需缴税看具体情况</td>\n<td>年审 + 零报税 3500 元左右 / 年一般没有开美国银行账户，可以零报税，如需缴税看具体情况</td>\n</tr>\n<tr>\n<td></td>\n<td>亚马逊平台月租费</td>\n<td>0 或者 39.9$</td>\n<td>0 或者 39.9$</td>\n</tr>\n<tr>\n<td></td>\n<td>亚马逊销售佣金</td>\n<td>统一按亚马逊标准收取，不同品类不一样，非媒介类产品一般为订单总金额（包括商品价格、运费、礼品包装费）的 8%-15%（媒介类产品为商品价格的 8%-15%），最低为 6%, 最高到 50%，一些品类还有最低销售佣金限制</td>\n<td>非媒介类产品一般为订单总金额（包括商品价格、运费、礼品包装费）的 8%-15%（媒介类产品为商品价格的 8%-15%），最低为 6%, 最高到 50%，一些品类还有最低销售佣金限制。统一按亚马逊标准收取，不同品类不一样，非媒介类产品一般为订单总金额（包括商品价格、运费、礼品包装费）的 8%-15%（媒介类产品为商品价格的 8%-15%），最低为 6%, 最高到 50%，一些品类还有最低销售佣金限制</td>\n</tr>\n<tr>\n<td></td>\n<td>亚马逊交易手续费（仅针对媒介类产品）</td>\n<td>$1.35 / 每件</td>\n<td>$1.35 / 每件</td>\n</tr>\n<tr>\n<td></td>\n<td>亚马逊大批量商品费用 (非媒介商品 SKU 超过 200 万时收取)</td>\n<td>超过 200 万部分，每个收费 $0.0005</td>\n<td>超过 200 万部分，每个收费 $0.0005</td>\n</tr>\n<tr>\n<td></td>\n<td>亚马逊退款管理费 (退款后，亚马逊返还佣金时收取)</td>\n<td>$5.00 和销售佣金的 20% 的较低者</td>\n<td>$5.00 和销售佣金的 20% 的较低者</td>\n</tr>\n<tr>\n<td></td>\n<td>从美国亚马逊收款后转回国内银行卡的费用（转不转试需求而定）</td>\n<td>视不同收款账户而不同，例 WF 卡是 1%-2.5%</td>\n<td>视不同收款账户而不同，例 WF 卡是 1%-2.5%</td>\n</tr>\n<tr>\n<td></td>\n<td>税务</td>\n<td>填写 W-8BEN 表格，免税</td>\n<td>填写 W-9 表格，非美国银行卡收款，可以做到零报税</td>\n</tr>\n<tr>\n<td></td>\n<td>物流仓储</td>\n<td>视具体情况而定，你可选择 FBA，也可自行发货</td>\n<td>视具体情况而定，你可选择 FBA，也可自行发货</td>\n</tr>\n<tr>\n<td></td>\n<td>营销广告</td>\n<td>实时竞价，按每次点击收费 (CPC)。只展示，不点击，不收费</td>\n<td>实时竞价，按每次点击收费 (CPC)。只展示，不点击，不收费</td>\n</tr>\n<tr>\n<td></td>\n<td>产品</td>\n<td>产品成本及库存费用等</td>\n<td>产品成本及库存费用等</td>\n</tr>\n<tr>\n<td></td>\n<td>人员</td>\n<td>人力成本</td>\n<td>人力成本</td>\n</tr>\n</tbody>\n</table>\n<p>预估计最低成本:</p>\n<ul>\n<li>注册公司：1500￥</li>\n<li>代理记账：2000￥<br />\n大概 3500.</li>\n</ul>\n",
            "tags": [
                "跨境电商",
                "amazon"
            ]
        },
        {
            "id": "http://yrmlnf.coding-pages.com/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/%E5%A4%A7%E6%95%B0%E6%8D%AE/%E6%95%B0%E6%8D%AE%E5%8F%AF%E8%A7%86%E5%8C%96/Superset-%E9%9B%86%E6%88%90Echarts%E5%9C%B0%E5%9B%BE/",
            "url": "http://yrmlnf.coding-pages.com/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/%E5%A4%A7%E6%95%B0%E6%8D%AE/%E6%95%B0%E6%8D%AE%E5%8F%AF%E8%A7%86%E5%8C%96/Superset-%E9%9B%86%E6%88%90Echarts%E5%9C%B0%E5%9B%BE/",
            "title": "Superset-集成Echarts地图",
            "date_published": "2020-05-21T02:19:08.000Z",
            "content_html": "<h1 id=\"操作系统\"><a class=\"anchor\" href=\"#操作系统\">#</a> 操作系统</h1>\n<ul class=\"task-list\">\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_0\" checked=\"true\" disabled=\"true\" /><label for=\"cbx_0\">  Windows</label></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_1\" checked=\"true\" disabled=\"true\" /><label for=\"cbx_1\">  MAC</label></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_2\" checked=\"true\" disabled=\"true\" /><label for=\"cbx_2\">  Linux</label></li>\n</ul>\n<h1 id=\"软件依赖\"><a class=\"anchor\" href=\"#软件依赖\">#</a> 软件依赖</h1>\n<p><span class=\"label info\">^ Lastest</span> <span class=\"label info\">~ minimum</span></p>\n<ul>\n<li>Python3.6~</li>\n<li>Pip~</li>\n<li>node.js~</li>\n</ul>\n<h1 id=\"实验环境\"><a class=\"anchor\" href=\"#实验环境\">#</a> 实验环境</h1>\n<ul>\n<li>Windows10</li>\n<li>python 3.68</li>\n<li>pip 19.2.3</li>\n<li>setuptools 41.4.0</li>\n<li>nodejs 12.15.0</li>\n<li>npm 6.134</li>\n<li>superset 0.35</li>\n</ul>\n<h1 id=\"前端开发\"><a class=\"anchor\" href=\"#前端开发\">#</a> 前端开发</h1>\n<ol>\n<li>在 visualizations 文件夹下创建 EchartsMapChina 文件夹<br />\n<img data-src=\"1.png\" alt=\"\" /></li>\n<li>在 images 文件夹里面放入图表的缩略图，可以自己去 echarts 官网截图然后放进去，名字不能更改</li>\n<li>创建 index.js</li>\n</ol>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token punctuation\">&#123;</span> t <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'@superset-ui/translation'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token punctuation\">&#123;</span> ChartMetadata<span class=\"token punctuation\">,</span> ChartPlugin <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'@superset-ui/chart'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">import</span> transformProps <span class=\"token keyword\">from</span> <span class=\"token string\">'./transformProps'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">import</span> thumbnail <span class=\"token keyword\">from</span> <span class=\"token string\">'./images/thumbnail.png'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">const</span> metadata <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ChartMetadata</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  name<span class=\"token operator\">:</span> <span class=\"token function\">t</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Echart China Map'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  description<span class=\"token operator\">:</span> <span class=\"token string\">''</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  credits<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'http://echarts.baidu.com/examples/editor.html?c=scatter-effect'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  thumbnail<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">TimeSeriesScatterChartPlugin</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">ChartPlugin</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  <span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token keyword\">super</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>      metadata<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      transformProps<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      <span class=\"token function-variable function\">loadChart</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">import</span><span class=\"token punctuation\">(</span><span class=\"token string\">'./ReactEchartsChinaMap.js'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><ol start=\"4\">\n<li>transformProps.js</li>\n</ol>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> <span class=\"token keyword\">function</span> <span class=\"token function\">transformProps</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">chartProps</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> width<span class=\"token punctuation\">,</span> height<span class=\"token punctuation\">,</span> queryData<span class=\"token punctuation\">,</span> formData <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> chartProps<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token comment\">//console.log (chartProps); 可以用来验证数据是否正确</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    data<span class=\"token operator\">:</span> queryData<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    width<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    height<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    formData<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    toolTip<span class=\"token operator\">:</span> queryData<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>toolTip<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    series<span class=\"token operator\">:</span> queryData<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    maxMetrics<span class=\"token operator\">:</span> queryData<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>max<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><ol start=\"5\">\n<li>创建 ReactEchartsChinaMap.js</li>\n</ol>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token punctuation\">&#123;</span> reactify <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'@superset-ui/chart'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">import</span> Component <span class=\"token keyword\">from</span> <span class=\"token string\">'./EchartsChinaMap'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> <span class=\"token function\">reactify</span><span class=\"token punctuation\">(</span>Component<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><ol start=\"6\">\n<li>创建 EchartsChinaMap.js<br />\n 注释内容是一些额外的样式，可以去掉也可以打开</li>\n</ol>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">import</span> d3 <span class=\"token keyword\">from</span> <span class=\"token string\">'d3'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">import</span> PropTypes <span class=\"token keyword\">from</span> <span class=\"token string\">'prop-types'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token punctuation\">&#123;</span> CategoricalColorNamespace <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'@superset-ui/color'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token punctuation\">&#123;</span> getNumberFormatter <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'@superset-ui/number-format'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token string\">'./EchartsChinaMap.css'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">import</span> echarts <span class=\"token keyword\">from</span> <span class=\"token string\">'echarts'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">import</span> china <span class=\"token keyword\">from</span> <span class=\"token string\">'echarts/map/json/china.json'</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">const</span> propTypes <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  data<span class=\"token operator\">:</span> PropTypes<span class=\"token punctuation\">.</span>array<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  width<span class=\"token operator\">:</span> PropTypes<span class=\"token punctuation\">.</span>number<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  height<span class=\"token operator\">:</span> PropTypes<span class=\"token punctuation\">.</span>number<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span> </pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token keyword\">function</span> <span class=\"token function\">EchartsChinaMap</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">element<span class=\"token punctuation\">,</span> props</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>         width<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>         height<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>         data<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>         formData<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>         series<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>         toolTip<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>         maxMetrics<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>     <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> props<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token comment\">// var mapData = [</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    <span class=\"token comment\">//     &#123;name:\"北京\",value:1199&#125;,</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    <span class=\"token comment\">//     &#123;name:\"天津\",value:42&#125;,</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    <span class=\"token comment\">//     &#123;name:\"河北\",value:102&#125;,</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    <span class=\"token comment\">//     &#123;name:\"山西\",value:81&#125;,</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    <span class=\"token comment\">//     &#123;name:\"内蒙古\",value:47&#125;,</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    <span class=\"token comment\">//     &#123;name:\"辽宁\",value:67&#125;,</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    <span class=\"token comment\">//     &#123;name:\"吉林\",value:82&#125;,</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    <span class=\"token comment\">//     &#123;name:\"黑龙江\",value:123&#125;,</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    <span class=\"token comment\">//     &#123;name:\"上海\",value:24&#125;,</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>    <span class=\"token comment\">//     &#123;name:\"江苏\",value:92&#125;,</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>    <span class=\"token comment\">//     &#123;name:\"浙江\",value:114&#125;,</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    <span class=\"token comment\">//     &#123;name:\"安徽\",value:109&#125;,</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>    <span class=\"token comment\">//     &#123;name:\"福建\",value:116&#125;,</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>    <span class=\"token comment\">//     &#123;name:\"江西\",value:91&#125;,</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    <span class=\"token comment\">//     &#123;name:\"山东\",value:119&#125;,</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>    <span class=\"token comment\">//     &#123;name:\"河南\",value:137&#125;,</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>    <span class=\"token comment\">//     &#123;name:\"湖北\",value:116&#125;,</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>    <span class=\"token comment\">//     &#123;name:\"湖南\",value:114&#125;,</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>    <span class=\"token comment\">//     &#123;name:\"重庆\",value:91&#125;,</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>    <span class=\"token comment\">//     &#123;name:\"四川\",value:125&#125;,</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>    <span class=\"token comment\">//     &#123;name:\"贵州\",value:62&#125;,</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>    <span class=\"token comment\">//     &#123;name:\"云南\",value:83&#125;,</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>    <span class=\"token comment\">//     &#123;name:\"西藏\",value:9&#125;,</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>    <span class=\"token comment\">//     &#123;name:\"陕西\",value:80&#125;,</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>    <span class=\"token comment\">//     &#123;name:\"甘肃\",value:56&#125;,</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>    <span class=\"token comment\">//     &#123;name:\"青海\",value:10&#125;,</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>    <span class=\"token comment\">//     &#123;name:\"宁夏\",value:18&#125;,</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>    <span class=\"token comment\">//     &#123;name:\"新疆\",value:180&#125;,</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>    <span class=\"token comment\">//     &#123;name:\"广东\",value:123&#125;,</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>    <span class=\"token comment\">//     &#123;name:\"广西\",value:59&#125;,</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>    <span class=\"token comment\">//     &#123;name:\"海南\",value:14&#125;,</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>    <span class=\"token comment\">//     ];</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>    <span class=\"token comment\">// var toolTipData = [</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>    <span class=\"token comment\">//     &#123;name:\"北京\",value:[&#123;name:\"科技人才总数\",value:95&#125;,&#123;name:\"理科\",value:82&#125;]&#125;,</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>    <span class=\"token comment\">//     &#123;name:\"天津\",value:[&#123;name:\"文科\",value:22&#125;,&#123;name:\"理科\",value:20&#125;]&#125;,</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>    <span class=\"token comment\">//     &#123;name:\"河北\",value:[&#123;name:\"文科\",value:60&#125;,&#123;name:\"理科\",value:42&#125;]&#125;,</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>    <span class=\"token comment\">//     &#123;name:\"山西\",value:[&#123;name:\"文科\",value:40&#125;,&#123;name:\"理科\",value:41&#125;]&#125;,</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>    <span class=\"token comment\">//     &#123;name:\"内蒙古\",value:[&#123;name:\"文科\",value:23&#125;,&#123;name:\"理科\",value:24&#125;]&#125;,</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>    <span class=\"token comment\">//     &#123;name:\"辽宁\",value:[&#123;name:\"文科\",value:39&#125;,&#123;name:\"理科\",value:28&#125;]&#125;,</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>    <span class=\"token comment\">//     &#123;name:\"吉林\",value:[&#123;name:\"文科\",value:41&#125;,&#123;name:\"理科\",value:41&#125;]&#125;,</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>    <span class=\"token comment\">//     &#123;name:\"黑龙江\",value:[&#123;name:\"文科\",value:35&#125;,&#123;name:\"理科\",value:31&#125;]&#125;,</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>    <span class=\"token comment\">//     &#123;name:\"上海\",value:[&#123;name:\"文科\",value:12&#125;,&#123;name:\"理科\",value:12&#125;]&#125;,</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>    <span class=\"token comment\">//     &#123;name:\"江苏\",value:[&#123;name:\"文科\",value:47&#125;,&#123;name:\"理科\",value:45&#125;]&#125;,</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>    <span class=\"token comment\">//     &#123;name:\"浙江\",value:[&#123;name:\"文科\",value:57&#125;,&#123;name:\"理科\",value:57&#125;]&#125;,</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>    <span class=\"token comment\">//     &#123;name:\"安徽\",value:[&#123;name:\"文科\",value:57&#125;,&#123;name:\"理科\",value:52&#125;]&#125;,</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>    <span class=\"token comment\">//     &#123;name:\"福建\",value:[&#123;name:\"文科\",value:59&#125;,&#123;name:\"理科\",value:57&#125;]&#125;,</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>    <span class=\"token comment\">//     &#123;name:\"江西\",value:[&#123;name:\"文科\",value:49&#125;,&#123;name:\"理科\",value:42&#125;]&#125;,</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>    <span class=\"token comment\">//     &#123;name:\"山东\",value:[&#123;name:\"文科\",value:67&#125;,&#123;name:\"理科\",value:52&#125;]&#125;,</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>    <span class=\"token comment\">//     &#123;name:\"河南\",value:[&#123;name:\"文科\",value:69&#125;,&#123;name:\"理科\",value:68&#125;]&#125;,</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>    <span class=\"token comment\">//     &#123;name:\"湖北\",value:[&#123;name:\"文科\",value:60&#125;,&#123;name:\"理科\",value:56&#125;]&#125;,</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>    <span class=\"token comment\">//     &#123;name:\"湖南\",value:[&#123;name:\"文科\",value:62&#125;,&#123;name:\"理科\",value:52&#125;]&#125;,</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>    <span class=\"token comment\">//     &#123;name:\"重庆\",value:[&#123;name:\"文科\",value:47&#125;,&#123;name:\"理科\",value:44&#125;]&#125;,</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>    <span class=\"token comment\">//     &#123;name:\"四川\",value:[&#123;name:\"文科\",value:65&#125;,&#123;name:\"理科\",value:60&#125;]&#125;,</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>    <span class=\"token comment\">//     &#123;name:\"贵州\",value:[&#123;name:\"文科\",value:32&#125;,&#123;name:\"理科\",value:30&#125;]&#125;,</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>    <span class=\"token comment\">//     &#123;name:\"云南\",value:[&#123;name:\"文科\",value:42&#125;,&#123;name:\"理科\",value:41&#125;]&#125;,</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>    <span class=\"token comment\">//     &#123;name:\"西藏\",value:[&#123;name:\"文科\",value:5&#125;,&#123;name:\"理科\",value:4&#125;]&#125;,</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>    <span class=\"token comment\">//     &#123;name:\"陕西\",value:[&#123;name:\"文科\",value:38&#125;,&#123;name:\"理科\",value:42&#125;]&#125;,</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>    <span class=\"token comment\">//     &#123;name:\"甘肃\",value:[&#123;name:\"文科\",value:28&#125;,&#123;name:\"理科\",value:28&#125;]&#125;,</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>    <span class=\"token comment\">//     &#123;name:\"青海\",value:[&#123;name:\"文科\",value:5&#125;,&#123;name:\"理科\",value:5&#125;]&#125;,</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>    <span class=\"token comment\">//     &#123;name:\"宁夏\",value:[&#123;name:\"文科\",value:10&#125;,&#123;name:\"理科\",value:8&#125;]&#125;,</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>    <span class=\"token comment\">//     &#123;name:\"新疆\",value:[&#123;name:\"文科\",value:36&#125;,&#123;name:\"理科\",value:31&#125;]&#125;,</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>    <span class=\"token comment\">//     &#123;name:\"广东\",value:[&#123;name:\"文科\",value:63&#125;,&#123;name:\"理科\",value:60&#125;]&#125;,</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>    <span class=\"token comment\">//     &#123;name:\"广西\",value:[&#123;name:\"文科\",value:29&#125;,&#123;name:\"理科\",value:30&#125;]&#125;,</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>    <span class=\"token comment\">//     &#123;name:\"海南\",value:[&#123;name:\"文科\",value:8&#125;,&#123;name:\"理科\",value:6&#125;]&#125;,</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>    <span class=\"token comment\">// \t  &#123;name:\"青海\",value:[&#123;name:\"文科\",value:8&#125;,&#123;name:\"理科\",value:6&#125;]&#125;,</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>    <span class=\"token comment\">// ];</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>  element<span class=\"token punctuation\">.</span>innerHTML <span class=\"token operator\">=</span> <span class=\"token string\">''</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre></pre></td></tr><tr><td data-num=\"95\"></td><td><pre>  <span class=\"token keyword\">const</span> div <span class=\"token operator\">=</span> d3<span class=\"token punctuation\">.</span><span class=\"token function\">select</span><span class=\"token punctuation\">(</span>element<span class=\"token punctuation\">,</span> props<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>  <span class=\"token keyword\">var</span> html <span class=\"token operator\">=</span> <span class=\"token string\">'&lt;div id=\"myChart\" style=\"height:'</span> <span class=\"token operator\">+</span> height <span class=\"token operator\">+</span> <span class=\"token string\">'px; width:'</span> <span class=\"token operator\">+</span> width <span class=\"token operator\">+</span> <span class=\"token string\">'px;\">&lt;/div>'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre>  div<span class=\"token punctuation\">.</span><span class=\"token function\">html</span><span class=\"token punctuation\">(</span>html<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 给 echarts 添加 div</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre>  <span class=\"token keyword\">var</span> myChart <span class=\"token operator\">=</span> echarts<span class=\"token punctuation\">.</span><span class=\"token function\">init</span><span class=\"token punctuation\">(</span>document<span class=\"token punctuation\">.</span><span class=\"token function\">getElementById</span><span class=\"token punctuation\">(</span><span class=\"token string\">'myChart'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 初始化 echarts</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre>  echarts<span class=\"token punctuation\">.</span><span class=\"token function\">registerMap</span><span class=\"token punctuation\">(</span><span class=\"token string\">'china'</span><span class=\"token punctuation\">,</span>china<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"100\"></td><td><pre>  <span class=\"token keyword\">var</span> mapName <span class=\"token operator\">=</span> <span class=\"token string\">'china'</span></pre></td></tr><tr><td data-num=\"101\"></td><td><pre>  <span class=\"token keyword\">var</span> geoCoordMap <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"102\"></td><td><pre>  <span class=\"token keyword\">const</span> fd <span class=\"token operator\">=</span> formData</pre></td></tr><tr><td data-num=\"103\"></td><td><pre>    <span class=\"token comment\">// 为了适配颜色</span></pre></td></tr><tr><td data-num=\"104\"></td><td><pre>    <span class=\"token keyword\">const</span> colorList <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"105\"></td><td><pre>        <span class=\"token constant\">DEFAULT</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'#15a8fe'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'rgba(21,168,254,0.31)'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'#FFFF00'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"106\"></td><td><pre>        <span class=\"token constant\">SUPERSET_DEFAULT</span><span class=\"token operator\">:</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"#f6efa6\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#d88273\"</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"#bf444c\"</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"#15a8fe\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"107\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"108\"></td><td><pre>    <span class=\"token keyword\">var</span> colors <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"109\"></td><td><pre></pre></td></tr><tr><td data-num=\"110\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>fd<span class=\"token punctuation\">.</span>echartsColorScheme<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"111\"></td><td><pre>        colors <span class=\"token operator\">=</span> colorList<span class=\"token punctuation\">[</span>fd<span class=\"token punctuation\">.</span>echartsColorScheme<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"112\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token keyword\">else</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"113\"></td><td><pre>        colors <span class=\"token operator\">=</span> colorList<span class=\"token punctuation\">[</span><span class=\"token string\">\"DEFAULT\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"114\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"115\"></td><td><pre></pre></td></tr><tr><td data-num=\"116\"></td><td><pre>  <span class=\"token comment\">/* 获取地图数据 */</span></pre></td></tr><tr><td data-num=\"117\"></td><td><pre>  myChart<span class=\"token punctuation\">.</span><span class=\"token function\">showLoading</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"118\"></td><td><pre>  <span class=\"token keyword\">var</span> mapFeatures <span class=\"token operator\">=</span> echarts<span class=\"token punctuation\">.</span><span class=\"token function\">getMap</span><span class=\"token punctuation\">(</span>mapName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>geoJson<span class=\"token punctuation\">.</span>features<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"119\"></td><td><pre>  myChart<span class=\"token punctuation\">.</span><span class=\"token function\">hideLoading</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"120\"></td><td><pre>  mapFeatures<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">v</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"121\"></td><td><pre>      <span class=\"token comment\">// 地区名称</span></pre></td></tr><tr><td data-num=\"122\"></td><td><pre>      <span class=\"token keyword\">var</span> name <span class=\"token operator\">=</span> v<span class=\"token punctuation\">.</span>properties<span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"123\"></td><td><pre>      <span class=\"token comment\">// 地区经纬度</span></pre></td></tr><tr><td data-num=\"124\"></td><td><pre>      geoCoordMap<span class=\"token punctuation\">[</span>name<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> v<span class=\"token punctuation\">.</span>properties<span class=\"token punctuation\">.</span>cp<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"125\"></td><td><pre></pre></td></tr><tr><td data-num=\"126\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"127\"></td><td><pre>  <span class=\"token keyword\">var</span> max <span class=\"token operator\">=</span> <span class=\"token number\">480</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"128\"></td><td><pre>      min <span class=\"token operator\">=</span> <span class=\"token number\">9</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// todo </span></pre></td></tr><tr><td data-num=\"129\"></td><td><pre>  <span class=\"token keyword\">var</span> maxSize4Pin <span class=\"token operator\">=</span> <span class=\"token number\">100</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"130\"></td><td><pre>      minSize4Pin <span class=\"token operator\">=</span> <span class=\"token number\">20</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"131\"></td><td><pre></pre></td></tr><tr><td data-num=\"132\"></td><td><pre>  <span class=\"token keyword\">var</span> <span class=\"token function-variable function\">convertData</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">data</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"133\"></td><td><pre>      <span class=\"token keyword\">var</span> res <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"134\"></td><td><pre>      <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">var</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> data<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"135\"></td><td><pre></pre></td></tr><tr><td data-num=\"136\"></td><td><pre>          <span class=\"token keyword\">var</span> geoCoord <span class=\"token operator\">=</span> geoCoordMap<span class=\"token punctuation\">[</span>data<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"137\"></td><td><pre>          <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>geoCoord<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"138\"></td><td><pre>              res<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"139\"></td><td><pre>                  name<span class=\"token operator\">:</span> data<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"140\"></td><td><pre>                  value<span class=\"token operator\">:</span> geoCoord<span class=\"token punctuation\">.</span><span class=\"token function\">concat</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"141\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"142\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"143\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"144\"></td><td><pre></pre></td></tr><tr><td data-num=\"145\"></td><td><pre>      <span class=\"token keyword\">return</span> res<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"146\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"147\"></td><td><pre> <span class=\"token keyword\">var</span> visualMap <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span></pre></td></tr><tr><td data-num=\"148\"></td><td><pre> <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>fd<span class=\"token punctuation\">.</span>echartsChinaVisualMap<span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"149\"></td><td><pre>     visualMap <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"150\"></td><td><pre>          show<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"151\"></td><td><pre>          min<span class=\"token operator\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"152\"></td><td><pre>          max<span class=\"token operator\">:</span> maxMetrics<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"153\"></td><td><pre>          left<span class=\"token operator\">:</span> <span class=\"token string\">'10%'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"154\"></td><td><pre>          top<span class=\"token operator\">:</span> <span class=\"token string\">'bottom'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"155\"></td><td><pre>          calculable<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"156\"></td><td><pre>          seriesIndex<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"157\"></td><td><pre>          inRange<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"158\"></td><td><pre>              color<span class=\"token operator\">:</span>colors<span class=\"token punctuation\">.</span><span class=\"token function\">slice</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span>colors<span class=\"token punctuation\">.</span>length<span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"159\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"160\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"161\"></td><td><pre> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"162\"></td><td><pre> <span class=\"token keyword\">var</span> option <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"163\"></td><td><pre>      tooltip<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"164\"></td><td><pre>          padding<span class=\"token operator\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"165\"></td><td><pre>          <span class=\"token comment\">// enterable: true,</span></pre></td></tr><tr><td data-num=\"166\"></td><td><pre>          <span class=\"token comment\">// transitionDuration: 1,</span></pre></td></tr><tr><td data-num=\"167\"></td><td><pre>          <span class=\"token comment\">// textStyle: &#123;</span></pre></td></tr><tr><td data-num=\"168\"></td><td><pre>          <span class=\"token comment\">//     color: '#000',</span></pre></td></tr><tr><td data-num=\"169\"></td><td><pre>          <span class=\"token comment\">//     decoration: 'none',</span></pre></td></tr><tr><td data-num=\"170\"></td><td><pre>          <span class=\"token comment\">// &#125;,</span></pre></td></tr><tr><td data-num=\"171\"></td><td><pre>          <span class=\"token comment\">// position: function (point, params, dom, rect, size) &#123;</span></pre></td></tr><tr><td data-num=\"172\"></td><td><pre>          <span class=\"token comment\">//   return [point[0], point[1]];</span></pre></td></tr><tr><td data-num=\"173\"></td><td><pre>          <span class=\"token comment\">// &#125;,</span></pre></td></tr><tr><td data-num=\"174\"></td><td><pre>          <span class=\"token function-variable function\">formatter</span><span class=\"token operator\">:</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">params</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"175\"></td><td><pre>              <span class=\"token keyword\">var</span> total <span class=\"token operator\">=</span> <span class=\"token number\">0</span> </pre></td></tr><tr><td data-num=\"176\"></td><td><pre>              <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>params<span class=\"token punctuation\">.</span>seriesType<span class=\"token operator\">!=</span><span class=\"token string\">\"map\"</span> <span class=\"token operator\">||</span> params<span class=\"token punctuation\">.</span>seriesType<span class=\"token operator\">==</span><span class=\"token string\">\"effectScatter\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"177\"></td><td><pre>                  total <span class=\"token operator\">=</span> params<span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">[</span>params<span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">.</span>length<span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"178\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span><span class=\"token keyword\">else</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"179\"></td><td><pre>                  total <span class=\"token operator\">=</span> params<span class=\"token punctuation\">.</span>value</pre></td></tr><tr><td data-num=\"180\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"181\"></td><td><pre>              <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">isNaN</span><span class=\"token punctuation\">(</span>total<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"182\"></td><td><pre>                  total <span class=\"token operator\">=</span> <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"183\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"184\"></td><td><pre>              <span class=\"token comment\">// var tooltipHtml = '&lt;p style=\"color:#fff;font-size:12px;\">'+'&lt;i style=\"display:inline-block;width:10px;height:10px;background:#0abdea;border-radius:40px;margin:0 8px\">'+'&lt;/i>'</span></pre></td></tr><tr><td data-num=\"185\"></td><td><pre>     <span class=\"token comment\">//          +' 总数：'+'&lt;span style=\"color:#0abdea;margin:0 6px;\">'+total+'&lt;/span>'+' 个 '+'&lt;/p>'</span></pre></td></tr><tr><td data-num=\"186\"></td><td><pre>              <span class=\"token keyword\">var</span> tooltipHtml <span class=\"token operator\">=</span> <span class=\"token string\">''</span></pre></td></tr><tr><td data-num=\"187\"></td><td><pre>              <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>toolTip<span class=\"token punctuation\">[</span>params<span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"188\"></td><td><pre>                  <span class=\"token keyword\">return</span>  tipHtml <span class=\"token operator\">=</span> <span class=\"token string\">'&lt;div style=\"width:280px;height:180px;background:rgba(22,80,158,0.8);border:1px solid rgba(7,166,255,0.7)\">'</span></pre></td></tr><tr><td data-num=\"189\"></td><td><pre>              <span class=\"token operator\">+</span><span class=\"token string\">'&lt;div style=\"width:100%;height:40px;line-height:40px;border-bottom:2px solid rgba(7,166,255,0.7);padding:0 20px\">'</span><span class=\"token operator\">+</span><span class=\"token string\">'&lt;i style=\"display:inline-block;width:8px;height:8px;background:#16d6ff;border-radius:40px;\">'</span><span class=\"token operator\">+</span><span class=\"token string\">'&lt;/i>'</span></pre></td></tr><tr><td data-num=\"190\"></td><td><pre>              <span class=\"token operator\">+</span><span class=\"token string\">'&lt;span style=\"margin-left:10px;color:#fff;font-size:16px;\">'</span><span class=\"token operator\">+</span>params<span class=\"token punctuation\">.</span>name<span class=\"token operator\">+</span><span class=\"token string\">':   '</span><span class=\"token operator\">+</span>total<span class=\"token operator\">+</span><span class=\"token string\">'&lt;/span>'</span><span class=\"token operator\">+</span><span class=\"token string\">'&lt;/div>'</span></pre></td></tr><tr><td data-num=\"191\"></td><td><pre>              <span class=\"token operator\">+</span><span class=\"token string\">'&lt;div style=\"padding:20px\">'</span></pre></td></tr><tr><td data-num=\"192\"></td><td><pre>              <span class=\"token comment\">// + tooltipHtml</span></pre></td></tr><tr><td data-num=\"193\"></td><td><pre>              <span class=\"token operator\">+</span><span class=\"token string\">'&lt;/div>'</span><span class=\"token operator\">+</span><span class=\"token string\">'&lt;/div>'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"194\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"195\"></td><td><pre>              <span class=\"token keyword\">var</span> height <span class=\"token operator\">=</span> <span class=\"token number\">100</span></pre></td></tr><tr><td data-num=\"196\"></td><td><pre>              <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">var</span> i<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">;</span>i<span class=\"token operator\">&lt;</span>toolTip<span class=\"token punctuation\">[</span>params<span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">;</span>i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"197\"></td><td><pre>                  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>toolTip<span class=\"token punctuation\">[</span>params<span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>value <span class=\"token operator\">&lt;=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"198\"></td><td><pre>                      <span class=\"token keyword\">continue</span></pre></td></tr><tr><td data-num=\"199\"></td><td><pre>                  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"200\"></td><td><pre>                  <span class=\"token keyword\">var</span> temp <span class=\"token operator\">=</span>  <span class=\"token string\">'&lt;p style=\"color:#fff;font-size:12px;\">'</span><span class=\"token operator\">+</span><span class=\"token string\">'&lt;i style=\"display:inline-block;width:10px;height:10px;background:#0abdea;border-radius:40px;margin:0 8px\">'</span><span class=\"token operator\">+</span><span class=\"token string\">'&lt;/i>'</span></pre></td></tr><tr><td data-num=\"201\"></td><td><pre>              <span class=\"token operator\">+</span>toolTip<span class=\"token punctuation\">[</span>params<span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>name<span class=\"token operator\">+</span><span class=\"token string\">'&lt;span style=\"color:#0abdea;margin:0 6px;\">'</span><span class=\"token operator\">+</span>toolTip<span class=\"token punctuation\">[</span>params<span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>value<span class=\"token operator\">+</span><span class=\"token string\">'&lt;/span>'</span><span class=\"token operator\">+</span><span class=\"token string\">'个'</span><span class=\"token operator\">+</span><span class=\"token string\">'&lt;/p>'</span> </pre></td></tr><tr><td data-num=\"202\"></td><td><pre>                  tooltipHtml <span class=\"token operator\">+=</span> temp</pre></td></tr><tr><td data-num=\"203\"></td><td><pre>                  height <span class=\"token operator\">+=</span> <span class=\"token number\">30</span></pre></td></tr><tr><td data-num=\"204\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"205\"></td><td><pre>              console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>height<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"206\"></td><td><pre>              <span class=\"token keyword\">var</span> tipHtml <span class=\"token operator\">=</span> <span class=\"token string\">''</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"207\"></td><td><pre>              tipHtml <span class=\"token operator\">=</span> <span class=\"token string\">'&lt;div style=\"width:280px;height:'</span><span class=\"token operator\">+</span>height<span class=\"token operator\">+</span><span class=\"token string\">'px'</span><span class=\"token operator\">+</span><span class=\"token string\">';border:1px solid rgba(197,197,197,0.7)\">'</span></pre></td></tr><tr><td data-num=\"208\"></td><td><pre>              <span class=\"token operator\">+</span><span class=\"token string\">'&lt;div style=\"width:100%;height:40px;line-height:40px;border-bottom:2px solid #d0d0d0;padding:0 20px\">'</span><span class=\"token operator\">+</span><span class=\"token string\">'&lt;i style=\"display:inline-block;width:8px;height:8px;background:#0abdea;border-radius:40px;\">'</span><span class=\"token operator\">+</span><span class=\"token string\">'&lt;/i>'</span></pre></td></tr><tr><td data-num=\"209\"></td><td><pre>              <span class=\"token operator\">+</span><span class=\"token string\">'&lt;span style=\"margin-left:10px;color:#fff;font-size:16px;\">'</span><span class=\"token operator\">+</span>params<span class=\"token punctuation\">.</span>name<span class=\"token operator\">+</span><span class=\"token string\">':  '</span><span class=\"token operator\">+</span>total<span class=\"token operator\">+</span><span class=\"token string\">'&lt;/span>'</span><span class=\"token operator\">+</span><span class=\"token string\">'&lt;/div>'</span></pre></td></tr><tr><td data-num=\"210\"></td><td><pre>              <span class=\"token operator\">+</span><span class=\"token string\">'&lt;div style=\"padding:20px\">'</span></pre></td></tr><tr><td data-num=\"211\"></td><td><pre>              <span class=\"token operator\">+</span> tooltipHtml</pre></td></tr><tr><td data-num=\"212\"></td><td><pre>              <span class=\"token operator\">+</span><span class=\"token string\">'&lt;/div>'</span><span class=\"token operator\">+</span><span class=\"token string\">'&lt;/div>'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"213\"></td><td><pre></pre></td></tr><tr><td data-num=\"214\"></td><td><pre>              <span class=\"token keyword\">return</span> tipHtml<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"215\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"216\"></td><td><pre></pre></td></tr><tr><td data-num=\"217\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"218\"></td><td><pre></pre></td></tr><tr><td data-num=\"219\"></td><td><pre>      visualMap<span class=\"token operator\">:</span> visualMap<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"220\"></td><td><pre>      <span class=\"token comment\">// geo: &#123;</span></pre></td></tr><tr><td data-num=\"221\"></td><td><pre>      <span class=\"token comment\">//     show: true,</span></pre></td></tr><tr><td data-num=\"222\"></td><td><pre>      <span class=\"token comment\">//     map: mapName,</span></pre></td></tr><tr><td data-num=\"223\"></td><td><pre>      <span class=\"token comment\">//     label: &#123;</span></pre></td></tr><tr><td data-num=\"224\"></td><td><pre>      <span class=\"token comment\">//         normal: &#123;</span></pre></td></tr><tr><td data-num=\"225\"></td><td><pre>      <span class=\"token comment\">//             show: false</span></pre></td></tr><tr><td data-num=\"226\"></td><td><pre>      <span class=\"token comment\">//         &#125;,</span></pre></td></tr><tr><td data-num=\"227\"></td><td><pre>      <span class=\"token comment\">//         emphasis: &#123;</span></pre></td></tr><tr><td data-num=\"228\"></td><td><pre>      <span class=\"token comment\">//             show: false,</span></pre></td></tr><tr><td data-num=\"229\"></td><td><pre>      <span class=\"token comment\">//         &#125;</span></pre></td></tr><tr><td data-num=\"230\"></td><td><pre>      <span class=\"token comment\">//     &#125;,</span></pre></td></tr><tr><td data-num=\"231\"></td><td><pre>      <span class=\"token comment\">//     roam: false,</span></pre></td></tr><tr><td data-num=\"232\"></td><td><pre>      <span class=\"token comment\">//     itemStyle: &#123;</span></pre></td></tr><tr><td data-num=\"233\"></td><td><pre>      <span class=\"token comment\">//         normal: &#123;</span></pre></td></tr><tr><td data-num=\"234\"></td><td><pre>      <span class=\"token comment\">//             areaColor: colors[0],</span></pre></td></tr><tr><td data-num=\"235\"></td><td><pre>      <span class=\"token comment\">//             borderColor: '#1180c7',</span></pre></td></tr><tr><td data-num=\"236\"></td><td><pre>      <span class=\"token comment\">//         &#125;,</span></pre></td></tr><tr><td data-num=\"237\"></td><td><pre>      <span class=\"token comment\">//         emphasis: &#123;</span></pre></td></tr><tr><td data-num=\"238\"></td><td><pre>      <span class=\"token comment\">//             areaColor: '#4499d0',</span></pre></td></tr><tr><td data-num=\"239\"></td><td><pre>      <span class=\"token comment\">//         &#125;</span></pre></td></tr><tr><td data-num=\"240\"></td><td><pre>      <span class=\"token comment\">//     &#125;</span></pre></td></tr><tr><td data-num=\"241\"></td><td><pre>      <span class=\"token comment\">// &#125;,</span></pre></td></tr><tr><td data-num=\"242\"></td><td><pre>      geo<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"243\"></td><td><pre>        show<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"244\"></td><td><pre>        map<span class=\"token operator\">:</span> <span class=\"token string\">'china'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"245\"></td><td><pre>        label<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"246\"></td><td><pre>          normal<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"247\"></td><td><pre>            show<span class=\"token operator\">:</span> <span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"248\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"249\"></td><td><pre>          emphasis<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"250\"></td><td><pre>            show<span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"251\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"252\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"253\"></td><td><pre>        roam<span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"254\"></td><td><pre>        itemStyle<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"255\"></td><td><pre>          normal<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"256\"></td><td><pre>            areaColor<span class=\"token operator\">:</span> <span class=\"token string\">'#fbfbfb'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"257\"></td><td><pre>            borderColor<span class=\"token operator\">:</span> <span class=\"token string\">'#878787'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"258\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"259\"></td><td><pre>          emphasis<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"260\"></td><td><pre>            areaColor<span class=\"token operator\">:</span> <span class=\"token string\">'#0c679b'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"261\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"262\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"263\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"264\"></td><td><pre>      series<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span></pre></td></tr><tr><td data-num=\"265\"></td><td><pre>          <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"266\"></td><td><pre>              name<span class=\"token operator\">:</span> <span class=\"token string\">'散点'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"267\"></td><td><pre>              type<span class=\"token operator\">:</span> <span class=\"token string\">'scatter'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"268\"></td><td><pre>              coordinateSystem<span class=\"token operator\">:</span> <span class=\"token string\">'geo'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"269\"></td><td><pre>              data<span class=\"token operator\">:</span> <span class=\"token function\">convertData</span><span class=\"token punctuation\">(</span>series<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"270\"></td><td><pre>              <span class=\"token function-variable function\">symbolSize</span><span class=\"token operator\">:</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">val</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"271\"></td><td><pre>                 <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>fd<span class=\"token punctuation\">.</span>echartsChinaProvice<span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"272\"></td><td><pre>                    <span class=\"token keyword\">return</span> <span class=\"token number\">0.1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"273\"></td><td><pre>                 <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"274\"></td><td><pre>                 <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"275\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"276\"></td><td><pre>              <span class=\"token comment\">// label: &#123;</span></pre></td></tr><tr><td data-num=\"277\"></td><td><pre>              <span class=\"token comment\">//     normal: &#123;</span></pre></td></tr><tr><td data-num=\"278\"></td><td><pre>              <span class=\"token comment\">//         formatter: '&#123;b&#125;',</span></pre></td></tr><tr><td data-num=\"279\"></td><td><pre>              <span class=\"token comment\">//         position: 'right',</span></pre></td></tr><tr><td data-num=\"280\"></td><td><pre>              <span class=\"token comment\">//         show: true</span></pre></td></tr><tr><td data-num=\"281\"></td><td><pre>              <span class=\"token comment\">//     &#125;,</span></pre></td></tr><tr><td data-num=\"282\"></td><td><pre>              <span class=\"token comment\">//     emphasis: &#123;</span></pre></td></tr><tr><td data-num=\"283\"></td><td><pre>              <span class=\"token comment\">//         show: true</span></pre></td></tr><tr><td data-num=\"284\"></td><td><pre>              <span class=\"token comment\">//     &#125;</span></pre></td></tr><tr><td data-num=\"285\"></td><td><pre>              <span class=\"token comment\">// &#125;,</span></pre></td></tr><tr><td data-num=\"286\"></td><td><pre>              <span class=\"token comment\">// itemStyle: &#123;</span></pre></td></tr><tr><td data-num=\"287\"></td><td><pre>              <span class=\"token comment\">//     normal: &#123;</span></pre></td></tr><tr><td data-num=\"288\"></td><td><pre>              <span class=\"token comment\">//         color: '#fff'</span></pre></td></tr><tr><td data-num=\"289\"></td><td><pre>              <span class=\"token comment\">//     &#125;</span></pre></td></tr><tr><td data-num=\"290\"></td><td><pre>              <span class=\"token comment\">// &#125;</span></pre></td></tr><tr><td data-num=\"291\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"292\"></td><td><pre>          <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"293\"></td><td><pre>              type<span class=\"token operator\">:</span> <span class=\"token string\">'map'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"294\"></td><td><pre>              map<span class=\"token operator\">:</span> mapName<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"295\"></td><td><pre>              geoIndex<span class=\"token operator\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"296\"></td><td><pre>              aspectScale<span class=\"token operator\">:</span> <span class=\"token number\">0.75</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// 长宽比</span></pre></td></tr><tr><td data-num=\"297\"></td><td><pre>              showLegendSymbol<span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// 存在 legend 时显示</span></pre></td></tr><tr><td data-num=\"298\"></td><td><pre>              label<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"299\"></td><td><pre>                  normal<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"300\"></td><td><pre>                      show<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"301\"></td><td><pre>                  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"302\"></td><td><pre>                  emphasis<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"303\"></td><td><pre>                      show<span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"304\"></td><td><pre>                      textStyle<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"305\"></td><td><pre>                          color<span class=\"token operator\">:</span> <span class=\"token string\">'#fff'</span></pre></td></tr><tr><td data-num=\"306\"></td><td><pre>                      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"307\"></td><td><pre>                  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"308\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"309\"></td><td><pre>              roam<span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"310\"></td><td><pre>              <span class=\"token comment\">// itemStyle: &#123;</span></pre></td></tr><tr><td data-num=\"311\"></td><td><pre>              <span class=\"token comment\">//     normal: &#123;</span></pre></td></tr><tr><td data-num=\"312\"></td><td><pre>              <span class=\"token comment\">//         areaColor: '#031525',</span></pre></td></tr><tr><td data-num=\"313\"></td><td><pre>              <span class=\"token comment\">//         borderColor: '#3B5077',</span></pre></td></tr><tr><td data-num=\"314\"></td><td><pre>              <span class=\"token comment\">//     &#125;,</span></pre></td></tr><tr><td data-num=\"315\"></td><td><pre>              <span class=\"token comment\">//     emphasis: &#123;</span></pre></td></tr><tr><td data-num=\"316\"></td><td><pre>              <span class=\"token comment\">//         areaColor: '#2B91B7'</span></pre></td></tr><tr><td data-num=\"317\"></td><td><pre>              <span class=\"token comment\">//     &#125;</span></pre></td></tr><tr><td data-num=\"318\"></td><td><pre>              <span class=\"token comment\">// &#125;,</span></pre></td></tr><tr><td data-num=\"319\"></td><td><pre>              animation<span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"320\"></td><td><pre>              data<span class=\"token operator\">:</span> series</pre></td></tr><tr><td data-num=\"321\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"322\"></td><td><pre>     <span class=\"token comment\">//      &#123;</span></pre></td></tr><tr><td data-num=\"323\"></td><td><pre>     <span class=\"token comment\">//          name: ' 点 ',</span></pre></td></tr><tr><td data-num=\"324\"></td><td><pre>     <span class=\"token comment\">//          type: 'scatter',</span></pre></td></tr><tr><td data-num=\"325\"></td><td><pre>     <span class=\"token comment\">//          coordinateSystem: 'geo',</span></pre></td></tr><tr><td data-num=\"326\"></td><td><pre>     <span class=\"token comment\">//          zlevel: 6,</span></pre></td></tr><tr><td data-num=\"327\"></td><td><pre>     <span class=\"token comment\">//      &#125;,</span></pre></td></tr><tr><td data-num=\"328\"></td><td><pre>     <span class=\"token comment\">//      &#123;</span></pre></td></tr><tr><td data-num=\"329\"></td><td><pre>     <span class=\"token comment\">//          name: 'Top 5',</span></pre></td></tr><tr><td data-num=\"330\"></td><td><pre>     <span class=\"token comment\">//          type: 'effectScatter',</span></pre></td></tr><tr><td data-num=\"331\"></td><td><pre>     <span class=\"token comment\">//          coordinateSystem: 'geo',</span></pre></td></tr><tr><td data-num=\"332\"></td><td><pre>     <span class=\"token comment\">//          data: convertData(series),</span></pre></td></tr><tr><td data-num=\"333\"></td><td><pre>     <span class=\"token comment\">//          symbolSize: function(val) &#123;</span></pre></td></tr><tr><td data-num=\"334\"></td><td><pre></pre></td></tr><tr><td data-num=\"335\"></td><td><pre>                 <span class=\"token comment\">//   if((val[2] / 10)>10)&#123;</span></pre></td></tr><tr><td data-num=\"336\"></td><td><pre>                 <span class=\"token comment\">//   \treturn 10</span></pre></td></tr><tr><td data-num=\"337\"></td><td><pre>                 <span class=\"token comment\">//    &#125;</span></pre></td></tr><tr><td data-num=\"338\"></td><td><pre></pre></td></tr><tr><td data-num=\"339\"></td><td><pre>     <span class=\"token comment\">//              return val[2] / 10;</span></pre></td></tr><tr><td data-num=\"340\"></td><td><pre>     <span class=\"token comment\">//          &#125;,</span></pre></td></tr><tr><td data-num=\"341\"></td><td><pre>     <span class=\"token comment\">//          showEffectOn: 'render',</span></pre></td></tr><tr><td data-num=\"342\"></td><td><pre>     <span class=\"token comment\">//          rippleEffect: &#123;</span></pre></td></tr><tr><td data-num=\"343\"></td><td><pre>     <span class=\"token comment\">//              brushType: 'stroke'</span></pre></td></tr><tr><td data-num=\"344\"></td><td><pre>     <span class=\"token comment\">//          &#125;,</span></pre></td></tr><tr><td data-num=\"345\"></td><td><pre>     <span class=\"token comment\">//          hoverAnimation: true,</span></pre></td></tr><tr><td data-num=\"346\"></td><td><pre>     <span class=\"token comment\">//          label: &#123;</span></pre></td></tr><tr><td data-num=\"347\"></td><td><pre>     <span class=\"token comment\">//              normal: &#123;</span></pre></td></tr><tr><td data-num=\"348\"></td><td><pre>     <span class=\"token comment\">//                  formatter: '&#123;b&#125;',</span></pre></td></tr><tr><td data-num=\"349\"></td><td><pre>     <span class=\"token comment\">//                  position: 'left',</span></pre></td></tr><tr><td data-num=\"350\"></td><td><pre>     <span class=\"token comment\">//                  show: false</span></pre></td></tr><tr><td data-num=\"351\"></td><td><pre>     <span class=\"token comment\">//              &#125;</span></pre></td></tr><tr><td data-num=\"352\"></td><td><pre>     <span class=\"token comment\">//          &#125;,</span></pre></td></tr><tr><td data-num=\"353\"></td><td><pre>     <span class=\"token comment\">//          itemStyle: &#123;</span></pre></td></tr><tr><td data-num=\"354\"></td><td><pre>     <span class=\"token comment\">//              normal: &#123;</span></pre></td></tr><tr><td data-num=\"355\"></td><td><pre>     <span class=\"token comment\">//                  color: colors[colors.length-1],</span></pre></td></tr><tr><td data-num=\"356\"></td><td><pre>     <span class=\"token comment\">//                  shadowBlur: 10,</span></pre></td></tr><tr><td data-num=\"357\"></td><td><pre>     <span class=\"token comment\">//                  shadowColor: colors[colors.length-1]</span></pre></td></tr><tr><td data-num=\"358\"></td><td><pre>     <span class=\"token comment\">//              &#125;</span></pre></td></tr><tr><td data-num=\"359\"></td><td><pre>     <span class=\"token comment\">//          &#125;,</span></pre></td></tr><tr><td data-num=\"360\"></td><td><pre>     <span class=\"token comment\">//          zlevel: 1</span></pre></td></tr><tr><td data-num=\"361\"></td><td><pre>     <span class=\"token comment\">//      &#125;,</span></pre></td></tr><tr><td data-num=\"362\"></td><td><pre></pre></td></tr><tr><td data-num=\"363\"></td><td><pre>      <span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"364\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"365\"></td><td><pre>  <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>fd<span class=\"token punctuation\">.</span>echartsChinaProvice<span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"366\"></td><td><pre>        option<span class=\"token punctuation\">[</span><span class=\"token string\">'series'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"label\"</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"367\"></td><td><pre>            normal<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span>formatter<span class=\"token operator\">:</span> <span class=\"token string\">'&#123;b&#125;'</span><span class=\"token punctuation\">,</span>position<span class=\"token operator\">:</span> <span class=\"token string\">'right'</span><span class=\"token punctuation\">,</span>show<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"368\"></td><td><pre>            emphasis<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span>show<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"369\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"370\"></td><td><pre>        option<span class=\"token punctuation\">[</span><span class=\"token string\">'series'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"itemStyle\"</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span>normal<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span>color<span class=\"token operator\">:</span> <span class=\"token string\">'#fff'</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"371\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"372\"></td><td><pre>  <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>fd<span class=\"token punctuation\">.</span>echartsChinaPoint<span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"373\"></td><td><pre>      option<span class=\"token punctuation\">[</span><span class=\"token string\">'series'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span>name<span class=\"token operator\">:</span> <span class=\"token string\">'点'</span><span class=\"token punctuation\">,</span>type<span class=\"token operator\">:</span> <span class=\"token string\">'scatter'</span><span class=\"token punctuation\">,</span>coordinateSystem<span class=\"token operator\">:</span> <span class=\"token string\">'geo'</span><span class=\"token punctuation\">,</span>zlevel<span class=\"token operator\">:</span> <span class=\"token number\">6</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"374\"></td><td><pre>      option<span class=\"token punctuation\">[</span><span class=\"token string\">'series'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"375\"></td><td><pre>              name<span class=\"token operator\">:</span> <span class=\"token string\">'Top 5'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"376\"></td><td><pre>              type<span class=\"token operator\">:</span> <span class=\"token string\">'effectScatter'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"377\"></td><td><pre>              coordinateSystem<span class=\"token operator\">:</span> <span class=\"token string\">'geo'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"378\"></td><td><pre>              data<span class=\"token operator\">:</span> <span class=\"token function\">convertData</span><span class=\"token punctuation\">(</span>series<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"379\"></td><td><pre>              <span class=\"token function-variable function\">symbolSize</span><span class=\"token operator\">:</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">val</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"380\"></td><td><pre></pre></td></tr><tr><td data-num=\"381\"></td><td><pre>                   <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>val<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">/</span> <span class=\"token number\">10</span><span class=\"token punctuation\">)</span><span class=\"token operator\">></span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"382\"></td><td><pre>                    <span class=\"token keyword\">return</span> <span class=\"token number\">10</span></pre></td></tr><tr><td data-num=\"383\"></td><td><pre>                    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"384\"></td><td><pre></pre></td></tr><tr><td data-num=\"385\"></td><td><pre>                  <span class=\"token keyword\">return</span> val<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">/</span> <span class=\"token number\">10</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"386\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"387\"></td><td><pre>              showEffectOn<span class=\"token operator\">:</span> <span class=\"token string\">'render'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"388\"></td><td><pre>              rippleEffect<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"389\"></td><td><pre>                  brushType<span class=\"token operator\">:</span> <span class=\"token string\">'stroke'</span></pre></td></tr><tr><td data-num=\"390\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"391\"></td><td><pre>              hoverAnimation<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"392\"></td><td><pre>              label<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"393\"></td><td><pre>                  normal<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"394\"></td><td><pre>                      formatter<span class=\"token operator\">:</span> <span class=\"token string\">'&#123;b&#125;'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"395\"></td><td><pre>                      position<span class=\"token operator\">:</span> <span class=\"token string\">'left'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"396\"></td><td><pre>                      show<span class=\"token operator\">:</span> <span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"397\"></td><td><pre>                  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"398\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"399\"></td><td><pre>              itemStyle<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"400\"></td><td><pre>                  normal<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"401\"></td><td><pre>                      color<span class=\"token operator\">:</span> colors<span class=\"token punctuation\">[</span>colors<span class=\"token punctuation\">.</span>length<span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"402\"></td><td><pre>                      shadowBlur<span class=\"token operator\">:</span> <span class=\"token number\">10</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"403\"></td><td><pre>                      shadowColor<span class=\"token operator\">:</span> colors<span class=\"token punctuation\">[</span>colors<span class=\"token punctuation\">.</span>length<span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"404\"></td><td><pre>                  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"405\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"406\"></td><td><pre>              zlevel<span class=\"token operator\">:</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"407\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"408\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"409\"></td><td><pre>  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>option<span class=\"token punctuation\">[</span><span class=\"token string\">'series'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"410\"></td><td><pre>  myChart<span class=\"token punctuation\">.</span><span class=\"token function\">setOption</span><span class=\"token punctuation\">(</span>option<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"411\"></td><td><pre></pre></td></tr><tr><td data-num=\"412\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"413\"></td><td><pre></pre></td></tr><tr><td data-num=\"414\"></td><td><pre>EchartsChinaMap<span class=\"token punctuation\">.</span>displayName <span class=\"token operator\">=</span> <span class=\"token string\">'Echarts Bar'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"415\"></td><td><pre>EchartsChinaMap<span class=\"token punctuation\">.</span>propTypes <span class=\"token operator\">=</span> propTypes<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"416\"></td><td><pre></pre></td></tr><tr><td data-num=\"417\"></td><td><pre><span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> EchartsChinaMap</pre></td></tr></table></figure><p>7. 修改 /visualizations/presets/MainPreset.js<br />\n<img data-src=\"2.png\" alt=\"\" /></p>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// 开头导入</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">import</span> EchartsChinaMapChartPlugin <span class=\"token keyword\">from</span> <span class=\"token string\">'../EchartsChinaMap/index.js'</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">//plugins 下增加</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">new</span> <span class=\"token class-name\">EchartsChinaMapChartPlugin</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">configure</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span> key<span class=\"token operator\">:</span> <span class=\"token string\">'echarts_china_map'</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr></table></figure><p>8. 修改 /explore/components/controls/VizTypeControl.jsx<br />\n 变量 DEFAULT_ORDER 增加 'echarts_china_map'</p>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">const</span> <span class=\"token constant\">DEFAULT_ORDER</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token string\">'line'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'big_number'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'table'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'filter_box'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'dist_bar'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'area'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'bar'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token string\">'deck_polygon'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'pie'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'time_table'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'pivot_table'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'histogram'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token string\">'big_number_total'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'deck_scatter'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'deck_hex'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'time_pivot'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'deck_arc'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token string\">'heatmap'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'deck_grid'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'dual_line'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'deck_screengrid'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'line_multi'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token string\">'treemap'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'box_plot'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'separator'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'sunburst'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'sankey'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'word_cloud'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token string\">'mapbox'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'kepler'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'cal_heatmap'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'rose'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'bubble'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'deck_geojson'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token string\">'horizon'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'markup'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'deck_multi'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'compare'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'partition'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'event_flow'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token string\">'deck_path'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'directed_force'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'world_map'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'paired_ttest'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'para'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token string\">'iframe'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'country_map'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'echarts_china_map'</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>9. 新建 /explore/controlPanels/echartsChinaMap.js</p>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token punctuation\">&#123;</span> t <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'@superset-ui/translation'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    requiresTime<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    controlPanelSections<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>            label<span class=\"token operator\">:</span> <span class=\"token function\">t</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Chart Options'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>            expanded<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>            controlSetRows<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>                <span class=\"token punctuation\">[</span><span class=\"token string\">'echarts_china_visualMap'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>                 <span class=\"token punctuation\">[</span><span class=\"token string\">'echarts_color_scheme'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'label_colors'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>                 <span class=\"token punctuation\">[</span><span class=\"token string\">'echarts_china_Point'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>                 <span class=\"token punctuation\">[</span><span class=\"token string\">'echarts_china_Provice'</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>            <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>            label<span class=\"token operator\">:</span> <span class=\"token function\">t</span><span class=\"token punctuation\">(</span><span class=\"token string\">'分组'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>            expanded<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>            controlSetRows<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>                <span class=\"token punctuation\">[</span><span class=\"token string\">'groupby'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>            <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>            label<span class=\"token operator\">:</span> <span class=\"token function\">t</span><span class=\"token punctuation\">(</span><span class=\"token string\">'指标'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>            expanded<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>            controlSetRows<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>                <span class=\"token punctuation\">[</span><span class=\"token string\">'echarts_china_map_metrics'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>            <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>            label<span class=\"token operator\">:</span> <span class=\"token function\">t</span><span class=\"token punctuation\">(</span><span class=\"token string\">'查询'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>            expanded<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>            controlSetRows<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>                <span class=\"token punctuation\">[</span><span class=\"token string\">'adhoc_filters'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>            <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>    controlOverrides<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>10. 修改 /explore/controls.jsx<br />\n 在文件最下面添加</p>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">//echarts china map</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    echarts_china_map_metrics<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>      <span class=\"token operator\">...</span>metrics<span class=\"token punctuation\">,</span> <span class=\"token comment\">// 继承</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>      multi<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// 多选</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>      clearable<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// 是否可调用， true 当作 sql</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>      validators<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// 是否可以为空</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>      label<span class=\"token operator\">:</span> <span class=\"token function\">t</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Metrics'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>      description<span class=\"token operator\">:</span> <span class=\"token function\">t</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Metrics for which line type are to be displayed'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    echarts_china_visualMap<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      type<span class=\"token operator\">:</span> <span class=\"token string\">'CheckboxControl'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      label<span class=\"token operator\">:</span> <span class=\"token function\">t</span><span class=\"token punctuation\">(</span><span class=\"token string\">'是否显示visualMap'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      <span class=\"token keyword\">default</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      renderTrigger<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      description<span class=\"token operator\">:</span> <span class=\"token function\">t</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Do you want a visualMap?'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    echarts_china_Point<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      type<span class=\"token operator\">:</span> <span class=\"token string\">'CheckboxControl'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>      label<span class=\"token operator\">:</span> <span class=\"token function\">t</span><span class=\"token punctuation\">(</span><span class=\"token string\">'是否显示点'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>      <span class=\"token keyword\">default</span><span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>      renderTrigger<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>      description<span class=\"token operator\">:</span> <span class=\"token function\">t</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Do you want Points?'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    echarts_china_Provice<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>      type<span class=\"token operator\">:</span> <span class=\"token string\">'CheckboxControl'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>      label<span class=\"token operator\">:</span> <span class=\"token function\">t</span><span class=\"token punctuation\">(</span><span class=\"token string\">'是否显示省份'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>      <span class=\"token keyword\">default</span><span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>      renderTrigger<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>      description<span class=\"token operator\">:</span> <span class=\"token function\">t</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Do you want Provices?'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    echarts_color_scheme<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>      type<span class=\"token operator\">:</span> <span class=\"token string\">'ColorSchemeControl'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>      label<span class=\"token operator\">:</span> <span class=\"token function\">t</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Color Scheme'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>      <span class=\"token keyword\">default</span><span class=\"token operator\">:</span> <span class=\"token string\">'DEFAULT'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>      renderTrigger<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>      choices<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>          <span class=\"token punctuation\">[</span><span class=\"token string\">\"DEFAULT\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"DEFAULT\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>          <span class=\"token punctuation\">[</span><span class=\"token string\">\"SUPERSET_DEFAULT\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"SUPERSET_DEFAULT\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>      <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>      description<span class=\"token operator\">:</span> <span class=\"token function\">t</span><span class=\"token punctuation\">(</span><span class=\"token string\">'The color scheme for rendering chart'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>      schemes<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>          <span class=\"token constant\">DEFAULT</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span>colors<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'#15a8fe'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'rgba(21,168,254,0.31)'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'#FFFF00'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>description<span class=\"token operator\">:</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span>id<span class=\"token operator\">:</span><span class=\"token string\">\"DEFAULT\"</span><span class=\"token punctuation\">,</span>label<span class=\"token operator\">:</span><span class=\"token string\">\"DEFAULT Category \"</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>          <span class=\"token constant\">SUPERSET_DEFAULT</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span>colors<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"#f6efa6\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#d88273\"</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"#bf444c\"</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"#15a8fe\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>description<span class=\"token operator\">:</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span>id<span class=\"token operator\">:</span><span class=\"token string\">\"d3Category10\"</span><span class=\"token punctuation\">,</span>label<span class=\"token operator\">:</span><span class=\"token string\">\"D3 Category 10\"</span><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr></table></figure><p>11. 修改 /setup/setupPlugins.ts</p>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// 开头导入</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">import</span> EchartsChinaMap <span class=\"token keyword\">from</span> <span class=\"token string\">'../explore/controlPanels/EchartsChinaMap'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">//getChartControlPanelRegistry 下增加，注意只有最后一个有分号</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">.</span><span class=\"token function\">registerValue</span><span class=\"token punctuation\">(</span><span class=\"token string\">'echarts_china_map'</span><span class=\"token punctuation\">,</span> EchartsChinaMap<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>12. 修改 \\superset\\assets\\package.json, 引入 npm echarts 包（如果已经引入则跳过）<br />\n<img data-src=\"6.png\" alt=\"\" /></p>\n<figure class=\"highlight json\"><figcaption data-lang=\"JSON\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// 找到 dependencies 下面增加</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token property\">\"echarts\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"^4.7.0\"</span></pre></td></tr></table></figure><h1 id=\"后端开发\"><a class=\"anchor\" href=\"#后端开发\">#</a> 后端开发</h1>\n<ol>\n<li>修改 superset/viz.py，修改 METRIC_KEYS，添加 echarts_china_map_metrics</li>\n</ol>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token operator\">//</span>找到METRIC_KEYS</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>METRIC_KEYS <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token string\">\"metric\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token string\">\"metrics\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token string\">\"percent_metrics\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token string\">\"metric_2\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token string\">\"secondary_metric\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token string\">\"x\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token string\">\"y\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token string\">\"size\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token string\">\"echarts_china_map_metrics\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">]</span></pre></td></tr></table></figure><ol start=\"2\">\n<li>修改 superset/viz.py，在 viz_types 前添加下面代码</li>\n</ol>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name\">EchartsChinaMapViz</span><span class=\"token punctuation\">(</span>NVD3Viz<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token triple-quoted-string string\">\"\"\" echarts pie  \"\"\"</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    viz_type <span class=\"token operator\">=</span> <span class=\"token string\">\"echarts_china_map\"</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    verbose_name <span class=\"token operator\">=</span> _<span class=\"token punctuation\">(</span><span class=\"token string\">\"Echarts China Map\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token comment\"># 是否排序</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    sort_series <span class=\"token operator\">=</span> <span class=\"token boolean\">False</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token comment\"># 是否对 time 做处理 _timestamp</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    is_timeseries <span class=\"token operator\">=</span> <span class=\"token boolean\">False</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token keyword\">def</span> <span class=\"token function\">query_obj</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token comment\"># check bar column, line column 是否重复</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        bar_metrics <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>form_data<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span><span class=\"token string\">'echarts_china_map_metrics'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token keyword\">not</span> bar_metrics <span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>            <span class=\"token keyword\">raise</span> Exception<span class=\"token punctuation\">(</span>_<span class=\"token punctuation\">(</span><span class=\"token string\">\"Please choose metrics on line or bar type\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        bar_metrics <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token keyword\">if</span> <span class=\"token keyword\">not</span> bar_metrics <span class=\"token keyword\">else</span> bar_metrics</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        d <span class=\"token operator\">=</span> <span class=\"token builtin\">super</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>query_obj<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        <span class=\"token keyword\">return</span> d</pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token keyword\">def</span> <span class=\"token function\">to_series</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> df<span class=\"token punctuation\">,</span> classed<span class=\"token operator\">=</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        <span class=\"token triple-quoted-string string\">\"\"\"</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>         拼接 前端渲染需要的数据</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        :param df:</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        :param classed:</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        :return: &#123;'legend':[], 'bar':[], 'line':[]&#125;</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        \"\"\"</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>        cols <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>        <span class=\"token keyword\">for</span> col <span class=\"token keyword\">in</span> df<span class=\"token punctuation\">.</span>columns<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>            <span class=\"token keyword\">if</span> col <span class=\"token operator\">==</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>                cols<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span><span class=\"token string\">\"N/A\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>            <span class=\"token keyword\">elif</span> col <span class=\"token keyword\">is</span> <span class=\"token boolean\">None</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>                cols<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span><span class=\"token string\">\"NULL\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>            <span class=\"token keyword\">else</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>                cols<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span>col<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>        df<span class=\"token punctuation\">.</span>columns <span class=\"token operator\">=</span> cols</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>        metrics <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>all_metrics</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>        toolTip<span class=\"token punctuation\">,</span>data <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>        total <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>        toolTipData <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>        series <span class=\"token operator\">=</span> df<span class=\"token punctuation\">.</span>to_dict<span class=\"token punctuation\">(</span><span class=\"token string\">\"series\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>        <span class=\"token keyword\">for</span> mt <span class=\"token keyword\">in</span> metrics<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>            m_label <span class=\"token operator\">=</span> utils<span class=\"token punctuation\">.</span>get_metric_name<span class=\"token punctuation\">(</span>mt<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>            <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>m_label<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>            ys <span class=\"token operator\">=</span>  <span class=\"token builtin\">list</span><span class=\"token punctuation\">(</span>series<span class=\"token punctuation\">[</span>m_label<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>items<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>            <span class=\"token keyword\">for</span> y <span class=\"token keyword\">in</span> ys<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>                <span class=\"token keyword\">if</span> y<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token operator\">==</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>                    <span class=\"token keyword\">continue</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>                province <span class=\"token operator\">=</span> y<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>replace<span class=\"token punctuation\">(</span><span class=\"token string\">\"省\"</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>                province <span class=\"token operator\">=</span> province<span class=\"token punctuation\">.</span>replace<span class=\"token punctuation\">(</span><span class=\"token string\">\"市\"</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>                province <span class=\"token operator\">=</span> province<span class=\"token punctuation\">.</span>replace<span class=\"token punctuation\">(</span><span class=\"token string\">\"自治区\"</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>                province <span class=\"token operator\">=</span> province<span class=\"token punctuation\">.</span>replace<span class=\"token punctuation\">(</span><span class=\"token string\">\"自治区\"</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>                <span class=\"token keyword\">if</span> province <span class=\"token keyword\">in</span> total<span class=\"token punctuation\">.</span>keys<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>                    total<span class=\"token punctuation\">[</span>province<span class=\"token punctuation\">]</span> <span class=\"token operator\">+=</span>  y<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>                <span class=\"token keyword\">else</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>                    total<span class=\"token punctuation\">[</span>province<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span>  y<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>                <span class=\"token keyword\">if</span> province <span class=\"token keyword\">in</span> toolTipData<span class=\"token punctuation\">.</span>keys<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>                    toolTipData<span class=\"token punctuation\">[</span>province<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span><span class=\"token string\">\"name\"</span><span class=\"token punctuation\">:</span>m_label<span class=\"token punctuation\">,</span><span class=\"token string\">\"value\"</span><span class=\"token punctuation\">:</span>y<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>                <span class=\"token keyword\">else</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>                    toolTipData<span class=\"token punctuation\">[</span>province<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span>  <span class=\"token punctuation\">[</span><span class=\"token punctuation\">&#123;</span><span class=\"token string\">\"name\"</span><span class=\"token punctuation\">:</span>m_label<span class=\"token punctuation\">,</span><span class=\"token string\">\"value\"</span><span class=\"token punctuation\">:</span>y<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>        <span class=\"token keyword\">for</span> k<span class=\"token punctuation\">,</span>v <span class=\"token keyword\">in</span> total<span class=\"token punctuation\">.</span>items<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>            data<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span> <span class=\"token punctuation\">&#123;</span><span class=\"token string\">\"name\"</span><span class=\"token punctuation\">:</span>k<span class=\"token punctuation\">,</span><span class=\"token string\">\"value\"</span><span class=\"token punctuation\">:</span>v<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>        chart_data <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>            <span class=\"token string\">'toolTip'</span><span class=\"token punctuation\">:</span> toolTipData<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>            <span class=\"token string\">'data'</span><span class=\"token punctuation\">:</span> data<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>            <span class=\"token string\">'max'</span><span class=\"token punctuation\">:</span> total<span class=\"token punctuation\">[</span><span class=\"token builtin\">max</span><span class=\"token punctuation\">(</span>total<span class=\"token punctuation\">,</span> key<span class=\"token operator\">=</span>total<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>        <span class=\"token keyword\">return</span> chart_data</pre></td></tr><tr><td data-num=\"72\"></td><td><pre></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>    <span class=\"token keyword\">def</span> <span class=\"token function\">get_data</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> df<span class=\"token punctuation\">:</span> pd<span class=\"token punctuation\">.</span>DataFrame<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>        <span class=\"token comment\"># 后端返回的数据</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>        df <span class=\"token operator\">=</span> df<span class=\"token punctuation\">.</span>pivot_table<span class=\"token punctuation\">(</span>index<span class=\"token operator\">=</span>self<span class=\"token punctuation\">.</span>groupby<span class=\"token punctuation\">,</span> values<span class=\"token operator\">=</span>self<span class=\"token punctuation\">.</span>metric_labels<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>        chart_data <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>to_series<span class=\"token punctuation\">(</span>df<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>        <span class=\"token keyword\">return</span> chart_data</pre></td></tr></table></figure>",
            "tags": [
                "计算机科学",
                "大数据",
                "数据可视化",
                "superset",
                "python"
            ]
        },
        {
            "id": "http://yrmlnf.coding-pages.com/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/%E5%A4%A7%E6%95%B0%E6%8D%AE/%E6%95%B0%E6%8D%AE%E5%8F%AF%E8%A7%86%E5%8C%96/Superset-%E9%9B%86%E6%88%90Echarts%E9%A5%BC%E5%9B%BE/",
            "url": "http://yrmlnf.coding-pages.com/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/%E5%A4%A7%E6%95%B0%E6%8D%AE/%E6%95%B0%E6%8D%AE%E5%8F%AF%E8%A7%86%E5%8C%96/Superset-%E9%9B%86%E6%88%90Echarts%E9%A5%BC%E5%9B%BE/",
            "title": "Superset-集成Echarts饼图",
            "date_published": "2020-04-26T05:41:51.000Z",
            "content_html": "<h1 id=\"操作系统\"><a class=\"anchor\" href=\"#操作系统\">#</a> 操作系统</h1>\n<ul class=\"task-list\">\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_0\" checked=\"true\" disabled=\"true\" /><label for=\"cbx_0\">  Windows</label></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_1\" checked=\"true\" disabled=\"true\" /><label for=\"cbx_1\">  MAC</label></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_2\" checked=\"true\" disabled=\"true\" /><label for=\"cbx_2\">  Linux</label></li>\n</ul>\n<h1 id=\"软件依赖\"><a class=\"anchor\" href=\"#软件依赖\">#</a> 软件依赖</h1>\n<p><span class=\"label info\">^ Lastest</span> <span class=\"label info\">~ minimum</span></p>\n<ul>\n<li>Python3.6~</li>\n<li>Pip~</li>\n<li>node.js~</li>\n</ul>\n<h1 id=\"实验环境\"><a class=\"anchor\" href=\"#实验环境\">#</a> 实验环境</h1>\n<ul>\n<li>Windows10</li>\n<li>python 3.68</li>\n<li>pip 19.2.3</li>\n<li>setuptools 41.4.0</li>\n<li>nodejs 12.15.0</li>\n<li>npm 6.134</li>\n<li>superset 0.35</li>\n</ul>\n<h1 id=\"前端开发\"><a class=\"anchor\" href=\"#前端开发\">#</a> 前端开发</h1>\n<ol>\n<li>在 visualizations 文件夹下创建 EchartsPie 文件夹<br />\n<img data-src=\"1.png\" alt=\"\" /></li>\n<li>在 images 文件夹里面放入图表的缩略图，可以自己去 echarts 官网截图然后放进去，名字不能更改</li>\n<li>创建 index.js</li>\n</ol>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token punctuation\">&#123;</span> t <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'@superset-ui/translation'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token punctuation\">&#123;</span> ChartMetadata<span class=\"token punctuation\">,</span> ChartPlugin <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'@superset-ui/chart'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">import</span> transformProps <span class=\"token keyword\">from</span> <span class=\"token string\">'./transformProps'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">import</span> thumbnail <span class=\"token keyword\">from</span> <span class=\"token string\">'./images/thumbnail.png'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">const</span> metadata <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ChartMetadata</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  name<span class=\"token operator\">:</span> <span class=\"token function\">t</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Echart Pie'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  description<span class=\"token operator\">:</span> <span class=\"token string\">''</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  credits<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'http://echarts.baidu.com/examples/editor.html?c=scatter-effect'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  thumbnail<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">TimeSeriesScatterChartPlugin</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">ChartPlugin</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  <span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token keyword\">super</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>      metadata<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      transformProps<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      <span class=\"token function-variable function\">loadChart</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">import</span><span class=\"token punctuation\">(</span><span class=\"token string\">'./ReactEchartsPie.js'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><ol start=\"4\">\n<li>transformProps.js</li>\n</ol>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> <span class=\"token keyword\">function</span> <span class=\"token function\">transformProps</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">chartProps</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>      <span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span>width<span class=\"token punctuation\">,</span> height<span class=\"token punctuation\">,</span> queryData<span class=\"token punctuation\">,</span> formData<span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> chartProps<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>      <span class=\"token comment\">//formData 前端页面的数据</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>      <span class=\"token comment\">//queryData  后端返回的数据</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>      <span class=\"token keyword\">return</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>          data<span class=\"token operator\">:</span> queryData<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>          width<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>          height<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>          formData<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>          legend<span class=\"token operator\">:</span> queryData<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>legend<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>          series<span class=\"token operator\">:</span> queryData<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><ol start=\"5\">\n<li>创建 ReactEchartsPie.js</li>\n</ol>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token punctuation\">&#123;</span> reactify <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'@superset-ui/chart'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">import</span> Component <span class=\"token keyword\">from</span> <span class=\"token string\">'./EchartsPie'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> <span class=\"token function\">reactify</span><span class=\"token punctuation\">(</span>Component<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><ol start=\"6\">\n<li>创建 EchartsPie</li>\n</ol>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">import</span> d3 <span class=\"token keyword\">from</span> <span class=\"token string\">'d3'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">import</span> PropTypes <span class=\"token keyword\">from</span> <span class=\"token string\">'prop-types'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token punctuation\">&#123;</span> CategoricalColorNamespace <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'@superset-ui/color'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token punctuation\">&#123;</span> getNumberFormatter <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'@superset-ui/number-format'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">import</span> echarts <span class=\"token keyword\">from</span> <span class=\"token string\">'echarts'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">const</span> propTypes <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  data<span class=\"token operator\">:</span> PropTypes<span class=\"token punctuation\">.</span>array<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  width<span class=\"token operator\">:</span> PropTypes<span class=\"token punctuation\">.</span>number<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  height<span class=\"token operator\">:</span> PropTypes<span class=\"token punctuation\">.</span>number<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token keyword\">function</span> <span class=\"token function\">EchartsPie</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">element<span class=\"token punctuation\">,</span> props</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>         width<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>         height<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>         data<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>         formData<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>         series<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>         legend<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>     <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> props<span class=\"token punctuation\">;</span> <span class=\"token comment\">//transformProps.js 返回的数据</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>     <span class=\"token keyword\">const</span> fd <span class=\"token operator\">=</span> formData</pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>     <span class=\"token comment\">// 为了适配颜色</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>     <span class=\"token keyword\">const</span> colorFn <span class=\"token operator\">=</span> CategoricalColorNamespace<span class=\"token punctuation\">.</span><span class=\"token function\">getScale</span><span class=\"token punctuation\">(</span>fd<span class=\"token punctuation\">.</span>colorScheme<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>     <span class=\"token keyword\">var</span> colors <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>     <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>colorFn <span class=\"token operator\">&amp;&amp;</span> colorFn<span class=\"token punctuation\">.</span>colors<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>         colors <span class=\"token operator\">=</span> colorFn<span class=\"token punctuation\">.</span>colors</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>     <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>     <span class=\"token keyword\">const</span> div <span class=\"token operator\">=</span> d3<span class=\"token punctuation\">.</span><span class=\"token function\">select</span><span class=\"token punctuation\">(</span>element<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>     <span class=\"token keyword\">const</span> sliceId <span class=\"token operator\">=</span> <span class=\"token string\">'mix-bar-line-'</span> <span class=\"token operator\">+</span> fd<span class=\"token punctuation\">.</span>sliceId<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>     <span class=\"token keyword\">const</span> html <span class=\"token operator\">=</span> <span class=\"token string\">'&lt;div id='</span><span class=\"token operator\">+</span> sliceId <span class=\"token operator\">+</span> <span class=\"token string\">' style=\"height:'</span> <span class=\"token operator\">+</span> height <span class=\"token operator\">+</span> <span class=\"token string\">'px; width:'</span> <span class=\"token operator\">+</span> width <span class=\"token operator\">+</span> <span class=\"token string\">'px;\">&lt;/div>'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>     div<span class=\"token punctuation\">.</span><span class=\"token function\">html</span><span class=\"token punctuation\">(</span>html<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>     <span class=\"token comment\">//init echarts，light 为制定主题，可以查看官方 api</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>     <span class=\"token keyword\">var</span> myChart <span class=\"token operator\">=</span> echarts<span class=\"token punctuation\">.</span><span class=\"token function\">init</span><span class=\"token punctuation\">(</span>document<span class=\"token punctuation\">.</span><span class=\"token function\">getElementById</span><span class=\"token punctuation\">(</span>sliceId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'light'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>     <span class=\"token comment\">//echarts 渲染图表的数据格式 在官网可以查看</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>    <span class=\"token keyword\">let</span> bgColor <span class=\"token operator\">=</span> <span class=\"token string\">'#fff'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>    <span class=\"token keyword\">let</span> title <span class=\"token operator\">=</span> fd<span class=\"token punctuation\">.</span>echartsPieTitle<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>title <span class=\"token operator\">==</span> <span class=\"token keyword\">undefined</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>        title <span class=\"token operator\">=</span> <span class=\"token string\">\"总量\"</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>    <span class=\"token keyword\">let</span> unit <span class=\"token operator\">=</span> fd<span class=\"token punctuation\">.</span>echartsPieUnit</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>unit <span class=\"token operator\">==</span> <span class=\"token keyword\">undefined</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>        unit <span class=\"token operator\">=</span> <span class=\"token string\">\"个\"</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>    <span class=\"token keyword\">let</span> <span class=\"token function-variable function\">formatNumber</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">num</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>        <span class=\"token keyword\">let</span> reg <span class=\"token operator\">=</span> <span class=\"token regex\"><span class=\"token regex-delimiter\">/</span><span class=\"token regex-source language-regex\">(?=(\\B)(\\d&#123;3&#125;)+$)</span><span class=\"token regex-delimiter\">/</span><span class=\"token regex-flags\">g</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>        <span class=\"token keyword\">return</span> num<span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">replace</span><span class=\"token punctuation\">(</span>reg<span class=\"token punctuation\">,</span> <span class=\"token string\">','</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>    <span class=\"token keyword\">let</span> total <span class=\"token operator\">=</span> series<span class=\"token punctuation\">.</span><span class=\"token function\">reduce</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">a<span class=\"token punctuation\">,</span> b</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>        <span class=\"token keyword\">return</span> a <span class=\"token operator\">+</span> b<span class=\"token punctuation\">.</span>value <span class=\"token operator\">*</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>    <span class=\"token keyword\">var</span> echart_legend <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>    <span class=\"token keyword\">var</span> x <span class=\"token operator\">=</span> fd<span class=\"token punctuation\">.</span>echartsPieLegendX</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>x <span class=\"token operator\">==</span> <span class=\"token keyword\">undefined</span> <span class=\"token operator\">||</span> x <span class=\"token operator\">==</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>        x <span class=\"token operator\">=</span> <span class=\"token string\">'2%'</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token keyword\">else</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>        x <span class=\"token operator\">=</span> fd<span class=\"token punctuation\">.</span>echartsPieLegendX <span class=\"token operator\">+</span> <span class=\"token string\">'%'</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>    <span class=\"token keyword\">var</span> y <span class=\"token operator\">=</span> fd<span class=\"token punctuation\">.</span>echartsPieLegendY</pre></td></tr><tr><td data-num=\"65\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>y <span class=\"token operator\">==</span> <span class=\"token keyword\">undefined</span> <span class=\"token operator\">||</span> y <span class=\"token operator\">==</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>        y <span class=\"token operator\">=</span> <span class=\"token string\">'10%'</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token keyword\">else</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>        y <span class=\"token operator\">=</span> fd<span class=\"token punctuation\">.</span>echartsPieLegendY <span class=\"token operator\">+</span> <span class=\"token string\">'%'</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>    <span class=\"token keyword\">var</span> legend_orient <span class=\"token operator\">=</span> <span class=\"token string\">\"horizontal\"</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>fd<span class=\"token punctuation\">.</span>echartsPieLegendVertical<span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>        legend_orient <span class=\"token operator\">=</span> <span class=\"token string\">\"vertical\"</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>fd<span class=\"token punctuation\">.</span>echartsLegend<span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>        echart_legend <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>          orient<span class=\"token operator\">:</span> legend_orient<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>                        x<span class=\"token operator\">:</span> x<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>                        y<span class=\"token operator\">:</span> y<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>                        data<span class=\"token operator\">:</span> legend<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>                        icon<span class=\"token operator\">:</span><span class=\"token string\">\"circle\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>                        <span class=\"token function-variable function\">formatter</span><span class=\"token operator\">:</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">name</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>                           <span class=\"token keyword\">let</span> res <span class=\"token operator\">=</span> series<span class=\"token punctuation\">.</span><span class=\"token function\">filter</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">v</span> <span class=\"token operator\">=></span> v<span class=\"token punctuation\">.</span>name <span class=\"token operator\">===</span> name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>                           res <span class=\"token operator\">=</span> res<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">||</span> <span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>                           <span class=\"token keyword\">let</span> unit <span class=\"token operator\">=</span> res<span class=\"token punctuation\">.</span>unit <span class=\"token operator\">||</span> <span class=\"token string\">''</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>                           <span class=\"token keyword\">return</span> <span class=\"token string\">'&#123;name|'</span> <span class=\"token operator\">+</span> name <span class=\"token operator\">+</span> <span class=\"token string\">'&#125;  &#123;value|'</span> <span class=\"token operator\">+</span> res<span class=\"token punctuation\">.</span>value <span class=\"token operator\">+</span> <span class=\"token string\">'&#125;&#123;unit|'</span> <span class=\"token operator\">+</span> unit <span class=\"token operator\">+</span> <span class=\"token string\">'&#125;'</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>                        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>                        textStyle<span class=\"token operator\">:</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>                            rich<span class=\"token operator\">:</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>                                a<span class=\"token operator\">:</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>                                    fontSize<span class=\"token operator\">:</span><span class=\"token number\">16</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>                                    color<span class=\"token operator\">:</span><span class=\"token string\">\"#EA5504\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>                                    padding<span class=\"token operator\">:</span><span class=\"token number\">10</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre>                                <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre>                                b<span class=\"token operator\">:</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>                                    fontSize<span class=\"token operator\">:</span><span class=\"token number\">14</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre>                                    color<span class=\"token operator\">:</span><span class=\"token string\">\"#333\"</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre>                                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre>                            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"100\"></td><td><pre>                        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"101\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"102\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"103\"></td><td><pre></pre></td></tr><tr><td data-num=\"104\"></td><td><pre>    <span class=\"token keyword\">var</span> option <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"105\"></td><td><pre>    backgroundColor<span class=\"token operator\">:</span> bgColor<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"106\"></td><td><pre>    color<span class=\"token operator\">:</span> colors<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"107\"></td><td><pre>    tooltip<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"108\"></td><td><pre>        trigger<span class=\"token operator\">:</span> <span class=\"token string\">'item'</span></pre></td></tr><tr><td data-num=\"109\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span>  </pre></td></tr><tr><td data-num=\"110\"></td><td><pre>    <span class=\"token comment\">// toolbox: &#123;</span></pre></td></tr><tr><td data-num=\"111\"></td><td><pre> <span class=\"token comment\">//        feature: &#123;</span></pre></td></tr><tr><td data-num=\"112\"></td><td><pre> <span class=\"token comment\">//            dataView: &#123;show: true, readOnly: false&#125;,</span></pre></td></tr><tr><td data-num=\"113\"></td><td><pre> <span class=\"token comment\">//            magicType: &#123;show: true, type: ['line', 'bar']&#125;,</span></pre></td></tr><tr><td data-num=\"114\"></td><td><pre> <span class=\"token comment\">//            restore: &#123;show: true&#125;,</span></pre></td></tr><tr><td data-num=\"115\"></td><td><pre> <span class=\"token comment\">//            saveAsImage: &#123;show: true&#125;</span></pre></td></tr><tr><td data-num=\"116\"></td><td><pre> <span class=\"token comment\">//        &#125;</span></pre></td></tr><tr><td data-num=\"117\"></td><td><pre> <span class=\"token comment\">//    &#125;,</span></pre></td></tr><tr><td data-num=\"118\"></td><td><pre>    title<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"119\"></td><td><pre>        text<span class=\"token operator\">:</span> <span class=\"token string\">'&#123;name|'</span> <span class=\"token operator\">+</span> title <span class=\"token operator\">+</span> <span class=\"token string\">'&#125;\\n&#123;val|'</span> <span class=\"token operator\">+</span> <span class=\"token function\">formatNumber</span><span class=\"token punctuation\">(</span>total<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">'&#125;'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"120\"></td><td><pre>        top<span class=\"token operator\">:</span> <span class=\"token string\">'center'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"121\"></td><td><pre>        left<span class=\"token operator\">:</span> <span class=\"token string\">'center'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"122\"></td><td><pre>        textStyle<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"123\"></td><td><pre>            rich<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"124\"></td><td><pre>                name<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"125\"></td><td><pre>                    fontSize<span class=\"token operator\">:</span> <span class=\"token number\">14</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"126\"></td><td><pre>                    fontWeight<span class=\"token operator\">:</span> <span class=\"token string\">'normal'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"127\"></td><td><pre>                    color<span class=\"token operator\">:</span> <span class=\"token string\">'#666666'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"128\"></td><td><pre>                    padding<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token number\">10</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"129\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"130\"></td><td><pre>                val<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"131\"></td><td><pre>                    fontSize<span class=\"token operator\">:</span> <span class=\"token number\">32</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"132\"></td><td><pre>                    fontWeight<span class=\"token operator\">:</span> <span class=\"token string\">'bold'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"133\"></td><td><pre>                    color<span class=\"token operator\">:</span> <span class=\"token string\">'#333333'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"134\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"135\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"136\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"137\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"138\"></td><td><pre>        text<span class=\"token operator\">:</span> <span class=\"token string\">'单位：'</span><span class=\"token operator\">+</span>unit<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"139\"></td><td><pre>        top<span class=\"token operator\">:</span> <span class=\"token number\">20</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"140\"></td><td><pre>        left<span class=\"token operator\">:</span> <span class=\"token number\">20</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"141\"></td><td><pre>        textStyle<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"142\"></td><td><pre>            fontSize<span class=\"token operator\">:</span> <span class=\"token number\">14</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"143\"></td><td><pre>            color<span class=\"token operator\">:</span><span class=\"token string\">'#666666'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"144\"></td><td><pre>            fontWeight<span class=\"token operator\">:</span> <span class=\"token number\">400</span></pre></td></tr><tr><td data-num=\"145\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"146\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"147\"></td><td><pre>    legend<span class=\"token operator\">:</span> echart_legend<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"148\"></td><td><pre>    series<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"149\"></td><td><pre>        type<span class=\"token operator\">:</span> <span class=\"token string\">'pie'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"150\"></td><td><pre>        radius <span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'45%'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'60%'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"151\"></td><td><pre>        center<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'50%'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'50%'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"152\"></td><td><pre>        data<span class=\"token operator\">:</span> series<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"153\"></td><td><pre>        hoverAnimation<span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"154\"></td><td><pre>        itemStyle<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"155\"></td><td><pre>            normal<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"156\"></td><td><pre>                borderColor<span class=\"token operator\">:</span> bgColor<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"157\"></td><td><pre>                borderWidth<span class=\"token operator\">:</span> <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"158\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"159\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"160\"></td><td><pre>        labelLine<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"161\"></td><td><pre>            normal<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"162\"></td><td><pre>                length<span class=\"token operator\">:</span> <span class=\"token number\">20</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"163\"></td><td><pre>                length2<span class=\"token operator\">:</span> <span class=\"token number\">120</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"164\"></td><td><pre>                lineStyle<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"165\"></td><td><pre>                    color<span class=\"token operator\">:</span> <span class=\"token string\">'#e6e6e6'</span></pre></td></tr><tr><td data-num=\"166\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"167\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"168\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"169\"></td><td><pre>        label<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"170\"></td><td><pre>            normal<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"171\"></td><td><pre>                <span class=\"token function-variable function\">formatter</span><span class=\"token operator\">:</span> <span class=\"token parameter\">params</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"172\"></td><td><pre>                    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"173\"></td><td><pre>                        <span class=\"token string\">'&#123;icon|●&#125;&#123;name|'</span> <span class=\"token operator\">+</span> params<span class=\"token punctuation\">.</span>name <span class=\"token operator\">+</span> <span class=\"token string\">'&#125;&#123;value|'</span> <span class=\"token operator\">+</span></pre></td></tr><tr><td data-num=\"174\"></td><td><pre>                        <span class=\"token function\">formatNumber</span><span class=\"token punctuation\">(</span>params<span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">'&#125;'</span></pre></td></tr><tr><td data-num=\"175\"></td><td><pre>                    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"176\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"177\"></td><td><pre>                padding<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token number\">0</span> <span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">100</span><span class=\"token punctuation\">,</span> <span class=\"token number\">25</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">100</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"178\"></td><td><pre>                rich<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"179\"></td><td><pre>                    icon<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"180\"></td><td><pre>                        fontSize<span class=\"token operator\">:</span> <span class=\"token number\">16</span></pre></td></tr><tr><td data-num=\"181\"></td><td><pre>                    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"182\"></td><td><pre>                    name<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"183\"></td><td><pre>                        fontSize<span class=\"token operator\">:</span> <span class=\"token number\">14</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"184\"></td><td><pre>                        padding<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">10</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"185\"></td><td><pre>                        color<span class=\"token operator\">:</span> <span class=\"token string\">'#666666'</span></pre></td></tr><tr><td data-num=\"186\"></td><td><pre>                    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"187\"></td><td><pre>                    value<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"188\"></td><td><pre>                        fontSize<span class=\"token operator\">:</span> <span class=\"token number\">18</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"189\"></td><td><pre>                        fontWeight<span class=\"token operator\">:</span> <span class=\"token string\">'bold'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"190\"></td><td><pre>                        color<span class=\"token operator\">:</span> <span class=\"token string\">'#333333'</span></pre></td></tr><tr><td data-num=\"191\"></td><td><pre>                    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"192\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"193\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"194\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"195\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"196\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"197\"></td><td><pre>     <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>fd<span class=\"token punctuation\">.</span>echartsDonut<span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"198\"></td><td><pre>        <span class=\"token keyword\">delete</span> option<span class=\"token punctuation\">[</span><span class=\"token string\">\"series\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>radius </pre></td></tr><tr><td data-num=\"199\"></td><td><pre>     <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"200\"></td><td><pre></pre></td></tr><tr><td data-num=\"201\"></td><td><pre>     myChart<span class=\"token punctuation\">.</span><span class=\"token function\">setOption</span><span class=\"token punctuation\">(</span>option<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"202\"></td><td><pre></pre></td></tr><tr><td data-num=\"203\"></td><td><pre></pre></td></tr><tr><td data-num=\"204\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"205\"></td><td><pre></pre></td></tr><tr><td data-num=\"206\"></td><td><pre>EchartsPie<span class=\"token punctuation\">.</span>displayName <span class=\"token operator\">=</span> <span class=\"token string\">'Echarts Pie'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"207\"></td><td><pre>EchartsPie<span class=\"token punctuation\">.</span>propTypes <span class=\"token operator\">=</span> propTypes<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"208\"></td><td><pre></pre></td></tr><tr><td data-num=\"209\"></td><td><pre><span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> EchartsPie<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><ol start=\"7\">\n<li>修改 /visualizations/presets/MainPreset.js<br />\n<img data-src=\"2.png\" alt=\"\" /></li>\n</ol>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// 开头导入</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">import</span> EchartsPieChartPlugin <span class=\"token keyword\">from</span> <span class=\"token string\">'../EchartsPie/index.js'</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">//plugins 下增加</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">new</span> <span class=\"token class-name\">EchartsPieChartPlugin</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">configure</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span> key<span class=\"token operator\">:</span> <span class=\"token string\">'echarts_pie'</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr></table></figure><ol start=\"8\">\n<li>修改 /explore/components/controls/VizTypeControl.jsx<br />\n 变量 DEFAULT_ORDER 增加 'echarts_pie'</li>\n</ol>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">const</span> <span class=\"token constant\">DEFAULT_ORDER</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token string\">'line'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'big_number'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'table'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'filter_box'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'dist_bar'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'area'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'bar'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token string\">'deck_polygon'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'pie'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'time_table'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'pivot_table'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'histogram'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token string\">'big_number_total'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'deck_scatter'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'deck_hex'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'time_pivot'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'deck_arc'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token string\">'heatmap'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'deck_grid'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'dual_line'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'deck_screengrid'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'line_multi'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token string\">'treemap'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'box_plot'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'separator'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'sunburst'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'sankey'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'word_cloud'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token string\">'mapbox'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'kepler'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'cal_heatmap'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'rose'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'bubble'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'deck_geojson'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token string\">'horizon'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'markup'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'deck_multi'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'compare'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'partition'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'event_flow'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token string\">'deck_path'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'directed_force'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'world_map'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'paired_ttest'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'para'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token string\">'iframe'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'country_map'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'echarts_pie'</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><ol start=\"9\">\n<li>新建 /explore/controlPanels/EchartsPie.js<br />\n<img data-src=\"3.png\" alt=\"\" /></li>\n</ol>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"2\"></td><td><pre> *   https://www.echartsjs.com/examples/zh/editor.html?c=mix-line-bar</pre></td></tr><tr><td data-num=\"3\"></td><td><pre> *   mix line bar</pre></td></tr><tr><td data-num=\"4\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token punctuation\">&#123;</span> t <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'@superset-ui/translation'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    requiresTime<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    controlPanelSections<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>            label<span class=\"token operator\">:</span> <span class=\"token function\">t</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Chart Options'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>            expanded<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>            controlSetRows<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>                <span class=\"token punctuation\">[</span><span class=\"token string\">'color_scheme'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'label_colors'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>            <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>            label<span class=\"token operator\">:</span> <span class=\"token function\">t</span><span class=\"token punctuation\">(</span><span class=\"token string\">'X Axis'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>            expanded<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>            controlSetRows<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>                <span class=\"token punctuation\">[</span><span class=\"token string\">'groupby'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>            <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>            label<span class=\"token operator\">:</span> <span class=\"token function\">t</span><span class=\"token punctuation\">(</span><span class=\"token string\">'metrics'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>            expanded<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>            controlSetRows<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>                <span class=\"token punctuation\">[</span><span class=\"token string\">'echarts_pie_metrics'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>            <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>            label<span class=\"token operator\">:</span> <span class=\"token function\">t</span><span class=\"token punctuation\">(</span><span class=\"token string\">'样式设置'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>            expanded<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>            controlSetRows<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>                <span class=\"token punctuation\">[</span><span class=\"token string\">'echarts_pie_title'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"echarts_donut\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"echarts_pie_unit\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"echarts_legend\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>            <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>            label<span class=\"token operator\">:</span> <span class=\"token function\">t</span><span class=\"token punctuation\">(</span><span class=\"token string\">'legend设置'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>            expanded<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>            controlSetRows<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>                <span class=\"token punctuation\">[</span><span class=\"token string\">'echarts_pie_legend_x'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"echarts_pie_legend_y\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"echarts_pie_legend_vertical\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>            <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre></pre></td></tr><tr><td data-num=\"49\"></td><td><pre></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>            label<span class=\"token operator\">:</span> <span class=\"token function\">t</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Query'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>            expanded<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>            controlSetRows<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>                <span class=\"token punctuation\">[</span><span class=\"token string\">'adhoc_filters'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>            <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>    controlOverrides<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><ol start=\"10\">\n<li>修改 /explore/controls.jsx<br />\n<img data-src=\"4.png\" alt=\"\" /><br />\n 在文件最下面添加</li>\n</ol>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// echarts pie</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    echarts_pie_metrics<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>      <span class=\"token operator\">...</span>metrics<span class=\"token punctuation\">,</span> <span class=\"token comment\">// 继承</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>      multi<span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// 多选</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>      clearable<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// 是否可调用， true 当作 sql</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>      validators<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// 是否可以为空</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>      label<span class=\"token operator\">:</span> <span class=\"token function\">t</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Metrics'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>      description<span class=\"token operator\">:</span> <span class=\"token function\">t</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Metrics for which line type are to be displayed'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    echarts_pie_title<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      type<span class=\"token operator\">:</span> <span class=\"token string\">'TextControl'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      label<span class=\"token operator\">:</span> <span class=\"token function\">t</span><span class=\"token punctuation\">(</span><span class=\"token string\">'标题'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      renderTrigger<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      <span class=\"token keyword\">default</span><span class=\"token operator\">:</span> <span class=\"token string\">'总量'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    echarts_pie_unit<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      type<span class=\"token operator\">:</span> <span class=\"token string\">'TextControl'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      label<span class=\"token operator\">:</span> <span class=\"token function\">t</span><span class=\"token punctuation\">(</span><span class=\"token string\">'单位'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>      renderTrigger<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>      <span class=\"token keyword\">default</span><span class=\"token operator\">:</span> <span class=\"token string\">'个'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    echarts_donut<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>      type<span class=\"token operator\">:</span> <span class=\"token string\">'CheckboxControl'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>      label<span class=\"token operator\">:</span> <span class=\"token function\">t</span><span class=\"token punctuation\">(</span><span class=\"token string\">'是否镂空'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>      <span class=\"token keyword\">default</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>      renderTrigger<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>      description<span class=\"token operator\">:</span> <span class=\"token function\">t</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Do you want a donut or a pie?'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    echarts_legend<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>      type<span class=\"token operator\">:</span> <span class=\"token string\">'CheckboxControl'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>      label<span class=\"token operator\">:</span> <span class=\"token function\">t</span><span class=\"token punctuation\">(</span><span class=\"token string\">'是否显示legend'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>      <span class=\"token keyword\">default</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>      renderTrigger<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>      description<span class=\"token operator\">:</span> <span class=\"token function\">t</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Do you want a donut or a pie?'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>    echarts_pie_legend_vertical<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>      type<span class=\"token operator\">:</span> <span class=\"token string\">'CheckboxControl'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>      label<span class=\"token operator\">:</span> <span class=\"token function\">t</span><span class=\"token punctuation\">(</span><span class=\"token string\">'legend是否垂直排列'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>      <span class=\"token keyword\">default</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>      renderTrigger<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>      description<span class=\"token operator\">:</span> <span class=\"token function\">t</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Do you want a donut or a pie?'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>    echarts_pie_legend_x<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>       type<span class=\"token operator\">:</span> <span class=\"token string\">'TextControl'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>       label<span class=\"token operator\">:</span> <span class=\"token function\">t</span><span class=\"token punctuation\">(</span><span class=\"token string\">'legend x position'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>       renderTrigger<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>       <span class=\"token keyword\">default</span><span class=\"token operator\">:</span> <span class=\"token string\">''</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>        isInt<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>     <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>     echarts_pie_legend_y<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>        type<span class=\"token operator\">:</span> <span class=\"token string\">'TextControl'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>        label<span class=\"token operator\">:</span> <span class=\"token function\">t</span><span class=\"token punctuation\">(</span><span class=\"token string\">'legend y position'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>        renderTrigger<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>        <span class=\"token keyword\">default</span><span class=\"token operator\">:</span> <span class=\"token string\">''</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>         isInt<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr></table></figure><ol start=\"11\">\n<li>修改 /setup/setupPlugins.ts<br />\n<img data-src=\"5.png\" alt=\"\" /></li>\n</ol>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// 开头导入</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">import</span> EchartsPie <span class=\"token keyword\">from</span> <span class=\"token string\">'../explore/controlPanels/EchartsPie'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">//getChartControlPanelRegistry 下增加，注意只有最后一个有分号</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">.</span><span class=\"token function\">registerValue</span><span class=\"token punctuation\">(</span><span class=\"token string\">'echarts_pie'</span><span class=\"token punctuation\">,</span> EchartsPie<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><ol start=\"12\">\n<li>修改 \\superset\\assets\\package.json, 引入 npm echarts 包（如果已经引入则跳过）<br />\n<img data-src=\"6.png\" alt=\"\" /></li>\n</ol>\n<figure class=\"highlight json\"><figcaption data-lang=\"JSON\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// 找到 dependencies 下面增加</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token property\">\"echarts\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"^4.7.0\"</span></pre></td></tr></table></figure><h1 id=\"后端开发\"><a class=\"anchor\" href=\"#后端开发\">#</a> 后端开发</h1>\n<ol>\n<li>修改 superset/viz.py，修改 METRIC_KEYS，添加 echarts_pie_metrics</li>\n</ol>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token operator\">//</span>找到METRIC_KEYS</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>METRIC_KEYS <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token string\">\"metric\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token string\">\"metrics\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token string\">\"percent_metrics\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token string\">\"metric_2\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token string\">\"secondary_metric\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token string\">\"x\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token string\">\"y\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token string\">\"size\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token string\">\"echarts_pie_metrics\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">]</span></pre></td></tr></table></figure><ol start=\"2\">\n<li>修改 superset/viz.py，在 viz_types 前添加下面代码</li>\n</ol>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name\">EchartsPieViz</span><span class=\"token punctuation\">(</span>NVD3Viz<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token triple-quoted-string string\">\"\"\" echarts pie  \"\"\"</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    viz_type <span class=\"token operator\">=</span> <span class=\"token string\">\"echarts_pie\"</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    verbose_name <span class=\"token operator\">=</span> _<span class=\"token punctuation\">(</span><span class=\"token string\">\"Echarts Pie\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token comment\"># 是否排序</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    sort_series <span class=\"token operator\">=</span> <span class=\"token boolean\">False</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token comment\"># 是否对 time 做处理 _timestamp</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    is_timeseries <span class=\"token operator\">=</span> <span class=\"token boolean\">False</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token keyword\">def</span> <span class=\"token function\">query_obj</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token comment\"># check bar column, line column 是否重复</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        bar_metrics <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>form_data<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span><span class=\"token string\">'echarts_pie_metrics'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token keyword\">not</span> bar_metrics <span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>            <span class=\"token keyword\">raise</span> Exception<span class=\"token punctuation\">(</span>_<span class=\"token punctuation\">(</span><span class=\"token string\">\"Please choose metrics on line or bar type\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        bar_metrics <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token keyword\">if</span> <span class=\"token keyword\">not</span> bar_metrics <span class=\"token keyword\">else</span> bar_metrics</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        d <span class=\"token operator\">=</span> <span class=\"token builtin\">super</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>query_obj<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>d<span class=\"token punctuation\">[</span><span class=\"token string\">\"groupby\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">></span><span class=\"token number\">1</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>            <span class=\"token keyword\">raise</span> Exception<span class=\"token punctuation\">(</span>_<span class=\"token punctuation\">(</span><span class=\"token string\">\"groupby has to be one\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        <span class=\"token keyword\">return</span> d</pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token keyword\">def</span> <span class=\"token function\">to_series</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> df<span class=\"token punctuation\">,</span> classed<span class=\"token operator\">=</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        <span class=\"token triple-quoted-string string\">\"\"\"</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>         拼接 前端渲染需要的数据</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        :param df:</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        :param classed:</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        :return: &#123;'legend':[], 'bar':[], 'line':[]&#125;</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>        \"\"\"</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>        cols <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>        <span class=\"token keyword\">for</span> col <span class=\"token keyword\">in</span> df<span class=\"token punctuation\">.</span>columns<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>            <span class=\"token keyword\">if</span> col <span class=\"token operator\">==</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>                cols<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span><span class=\"token string\">\"N/A\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>            <span class=\"token keyword\">elif</span> col <span class=\"token keyword\">is</span> <span class=\"token boolean\">None</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>                cols<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span><span class=\"token string\">\"NULL\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>            <span class=\"token keyword\">else</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>                cols<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span>col<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>        df<span class=\"token punctuation\">.</span>columns <span class=\"token operator\">=</span> cols</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>        metrics <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>all_metrics</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>        legend<span class=\"token punctuation\">,</span> data <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>        series <span class=\"token operator\">=</span> df<span class=\"token punctuation\">.</span>to_dict<span class=\"token punctuation\">(</span><span class=\"token string\">\"series\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>        <span class=\"token keyword\">for</span> mt <span class=\"token keyword\">in</span> metrics<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>            m_label <span class=\"token operator\">=</span> utils<span class=\"token punctuation\">.</span>get_metric_name<span class=\"token punctuation\">(</span>mt<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>            ys <span class=\"token operator\">=</span>  <span class=\"token builtin\">list</span><span class=\"token punctuation\">(</span>series<span class=\"token punctuation\">[</span>m_label<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>items<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>            <span class=\"token keyword\">for</span> y <span class=\"token keyword\">in</span> ys<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>                info <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span><span class=\"token string\">\"name\"</span><span class=\"token punctuation\">:</span> y<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"value\"</span><span class=\"token punctuation\">:</span> y<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>                data<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span>info<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>                legend<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span>y<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>        chart_data <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>            <span class=\"token string\">'legend'</span><span class=\"token punctuation\">:</span> legend<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>            <span class=\"token string\">'data'</span><span class=\"token punctuation\">:</span> data<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>        <span class=\"token keyword\">return</span> chart_data</pre></td></tr><tr><td data-num=\"56\"></td><td><pre></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>    <span class=\"token keyword\">def</span> <span class=\"token function\">get_data</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> df<span class=\"token punctuation\">:</span> pd<span class=\"token punctuation\">.</span>DataFrame<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>        <span class=\"token comment\"># 后端返回的数据</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>        df <span class=\"token operator\">=</span> df<span class=\"token punctuation\">.</span>pivot_table<span class=\"token punctuation\">(</span>index<span class=\"token operator\">=</span>self<span class=\"token punctuation\">.</span>groupby<span class=\"token punctuation\">,</span> values<span class=\"token operator\">=</span>self<span class=\"token punctuation\">.</span>metric_labels<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>        chart_data <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>to_series<span class=\"token punctuation\">(</span>df<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>        <span class=\"token keyword\">return</span> chart_data</pre></td></tr><tr><td data-num=\"62\"></td><td><pre></pre></td></tr><tr><td data-num=\"63\"></td><td><pre></pre></td></tr><tr><td data-num=\"64\"></td><td><pre><span class=\"token operator\">//</span>在这之前添加代码</pre></td></tr><tr><td data-num=\"65\"></td><td><pre>viz_types <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>    o<span class=\"token punctuation\">.</span>viz_type<span class=\"token punctuation\">:</span> o</pre></td></tr><tr><td data-num=\"67\"></td><td><pre>    <span class=\"token keyword\">for</span> o <span class=\"token keyword\">in</span> <span class=\"token builtin\">globals</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>values<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>        inspect<span class=\"token punctuation\">.</span>isclass<span class=\"token punctuation\">(</span>o<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>        <span class=\"token keyword\">and</span> <span class=\"token builtin\">issubclass</span><span class=\"token punctuation\">(</span>o<span class=\"token punctuation\">,</span> BaseViz<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>        <span class=\"token keyword\">and</span> o<span class=\"token punctuation\">.</span>viz_type <span class=\"token keyword\">not</span> <span class=\"token keyword\">in</span> config<span class=\"token punctuation\">[</span><span class=\"token string\">\"VIZ_TYPE_BLACKLIST\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>    <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h1 id=\"运行\"><a class=\"anchor\" href=\"#运行\">#</a> 运行</h1>\n<ol>\n<li>如果没有安装 echarts，先安装 echarts</li>\n</ol>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>$ <span class=\"token builtin class-name\">cd</span> superset/assets</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>$ <span class=\"token function\">npm</span> <span class=\"token function\">install</span> echarts --save</pre></td></tr></table></figure><ol start=\"2\">\n<li>重新编译前端</li>\n</ol>\n<pre><code>// 或者npm run dev\nnpm run build\n</code></pre>\n<ol start=\"3\">\n<li>运行后台 superset，访问 superset，创建一个图表<br />\n<img data-src=\"7.png\" alt=\"\" /></li>\n<li>镂空形状<br />\n<img data-src=\"8.png\" alt=\"\" /></li>\n<li>非镂空形状<br />\n<img data-src=\"9.png\" alt=\"\" /></li>\n</ol>\n<h1 id=\"相关\"><a class=\"anchor\" href=\"#相关\">#</a> 相关</h1>\n<p><a href=\"/Superset-%E5%9B%BE%E8%A1%A8%E6%B8%B2%E6%9F%93%E6%B5%81%E7%A8%8B/\">Superset - 图表渲染流程</a><br />\n<a href=\"/Superset-%E4%BA%8C%E6%AC%A1%E5%BC%80%E5%8F%91%E6%8C%87%E5%8D%97/\"> Superset - 二次开发指南</a></p>\n",
            "tags": [
                "计算机科学",
                "大数据",
                "数据可视化",
                "superset",
                "python",
                "react",
                "echarts"
            ]
        }
    ]
}