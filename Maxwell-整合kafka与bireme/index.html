<!-- build time:Fri Apr 23 2021 17:18:44 GMT+0800 (GMT+08:00) --><!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#FFF"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png"><link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="alternate" type="application/rss+xml" title="专注技术分享" href="http://yrmlnf.coding-pages.com/rss.xml"><link rel="alternate" type="application/atom+xml" title="专注技术分享" href="http://yrmlnf.coding-pages.com/atom.xml"><link rel="alternate" type="application/json" title="专注技术分享" href="http://yrmlnf.coding-pages.com/feed.json"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="/css/app.css?v=0.2.5"><meta name="keywords" content="maxwell,bireme,kafka"><link rel="canonical" href="http://yrmlnf.coding-pages.com/Maxwell-%E6%95%B4%E5%90%88kafka%E4%B8%8Ebireme/"><title>Maxwell-整合kafka与bireme - 大数据 - 计算机科学 | Lucas Home = 专注技术分享 = 醒醒，别做梦了</title><meta name="generator" content="Hexo 5.4.0"></head><body itemscope itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline">Maxwell-整合kafka与bireme</h1><div class="meta"><span class="item" title="创建时间：2021-03-31 10:28:30"><span class="icon"><i class="ic i-calendar"></i> </span><span class="text">发表于</span> <time itemprop="dateCreated datePublished" datetime="2021-03-31T10:28:30+08:00">2021-03-31</time> </span><span class="item" title="本文字数"><span class="icon"><i class="ic i-pen"></i> </span><span class="text">本文字数</span> <span>33k</span> <span class="text">字</span> </span><span class="item" title="阅读时长"><span class="icon"><i class="ic i-clock"></i> </span><span class="text">阅读时长</span> <span>30 分钟</span></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="切换导航栏"><span class="line"></span> <span class="line"></span> <span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/" rel="start">Lucas Home</a></li></ul><ul class="right"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div id="imgs" class="pjax"><ul><li class="item" data-background-image="https://tva4.sinaimg.cn/large/005yAHGDly8gplfen2ianj31hc0u0qh0.jpg"></li><li class="item" data-background-image="https://tva4.sinaimg.cn/large/005yAHGDly8gplgvgg14sj31hc0u0wk0.jpg"></li><li class="item" data-background-image="https://tva4.sinaimg.cn/large/005yAHGDly8gplguqekvhj31cv0q9tcp.jpg"></li><li class="item" data-background-image="https://tva4.sinaimg.cn/large/005yAHGDly8gplgtt2qdsj31zo0u00xe.jpg"></li><li class="item" data-background-image="https://tva4.sinaimg.cn/large/005yAHGDly8gplfey3d76j31hc0u0k28.jpg"></li><li class="item" data-background-image="https://tva4.sinaimg.cn/large/005yAHGDly8gplfeqrjo2j31hc0u0nae.jpg"></li></ul></div></header><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"/></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"/><use xlink:href="#gentle-wave" x="48" y="3"/><use xlink:href="#gentle-wave" x="48" y="5"/><use xlink:href="#gentle-wave" x="48" y="7"/></g></svg></div><main><div class="inner"><div id="main" class="pjax"><div class="article wrap"><div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i> <span><a href="/">首页</a></span><i class="ic i-angle-right"></i> <span itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/" itemprop="item" rel="index" title="分类于 计算机科学"><span itemprop="name">计算机科学</span></a><meta itemprop="position" content="1"></span><i class="ic i-angle-right"></i> <span class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/%E5%A4%A7%E6%95%B0%E6%8D%AE/" itemprop="item" rel="index" title="分类于 大数据"><span itemprop="name">大数据</span></a><meta itemprop="position" content="2"></span></div><article itemscope itemtype="http://schema.org/Article" class="post block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="http://yrmlnf.coding-pages.com/Maxwell-%E6%95%B4%E5%90%88kafka%E4%B8%8Ebireme/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jpg"><meta itemprop="name" content="Lucas"><meta itemprop="description" content="醒醒，别做梦了, "></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="专注技术分享"></span><div class="body md" itemprop="articleBody"><h1 id="mysqlmaridb-开启binlog"><a class="anchor" href="#mysqlmaridb-开启binlog">#</a> mysql (maridb) 开启 binlog</h1><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">SHOW</span> VARIABLES <span class="token operator">LIKE</span> <span class="token string">'%log_bin%'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token operator">+</span><span class="token comment">---------------+-------+</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token operator">|</span> Variable_name <span class="token operator">|</span> <span class="token keyword">Value</span> <span class="token operator">|</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token operator">+</span><span class="token comment">---------------+-------+</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token operator">|</span> log_bin       <span class="token operator">|</span> <span class="token keyword">OFF</span>   <span class="token operator">|</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token operator">+</span><span class="token comment">---------------+-------+</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment">--  如果返回 OFF 没有开启，ON 则是已经开启</span></pre></td></tr></table></figure><h2 id="设置开启login"><a class="anchor" href="#设置开启login">#</a> 设置开启 login</h2><p etcmy.cnf.dserver.cnf="">修改 my.cnf，mysql 一般位于 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mrow><mi mathvariant="normal">/</mi><mi>e</mi><mi>t</mi><mi>c</mi><mi mathvariant="normal">/</mi><mi>m</mi><mi>y</mi><mi mathvariant="normal">.</mi><mi>c</mi><mi>n</mi><mi>f</mi></mrow></mstyle></mrow><annotation encoding="application/x-tex">\color{red}{/etc/my.cnf}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-.25em"></span><span class="mord" style="color:red"><span class="mord" style="color:red">/</span><span class="mord mathnormal" style="color:red">e</span><span class="mord mathnormal" style="color:red">t</span><span class="mord mathnormal" style="color:red">c</span><span class="mord" style="color:red">/</span><span class="mord mathnormal" style="color:red">m</span><span class="mord mathnormal" style="margin-right:.03588em;color:red">y</span><span class="mord" style="color:red">.</span><span class="mord mathnormal" style="color:red">c</span><span class="mord mathnormal" style="color:red">n</span><span class="mord mathnormal" style="margin-right:.10764em;color:red">f</span></span></span></span></span> maridb 一般位于<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"></mstyle></mrow><annotation encoding="application/x-tex">\color{red}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"></span></span></p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># mysqld 中添加如下</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>mysqld<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="3"></td><td><pre>log-bin <span class="token operator">=</span> mysql-bin <span class="token comment">#开启 binlog</span></pre></td></tr><tr><td data-num="4"></td><td><pre>binlog-format <span class="token operator">=</span> ROW <span class="token comment">#选择 row 模式</span></pre></td></tr><tr><td data-num="5"></td><td><pre>server_id <span class="token operator">=</span> <span class="token number">1</span> <span class="token comment">#配置 mysql replication 需要定义，不能和 canal 的 slaveId 重复</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment">## 开启 gtid 模式</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment">#gtid-mode=ON</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token comment">#log-slave-updates=ON</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token comment">#enforce-gtid-consistency=true</span></pre></td></tr></table></figure><p>修改后重启数据库</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">service</span> mysql restart</pre></td></tr></table></figure><p><strong>检查是否开启</strong></p><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">show</span> <span class="token keyword">global</span> variables <span class="token operator">like</span> <span class="token string">"%log_bin%"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token operator">+</span><span class="token comment">---------------------------------+---------------------------------------+</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token operator">|</span> Variable_name                   <span class="token operator">|</span> <span class="token keyword">Value</span>                                 <span class="token operator">|</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token operator">+</span><span class="token comment">---------------------------------+---------------------------------------+</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token operator">|</span> log_bin                         <span class="token operator">|</span> <span class="token keyword">ON</span>                                    <span class="token operator">|</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token operator">|</span> log_bin_basename                <span class="token operator">|</span> <span class="token operator">/</span>usr<span class="token operator">/</span><span class="token keyword">local</span><span class="token operator">/</span>mysql<span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>mysql<span class="token operator">-</span>bin       <span class="token operator">|</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token operator">|</span> log_bin_index                   <span class="token operator">|</span> <span class="token operator">/</span>usr<span class="token operator">/</span><span class="token keyword">local</span><span class="token operator">/</span>mysql<span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>mysql<span class="token operator">-</span>bin<span class="token punctuation">.</span><span class="token keyword">index</span> <span class="token operator">|</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token operator">|</span> log_bin_trust_function_creators <span class="token operator">|</span> <span class="token keyword">OFF</span>                                   <span class="token operator">|</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token operator">|</span> log_bin_use_v1_row_events       <span class="token operator">|</span> <span class="token keyword">OFF</span>                                   <span class="token operator">|</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token operator">+</span><span class="token comment">---------------------------------+---------------------------------------+</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token keyword">SHOW</span> VARIABLES <span class="token operator">LIKE</span> <span class="token string">'%log_bin%'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token operator">+</span><span class="token comment">---------------+-------+</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token operator">|</span> Variable_name <span class="token operator">|</span> <span class="token keyword">Value</span> <span class="token operator">|</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token operator">+</span><span class="token comment">---------------+-------+</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token operator">|</span> log_bin       <span class="token operator">|</span> <span class="token keyword">ON</span>    <span class="token operator">|</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token operator">+</span><span class="token comment">---------------+-------+</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token comment">-- 开启成功</span></pre></td></tr></table></figure><h2 id="创始用户及表"><a class="anchor" href="#创始用户及表">#</a> 创始用户及表</h2><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">-- 开通 MySQL 高权限账号</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">CREATE</span> <span class="token keyword">USER</span> <span class="token string">'maxwell'</span><span class="token variable">@'%'</span> IDENTIFIED <span class="token keyword">BY</span> <span class="token string">'maxwell'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">GRANT</span> <span class="token keyword">ALL</span> <span class="token keyword">ON</span> maxwell<span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">TO</span> <span class="token string">'maxwell'</span><span class="token variable">@'%'</span> IDENTIFIED <span class="token keyword">BY</span> <span class="token string">'maxwell'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">GRANT</span> <span class="token keyword">SELECT</span><span class="token punctuation">,</span> <span class="token keyword">REPLICATION</span> CLIENT<span class="token punctuation">,</span><span class="token keyword">REPLICATION</span> SLAVE <span class="token keyword">ON</span> <span class="token operator">*</span><span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">TO</span> <span class="token string">'maxwell'</span><span class="token variable">@'%'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>FLUSH <span class="token keyword">PRIVILEGES</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment">-- 初始化表</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> tb1<span class="token punctuation">(</span>a <span class="token keyword">int</span><span class="token punctuation">,</span> b <span class="token keyword">char</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">primary</span> <span class="token keyword">key</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr></table></figure><h1 id="maxwell"><a class="anchor" href="#maxwell">#</a> maxwell</h1><blockquote><p><span class="exturl" data-url="aHR0cDovL21heHdlbGxzLWRhZW1vbi5pby8=">Maxwell</span> 通过 canal 解析 binlog，并将其发送到 Kafka</p></blockquote><h2 id="maxwell主要功能"><a class="anchor" href="#maxwell主要功能">#</a> Maxwell 主要功能</h2><ul><li>支持 SELECT * FROM table 的方式进行全量数据初始化</li><li>支持在主库发生 failover 后，自动恢复 binlog 位置 (GTID)</li><li>可以对数据进行分区，解决数据倾斜问题，发送到 kafka 的数据支持 database、table、column 等级别的数据分区</li><li>工作方式是伪装为 Slave，接收 binlog events，然后根据 schemas 信息拼装，可以接受 ddl、xid、row 等各种 event</li></ul><p><strong>常见 mysql binlog 解析工具对比</strong></p><p><img data-src="https://cdn.jsdelivr.net/gh/happydj/cloudimg@master/data/20200628110252.png" alt=""></p><ul><li><p><em>canal 由 Java 开发，分为服务端和客户端，拥有众多的衍生应用，性能稳定，功能强大；canal 需要自己编写客户端来消费 canal 解析到的数据。</em></p></li><li><p><em>maxwell 相对于 canal 的优势是使用简单，它直接将数据变更输出为 json 字符串，不需要再编写客户端。</em></p></li></ul><h2 id="快速开始"><a class="anchor" href="#快速开始">#</a> 快速开始</h2><blockquote><p>首先 MySQL 需要先启用 binlog，关于什么是 MySQL binlog，可以参考文章《<span class="exturl" data-url="aHR0cHM6Ly9tcC53ZWl4aW4ucXEuY29tL3M/X19iaXo9TXpJMU5EVTBNVEUxTkE9PSZhbXA7bWlkPTIyNDc0ODM4NzUmYW1wO2lkeD0xJmFtcDtzbj0yY2RjMjMyZmEzMDM2ZGE1MmE4MjY5NjQ5OTY1MDZhOCZhbXA7Y2hrc209ZTljMmVkZWVkZWI1NjRmODkxYjM0ZWYxZTQ3NDE4YmJlNmI4Y2I2ZGNiN2Y0OGI1ZmE3M2IxNWNmMWQ2MzE3MmRmMWExNzNjNzVkMCZhbXA7c2NlbmU9MCZhbXA7eHRyYWNrPTEmYW1wO2tleT1lMzk3N2Y4YTc5NDkwYzYzNDViZWZiODhkMGJiZjc0Y2JkYzZiNTA4YTUyZTYxZWEwNzZjODMwYTViNjRjNTUyZGVmNmM2YWQ4NDhkNGJjYzdhMWQyMWU1M2UzMGViNWMxZWFkMzNhY2RiOTdkZjc3OWQwZTZmYThhMGZiZTRiZGEzMmMwNDA3N2VhMGQzNTExYmM5Zjk0OTBhZDBiNDZjJmFtcDthc2NlbmU9MSZhbXA7dWluPU1qSTRNVGMwT0RFd09RJTNEJTNEJmFtcDtkZXZpY2V0eXBlPVdpbmRvd3MrNyZhbXA7dmVyc2lvbj02MjA2MDcxOSZhbXA7bGFuZz16aF9DTiZhbXA7cGFzc190aWNrZXQ9aDhqeXJRNzFoUWM4NzJMeHlkWlMlMkYzYVUxSlhGYnA0cmFRMUt2WTkwOEJjS0JlU0J0WEZnQlk5SVM5WmFMRURp">MySQL Binlog 介绍</span>》</p></blockquote><ol><li><p><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3plbmRlc2svbWF4d2VsbC9yZWxlYXNlcw==">maxwell 下载地址</span></p></li><li><p><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3plbmRlc2svbWF4d2VsbA==">maxwell 官方文档</span></p></li><li><p>解压: tar xf maxwell.tar.gz</p></li><li><p>简单测试</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 直接输入到终端窗口 </span></pre></td></tr><tr><td data-num="2"></td><td><pre>bin/maxwell <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="3"></td><td><pre>--host<span class="token operator">=</span><span class="token string">'localhost'</span> <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="4"></td><td><pre>--port<span class="token operator">=</span><span class="token number">3306</span> <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="5"></td><td><pre>--user<span class="token operator">=</span><span class="token string">'maxwell'</span> <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="6"></td><td><pre>--password<span class="token operator">=</span><span class="token string">'maxwell'</span> <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="7"></td><td><pre>--producer<span class="token operator">=</span>stdout <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="8"></td><td><pre>--log_level<span class="token operator">=</span>INFO</pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment"># mysql sql</span></pre></td></tr><tr><td data-num="11"></td><td><pre>insert into tb2 value<span class="token punctuation">(</span><span class="token number">10</span>,<span class="token string">"10"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token comment"># 控制台输出</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token punctuation">&#123;</span><span class="token string">"database"</span><span class="token builtin class-name">:</span><span class="token string">"sampledata"</span>,<span class="token string">"table"</span><span class="token builtin class-name">:</span><span class="token string">"tb2"</span>,<span class="token string">"type"</span><span class="token builtin class-name">:</span><span class="token string">"bootstrap-insert"</span>,<span class="token string">"ts"</span>:1584716272,<span class="token string">"xid"</span>:832,<span class="token string">"data"</span>:<span class="token punctuation">&#123;</span><span class="token string">"a"</span>:10,<span class="token string">"b"</span><span class="token builtin class-name">:</span><span class="token string">"10"</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token comment">## 输入到 kafka</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token comment"># 创建 topic </span></pre></td></tr><tr><td data-num="18"></td><td><pre>./kafka-topics.sh --create --zookeeper hdp-m-1.data.dc.zjft.com:2181 hdp-m-2.data.dc.zjft.com:2181 hdp-e-1.data.dc.zjft.com:2181 --replication-factor <span class="token number">1</span> --partitions <span class="token number">1</span> --topic maxwell</pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token comment"># 启动消费者</span></pre></td></tr><tr><td data-num="21"></td><td><pre>./kafka-console-consumer.sh --topic maxwell --bootstrap-server hdp-s-1.data.dc.zjft.com:6667</pre></td></tr><tr><td data-num="22"></td><td><pre></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token comment"># 运行 maxwell</span></pre></td></tr><tr><td data-num="24"></td><td><pre>bin/maxwell --user<span class="token operator">=</span><span class="token string">'maxwell'</span> <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    --password<span class="token operator">=</span><span class="token string">'maxwell'</span> --host<span class="token operator">=</span><span class="token string">'localshot'</span> <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    --producer<span class="token operator">=</span>kafka <span class="token punctuation">\</span> </pre></td></tr><tr><td data-num="27"></td><td><pre>    --kafka.bootstrap.servers<span class="token operator">=</span><span class="token string">'hdp-s-1.data.dc.zjft.com:6667'</span> <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    --kafka_topic<span class="token operator">=</span>maxwell <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    --log_level<span class="token operator">=</span>info</pre></td></tr><tr><td data-num="30"></td><td><pre>    </pre></td></tr><tr><td data-num="31"></td><td><pre><span class="token comment"># insert</span></pre></td></tr><tr><td data-num="32"></td><td><pre>insert into tb2 value<span class="token punctuation">(</span><span class="token number">1</span>,<span class="token string">"2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>insert into tb2 value<span class="token punctuation">(</span><span class="token number">2</span>,<span class="token string">"b"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>insert into tb2 value<span class="token punctuation">(</span><span class="token number">3</span>,<span class="token string">"2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>udpate tb2 <span class="token builtin class-name">set</span> <span class="token assign-left variable">b</span><span class="token operator">=</span><span class="token string">"b"</span> where <span class="token assign-left variable">a</span><span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre></pre></td></tr><tr><td data-num="37"></td><td><pre><span class="token comment"># 消费者消费 maxwell topic 的消息</span></pre></td></tr><tr><td data-num="38"></td><td><pre><span class="token comment"># 主题不存在报错：Error while fetching metadata with correlation id 379 : &#123;tpoicname:=INVALID_TOPIC_EXCEPTION&#125;</span></pre></td></tr><tr><td data-num="39"></td><td><pre></pre></td></tr><tr><td data-num="40"></td><td><pre><span class="token punctuation">&#123;</span><span class="token string">"database"</span><span class="token builtin class-name">:</span><span class="token string">"sampledata"</span>,<span class="token string">"table"</span><span class="token builtin class-name">:</span><span class="token string">"tb2"</span>,<span class="token string">"type"</span><span class="token builtin class-name">:</span><span class="token string">"insert"</span>,<span class="token string">"ts"</span>:1585033146,<span class="token string">"xid"</span>:840，<span class="token string">"data"</span>:<span class="token punctuation">&#123;</span><span class="token string">"a"</span>:1,<span class="token string">"b"</span><span class="token builtin class-name">:</span><span class="token string">"2"</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="41"></td><td><pre><span class="token punctuation">&#123;</span><span class="token string">"database"</span><span class="token builtin class-name">:</span><span class="token string">"sampledata"</span>,<span class="token string">"table"</span><span class="token builtin class-name">:</span><span class="token string">"tb2"</span>,<span class="token string">"type"</span><span class="token builtin class-name">:</span><span class="token string">"insert"</span>,<span class="token string">"ts"</span>:1585033147,<span class="token string">"xid"</span>:841,<span class="token string">"data"</span>:<span class="token punctuation">&#123;</span><span class="token string">"a"</span>:2,<span class="token string">"b"</span><span class="token builtin class-name">:</span><span class="token string">"2"</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="42"></td><td><pre><span class="token punctuation">&#123;</span><span class="token string">"database"</span><span class="token builtin class-name">:</span><span class="token string">"sampledata"</span>,<span class="token string">"table"</span><span class="token builtin class-name">:</span><span class="token string">"tb2"</span>,<span class="token string">"type"</span><span class="token builtin class-name">:</span><span class="token string">"insert"</span>,<span class="token string">"ts"</span>:1585033147,<span class="token string">"xid"</span>:842,<span class="token string">"data"</span>:<span class="token punctuation">&#123;</span><span class="token string">"a"</span>:3,<span class="token string">"b"</span><span class="token builtin class-name">:</span><span class="token string">"2"</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="43"></td><td><pre></pre></td></tr><tr><td data-num="44"></td><td><pre></pre></td></tr><tr><td data-num="45"></td><td><pre><span class="token comment"># update （若修改的数据值不变，则不产生日志）</span></pre></td></tr><tr><td data-num="46"></td><td><pre>update tb1 <span class="token builtin class-name">set</span> <span class="token assign-left variable">dtm</span><span class="token operator">=</span><span class="token string">'2020-03-31'</span> where a <span class="token operator">=</span> <span class="token number">1235</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="47"></td><td><pre><span class="token punctuation">&#123;</span><span class="token string">"database"</span><span class="token builtin class-name">:</span><span class="token string">"sampledata"</span>,<span class="token string">"table"</span><span class="token builtin class-name">:</span><span class="token string">"tb1"</span>,<span class="token string">"type"</span><span class="token builtin class-name">:</span><span class="token string">"update"</span>,<span class="token string">"ts"</span>:1585536380,<span class="token string">"xid"</span>:10588,<span class="token string">"commit"</span>:true,<span class="token string">"data"</span>:<span class="token punctuation">&#123;</span><span class="token string">"a"</span>:1235,<span class="token string">"b"</span><span class="token builtin class-name">:</span><span class="token string">"100"</span>,<span class="token string">"dtm"</span><span class="token builtin class-name">:</span><span class="token string">"2020-03-31"</span><span class="token punctuation">&#125;</span>,<span class="token string">"old"</span>:<span class="token punctuation">&#123;</span><span class="token string">"dtm"</span><span class="token builtin class-name">:</span><span class="token string">"2020-03-30"</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="48"></td><td><pre></pre></td></tr><tr><td data-num="49"></td><td><pre><span class="token comment"># delete </span></pre></td></tr><tr><td data-num="50"></td><td><pre>delete from tb1 where <span class="token assign-left variable">a</span><span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="51"></td><td><pre><span class="token punctuation">&#123;</span><span class="token string">"database"</span><span class="token builtin class-name">:</span><span class="token string">"sampledata"</span>,<span class="token string">"table"</span><span class="token builtin class-name">:</span><span class="token string">"tb1"</span>,<span class="token string">"type"</span><span class="token builtin class-name">:</span><span class="token string">"delete"</span>,<span class="token string">"ts"</span>:1585535987,<span class="token string">"xid"</span>:10063,<span class="token string">"</span></pre></td></tr><tr><td data-num="52"></td><td><pre>commit":true,<span class="token string">"data"</span>:<span class="token punctuation">&#123;</span><span class="token string">"a"</span>:4,<span class="token string">"b"</span><span class="token builtin class-name">:</span><span class="token string">"10"</span>,<span class="token string">"dtm"</span>:null<span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></pre></td></tr></table></figure></li><li><p>使用配置文件 ： cp config.properties.example config.properties &amp;&amp; vi config.properties</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">#config.properties</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token assign-left variable">log_level</span><span class="token operator">=</span>info</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token assign-left variable">producer</span><span class="token operator">=</span>kafka</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token assign-left variable">kafka_topic</span><span class="token operator">=</span>maxwell3</pre></td></tr><tr><td data-num="5"></td><td><pre>kafka.bootstrap.servers<span class="token operator">=</span>hdp-s-1.data.dc.zjft.com:6667 </pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment"># mysql login info</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token assign-left variable">host</span><span class="token operator">=</span><span class="token number">127.0</span>.0.1</pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token assign-left variable">port</span><span class="token operator">=</span><span class="token number">3306</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token assign-left variable">user</span><span class="token operator">=</span>maxwell</pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token assign-left variable">password</span><span class="token operator">=</span>maxwell</pre></td></tr></table></figure><p>** 运行方法： ** bin/maxwell --config config.properties</p></li></ol><h2 id="输出json字符串的格式"><a class="anchor" href="#输出json字符串的格式">#</a> 输出 JSON 字符串的格式</h2><table><thead><tr><th>字段</th><th>解释</th></tr></thead><tbody><tr><td>data</td><td>最新的数据，修改后的数据</td></tr><tr><td>old</td><td>旧数据，修改前的数据</td></tr><tr><td>type</td><td>有 insert, update, delete, database-create, database-alter, database-drop, table-create, table-alter, table-drop，bootstrap-insert，int (未知类型)</td></tr><tr><td>xid</td><td>事务 id</td></tr><tr><td>commit</td><td>同一个 xid 代表同一个事务，事务的最后一条语句会有 commit，可以利用这个重现事务</td></tr></tbody></table><h2 id="maxwell配置项说明"><a class="anchor" href="#maxwell配置项说明">#</a> maxwell 配置项说明</h2><blockquote><p>config.properties 配置文件里面的所有选项，都可以在启动 maxweill ./bin/maxwell 是指定，覆盖配置文件的内容。这里只讲一些常用的</p></blockquote><h3 id="mysql-配置选项"><a class="anchor" href="#mysql-配置选项">#</a> mysql 配置选项</h3><p><strong>Maxwell 根据用途将 MySQL 划分为 3 种角色：</strong></p><ul><li><strong>host</strong>：主机，建 maxwell 库表，存储捕获到的 schema 等信息<ul><li><strong>Maxwell</strong> 主要有六张表，<ul><li><strong>bootstrap</strong> 用于数据初始化，</li><li><strong>schemas</strong> 记录所有的 binlog 文件信息，</li><li><strong>databases</strong> 记录了所有的数据库信息，</li><li><strong>tables</strong> 记录了所有的表信息，</li><li><strong>columns</strong> 记录了所有的字段信息，</li><li><strong>positions</strong> 记录了读取 binlog 的位移信息，heartbeats 记录了心跳信息</li></ul></li></ul></li><li><strong>replication_hos</strong>t：复制主机，Event 监听，读取该主机 binlog<ul><li>将 host 和 replication_host 分开，可以避免 replication_user 往生产库里写数据</li></ul></li><li><strong>schema_hos</strong>t：schema 主机，捕获表结构 schema 的主机<ul><li><strong>binlog</strong> 里面没有字段信息，所以 maxwell 需要从数据库查出 schema，存起来。</li><li><strong>schema_host</strong> 一般用不到，但在 binlog-proxy 场景下就很实用。比如要将已经离线的 binlog 通过 maxwell 生成 json 流，于是自建一个 mysql server 里面没有结构，只用于发送 binlog，此时表机构就可以制动从 schema_host 获取。<br>通常，这三个主机都是同一个，schema_host 只在有 replication_host 的时候使用。</li></ul></li></ul><table><thead><tr><th>选项</th><th>参数值</th><th>描述</th><th>默认值</th></tr></thead><tbody><tr><td>host</td><td>STRING</td><td>mysql 地址</td><td>localhost</td></tr><tr><td>user</td><td>STRING</td><td colspan="2">mysql 用户名</td></tr><tr><td>password</td><td>STRING</td><td>mysql 密码</td><td>(no password)</td></tr><tr><td>port</td><td>INT</td><td colspan="2">mysql 端口 3306</td></tr><tr><td>jdbc_options</td><td>STRING</td><td>mysql jdbc connection options</td><td>DEFAULT_JDBC_OPTS</td></tr><tr><td>ssl</td><td>SSL_OPT</td><td>SSL behavior for mysql cx</td><td>DISABLED</td></tr><tr><td>schema_database</td><td>STRING</td><td>Maxwell 用于维护的 schema 和 position 将使用的数据库</td><td>maxwell</td></tr><tr><td>client_id</td><td>STRING</td><td>用于标识 Maxwell 实例的唯一字符串</td><td>maxwell</td></tr><tr><td>replica_server_id</td><td>LONG</td><td>用于标识 Maxwell 实例的唯一数字</td><td>6379 (see notes)</td></tr><tr><td>master_recovery</td><td>BOOLEAN</td><td>enable experimental master recovery code</td><td>false</td></tr><tr><td>gtid_mode</td><td>BOOLEAN</td><td>是否开启基于 GTID 的复制</td><td>false</td></tr><tr><td>recapture_schema</td><td>BOOLEAN</td><td>重新捕获最新的表结构 (schema)，不可在 config.properties 中配置</td><td>false</td></tr><tr><td>replication_host</td><td>STRING</td><td>server to replicate from. See split server roles</td><td>schema-store host</td></tr><tr><td>replication_password</td><td>STRING</td><td>password on replication server</td><td>(none)</td></tr><tr><td>replication_port</td><td>INT</td><td>port on replication server</td><td>3306</td></tr><tr><td>replication_user</td><td>STRING</td><td colspan="2">user on replication server</td></tr><tr><td>replication_ssl</td><td>SSL_OPT</td><td>SSL behavior for replication cx cx</td><td>DISABLED</td></tr><tr><td>schema_host</td><td>STRING</td><td>server to capture schema from. See split server roles</td><td>schema-store host</td></tr><tr><td>schema_password</td><td>STRING</td><td>password on schema-capture server</td><td>(none)</td></tr><tr><td>schema_port</td><td>INT</td><td>port on schema-capture server</td><td>3306</td></tr><tr><td>schema_user</td><td>STRING</td><td colspan="2">user on schema-capture server</td></tr><tr><td>schema_ssl</td><td>SSL_OPT</td><td>SSL behavior for schema-capture server</td><td>DISABLED</td></tr></tbody></table><h3 id="生产者的配置"><a class="anchor" href="#生产者的配置">#</a> 生产者的配置</h3><table><thead><tr><th>选项</th><th>参数值</th><th>描述</th><th>默认值</th></tr></thead><tbody><tr><td>producer</td><td>PRODUCER_TYPE</td><td>生产者类型</td><td>stdout</td></tr><tr><td>custom_producer.factory</td><td>CLASS_NAME</td><td colspan="2">自定义消费者的工厂类</td></tr><tr><td>producer_ack_timeout</td><td>PRODUCER_ACK_TIMEOUT</td><td colspan="2">异步消费认为消息丢失的超时时间（毫秒 ms）</td></tr><tr><td>producer_partition_by</td><td>输入到 kafka/kinesis 的分区函数</td><td>输入到 kafka/kinesis 的分区函数</td><td>database</td></tr><tr><td>producer_partition_columns</td><td>STRING</td><td colspan="2">若按列分区，以逗号分隔的列名称</td></tr><tr><td>producer_partition_by_fallback</td><td>PARTITION_BY_FALLBACK</td><td colspan="2">producer_partition_by=column 时需要，当列不存在是使用</td></tr><tr><td>ignore_producer_error</td><td>BOOLEAN</td><td>为 false 时，在 kafka/kinesis 发生错误时退出程序；为 true 时，仅记录日志 See also dead_letter_topic</td><td>true</td></tr><tr><td>kafka.bootstrap.servers</td><td>STRING</td><td colspan="2">kafka 集群列表，HOST:PORT [,HOST:PORT]</td></tr><tr><td>kafka_topic	STRING</td><td>kafka</td><td>topic</td><td>maxwell</td></tr><tr><td>dead_letter_topic</td><td>STRING</td><td colspan="2">详见官方文档</td></tr><tr><td>kafka_version</td><td>KAFKA_VERSION</td><td colspan="2">指定 maxwell 的 kafka 生产者客户端版本，不可在 config.properties 中配置	0.11.0.1</td></tr><tr><td>kafka_partition_hash</td><td>[default | murmur3]</td><td>选择 kafka 分区时使用的 hash 方法</td><td>default</td></tr><tr><td>kafka_key_format</td><td>[array | hash]</td><td colspan="2">how maxwell outputs kafka keys, either a hash or an array of hashes	hash</td></tr><tr><td>ddl_kafka_topic</td><td>STRING</td><td>当 output_ddl 为 true 时，所有 DDL 的消息都将投递到该 topic</td><td>kafka_topic</td></tr></tbody></table><h3 id="过滤器配置"><a class="anchor" href="#过滤器配置">#</a> 过滤器配置</h3><p>​ <strong>通过 exclude 排除，通过 include 包含，值可以为具体的数据库、数据表、数据列，甚至用 Javascript 来定义复杂的过滤规则；可以用正则表达式描述，有几个来自官网的例子</strong></p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 仅匹配 foodb 数据库的 tbl 表和所有 table_数字的表</span></pre></td></tr><tr><td data-num="2"></td><td><pre>--filter<span class="token operator">=</span><span class="token string">'exclude: foodb.*, include: foodb.tbl, include: foodb./table_\d+/'</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment"># 排除所有库所有表，仅匹配 db1 数据库</span></pre></td></tr><tr><td data-num="4"></td><td><pre>--filter <span class="token operator">=</span> <span class="token string">'exclude: *.*, include: db1.*'</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment"># 排除含 db.tbl.col 列值为 reject 的所有更新</span></pre></td></tr><tr><td data-num="6"></td><td><pre>--filter <span class="token operator">=</span> <span class="token string">'exclude: db.tbl.col = reject'</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment"># 排除任何包含 col_a 列的更新</span></pre></td></tr><tr><td data-num="8"></td><td><pre>--filter <span class="token operator">=</span> <span class="token string">'exclude: *.*.col_a = *'</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token comment"># blacklist 黑名单，完全排除 bad_db 数据库，若要恢复，必须删除 maxwell 库</span></pre></td></tr><tr><td data-num="10"></td><td><pre>--filter <span class="token operator">=</span> <span class="token string">'blacklist: bad_db.*'</span></pre></td></tr></table></figure><h3 id="javascript-过滤器"><a class="anchor" href="#javascript-过滤器">#</a> javascript 过滤器</h3><blockquote><p>如果需要本机过滤器无法提供的更多灵活性，则可以编写一小段 JavaScript，让 Maxwell 通过传递每一行 <code>--javascript FILE</code></p></blockquote><figure class="highlight javascript"><figcaption data-lang="javascript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token operator">/</span> <span class="token operator">*</span></pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token operator">*</span>您的JavaScript过滤器至少应定义</pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token operator">*</span>（process_row，process_heartbeat，process_ddl）之一。</pre></td></tr><tr><td data-num="4"></td><td><pre> <span class="token operator">*</span></pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token operator">*</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">process_row</span><span class="token template-punctuation string">`</span></span>被称为后过滤器，用于所有未过滤的数据行</pre></td></tr><tr><td data-num="6"></td><td><pre> <span class="token operator">*</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token operator">*</span> process_row必须采用一个参数，即“ WrappedRowMap”的实例。WrappedRowMap的javascript <span class="token constant">API</span>如下所示：</pre></td></tr><tr><td data-num="8"></td><td><pre> <span class="token operator">*</span></pre></td></tr><tr><td data-num="9"></td><td><pre> <span class="token operator">*</span> <span class="token punctuation">.</span>suppress（）<span class="token operator">-</span><span class="token operator">></span>调用此命令从输出中删除行</pre></td></tr><tr><td data-num="10"></td><td><pre> <span class="token operator">*</span> <span class="token punctuation">.</span>kafka_topic <span class="token operator">=</span>“ topic”<span class="token operator">-</span><span class="token operator">></span>覆盖此行的默认kafka主题</pre></td></tr><tr><td data-num="11"></td><td><pre> <span class="token operator">*</span> <span class="token punctuation">.</span>partition_string <span class="token operator">=</span>“ string”<span class="token operator">-</span><span class="token operator">></span>覆盖kafka <span class="token operator">/</span> kinesis按字符串划分</pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token operator">*</span> <span class="token punctuation">.</span>data<span class="token operator">-</span><span class="token operator">></span>包含行数据的哈希。可以修改。</pre></td></tr><tr><td data-num="13"></td><td><pre> <span class="token operator">*</span> <span class="token punctuation">.</span>old_data<span class="token operator">-</span><span class="token operator">></span>包含旧数据的哈希</pre></td></tr><tr><td data-num="14"></td><td><pre> <span class="token operator">*</span> <span class="token punctuation">.</span>extra_attributes<span class="token operator">-</span><span class="token operator">></span>如果您在此哈希中设置值，则它们将在最终<span class="token constant">JSON</span>的顶级输出</pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token operator">*</span> <span class="token punctuation">.</span>type<span class="token operator">-</span><span class="token operator">></span>“插入” <span class="token operator">|</span> “更新” <span class="token operator">|</span> “删除”</pre></td></tr><tr><td data-num="16"></td><td><pre> <span class="token operator">*</span> <span class="token punctuation">.</span>table<span class="token operator">-</span><span class="token operator">></span>表名</pre></td></tr><tr><td data-num="17"></td><td><pre> <span class="token operator">*</span> <span class="token punctuation">.</span>database<span class="token operator">-</span><span class="token operator">></span>数据库名称</pre></td></tr><tr><td data-num="18"></td><td><pre> <span class="token operator">*</span> <span class="token punctuation">.</span>position<span class="token operator">-</span><span class="token operator">></span>事件的binlog位置作为字符串</pre></td></tr><tr><td data-num="19"></td><td><pre> <span class="token operator">*</span> <span class="token punctuation">.</span>xid<span class="token operator">-</span><span class="token operator">></span>交易<span class="token constant">XID</span></pre></td></tr><tr><td data-num="20"></td><td><pre> <span class="token operator">*</span> <span class="token punctuation">.</span>server_id<span class="token operator">-</span><span class="token operator">></span>服务器<span class="token constant">ID</span></pre></td></tr><tr><td data-num="21"></td><td><pre> <span class="token operator">*</span> <span class="token punctuation">.</span>thread_id<span class="token operator">-</span><span class="token operator">></span>客户端thread_id</pre></td></tr><tr><td data-num="22"></td><td><pre> <span class="token operator">*</span> <span class="token punctuation">.</span>timestamp<span class="token operator">-</span><span class="token operator">></span>行时间戳</pre></td></tr><tr><td data-num="23"></td><td><pre> <span class="token operator">*</span></pre></td></tr><tr><td data-num="24"></td><td><pre> <span class="token operator">*</span> <span class="token operator">/</span></pre></td></tr><tr><td data-num="25"></td><td><pre></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token keyword">function</span> <span class="token function">process_row</span><span class="token punctuation">(</span><span class="token parameter">row</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>	<span class="token keyword">if</span> <span class="token punctuation">(</span> row<span class="token punctuation">.</span>database <span class="token operator">==</span> <span class="token string">"shard_1"</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>		<span class="token keyword">if</span> <span class="token punctuation">(</span> row<span class="token punctuation">.</span>table <span class="token operator">==</span> <span class="token string">"fo"</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>			row<span class="token punctuation">.</span><span class="token function">suppress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>		<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span> row<span class="token punctuation">.</span>table <span class="token operator">==</span> <span class="token string">"sharded"</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>			<span class="token keyword">if</span> <span class="token punctuation">(</span> row<span class="token punctuation">.</span>type <span class="token operator">==</span> <span class="token string">"insert"</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>				row<span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"password"</span><span class="token punctuation">,</span> <span class="token string">"XXXXXXXX"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>			<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>		<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span> row<span class="token punctuation">.</span>table <span class="token operator">==</span> <span class="token string">"other"</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>			row<span class="token punctuation">.</span>kafka_topic <span class="token operator">=</span> <span class="token string">"other_kafka_topic"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>		<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span> row<span class="token punctuation">.</span>table <span class="token operator">==</span> <span class="token string">"iterate_me"</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>			<span class="token keyword">for</span> <span class="token function">each</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">var</span> key <span class="token keyword">in</span> row<span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>				logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>row<span class="token punctuation">.</span>data<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>			<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>		<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="42"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="43"></td><td><pre></pre></td></tr><tr><td data-num="44"></td><td><pre><span class="token operator">/</span> <span class="token operator">*</span></pre></td></tr><tr><td data-num="45"></td><td><pre><span class="token operator">*</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">process_ddl</span><span class="token template-punctuation string">`</span></span>必须采用一个参数，即<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">WrappedDDLMap</span><span class="token template-punctuation string">`</span></span>的实例。WrappedDDLMap响应：</pre></td></tr><tr><td data-num="46"></td><td><pre> <span class="token operator">*</span> <span class="token punctuation">.</span>suppress（）<span class="token operator">-</span><span class="token operator">></span>调用此命令从输出中删除行</pre></td></tr><tr><td data-num="47"></td><td><pre> <span class="token operator">*</span> <span class="token punctuation">.</span>kafka_topic <span class="token operator">=</span>“ topic”<span class="token operator">-</span><span class="token operator">></span>覆盖此行的默认kafka主题</pre></td></tr><tr><td data-num="48"></td><td><pre> <span class="token operator">*</span> <span class="token punctuation">.</span>extra_attributes<span class="token operator">-</span><span class="token operator">></span>如果您在此哈希中设置值，则它们将在最终<span class="token constant">JSON</span>的顶级输出</pre></td></tr><tr><td data-num="49"></td><td><pre> <span class="token operator">*</span> <span class="token punctuation">.</span>type<span class="token operator">-</span><span class="token operator">></span> <span class="token constant">DDL</span><span class="token operator">-</span><span class="token constant">TYPE</span></pre></td></tr><tr><td data-num="50"></td><td><pre> <span class="token operator">*</span> <span class="token punctuation">.</span>table<span class="token operator">-</span><span class="token operator">></span>表名</pre></td></tr><tr><td data-num="51"></td><td><pre> <span class="token operator">*</span> <span class="token punctuation">.</span>database<span class="token operator">-</span><span class="token operator">></span>数据库名称</pre></td></tr><tr><td data-num="52"></td><td><pre> <span class="token operator">*</span> <span class="token punctuation">.</span>position<span class="token operator">-</span><span class="token operator">></span>事件的binlog位置作为字符串</pre></td></tr><tr><td data-num="53"></td><td><pre> <span class="token operator">*</span> <span class="token punctuation">.</span>timestamp<span class="token operator">-</span><span class="token operator">></span>以<span class="token constant">UTC</span>秒为单位的行时间戳</pre></td></tr><tr><td data-num="54"></td><td><pre><span class="token operator">*</span> <span class="token punctuation">.</span>change<span class="token operator">-</span><span class="token operator">></span>表示<span class="token constant">DDL</span>更改的哈希图。每种<span class="token constant">DDL</span>类型都不同。</pre></td></tr><tr><td data-num="55"></td><td><pre> <span class="token operator">*</span> <span class="token operator">/</span></pre></td></tr><tr><td data-num="56"></td><td><pre></pre></td></tr><tr><td data-num="57"></td><td><pre><span class="token keyword">function</span> <span class="token function">process_ddl</span><span class="token punctuation">(</span><span class="token parameter">ddl</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="58"></td><td><pre>	logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>ddl<span class="token punctuation">.</span>change<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="59"></td><td><pre>	logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>ddl<span class="token punctuation">.</span>table<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="60"></td><td><pre>	logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>ddl<span class="token punctuation">.</span>database<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="61"></td><td><pre></pre></td></tr><tr><td data-num="62"></td><td><pre>	ddl<span class="token punctuation">.</span>extra_attributes<span class="token punctuation">[</span><span class="token string">'hello'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'world'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="63"></td><td><pre>	<span class="token keyword">if</span> <span class="token punctuation">(</span> ddl<span class="token punctuation">.</span>table <span class="token operator">==</span> <span class="token string">"foo"</span> <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="64"></td><td><pre>		ddl<span class="token punctuation">.</span><span class="token function">suppress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="65"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="66"></td><td><pre></pre></td></tr><tr><td data-num="67"></td><td><pre><span class="token operator">/</span> <span class="token operator">*</span></pre></td></tr><tr><td data-num="68"></td><td><pre> <span class="token operator">*</span> process_heartbeat<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">必须采用一个参数，即WrappedHeartbeatMap</span><span class="token template-punctuation string">`</span></span>的实例。WrappedHeartbeatMap响应：</pre></td></tr><tr><td data-num="69"></td><td><pre> <span class="token operator">*</span> <span class="token punctuation">.</span>position<span class="token operator">-</span><span class="token operator">></span>事件的binlog位置作为字符串</pre></td></tr><tr><td data-num="70"></td><td><pre> <span class="token operator">*</span> <span class="token punctuation">.</span>timestamp<span class="token operator">-</span><span class="token operator">></span>以<span class="token constant">UTC</span>秒为单位的行时间戳</pre></td></tr><tr><td data-num="71"></td><td><pre> <span class="token operator">*</span> <span class="token punctuation">.</span>heartbeat<span class="token operator">-</span><span class="token operator">></span>发送心跳的时间戳，以utc毫秒为单位</pre></td></tr><tr><td data-num="72"></td><td><pre> <span class="token operator">*</span> <span class="token operator">/</span></pre></td></tr><tr><td data-num="73"></td><td><pre></pre></td></tr><tr><td data-num="74"></td><td><pre><span class="token keyword">function</span> <span class="token function">process_heartbeat</span><span class="token punctuation">(</span><span class="token parameter">heartbeat</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="75"></td><td><pre>	logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>heartbeat<span class="token punctuation">.</span>position<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="76"></td><td><pre>	logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>heartbeat<span class="token punctuation">.</span>timestamp<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="77"></td><td><pre>	logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>heartbeat<span class="token punctuation">.</span>heartbeat<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="78"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="formatting"><a class="anchor" href="#formatting">#</a> formatting</h3><ul><li><p><strong>output_ddl</strong></p><p>是否在输出的 json 流中，包含 ddl 语句。默认 false</p></li><li><p><strong>output_binlog_position</strong><br>是否在输出的 json 流中，包含 binlog filename:postion。默认 false</p></li><li><p><strong>output_commit_info</strong><br>是否在输出的 json 流里面，包含 commit 和 xid 信息。默认 true<br>比如一个事物里，包含多个表的变更，或一个表上多条数据的变更，那么他们都具有相同的 xid，最后一个 row event 输出 commit:true 字段。这有利于消费者实现 事务回放，而不仅仅是行级别的回放。</p></li><li><p><strong>output_thread_id</strong></p><p>同样，binlog 里面也包含了 thread_id ，可以包含在输出中。默认 false<br>消费者可以用它来实现更粗粒度的事务回放。还有一个场景是用户审计，用户每次登陆之后将登陆 ip、登陆时间、用户名、thread_id 记录到一个表中，可轻松根据 thread_id 关联到 binlog 里面这条记录是哪个用户修改的。</p></li></ul><h3 id="init_position"><a class="anchor" href="#init_position">#</a> init_position</h3><blockquote><p>手动指定 maxwell 要从哪个 binlog，哪个位置开始。指定的格式 FILE:POSITION:HEARTBEAT。只支持在启动 maxwell 的命令指定，比如 --init_postion=mysql-bin.0000456:4:0。<br>maxwell 默认从连接上 mysql server 的当前位置开始解析，如果指定 init_postion，要确保文件确实存在，如果 binlog 已经被 purge 掉了，可能需要想其它办法。<span class="exturl" data-url="aHR0cDovL3NlYW5sb29rLmNvbS8yMDE4LzAxLzEzL21heHdlbGwtYmlubG9nL3h4">见 Binlog 可视化搜索：实现类似阿里 RDS 数据追踪功能</span></p></blockquote><p><strong>指定 --init_postion=mysql.bin.00001:xxx，<em>报错 EventDataDeserializationException: Failed to deserialize data of EventHeaderV4，当我另起一个 maxwell 指点之前的 binlog postion 开始解析，却有没有抛异常。事后的数据也表明并没有数据丢失</em>。</strong></p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>com.github.shyiko.mysql.binlog.event.deserialization.EventDataDeserializationException: Failed to deserialize data of EventHeaderV4<span class="token punctuation">&#123;</span>timestamp<span class="token operator">=</span><span class="token number">1584948956000</span>, <span class="token assign-left variable">eventType</span><span class="token operator">=</span>EXT_WRITE_ROWS, <span class="token assign-left variable">serverId</span><span class="token operator">=</span><span class="token number">1</span>, <span class="token assign-left variable">headerLength</span><span class="token operator">=</span><span class="token number">19</span>, <span class="token assign-left variable">dataLength</span><span class="token operator">=</span><span class="token number">28</span>, <span class="token assign-left variable">nextPosition</span><span class="token operator">=</span><span class="token number">881252</span>, <span class="token assign-left variable">flags</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>	at com.github.shyiko.mysql.binlog.event.deserialization.EventDeserializer.deserializeEventData<span class="token punctuation">(</span>EventDeserializer.java:300<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>mysql-binlog-connector-java-0.20.0.jar:0.20.0<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="3"></td><td><pre>	at com.github.shyiko.mysql.binlog.event.deserialization.EventDeserializer.nextEvent<span class="token punctuation">(</span>EventDeserializer.java:223<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>mysql-binlog-connector-java-0.20.0.jar:0.20.0<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="4"></td><td><pre>	at com.github.shyiko.mysql.binlog.BinaryLogClient.listenForEventPackets<span class="token punctuation">(</span>BinaryLogClient.java:954<span class="token punctuation">)</span> <span class="token punctuation">[</span>mysql-binlog-connector-java-0.20.0.jar:0.20.0<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="5"></td><td><pre>	at com.github.shyiko.mysql.binlog.BinaryLogClient.connect<span class="token punctuation">(</span>BinaryLogClient.java:581<span class="token punctuation">)</span> <span class="token punctuation">[</span>mysql-binlog-connector-java-0.20.0.jar:0.20.0<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="6"></td><td><pre>	at com.github.shyiko.mysql.binlog.BinaryLogClient<span class="token variable">$7</span>.run<span class="token punctuation">(</span>BinaryLogClient.java:857<span class="token punctuation">)</span> <span class="token punctuation">[</span>mysql-binlog-connector-java-0.20.0.jar:0.20.0<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="7"></td><td><pre>	at java.lang.Thread.run<span class="token punctuation">(</span>Thread.java:748<span class="token punctuation">)</span> <span class="token punctuation">[</span>?:1.8.0_231<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="8"></td><td><pre>Caused by: com.github.shyiko.mysql.binlog.event.deserialization.MissingTableMapEventException: No TableMapEventData has been found <span class="token keyword">for</span> table id:316. Usually that means that you have started reading binary log <span class="token string">'within the logical event group'</span> <span class="token punctuation">(</span>e.g. from WRITE_ROWS and not proceeding TABLE_MAP</pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token comment"># 查询日志文件的位置</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre>mysql<span class="token operator">></span> show binlog events <span class="token keyword">in</span> <span class="token string">'mysql-bin.000002'</span> from <span class="token number">61012</span> limit <span class="token number">10</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>+------------------+-------+----------------+-----------+-------------+-----------------------------------------+</pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token operator">|</span> Log_name         <span class="token operator">|</span> Pos   <span class="token operator">|</span> Event_type     <span class="token operator">|</span> Server_id <span class="token operator">|</span> End_log_pos <span class="token operator">|</span> Info                                    <span class="token operator">|</span></pre></td></tr><tr><td data-num="14"></td><td><pre>+------------------+-------+----------------+-----------+-------------+-----------------------------------------+</pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token operator">|</span> mysql-bin.000002 <span class="token operator">|</span> <span class="token number">61012</span> <span class="token operator">|</span> Xid            <span class="token operator">|</span>         <span class="token number">1</span> <span class="token operator">|</span>       <span class="token number">61043</span> <span class="token operator">|</span> COMMIT /* <span class="token assign-left variable">xid</span><span class="token operator">=</span><span class="token number">40</span> */                     <span class="token operator">|</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token operator">|</span> mysql-bin.000002 <span class="token operator">|</span> <span class="token number">61043</span> <span class="token operator">|</span> Anonymous_Gtid <span class="token operator">|</span>         <span class="token number">1</span> <span class="token operator">|</span>       <span class="token number">61108</span> <span class="token operator">|</span> SET @@<span class="token environment constant">SESSION</span>.GTID_NEXT<span class="token operator">=</span> <span class="token string">'ANONYMOUS'</span>    <span class="token operator">|</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token operator">|</span> mysql-bin.000002 <span class="token operator">|</span> <span class="token number">61108</span> <span class="token operator">|</span> Query          <span class="token operator">|</span>         <span class="token number">1</span> <span class="token operator">|</span>       <span class="token number">61186</span> <span class="token operator">|</span> BEGIN                                   <span class="token operator">|</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token operator">|</span> mysql-bin.000002 <span class="token operator">|</span> <span class="token number">61186</span> <span class="token operator">|</span> Table_map      <span class="token operator">|</span>         <span class="token number">1</span> <span class="token operator">|</span>       <span class="token number">61296</span> <span class="token operator">|</span> table_id: <span class="token number">156</span> <span class="token punctuation">(</span>sampledata.uas_corp_reg<span class="token punctuation">)</span> <span class="token operator">|</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token operator">|</span> mysql-bin.000002 <span class="token operator">|</span> <span class="token number">61296</span> <span class="token operator">|</span> Delete_rows    <span class="token operator">|</span>         <span class="token number">1</span> <span class="token operator">|</span>       <span class="token number">63469</span> <span class="token operator">|</span> table_id: <span class="token number">156</span> flags: STMT_END_F         <span class="token operator">|</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token operator">|</span> mysql-bin.000002 <span class="token operator">|</span> <span class="token number">63469</span> <span class="token operator">|</span> Xid            <span class="token operator">|</span>         <span class="token number">1</span> <span class="token operator">|</span>       <span class="token number">63500</span> <span class="token operator">|</span> COMMIT /* <span class="token assign-left variable">xid</span><span class="token operator">=</span><span class="token number">42</span> */                     <span class="token operator">|</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token operator">|</span> mysql-bin.000002 <span class="token operator">|</span> <span class="token number">63500</span> <span class="token operator">|</span> Anonymous_Gtid <span class="token operator">|</span>         <span class="token number">1</span> <span class="token operator">|</span>       <span class="token number">63565</span> <span class="token operator">|</span> SET @@<span class="token environment constant">SESSION</span>.GTID_NEXT<span class="token operator">=</span> <span class="token string">'ANONYMOUS'</span>    <span class="token operator">|</span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token operator">|</span> mysql-bin.000002 <span class="token operator">|</span> <span class="token number">63565</span> <span class="token operator">|</span> Query          <span class="token operator">|</span>         <span class="token number">1</span> <span class="token operator">|</span>       <span class="token number">63643</span> <span class="token operator">|</span> BEGIN                                   <span class="token operator">|</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token operator">|</span> mysql-bin.000002 <span class="token operator">|</span> <span class="token number">63643</span> <span class="token operator">|</span> Table_map      <span class="token operator">|</span>         <span class="token number">1</span> <span class="token operator">|</span>       <span class="token number">63780</span> <span class="token operator">|</span> table_id: <span class="token number">158</span> <span class="token punctuation">(</span>sampledata.work_deal<span class="token punctuation">)</span>    <span class="token operator">|</span></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token operator">|</span> mysql-bin.000002 <span class="token operator">|</span> <span class="token number">63780</span> <span class="token operator">|</span> Delete_rows    <span class="token operator">|</span>         <span class="token number">1</span> <span class="token operator">|</span>       <span class="token number">71930</span> <span class="token operator">|</span> table_id: <span class="token number">158</span>                           <span class="token operator">|</span></pre></td></tr><tr><td data-num="25"></td><td><pre>+------------------+-------+----------------+-----------+-------------+-----------------------------------------+</pre></td></tr><tr><td data-num="26"></td><td><pre></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token comment">#测试可知当 Event_type 在 Xid 之前一个（delete_row,update_row,wirte_row）就会报错则会报错跳过该 event</span></pre></td></tr></table></figure><h2 id="数据初始化bootstrap引导操作"><a class="anchor" href="#数据初始化bootstrap引导操作">#</a> 数据初始化（bootstrap 引导操作）</h2><blockquote><p>Maxwell 启动后将从 maxwell 库中获取上一次停止时 position, 从该断点处开始读取 binlog. 如果 binlog 已经清除了，那么怎样可以通过 maxwell 把整张表都复制出来呢？也就是数据初始化该怎么做？</p></blockquote><p>针对数据初始化的问题，Maxwell 提供了一个命令工具 maxwell-bootstrap 帮助我们完成数据初始化，maxwell-bootstrap 是基于 SELECT * FROM table 的方式进行全量数据初始化，不会产生多余的 binlog！</p><p><strong>这个工具有下面这些参数：</strong></p><table><thead><tr><th>参数</th><th>说明</th></tr></thead><tbody><tr><td>--log_level LOG_LEVEL</td><td>日志级别（DEBUG, INFO, WARN or ERROR）</td></tr><tr><td>--user USER</td><td>mysql 用户名</td></tr><tr><td>--password PASSWORD</td><td>mysql 密码</td></tr><tr><td>--host HOST</td><td>mysql 地址</td></tr><tr><td>--port PORT</td><td>mysql 端口</td></tr><tr><td>--database DATABASE</td><td>要 bootstrap 的表所在的数据库</td></tr><tr><td>--table TABLE</td><td>要引导的表</td></tr><tr><td>--where WHERE_CLAUSE</td><td>设置过滤条件</td></tr><tr><td>--client_id CLIENT_ID</td><td>指定执行引导操作的 Maxwell 实例</td></tr></tbody></table><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># maxwell-bootstrap 命令</span></pre></td></tr><tr><td data-num="2"></td><td><pre>bin/maxwell-bootstrap --user maxwell  <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    --password maxwell <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    --host <span class="token number">127.0</span>.0.1  <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    --database sampledata <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    --table <span class="token builtin class-name">test</span> <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    --client_id maxwell  <span class="token comment"># 默认 client_id=maxwell</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token comment"># 在 `maxwell.bootstrap` 表中插入记录，手动触发</span></pre></td></tr><tr><td data-num="10"></td><td><pre>INSERT INTO maxwell.bootstrap <span class="token punctuation">(</span>database_name, table_name,where_clause<span class="token punctuation">)</span> VALUES <span class="token punctuation">(</span><span class="token string">'test'</span>, <span class="token string">'tb2'</span>,<span class="token string">'1=1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token comment"># 在运行 maxwell</span></pre></td></tr><tr><td data-num="12"></td><td><pre>bin/maxwell --config config.properties</pre></td></tr></table></figure><p><strong>kafka 消费者日志</strong></p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">&#123;</span><span class="token string">"database"</span><span class="token builtin class-name">:</span><span class="token string">"sampledata"</span>,<span class="token string">"table"</span><span class="token builtin class-name">:</span><span class="token string">"tb3"</span>,<span class="token string">"type"</span><span class="token builtin class-name">:</span><span class="token string">"bootstrap-start"</span>,<span class="token string">"ts"</span>:1585033656,<span class="token string">"data"</span>:<span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span><span class="token string">"database"</span><span class="token builtin class-name">:</span><span class="token string">"sampledata"</span>,<span class="token string">"table"</span><span class="token builtin class-name">:</span><span class="token string">"tb3"</span>,<span class="token string">"type"</span><span class="token builtin class-name">:</span><span class="token string">"bootstrap-insert"</span>,<span class="token string">"ts"</span>:1585033656,<span class="token string">"data"</span>:<span class="token punctuation">&#123;</span><span class="token string">"a"</span>:1,<span class="token string">"b"</span><span class="token builtin class-name">:</span><span class="token string">"2"</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#123;</span><span class="token string">"database"</span><span class="token builtin class-name">:</span><span class="token string">"sampledata"</span>,<span class="token string">"table"</span><span class="token builtin class-name">:</span><span class="token string">"tb3"</span>,<span class="token string">"type"</span><span class="token builtin class-name">:</span><span class="token string">"bootstrap-insert"</span>,<span class="token string">"ts"</span>:1585033656,<span class="token string">"data"</span>:<span class="token punctuation">&#123;</span><span class="token string">"a"</span>:2,<span class="token string">"b"</span><span class="token builtin class-name">:</span><span class="token string">"2"</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">&#123;</span><span class="token string">"database"</span><span class="token builtin class-name">:</span><span class="token string">"sampledata"</span>,<span class="token string">"table"</span><span class="token builtin class-name">:</span><span class="token string">"tb3"</span>,<span class="token string">"type"</span><span class="token builtin class-name">:</span><span class="token string">"bootstrap-insert"</span>,<span class="token string">"ts"</span>:1585033656,<span class="token string">"data"</span>:<span class="token punctuation">&#123;</span><span class="token string">"a"</span>:3,<span class="token string">"b"</span><span class="token builtin class-name">:</span><span class="token string">"2"</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment">#若主键相同 bootstrap 将其覆盖</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">&#123;</span><span class="token string">"database"</span><span class="token builtin class-name">:</span><span class="token string">"sampledata"</span>,<span class="token string">"table"</span><span class="token builtin class-name">:</span><span class="token string">"tb3"</span>,<span class="token string">"type"</span><span class="token builtin class-name">:</span><span class="token string">"bootstrap-insert"</span>,<span class="token string">"ts"</span>:1584932007,<span class="token string">"data"</span>:<span class="token punctuation">&#123;</span><span class="token string">"a"</span>:10,<span class="token string">"b"</span><span class="token builtin class-name">:</span><span class="token string">"10"</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">&#123;</span><span class="token string">"database"</span><span class="token builtin class-name">:</span><span class="token string">"sampledata"</span>,<span class="token string">"table"</span><span class="token builtin class-name">:</span><span class="token string">"tb3"</span>,<span class="token string">"type"</span><span class="token builtin class-name">:</span><span class="token string">"bootstrap-complete"</span>,<span class="token string">"ts"</span>:1585033657,<span class="token string">"data"</span>:<span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>是 bootstrap-insert，便是 sampledata.tb3 的 binlog 数据了</p><p>Bootstrap 的过程是 <strong>bootstrap-start -&gt; bootstrap-insert -&gt; bootstrap-complete</strong>，其中，start 和 complete 的 data 字段为空，不携带数据。</p><p><em>在进行 bootstrap 过程中，如果 maxwell 崩溃，重启时，bootstrap 会完全重新开始，不管之前进行到多少，若不希望这样，可以到数据库中设置 is_complete 字段值为 1 (表示完成)，或者删除该行</em></p><p><strong>控制台输出</strong></p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 增量输出</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span><span class="token string">"database"</span><span class="token builtin class-name">:</span><span class="token string">"sampledata"</span>,<span class="token string">"table"</span><span class="token builtin class-name">:</span><span class="token string">"tb1"</span>,<span class="token string">"type"</span><span class="token builtin class-name">:</span><span class="token string">"insert"</span>,<span class="token string">"ts"</span>:1584672522,<span class="token string">"xid"</span>:18003,<span class="token string">"commit"</span>:true,<span class="token string">"data"</span>:<span class="token punctuation">&#123;</span><span class="token string">"a"</span>:1,<span class="token string">"b"</span><span class="token builtin class-name">:</span><span class="token string">"a"</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#123;</span><span class="token string">"database"</span><span class="token builtin class-name">:</span><span class="token string">"sampledata"</span>,<span class="token string">"table"</span><span class="token builtin class-name">:</span><span class="token string">"tb1"</span>,<span class="token string">"type"</span><span class="token builtin class-name">:</span><span class="token string">"insert"</span>,<span class="token string">"ts"</span>:1584672522,<span class="token string">"xid"</span>:18004,<span class="token string">"commit"</span>:true,<span class="token string">"data"</span>:<span class="token punctuation">&#123;</span><span class="token string">"a"</span>:2,<span class="token string">"b"</span><span class="token builtin class-name">:</span><span class="token string">"b"</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><strong>输出参数说明</strong></p><ul><li><p>data，最新的数据，修改后的数据</p></li><li><p>old，旧数据，修改前的数据</p></li><li><p>type，操作类型，有 insert, update, delete, database-create, database-alter, database-drop, table-create, table-alter, table-drop，bootstrap-insert，int (未知类型)</p></li><li><p>xid，事务 id</p></li><li><p>commit，同一个 xid 代表同一个事务，事务的最后一条语句会有 commit，可以利用这个重现事务</p></li><li><p>server_id，thread_id，</p></li></ul><h2 id="monitoring"><a class="anchor" href="#monitoring">#</a> monitoring</h2><blockquote><p>如果是长时间运行的 maxwell，添加 monitor 配置，maxwell 提供了 http api 返回监控数据。</p></blockquote><ul><li><p>metrics_type=http</p></li><li><p>metrics_jvm=true --http_port=8080</p></li></ul><h2 id="maxwell多实例"><a class="anchor" href="#maxwell多实例">#</a> maxwell 多实例</h2><blockquote><p>​ 在不同的配置下，Maxwell 可以在同一个主服务器上运行多个实例。如果希望让生产者以不同的配置运行，例如将来自不同组的表 (table) 的事件投递到不同的 Topic 中，这将非常有用。Maxwell 的每个实例都必须配置一个唯一的 client_id，以便区分的 binlog 位置。</p></blockquote><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">select</span> * from positions<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>+-----------+------------------+-----------------+----------+-----------+--------------+---------------------+</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token operator">|</span> server_id <span class="token operator">|</span> binlog_file      <span class="token operator">|</span> binlog_position <span class="token operator">|</span> gtid_set <span class="token operator">|</span> client_id <span class="token operator">|</span> heartbeat_at <span class="token operator">|</span> last_heartbeat_read <span class="token operator">|</span></pre></td></tr><tr><td data-num="4"></td><td><pre>+-----------+------------------+-----------------+----------+-----------+--------------+---------------------+</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token operator">|</span>         <span class="token number">1</span> <span class="token operator">|</span> mysql-bin.000001 <span class="token operator">|</span>         <span class="token number">4323504</span> <span class="token operator">|</span> NULL     <span class="token operator">|</span> maxwell   <span class="token operator">|</span>         NULL <span class="token operator">|</span>       <span class="token number">1585040020604</span> <span class="token operator">|</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token operator">|</span>         <span class="token number">1</span> <span class="token operator">|</span> mysql-bin.000001 <span class="token operator">|</span>         <span class="token number">5897218</span> <span class="token operator">|</span> NULL     <span class="token operator">|</span> maxwell1 <span class="token operator">|</span>         NULL <span class="token operator">|</span>       <span class="token number">1585063941753</span> <span class="token operator">|</span></pre></td></tr><tr><td data-num="7"></td><td><pre>+-----------+------------------+-----------------+----------+-----------+--------------+---------------------+</pre></td></tr></table></figure><h2 id="maxwell-分区"><a class="anchor" href="#maxwell-分区">#</a> maxwell 分区</h2><blockquote><p>Kafka 和 AWS Kinesis 都支持分区流的概念。分区由来控制 <code>producer_partition_by</code> ，它使您可以选择按数据库，表，主键或列数据拆分流。您如何选择分区将影响 maxwell 流的使用者</p></blockquote><p>在 <code>Maxwell</code> 官网查文档得知，在 <code>Maxwell</code> 没有配置的情况下，默认使用数据库名 database 作为计算分区的 key，并使用 Java 默认的 hashcode 算法进行计算，项目中 <code>maxwell</code> 的 binlog 就是单个 database，所以会造成数据倾斜</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>HASH_FUNCTION<span class="token punctuation">(</span>HASH_STRING<span class="token punctuation">)</span> % TOPIC.NUMBER_OF_PARTITIONS</pre></td></tr></table></figure><p>maxwell 有一个参数是–producer_partition_by，在不指定的情况下默认是 database，意思是数据推送到 kafka 时，数据被根据数据库进行 hash，同一个库的数据会被放在同一个 partition 中，这个参数有三个值：<br>database、table、primary_key</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">#murmurhash3 hash 算法</span></pre></td></tr><tr><td data-num="2"></td><td><pre>--kafka_partition_hash<span class="token operator">=</span>murmur3</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment"># Rowkey 作为分区 key</span></pre></td></tr><tr><td data-num="4"></td><td><pre>--producer_partition_by<span class="token operator">=</span>primary_key</pre></td></tr></table></figure><h2 id="maxwell高可用未实现"><a class="anchor" href="#maxwell高可用未实现">#</a> maxwell 高可用（未实现）</h2><p>​ 通过 zookeeper 实现高可用，修改一下 maxwell 源码，启动的时候到 zk 里注册一个临时结点，注册监听，节点挂了就重启 Maxwell 或者其他操作</p><p>​	<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3plbmRlc2svbWF4d2VsbC9pc3N1ZXMvMjQ4">Maxwell / MySQL 高可用性设置</span></p><h2 id="注意事项"><a class="anchor" href="#注意事项">#</a> 注意事项</h2><p><strong>1 timestamp column</strong></p><p>​ maxwell 对时间类型（datetime, timestamp, date）都是当做字符串处理的，这也是为了保证数据一致 (比如 0000-00-00 00:00:00 这样的时间在 timestamp 里是非法的，但 mysql 却认，解析成 java 或者 python 类型就是 null/None)。</p><p>如果 MySQL 表上的字段是 timestamp 类型，是有时区的概念 <strong>binlog 解析出来的是标准 UTC 时间</strong></p><p><strong>2 binary column</strong></p><p>​ maxwell 可以处理 binary 类型的列，如 blob、varbinary，它的做法就是对二进制列使用 <code>base64_encode</code> ，当做字符串输出到 json。消费者拿到这个列数据后，不能直接拼装，需要 <code>base64_decode</code> 。</p><h1 id="bireme增量"><a class="anchor" href="#bireme增量">#</a> bireme (增量)</h1><blockquote><p>运行 bireme 环境</p><ul><li>JAVA_HOME</li><li>yun install jsvc</li></ul></blockquote><p>Bireme 是用于 Greenplum / HashData 数据仓库的 ** <code>增量</code> ** 同步工具。目前，它支持 MySQL，PostgreSQL 和 MongoDB 数据源。</p><p><span class="exturl" data-url="aHR0cDovL2dyZWVucGx1bS5vcmcv">Greenplum</span> 是一个高级的，功能齐全的开源数据仓库，可对 PB 数据量进行强大而快速的分析。它是面向大数据分析的唯一对象，并且得到了世界上最先进的基于成本的查询优化器的支持。它可以对大量数据提供高查询性能。</p><p><span class="exturl" data-url="aHR0cDovL3d3dy5oYXNoZGF0YS5jbi8=">HashData</span> 是基于 Greenplum 构建的灵活的云数据仓库。</p><p>Bireme 使用 DELETE + COPY 将数据源的修改记录同步到 Greenplum / HashData。此模式比 INSERT + UPDATE + DELETE 更快更好。</p><p>功能和限制：</p><ul><li>使用小批量加载来增强数据同步的性能。默认的加载延迟时间是 10 秒。</li><li>所有表在目标数据库中必须具有主键。</li></ul><p>使用这个版本<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL0hhc2hEYXRhSW5jL2JpcmVtZS9yZWxlYXNlcw=="> bireme</span> （bireme 的 jar 包不在路径里）这个使用会报错：**Cannot find daemon loader org/apache/commons/daemon/support/DaemonLoader **</p><p>所以使用编译好的<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL0hhc2hEYXRhSW5jL2JpcmVtZS9yZWxlYXNlcy9kb3dubG9hZC92Mi4wLjAtYWxwaGEtMS9iaXJlbWUtMi4wLjAtYWxwaGEtMS50YXIuZ3o="> v2.0.0-alpha-1</span></p><h2 id="bireme如何工作"><a class="anchor" href="#bireme如何工作">#</a> bireme 如何工作</h2><p>Bireme 从数据源读取记录，然后将它们传递到单独的管道中。在每个管道中，bireme 会将其转换为内部格式并对其进行缓存。当缓存的记录达到一定数量时，它们将合并为一个任务。每个任务包含两个集合，<em>删除</em> 集合和<em>插入</em>集合。最后，它将记录更新到目标数据库。</p><p>每个数据源可能具有多个管道。对于 maxwell，每个 Kafka 分区对应一个管道，对于 debezium，每个 Kafka 主题对应一个管道。</p><p><img data-src="https://raw.githubusercontent.com/HashDataInc/bireme/master/docs/bireme.png" alt=""></p><p>下图描述了如何在管道中处理更改数据。</p><p><img data-src="https://raw.githubusercontent.com/HashDataInc/bireme/master/docs/bireme.png" alt="管道"></p><h2 id="配置文件简介"><a class="anchor" href="#配置文件简介">#</a> 配置文件简介</h2><p>配置文件包括两部分：</p><ul><li>基本配置文件：默认为<strong> config.properties</strong>，其中包含 bireme 的基本配置。</li><li>表映射文件：** .properties**。每个数据源都对应一个文件，该文件指定要同步的表以及目标数据库中的对应表。&lt;source_name&gt; 在 config.properties 文件中指定。</li></ul><h3 id="configproperties"><a class="anchor" href="#configproperties">#</a> config.properties</h3><p><strong>必要参数</strong></p><table><thead><tr><th>参量</th><th>描述</th></tr></thead><tbody><tr><td>target.url</td><td>目标数据库的地址。格式： jdbc：postgresql：// &lt;ip&gt;：&lt; 端口 &gt; / &lt; 数据库 &gt;</td></tr><tr><td>target.user</td><td>用于连接到目标数据库的用户名</td></tr><tr><td>target.passwd</td><td>用于连接到目标数据库的密码</td></tr><tr><td>data.source</td><td>指定数据源为 &lt;source_name&gt;，并用逗号分隔多个数据源，忽略空格</td></tr><tr><td>&lt;source_name&gt; .type</td><td>指定数据源的类型，例如 maxwell</td></tr></tbody></table><p>** 注意：** 数据源名称只是为了方便起见。可以根据需要进行修改。</p><p><strong>Maxwell 数据源的参数</strong></p><table><thead><tr><th>参量</th><th>描述</th></tr></thead><tbody><tr><td>&lt;source_name&gt; .kafka.server</td><td>Kafka 地址。格式： &lt;ip&gt;：&lt;port&gt;</td></tr><tr><td>&lt;source_name&gt; .kafka.topic</td><td>数据源对应主题</td></tr><tr><td>&lt;source_name&gt; .kafka.groupid</td><td>kafka 消费者组 ID。默认值为<em> bireme</em></td></tr></tbody></table><p><strong>其他参数</strong></p><table><thead><tr><th>参量</th><th>描述</th><th>默认</th></tr></thead><tbody><tr><td>pipeline.thread_pool.size</td><td>管道的线程池大小</td><td>5</td></tr><tr><td>transform.thread_pool.size</td><td>转换的线程池大小</td><td>10</td></tr><tr><td>merge.thread_pool.size</td><td>合并的线程池大小</td><td>10</td></tr><tr><td>merge.interval</td><td>合并之间的最大间隔（以毫秒为单位）</td><td>10000</td></tr><tr><td>merge.batch.size</td><td>一次合并的最大行数</td><td>50000</td></tr><tr><td>loader.conn_pool.size</td><td>与目标数据库的连接数，小于或等于变更装入程序的数量</td><td>10</td></tr><tr><td>loader.task_queue.size</td><td>每个变更加载器中任务队列的长度</td><td>2</td></tr><tr><td>metrics.reporter</td><td>Bireme 指定两种监视模式，即 consolo 或 jmx。如果不需要监视，则可以将其指定为 none</td><td>jmx</td></tr><tr><td>metrics.reporter.console.interval</td><td>指标输出之间的时间间隔（以秒为单位）。只要 metrics.reporter 是控制台，它就有效</td><td>10</td></tr><tr><td>state.server.port</td><td>状态服务器的端口</td><td>8080</td></tr><tr><td>state.server.addr</td><td>状态服务器的 IP 地址</td><td>0.0.0.0</td></tr></tbody></table><h3 id="source_name-properties"><a class="anchor" href="#source_name-properties">#</a> source_name&gt; .properties</h3><p>在每个数据源的配置文件中，指定数据源包括的表以及目标数据库中的对应表。</p><pre><code>&lt;database&gt;.&lt;OriginTable_1&gt; = &lt;schema&gt;.&lt;MappedTable_1&gt;
&lt;database&gt;.&lt;OriginTable_2&gt; = &lt;schema&gt;.&lt;MappedTable_2&gt;
...
</code></pre><h2 id="快速操作"><a class="anchor" href="#快速操作">#</a> 快速操作</h2><p>因为 bireme 的 jar 包不在路径里，直接下载编译好的<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL0hhc2hEYXRhSW5jL2JpcmVtZS9yZWxlYXNlcy9kb3dubG9hZC92Mi4wLjAtYWxwaGEtMS9iaXJlbWUtMi4wLjAtYWxwaGEtMS50YXIuZ3o="> bireme</span> 包</p><ol><li><p>下载<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL0hhc2hEYXRhSW5jL2JpcmVtZS9yZWxlYXNlcy9kb3dubG9hZC92Mi4wLjAtYWxwaGEtMS9iaXJlbWUtMi4wLjAtYWxwaGEtMS50YXIuZ3o="> bireme</span></p></li><li><p>解压： tar xf bireme bireme-2.0.0-alpha-1.tar.gz</p></li><li><p>修改配置文件 vim etc/config.properties etc/maxwell.properties</p></li></ol><figure class="highlight properties"><figcaption data-lang=".properties"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># etc/config.propertis</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token attr-name">target.url</span> <span class="token punctuation">=</span> <span class="token attr-value">jdbc:postgresql://10.34.11.141:2345/postgres</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token attr-name">target.user</span> <span class="token punctuation">=</span> <span class="token attr-value">pentaho_user</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token attr-name">target.passwd</span> <span class="token punctuation">=</span> <span class="token attr-value">cloud.Zijin</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment"># data source name list, separated by comma.</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token attr-name">data_source</span> <span class="token punctuation">=</span> <span class="token attr-value">maxwell1</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment"># data source name list, separated by comma.</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token attr-name">data_source</span> <span class="token punctuation">=</span> <span class="token attr-value">maxwell1</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token comment"># data source "mysql1" type</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token attr-name">maxwell1.type</span> <span class="token punctuation">=</span> <span class="token attr-value">maxwell</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token comment"># kafka server which maxwell write binlog into.</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token attr-name">maxwell1.kafka.server</span> <span class="token punctuation">=</span> <span class="token attr-value">hdp-s-1.data.dc.zjft.com:6667</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token comment"># kafka topic which maxwell write binlog into.</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token attr-name">maxwell1.kafka.topic</span> <span class="token punctuation">=</span> <span class="token attr-value">maxwell</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token comment"># kafka groupid used for consumer.</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token attr-name">maxwell1.kafka.groupid</span> <span class="token punctuation">=</span> <span class="token attr-value">bireme</span></pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token comment"># set the IP address for bireme state server.</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token attr-name">state.server.addr</span> <span class="token punctuation">=</span> <span class="token attr-value">0.0.0.0</span></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token comment"># set the port for bireme state server.</span></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token attr-name">state.server.port</span> <span class="token punctuation">=</span> <span class="token attr-value">8080</span></pre></td></tr></table></figure><p><strong>maxwell1.properties</strong></p><figure class="highlight properties"><figcaption data-lang=".properties"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># etc/maxwell.properties</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token attr-name">test.tb1</span> <span class="token punctuation">=</span> <span class="token attr-value">public.tb1</span></pre></td></tr></table></figure><p><strong>若 postgres 表不存在则</strong>：cn.hashdata.bireme.BiremeException: Greenplum table and MySQL table size are inconsistent!*</p><ol start="4"><li>在 postgres 建表</li></ol><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">create</span> <span class="token keyword">table</span> tb1<span class="token punctuation">(</span>a <span class="token keyword">int</span><span class="token punctuation">,</span> b <span class="token keyword">char</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">primary</span> <span class="token keyword">key</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment">-- 字段需要和 mysql 一直否在报：字段不存在</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">-- 字段类型需要一直，否则同步到 postgres 中会忽略该字段</span></pre></td></tr></table></figure><ol start="5"><li><p>启动 bireme : bin/bireme start （ stop| restart ）</p></li><li><p>监听日志：tai l -f logs/bireme.out（ logs/bireme.err ）</p></li><li><p>测试（查询 psotgres）</p><pre><code class="language-sql"></code></pre></li></ol><p>select * from tb1;<br>a | b<br>----+------------<br>3 | d<br>6 | 6<br>7 | 7<br>4 | 4<br>10 | 10<br>1 | 1<br>5 | 5</p><pre><code>


## 监控，http://127.0.0.1:8080/pretty 

**HTTP服务器**

Bireme启动轻型HTTP服务器以获取当前的加载状态。

启动HTTP服务器时，将公开以下端点：

| 终点       | 描述                       |
| ---------- | -------------------------- |
| /          | 获取所有数据源的加载状态。 |
| / &lt;数据源&gt; | 获取给定数据源的加载状态。 |

结果以JSON格式组织。使用参数*pretty*将打印出用户友好的结果。

**例**

以下是加载状态的示例：

</code></pre><p>{<br>&quot;source_name&quot;: &quot;maxwell1&quot;,<br>&quot;type&quot;: &quot;MAXWELL&quot;<br>&quot;pipelines&quot;: [<br>{<br>&quot;name&quot;: &quot;maxwell-1&quot;,<br>&quot;latest&quot;: &quot;1970-01-01T08:00:00.000Z&quot;,<br>&quot;delay&quot;: latest,<br>&quot;state&quot;: &quot;NORMAL&quot;<br>},<br>]<br>}</p><pre><code>
- *source_name*是在配置文件中指定的查询数据源的名称。
- *type*是数据源的类型。
- *管道*是一个数组，每个元素都对应一个管道。（每个数据源可能有几个单独的管道。）

- *name*是管道的名称。
- *最新*时间是已成功加载到哈希数据的最新更改数据的产生时间。
- *延迟*是更改数据从输入双向到提交到数据源的时间段。
- *状态*是管道的状态。

## 优势和存在问题

**优势**

1、可以实现多个库表的汇总功能，syncdb1.tb1/syncdb2.tb1 可以汇总到pgsql的一张表tb1中
2、中间使用kafka消息队列，对于大数据量性能方面提升较好


**存在问题**

1、maxwell会连接数据源库，生成maxwell库，用来存在相应binlog消费位点position信息，只能在数据源生成库
2、第一次启动maxwell时，只能以当前的binlog position位点开始解析，事先需要先同步数据源数据库到目标数据库的一份全量数据

## 实际操作

&gt; 其他配置不变，只需要修改**maxwell1.properties**

**maxwell1.properties**

```properties
usp_anyfix.work_type=usp_anyfix.work_type
usp_anyfix.work_deal=usp_anyfix.work_deal
usp_anyfix.device_branch=usp_anyfix.device_branch
usp_anyfix.service_remote_way=usp_anyfix.service_remote_way
usp_anyfix.fault_type=usp_anyfix.fault_type
usp_anyfix.service_branch=usp_anyfix.service_branch
usp_anyfix.work_request=usp_anyfix.work_request


usp_uas.uas_user_info=usp_uas.uas_user_info
usp_uas.sys_tenant=usp_uas.sys_tenant
usp_uas.uas_cfg_area=usp_uas.uas_cfg_area
usp_uas.uas_corp_reg=usp_uas.uas_corp_reg
usp_uas.uas_user_real=usp_uas.uas_user_real


usp_device.device_brand=usp_device.device_brand
usp_device.device_info=usp_device.device_info
usp_device.device_large_class=usp_device.device_large_class
usp_device.device_model=usp_device.device_model
usp_device.device_small_class=usp_device.device_small_class
usp_device.device_specification=usp_device.device_specification

</code></pre><p><em>经测试发现，以下表无法识别</em></p><p><em>cn.hashdata.bireme.BiremeException: Greenplum table and MySQL table size are inconsistent!</em></p><figure class="highlight properties"><figcaption data-lang=".properties"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token attr-name">usp_anyfix.work_type</span><span class="token punctuation">=</span><span class="token attr-value">usp_anyfix.work_type</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token attr-name">usp_anyfix.work_deal</span><span class="token punctuation">=</span><span class="token attr-value">usp_anyfix.work_deal</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token attr-name">usp_anyfix.device_branch</span><span class="token punctuation">=</span><span class="token attr-value">usp_anyfix.device_branch</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token attr-name">usp_anyfix.service_remote_way</span><span class="token punctuation">=</span><span class="token attr-value">usp_anyfix.service_remote_way</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token attr-name">usp_uas.uas_user_info</span><span class="token punctuation">=</span><span class="token attr-value">usp_uas.uas_user_info</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token attr-name">usp_uas.sys_tenant</span><span class="token punctuation">=</span><span class="token attr-value">usp_uas.sys_tenant</span></pre></td></tr></table></figure><p><strong>未知原因</strong>： <em>表在 gp 中存在，而且修改表名，有些表名能识别，有些表名无法识别，</em></p><h1 id="mysql2pgsql全量"><a class="anchor" href="#mysql2pgsql全量">#</a> mysql2pgsql（全量）</h1><blockquote><p>由于 bireme 无法解析 bootsrap-maxwell 产生的 json，导致 bireme 无法通过 maxwell 实现 mysql 全量导入 gp</p><p>所以可以泗洪 mysql2pasql 开源工具实现全量同步</p></blockquote><p><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FsaXl1bi9yZHNfZGJzeW5jL3JlbGVhc2VzP3NwbT1hMmM0Zy4xMTE4NjYyMy4yLjQueU9QWUtk">mysql2pgsql 开源文档</span></p><p><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FsaXl1bi9yZHNfZGJzeW5jL2Jsb2IvbWFzdGVyL2RvYy9teXNxbDJncC5tZA==">mysql2pgsql 参数文档</span></p><p><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FsaXl1bi9yZHNfZGJzeW5jL2lzc3Vlcz9xPWlzJTNBaXNzdWUraXMlM0FjbG9zZWQ=">mysql2pgsql 问题答疑</span></p><h2 id="下载-mysql2pgsql"><a class="anchor" href="#下载-mysql2pgsql">#</a> 下载 mysql2pgsql</h2><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">wget</span> https://github.com/aliyun/rds_dbsync/files/919279/mysql2pgsql.bin.el6.20170413.tar.gz</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment"># 解压</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token function">tar</span> -xzvf mysql2pgsql.bin.el6.20170413.tar.gz mysql2pgsql</pre></td></tr></table></figure><h2 id="配置mysql和gp连接信息配置文件"><a class="anchor" href="#配置mysql和gp连接信息配置文件">#</a> 配置 mysql 和 gp 连接信息配置文件</h2><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token builtin class-name">cd</span> mysql2pgsql</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token function">vi</span> my.cfg</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">## my.cfg</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">[</span>src.mysql<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token function">host</span> <span class="token operator">=</span> <span class="token string">"10.34.12.185"</span></pre></td></tr><tr><td data-num="6"></td><td><pre>port <span class="token operator">=</span> <span class="token string">"3306"</span></pre></td></tr><tr><td data-num="7"></td><td><pre>user <span class="token operator">=</span> <span class="token string">"root"</span></pre></td></tr><tr><td data-num="8"></td><td><pre>password <span class="token operator">=</span> <span class="token string">"cloud.Zijin"</span></pre></td></tr><tr><td data-num="9"></td><td><pre>db <span class="token operator">=</span> <span class="token string">"usp_anyfix"</span></pre></td></tr><tr><td data-num="10"></td><td><pre>encodingdir <span class="token operator">=</span> <span class="token string">"share"</span></pre></td></tr><tr><td data-num="11"></td><td><pre>encoding <span class="token operator">=</span> <span class="token string">"utf8"</span></pre></td></tr><tr><td data-num="12"></td><td><pre>serverid <span class="token operator">=</span> <span class="token number">10</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token punctuation">[</span>desc.pgsql<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="15"></td><td><pre>connect_string <span class="token operator">=</span> <span class="token string">"host=10.34.11.141 dbname=postgres port=2345 user=gpadmin password=cloud.Zijin"</span></pre></td></tr></table></figure><h2 id="mysql2pgsql-用法"><a class="anchor" href="#mysql2pgsql-用法">#</a> mysql2pgsql 用法</h2><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>./mysql2pgsql -l <span class="token operator">&lt;</span>tables_list_file<span class="token operator">></span> -d -n -j <span class="token operator">&lt;</span>number of threads<span class="token operator">></span> -s <span class="token operator">&lt;</span>schema of target table<span class="token operator">></span></pre></td></tr></table></figure><p><strong>参数说明</strong></p><p *="" 不添加参数默认同步所有表=""><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"></mstyle></mrow><annotation encoding="application/x-tex">\color{red}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"></span></span></p><ul><li><p>-l : 可选参数，指定一个文本文件，文件中含有需要同步的表；如果不指定此参数，则同步配置文件中指定数据库下的所有表。 <code>&lt;tables_list_file&gt;</code> 为一个文件名，里面含有需要同步的表集合以及表上查询的条件，其内容格式示例如下:</p><figure class="highlight properties"><figcaption data-lang=".properties"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token attr-name">table1</span> <span class="token punctuation">:</span> <span class="token attr-value">select * from table_big where column1 &lt; '2016-08-05'</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token attr-name">table2</span> <span class="token attr-value">: </span></pre></td></tr><tr><td data-num="3"></td><td><pre>table3</pre></td></tr></table></figure></li><li><p>-d：可选参数，表示只生成目的表的建表 DDL 语句，不实际进行数据同步。</p></li><li><p>-n：可选参数，需要与 - d 一起使用，指定在 DDL 语句中不包含表分区定义。</p></li><li><p>-j：可选参数，指定使用多少线程进行数据同步；如果不指定此参数，会使用 5 个线程并发。</p></li><li><p>-s：可选参数，指定目标表的 schema</p></li></ul><h2 id="迁移maridb数据库"><a class="anchor" href="#迁移maridb数据库">#</a> 迁移 maridb 数据库</h2><ul><li><p>获取 maridb usp_anfyfix 所有表的 ddl</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>./mysql2pgsql -d</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment"># 获取 usp_anyfix 数据库所有表</span></pre></td></tr><tr><td data-num="3"></td><td><pre>-- Reference commands to create target tables <span class="token punctuation">(</span>Please choose a distribution key and replace it with <span class="token operator">&lt;</span>distribution key<span class="token operator">></span> <span class="token keyword">for</span> each table<span class="token punctuation">)</span>: </pre></td></tr><tr><td data-num="4"></td><td><pre>---------------</pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre>CREATE TABLE __hr_org_dept <span class="token punctuation">(</span>deptid text, name text, corpcode text, upperid text, upperid2 text, allupper text, deptlevelid text, bureaulevelid int4, hzcorp text<span class="token punctuation">)</span> with <span class="token punctuation">(</span>APPENDONLY<span class="token operator">=</span>true, <span class="token assign-left variable">ORIENTATION</span><span class="token operator">=</span>column, <span class="token assign-left variable">COMPRESSTYPE</span><span class="token operator">=</span>zlib, <span class="token assign-left variable">COMPRESSLEVEL</span><span class="token operator">=</span><span class="token number">1</span>, <span class="token assign-left variable">BLOCKSIZE</span><span class="token operator">=</span><span class="token number">1048576</span>, <span class="token assign-left variable">OIDS</span><span class="token operator">=</span>false<span class="token punctuation">)</span> DISTRIBUTED BY <span class="token punctuation">(</span><span class="token operator">&lt;</span>distribution key<span class="token operator">></span><span class="token punctuation">)</span> PARTITION BY RANGE <span class="token punctuation">(</span><span class="token operator">&lt;</span>partition key<span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">(</span>START <span class="token punctuation">(</span>date <span class="token string">'&lt;YYYY-MM-DD>'</span><span class="token punctuation">)</span> INCLUSIVE END <span class="token punctuation">(</span>date <span class="token string">'&lt;YYYY-MM-DD>'</span><span class="token punctuation">)</span> EXCLUSIVE EVERY <span class="token punctuation">(</span>INTERVAL <span class="token string">'&lt;1 month>'</span> <span class="token punctuation">))</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre>CREATE TABLE custom_field <span class="token punctuation">(</span>field_id int8, field_name text, field_type int4, required text, form_type int4, common text, corp_id int8, operator int8, operate_time timestamp<span class="token punctuation">)</span> with <span class="token punctuation">(</span>APPENDONLY<span class="token operator">=</span>true, <span class="token assign-left variable">ORIENTATION</span><span class="token operator">=</span>column, <span class="token assign-left variable">COMPRESSTYPE</span><span class="token operator">=</span>zlib, <span class="token assign-left variable">COMPRESSLEVEL</span><span class="token operator">=</span><span class="token number">1</span>, <span class="token assign-left variable">BLOCKSIZE</span><span class="token operator">=</span><span class="token number">1048576</span>, <span class="token assign-left variable">OIDS</span><span class="token operator">=</span>false<span class="token punctuation">)</span> DISTRIBUTED BY <span class="token punctuation">(</span><span class="token operator">&lt;</span>distribution key<span class="token operator">></span><span class="token punctuation">)</span> PARTITION BY RANGE <span class="token punctuation">(</span><span class="token operator">&lt;</span>partition key<span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">(</span>START <span class="token punctuation">(</span>date <span class="token string">'&lt;YYYY-MM-DD>'</span><span class="token punctuation">)</span> INCLUSIVE END <span class="token punctuation">(</span>date <span class="token string">'&lt;YYYY-MM-DD>'</span><span class="token punctuation">)</span> EXCLUSIVE EVERY <span class="token punctuation">(</span>INTERVAL <span class="token string">'&lt;1 month>'</span> <span class="token punctuation">))</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre>CREATE TABLE custom_field_data <span class="token punctuation">(</span>data_id int8, form_type int4, form_id int8, field_id int8, field_name text, field_type int4, field_value text<span class="token punctuation">)</span> with <span class="token punctuation">(</span>APPENDONLY<span class="token operator">=</span>true, <span class="token assign-left variable">ORIENTATION</span><span class="token operator">=</span>column, <span class="token assign-left variable">COMPRESSTYPE</span><span class="token operator">=</span>zlib, <span class="token assign-left variable">COMPRESSLEVEL</span><span class="token operator">=</span><span class="token number">1</span>, <span class="token assign-left variable">BLOCKSIZE</span><span class="token operator">=</span><span class="token number">1048576</span>, <span class="token assign-left variable">OIDS</span><span class="token operator">=</span>false<span class="token punctuation">)</span> DISTRIBUTED BY <span class="token punctuation">(</span><span class="token operator">&lt;</span>distribution key<span class="token operator">></span><span class="token punctuation">)</span> PARTITION BY RANGE <span class="token punctuation">(</span><span class="token operator">&lt;</span>partition key<span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">(</span>START <span class="token punctuation">(</span>date <span class="token string">'&lt;YYYY-MM-DD>'</span><span class="token punctuation">)</span> INCLUSIVE END <span class="token punctuation">(</span>date <span class="token string">'&lt;YYYY-MM-DD>'</span><span class="token punctuation">)</span> EXCLUSIVE EVERY <span class="token punctuation">(</span>INTERVAL <span class="token string">'&lt;1 month>'</span> <span class="token punctuation">))</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token punctuation">..</span><span class="token punctuation">..</span></pre></td></tr></table></figure><p>​ <code>通过./mysql2pgsql -d命令获取的mysql表结构信息不完整，例如表的注释，主键，字段注释等都不会获取到，所以需要复制你所需的建表信息并加以修改,在greenplum端先用列出来的建表信息加以修改之后并执行，如果目的数据库中没有对应的表的话，执行同步命令会失败，所以必须先对应建立每一张表</code></p></li><li><p>在 gp 的 usp_anyfix 模式中建表</p></li><li><p>创建 tables_list_file 文件用途同步（存放需要同步的表）</p><p><strong>tables_list_file.txt</strong></p><figure class="highlight properties"><figcaption data-lang=".properties"></figcaption><table><tr><td data-num="1"></td><td><pre>work_type</pre></td></tr><tr><td data-num="2"></td><td><pre>work_deal</pre></td></tr><tr><td data-num="3"></td><td><pre>device_branch</pre></td></tr><tr><td data-num="4"></td><td><pre>fault_type</pre></td></tr><tr><td data-num="5"></td><td><pre>work_request</pre></td></tr><tr><td data-num="6"></td><td><pre>service_remote_way</pre></td></tr><tr><td data-num="7"></td><td><pre>service_branch</pre></td></tr></table></figure></li><li><p>运行</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>./mysql2pqsql -l tables_list_files -s usp_anyfix</pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">##</span></pre></td></tr><tr><td data-num="4"></td><td><pre>-- Adding table: work_type</pre></td></tr><tr><td data-num="5"></td><td><pre>-- Adding table: work_deal</pre></td></tr><tr><td data-num="6"></td><td><pre>-- Adding table: work_branch</pre></td></tr><tr><td data-num="7"></td><td><pre>-- Adding table: fault_type</pre></td></tr><tr><td data-num="8"></td><td><pre>-- Adding table: work_request</pre></td></tr><tr><td data-num="9"></td><td><pre>-- Adding table: service_remote_way</pre></td></tr><tr><td data-num="10"></td><td><pre>-- Adding table: service_branch</pre></td></tr><tr><td data-num="11"></td><td><pre>Starting data <span class="token function">sync</span></pre></td></tr><tr><td data-num="12"></td><td><pre>Query to get <span class="token builtin class-name">source</span> data <span class="token keyword">for</span> target table work_type: <span class="token keyword">select</span> * from </pre></td></tr><tr><td data-num="13"></td><td><pre>Query to get <span class="token builtin class-name">source</span> data <span class="token keyword">for</span> target table work_deal: <span class="token keyword">select</span> * from </pre></td></tr><tr><td data-num="14"></td><td><pre>Query to get <span class="token builtin class-name">source</span> data <span class="token keyword">for</span> target table work_branch: <span class="token keyword">select</span> * from </pre></td></tr><tr><td data-num="15"></td><td><pre>Query to get <span class="token builtin class-name">source</span> data <span class="token keyword">for</span> target table fault_type: <span class="token keyword">select</span> * from </pre></td></tr><tr><td data-num="16"></td><td><pre>Query to get <span class="token builtin class-name">source</span> data <span class="token keyword">for</span> target table work_request: <span class="token keyword">select</span> * from </pre></td></tr><tr><td data-num="17"></td><td><pre>Query to get <span class="token builtin class-name">source</span> data <span class="token keyword">for</span> target table service_remote_way: <span class="token keyword">select</span> * from </pre></td></tr><tr><td data-num="18"></td><td><pre>Query to get <span class="token builtin class-name">source</span> data <span class="token keyword">for</span> target table service_branch: <span class="token keyword">select</span> * from </pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token variable"><span class="token variable">`</span>usp_anyfix<span class="token variable">`</span></span><span class="token builtin class-name">.</span><span class="token variable"><span class="token variable">`</span>work_type<span class="token variable">`</span></span> </pre></td></tr><tr><td data-num="20"></td><td><pre>-- Reference DDL to create the target table:</pre></td></tr><tr><td data-num="21"></td><td><pre>CREATE TABLE usp_anyfix.work_type <span class="token punctuation">(</span>id int4, name text, demander_corp int8, description text, sys_type int4, enabled text, operator int8, operate_time timestamp<span class="token punctuation">)</span> with <span class="token punctuation">(</span>APPENDONLY<span class="token operator">=</span>true, <span class="token assign-left variable">ORIENTATION</span><span class="token operator">=</span>column, <span class="token assign-left variable">COMPRESSTYPE</span><span class="token operator">=</span>zlib, <span class="token assign-left variable">COMPRESSLEVEL</span><span class="token operator">=</span><span class="token number">1</span>, <span class="token assign-left variable">BLOCKSIZE</span><span class="token operator">=</span><span class="token number">1048576</span>, <span class="token assign-left variable">OIDS</span><span class="token operator">=</span>false<span class="token punctuation">)</span> DISTRIBUTED BY <span class="token punctuation">(</span><span class="token operator">&lt;</span>distribution key<span class="token operator">></span><span class="token punctuation">)</span> PARTITION BY RANGE <span class="token punctuation">(</span><span class="token operator">&lt;</span>partition key<span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">(</span>START <span class="token punctuation">(</span>date <span class="token string">'&lt;YYYY-MM-DD>'</span><span class="token punctuation">)</span> INCLUSIVE END <span class="token punctuation">(</span>date <span class="token string">'&lt;YYYY-MM-DD>'</span><span class="token punctuation">)</span> EXCLUSIVE EVERY <span class="token punctuation">(</span>INTERVAL <span class="token string">'&lt;1 month>'</span> <span class="token punctuation">))</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre></pre></td></tr><tr><td data-num="23"></td><td><pre>thread <span class="token number">0</span> migrate task <span class="token number">0</span> table usp_anyfix.work_type <span class="token number">5</span> rows complete, <span class="token function">time</span> cost <span class="token number">117.708</span> ms</pre></td></tr><tr><td data-num="24"></td><td><pre>Number of rows migrated: <span class="token number">5</span> <span class="token punctuation">(</span>number of <span class="token builtin class-name">source</span> tables' rows: <span class="token number">5</span><span class="token punctuation">)</span> </pre></td></tr><tr><td data-num="25"></td><td><pre>Data <span class="token function">sync</span> <span class="token function">time</span> cost <span class="token number">208.147</span> ms</pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>.</pre></td></tr></table></figure><p><strong>每个库都要单独运行一次</strong></p><p><strong>usp_uas</strong></p><pre><code>uas_cfg_area
uas_corp_reg
uas_user_info
uas_user_real
sys_tenant
</code></pre><p><strong>usp_device</strong></p><pre><code>device_brand
device_info
device_large_class
device_model
device_small_class
device_specification
</code></pre></li><li><p>查看 pg (同步完成)</p><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">SELECT</span> id<span class="token punctuation">,</span> name<span class="token punctuation">,</span> demander_corp<span class="token punctuation">,</span> description<span class="token punctuation">,</span> sys_type</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">FROM</span> usp_anyfix<span class="token punctuation">.</span>work_type<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre> id <span class="token operator">|</span> name <span class="token operator">|</span> demander_corp <span class="token operator">|</span> description <span class="token operator">|</span> sys_type  <span class="token operator">|</span> enabled</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment">----+------+---------------+-------------+-----------+----------</span></pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token number">1</span>	<span class="token operator">|</span>  维修 <span class="token operator">|</span>   	  <span class="token number">0</span>       <span class="token operator">|</span>	     维修	  <span class="token operator">|</span>    <span class="token number">1</span>      <span class="token operator">|</span>   	Y		</pre></td></tr><tr><td data-num="6"></td><td><pre> <span class="token number">5</span>	<span class="token operator">|</span>  投诉 <span class="token operator">|</span>   	  <span class="token number">0</span>       <span class="token operator">|</span>	     投诉	  <span class="token operator">|</span>    <span class="token number">5</span>      <span class="token operator">|</span>   	Y		</pre></td></tr><tr><td data-num="7"></td><td><pre> <span class="token number">2</span>	<span class="token operator">|</span>  巡检 <span class="token operator">|</span>   	  <span class="token number">0</span>       <span class="token operator">|</span>	     巡检	  <span class="token operator">|</span>    <span class="token number">2</span>      <span class="token operator">|</span>   	Y		</pre></td></tr><tr><td data-num="8"></td><td><pre> <span class="token number">3</span>	<span class="token operator">|</span>  安装 <span class="token operator">|</span>   	  <span class="token number">0</span>       <span class="token operator">|</span>	     安装	  <span class="token operator">|</span>    <span class="token number">3</span>      <span class="token operator">|</span>   	Y	</pre></td></tr><tr><td data-num="9"></td><td><pre> <span class="token number">4</span>	<span class="token operator">|</span>  咨询 <span class="token operator">|</span>   	  <span class="token number">0</span>       <span class="token operator">|</span>	     咨询	  <span class="token operator">|</span>    <span class="token number">4</span>      <span class="token operator">|</span>   	Y</pre></td></tr></table></figure></li></ul><h1 id="可能出现的异常"><a class="anchor" href="#可能出现的异常">#</a> 可能出现的异常</h1><h2 id="mysql-maxwell"><a class="anchor" href="#mysql-maxwell">#</a> mysql-maxwell</h2><h3 id="maxwell-重启或意外挂断"><a class="anchor" href="#maxwell-重启或意外挂断">#</a> Maxwell 重启或意外挂断</h3><blockquote><p>kiil $ {PID} 停止 Maxwell 进程，或者当 Maxwell 由于网络和其他因素挂断时。重新启动进程是不会丢失少量数据</p></blockquote><p>取决于您的生产者设置。通常，maxwell <code>maxwell.positions</code> 在记录发送之前不会更新，尤其是在与可靠的生产者（例如 kafka /kinesis 等）打交道时，只有等 kafka 接收后发送成功的标示才会更新 <code>maxwell.positions</code> 。</p><p>所以当 maxwell 意外挂掉重启即可</p><p>可配置 kafka 相关参数:</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 压缩格式 压缩的速度上 lz4=snappy&lt;gzip。</span></pre></td></tr><tr><td data-num="2"></td><td><pre>kafka.compression.type<span class="token operator">=</span>snappy</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment"># 重试次数</span></pre></td></tr><tr><td data-num="4"></td><td><pre>kafka.retries<span class="token operator">=</span><span class="token number">0</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment">#procedure 要求 leader 在考虑完成请求之前收到的确认数，用于控制发送记录在服务端的持久化，其值可以为如下：</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment">#acks = 0 如果设置为零，则生产者将不会等待来自服务器的任何确认，该记录将立即添加到套接字缓冲区并视为已发送。在这种情况下，无法保证服务器已收到记录，并且重试配置将不会生效（因为客户端通常不会知道任何故障），为每条记录返回的偏移量始终设置为 - 1。</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment">#acks = 1 这意味着 leader 会将记录写入其本地日志，但无需等待所有副本服务器的完全确认即可做出回应，在这种情况下，如果 leader 在确认记录后立即失败，但在将数据复制到所有的副本服务器之前，则记录将会丢失。</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token comment">#acks = all 这意味着 leader 将等待完整的同步副本集以确认记录，这保证了只要至少一个同步副本服务器仍然存活，记录就不会丢失，这是最强有力的保证，这相当于 acks = -1 的设置。</span></pre></td></tr><tr><td data-num="9"></td><td><pre>kafka.acks<span class="token operator">=</span><span class="token number">1</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment">#kafka.batch.size=16384</span></pre></td></tr></table></figure><h3 id="使用旧的binlog"><a class="anchor" href="#使用旧的binlog">#</a> 使用旧的 binlog</h3><blockquote><p>如果是拿比较老的 binlog 放到新的 mysql server 上去用 maxwell 拉去，有可能表结构已经发生了变化。</p></blockquote><ul><li><p>表字段添加或者减少 (删除)</p><p>目前传入 kafka 没什么影响，只会在 json 中多一个字段或者少一个</p></li><li><p>若 binlog 中存在 ddl</p><p>报错：com.zendesk.maxwell.schema.ddl.InvalidSchemaError: Unexpectedly asked to create existing table device_large_class</p><p>可以使用 --init-postition 跳过</p><p>或者直接使用 maxwell-bootstrap 直接读表，不读 binlog</p></li></ul><h3 id="mysql-用户权限"><a class="anchor" href="#mysql-用户权限">#</a> mysql 用户权限</h3><blockquote><p>maxwell 对数据库中多个表读写权限，而对其他表则没有读取权限，配置参数还会过滤掉没有读权限的表。但是如果没有读取权限的表发生更改，</p><p>就会报错 ： java.lang.RuntimeException: Couldn't find table test_tb in database Maxwell</p></blockquote><p><strong>原因</strong>：</p><pre><code> Maxwell构建元数据库时，它没有足够的权限，并且不知道表的存在。 因此，该表在Maxwell元数据中不存在
</code></pre><p><strong>解决</strong></p><ul><li>Maxwell 添加足够的权限并重建元数据。</li><li>您可以在配置中配置具有读取权限的过滤器表 --filter='exclude: databasename.table'</li></ul><h3 id="14-timestamp-column"><a class="anchor" href="#14-timestamp-column">#</a> 1.4 timestamp column</h3><p>maxwell 对时间类型（datetime, timestamp, date）都是当做字符串处理的，这也是为了保证数据一致 (比如 0000-00-00 00:00:00 这样的时间在 timestamp 里是非法的，但 mysql 却认，解析成 java 或者 python 类型就是 null/None)。</p><p>如果 MySQL 表上的字段是 timestamp 类型，是有时区的概念 <strong>binlog 解析出来的是标准 UTC 时间</strong></p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 查看 mysql 时区</span></pre></td></tr><tr><td data-num="2"></td><td><pre>show variables like <span class="token string">'%time_zone%'</span></pre></td></tr><tr><td data-num="3"></td><td><pre>+------------------+--------+</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token operator">|</span> Variable_name    <span class="token operator">|</span> Value  <span class="token operator">|</span></pre></td></tr><tr><td data-num="5"></td><td><pre>+------------------+--------+</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token operator">|</span> system_time_zone <span class="token operator">|</span> CST    <span class="token operator">|</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token operator">|</span> time_zone        <span class="token operator">|</span> SYSTEM <span class="token operator">|</span></pre></td></tr><tr><td data-num="8"></td><td><pre>+------------------+--------+</pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token comment">#SYSTEM 表示使用 “OS 时区”； CST ，这里 cst 是 “中国标准时间 + 8:00 区”</span></pre></td></tr></table></figure><p><strong>修改 mysql 服务器的时区</strong></p><ul><li><p>修改 global 变量</p><p>set global time_zone = '+8:00'; ## 修改 mysql 全局时区为北京时间，即我们所在的东 8 区</p><p>set time_zone = '+8:00'; ## 修改当前会话时区</p><p>flush privileges; #立即生效</p></li><li><p>修改 my.cnf 配置文件来修改时区</p><p># vim /etc/my.cnf ## 在 [mysqld] 区域中加上</p><p>default-time_zone = '+8:00'</p></li></ul><h2 id="maxwell-kafka"><a class="anchor" href="#maxwell-kafka">#</a> maxwell - kafka</h2><h3 id="maxwell-到kafka-数据倾斜问题"><a class="anchor" href="#maxwell-到kafka-数据倾斜问题">#</a> maxwell 到 kafka 数据倾斜问题</h3><p>在<span class="exturl" data-url="aHR0cDovL21heHdlbGxzLWRhZW1vbi5pby8="> Maxwell</span> 官网查文档得知，在 <code>Maxwell</code> 没有配置的情况下，默认使用数据库名 database 作为计算分区的 key，并使用 Java 默认的 hashcode 算法进行计算，项目中 <code>maxwell</code> 的 binlog 就是单个 database，所以造成数据倾斜。</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>HASH_FUNCTION<span class="token punctuation">(</span>HASH_STRING<span class="token punctuation">)</span> % TOPIC.NUMBER_OF_PARTITIONS</pre></td></tr></table></figure><p>修改 <code>Maxwell</code> 的配置文件 config.properties 中加入对应参数即可，选择了 primary_key 作为分区 key，同时选用 murmurhash3</p><p>maxwell 有一个参数是–producer_partition_by，在不指定的情况下默认是 database，意思是数据推送到 kafka 时，数据被根据数据库进行 hash，同一个库的数据会被放在同一个 partition 中，这个参数有三个值：<br>database、table、primary_key</p><p>哈希算法，以获得更好的效率和分布：</p><figure class="highlight properties"><figcaption data-lang=".properties"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token attr-name">kafka_partition_hash</span><span class="token punctuation">=</span><span class="token attr-value">murmur3</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token attr-name">producer_partition_by</span><span class="token punctuation">=</span><span class="token attr-value">primary_key</span></pre></td></tr></table></figure><h3 id="kafka可能存在数据丢失情况"><a class="anchor" href="#kafka可能存在数据丢失情况">#</a> kafka 可能存在数据丢失情况</h3><p>在 maxwell 中 kafka.acks=1（默认）</p><pre><code>   kafka在 Partition Leader接收到消息而且写入本地磁盘了，就认为成功了，不管他其他的Follower有没有同步过去这条消息了，
</code></pre><p><strong>存在极端情况</strong></p><pre><code> 万一Partition Leader刚刚接收到消息，Follower还没来得及同步过去，结果Leader所在的broker宕机了，此时也会导致这条消息丢失，因为客户端已经认为发送成功了。
</code></pre><p>解决办法：</p><ul><li><p>一开始就参数改成的：kafka.akcs=-1</p><p>Partition Leader 接收到消息之后，还必须要求 ISR 列表里跟 Leader 保持同步的那些 Follower 都要把消息同步过去，才能认为这条消息是写入成功了</p></li><li><p>可以通过 kafka 接受的 json 中 <code>position</code> 属性获取 position</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 可以通过 mysql 查询手动定位丢失的数据</span></pre></td></tr><tr><td data-num="2"></td><td><pre>show binlog events <span class="token keyword">in</span> <span class="token string">'mysql-bin.000002'</span> from position limit <span class="token number">30</span><span class="token punctuation">;</span></pre></td></tr></table></figure></li></ul><h2 id="kafka-bireme-gp"><a class="anchor" href="#kafka-bireme-gp">#</a> kafka-bireme-gp</h2><h3 id="31-bireme-不支持ddl-不支持maxwell全量"><a class="anchor" href="#31-bireme-不支持ddl-不支持maxwell全量">#</a> 3.1 bireme 不支持 ddl (不支持 maxwell 全量)</h3><blockquote><p>若 kalka 中有 maxwell 导入的 ddl，或者全量数据，bireme 是无法解析该 json</p></blockquote><p>* 所以在 kafka 中一定不能有 ddl 语句和 maxwell 导入的全量（bootstrap-start -&gt; bootstrap-insert -&gt; bootstrap-complete），bireme 无法解析 json</p><ul -to-offset="" 这个的偏移量是全区都是用一个，如果分区消息不均衡="" 需要考虑是否适用=""><li><p>解决方法</p><ol><li><p>maxwell 不使用全量到入</p></li><li><p>maxwell 不使用 output_ddl 或者 <code>output_ddl 为 true 配合 ddl_kafka_topic使用</code></p></li><li><p>使用 kafka 命令修改消费者的偏移量（跳过 bireme 无法识别的错误）</p></li></ol><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 获取消费者组的偏移量</span></pre></td></tr><tr><td data-num="2"></td><td><pre> ./kafka-consumer-groups.sh --bootstrap-server hdp-s-1.data.dc.zjft.com:6667 --group bireme2 --describe</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment"># TOPIC     PARTITION  CURRENT-OFFSET  LOG-END-OFFSET  LAG  CONSUMER-ID  HOST  CLIENT-ID</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment"># maxwell2      0          43              43           0        -         -        -</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment"># maxwell1      0          33              55           22        -        -        -</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment">#修改 bireme2 在 maxwell1 中的偏移量</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment"># （最新的偏移量）</span></pre></td></tr><tr><td data-num="8"></td><td><pre>./kafka-consumer-groups.sh --bootstrap-server hdp-s-1.data.dc.zjft.com:6667 --group bireme2 --topic maxwell1 --reset-offsets --to-latest -execute</pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token comment">#  TOPIC                          PARTITION  NEW-OFFSET     </span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment">#  maxwell1                       0          55    </span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token comment">#（最早的）</span></pre></td></tr><tr><td data-num="13"></td><td><pre>./kafka-consumer-groups.sh --bootstrap-server hdp-s-1.data.dc.zjft.com:6667 --group bireme2 --topic maxwell1 --reset-offsets --to-earliest -execute</pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token comment"># TOPIC                          PARTITION  NEW-OFFSET     </span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token comment"># maxwell1                       0          38             </span></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token comment">#（指定位置）</span></pre></td></tr><tr><td data-num="19"></td><td><pre>./kafka-consumer-groups.sh --bootstrap-server hdp-s-1.data.dc.zjft.com:6667 --group bireme2 --topic maxwell1 --reset-offsets -to-offset <span class="token number">43</span> -execute</pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token comment"># TOPIC                          PARTITION  NEW-OFFSET     </span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token comment"># maxwell1                       0          43</span></pre></td></tr></table></figure><p>***** <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"></mstyle></mrow><annotation encoding="application/x-tex">\color{red}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"></span></span></p></li></ul><h3 id="mysql结构发生改变"><a class="anchor" href="#mysql结构发生改变">#</a> mysql 结构发生改变</h3><ul><li><p>若 mysql 表添加字段</p><p>bireme 导入 gp 没有影响，若 gp 也添加相应字段，则该字段自动填充（bireme 重启）</p></li><li><p>若 mysql 表删除字段</p><blockquote><p>Caused by: cn.hashdata.bireme.BiremeException: Not found. Record does not have a field named &quot;fieldName&quot;.</p></blockquote><p><strong>解决</strong></p><ul><li>减少 gp 表对应的字段，在重启 bireme</li></ul></li></ul><h3 id="source_nameproperties中表对应不上"><a class="anchor" href="#source_nameproperties中表对应不上">#</a> &lt;source_name&gt;.properties 中表对应不上</h3><blockquote><p>在使用 v2.0.0-alpha-1 可能会出现这种情况，mysql 多张表指向一张表<br>报错：cn.hashdata.bireme.BiremeException: Greenplum table and MySQL table size are inconsistent!</p></blockquote><figure class="highlight properties"><figcaption data-lang=".properties"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token attr-name">test.device_info</span> <span class="token punctuation">=</span> <span class="token attr-value">public.device_info</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token attr-name">test1.device_info</span> <span class="token punctuation">=</span> <span class="token attr-value">public.device_info</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token attr-name">test2.device_info</span> <span class="token punctuation">=</span> <span class="token attr-value">public.device_info</span></pre></td></tr></table></figure><p><strong>注释以下部分</strong></p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">if</span> <span class="token punctuation">(</span>table_map<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> tableMap<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token class-name">String</span> message <span class="token operator">=</span> <span class="token string">"some tables do not have primary keys！"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BiremeException</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Greenplum table primary key check is completed, the state is okay！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="当同步的表个数过多时数据不能同步"><a class="anchor" href="#当同步的表个数过多时数据不能同步">#</a> <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL0hhc2hEYXRhSW5jL2JpcmVtZS9pc3N1ZXMvODg=">当同步的表个数过多时，数据不能同步</span></h3><h3 id="bireme启动后1分钟左右就出现假死情况日志没有记录任何错误"><a class="anchor" href="#bireme启动后1分钟左右就出现假死情况日志没有记录任何错误">#</a> <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL0hhc2hEYXRhSW5jL2JpcmVtZS9pc3N1ZXMvNDc=">bireme 启动后，1 分钟左右就出现假死情况，日志没有记录任何错误</span></h3><h2 id="mysql2pgsql全量-2"><a class="anchor" href="#mysql2pgsql全量-2">#</a> mysql2pgsql（全量）</h2><ul><li><p><strong>主键重复</strong>：</p><p><em>同步出现此问题，则会导致该表同步失败:</em></p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>COPY failed <span class="token keyword">for</span> table <span class="token string">"work_request"</span><span class="token builtin class-name">:</span> ERROR:  duplicate key value violates unique constraint <span class="token string">"work_request_pkey"</span></pre></td></tr><tr><td data-num="2"></td><td><pre>DETAIL:  Key <span class="token punctuation">(</span>work_id<span class="token punctuation">)</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1230771096200847361</span><span class="token punctuation">)</span> already exists.</pre></td></tr><tr><td data-num="3"></td><td><pre>CONTEXT:  COPY work_request, line <span class="token number">1</span></pre></td></tr></table></figure><p>可以删除 key (work_id)=(1230771096200847361) 这条记录 ，再删除 table_list_file.txt 中除该表的其他表</p></li><li><p><strong>表不存在</strong></p><p><em>同步出现此问题，不影响其他表</em></p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>-- Reference DDL to create the target table:</pre></td></tr><tr><td data-num="2"></td><td><pre>CREATE TABLE usp_anyfix.custom_field <span class="token punctuation">(</span>field_id int8, field_name text, field_type int4, required text, form_type int4, common text, corp_id int8, operator int8, operate_time timestamp<span class="token punctuation">)</span> with <span class="token punctuation">(</span>APPENDONLY<span class="token operator">=</span>true, <span class="token assign-left variable">ORIENTATION</span><span class="token operator">=</span>column, <span class="token assign-left variable">COMPRESSTYPE</span><span class="token operator">=</span>zlib, <span class="token assign-left variable">COMPRESSLEVEL</span><span class="token operator">=</span><span class="token number">1</span>, <span class="token assign-left variable">BLOCKSIZE</span><span class="token operator">=</span><span class="token number">1048576</span>, <span class="token assign-left variable">OIDS</span><span class="token operator">=</span>false<span class="token punctuation">)</span> DISTRIBUTED BY <span class="token punctuation">(</span><span class="token operator">&lt;</span>distribution key<span class="token operator">></span><span class="token punctuation">)</span> PARTITION BY RANGE <span class="token punctuation">(</span><span class="token operator">&lt;</span>partition key<span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">(</span>START <span class="token punctuation">(</span>date <span class="token string">'&lt;YYYY-MM-DD>'</span><span class="token punctuation">)</span> INCLUSIVE END <span class="token punctuation">(</span>date <span class="token string">'&lt;YYYY-MM-DD>'</span><span class="token punctuation">)</span> EXCLUSIVE EVERY <span class="token punctuation">(</span>INTERVAL <span class="token string">'&lt;1 month>'</span> <span class="token punctuation">))</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre>table copy failed Query <span class="token string">'COPY "usp_anyfix"."custom_field" FROM stdin DELIMITERS '</span><span class="token operator">|</span><span class="token string">' with csv QUOTE '</span>'<span class="token string">''</span>': ERROR:  relation <span class="token string">"usp_anyfix.custom_field"</span> does not exist</pre></td></tr><tr><td data-num="5"></td><td><pre>thread <span class="token number">1</span> migrate task <span class="token number">1</span> table usp_anyfix.work_type <span class="token number">5</span> rows complete, <span class="token function">time</span> cost <span class="token number">119.677</span> ms</pre></td></tr><tr><td data-num="6"></td><td><pre>Number of rows migrated: <span class="token number">5</span> <span class="token punctuation">(</span>number of <span class="token builtin class-name">source</span> tables' rows: <span class="token number">5</span><span class="token punctuation">)</span> </pre></td></tr><tr><td data-num="7"></td><td><pre>Data <span class="token function">sync</span> <span class="token function">time</span> cost <span class="token number">248.356</span> ms</pre></td></tr><tr><td data-num="8"></td><td><pre>errors occured during migration</pre></td></tr></table></figure><p>若需要同步 gai 表，可以修改日志里的 sql 语句在 gp 创建表，再重新运行（修改 table_list_file）</p></li><li><p><strong>需要修改 gp 表结构的</strong></p><ul><li><p>字段对应不上</p></li><li><p>gp 表约束条件 如（不为空，惟一值）</p><p>* 在同步时 gp 可能会把 <code>‘’</code> 当成空，所以不能设置 <code>NOT NULL</code></p></li></ul></li></ul><div class="tags"><a href="/tags/maxwell/" rel="tag"><i class="ic i-tag"></i> maxwell</a> <a href="/tags/bireme/" rel="tag"><i class="ic i-tag"></i> bireme</a> <a href="/tags/kafka/" rel="tag"><i class="ic i-tag"></i> kafka</a></div></div><footer><div class="meta"><span class="item"><span class="icon"><i class="ic i-calendar-check"></i> </span><span class="text">更新于</span> <time title="修改时间：2021-04-23 16:52:13" itemprop="dateModified" datetime="2021-04-23T16:52:13+08:00">2021-04-23</time> </span><span id="Maxwell-整合kafka与bireme/" class="item leancloud_visitors" data-flag-title="Maxwell-整合kafka与bireme" title="阅读次数"><span class="icon"><i class="ic i-eye"></i> </span><span class="text">阅读次数</span> <span class="leancloud-visitors-count"></span> <span class="text">次</span></span></div><div class="reward"><button><i class="ic i-heartbeat"></i> 赞赏</button><p>请我喝[茶]~(￣▽￣)~*</p><div id="qr"><div><img data-src="/images/wechatpay.png" alt="Lucas 微信支付"><p>微信支付</p></div><div><img data-src="/images/alipay.png" alt="Lucas 支付宝"><p>支付宝</p></div><div><img data-src="/images/paypal.png" alt="Lucas 贝宝"><p>贝宝</p></div></div></div><div id="copyright"><ul><li class="author"><strong>本文作者： </strong>Lucas <i class="ic i-at"><em>@</em></i>专注技术分享</li><li class="link"><strong>本文链接：</strong> <a href="http://yrmlnf.coding-pages.com/Maxwell-%E6%95%B4%E5%90%88kafka%E4%B8%8Ebireme/" title="Maxwell-整合kafka与bireme">http://yrmlnf.coding-pages.com/Maxwell-整合kafka与bireme/</a></li><li class="license"><strong>版权声明： </strong>本站所有文章除特别声明外，均采用 <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> 许可协议。转载请注明出处！</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"><a href="/Canal-%E9%83%A8%E7%BD%B2%E6%8C%87%E5%8D%97/" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;tva4.sinaimg.cn&#x2F;mw690&#x2F;005yAHGDly8gplgv1xdiuj31hc0u0wmy.jpg" title="Canal-部署指南"><span class="type">上一篇</span> <span class="category"><i class="ic i-flag"></i> IT运维</span><h3>Canal-部署指南</h3></a></div><div class="item right"><a href="/Druid-%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5%E4%B8%8E%E4%BD%BF%E7%94%A8/" itemprop="url" rel="next" data-background-image="https:&#x2F;&#x2F;tva4.sinaimg.cn&#x2F;mw690&#x2F;005yAHGDly8gplff3dn3dj31hc0u0tkn.jpg" title="Druid-基本概念与使用"><span class="type">下一篇</span> <span class="category"><i class="ic i-flag"></i> 大数据</span><h3>Druid-基本概念与使用</h3></a></div></div><div class="wrap" id="comments"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="文章目录"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#mysqlmaridb-%E5%BC%80%E5%90%AFbinlog"><span class="toc-number">1.</span> <span class="toc-text">mysql (maridb) 开启 binlog</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AE%E5%BC%80%E5%90%AFlogin"><span class="toc-number">1.1.</span> <span class="toc-text">设置开启 login</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9B%E5%A7%8B%E7%94%A8%E6%88%B7%E5%8F%8A%E8%A1%A8"><span class="toc-number">1.2.</span> <span class="toc-text">创始用户及表</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#maxwell"><span class="toc-number">2.</span> <span class="toc-text">maxwell</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#maxwell%E4%B8%BB%E8%A6%81%E5%8A%9F%E8%83%BD"><span class="toc-number">2.1.</span> <span class="toc-text">Maxwell 主要功能</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BF%AB%E9%80%9F%E5%BC%80%E5%A7%8B"><span class="toc-number">2.2.</span> <span class="toc-text">快速开始</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BE%93%E5%87%BAjson%E5%AD%97%E7%AC%A6%E4%B8%B2%E7%9A%84%E6%A0%BC%E5%BC%8F"><span class="toc-number">2.3.</span> <span class="toc-text">输出 JSON 字符串的格式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#maxwell%E9%85%8D%E7%BD%AE%E9%A1%B9%E8%AF%B4%E6%98%8E"><span class="toc-number">2.4.</span> <span class="toc-text">maxwell 配置项说明</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#mysql-%E9%85%8D%E7%BD%AE%E9%80%89%E9%A1%B9"><span class="toc-number">2.4.1.</span> <span class="toc-text">mysql 配置选项</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%9F%E4%BA%A7%E8%80%85%E7%9A%84%E9%85%8D%E7%BD%AE"><span class="toc-number">2.4.2.</span> <span class="toc-text">生产者的配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%87%E6%BB%A4%E5%99%A8%E9%85%8D%E7%BD%AE"><span class="toc-number">2.4.3.</span> <span class="toc-text">过滤器配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#javascript-%E8%BF%87%E6%BB%A4%E5%99%A8"><span class="toc-number">2.4.4.</span> <span class="toc-text">javascript 过滤器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#formatting"><span class="toc-number">2.4.5.</span> <span class="toc-text">formatting</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#init_position"><span class="toc-number">2.4.6.</span> <span class="toc-text">init_position</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%88%9D%E5%A7%8B%E5%8C%96bootstrap%E5%BC%95%E5%AF%BC%E6%93%8D%E4%BD%9C"><span class="toc-number">2.5.</span> <span class="toc-text">数据初始化（bootstrap 引导操作）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#monitoring"><span class="toc-number">2.6.</span> <span class="toc-text">monitoring</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#maxwell%E5%A4%9A%E5%AE%9E%E4%BE%8B"><span class="toc-number">2.7.</span> <span class="toc-text">maxwell 多实例</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#maxwell-%E5%88%86%E5%8C%BA"><span class="toc-number">2.8.</span> <span class="toc-text">maxwell 分区</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#maxwell%E9%AB%98%E5%8F%AF%E7%94%A8%E6%9C%AA%E5%AE%9E%E7%8E%B0"><span class="toc-number">2.9.</span> <span class="toc-text">maxwell 高可用（未实现）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9"><span class="toc-number">2.10.</span> <span class="toc-text">注意事项</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#bireme%E5%A2%9E%E9%87%8F"><span class="toc-number">3.</span> <span class="toc-text">bireme (增量)</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#bireme%E5%A6%82%E4%BD%95%E5%B7%A5%E4%BD%9C"><span class="toc-number">3.1.</span> <span class="toc-text">bireme 如何工作</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E7%AE%80%E4%BB%8B"><span class="toc-number">3.2.</span> <span class="toc-text">配置文件简介</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#configproperties"><span class="toc-number">3.2.1.</span> <span class="toc-text">config.properties</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#source_name-properties"><span class="toc-number">3.2.2.</span> <span class="toc-text">source_name&gt; .properties</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BF%AB%E9%80%9F%E6%93%8D%E4%BD%9C"><span class="toc-number">3.3.</span> <span class="toc-text">快速操作</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#mysql2pgsql%E5%85%A8%E9%87%8F"><span class="toc-number">4.</span> <span class="toc-text">mysql2pgsql（全量）</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%8B%E8%BD%BD-mysql2pgsql"><span class="toc-number">4.1.</span> <span class="toc-text">下载 mysql2pgsql</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%85%8D%E7%BD%AEmysql%E5%92%8Cgp%E8%BF%9E%E6%8E%A5%E4%BF%A1%E6%81%AF%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">4.2.</span> <span class="toc-text">配置 mysql 和 gp 连接信息配置文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#mysql2pgsql-%E7%94%A8%E6%B3%95"><span class="toc-number">4.3.</span> <span class="toc-text">mysql2pgsql 用法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%81%E7%A7%BBmaridb%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="toc-number">4.4.</span> <span class="toc-text">迁移 maridb 数据库</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8F%AF%E8%83%BD%E5%87%BA%E7%8E%B0%E7%9A%84%E5%BC%82%E5%B8%B8"><span class="toc-number">5.</span> <span class="toc-text">可能出现的异常</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#mysql-maxwell"><span class="toc-number">5.1.</span> <span class="toc-text">mysql-maxwell</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#maxwell-%E9%87%8D%E5%90%AF%E6%88%96%E6%84%8F%E5%A4%96%E6%8C%82%E6%96%AD"><span class="toc-number">5.1.1.</span> <span class="toc-text">Maxwell 重启或意外挂断</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E6%97%A7%E7%9A%84binlog"><span class="toc-number">5.1.2.</span> <span class="toc-text">使用旧的 binlog</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#mysql-%E7%94%A8%E6%88%B7%E6%9D%83%E9%99%90"><span class="toc-number">5.1.3.</span> <span class="toc-text">mysql 用户权限</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#14-timestamp-column"><span class="toc-number">5.1.4.</span> <span class="toc-text">1.4 timestamp column</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#maxwell-kafka"><span class="toc-number">5.2.</span> <span class="toc-text">maxwell - kafka</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#maxwell-%E5%88%B0kafka-%E6%95%B0%E6%8D%AE%E5%80%BE%E6%96%9C%E9%97%AE%E9%A2%98"><span class="toc-number">5.2.1.</span> <span class="toc-text">maxwell 到 kafka 数据倾斜问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#kafka%E5%8F%AF%E8%83%BD%E5%AD%98%E5%9C%A8%E6%95%B0%E6%8D%AE%E4%B8%A2%E5%A4%B1%E6%83%85%E5%86%B5"><span class="toc-number">5.2.2.</span> <span class="toc-text">kafka 可能存在数据丢失情况</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#kafka-bireme-gp"><span class="toc-number">5.3.</span> <span class="toc-text">kafka-bireme-gp</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#31-bireme-%E4%B8%8D%E6%94%AF%E6%8C%81ddl-%E4%B8%8D%E6%94%AF%E6%8C%81maxwell%E5%85%A8%E9%87%8F"><span class="toc-number">5.3.1.</span> <span class="toc-text">3.1 bireme 不支持 ddl (不支持 maxwell 全量)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#mysql%E7%BB%93%E6%9E%84%E5%8F%91%E7%94%9F%E6%94%B9%E5%8F%98"><span class="toc-number">5.3.2.</span> <span class="toc-text">mysql 结构发生改变</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#source_nameproperties%E4%B8%AD%E8%A1%A8%E5%AF%B9%E5%BA%94%E4%B8%8D%E4%B8%8A"><span class="toc-number">5.3.3.</span> <span class="toc-text">&lt;source_name&gt;.properties 中表对应不上</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BD%93%E5%90%8C%E6%AD%A5%E7%9A%84%E8%A1%A8%E4%B8%AA%E6%95%B0%E8%BF%87%E5%A4%9A%E6%97%B6%E6%95%B0%E6%8D%AE%E4%B8%8D%E8%83%BD%E5%90%8C%E6%AD%A5"><span class="toc-number">5.3.4.</span> <span class="toc-text">当同步的表个数过多时，数据不能同步</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#bireme%E5%90%AF%E5%8A%A8%E5%90%8E1%E5%88%86%E9%92%9F%E5%B7%A6%E5%8F%B3%E5%B0%B1%E5%87%BA%E7%8E%B0%E5%81%87%E6%AD%BB%E6%83%85%E5%86%B5%E6%97%A5%E5%BF%97%E6%B2%A1%E6%9C%89%E8%AE%B0%E5%BD%95%E4%BB%BB%E4%BD%95%E9%94%99%E8%AF%AF"><span class="toc-number">5.3.5.</span> <span class="toc-text">bireme 启动后，1 分钟左右就出现假死情况，日志没有记录任何错误</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#mysql2pgsql%E5%85%A8%E9%87%8F-2"><span class="toc-number">5.4.</span> <span class="toc-text">mysql2pgsql（全量）</span></a></li></ol></li></ol></div><div class="related panel pjax" data-title="系列文章"><ul><li><a href="/Pentaho-%E5%88%9D%E8%AF%86%E5%BC%80%E6%BA%90%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%B9%B3%E5%8F%B0/" rel="bookmark" title="Pentaho-初识开源大数据平台">Pentaho-初识开源大数据平台</a></li><li><a href="/Superset-%E8%BD%BB%E9%87%8F%E7%BA%A7BI%E5%B9%B3%E5%8F%B0%E7%9A%84%E4%BD%BF%E7%94%A8/" rel="bookmark" title="Superset-轻量级BI平台的使用">Superset-轻量级BI平台的使用</a></li><li><a href="/Pentaho-%E6%97%B6%E9%97%B4%E7%BB%B4%E5%BA%A6%E8%A1%A8%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/" rel="bookmark" title="Pentaho-时间维度表最佳实践">Pentaho-时间维度表最佳实践</a></li><li><a href="/Pentaho-%E7%BC%93%E6%85%A2%E5%A2%9E%E9%95%BF%E7%BB%B4%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/" rel="bookmark" title="Pentaho-缓慢增长维最佳实践">Pentaho-缓慢增长维最佳实践</a></li><li><a href="/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/%E5%A4%A7%E6%95%B0%E6%8D%AE/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93-%E4%B8%80%E4%BA%9B%E6%95%B0%E4%BB%93%E7%90%86%E8%AE%BA%E5%9C%A8%E5%B7%A5%E4%BD%9C%E4%B8%AD%E7%9A%84%E7%90%86%E8%A7%A3/" rel="bookmark" title="数据仓库-一些数仓理论在工作中的理解">数据仓库-一些数仓理论在工作中的理解</a></li><li><a href="/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/%E5%A4%A7%E6%95%B0%E6%8D%AE/%E6%95%B0%E6%8D%AE%E5%8F%AF%E8%A7%86%E5%8C%96/Pentaho-CDE%E5%BC%80%E5%8F%91%E6%8C%87%E5%8D%97/" rel="bookmark" title="Pentaho-CDE开发指南">Pentaho-CDE开发指南</a></li><li><a href="/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/%E5%A4%A7%E6%95%B0%E6%8D%AE/Solr-%E5%85%A8%E6%96%87%E6%90%9C%E7%B4%A2%E5%BC%95%E6%93%8E%E4%BD%BF%E7%94%A8/" rel="bookmark" title="Solr-全文搜索引擎使用">Solr-全文搜索引擎使用</a></li><li><a href="/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/%E5%A4%A7%E6%95%B0%E6%8D%AE/%E6%95%B0%E6%8D%AE%E5%8F%AF%E8%A7%86%E5%8C%96/Superset-%E5%9B%BE%E8%A1%A8%E6%B8%B2%E6%9F%93%E6%B5%81%E7%A8%8B/" rel="bookmark" title="Superset-图表渲染流程">Superset-图表渲染流程</a></li><li><a href="/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/%E5%A4%A7%E6%95%B0%E6%8D%AE/%E6%95%B0%E6%8D%AE%E5%8F%AF%E8%A7%86%E5%8C%96/Superset-%E9%9B%86%E6%88%90Echarts%E9%A5%BC%E5%9B%BE/" rel="bookmark" title="Superset-集成Echarts饼图">Superset-集成Echarts饼图</a></li><li><a href="/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/%E5%A4%A7%E6%95%B0%E6%8D%AE/%E6%95%B0%E6%8D%AE%E5%8F%AF%E8%A7%86%E5%8C%96/Superset-%E9%9B%86%E6%88%90Echarts%E5%9C%B0%E5%9B%BE/" rel="bookmark" title="Superset-集成Echarts地图">Superset-集成Echarts地图</a></li><li><a href="/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/%E5%A4%A7%E6%95%B0%E6%8D%AE/%E6%95%B0%E6%8D%AE%E6%B2%BB%E7%90%86/%E6%95%B0%E6%8D%AE%E6%B2%BB%E7%90%86-%E6%95%B0%E6%8D%AE%E8%A1%80%E7%BC%98%E8%AE%BE%E8%AE%A1/" rel="bookmark" title="数据治理-数据血缘设计">数据治理-数据血缘设计</a></li><li class="active"><a href="/Maxwell-%E6%95%B4%E5%90%88kafka%E4%B8%8Ebireme/" rel="bookmark" title="Maxwell-整合kafka与bireme">Maxwell-整合kafka与bireme</a></li><li><a href="/Druid-%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5%E4%B8%8E%E4%BD%BF%E7%94%A8/" rel="bookmark" title="Druid-基本概念与使用">Druid-基本概念与使用</a></li><li><a href="/Pentaho-8-3%E7%89%88%E6%9C%AC%E6%95%B0%E6%8D%AE%E5%BA%93%E8%BF%81%E7%A7%BB/" rel="bookmark" title="Pentaho-8.3版本数据库迁移">Pentaho-8.3版本数据库迁移</a></li><li><a href="/Pentaho-RestAPI%E7%94%A8%E6%88%B7%E8%A7%92%E8%89%B2%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86/" rel="bookmark" title="Pentaho-RestAPI用户角色权限管理">Pentaho-RestAPI用户角色权限管理</a></li><li><a href="/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/%E5%A4%A7%E6%95%B0%E6%8D%AE/%E6%95%B0%E6%8D%AE%E5%8F%AF%E8%A7%86%E5%8C%96/Superset-%E4%BA%8C%E6%AC%A1%E5%BC%80%E5%8F%91%E6%8C%87%E5%8D%97/" rel="bookmark" title="Superset-二次开发指南">Superset-二次开发指南</a></li></ul></div><div class="overview panel" data-title="站点概览"><div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="image" itemprop="image" alt="Lucas" data-src="/images/avatar.jpg"><p class="name" itemprop="name">Lucas</p><div class="description" itemprop="description"></div></div><nav class="state"><div class="item posts"><a href="/archives/"><span class="count">40</span> <span class="name">文章</span></a></div><div class="item categories"><a href="/categories/"><span class="count">12</span> <span class="name">分类</span></a></div><div class="item tags"><a href="/tags/"><span class="count">41</span> <span class="name">标签</span></a></div></nav><div class="social"><span class="exturl item github" data-url="aHR0cHM6Ly9naXRodWIuY29tL3lvdXJuYW1l" title="https:&#x2F;&#x2F;github.com&#x2F;yourname"><i class="ic i-github"></i></span> <span class="exturl item twitter" data-url="aHR0cHM6Ly90d2l0dGVyLmNvbS95b3VybmFtZQ==" title="https:&#x2F;&#x2F;twitter.com&#x2F;yourname"><i class="ic i-twitter"></i></span> <span class="exturl item zhihu" data-url="aHR0cHM6Ly93d3cuemhpaHUuY29tL3Blb3BsZS95b3VybmFtZQ==" title="https:&#x2F;&#x2F;www.zhihu.com&#x2F;people&#x2F;yourname"><i class="ic i-zhihu"></i></span> <span class="exturl item music" data-url="aHR0cHM6Ly9tdXNpYy4xNjMuY29tLyMvdXNlci9ob21lP2lkPXlvdXJpZA==" title="https:&#x2F;&#x2F;music.163.com&#x2F;#&#x2F;user&#x2F;home?id&#x3D;yourid"><i class="ic i-cloud-music"></i></span> <span class="exturl item weibo" data-url="aHR0cHM6Ly93ZWliby5jb20veW91cm5hbWU=" title="https:&#x2F;&#x2F;weibo.com&#x2F;yourname"><i class="ic i-weibo"></i></span> <span class="exturl item about" data-url="aHR0cHM6Ly9hYm91dC5tZS95b3VybmFtZQ==" title="https:&#x2F;&#x2F;about.me&#x2F;yourname"><i class="ic i-address-card"></i></span></div><ul class="menu"><li class="item"><a href="/" rel="section"><i class="ic i-home"></i>首页</a></li><li class="item"><a href="/about/" rel="section"><i class="ic i-user"></i>关于</a></li><li class="item dropdown"><a href="javascript:void(0);"><i class="ic i-feather"></i>文章</a><ul class="submenu"><li class="item"><a href="/archives/" rel="section"><i class="ic i-list-alt"></i>归档</a></li><li class="item"><a href="/categories/" rel="section"><i class="ic i-th"></i>分类</a></li><li class="item"><a href="/tags/" rel="section"><i class="ic i-tags"></i>标签</a></li></ul></li></ul></div></div></div><ul id="quick"><li class="prev pjax"><a href="/Canal-%E9%83%A8%E7%BD%B2%E6%8C%87%E5%8D%97/" rel="prev" title="上一篇"><i class="ic i-chevron-left"></i></a></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"><a href="/Druid-%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5%E4%B8%8E%E4%BD%BF%E7%94%A8/" rel="next" title="下一篇"><i class="ic i-chevron-right"></i></a></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"><div class="rpost pjax"><h2>随机文章</h2><ul><li class="item"><div class="breadcrumb"><a href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/" title="分类于 计算机科学">计算机科学</a> <i class="ic i-angle-right"></i> <a href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/%E5%A4%A7%E6%95%B0%E6%8D%AE/" title="分类于 大数据">大数据</a></div><span><a href="/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/%E5%A4%A7%E6%95%B0%E6%8D%AE/Solr-%E5%85%A8%E6%96%87%E6%90%9C%E7%B4%A2%E5%BC%95%E6%93%8E%E4%BD%BF%E7%94%A8/" title="Solr-全文搜索引擎使用">Solr-全文搜索引擎使用</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/" title="分类于 计算机科学">计算机科学</a> <i class="ic i-angle-right"></i> <a href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/%E5%A4%A7%E6%95%B0%E6%8D%AE/" title="分类于 大数据">大数据</a> <i class="ic i-angle-right"></i> <a href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/%E5%A4%A7%E6%95%B0%E6%8D%AE/%E6%95%B0%E6%8D%AE%E5%8F%AF%E8%A7%86%E5%8C%96/" title="分类于 数据可视化">数据可视化</a></div><span><a href="/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/%E5%A4%A7%E6%95%B0%E6%8D%AE/%E6%95%B0%E6%8D%AE%E5%8F%AF%E8%A7%86%E5%8C%96/Superset-%E5%9B%BE%E8%A1%A8%E6%B8%B2%E6%9F%93%E6%B5%81%E7%A8%8B/" title="Superset-图表渲染流程">Superset-图表渲染流程</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/" title="分类于 计算机科学">计算机科学</a> <i class="ic i-angle-right"></i> <a href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/%E5%A4%A7%E6%95%B0%E6%8D%AE/" title="分类于 大数据">大数据</a> <i class="ic i-angle-right"></i> <a href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/%E5%A4%A7%E6%95%B0%E6%8D%AE/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/" title="分类于 数据仓库">数据仓库</a></div><span><a href="/Pentaho-%E6%97%B6%E9%97%B4%E7%BB%B4%E5%BA%A6%E8%A1%A8%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/" title="Pentaho-时间维度表最佳实践">Pentaho-时间维度表最佳实践</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/" title="分类于 计算机科学">计算机科学</a> <i class="ic i-angle-right"></i> <a href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/%E5%A4%A7%E6%95%B0%E6%8D%AE/" title="分类于 大数据">大数据</a> <i class="ic i-angle-right"></i> <a href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/%E5%A4%A7%E6%95%B0%E6%8D%AE/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/" title="分类于 数据仓库">数据仓库</a></div><span><a href="/Pentaho-%E7%BC%93%E6%85%A2%E5%A2%9E%E9%95%BF%E7%BB%B4%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/" title="Pentaho-缓慢增长维最佳实践">Pentaho-缓慢增长维最佳实践</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E8%B7%A8%E5%A2%83%E7%94%B5%E5%95%86/" title="分类于 跨境电商">跨境电商</a></div><span><a href="/%E8%B7%A8%E5%A2%83%E7%94%B5%E5%95%86/Amazon-2020%E5%BC%80%E5%BA%97%E6%88%90%E6%9C%AC/" title="Amazon-2020开店成本">Amazon-2020开店成本</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/" title="分类于 计算机科学">计算机科学</a> <i class="ic i-angle-right"></i> <a href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/%E8%BD%AF%E4%BB%B6%E5%BA%94%E7%94%A8/" title="分类于 软件应用">软件应用</a></div><span><a href="/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/%E8%BD%AF%E4%BB%B6%E5%BA%94%E7%94%A8/Hexo-Next%E4%B8%BB%E9%A2%98%E5%AE%89%E8%A3%85%E5%92%8C%E9%83%A8%E7%BD%B2/" title="Hexo-Next主题安装和部署">Hexo-Next主题安装和部署</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/" title="分类于 计算机科学">计算机科学</a> <i class="ic i-angle-right"></i> <a href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/%E5%A4%A7%E6%95%B0%E6%8D%AE/" title="分类于 大数据">大数据</a> <i class="ic i-angle-right"></i> <a href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/%E5%A4%A7%E6%95%B0%E6%8D%AE/%E6%95%B0%E6%8D%AE%E5%8F%AF%E8%A7%86%E5%8C%96/" title="分类于 数据可视化">数据可视化</a></div><span><a href="/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/%E5%A4%A7%E6%95%B0%E6%8D%AE/%E6%95%B0%E6%8D%AE%E5%8F%AF%E8%A7%86%E5%8C%96/Superset-%E9%9B%86%E6%88%90Echarts%E5%9C%B0%E5%9B%BE/" title="Superset-集成Echarts地图">Superset-集成Echarts地图</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/" title="分类于 计算机科学">计算机科学</a> <i class="ic i-angle-right"></i> <a href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/%E6%95%B0%E6%8D%AE%E5%BA%93/" title="分类于 数据库">数据库</a></div><span><a href="/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis-%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5%E4%B8%8E%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/" title="Redis-基本概念与解决方案">Redis-基本概念与解决方案</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/" title="分类于 计算机科学">计算机科学</a> <i class="ic i-angle-right"></i> <a href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" title="分类于 数据结构">数据结构</a></div><span><a href="/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-HashMap/" title="数据结构-HashMap">数据结构-HashMap</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/" title="分类于 计算机科学">计算机科学</a> <i class="ic i-angle-right"></i> <a href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/%E8%BD%AF%E4%BB%B6%E5%BA%94%E7%94%A8/" title="分类于 软件应用">软件应用</a></div><span><a href="/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/%E8%BD%AF%E4%BB%B6%E5%BA%94%E7%94%A8/Github-%E9%83%A8%E7%BD%B2%E9%9D%99%E6%80%81%E9%A1%B5%E9%9D%A2/" title="Github-部署静态页面">Github-部署静态页面</a></span></li></ul></div><div><h2>最新评论</h2><ul class="leancloud-recent-comment"></ul></div></div><div class="status"><div class="copyright">&copy; 2010 – <span itemprop="copyrightYear">2021</span> <span class="with-love"><i class="ic i-sakura rotate"></i> </span><span class="author" itemprop="copyrightHolder">Lucas @ Lucas Home</span></div><div class="count"><span class="post-meta-item-icon"><i class="ic i-chart-area"></i> </span><span title="站点总字数">370k 字</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="ic i-coffee"></i> </span><span title="站点阅读时长">5:36</span></div><div class="powered-by">基于 <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span></div></div></div></footer></div><script data-config type="text/javascript">var LOCAL={path:"Maxwell-整合kafka与bireme/",favicon:{show:"（●´3｀●）やれやれだぜ",hide:"(´Д｀)大変だ！"},search:{placeholder:"文章搜索",empty:"关于 「 ${query} 」，什么也没搜到",stats:"${time} ms 内找到 ${hits} 条结果"},valine:!0,fancybox:!0,copyright:'复制成功，转载请遵守 <i class="ic i-creative-commons"></i>BY-NC-SA 协议。',ignores:[function(e){return e.includes("#")},function(e){return new RegExp(LOCAL.path+"$").test(e)}]}</script><script src="https://cdn.polyfill.io/v2/polyfill.js"></script><script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script><script src="/js/app.js?v=0.2.5"></script></body></html><!-- rebuild by hrmmi -->